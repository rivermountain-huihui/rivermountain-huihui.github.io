<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="huihui"><meta name="copyright" content="huihui"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>Redis | 辉辉的数据库</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"example.com","root":"/","title":"云游君的小站","version":"1.3.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="NoSQL数据库Redisnosql: not only sql">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/index.html">
<meta property="og:site_name" content="辉辉的数据库">
<meta property="og:description" content="NoSQL数据库Redisnosql: not only sql">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205309861.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205320223.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205326907.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205347005.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205354193.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201024192759734.png">
<meta property="article:published_time" content="2020-11-18T00:48:10.000Z">
<meta property="article:modified_time" content="2020-11-19T00:46:34.335Z">
<meta property="article:author" content="huihui">
<meta property="article:tag" content="notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20201022205309861.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="huihui"><img width="96" loading="lazy" src="/Yun.png" alt="huihui"></a><div class="site-author-name"><a href="/about/">huihui</a></div><a class="site-name" href="/about/site.html">辉辉的数据库</a><sub class="site-subtitle">我们要丈量大地！</sub><div class="site-desciption">笔记</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">12</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">1</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=epvxdq1sknJe9JMj6J1LsBw4a6cI_2ln&amp;jump_from=webapi" title="QQ 群 389401003" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis"><span class="toc-number">1.</span> <span class="toc-text">NoSQL数据库Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nosql-not-only-sql"><span class="toc-number">1.1.</span> <span class="toc-text">nosql: not only sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF"><span class="toc-number">1.2.</span> <span class="toc-text">1 缓存技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-buffer%E4%B8%8Ecache"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.1.1 buffer与cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E7%BC%93%E5%AD%98%E4%BF%9D%E5%AD%98%E4%BD%8D%E7%BD%AE%E5%8F%8A%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.1.2 缓存保存位置及分层结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-cache%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">1.1.3 cache的特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%A8%E6%88%B7%E5%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 用户层缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-DNS%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">1.2.1 DNS缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E6%9F%A5%E7%9C%8B%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">1.2.2 查看浏览器的缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E5%89%8D%E7%AB%AF%E4%BD%BF%E7%94%A8%E7%9A%84%E6%8A%80%E6%9C%AF%E2%80%93dns-prefetch"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">1.2.2 前端使用的技术–dns-prefetch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E6%9C%BA%E5%88%B6%EF%BC%9A"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">1.2.4 浏览器缓存过期机制：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-CDN%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 CDN缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E5%BA%94%E7%94%A8%E5%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4应用层缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E6%95%B0%E6%8D%AE%E5%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.5 数据层缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-CPU%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.6.</span> <span class="toc-text">1.6 CPU缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis-%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">2 Redis 部署和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-RDBMS%E5%92%8CNOSQL%E7%9A%84%E5%90%84%E8%87%AA%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 RDBMS和NOSQL的各自优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Redis%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 Redis特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 单线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Redis-%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 Redis 安装和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">2.1 编译安装步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2.2 内核参数修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">2.3 配置文件修改</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 慢查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Redis-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.5 Redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-RDB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">2.5.1 RDB模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-AOF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">2.5.2 AOF模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Redis%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.7.</span> <span class="toc-text">2.6 Redis常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-INFO"><span class="toc-number">1.3.7.1.</span> <span class="toc-text">2.6.1 INFO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-SELECT"><span class="toc-number">1.3.7.2.</span> <span class="toc-text">2.6.2 SELECT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-3-KEYS"><span class="toc-number">1.3.7.3.</span> <span class="toc-text">2.6.3 KEYS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-4-BGSAVE"><span class="toc-number">1.3.7.4.</span> <span class="toc-text">2.6.4  BGSAVE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-5-DBSIZE"><span class="toc-number">1.3.7.5.</span> <span class="toc-text">2.6.5 DBSIZE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-6-FLUSHDB"><span class="toc-number">1.3.7.6.</span> <span class="toc-text">2.6.6 FLUSHDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-7-FLUSHALL"><span class="toc-number">1.3.7.7.</span> <span class="toc-text">2.6.7 FLUSHALL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-8-SHUTDOWN"><span class="toc-number">1.3.7.8.</span> <span class="toc-text">2.6.8 SHUTDOWN</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.8.</span> <span class="toc-text">2.7 Redis的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1-%E5%AD%97%E7%AC%A6%E4%B8%B2-string"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">2.7.1 字符串 string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-2-%E5%88%97%E8%A1%A8-list"><span class="toc-number">1.3.8.2.</span> <span class="toc-text">2.7.2 列表 list</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-3-%E9%9B%86%E5%90%88-set"><span class="toc-number">1.3.8.3.</span> <span class="toc-text">2.7.3 集合 set</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-4-%E5%93%88%E5%B8%8C-hash"><span class="toc-number">1.3.8.4.</span> <span class="toc-text">2.7.4 哈希 hash</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.3.9.</span> <span class="toc-text">2.8 消息队列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">3 Redis 高可用性和集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%9A"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">3.1.1 主从复制的优化：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%93%A8%E5%85%B5-Sentinel"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 哨兵 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%AE%9E%E7%8E%B0%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%88%87%E6%8D%A2"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">3.2.1 实现主服务器的切换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%9E%E6%8E%A5sentinel"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">3.2.2 应用程序连接sentinel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Redis-Cluster%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 Redis Cluster集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-Cluster%E9%9B%86%E7%BE%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">3.3.1 Cluster集群的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">操作：使用原生命令部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%EF%BC%9A%E4%BD%BF%E7%94%A8Redis-5-0%E9%83%A8%E7%BD%B2Cluster"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">操作：使用Redis 5.0部署Cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%EF%BC%9A%E4%BD%BF%E7%94%A8Redis-4-x-%E9%83%A8%E7%BD%B2Cluster"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">操作：使用Redis 4.x 部署Cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E9%9B%86%E7%BE%A4%E7%9A%84%E6%89%A9%E5%AE%B9"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">3.3.2 集群的扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BC%A9%E5%AE%B9"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">3.3.3 集群的缩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-5-%E6%8A%8A%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">3.3.5 把数据导入集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-%E9%9B%86%E7%BE%A4%E5%81%8F%E6%96%9C"><span class="toc-number">1.4.3.8.</span> <span class="toc-text">3.3.6 集群偏斜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-7-Redis-cluster%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.4.3.9.</span> <span class="toc-text">3.3.7 Redis cluster的局限性</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="huihui"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="辉辉的数据库"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-11-18 08:48:10" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2020-11-19 08:46:34" itemprop="dateModified" datetime="2020-11-19T08:46:34+08:00">2020-11-19</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1 id="NoSQL数据库Redis"><a href="#NoSQL数据库Redis" class="headerlink" title="NoSQL数据库Redis"></a>NoSQL数据库Redis</h1><h2 id="nosql-not-only-sql"><a href="#nosql-not-only-sql" class="headerlink" title="nosql: not only sql"></a><strong>nosql: not only sql</strong></h2><a id="more"></a>

<h2 id="1-缓存技术"><a href="#1-缓存技术" class="headerlink" title="1 缓存技术"></a>1 缓存技术</h2><p>缓存是在物理速度有差距的两个硬件中间的过渡</p>
<p>一级缓存：</p>
<p>二级缓存：</p>
<p>三级缓存：</p>
<p>LRU：近期最少使用算法</p>
<p>凡事有利有弊，缓存也有问题；例如缓存中的数据与硬盘中的数据不一致；缓存价格高</p>
<h3 id="1-1-缓存"><a href="#1-1-缓存" class="headerlink" title="1.1 缓存"></a>1.1 缓存</h3><h4 id="1-1-1-buffer与cache"><a href="#1-1-1-buffer与cache" class="headerlink" title="1.1.1 buffer与cache"></a>1.1.1 buffer与cache</h4><p>buffer：缓冲，也叫写缓冲，一般用作写操作</p>
<p>清除缓存的方法：<code>echo 3 &gt; /proc/sys/vm/drop_caches</code>，查看帮助：<code>man proc</code>然后搜索<code>drop_caches</code></p>
<p>cache：缓存，也叫读缓存，一般用于读操作</p>
<h4 id="1-1-2-缓存保存位置及分层结构"><a href="#1-1-2-缓存保存位置及分层结构" class="headerlink" title="1.1.2 缓存保存位置及分层结构"></a>1.1.2 缓存保存位置及分层结构</h4><p>缓存技术是<code>互联网应用快速</code>的核心技术</p>
<ul>
<li>用户层：浏览器DNS缓存，应用程序DNS缓存，操作系统DNS缓存客户端</li>
<li>代理层：CDN，反向代理缓存</li>
<li>Web层：解释器Opcache，Web服务器缓存</li>
<li>应用层：页面静态化</li>
<li>数据层：分布式缓存，数据库</li>
<li>系统层：操作系统cache</li>
<li>物理层：磁盘cahche，Raid Cache</li>
</ul>
<h4 id="1-1-3-cache的特性"><a href="#1-1-3-cache的特性" class="headerlink" title="1.1.3 cache的特性"></a>1.1.3 cache的特性</h4><p>自动过期：给缓存的数据加上有效时间，超出时间后自动过期删除</p>
<p>强制过期：源网站更新图片后CDN是不会更新的，需要强制图片缓存过期，通过CDN后台设置</p>
<p>命中率：即缓存的读取命中率</p>
<h3 id="1-2-用户层缓存"><a href="#1-2-用户层缓存" class="headerlink" title="1.2 用户层缓存"></a>1.2 用户层缓存</h3><h4 id="1-2-1-DNS缓存"><a href="#1-2-1-DNS缓存" class="headerlink" title="1.2.1 DNS缓存"></a>1.2.1 DNS缓存</h4><p>浏览器的DNS缓存默认60秒</p>
<h4 id="1-2-2-查看浏览器的缓存"><a href="#1-2-2-查看浏览器的缓存" class="headerlink" title="1.2.2 查看浏览器的缓存"></a>1.2.2 查看浏览器的缓存</h4><p>火狐：about:cache</p>
<h4 id="1-2-2-前端使用的技术–dns-prefetch"><a href="#1-2-2-前端使用的技术–dns-prefetch" class="headerlink" title="1.2.2 前端使用的技术–dns-prefetch"></a>1.2.2 前端使用的技术–dns-prefetch</h4><p>HTML5的技术，可以在加载页面时提前将一些域名转换成IP地址</p>
<h4 id="1-2-4-浏览器缓存过期机制："><a href="#1-2-4-浏览器缓存过期机制：" class="headerlink" title="1.2.4 浏览器缓存过期机制："></a>1.2.4 浏览器缓存过期机制：</h4><p><strong>HTTP的状态码：304 Not Modified</strong> </p>
<p>304：服务器判断本地缓存文件与服务器上的文件一致，无需再次从服务器下载时，返回给用户304状态码</p>
<p><strong>if-last-modified：最后修改时间</strong></p>
<p><strong>Etags标记：Entity tag</strong></p>
<p>报文中有：If-None-Match  服务器会比较自己的文件的Etag值与if-None-Match的值是否一致</p>
<p>Etag：对文件的<strong>哈希运算（？）</strong>得到的值，每次都进行对比</p>
<p><strong>expire：有效期</strong></p>
<p>在有效期来临之前，不会重新向服务器发出该资源的请求</p>
<p><strong>混合使用前面提到的几种方式</strong></p>
<ul>
<li>Last-Modified和Expire，每次刷新都有新的Last-Modified</li>
<li>Etag和Expire一起使用，先判断Expire，然后判断Etag</li>
<li>三个一起用，先判断Expire，然后判断Last-Modified，再判断Etag</li>
</ul>
<p>缓存的刷新：</p>
<ul>
<li>第一次访问，获取最新数据，返回200响应码</li>
<li>鼠标点击或输入地址后回车（cache），浏览器对所有没有过期的内容直接使用本地缓存</li>
<li>F5或点刷新，浏览器会向服务器发送请求缓存协商信息，Last-Modified和Etag会有影响，但Expire不受影响，如果没有变化，返回304</li>
<li>ctrl+F5：不使用所有缓存，直接访问地址</li>
</ul>
<p><strong>Cookie和session</strong></p>
<p>cookie：访问网站时保持在本地的相关信息，比如账号密码，下次再访问的时候会在报文中增加cookie，方便一点</p>
<p>cookies：是服务器在客户单浏览器上存储的小段文本并随着每一个请求发送至同一个服务器，是一种实现客户端保持状态的方案</p>
<p>session：会话信息，位于web服务器上，主要负责访问者与网站之间的交互，当浏览器请求http地址时，可以基于之前的session实现会话保持、session共享。</p>
<h3 id="1-3-CDN缓存"><a href="#1-3-CDN缓存" class="headerlink" title="1.3 CDN缓存"></a>1.3 CDN缓存</h3><p>302重定向技术</p>
<p>CDN分层缓存技术</p>
<h3 id="1-4应用层缓存"><a href="#1-4应用层缓存" class="headerlink" title="1.4应用层缓存"></a>1.4应用层缓存</h3><p>Nginx、PHP等web服务器可以设置应用缓存以加速响应速度，另外有些解释性语言，比如：Python/PHP/Java不能直接运行，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候会出现程序代码上线后字节码没有更新的现象。所以上线新版前，需要先将应用缓存清理，再上线新版。</p>
<h3 id="1-5-数据层缓存"><a href="#1-5-数据层缓存" class="headerlink" title="1.5 数据层缓存"></a>1.5 数据层缓存</h3><p>分布式缓存服务：</p>
<ul>
<li>Redis</li>
<li>Memcache</li>
</ul>
<p>数据库</p>
<ul>
<li>Mysql查询缓存（不使用了）</li>
<li>InnoDB缓存、MYISAM缓存</li>
</ul>
<h3 id="1-6-CPU缓存"><a href="#1-6-CPU缓存" class="headerlink" title="1.6 CPU缓存"></a>1.6 CPU缓存</h3><p>CPU缓存（L1）、二级缓存（L2）、三级缓存（L3）</p>
<h2 id="2-Redis-部署和使用"><a href="#2-Redis-部署和使用" class="headerlink" title="2 Redis 部署和使用"></a>2 Redis 部署和使用</h2><h3 id="2-1-RDBMS和NOSQL的各自优缺点"><a href="#2-1-RDBMS和NOSQL的各自优缺点" class="headerlink" title="2.1 RDBMS和NOSQL的各自优缺点"></a>2.1 RDBMS和NOSQL的各自优缺点</h3><p>Redis (Remote Dictionary Server) ：是一个开源的、键值数据库</p>
<p>Redis在高并发、低延迟方面很好</p>
<p>NOSQL的根本优势在于云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高</p>
<p>NOSQL的事务支持弱，join的操作弱，通用性差</p>
<p>官方网站：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis特性"><a href="#2-2-Redis特性" class="headerlink" title="2.2 Redis特性"></a>2.2 Redis特性</h3><ul>
<li>速度快：10W并发，C语言开发，单线程</li>
<li>持久化</li>
<li>支持多种数据结构</li>
<li>支持多种变成语言</li>
<li>功能丰富：支持Luau脚本，发布订阅，事务，pipeline等功能</li>
<li>简单：代码短小精悍（23000行左右代码）</li>
<li>主从复制</li>
<li>支持高可用和分布式</li>
</ul>
<h3 id="2-3-单线程"><a href="#2-3-单线程" class="headerlink" title="2.3 单线程"></a>2.3 单线程</h3><p>单线程为什么这么快？</p>
<ul>
<li>纯内存</li>
<li>非阻塞</li>
<li>避免线程切换和竟态消耗</li>
</ul>
<p>注意：</p>
<ul>
<li>一次只运行一条命令</li>
<li>拒绝长命令</li>
<li>其实不是单线程：早期是单线程，3版本后还有其他线程，fysnc file,descriptor,close file descriptor</li>
</ul>
<p>能用来解决问题的技术</p>
<ul>
<li>session共享</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>互联网的计数器，比如微博的点赞，排行榜</li>
<li>微博/微信社交场合：共同好友、粉丝数、关注、点赞等</li>
<li>消息队列</li>
<li>地理位置</li>
</ul>
<h3 id="2-4-Redis-安装和使用"><a href="#2-4-Redis-安装和使用" class="headerlink" title="2.4 Redis 安装和使用"></a>2.4 Redis 安装和使用</h3><p><strong>1.yum安装，需要epel源</strong></p>
<p><strong>2.Redis的编译安装</strong></p>
<h4 id="2-1-编译安装步骤"><a href="#2-1-编译安装步骤" class="headerlink" title="2.1 编译安装步骤"></a>2.1 编译安装步骤</h4><p>下载</p>
<p>下载地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;</span><br></pre></td></tr></table></figure>

<p>选择一个5.x版本的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd redis-5.0.9</span><br><span class="line">make --PREFIX&#x3D;&#x2F;app&#x2F; install</span><br></pre></td></tr></table></figure>



<h4 id="2-2-内核参数修改"><a href="#2-2-内核参数修改" class="headerlink" title="2.2 内核参数修改"></a>2.2 内核参数修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn  #Redis需要511，系统默认是128，改成1024</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">#操作</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">To fix this issue run the command &#39;echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent    _hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the     setting after a reboot. Redis must be restarted after THP is disabled (set to &#39;madvise&#39; or &#39;never&#39;).</span><br><span class="line">#操作</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">#添加</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br></pre></td></tr></table></figure>

<h4 id="2-3-配置文件修改"><a href="#2-3-配置文件修改" class="headerlink" title="2.3 配置文件修改"></a>2.3 配置文件修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">11 # 1k &#x3D;&gt; 1000 bytes</span><br><span class="line">12 # 1kb &#x3D;&gt; 1024 bytes</span><br><span class="line">13 # 1m &#x3D;&gt; 1000000 bytes</span><br><span class="line">14 # 1mb &#x3D;&gt; 1024*1024 bytes                                                    </span><br><span class="line">15 # 1g &#x3D;&gt; 1000000000 bytes</span><br><span class="line">16 # 1gb &#x3D;&gt; 1024*1024*1024 bytes</span><br><span class="line">#文档中关于数据单位的说明</span><br></pre></td></tr></table></figure>

<p>配置文件讲解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">protected-mode yes #默认开启，这个是管理其他主机登录本机redis数据库的安全设置，本机只有设置了bind地址或者配置了密码才能被登录</span><br><span class="line">port 6379  #监听端口，TCP</span><br><span class="line">daemonize yes  #是否后台使用守护进程运行，默认是前台执行的</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid  </span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;    #生成数据文件的存放目录</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br><span class="line">timeout 0 #客户端和redis服务端的连接超时时间，默认是0，表示永不超时</span><br><span class="line">requirepass centos #密码</span><br><span class="line">maxclients  100000   #最大连接数</span><br><span class="line">maxmemory &lt;bytes&gt;  #Redis使用的最大内存，单位为字节，0是不限制，建议设置为物理内存的一半</span><br><span class="line">					注意不要出现OOM，Out Of Memory</span><br><span class="line">supervised systemd #默认为no，如果想用systemd管理，就设置成systemd</span><br><span class="line"></span><br><span class="line">#主从复制相关的选项</span><br><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt; #配置主服务器的IP和端口</span><br><span class="line">masterauth &lt;master-password&gt; #如果主服务器开启requirepass了，那么从服务器也需要输入密码</span><br><span class="line">replica-read-only yes #从服务器默认为只读</span><br><span class="line">repl-diskless-sync no #实验阶段，不推荐使用，默认就是拒绝</span><br><span class="line">rename-command  #重命名一些危险的命令，相当于屏蔽掉命令，比如keys * ,flushdb,flushall</span><br><span class="line">appendonly no #默认是no，appendonly是一种类似二进制的日志方式，而且优先级高于默认的rdb方式，当启				用appendonly后，redis启动时会从aof文件恢复数据</span><br><span class="line">appendfilename &quot;appendonly.aof&quot; aof文件，目录是dir指定的</span><br><span class="line">appendfsync everysec #默认的，每秒钟写一次</span><br><span class="line">#appendfsync always  #这个是安全，每次修改数据库都会写入磁盘，但是性能差</span><br><span class="line">no-appendfsync-on-rewrite no #建议设置为yes，这个是说在append重写的时候是否可以继续写磁盘，默								认是no，最安全，可以写磁盘，但是会阻塞；</span><br><span class="line">								设置为yes会写在缓冲区内，等重新结束后才写磁盘，这个性能好，但是								会不安全，因为最多有30秒时间的数据可能会因为断电等原因写不进磁盘</span><br><span class="line">auto-aof-rewrite-percentage 100 #自动重写检测的百分比，因为rewrite会根据aof中的清理数据库操作，比如del,flushdb等来删除数据，缩小文件大小，同时数据也是安全的。这个值的意思是aof增长超过一倍，那么就执行一次重写操作。</span><br><span class="line">auto-aof-rewrite-min-size 64mb  #触发rewrite的最小文件大小</span><br><span class="line">auto-load-truncated yes  #是否加载由于某些原因导致的末尾异常的AOF文件（主进程被kill&#x2F;断电等），建议yes</span><br><span class="line"></span><br><span class="line">#集群相关：</span><br><span class="line">cluster-enabled yes #是否开启集群模式，默认是不开启的</span><br><span class="line">cluster-config-file nodes-6379.conf #由node节点自动生成的集群配置文件名称</span><br><span class="line">cluster-node-timeout 15000  #集群中node节点连接超时时间，单位ms，超过此时间，会踢出集群</span><br><span class="line">cluster-replica-validity-factor 10 #单位是 “次数” </span><br><span class="line">cluster-migration-barrier 1 #集群迁移屏障，一个主节点至少拥有一个正常工作的从节点，即如果主节点的slave节点								故障后会将多余的从节点分配到当前主节点称为其新的从节点</span><br><span class="line">cluster-require-full-coverage yes #建议为no</span><br><span class="line">cluster-replica-no-failover no #默认是no，建议no</span><br><span class="line"></span><br><span class="line">#慢日志相关：</span><br><span class="line">slowlog-log-slower-than 10000 #以微妙为单位的慢日志记录，这个是10ms</span><br><span class="line">slowlog-max-len 128  #最多记录多少条慢日志的保存队列长度，滚动更新。先进先出，队列固定长度</span><br></pre></td></tr></table></figure>

<p>额外介绍</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LRU means Least Recently Used</span><br><span class="line">LFU means Least Frequently Used</span><br></pre></td></tr></table></figure>

<p>使用systemd的方式启动redis-server  </p>
<p><strong>注意：这个service是redis6.x版本的，不同版本之间的差异还是有的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;下建立redis_6379.service文件</span><br><span class="line">  1 [Unit]</span><br><span class="line">  2 Description&#x3D;Redis persistent key-value database</span><br><span class="line">  3 Wants&#x3D;network-online.target</span><br><span class="line">  4 After&#x3D;network-online.target</span><br><span class="line">  5 </span><br><span class="line">  6 [Service]</span><br><span class="line">  7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;conf&#x2F;redis_6379.conf --supervised systemd</span><br><span class="line">  8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line">  9 Type&#x3D;forking         #重点是这里，6.X的redis要写成forKing，后台模式，不能写notify                                                                                                                        </span><br><span class="line"> 10 User&#x3D;redis</span><br><span class="line"> 11 Group&#x3D;redis</span><br><span class="line"> 12 TimeoutStartSec&#x3D;infinity</span><br><span class="line"> 13 TimeoutStopSec&#x3D;infinity</span><br><span class="line"> 14 [Install]</span><br><span class="line"> 15 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.4编译安装和参数修改和配置文件修改的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	install_redis_5.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line"></span><br><span class="line">BASEDIR&#x3D;&#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">VERSION&#x3D;redis-5.0.9</span><br><span class="line">APPDIR&#x3D;&#x2F;app&#x2F;redis</span><br><span class="line">PASSWORD&#x3D;&quot;centos&quot;</span><br><span class="line">START_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line"></span><br><span class="line">check_env () </span><br><span class="line">&#123;</span><br><span class="line">    id redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &#39;redis用户已存在，请检查环境&#39; false </span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ -f $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;.tar.gz ];then</span><br><span class="line">        action &#39;源码包已存在，请检查环境&#39; false </span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    if [ -d $APPDIR ];then</span><br><span class="line">        action &quot;$&#123;APPDIR&#125;已存在，请检查环境&quot; false</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    action &quot;环境检查完成，开始安装$&#123;VERSION&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">install_redis () </span><br><span class="line">&#123;</span><br><span class="line">    yum -y install wget gcc jemalloc-devel  &amp;&gt;&#x2F;dev&#x2F;null || &#123; action &#39;依赖包安装失败&#39; false;exit 10;&#125;</span><br><span class="line">   </span><br><span class="line">    wget -P $&#123;BASEDIR&#125; https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;$&#123;VERSION&#125;.tar.gz &amp;&gt;&#x2F;dev&#x2F;null || action &#39;下载源码包失败&#39; false</span><br><span class="line">    cd $&#123;BASEDIR&#125;</span><br><span class="line">    tar xf $&#123;VERSION&#125;.tar.gz </span><br><span class="line">    </span><br><span class="line">    cd $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125; </span><br><span class="line">    echo &quot;开始编译安装&quot;</span><br><span class="line">    echo &quot;...&quot;</span><br><span class="line">    make PREFIX&#x3D;$&#123;APPDIR&#125; install &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;编译安装成功!&quot; || &#123; action &quot;编译安装失败&quot; false;exit 4; &#125;</span><br><span class="line">    </span><br><span class="line">    mkdir -p $&#123;APPDIR&#125;&#x2F;&#123;etc,data,run,log&#125; </span><br><span class="line">    </span><br><span class="line">    useradd -r -s &#x2F;sbin&#x2F;nologin redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">   </span><br><span class="line">    ln -s $&#123;APPDIR&#125;&#x2F;bin&#x2F;*  &#x2F;usr&#x2F;local&#x2F;bin&#x2F; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">    cp $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;&#x2F;redis.conf $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line">    sysctl -p</span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;rc.d&#x2F;rc.local&lt;&lt;EOF</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">EOF</span><br><span class="line">    chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    sed -i -E &quot;s&#x2F;^daemonize no&#x2F;daemonize yes&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^(bind ).*&#x2F;\10.0.0.0&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^supervised no&#x2F;supervised systemd&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(pidfile).*#\1 $&#123;APPDIR&#125;&#x2F;run&#x2F;redis.pid#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(logfile).*#\1 $&#123;APPDIR&#125;&#x2F;log&#x2F;redis.log#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dbfilename).*#\1 dump.rdb#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dir).*#\1 $&#123;APPDIR&#125;&#x2F;data&#x2F;#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;&#x2F;^# requirepass foobared&#x2F;a requirepass $&#123;PASSWORD&#125;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    chown -R redis.redis $&#123;APPDIR&#125;</span><br><span class="line">    </span><br><span class="line">    cat&gt;&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Redis persistent key-value database</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;$&#123;APPDIR&#125;&#x2F;bin&#x2F;redis-server $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf --supervised systemd</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT \$MAINPID</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">User&#x3D;redis</span><br><span class="line">Group&#x3D;redis</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl start redis &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;redis服务启动！&quot; || action &quot;redis服务启动失败，检查&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service，$&#123;APPDIR&#125;下的文件属性、配置文件&quot; false</span><br><span class="line">    END_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line">    USED_TIME&#x3D;$(( $END_TIME - $START_TIME ))    </span><br><span class="line">    echo &quot;脚本总用时：$&#123;USED_TIME&#125;s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_env</span><br><span class="line">install_redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.5写成playbook，使用角色实现</p>
<p><strong>3.Redis的多实例</strong></p>
<p>下面的这些选项中6379都改成其他端口，比如6380,6381等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>做好的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 redis]$tree</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── redis-benchmark</span><br><span class="line">│   ├── redis-check-aof</span><br><span class="line">│   ├── redis-check-rdb</span><br><span class="line">│   ├── redis-cli</span><br><span class="line">│   ├── redis-sentinel -&gt; redis-server</span><br><span class="line">│   └── redis-server</span><br><span class="line">├── conf</span><br><span class="line">│   ├── redis_6379.conf</span><br><span class="line">│   ├── redis_6380.conf</span><br><span class="line">│   └── redis_6381.conf</span><br><span class="line">├── data</span><br><span class="line">├── log</span><br><span class="line">│   ├── redis_6379.log</span><br><span class="line">│   ├── redis_6380.log</span><br><span class="line">│   ├── redis_6381.log</span><br><span class="line">│   └── redis.log</span><br><span class="line">└── run</span><br><span class="line">    ├── redis_6379.pid</span><br><span class="line">    ├── redis_6380.pid</span><br><span class="line">    └── redis_6381.pid</span><br><span class="line"></span><br><span class="line">5 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改内核参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn &#x3D; 1024 #Redis默认511，linux默认是128，太小了，所以要调整大一点</span><br><span class="line"></span><br><span class="line">vm.overcommit_memory &#x3D; 1 #linux默认是0，Redis建议设置为1</span><br><span class="line"></span><br><span class="line">&#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39;  ，然后把这个加入到&#x2F;etc&#x2F;rc.local中，因为这个是sys目录下的变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;apps&#x2F;redis&#x2F;etc&#x2F;redis.conf  #</span><br></pre></td></tr></table></figure>



<h3 id="2-5-慢查询"><a href="#2-5-慢查询" class="headerlink" title="2.5 慢查询"></a>2.5 慢查询</h3><p>slowlog-log-slower-than 10000  #单位是微秒，这个是10ms的意思，Redis的慢是指超过10ms</p>
<p>配置文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128 </span><br></pre></td></tr></table></figure>

<p>命令行指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slowlog len</span><br><span class="line">slowlog get N #查看具体的慢查询，可以限制个数</span><br><span class="line">slowlog reset</span><br></pre></td></tr></table></figure>

<p>一个命令大约在5us</p>
<h3 id="2-5-Redis-持久化"><a href="#2-5-Redis-持久化" class="headerlink" title="2.5 Redis 持久化"></a>2.5 Redis 持久化</h3><p>持久化：按照一定的策略把Redis内存中的数据存放到磁盘中，从而实现数据持久保存的目的</p>
<p>目前Redis支持两种方式的数据持久化保存机制，分别是RDB和AOF</p>
<p>RDB ~ MYSQL DUMP  –&gt;快照</p>
<p>AOF ~ MYSQL BINLOG  –&gt;写日志</p>
<h4 id="2-5-1-RDB模式"><a href="#2-5-1-RDB模式" class="headerlink" title="2.5.1 RDB模式"></a>2.5.1 RDB模式</h4><p>Redis-Server –&gt; fork子进程[专门用于dump操作] –&gt; 临时文件[temp-‘子进程PID’] –&gt; 覆盖到dump文件</p>
<p>配置文件中选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 294 #   In the example below the behaviour will be to save:</span><br><span class="line"> 295 #   after 900 sec (15 min) if at least 1 key changed</span><br><span class="line"> 296 #   after 300 sec (5 min) if at least 10 keys changed</span><br><span class="line"> 297 #   after 60 sec if at least 10000 keys changed</span><br><span class="line">#这个是自动保存规则，通过条件触发RDB保存</span><br><span class="line"> 307 save 900 1</span><br><span class="line"> 308 save 300 10</span><br><span class="line"> 309 save 60 10000</span><br></pre></td></tr></table></figure>

<p>手动执行RDB</p>
<ul>
<li><pre><code>save --&gt; 直接进行RDB备份，备份目录是配置文件中写好的
#同步执行，但是会阻塞其他命令，不推荐使用
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* &#96;&#96;&#96;</span><br><span class="line">  bgsave --&gt; 异步后台执行，不影响其他命令的执行，推荐使用，使用的时候参考一个参数，rdb_bgsave_in_progress &#x3D; 0  是0的时候就是执行完成了</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>数据还原：</p>
<p>把数据文件名称改成配置文件中规定的文件名，然后重启服务</p>
<p><strong>优劣势：</strong></p>
<p>优点：</p>
<ul>
<li>就像快照，可以保存多个版本，恢复数据的时候可以选择恢复到哪个时间点</li>
<li>性能好，它可以使用子进程进行备份操作，父进程在fork出一个子进程后将不参与I/O，所以不影响本身的读写操作</li>
<li>RDB在恢复大量数据时比AOF快</li>
</ul>
<p>缺点：</p>
<ul>
<li>在断电等情况发生时，可能会丢失两次备份之间的内存数据</li>
<li>当数据量比较大时，父进程fork一个子进程需要一点时间，因为redis单线程，会阻塞</li>
</ul>
<p><strong>脚本：手动方式备份RDB文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#注意：使用RDB恢复数据就不要开启AOF</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	backup_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILE&#x3D;&quot;dump&quot;</span><br><span class="line">PASSWD&#x3D;&quot;centos&quot;</span><br><span class="line"></span><br><span class="line">#For test path</span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning bgsave</span><br><span class="line">[ -d $BACKDIR ] || mkdir -p $BACKDIR </span><br><span class="line"></span><br><span class="line">single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line"></span><br><span class="line">until [ $single -eq 0 ];do</span><br><span class="line">    sleep 1</span><br><span class="line">    single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">DATE&#x3D;&#96;date +%F_%H-%M_%S&#96;</span><br><span class="line">cp $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILE&#125;.rdb $BACKDIR&#x2F;$&#123;DATAFILE&#125;_$&#123;DATE&#125;.rdb </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>脚本：手动方式还原最新的数据文件到redis</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	recover_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line">#recover the latest rdb file </span><br><span class="line"></span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILENAME&#x3D;&quot;dump.rdb&quot;</span><br><span class="line"></span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">systemctl stop redis</span><br><span class="line"></span><br><span class="line">LASTEST_FILENAME&#x3D;&#96;ls -lt $&#123;BACKDIR&#125; | awk &#39;NR&#x3D;&#x3D;2&#123;print $NF&#125;&#39;&#96;  #找出最新的备份文件</span><br><span class="line"></span><br><span class="line">rm -f $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125; </span><br><span class="line"></span><br><span class="line">cp $&#123;BACKDIR&#125;&#x2F;$&#123;LASTEST_FILENAME&#125; $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125;</span><br><span class="line"></span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-5-2-AOF模式"><a href="#2-5-2-AOF模式" class="headerlink" title="2.5.2 AOF模式"></a>2.5.2 AOF模式</h4><p><strong>AOF：AppendOnlyFile，按照顺序依次将操作追加到指定日志末尾</strong></p>
<p>fsync策略：</p>
<ul>
<li>每1秒钟写入一次文件；</li>
<li>每次变更数据时写入文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfsync everysec  #默认的everysec是每秒钟写入磁盘，改成always就是每次变更都写入文件</span><br></pre></td></tr></table></figure>

<p>默认是RDB，AOF需要开启配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;，数据文件的存放路径还是由 dir决定的</span><br></pre></td></tr></table></figure>

<p>AOF优先级比RDB高</p>
<p>从配置文件设定AOF启动后，重启服务时会使用AOF的数据文件，之前使用的RDB数据文件就没有被使用，因此有些问题。</p>
<p>正确的使用AOF的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.开启服务，默认使用RDB</span><br><span class="line">2.保存数据</span><br><span class="line">3.在命令行用config set appendonly yes 开启AOF</span><br><span class="line">4.观察数据目录中，是否已经将之前的RDB的数据文件写入AOF数据文件中了</span><br><span class="line">5.完成后，再去配置文件中启动AOF</span><br></pre></td></tr></table></figure>

<p>数据恢复操作：</p>
<p>在aof日志中删除之前的误操作动作，然后重启服务就好了</p>
<p><strong>AOF rewrite 重写</strong></p>
<p>将一些重复的，可以合并的，过期的数据重新写入一个新的AOF文件，从而节约AOF备份占用的硬盘空间，也能加速恢复过程</p>
<p>通过flushdb进行db0数据库的清空</p>
<p>bgwrite –&gt; 父进程 –&gt; fork一个子进程 –&gt; 子进程创建新的aof日志 –&gt; 父进程把rewrite数据写入新的aof日志 –&gt; 子进程把新的aof日志覆盖原来的aof日志</p>
<p>手动执行重新：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewriteaof</span><br></pre></td></tr></table></figure>

<p><strong>AOF的优缺点：</strong></p>
<p>优点：</p>
<ul>
<li>数据安全性高</li>
<li>写入日志的模式是追加的方式，更高效和安全</li>
<li>Redis可以在AOF文件体积变得过大时，自动地在后台对AOF进行重写，重写后的新AOF文件包含了恢复当前数据集的最小命令集合。整个重写过程是安全的，因为Redis是fork一个子进程来写入新的AOF日志，而append模式也就是父进程不断的将修改的数据追加到现有的AOF日志，即使重写过程发生停机，现有的AOF文件也不会丢失。而一旦新AOF文件创建完毕，Redis就会从旧AOF文件切换到新AOF文件，并开始对新AOF文件进行追加操作。</li>
<li>AOF包含一个格式清晰、易于理解的日志文件用于记录有所的修改操作。事实上，也可以通过该文件完成数据的重建。</li>
</ul>
<p>缺点：</p>
<ul>
<li>即使有些操作是重复的也会全部记录，AOF的文件大小要大于RDB模式的文件</li>
<li>AOF在恢复大数据集时的数据比RDB的恢复速度要慢</li>
<li>根据fsync策略不同，AOF速度可能慢于RDB</li>
<li>bug出现的可能性更多</li>
</ul>
<h3 id="2-6-Redis常用命令"><a href="#2-6-Redis常用命令" class="headerlink" title="2.6 Redis常用命令"></a>2.6 Redis常用命令</h3><p>官方文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;commands</span><br></pre></td></tr></table></figure>

<h4 id="2-6-1-INFO"><a href="#2-6-1-INFO" class="headerlink" title="2.6.1 INFO"></a>2.6.1 INFO</h4><p>获取信息</p>
<h4 id="2-6-2-SELECT"><a href="#2-6-2-SELECT" class="headerlink" title="2.6.2 SELECT"></a>2.6.2 SELECT</h4><h4 id="2-6-3-KEYS"><a href="#2-6-3-KEYS" class="headerlink" title="2.6.3 KEYS"></a>2.6.3 KEYS</h4><p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keys pattern</span><br><span class="line"></span><br><span class="line">例子</span><br><span class="line"></span><br><span class="line">keys * ......#这个是明令禁止的操作.....</span><br></pre></td></tr></table></figure>



<h4 id="2-6-4-BGSAVE"><a href="#2-6-4-BGSAVE" class="headerlink" title="2.6.4  BGSAVE"></a>2.6.4  BGSAVE</h4><h4 id="2-6-5-DBSIZE"><a href="#2-6-5-DBSIZE" class="headerlink" title="2.6.5 DBSIZE"></a>2.6.5 DBSIZE</h4><h4 id="2-6-6-FLUSHDB"><a href="#2-6-6-FLUSHDB" class="headerlink" title="2.6.6 FLUSHDB"></a><strong>2.6.6 FLUSHDB</strong></h4><h4 id="2-6-7-FLUSHALL"><a href="#2-6-7-FLUSHALL" class="headerlink" title="2.6.7 FLUSHALL"></a>2.6.7 FLUSHALL</h4><h4 id="2-6-8-SHUTDOWN"><a href="#2-6-8-SHUTDOWN" class="headerlink" title="2.6.8 SHUTDOWN"></a>2.6.8 SHUTDOWN</h4><p>禁用危险命令！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中找到rename-command</span><br><span class="line">配置：</span><br><span class="line">rename-command key* &#39;&#39;</span><br><span class="line">rename-command flushdb &#39;&#39;</span><br><span class="line">rename-command flushall &#39;&#39;</span><br></pre></td></tr></table></figure>



<h3 id="2-7-Redis的数据类型"><a href="#2-7-Redis的数据类型" class="headerlink" title="2.7 Redis的数据类型"></a>2.7 Redis的数据类型</h3><h4 id="2-7-1-字符串-string"><a href="#2-7-1-字符串-string" class="headerlink" title="2.7.1 字符串 string"></a>2.7.1 字符串 string</h4><p><strong>set命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set key value [ EX|PX ] time [NX|XX]</span><br><span class="line">EX：有效时间，单位是秒</span><br><span class="line">PX：有效时间，单位是毫秒</span><br><span class="line">NX：判断该键是否有值了，有值了就不动，没有值了才设置，XX相反</span><br></pre></td></tr></table></figure>

<p><strong>查看有效时间的命令ttl</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl key</span><br></pre></td></tr></table></figure>

<p><strong>get命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<p><strong>批量的命令mset，mget</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mget key1 key2 ..</span><br><span class="line">mset key1 value1 key2 value2...</span><br></pre></td></tr></table></figure>

<p><strong>字符串追加append，返回值是字节长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key1 ‘xxxxx’</span><br></pre></td></tr></table></figure>

<p><strong>返回字符串长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<p><strong>设置新值，返回旧值getset</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getset key1 new_value</span><br><span class="line">return old_value</span><br></pre></td></tr></table></figure>

<p><strong>判断键是否存在</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key1</span><br></pre></td></tr></table></figure>

<p><strong>数值递增递减</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INCR KEY1  加1</span><br><span class="line">DECR KEY1  减1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数值增加/减少</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INCRBY KEY1 NUMBER</span><br><span class="line">incrby age 20</span><br><span class="line">incrby age -20</span><br><span class="line"></span><br><span class="line">DECRBY KEY1 NUMBER</span><br><span class="line">decrby age 20</span><br><span class="line">decrby age -20</span><br></pre></td></tr></table></figure>



<h4 id="2-7-2-列表-list"><a href="#2-7-2-列表-list" class="headerlink" title="2.7.2 列表 list"></a>2.7.2 列表 list</h4><p>lpush：从左侧开始往列表中增加元素</p>
<p>rpush：从右侧开始往列表中增加元素</p>
<p>lrange：</p>
<p>lindex：</p>
<p>lpop：</p>
<p>rpop：</p>
<p>ltrim</p>
<h4 id="2-7-3-集合-set"><a href="#2-7-3-集合-set" class="headerlink" title="2.7.3 集合 set"></a>2.7.3 集合 set</h4><p>集合是唯一的，不能重复</p>
<p>sadd</p>
<p>smembers</p>
<p>srem</p>
<p>集合间操作</p>
<p>sinter</p>
<p>sunion</p>
<p>sdiff</p>
<p>有序集合 sorted set： –&gt; 排行榜</p>
<ul>
<li>有序</li>
<li>无重复元素</li>
<li>每个元素由score和value组成</li>
<li>score可以重复</li>
<li>value不可以重复</li>
</ul>
<p>zadd</p>
<p>zrange music 0 -1  #取出全部元素  </p>
<p>zcard music  #取出元素个数</p>
<p>zscore music  #取出分值</p>
<p>zrank</p>
<p>zrem</p>
<h4 id="2-7-4-哈希-hash"><a href="#2-7-4-哈希-hash" class="headerlink" title="2.7.4 哈希 hash"></a>2.7.4 哈希 hash</h4><p>hset </p>
<p>hgetall</p>
<p>type</p>
<p>hget </p>
<p>hmget</p>
<p>hdel</p>
<h3 id="2-8-消息队列"><a href="#2-8-消息队列" class="headerlink" title="2.8 消息队列"></a>2.8 消息队列</h3><p>消息队列：把要传输的数据放在队列中</p>
<p>功能：可以实现多个系统之间解耦，异步，削峰/限流等</p>
<p>消息队列主要分为两种，Redis都支持：</p>
<ul>
<li>生产者消费者模式</li>
<li>发布者订阅者模式</li>
</ul>
<p>生产者消费者：</p>
<p>先生产，后消费</p>
<p>列表的push和pop技术，生产数据，被消费，消费一次数据就没了</p>
<p>发布者和订阅者：</p>
<p>先订阅，后发布</p>
<p>订阅</p>
<p>发布</p>
<p>频道</p>
<p>subscribe channel </p>
<p>publish channel message</p>
<p>psubscribe 10*  #psubscribe支持通配符</p>
<h2 id="3-Redis-高可用性和集群"><a href="#3-Redis-高可用性和集群" class="headerlink" title="3 Redis 高可用性和集群"></a>3 Redis 高可用性和集群</h2><p>解决单点问题；</p>
<p>解决单机性能瓶颈问题</p>
<p>Redis的中间件（代理）是开发自己写，实现读写分离</p>
<h3 id="3-1-Redis-主从复制"><a href="#3-1-Redis-主从复制" class="headerlink" title="3.1 Redis 主从复制"></a>3.1 Redis 主从复制</h3><p>Redis自带高可用方案</p>
<p>复制缓冲区大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 512mb #需要设置一个足够大的缓冲区大小，否则从服务在获取数据时无法获取完整数据</span><br></pre></td></tr></table></figure>

<p><strong>启用主从</strong></p>
<p>在从节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip port</span><br><span class="line">config set masterauth password</span><br></pre></td></tr></table></figure>



<p>在主节点设置密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set masterauth password</span><br><span class="line">#配置文件修改</span><br><span class="line">requirepass centos</span><br></pre></td></tr></table></figure>



<p>搭好主从之后，从节点自动变成只读，能读不能写</p>
<p>主从节点的配置文件一定要一致，因为Redis主从复制时是对命令的复现，主节点输入什么，从节点也输入什么，比如对命令的rename-command，一定要一致，否则你主节点rename了一个flushdb命令，变成了hahahaah，那么当主节点输入这个命令时，执行了清空命令，但是，从节点不识别hahahahah，所以从节点没有执行清空命令</p>
<p>runid是主从复制的关键点，每当主从某一方的runid发生改变，那么都会发生全量的复制</p>
<p>runid在Redis服务重启后会重新生成一个新的</p>
<p>查看主从复制的信息：info replication</p>
<p>写入Redis的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip</span><br><span class="line"></span><br><span class="line">masterauth passwd</span><br></pre></td></tr></table></figure>



<p><strong>主从同步过程：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.从服务连接主服务器，发送PSYNC命令</span><br><span class="line"></span><br><span class="line">2.主服务器接收到PSYNC命令后，开始执行BGSAVE命令生成RDB快照文件并使用缓冲区记录这个记录点之后的所有写类型</span><br><span class="line"></span><br><span class="line">3.主服务器BGSAVE执行完成后，向所有从服务器发送RDB快照文件，并在发送期间继续记录被执行的写命令</span><br><span class="line"></span><br><span class="line">4.从服务器收到快照文件后丢弃所有旧数据，载入收到的快照到内存</span><br><span class="line"></span><br><span class="line">5.主服务器快照发送完毕后，开始向服务器发送缓冲区中的写命令</span><br><span class="line"></span><br><span class="line">6.从服务器完成对快照的载入，开始接收读命令请求，并执行来自主服务器缓冲区的命令</span><br><span class="line"></span><br><span class="line">7.后期同步会先发送自己salve_repl_offset位置，只同步新增加的数据，不再全量同步</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205309861.png" alt="image-20201022205309861"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205320223.png" alt="image-20201022205320223"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205326907.png" alt="image-20201022205326907"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205347005.png" alt="image-20201022205347005"></p>
<p>复制缓冲区（环形队列）</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205354193.png" alt="image-20201022205354193"></p>
<p>复制缓冲区（环形队列）的配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 1mb</span><br><span class="line"></span><br><span class="line">repl-backlog-ttl 3600</span><br></pre></td></tr></table></figure>



<h4 id="3-1-1-主从复制的优化："><a href="#3-1-1-主从复制的优化：" class="headerlink" title="3.1.1 主从复制的优化："></a><strong>3.1.1 主从复制的优化：</strong></h4><p>1.复制缓冲区尽量大，因为它承载着全量复制开始后写入主节点的数据</p>
<p>2.避免全量复制，第一次的全量复制不可避免，之后的可能产生全量复制的操作，比如主节点重启导致RUNID改变引起的复制或者是复制缓冲区小，导致主节点临时写入的、超出缓冲区的数据没有复制给从节点而导致的全量复制等情况要避免，可以使用哨兵或者Cluster</p>
<p>3.避免复制风暴，比如一个主，三个从，当主节点重启服务后启动，会让三个从节点同时去复制数据，造成大量数据传输，可以使用级联架构。</p>
<h3 id="3-2-哨兵-Sentinel"><a href="#3-2-哨兵-Sentinel" class="headerlink" title="3.2 哨兵 Sentinel"></a>3.2 哨兵 Sentinel</h3><p>功能：高可用，当主节点宕机，自动提升一个从节点为主节点</p>
<p>版本选择：在redis的2.8版本后sentinel就稳定了，生产环境建议使用2.8之后的redis</p>
<p><strong>使用的协议：流言协议(gossip protocols)来接收关于Master是否下线的消息，投票协议(Agreement Protocols)来决定否是执行自动故障迁移，以及选择哪个Slave作为新的Master</strong></p>
<p>一台主机可以被多个哨兵监控</p>
<p>哨兵可以监控多组主从；</p>
<p><strong>哨兵的故障转移步骤：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.多个sentinel发现并确认master有问题</span><br><span class="line">2.选举出一个sentinel作为领导</span><br><span class="line">3.选出一个salve作为master</span><br><span class="line">4.通知其余slave成为新master的slave</span><br><span class="line">5.通知客户端主从变换</span><br><span class="line">6.老的master修好重启后，将会成为新master的slave</span><br></pre></td></tr></table></figure>

<p>每个主从集群组要有一个名字，不同组的名字不能一样，否则sentinel无法识别；</p>
<blockquote>
<p> 主观down：SDOWN SubjectDown</p>
<p>客观down：ODOWN  ObjectDown</p>
<p>哨兵个数要设定为奇数个，防止脑裂</p>
</blockquote>
<blockquote>
<p>Sentinel实际上是一个特殊的redis服务器，有些redis指令支持，但更多的指令是不支持的。</p>
<p>默认监听端口：26379/TCP</p>
<p>Sentinel可以不和Redis服务器部署在一起，但一般部署在一起，所有Redis节点使用相同的配置</p>
</blockquote>
<p>哨兵的定时任务：</p>
<ul>
<li>每10s每个sentinel对master和slave执行info，发现节点的主从关系</li>
<li>每2s每个sentinel通过master节点的channel交换信息(pub/sub)，通过sentinel_:hello频道交互对节点的“看法”和自身信息</li>
<li>每1秒每个sentinel对其他sentinel和redis执行ping</li>
</ul>
<h4 id="3-2-1-实现主服务器的切换"><a href="#3-2-1-实现主服务器的切换" class="headerlink" title="3.2.1 实现主服务器的切换"></a>3.2.1 实现主服务器的切换</h4><p>操作：</p>
<blockquote>
<p>1.搭建主从，从节点比主节点多了一步，就是把主节点IP填写上<br>2.配置哨兵，哨兵可以理解为另一个redis-server，哨兵和客户端是发布-订阅模式</p>
</blockquote>
<p>1.搭建主从：一主两从</p>
<p>主节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>从节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">replicaof 10.0.0.7 6379</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>配置完成后，检查info信息，可以看到replication列表中有很多相关信息</p>
<p>哨兵的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim redis-sentinel.conf</span><br><span class="line">...</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis-sentinel.log</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 10.0.0.7 2 #最后的选项“2”，是投票选项，有两个哨兵认为主节点宕机了，那哨兵们就都认为它宕机了</span><br><span class="line"></span><br><span class="line">sentinel auth-pass mymaster password</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 3000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1 #当故障发生后，提拔了新的主节点后，新的主节点会按照这个选项，允许同时有几个从节点可以进行复制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-cli -a centos -p 26379 </span><br><span class="line"></span><br><span class="line">看到sentinel的数量与之前设置的sentinel数量匹配才是设置正确</span><br></pre></td></tr></table></figure>

<p>编译安装的redis的哨兵配置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;local&#x2F;src&#x2F;redis-5.0.9&#x2F;sentinel.conf &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br><span class="line">chown redis.redis &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br></pre></td></tr></table></figure>

<p>开启哨兵的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;redis-server &#x2F;etc&#x2F;sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<p>写一个service文件，参考redis.service的写法，只要改一下启动项就行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervised systemd</span><br></pre></td></tr></table></figure>

<p>完整的哨兵启动服务文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1 [Unit]</span><br><span class="line"> 2 Description&#x3D;Redis Sentinel</span><br><span class="line"> 3 Wants&#x3D;network-online.target</span><br><span class="line"> 4 After&#x3D;network-online.target</span><br><span class="line"> 5 </span><br><span class="line"> 6 [Service]</span><br><span class="line"> 7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervis    ed systemd</span><br><span class="line"> 8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line"> 9 Type&#x3D;notify</span><br><span class="line">10 User&#x3D;redis</span><br><span class="line">11 Group&#x3D;redis</span><br><span class="line">12                                                                                         </span><br><span class="line">13 [Install]</span><br><span class="line">14 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登录sentinel的方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 </span><br></pre></td></tr></table></figure>

<p>查看sentinel的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name&#x3D;mymaster,status&#x3D;ok,address&#x3D;10.0.0.7:6379,slaves&#x3D;2,sentinels&#x3D;3</span><br></pre></td></tr></table></figure>



<p>使用命令让一个主节点下线，实现切换主从</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 sentinel failover mymaster </span><br></pre></td></tr></table></figure>

<p>通过这个命令实现了把当前主服务器变成从服务器，提升一个原本的从服务器为主服务器！</p>
<blockquote>
<p>而且sentinel可以修改redis的配置文件，这点很好！</p>
</blockquote>
<h4 id="3-2-2-应用程序连接sentinel"><a href="#3-2-2-应用程序连接sentinel" class="headerlink" title="3.2.2 应用程序连接sentinel"></a>3.2.2 应用程序连接sentinel</h4><p>因为涉及到主节点的改变，所以程序在写入数据时需要动态获取主节点IP，这一点可以通过让客户端连接哨兵，因为哨兵是可以动态获取主服务器IP地址的，所以客户端只需要一直与哨兵联系就能获得实时的主服务器地址，那么这时候就客户端和哨兵之间就可以使用：订阅者-发布者模式。客户端订阅哨兵的频道，哨兵有新消息就发送到频道。</p>
<p>例如使用Python写的连接哨兵的客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3 python3-redis</span><br><span class="line"></span><br><span class="line">  1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">  2 </span><br><span class="line">  3 import redis</span><br><span class="line">  4 </span><br><span class="line">  5 from redis.sentinel import Sentinel                                            </span><br><span class="line">  6 </span><br><span class="line">  7 sentinel &#x3D; Sentinel([(&#39;10.0.0.7&#39;, 26379),</span><br><span class="line">  8                      (&#39;10.0.0.101&#39;, 26379),</span><br><span class="line">  9                      (&#39;10.0.0.110&#39;, 26379)],</span><br><span class="line"> 10                     socket_timeout &#x3D; 0.5)</span><br><span class="line"> 11 redis_auth_pass &#x3D; &#39;centos&#39;</span><br><span class="line"> 12 master &#x3D; sentinel.discover_master(&#39;mymaster&#39;)</span><br><span class="line"> 13 print(master)</span><br><span class="line"> 14 </span><br><span class="line"> 15 slave &#x3D; sentinel.discover_slaves(&#39;mymaster&#39;)</span><br><span class="line"> 16 print(slave)</span><br><span class="line"> 17 </span><br><span class="line"> 18 master &#x3D; sentinel.master_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 19                              password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 20 w_ret &#x3D; master.set(&#39;name&#39;, &#39;huihui&#39;)</span><br><span class="line"> 21 </span><br><span class="line"> 22 slave &#x3D; sentinel.slave_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 23                            password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 24 r_ret &#x3D; slave.get(&#39;name&#39;)</span><br><span class="line"> 25 print(r_ret)</span><br><span class="line"></span><br><span class="line">➜  ~ redis-cli -a centos</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-3-Redis-Cluster集群"><a href="#3-3-Redis-Cluster集群" class="headerlink" title="3.3 Redis Cluster集群"></a>3.3 Redis Cluster集群</h3><p>功能：解决单机写入的瓶颈问题</p>
<p>1.之前使用各个中间件：中间件本身存在单点失败问题</p>
<p>2.Redis 3.0之后推出了Cluster，无中心，每个节点保存当前节点数据和整个集群状态，每个节点都和其他所有节点连接。其实就是cluster集成在了redis程序中，需要使用的时候选择开启cluster模式，那么开启了cluster模式的redis就组成了cluster。因此客户端软件中只要写入了所有redis服务器的地址，就能够实现不需要一个管理服务器而以集群的方式访问redis数据库</p>
<p>Redis Cluster的特点：</p>
<ul>
<li>所有Redis节点使用PING机制互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点检测都失效，才能算真正的失效</li>
<li>客户端不需要proxy就可以直接连接redis，但是客户端中需要配置全部的redis服务器的IP</li>
<li>redis cluster把所有的redis node平均映射到0-16383个槽位(slot)上，读写需要到指定的redis node上进行操作，因此有多少个redis node就相当于redis并发扩展了多少倍，每个redis node承担 16384/N个槽位，当然这个得工程师自己设置分配的大小</li>
<li>Redis Cluster程序预先分配16384个槽位，当需要在redis集群中写入一个键值对的时候，会使用<strong>CRC16(key) mod 16384</strong> 来得出这个key的放置槽位应该是哪个，从而根据工程师自己分配的槽位和节点的关系来知道把这个键值对放置到哪个node服务器上，从而有效解决了单机瓶颈问题</li>
<li>Redis Cluster只是解决了单机瓶颈问题，但是在高可用方面还没解决，可以通过对每一个节点设置主从复制来解决这个问题，它也可以实现主服务器宕机自动提升从服务器为主的操作</li>
</ul>
<p><strong>注意：槽位是个逻辑概念，真实的数据还是在redis服务器上</strong></p>
<p>Cluster的执行过程</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201024192759734.png" alt="image-20201024192759734"></p>
<h4 id="3-3-1-Cluster集群的实现"><a href="#3-3-1-Cluster集群的实现" class="headerlink" title="3.3.1 Cluster集群的实现"></a>3.3.1 Cluster集群的实现</h4><p>Cluster实现：</p>
<ul>
<li>多个主，解决单点写入失败问题和单点性能瓶颈问题</li>
<li>每个主都建立一个从，实现主从复制，并且cluster支持主宕机自动切换主从</li>
</ul>
<p>Cluster的部署有多种方式：</p>
<ul>
<li>原生命令安装，用于理解Redis Cluster架构，生产环境就不推荐了</li>
<li>官方工具安装，高效、快速，生产环境可以用</li>
<li>自主开发工具，可以实现可视化的自动化部署</li>
</ul>
<h4 id="操作：使用原生命令部署"><a href="#操作：使用原生命令部署" class="headerlink" title="操作：使用原生命令部署"></a>操作：使用原生命令部署</h4><p>1.六个节点，三主三从</p>
<p>2.cluster中只有数据库0，分成了16384个槽位（slot）2^14</p>
<p>3.每个主节点承担 16384 / 3 个槽位</p>
<p>4.还需要用Python写客户端，用来连接服务器</p>
<p>5.扩容、缩容需要先删除源数据，然后扩容、缩容，再然后重新导入数据</p>
<p>6.原生命令手动部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">部署redis，全部节点开启cluster</span><br><span class="line">meet命令：先开会</span><br><span class="line">给每个节点分配槽位</span><br><span class="line">确立每个节点的主从关系</span><br></pre></td></tr></table></figure>

<p><strong>1.部署redis，全部节点开启cluster，其他的bind，requirepass，masterauth也需要有，这里没记录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &#39;&#x2F;# cluster-enabled yes&#x2F;a cluster-enabled yes&#39; -e &#39;&#x2F;cluster-enabled yes&#x2F;a cluster-config-file nodes-6379.conf&#39; -e &#39;&#x2F;# cluster-require-full-coverage yes&#x2F;a cluster-require-full-coverage no&#39;  &#x2F;app&#x2F;redis&#x2F;etc&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>先监控日志，然后启动redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis.log #开多个ssh窗口，一个监控日志，一个执行命令</span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br><span class="line">#查看到日志中：</span><br><span class="line"> 1705                 _._                                                  </span><br><span class="line"> 1706            _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line"> 1707       _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 5.0.9 (00000000&#x2F;0) 64 bit</span><br><span class="line"> 1708   .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> 1709  (    &#39;      ,       .-&#96;  | &#96;,    )     Running in cluster mode  #重点是这个，cluster mode</span><br><span class="line"> 1710  |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 6379</span><br><span class="line"> 1711  |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 2607</span><br><span class="line"> 1712   &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1713  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1714  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line"> 1715   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1716  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1717  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line"> 1718   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1719       &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line"> 1720           &#96;-._        _.-&#39;                                           </span><br><span class="line"> 1721               &#96;-.__.-&#39;                                                </span><br><span class="line">2607:M 24 Oct 2020 14:38:07.058 * Ready to accept connections</span><br><span class="line">2607:M 24 Oct 2020 14:38:09.143 # Cluster state changed: ok</span><br><span class="line"></span><br><span class="line">redis-cli -a centos info cluster</span><br><span class="line"></span><br><span class="line"># Cluster</span><br><span class="line">cluster_enabled:1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.meet，认识Cluster中的其他成员</strong></p>
<p>通过一台node就可以设置全部的node，meet具有传播性，A meet B，那么A接下来meet其他主机，B也就都知道了，因此这个命令操作5次就可以了</p>
<p>记得在操作前检查是否已经存在日志文件，如果有记得先备份了，然后删除日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.7 -a centos --no-auth-warning cluster meet 10.0.0.101 6379</span><br></pre></td></tr></table></figure>

<p>查看cluster命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster help</span><br><span class="line"> 1) CLUSTER &lt;subcommand&gt; arg arg ... arg. Subcommands are:</span><br><span class="line"> 2) ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.</span><br><span class="line"> 3) BUMPEPOCH -- Advance the cluster config epoch.</span><br><span class="line"> 4) COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports for &lt;node-id&gt;.</span><br><span class="line"> 5) COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys in &lt;slot&gt;.</span><br><span class="line"> 6) DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.</span><br><span class="line"> 7) FAILOVER [force|takeover] -- Promote current replica node to being a master.</span><br><span class="line"> 8) FORGET &lt;node-id&gt; -- Remove a node from the cluster.</span><br><span class="line"> 9) GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node in a slot.</span><br><span class="line">10) FLUSHSLOTS -- Delete current node own slots information.</span><br><span class="line">11) INFO - Return onformation about the cluster.</span><br><span class="line">12) KEYSLOT &lt;key&gt; -- Return the hash slot for &lt;key&gt;.</span><br><span class="line">13) MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.</span><br><span class="line">14) MYID -- Return the node id.</span><br><span class="line">15) NODES -- Return cluster configuration seen by node. Output format:</span><br><span class="line">16)     &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;</span><br><span class="line">17) REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.</span><br><span class="line">18) RESET [hard|soft] -- Reset current node (default: soft).</span><br><span class="line">19) SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.</span><br><span class="line">20) SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.</span><br><span class="line">21) REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.</span><br><span class="line">22) SLOTS -- Return information about slots range mappings. Each range is made of:</span><br><span class="line">23)     start, end, master and replicas IP addresses, ports and ids</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>meet后的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603526520177 1 connected</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603526520000 0 connected</span><br><span class="line">735a7e7371db2986b860248e26b2028f9d57df69 10.0.0.7:6379@16379 myself,master - 0 1603526522000 5 connected</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603526523234 2 connected</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603526521198 3 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603526522211 4 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.给每个节点分配槽位</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p password -a centos cluster addslots slotId</span><br><span class="line">#使用上面的命令一个一个的加很费劲，写一个脚本加</span><br><span class="line"></span><br><span class="line">#槽位的分配可以平均分配，我们是3个主3个从节点，那么就分三份，因为从节点只用来主从，不使用写操作</span><br></pre></td></tr></table></figure>

<p>写一个分配槽位的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-10-24</span><br><span class="line"> 7 #FileName:  redis_allocate_slots.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 </span><br><span class="line">11 #need three arguments,$1 for IP, $2 for start position, $3 for stop position</span><br><span class="line">12 HOST&#x3D;&#39;&#39;</span><br><span class="line">13 PORT&#x3D;6379</span><br><span class="line">14 PASSWORD&#x3D;&#39;centos&#39;</span><br><span class="line">15 HOST&#x3D;$1</span><br><span class="line">16 START_POSITION&#x3D;$2</span><br><span class="line">17 STOP_POSITION&#x3D;$3</span><br><span class="line">18 </span><br><span class="line">19 for ((SLOTID&#x3D;$START_POSITION;SLOTID&lt;&#x3D;$STOP_POSITION;SLOTID++));                      </span><br><span class="line">20 do</span><br><span class="line">21     echo &quot;slot:$SLOTID&quot; </span><br><span class="line">22     redis-cli -h $HOST -p $PORT -a $PASSWORD --no-auth-warning cluster addslots \</span><br><span class="line">23         $SLOTID</span><br><span class="line">24 done</span><br><span class="line">25 </span><br><span class="line">26 #other method</span><br><span class="line">27 </span><br><span class="line">28 #for SLOTID in &#96;seq $2 $3&#96;;do</span><br><span class="line">29 # xxxxx</span><br><span class="line">30 #done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用脚本进行分配：0<del>5461 5462</del>10922 10923~16383</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash redis_allocate_slots.sh 10.0.0.7 0 5461</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.101 5462 10992</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.7 10993 10683</span><br></pre></td></tr></table></figure>

<p>如果错误了，执行这两个命令清除本节点的槽位，并且让其他节点忘记自己，或者把全部的Cluster生成的Node-6379.conf文件删除，重启服务，然后重新添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#进入redis，注意情况槽位命令是在本槽位执行，忘记节点的命令是在其他所有节点都要执行，然后本节点重新meet</span><br><span class="line">cluster flushslots</span><br><span class="line"></span><br><span class="line">cluster forget nodeId</span><br></pre></td></tr></table></figure>

<p>槽位分配完成后查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531283731 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603531284755 3 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531284000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603531285000 0 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603531285771 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531286786 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>4.确定主从关系</strong></p>
<p>使用下面的命令，把当前节点设置为该Node号对应的redis的从节点</p>
<p>比如第一个：让11节点变成bee1594fe4100436e04459ff516c2f52ebe18f41对应的redis服务器的从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.11 -a centos --no-auth-warning cluster replicate bee1594fe4100436e04459ff516c2f52ebe18f41</span><br></pre></td></tr></table></figure>

<p>执行完成的效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531877891 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 slave bee1594fe4100436e04459ff516c2f52ebe18f41 0 1603531876000 6 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531876000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 slave 5a2604519a94555225231bacdbef54f9f41be38a 0 1603531876873 2 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 slave 1ff2c9229779ea27d54890a9adda44b80e199157 0 1603531876000 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531875848 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试cluster的写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name huihui</span><br><span class="line">(error) MOVED 5798 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set k1 huihui</span><br><span class="line">(error) MOVED 12706 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set k2 huihui</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br><span class="line">#根据Key的不同，放入不同的槽位</span><br></pre></td></tr></table></figure>

<p>cluster中有关键和槽位的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster keyslot keyname</span><br><span class="line">#返回这个键存储在哪个槽位中</span><br><span class="line"></span><br><span class="line">cluster getkeysinslot slot 1  </span><br><span class="line">#返回本节点的某个槽位中是什么键</span><br></pre></td></tr></table></figure>

<p>如果想不去重定向寻找的话，可以在redis-cli后跟-c选项，这个选项可以自动重定向到指定redis服务器寻找键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br></pre></td></tr></table></figure>

<p>如果要从从节点上查看数据，需要开启readonly选项，这个选项是专门开启集群中的从节点的读模式的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help readonly</span><br><span class="line"></span><br><span class="line">  READONLY -</span><br><span class="line">  summary: Enables read queries for a connection to a cluster replica node</span><br><span class="line">  since: 3.0.0</span><br><span class="line">  group: cluster</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试主从切换：</p>
<p>关闭10.0.0.7的redis服务，然后他的从节点11在10s左右后，成为了主节点，并继承了7的槽位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1598:S 24 Oct 2020 17:53:40.651 * Connecting to MASTER 10.0.0.7:6379</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.652 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.654 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.961 # Starting a failover election for epoch 7.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # Failover election won: I&#39;m the new master.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # configEpoch set to 7 after successful failover</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 # Setting secondary replication ID to 6d95441d58cb6f12eb56b1bc5495434fb08f3f57, valid up to offset: 2073. New replication ID is a01291fd6ff422a13139bc5fa71f17687845f37e</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 * Discarding previously cached master state.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>恢复了7后，7成了11的从节点！</p>
<p><strong>redis涉及到的几个端口：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis:6379</span><br><span class="line">sentinel:26379</span><br><span class="line">cluster:16379</span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-5-0部署Cluster"><a href="#操作：使用Redis-5-0部署Cluster" class="headerlink" title="操作：使用Redis 5.0部署Cluster"></a>操作：使用Redis 5.0部署Cluster</h4><p>需要使用到的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br></pre></td></tr></table></figure>

<p><strong>注意：在操作前先监控日志</strong></p>
<p>部署要求：</p>
<ul>
<li>每个redis节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何书籍</li>
<li>先启动为单机redis且没有任何key value</li>
</ul>
<p>1.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster create 10.0.0.7:6379 10.0.0.101:6379 10.0.0.110:6379 1</span><br><span class="line">0.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line">#命令说明：</span><br><span class="line">--cluster create  表示创建集群</span><br><span class="line">后面跟着的主机名:端口，表示要加入集群的主机和端口</span><br><span class="line">--cluster-replicas 1  表示集群中主从复制，并且每个主节点配合一个从节点</span><br><span class="line">cluster会自动把前面三个变成主节点，后面三个变成从节点</span><br></pre></td></tr></table></figure>

<p>创建的过程中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383                       #分配槽位</span><br><span class="line">Adding replica 10.0.0.12:6379 to 10.0.0.7:6379</span><br><span class="line">Adding replica 10.0.0.13:6379 to 10.0.0.101:6379</span><br><span class="line">Adding replica 10.0.0.11:6379 to 10.0.0.110:6379       #分配主从节点</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept):  #需要接受或拒绝</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完成的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">........</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看当前的集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6           #节点个数</span><br><span class="line">cluster_size:3                  #主节点个数，也是主从对的个数</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:92</span><br><span class="line">cluster_stats_messages_pong_sent:94</span><br><span class="line">cluster_stats_messages_sent:186</span><br><span class="line">cluster_stats_messages_ping_received:89</span><br><span class="line">cluster_stats_messages_pong_received:92</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:186</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试多个主节点分别写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set huihui jiayou</span><br><span class="line">(error) MOVED 16071 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota haowan</span><br><span class="line">(error) MOVED 7267 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota2 haowan</span><br><span class="line">(error) MOVED 14116 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>测试主从的切换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关闭主节点7，看它的从节点11会怎么样</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.826 # Starting a failover election for epoch 7.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # Failover election won: I&#39;m the new master.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # configEpoch set to 7 after successful failover</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 # Setting secondary replication ID to 1786540a1dc01f327cbde7f520591090c96a9f4d, valid up to offset: 715. New replication ID is 6e95b3f60a28e9510a43da88105357924d1e344d</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 * Discarding previously cached master state.</span><br><span class="line">切换成功！</span><br></pre></td></tr></table></figure>

<p>写一个可以向集群写入数据的Python脚本：用redis-cli -c 可能更方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line"> 2 </span><br><span class="line"> 3 from rediscluster import RedisCluster</span><br><span class="line"> 4 startup_nodes &#x3D; [</span><br><span class="line"> 5     &#123;&quot;host&quot;:&quot;10.0.0.7&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 6     &#123;&quot;host&quot;:&quot;10.0.0.101&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 7     &#123;&quot;host&quot;:&quot;10.0.0.110&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 8     &#123;&quot;host&quot;:&quot;10.0.0.11&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 9     &#123;&quot;host&quot;:&quot;10.0.0.12&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line">10     &#123;&quot;host&quot;:&quot;10.0.0.13&quot;, &quot;port&quot;:6379&#125;</span><br><span class="line">11 ]</span><br><span class="line">12 redis_conn &#x3D; RedisCluster(startup_nodes &#x3D; startup_nodes, password &#x3D; &#39;centos&#39;, \</span><br><span class="line">13                          decode_responses &#x3D; True)</span><br><span class="line">14 </span><br><span class="line">15 for i in range(0, 10000):</span><br><span class="line">16     redis_conn.set(&#39;huihuide&#39; + str(i), &#39;xinxinde&#39; + str(i))</span><br><span class="line">17     print(&#39;huihuide&#39; + str(i) + &#39;:&#39;, redis_conn.get(&#39;huihuide&#39; + str(i)) )</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-4-x-部署Cluster"><a href="#操作：使用Redis-4-x-部署Cluster" class="headerlink" title="操作：使用Redis 4.x 部署Cluster"></a>操作：使用Redis 4.x 部署Cluster</h4><p>1.编译安装，用ansible安装一遍</p>
<p>使用了ansible的角色，角色目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  redis tree</span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── redis-4.0.14.tar.gz</span><br><span class="line">│   └── redis_arguments.sh</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── copy_redis_config.yml</span><br><span class="line">│   ├── copy_redis_service.yml</span><br><span class="line">│   ├── groupadd.yml</span><br><span class="line">│   ├── homedir.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── make_install.yml</span><br><span class="line">│   ├── modify_arguments.yml</span><br><span class="line">│   ├── start_redis.yml</span><br><span class="line">│   ├── symbolic_link.yml</span><br><span class="line">│   ├── unarchive.yml</span><br><span class="line">│   └── useradd.yml</span><br><span class="line">└── templates</span><br><span class="line">    ├── redis.conf.j2</span><br><span class="line">    ├── redis.service.j2</span><br><span class="line">    └── sentinel.conf.j2</span><br><span class="line"></span><br><span class="line">4 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总体需要什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.一个调用角色的playbook，我这里是：role_redis_4.yml，注意这个文件需要跟roles目录同级别，redis角色应该是在roles目录下一个叫redis的目录，角色名称和目录名称要一致</span><br><span class="line">2.一个角色目录，包括：tasks,handlers,files,temples</span><br><span class="line">3.每个目录下的若干文件</span><br></pre></td></tr></table></figure>

<p>执行之后，在六台主机上部署了redis</p>
<p>2.使用ruby脚本</p>
<p>需要首先编译安装ruby，因为yum自带的ruby版本太老了，无法使用。</p>
<p>去ruby官网下载源码，然后根据官网的指导编译安装即可，安装完成后还得gem安装一个redis</p>
<p>官网地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;downloads&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;documentation&#x2F;installation&#x2F;#building-from-source</span><br></pre></td></tr></table></figure>

<p>安装ruby的redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>

<p>3.使用redis自带的ruby脚本，位于源码包的src文件中，叫redis-trib.rb，可以把它软链接到/usr/local/bin/下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb </span><br><span class="line">Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;</span><br><span class="line"></span><br><span class="line">  create          host1:port1 ... hostN:portN</span><br><span class="line">                  --replicas &lt;arg&gt;</span><br><span class="line">  check           host:port</span><br><span class="line">  info            host:port</span><br><span class="line">  fix             host:port</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">  reshard         host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --to &lt;arg&gt;</span><br><span class="line">                  --slots &lt;arg&gt;</span><br><span class="line">                  --yes</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">  rebalance       host:port</span><br><span class="line">                  --weight &lt;arg&gt;</span><br><span class="line">                  --auto-weights</span><br><span class="line">                  --use-empty-masters</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --simulate</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">                  --threshold &lt;arg&gt;</span><br><span class="line">  add-node        new_host:new_port existing_host:existing_port</span><br><span class="line">                  --slave</span><br><span class="line">                  --master-id &lt;arg&gt;</span><br><span class="line">  del-node        host:port node_id</span><br><span class="line">  set-timeout     host:port milliseconds</span><br><span class="line">  call            host:port command arg arg .. arg</span><br><span class="line">  import          host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --copy</span><br><span class="line">                  --replace</span><br><span class="line">  help            (show this help)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb create --replicas 1 10.0.0.101:6379 10.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 10.0.0.14:6379 10.0.0.110:6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>操作和5.X版本redis没有区别，就是执行脚本不一样，4.X是用ruby，5.X是集成到了redis-cli中！</p>
<h4 id="3-3-2-集群的扩容"><a href="#3-3-2-集群的扩容" class="headerlink" title="3.3.2 集群的扩容"></a>3.3.2 集群的扩容</h4><p><strong>注意：先让开发把数据导出，然后备份数据，然后清空数据库，然后再扩容</strong></p>
<p>1.成主从对的扩容，也就是一对一对的增加，但是注意，整体集群的个数要保持在奇数个</p>
<p>2.新加主从对的配置</p>
<p>3.添加主从对里的主节点到集群</p>
<p>4.重新分配槽位</p>
<p>5.添加主从对里的从节点到集群，先添加进去，然后设置为从</p>
<p><strong>添加节点准备：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">新的节点全部配置要和集群中的节点配置相同，且新加入的节点也应该为一主一从</span><br></pre></td></tr></table></figure>

<p>需要使用的命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line">redis-cli 5.0.9</span><br><span class="line"></span><br><span class="line">Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]</span><br><span class="line">  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).</span><br><span class="line">  -p &lt;port&gt;          Server port (default: 6379).</span><br><span class="line">  -s &lt;socket&gt;        Server socket (overrides hostname and port).</span><br><span class="line">  -a &lt;password&gt;      Password to use when connecting to the server.</span><br><span class="line">                     You can also use the REDISCLI_AUTH environment</span><br><span class="line">                     variable to pass this password more safely</span><br><span class="line">                     (if both are used, this argument takes predecence).</span><br><span class="line">  -u &lt;uri&gt;           Server URI.</span><br><span class="line">  -r &lt;repeat&gt;        Execute specified command N times.</span><br><span class="line">  -i &lt;interval&gt;      When -r is used, waits &lt;interval&gt; seconds per command.</span><br><span class="line">                     It is possible to specify sub-second times like -i 0.1.</span><br><span class="line">  -n &lt;db&gt;            Database number.</span><br><span class="line">  -x                 Read last argument from STDIN.</span><br><span class="line">  -d &lt;delimiter&gt;     Multi-bulk delimiter in for raw formatting (default: \n).</span><br><span class="line">  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br><span class="line">  --raw              Use raw formatting for replies (default when STDOUT is</span><br><span class="line">                     not a tty).</span><br><span class="line">  --no-raw           Force formatted output even when STDOUT is not a tty.</span><br><span class="line">  --csv              Output in CSV format.</span><br><span class="line">  --stat             Print rolling stats about server: mem, clients, ...</span><br><span class="line">  --latency          Enter a special mode continuously sampling latency.</span><br><span class="line">                     If you use this mode in an interactive session it runs</span><br><span class="line">                     forever displaying real-time stats. Otherwise if --raw or</span><br><span class="line">                     --csv is specified, or if you redirect the output to a non</span><br><span class="line">                     TTY, it samples the latency for 1 second (you can use</span><br><span class="line">                     -i to change the interval), then produces a single output</span><br><span class="line">                     and exits.</span><br><span class="line">  --latency-history  Like --latency but tracking latency changes over time.</span><br><span class="line">                     Default time interval is 15 sec. Change it using -i.</span><br><span class="line">  --latency-dist     Shows latency as a spectrum, requires xterm 256 colors.</span><br><span class="line">                     Default time interval is 1 sec. Change it using -i.</span><br><span class="line">  --lru-test &lt;keys&gt;  Simulate a cache workload with an 80-20 distribution.</span><br><span class="line">  --replica          Simulate a replica showing commands received from the master.</span><br><span class="line">  --rdb &lt;filename&gt;   Transfer an RDB dump from remote server to local file.</span><br><span class="line">  --pipe             Transfer raw Redis protocol from stdin to server.</span><br><span class="line">  --pipe-timeout &lt;n&gt; In --pipe mode, abort with error if after sending all data.</span><br><span class="line">                     no reply is received within &lt;n&gt; seconds.</span><br><span class="line">                     Default timeout: 30. Use 0 to wait forever.</span><br><span class="line">  --bigkeys          Sample Redis keys looking for keys with many elements (complexity).</span><br><span class="line">  --memkeys          Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">  --memkeys-samples &lt;n&gt; Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">                     And define number of key elements to sample</span><br><span class="line">  --hotkeys          Sample Redis keys looking for hot keys.</span><br><span class="line">                     only works when maxmemory-policy is *lfu.</span><br><span class="line">  --scan             List all keys using the SCAN command.</span><br><span class="line">  --pattern &lt;pat&gt;    Useful with --scan to specify a SCAN pattern.</span><br><span class="line">  --intrinsic-latency &lt;sec&gt; Run a test to measure intrinsic system latency.</span><br><span class="line">                     The test will run for the specified amount of seconds.</span><br><span class="line">  --eval &lt;file&gt;      Send an EVAL command using the Lua script at &lt;file&gt;.</span><br><span class="line">  --ldb              Used with --eval enable the Redis Lua debugger.</span><br><span class="line">  --ldb-sync-mode    Like --ldb but uses the synchronous Lua debugger, in</span><br><span class="line">                     this mode the server is blocked and script changes are</span><br><span class="line">                     not rolled back from the server memory.</span><br><span class="line">  --cluster &lt;command&gt; [args...] [opts...]</span><br><span class="line">                     Cluster Manager command and arguments (see below).</span><br><span class="line">  --verbose          Verbose mode.</span><br><span class="line">  --no-auth-warning  Don&#39;t show warning message when using password on command</span><br><span class="line">                     line interface.</span><br><span class="line">  --help             Output this help and exit.</span><br><span class="line">  --version          Output version and exit.</span><br><span class="line"></span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  Use --cluster help to list all available cluster manager commands.</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  cat &#x2F;etc&#x2F;passwd | redis-cli -x set mypasswd</span><br><span class="line">  redis-cli get mypasswd</span><br><span class="line">  redis-cli -r 100 lpush mylist x</span><br><span class="line">  redis-cli -r 100 -i 1 info | grep used_memory_human:</span><br><span class="line">  redis-cli --eval myscript.lua key1 key2 , arg1 arg2 arg3</span><br><span class="line">  redis-cli --scan --pattern &#39;*:12345*&#39;</span><br><span class="line"></span><br><span class="line">  (Note: when using --eval the comma separates KEYS[] from ARGV[] items)</span><br><span class="line"></span><br><span class="line">When no command is given, redis-cli starts in interactive mode.</span><br><span class="line">Type &quot;help&quot; in interactive mode for information on available commands</span><br><span class="line">and settings.</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port  #需要使用这个命令添加</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>开始添加主节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster add-node 10.0.0.112:6379 10.0.0.110:6379</span><br><span class="line"></span><br><span class="line">redis-cli -a centos cluster nodes</span><br><span class="line">25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379@16379 master - 0 1603542788089 0 connected</span><br><span class="line">#新主节点已经添加成功</span><br></pre></td></tr></table></figure>

<p>检查当前的集群情况：注意，redis的命令行中–cluster和进入redis输入的cluster是两个方式，他们的内容不一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112:6379</span><br></pre></td></tr></table></figure>

<p><strong>给新的节点分配槽位（slot）：</strong></p>
<p><strong>注意：重新分配槽位需要清空数据！请备份好数据后再操作</strong></p>
<p>利用的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster reshard 10.0.0.110:6379 #这里填写任意一个集群中的节点</span><br><span class="line">reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">需要被询问：</span><br><span class="line">1.需要分配多少槽位？</span><br><span class="line">2.需要分配给哪个主节点</span><br><span class="line">3.分配的槽位是从哪些主节点上来的（也就是从哪里再分一些槽位出来给新的主节点，如果是想要把某个老的主节点替换掉，那么就把它的全部槽位分配给新节点），有一个智能的ALL选项，可以平均的从其他主节点上获取槽位</span><br><span class="line">4.是否接受分配规则？</span><br></pre></td></tr></table></figure>

<p>分配完成后，检查当前集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.112:6379)</span><br><span class="line">M: 25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">已经有了槽位</span><br></pre></td></tr></table></figure>

<p><strong>添加从节点：</strong></p>
<p>两个方法：</p>
<p><strong>1.第一个方法：</strong></p>
<p>一步添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379 --cluster-slave --cluster-master-id 25a3f4642c96aa8da5895fe6948c16add5737036</span><br><span class="line">#cluster的id填新的主节点的id</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line">6803c4e25d23980fba3ff2d336126f4f000a4418 10.0.0.14:6379@16379 myself,slave 25a3f4642c96aa8da5895fe6948c16add5737036 0 1603544102000 0 connected</span><br><span class="line">已经添加成为了从节点</span><br></pre></td></tr></table></figure>

<p>2.第二个方法：</p>
<p>两步添加为从节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate 25a3f4642c96aa8da5895fe6948c16add5737036</span><br></pre></td></tr></table></figure>



<h4 id="3-3-3-集群的缩容"><a href="#3-3-3-集群的缩容" class="headerlink" title="3.3.3 集群的缩容"></a>3.3.3 集群的缩容</h4><p>1.缩容之前需要把原本的槽位分给其他主节点</p>
<p><strong>注意：缩容操作中，需要分三次，均匀的把槽位分配给剩余的主节点</strong></p>
<p>分配槽位，使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster reshard 10.0.0.112:6379</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 1365  #这里设置每次分配的槽位，4096 &#x2F; 3 </span><br><span class="line">What is the receiving node ID? 819d053d78d249570b5bd610436fdb0e4ac59627 #这里写分配给哪个主节点</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: 25a3f4642c96aa8da5895fe6948c16add5737036  #这里写要把哪个主节点分配了，也就是缩容了</span><br><span class="line"></span><br><span class="line">这个操作做三次，并且确保要缩容的节点上已经没有槽位</span><br></pre></td></tr></table></figure>

<p>把槽位分配完成后，原本的从节点也自动变成了其他主节点的从节点</p>
<p>2.删除节点，先删除主，后删除从</p>
<p>使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~ redis-cli -a centos --cluster del-node 10.0.0.112:6379 25a3f4642c96aa8da5895fe6948c16ad</span><br><span class="line">d5737036</span><br><span class="line"></span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Removing node 25a3f4642c96aa8da5895fe6948c16add5737036 from cluster 10.0.0.112:6379</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node</span><br></pre></td></tr></table></figure>

<p>此时这个主节点的redis服务也被关闭了，然后下一步我们把他的cluster自动生成的nodes-6379.conf文件删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;*  #注意：cluster的配置文件存放到哪里，是由redis.conf文件中dir选项决定的</span><br></pre></td></tr></table></figure>

<p>检查当前集群信息，发现已经没有被缩容的主节点了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del-node ip:port</span><br></pre></td></tr></table></figure>

<p>删除从节点：从节点只需要删除节点，删除自动生成的nodes-6379.conf文件即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster del-node 10.0.0.14:6379 42339be4491341520d59219d685530fcc61655ec</span><br><span class="line"></span><br><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;* </span><br></pre></td></tr></table></figure>

<p>此时检查集群信息，已经没有这个从节点了，缩容结束。</p>
<h4 id="3-3-5-把数据导入集群"><a href="#3-3-5-把数据导入集群" class="headerlink" title="3.3.5 把数据导入集群"></a>3.3.5 把数据导入集群</h4><p><strong>注意：慎用！</strong></p>
<p>用之前把所有涉及到的redis服务的密码全设置为空，包括导入数据的redis和被导入数据的redis集群的全部节点</p>
<p>然后使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster import 10.0.0.110:6379 --cluster-from 10.0.0.112:6379 --cluster-copy --cluster-replace</span><br><span class="line">参数说明：</span><br><span class="line">--cluster import 后面跟上集群中的一个节点IP和端口</span><br><span class="line">--cluster-from 后面跟上从哪里导入数据</span><br><span class="line">--cluster-copy  这个参数表示复制数据到集群</span><br><span class="line">--cluster-replace 这个参数表示如果出现相同的key，那么使用导入的数据替换了原来的数据</span><br></pre></td></tr></table></figure>



<h4 id="3-3-6-集群偏斜"><a href="#3-3-6-集群偏斜" class="headerlink" title="3.3.6 集群偏斜"></a>3.3.6 集群偏斜</h4><ul>
<li>节点和槽位分配不均</li>
<li>不同槽位对应键值数量差异较大</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看槽位中的键值对个数</span><br><span class="line">countkeysinslot NUMBER</span><br></pre></td></tr></table></figure>

<p>有一个重新分配槽位的命令，但是慎用！会影响客户端的访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster rebalance 集群IP:端口</span><br></pre></td></tr></table></figure>



<ul>
<li>包含bigkey，建议少用</li>
<li>内存相关配置不一致</li>
<li>热点数据不均衡：一致性不高时，可以使用本机缓存和MQ</li>
</ul>
<h4 id="3-3-7-Redis-cluster的局限性"><a href="#3-3-7-Redis-cluster的局限性" class="headerlink" title="3.3.7 Redis cluster的局限性"></a>3.3.7 Redis cluster的局限性</h4><ul>
<li>跨槽位查询不支持，不是说跨节点的问题，槽位都不能跨</li>
<li>性能降低</li>
<li>客户端维护更复杂</li>
<li>不支持多个数据库，只使用db0</li>
<li>复制只有一层，不支持级联复制</li>
<li>key事务和Lua支持有限</li>
</ul>
<p>1.主从复制</p>
<p>2.哨兵</p>
<p>3.Cluster 创建  两个版本  4,5都试试</p>
<p>4.扩容</p>
<p>5.缩容</p>
<p>6.导入</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>huihui</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/" title="Redis">http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/11/18/HTTP%E5%8D%8F%E8%AE%AE%E5%92%8CAPACHE/" rel="prev" title="HTTP协议和APACHE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">HTTP协议和APACHE</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/11/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="next" title="MYSQL"><span class="post-nav-text">MYSQL</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+Redis">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> huihui</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.3.0</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>