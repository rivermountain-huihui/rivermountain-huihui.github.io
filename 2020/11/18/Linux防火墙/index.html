<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="huihui"><meta name="copyright" content="huihui"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>Linux防火墙 | 辉辉的数据库</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"example.com","root":"/","title":"这一幕是我了","version":"1.3.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="Linux防火墙1.防火墙的概念 2.防火墙工具 3.iptables 4.firewalld 5.ntf">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux防火墙">
<meta property="og:url" content="http://example.com/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/index.html">
<meta property="og:site_name" content="辉辉的数据库">
<meta property="og:description" content="Linux防火墙1.防火墙的概念 2.防火墙工具 3.iptables 4.firewalld 5.ntf">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200915174710914.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200915180126223.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200915191228621.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200917105248428.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200916193650280.png">
<meta property="og:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200917154841708.png">
<meta property="article:published_time" content="2020-11-18T00:48:10.000Z">
<meta property="article:modified_time" content="2020-11-19T00:45:37.615Z">
<meta property="article:author" content="huihui">
<meta property="article:tag" content="notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/a/AppData/Roaming/Typora/typora-user-images/image-20200915174710914.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="huihui"><img width="96" loading="lazy" src="/Yun.png" alt="huihui"></a><div class="site-author-name"><a href="/about/">huihui</a></div><a class="site-name" href="/about/site.html">辉辉的数据库</a><sub class="site-subtitle">我们要丈量大地！</sub><div class="site-desciption">笔记</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">12</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">1</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=epvxdq1sknJe9JMj6J1LsBw4a6cI_2ln&amp;jump_from=webapi" title="QQ 群 389401003" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.</span> <span class="toc-text">Linux防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%98%B2%E7%81%AB%E5%A2%99%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.防火墙概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.安全技术：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%98%B2%E7%81%AB%E5%A2%99%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.防火墙分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Linux%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.Linux防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Netfilter"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.Netfilter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Netfilter%E7%9A%84%E4%BA%94%E4%B8%AA%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E5%92%8C%E6%8A%A5%E6%96%87%E6%B5%81%E5%90%91"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">2.Netfilter的五个钩子函数和报文流向</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-iptables%E7%BB%84%E6%88%90%E2%80%93-gt-%E4%BA%94%E8%A1%A8%E4%BA%94%E9%93%BE"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">3.iptables组成–&gt;五表五链</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-iptables"><span class="toc-number">1.1.4.</span> <span class="toc-text">4.iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-iptables%E8%A7%84%E5%88%99"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">1.iptables规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-iptables%E7%9A%84%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">2.iptables的匹配条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-target"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">3.target</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E8%A7%84%E5%88%99%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9A"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">4.规则优化最佳实践：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-iptables%E8%A7%84%E5%88%99%E4%BF%9D%E5%AD%98"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">6.iptables规则保存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E7%BD%91%E7%BB%9C%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">7.网络防火墙</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NAT%E8%A1%A8"><span class="toc-number">1.2.</span> <span class="toc-text">NAT表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SNAT%EF%BC%9A%E6%BA%90%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%EF%BC%8C%E9%85%8D%E5%90%88POSTROUTING%E9%93%BE%EF%BC%8C%E5%B0%86%E6%95%B0%E6%8D%AE%E6%9D%A5%E6%BA%90%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E6%88%90%E6%8C%87%E5%AE%9AIP"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-DNAT%EF%BC%9A%E7%9B%AE%E6%A0%87%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%EF%BC%8C%E9%85%8D%E5%90%88PERROUTING%E9%93%BE%EF%BC%8C%E5%B0%86%E6%95%B0%E6%8D%AE%E7%9B%AE%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E6%88%90%E6%8C%87%E5%AE%9AIP"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-REDIRECT%E8%BD%AC%E5%8F%91"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.REDIRECT转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%B6%E6%9E%81%E5%AE%9E%E9%AA%8C%EF%BC%9A"><span class="toc-number">1.2.4.</span> <span class="toc-text">究极实验：</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="huihui"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="辉辉的数据库"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Linux防火墙</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-11-18 08:48:10" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2020-11-19 08:45:37" itemprop="dateModified" datetime="2020-11-19T08:45:37+08:00">2020-11-19</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h2 id="Linux防火墙"><a href="#Linux防火墙" class="headerlink" title="Linux防火墙"></a>Linux防火墙</h2><p><strong>1.防火墙的概念</strong></p>
<p><strong>2.防火墙工具</strong></p>
<p><strong>3.iptables</strong></p>
<p><strong>4.firewalld</strong></p>
<p><strong>5.ntf</strong></p>
<a id="more"></a>

<h3 id="1-防火墙概念"><a href="#1-防火墙概念" class="headerlink" title="1.防火墙概念"></a>1.防火墙概念</h3><h4 id="1-安全技术："><a href="#1-安全技术：" class="headerlink" title="1.安全技术："></a>1.安全技术：</h4><ul>
<li>入侵检测系统</li>
<li>入侵防御系统</li>
<li>防火墙</li>
</ul>
<h4 id="2-防火墙分类"><a href="#2-防火墙分类" class="headerlink" title="2.防火墙分类"></a>2.防火墙分类</h4><p>按保护范围划分：</p>
<ul>
<li>主机防火墙：服务范围为当前一台主机</li>
<li>网络防火墙：服务范围为防火墙一侧的局域网</li>
</ul>
<p>按实现方式划分：</p>
<ul>
<li>硬件防火墙：在专用硬件级别实现部分功能的防火墙</li>
<li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件</li>
</ul>
<p>按网络协议划分：</p>
<ul>
<li>网络层防火墙：OSI模型下四层，又称为包过滤防火墙</li>
<li>应用层防火墙/代理服务器：代理网关，OSI模型七层</li>
</ul>
<p><strong>包过滤防火墙：</strong></p>
<p>网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控制列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议状态等因素，或他们的组合来确定是否允许该数据包通过</p>
<p>优点：对用户来说透明，处理速度快且易于维护</p>
<p>缺点：无法检查应用层数据，如病毒等</p>
<p><strong>应用层防火墙/代理服务型防火墙，也称为代理服务器（Proxy Server）</strong></p>
<p>将所有跨越防火墙的网络通信链路分为两段</p>
<p>内外网用户的访问都是通过代理服务器上的”链接“来实现</p>
<p>优点：在应用层对数据进行检查，比较安全</p>
<p>缺点：增加防火墙的负载</p>
<p>现实生产环境中所使用的防火墙一般都是二者结合体，即先检查网络数据，通过之后再送到应用层去检查。</p>
<h4 id="3-Linux防火墙"><a href="#3-Linux防火墙" class="headerlink" title="3.Linux防火墙"></a>3.Linux防火墙</h4><h5 id="1-Netfilter"><a href="#1-Netfilter" class="headerlink" title="1.Netfilter"></a>1.Netfilter</h5><p>Linux防火墙是由Netfilter组件提供的，Netfilter工作在内核空间，集成在LINux内核中</p>
<h5 id="2-Netfilter的五个钩子函数和报文流向"><a href="#2-Netfilter的五个钩子函数和报文流向" class="headerlink" title="2.Netfilter的五个钩子函数和报文流向"></a>2.Netfilter的五个钩子函数和报文流向</h5><p>Netfilter在内核中选取五个位置放了五个钩子函数，这五个钩子函数向用户开放，用户可以通过一个命令工具向函数中写入规则，工具可以是：iptables firewalld ntfables</p>
<table>
<thead>
<tr>
<th>FUNCTION</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>INPUT</td>
<td></td>
</tr>
<tr>
<td>OUTPUT</td>
<td></td>
</tr>
<tr>
<td>FORWARD</td>
<td></td>
</tr>
<tr>
<td>PRE_ROUTING</td>
<td></td>
</tr>
<tr>
<td>POST_ROUTING</td>
<td></td>
</tr>
</tbody></table>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915174710914.png" alt="image-20200915174710914"></p>
<p>三种数据流向：</p>
<ul>
<li>流入本机：PRE_ROUTING–&gt;INPUT–&gt;用户进程空间</li>
<li>流出本机：用户进程空间–&gt;OUTPUT–&gt;POST_ROUTING</li>
<li>转发：PRE_ROUTING–&gt;FORWARD–&gt;POST_ROUTING</li>
</ul>
<h5 id="3-iptables组成–-gt-五表五链"><a href="#3-iptables组成–-gt-五表五链" class="headerlink" title="3.iptables组成–&gt;五表五链"></a>3.iptables组成–&gt;五表五链</h5><p><strong>链 chain：</strong></p>
<ul>
<li>内置链：每个内置链对应一个钩子函数 INPUT、OUTPUT、FORWARD、PRE_ROUTING、POST_ROUTING</li>
<li>自定义链：用于对内置链进行扩展或补充，可实现更灵活地规则组织管理机制；只有钩子调用自定义链的时候才能生效。</li>
</ul>
<p><strong>表 table ：filter、nat、mangle、raw、security</strong></p>
<ul>
<li>filter：过滤规则表，根据定义的规则过滤符合条件的数据包，也是iptables的默认表</li>
<li>nat：network address translation 地址转换规则表</li>
<li>mangle：修改数据标记为规则表</li>
<li>raw：关闭启用的连接跟踪机制，加快封包穿越防火墙速度</li>
<li>security：用于强制访问控制（MAC）网络规则，有Linux安全模块实现</li>
</ul>
<p>表的优先级：从大到小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security&gt;raw&gt;mangle&gt;nat&gt;filter</span><br></pre></td></tr></table></figure>

<p>表和链的对应关系</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915180126223.png" alt="image-20200915180126223"></p>
<p>内核中数据包的传输过程</p>
<ul>
<li>当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包目的IP判断是否需要转送出去</li>
<li>如果数据包是进入本机的，数据包就会沿着图向下移动，到达INPUT链。数据包到达INPUT链后，任何进程都会受到它。本机上运行的程序可以发送数据包，这些数据包经过OUTPUT链，然后到达POSTROUTING链输出</li>
<li>如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915191228621.png" alt="image-20200915191228621"></p>
<h4 id="4-iptables"><a href="#4-iptables" class="headerlink" title="4.iptables"></a>4.iptables</h4><h5 id="1-iptables规则"><a href="#1-iptables规则" class="headerlink" title="1.iptables规则"></a>1.iptables规则</h5><p>规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义的处理动作做出处理，规则在链接上的次序即为其检查时的生效次序</p>
<p><strong>匹配条件</strong>：默认为与条件，同时满足</p>
<p><strong>基本匹配</strong>：IP、端口、TCP的Flags（SYN、ACK、FIN）</p>
<p><strong>扩展匹配</strong>：通过复杂高级功能匹配</p>
<p><strong>处理动作</strong>：称为target，跳转目标</p>
<ul>
<li>内建处理动作：ACCEPT、DROP、REJECT、SNAT、DNAT、MASQUERADE、MARK、LOG</li>
<li>自定义处理动作：自定义chain，利用分类管理复杂情形</li>
</ul>
<p>规则要添加在内置链上才能生效；添加在自定义链上不会生效，还需要把自定义链加到内置链上。</p>
<p>因为本质上这个规则就是利用了那5个钩子函数，也就是5个链。我们写的规则就是这5个函数的参数。</p>
<p>iptables规则添加时的考量点：</p>
<ul>
<li>要实现哪种功能：判断添加在哪张表上</li>
<li>报文流经的路径：判断添加在哪个链上</li>
<li>报文的流向：判断源和目的</li>
<li>匹配规则：业务需要</li>
</ul>
<p><strong>注意一点：Iptables等防火墙工具他们的服务开启和关闭都是在控制链和表，所以关闭了防火墙，其实是清空了防火墙规则，方便我们自己去定义规则</strong></p>
<p>2.iptables用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@localdns ~]#iptables --help</span><br><span class="line">iptables v1.4.21</span><br><span class="line"></span><br><span class="line">Usage: iptables -[ACD] chain rule-specification [options]</span><br><span class="line">       iptables -I chain [rulenum] rule-specification [options]</span><br><span class="line">       iptables -R chain rulenum rule-specification [options]</span><br><span class="line">       iptables -D chain rulenum [options]</span><br><span class="line">       iptables -[LS] [chain [rulenum]] [options]</span><br><span class="line">       iptables -[FZ] [chain] [options]</span><br><span class="line">       iptables -[NX] chain</span><br><span class="line">       iptables -E old-chain-name new-chain-name</span><br><span class="line">       iptables -P chain target [options]</span><br><span class="line">       iptables -h (print this help information)</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">Either long or short options are allowed.</span><br><span class="line">  --append  -A chain		Append to chain</span><br><span class="line">  --check   -C chain		Check for the existence of a rule</span><br><span class="line">  --delete  -D chain		Delete matching rule from chain</span><br><span class="line">  --delete  -D chain rulenum</span><br><span class="line">				Delete rule rulenum (1 &#x3D; first) from chain</span><br><span class="line">  --insert  -I chain [rulenum]</span><br><span class="line">				Insert in chain as rulenum (default 1&#x3D;first)</span><br><span class="line">  --replace -R chain rulenum</span><br><span class="line">				Replace rule rulenum (1 &#x3D; first) in chain</span><br><span class="line">  --list    -L [chain [rulenum]]</span><br><span class="line">				List the rules in a chain or all chains</span><br><span class="line">  --list-rules -S [chain [rulenum]]</span><br><span class="line">				Print the rules in a chain or all chains</span><br><span class="line">  --flush   -F [chain]		Delete all rules in  chain or all chains</span><br><span class="line">  --zero    -Z [chain [rulenum]]</span><br><span class="line">				Zero counters in chain or all chains</span><br><span class="line">  --new     -N chain		Create a new user-defined chain</span><br><span class="line">  --delete-chain</span><br><span class="line">            -X [chain]		Delete a user-defined chain</span><br><span class="line">  --policy  -P chain target</span><br><span class="line">				Change policy on chain to target</span><br><span class="line">  --rename-chain</span><br><span class="line">            -E old-chain new-chain</span><br><span class="line">				Change chain name, (moving any references)</span><br><span class="line">Options:</span><br><span class="line">    --ipv4	-4		Nothing (line is ignored by ip6tables-restore)</span><br><span class="line">    --ipv6	-6		Error (line is ignored by iptables-restore)</span><br><span class="line">[!] --protocol	-p proto	protocol: by number or name, eg. &#96;tcp&#39;</span><br><span class="line">[!] --source	-s address[&#x2F;mask][...]</span><br><span class="line">				source specification</span><br><span class="line">[!] --destination -d address[&#x2F;mask][...]</span><br><span class="line">				destination specification</span><br><span class="line">[!] --in-interface -i input name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line"> --jump	-j target</span><br><span class="line">				target for rule (may load target extension)</span><br><span class="line">  --goto      -g chain</span><br><span class="line">                              jump to chain with no return</span><br><span class="line">  --match	-m match</span><br><span class="line">				extended match (may load extension)</span><br><span class="line">  --numeric	-n		numeric output of addresses and ports</span><br><span class="line">[!] --out-interface -o output name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line">  --table	-t table	table to manipulate (default: &#96;filter&#39;)</span><br><span class="line">  --verbose	-v		verbose mode</span><br><span class="line">  --wait	-w [seconds]	maximum wait to acquire xtables lock before give up</span><br><span class="line">  --wait-interval -W [usecs]	wait time to try to acquire xtables lock</span><br><span class="line">				default is 1 second</span><br><span class="line">  --line-numbers		print line numbers when listing</span><br><span class="line">  --exact	-x		expand numbers (display exact values)</span><br><span class="line">[!] --fragment	-f		match second or further fragments only</span><br><span class="line">  --modprobe&#x3D;&lt;command&gt;		try to insert modules using this command</span><br><span class="line">  --set-counters PKTS BYTES	set the counter during insert&#x2F;append</span><br><span class="line">[!] --version	-V		print package version.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>iptables命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table]  &#123;-A|-I|-R|-D|...&#125; chain    rule      -j targetname</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-t table 这个可以不写，默认是filter表</span><br><span class="line">-A append 追加一个规则，排在最后一条</span><br><span class="line">-I number 插入到第几行，可以自由选择规则顺序</span><br><span class="line">-R replace 代替哪个链的第几行</span><br><span class="line">-D 删除</span><br><span class="line">-N	new 新建一个链</span><br><span class="line">-E	重命名自定义链</span><br><span class="line">-X：delete，删除自定义的空的规则链 注意一定得是空链，里面不能有规则</span><br><span class="line">-P：policy，设置默认策略；filter表的默认策略是ACCEPT，可以改成DROP，只有这两种</span><br><span class="line">-F：flush 清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line">	(1)匹配到的报文的个数</span><br><span class="line">	(2)匹配到的所有报文的大小之和</span><br></pre></td></tr></table></figure>

<p>例子：拒绝10.0.0.5访问本主机的TCP80端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -A INPUT -s  10.0.0.5 -p tcp -m multiport --dports 80 -j REJECT</span><br><span class="line">[root@forwarddns named]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br><span class="line">    0     0 REJECT     tcp  --  *      *       10.0.0.5             0.0.0.0&#x2F;0     </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br></pre></td></tr></table></figure>

<p>例子：新建web_chain控制网页访问的几个端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -N web_chain </span><br><span class="line">[root@forwarddns named]#iptables -E web_chain WEB_CHAIN  #改了个大写名字</span><br><span class="line">[root@forwarddns named]#iptables -A WEB_CHAIN -p tcp -m multiport --dports 80,443,8080 -j REJECT  #此时规则时无法生效的，因为自定义链还没有插入到内置链中</span><br><span class="line">[root@forwarddns named]#iptables -A INPUT -j WEB_CHAIN   #插入链的操作是 —j</span><br><span class="line">[root@forwarddns named]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   28  1848 WEB_CHAIN  all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain WEB_CHAIN (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 REJECT     tcp  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            multiport dports 80,443,8080 reject-with icmp-port-unreachable</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例子：删除自定义链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -F WEB_CHAIN #先把链里的规则清空</span><br><span class="line">[root@forwarddns named]#iptables -D INPUT 1  #删除自定义链和内置链的关联关系</span><br><span class="line">[root@forwarddns named]#iptables -X WEB_CHAIN  #删除自定义链</span><br></pre></td></tr></table></figure>

<p><strong>2.匹配条件</strong></p>
<ul>
<li>基本匹配：通用的，PARAMENTERS</li>
<li>扩展：需加载模块，MATCH EXTENSIONS</li>
</ul>
<p><strong>3.处理动作</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-j targetname</span><br><span class="line">ACCEPT </span><br><span class="line">DROP</span><br><span class="line">REJECT</span><br><span class="line">RETURN 返回调用链</span><br><span class="line">REDIRECT 端口重定向</span><br><span class="line">LOG 记录日志</span><br><span class="line">MARK 做防火墙标记</span><br><span class="line">DNAT 目标地址转换</span><br><span class="line">SNAT 源地址转换</span><br><span class="line">MASQUERADE 地址伪装</span><br><span class="line">自定义链  添加到内置链的时候是 ‘-j 自定义链’    </span><br></pre></td></tr></table></figure>

<h5 id="2-iptables的匹配条件"><a href="#2-iptables的匹配条件" class="headerlink" title="2.iptables的匹配条件"></a>2.iptables的匹配条件</h5><p>1.基本匹配条件：无需加载模块，由iptables/netfilter自行提供</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-s source address 源IP地址</span><br><span class="line">-d destination address目标IP地址</span><br><span class="line">-p protocol 协议，tcp,udp,icmp ...  查看&#x2F;etc&#x2F;protocols</span><br><span class="line">-i in-interface 报文流入的接口</span><br><span class="line">-o out-interface 报文流出的接口</span><br></pre></td></tr></table></figure>

<p>2.扩展匹配条件</p>
<p>扩展匹配条件需要加载扩展模块：/usr/lib64/xtables/*.so</p>
<p>扩展模块的查看帮助：man iptables-extensions</p>
<p>扩展匹配条件：</p>
<ul>
<li>隐式扩展</li>
<li>显式扩展</li>
</ul>
<p>3.隐式扩展</p>
<p>iptables在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块</p>
<p>tcp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--sport port 匹配报文源端口</span><br><span class="line">--dport port 匹配报文目的端口</span><br><span class="line">--tcp-flags mask,comp</span><br><span class="line">	mask 需要检查的标示位，用“，”分隔，例如 SYN,FIN,ACK,RST</span><br><span class="line">	COMP 在mask需要检查的标示位中必须为1的那个标识位，比如 SYN,FIN,ACK SYN 这个意思是在这三个标示位里SYN必须是1</span><br></pre></td></tr></table></figure>

<p>udp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--sport</span><br><span class="line">--dport</span><br></pre></td></tr></table></figure>

<p>icmp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--icmp-type type&#x2F;code</span><br><span class="line">	0&#x2F;0 echo-reply ICMP应答</span><br><span class="line">	8&#x2F;0 echo-request ICMP请求</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.5 -p tcp -m multiport --dport 22,23,24,25 -j REJECT </span><br><span class="line">这里用了显示扩展条件</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.7 -p tcp --tcp-flags SYN,ACK,FIN SYN -j REJECT</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.显式扩展及相关模块</p>
<p>显示扩展必须使用-m选项指明要调用的模块，需要手动加载扩展模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m matchname</span><br></pre></td></tr></table></figure>

<p>帮助文档：</p>
<p>centos7,8：man iptables-extensions</p>
<p>centos6：man iptables</p>
<p>4.1multiport扩展</p>
<p>以离散方式定义多端口匹配，最多指定15个端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--sports port</span><br><span class="line">--dports port</span><br><span class="line">--ports port</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -s 10.0.0.0&#x2F;24  -p tcp -m multiport --dports 20:22,80 -j ACCEPT </span><br></pre></td></tr></table></figure>

<p>4.2 iprange扩展</p>
<p>指明连续的IP地址范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--src-range from</span><br><span class="line">--dst-range from</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -m iprange --src-range 10.0.0.1-10.0.0.10 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.3 mac扩展</p>
<p>mac扩展用于指明MAC地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--mac-source xx:xx:xx:xx:xx:xx</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -m mac --mac-source 00:0c:29:f4:f0:1c -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.4 string扩展</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--algo &#123;bm|kmp&#125; 字符串匹配检测算法</span><br><span class="line">	bm:Boyer-Moore</span><br><span class="line">	kmp:Knuth-Pratt-Morris</span><br><span class="line">--from offset 开始偏移</span><br><span class="line">--to offset 结束偏移</span><br><span class="line">--string pattern 要检测的字符串</span><br><span class="line">--hex-string 要检测字符串模式，16进制</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A OUTPUT -p tcp --sport 80 -m string --algo bm --from 62 --string &quot;google&quot; -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.5 time扩展</p>
<p>将根据报文到达的时间与指定的时间范围进行匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--datestart 日期</span><br><span class="line">--datestop 日期</span><br><span class="line">--timestart 时间</span><br><span class="line">--timestop 时间</span><br><span class="line">--monthdays day 每个月的几号</span><br><span class="line">--weekdays day 星期几</span><br><span class="line">--kerneltz 内核时间</span><br></pre></td></tr></table></figure>

<p>4.6 connlimit扩展</p>
<p>根据客户端IP做并发连接数数量匹配</p>
<p>可防止Dos（Denial of service，拒绝服务）攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--connlimit-upto N   #连接的数量小于等于N时匹配</span><br><span class="line">--connlimit-above N  #连接的数量大于N时匹配</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -d 10.0.0.0&#x2F;24 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.7 limit扩展</p>
<p>基于收发报文的速率做匹配，令牌桶过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--limit-burst number #前多少个包不限制</span><br><span class="line">--limit #</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT  -p icmp --icmp-type 8 -m limit --limit 10&#x2F;minute --limit-burst 5 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.8 state扩展</p>
<p>state扩展模块，可以根据“连接追踪机制”去检查连接的状态，比较消耗资源</p>
<p>conntrack机制：连接追踪机制，追踪本机上的请求和响应之间的关系</p>
<p>-m state –state NEW/ESTABLISHED/….</p>
<p>NEW:新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</p>
<p>ESTABLISHED</p>
<p>RELATED</p>
<p>第一个：已经追踪到的并记录下来的连接信息库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;net&#x2F;nf_contrack</span><br></pre></td></tr></table></figure>

<p>第二个：连接追踪功能所能容纳的最大连接数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;netfilter&#x2F;nf_conntrack_max</span><br><span class="line"></span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;nf_conntrack_max</span><br></pre></td></tr></table></figure>

<p>第三个：查看连接追踪有多少条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;netfilter&#x2F;nf_conntrack_count</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>连接追踪需要加载模块 modprobe nf_conntrack_ipv4</li>
<li>当服务器连接多于最大连接数时，dmesg可以观察到日志：kernel:ip_conntrack:table full,dropping packet错误，并且导致建立TCP连接很慢  tail -f /var/log/message</li>
<li>各种状态的超时后，链接会从表中删除</li>
</ul>
<h5 id="3-target"><a href="#3-target" class="headerlink" title="3.target"></a>3.target</h5><p>自定义链、ACCEPT、REJECT、DROP、RETURN、LOG、SNAT、DNAT、REDIRECT、MASQUERADE</p>
<h5 id="4-规则优化最佳实践："><a href="#4-规则优化最佳实践：" class="headerlink" title="4.规则优化最佳实践："></a>4.规则优化最佳实践：</h5><p>1.安全放行所有入站和出站的状态为ESTABLISHED状态连接，建议放在第一条，效率更高</p>
<p>2.谨慎放行入站的新请求</p>
<p>3.有特殊目的限制访问功能，要在放行规则之前加以拒绝</p>
<p>4.同类规则（访问同一应用，比如：http），匹配范围小的放前面，用于特殊处理</p>
<p>5.不同类的规则，匹配范围大的放在前面，效率更高，就是访问次数多的端口放前面，更加高效</p>
<h5 id="6-iptables规则保存"><a href="#6-iptables规则保存" class="headerlink" title="6.iptables规则保存"></a>6.iptables规则保存</h5><p>使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限</p>
<p>持久保存规则的方法：</p>
<p>防火墙的规则都是保存在文件里的，我们可以把自己配置好的防火墙规则保存成一个文件，然后通过开机自动加载这个文件的方式实现规则的永久保存</p>
<p><strong>centos7之后：</strong></p>
<p>iptables-save</p>
<p>iptables-restore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">iptables-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables #然后把这行命令放到&#x2F;etc&#x2F;rc.local 中，这样每次开机都会执行这行命令，从而达到防火墙规则的永久保存</span><br></pre></td></tr></table></figure>

<p><strong>centos6：</strong></p>
<p>/etc/sysconfig/iptables</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br><span class="line">service iptables restart #centos 6每次启动服务都会重新加载防火墙规则的，只要我们之前手动保存过就可以永久保存了</span><br></pre></td></tr></table></figure>

<h5 id="7-网络防火墙"><a href="#7-网络防火墙" class="headerlink" title="7.网络防火墙"></a>7.网络防火墙</h5><p>iptables/netfilter利用filter表的forward链，可以充当网络防火墙</p>
<p>注意的问题：</p>
<p>​    （1）请求-响应报文均会经由FORWARD链，要注意规则的方向性</p>
<p>​    （2）如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行</p>
<p>实验：防火墙利用forward链实现内外网的访问控制，同时对路由进行理解</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200917105248428.png" alt="image-20200917105248428"></p>
<p>1.通过标准模块实现内网访问外网，反之禁止</p>
<p>注意先开通转发功能：ip_forward = 1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.con</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">iptables -t fliter -A FORWARD -j REJECT  禁止所有的转发</span><br><span class="line">iptables -t filter -A FORWARD -s 10.0.0.0&#x2F;24 -p tcp --dport 80  -j ACCEPT  允许内网向外网的数据传输</span><br><span class="line">iptables -I FORWARD -d 10.0.0.0&#x2F;24 -p tcp --dport 80 -j ACCEPT 允许外网的80端口的回复</span><br></pre></td></tr></table></figure>

<p>2.通过state模块实现内网访问外网所有资源，反之禁止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -j REJECT  禁止所有转发</span><br><span class="line">iptables -I FORWARD -s 10.0.0.0&#x2F;24 -m state --state NEW -j ACCEPT  允许内网向外网建立连接</span><br><span class="line">iptables -I FORWARD  -m state --state ESTABLISHED,RELATED -j ACCEPT  允许所有已经了建立连接的主机之间数据的传输</span><br></pre></td></tr></table></figure>

<p>3.允许内网指定主机被外网访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -j REJECT  禁止所有转发</span><br><span class="line">iptables -I FORWARD -s 10.0.0.0&#x2F;24 -m state --state NEW -j ACCEPT  允许内网向外网建立连接</span><br><span class="line">iptables -I FORWARD  -m state --state ESTABLISHED,RELATED -j ACCEPT  允许所有已经了建立连接的主机之间数据的传输</span><br><span class="line">[root@centos8 network-scripts]#iptables -I FORWARD -d 10.0.0.5&#x2F;32 -p tcp --dport 8080 -j ACCEPT 允许内网的10.0.0.5主机的8080端口被访问</span><br></pre></td></tr></table></figure>

<p>4.一句命令实现内部访问外部，外部禁止访问内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 network-scripts]#iptables -R FORWARD 1 -d 10.0.0.0&#x2F;24 -m state --state NEW -j REJECT  利用state模块，实现禁止外部主动与内部通讯</span><br></pre></td></tr></table></figure>

<h3 id="NAT表"><a href="#NAT表" class="headerlink" title="NAT表"></a>NAT表</h3><p>SNAT，DNAT都是TARGET，是跟在“-j”后面的参数</p>
<h4 id="1-SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP"><a href="#1-SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP" class="headerlink" title="1.SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP"></a>1.SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s IP -t tcp|udp --dport xxx -j SNAT --to-source extened IP</span><br></pre></td></tr></table></figure>

<h4 id="2-DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP"><a href="#2-DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP" class="headerlink" title="2.DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP"></a>2.DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d IP -t tcp|udp|icmp --dport xx  -j DNAT --to-destination IP:[port] </span><br></pre></td></tr></table></figure>

<p>PAT：端口IP都转换，可以实现端口的对应关系，比如防火墙上IP的80端口对应内网web服务器IP的8080端口</p>
<p>综合实验：互联网中防火墙的实际NAT使用，SNAT和DNAT配合使用，还有最后在目标主机上配置本地端口转发</p>
<p>配置内外网的访问限制</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200916193650280.png" alt="image-20200916193650280"></p>
<p>​                                                                                    架构图</p>
<p>准备阶段：</p>
<ul>
<li>3个网段：10.0.0.0/8    172.16.0.0/12     192.168.0.0/16        为什么是这三个网段呢？因为这三个网段是私网网段，公网上没有这三种IP。</li>
<li>4台主机</li>
</ul>
<h4 id="3-REDIRECT转发"><a href="#3-REDIRECT转发" class="headerlink" title="3.REDIRECT转发"></a>3.REDIRECT转发</h4><p>REDIRECT，是NAT表的target，通过改变目标IP和端口，将接受的包转发至同一个主机的不同端口，可用于PREROUTING OUTPUT链</p>
<p><strong>适用于本地主机使用，不是让防火墙来使用的！！</strong></p>
<p>REDIRECT选项：</p>
<ul>
<li>–to-ports xx</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d ip -t tcp|udp --dport 80 -j REDIRECT --to-ports 80</span><br><span class="line">把原来发给IP：80端口的数据转发给了IP:8080端口</span><br></pre></td></tr></table></figure>



<h4 id="究极实验："><a href="#究极实验：" class="headerlink" title="究极实验："></a>究极实验：</h4><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200917154841708.png" alt="image-20200917154841708"></p>
<p>1.环境准备：包括三个网段、四台主机、开启路由转发功能、配置路由等操作</p>
<ul>
<li>路由转发功能：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward #查看当前主机是否开启路由转发功能，0是关闭，1是开启</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf </span><br><span class="line">添加一行</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">#保存退出</span><br><span class="line">sysctl -p #sysctl 是专门的内核参数命令，包括</span><br><span class="line">-a 显示所有内核参数 </span><br><span class="line">-p 读取 &#x2F;etc&#x2F;sysctl.conf文件中的配置</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置路由：本来只使用SNAT和DNAT的话可以不配置路由，但是为了体现FORWARD的功能，我专门配置了路由，使得 192.168.0.0/24 和 172.16.0.0/24 段能够互联互通。</p>
<ul>
<li>原本不通的原因：！！！ 原本192.168.0.0/24和10.0.0.3都不通，按理说不应该</li>
</ul>
<p>本来从192.168.0.0/24段通过防火墙的192.168.0.710.0.0.7这两个地址是可以找到10.0.0.3的，但是，10.0.0.3找不到192.168.0.0/24网段的路由！！！所以ping不通，所以需要写上去192.168.0.0/24网段的路由</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">配置10.0.0.7的路由：</span><br><span class="line">[root@localhost ~]#route -n  #显示当前路由</span><br><span class="line">Kernel IP routing table</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     102    0        0 eth0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.255.0   U     101    0        0 eth1</span><br><span class="line">通过实测发现，通过默认路由192.168.0.0&#x2F;24和172.16.0.0&#x2F;24是不能通信的，是因为10.0.0.7不知道怎么去172.16.0.0&#x2F;24网段，10.0.0.3不知道怎么去192.168.0.0&#x2F;24网段，所以要加上路由，告诉他们怎么去</span><br><span class="line"></span><br><span class="line">[root@localhost ~]#ip route add default dev eth0 via 10.0.0.3 #添加默认路由</span><br><span class="line">[root@localhost ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.0.0.3        0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     102    0        0 eth0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.255.0   U     101    0        0 eth1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同理配置10.0.0.3的路由</p>
<p>2.filter表的FORWARD链规则配置，目的是控制内外网之间的通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#iptables -t filter -A FORWARD -j REJECT #拒绝所有转发</span><br><span class="line">[root@localhost ~]#iptables -t filter -I FORWARD 1 -s 192.168.0.0&#x2F;24 -m state --state NEW -j ACCEPT #只允许内网向外网发起连接请求，也就是内网可以主动访问外网</span><br><span class="line">[root@localhost ~]#iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT #已经建立了的链接可以被转发</span><br><span class="line">[root@localhost ~]#iptables -I FORWARD 3 -d 192.168.0.100 -p tcp --dport 80 -j ACCEPT #开放内网的部分主机的部分服务给外网访问</span><br><span class="line">下面是配置好的filter的全部规则</span><br><span class="line">[root@localhost ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 47 packets, 3128 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    9   896 ACCEPT     all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            state RELATED,ESTABLISHED</span><br><span class="line">    2   136 ACCEPT     all  --  *      *       192.168.0.0&#x2F;24       0.0.0.0&#x2F;0            state NEW</span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0&#x2F;0            192.168.0.100        tcp dpt:80</span><br><span class="line">   18  1232 REJECT     all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 25 packets, 2348 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination </span><br></pre></td></tr></table></figure>

<p>同理配置另一个公司的防火墙filter表的FORWARD链规则</p>
<p>3.NAT，利用NAT实现私网地址和公网地址的转换，涉及到nat表的PREROUTING和POSTROUTING链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#iptables -t nat -A POSTROUTING -s 192.168.0.0&#x2F;24 -p tcp -j  MASQUERADE</span><br><span class="line">[root@localhost ~]#iptables -t nat -A PREROUTING -d 10.0.0.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.0.100:8080</span><br><span class="line">注意：这里除了设定了DNAT，还设定了端口转换，本来是发送给80端口的，但是转换成了8080端口，所以上面的FORWARD规则就要改一下，把允许外网通过的tcp端口改成8080</span><br></pre></td></tr></table></figure>

<p>4.测试，可以实现</p>
<p>5.防火墙规则保存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sysconfig]#iptables-save &gt; &#x2F;data&#x2F;iptables.conf</span><br><span class="line">[root@localhost data]#vim iptables.conf</span><br><span class="line">  1 # Generated by iptables-save v1.4.21 on Thu Sep 17 18:45:26 2020</span><br><span class="line">  2 *nat</span><br><span class="line">  3 :PREROUTING ACCEPT [21:2684]</span><br><span class="line">  4 :INPUT ACCEPT [4:916]</span><br><span class="line">  5 :OUTPUT ACCEPT [19:1420]</span><br><span class="line">  6 :POSTROUTING ACCEPT [31:2212]</span><br><span class="line">  7 -A PREROUTING -d 10.0.0.7&#x2F;32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.0.100:8080</span><br><span class="line">  8 -A POSTROUTING -s 192.168.0.0&#x2F;24 -p tcp -j MASQUERADE</span><br><span class="line">  9 COMMIT</span><br><span class="line"> 10 # Completed on Thu Sep 17 18:45:26 2020</span><br><span class="line"> 11 # Generated by iptables-save v1.4.21 on Thu Sep 17 18:45:26 2020</span><br><span class="line"> 12 *filter</span><br><span class="line"> 13 :INPUT ACCEPT [561:40565]</span><br><span class="line"> 14 :FORWARD ACCEPT [0:0]</span><br><span class="line"> 15 :OUTPUT ACCEPT [363:66484]</span><br><span class="line"> 16 -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"> 17 -A FORWARD -s 192.168.0.0&#x2F;24 -m state --state NEW -j ACCEPT</span><br><span class="line"> 18 -A FORWARD -d 192.168.0.100&#x2F;32 -p tcp -m tcp --dport 8080 -j ACCEPT</span><br><span class="line"> 19 -A FORWARD -j REJECT --reject-with icmp-port-unreachable</span><br><span class="line"> 20 COMMIT</span><br><span class="line"> 21 # Completed on Thu Sep 17 18:45:26 2020  </span><br><span class="line"> 设置为开机自动导入规则，配合开机自动启动防火墙服务，可以实现永久保存规则</span><br><span class="line"> [root@localhost data]#iptables-restore &lt; &#x2F;data&#x2F;iptables.conf</span><br><span class="line"> [root@localhost data]#vim &#x2F;etc&#x2F;rc.local</span><br><span class="line">  1 #!&#x2F;bin&#x2F;bash</span><br><span class="line">  2 # THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span><br><span class="line">  3 #</span><br><span class="line">  4 # It is highly advisable to create own systemd services or udev rules</span><br><span class="line">  5 # to run scripts during boot instead of using this file.</span><br><span class="line">  6 #</span><br><span class="line">  7 # In contrast to previous versions due to parallel execution during boot</span><br><span class="line">  8 # this script will NOT be run after all other services.</span><br><span class="line">  9 #</span><br><span class="line"> 10 # Please note that you must run &#39;chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local&#39; to ensure</span><br><span class="line"> 11 # that this script will be executed during boot.</span><br><span class="line"> 12 </span><br><span class="line"> 13 touch &#x2F;var&#x2F;lock&#x2F;subsys&#x2F;local</span><br><span class="line"> 14 iptables-restore &lt; &#x2F;data&#x2F;iptables.conf </span><br></pre></td></tr></table></figure>



<p>firewalld</p>
<p>firewall-cmd</p>
<p>zone</p>
<p>nft netfiltertables</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>huihui</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙">http://example.com/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/11/18/LVS/" rel="prev" title="LVS"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">LVS</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/11/18/KVM%20---%20Kernel-Based%20Virtual%20Machine/" rel="next" title="KVM"><span class="post-nav-text">KVM</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+Linux防火墙">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> huihui</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.3.0</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>