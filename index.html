<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="学习和看笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="辉辉的数据库">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="辉辉的数据库">
<meta property="og:description" content="学习和看笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="huihui">
<meta property="article:tag" content="notes">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>辉辉的数据库</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">辉辉的数据库</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">我们要丈量大地！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-18 21:55:38" itemprop="dateCreated datePublished" datetime="2020-11-18T21:55:38+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/Linux%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/Linux%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">Linux启动和内核管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：21:59:27" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Linux启动和内核管理"><a href="#Linux启动和内核管理" class="headerlink" title="Linux启动和内核管理"></a>Linux启动和内核管理</h3><p>重点：</p>
<p><strong>1.linux的启动流程</strong></p>
<p>2.启动故障排错</p>
<p>3.编译内核</p>
<p><strong>4.内核参数优化 /etc/sysctl.conf</strong> </p>
<p>5.自制Linux+BUSYBOX = WEB服务器</p>
<p>命令：</p>
<p>busybox    mkinitrd    modinfo    modprobe    chkconfig    sysctl</p>
<p>ntsysnv    ismod    rmmod    grub    grub-install    grub-md5-crypt    grub-crypt    runlevel    </p>
<p>sysctl -a -w -p</p>
<p>加电自检–&gt;找到启动设备–&gt;bootloader grub –&gt;读取第一个扇区内容（512 bytes）–&gt;找到文件系统的驱动程序</p>
<p>bootloader 阶段</p>
<ul>
<li>1阶段：MBR的前446个字节</li>
<li>1.5阶段：512字节之后的扇区，让阶段1的bootloader能识别阶段2所在分区的文件系统</li>
<li>2阶段：分区文件/boot/grub</li>
</ul>
<p>/boot/grub/grub.conf –&gt;找到系统内核和根系统路径</p>
<p>kernel /vmlinuzxxxxxxx</p>
<p>initrd /initxxxxxxxxx</p>
<p>1,1.5阶段的修复：</p>
<ul>
<li><p>切换根目录 chroot /mnt/sysimage</p>
</li>
<li><p>grub -install –root -directory=DIR /dev/sda –&gt;修复/boot/grub下除了grub.conf以外的文件</p>
</li>
<li><p>mkinitrd /boot/initrdxxxx</p>
</li>
</ul>
<p>centos 6 的开机运行程序顺序</p>
<p>脚本的编写</p>
<p>服务卡住导致无法启动，可以进单用户模式修改，禁止他启动</p>
<p>/etc/init.d/  这里放的是脚本</p>
<p>/etc/rc*.d/    这里放的都是软链接，通过命令创建软链接</p>
<p>然后通过命令将他添加到自动启动</p>
<p>/etc/rc.d/rc.local 这个里面可以写自己想要自动启动的脚本</p>
<p><strong>/proc</strong></p>
<p>sysctl </p>
<p>/etc/sysctl.conf</p>
<p><strong>/sys</strong></p>
<h4 id="内核管理"><a href="#内核管理" class="headerlink" title="内核管理"></a>内核管理</h4><p>kernel object  内核文件 .ko</p>
<p>几个内核模板命令</p>
<p><strong>编译内核</strong></p>
<p>1.configure文件照抄原系统，修改几个地方</p>
<p>2.解压文件</p>
<p>3.编译</p>
<p>4.make install</p>
<p><strong>BUSYBOX</strong>：一个强大的工具箱，可以实现多种功能</p>
<h4 id="内核参数"><a href="#内核参数" class="headerlink" title="内核参数"></a>内核参数</h4><p>/proc/sys –&gt; sysctl命令，专门用来调整内核参数</p>
<p><strong>sysctl</strong> -w name=xxx  更改内核参数 </p>
<p>sysctl -a 全部内核参数</p>
<p>/sys 硬件信息</p>
<p>内核版本 uname -r 显示版本</p>
<p><strong>uname</strong> -a 显示所有信息</p>
<p>内核模块命令 /proc/modules</p>
<p><strong>lsmod</strong> 显示由核心已经装载的内核模块，显示内容来自/proc/modules</p>
<p><strong>modinfo</strong> 管理内核模块，显示内核模块的详细信息</p>
<p>modinfo -n  只显示模块路径</p>
<p>modinfo -p 显示模块参数</p>
<p>modinfo -a 作者</p>
<p>modinfo -d 描述</p>
<p><strong>modprobe</strong>  装载或卸载内核模块</p>
<p>modprobe usb_storage 装载</p>
<p>modprobe -r usb_storage 卸载</p>
<p><strong>depmod</strong> 内核模块依赖关系文件及系统信息映射文件的生成工具</p>
<p><strong>insmod</strong>  可以安装模块，需要指定模块文件路径，并且不自动解决依赖模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insmod [ filename ]  [ module options ]</span><br><span class="line">例子：</span><br><span class="line">insmod &#96;modinfo -n exportfs&#96;</span><br><span class="line">insmod &#96;modinfo -n xfs&#96;</span><br></pre></td></tr></table></figure>

<p><strong>rmmod</strong> 卸载模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rmmod xfs</span><br><span class="line">rmmod exportfs</span><br></pre></td></tr></table></figure>



<h4 id="centos-6-linux的启动流程"><a href="#centos-6-linux的启动流程" class="headerlink" title="centos 6 linux的启动流程"></a>centos 6 linux的启动流程</h4><p><a target="_blank" rel="noopener" href="http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg">http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg</a></p>
<p>–&gt;加电自检</p>
<p>–&gt;加载BIOS，根据自上而下的顺序决定启动的存储硬件，并读取硬件上的MBR（Master boot recoder，硬盘的主引导记录）</p>
<p>–&gt;寻找grub，MBR的前446字节是grub（bootloader）的地址，后64字节是分区信息，最后两个字节是55 aa结束标识位</p>
<p><strong>stage1</strong> MBR的前446个字节，里面是grub的地址</p>
<p><strong>stage1.5</strong> MBR从前512字节之后的字节，这里的内容是让grub能够识别/boot/grub的文件系统</p>
<p><strong>stage2</strong> /boot/grub文件，这里面有grub配置文件，包含内核位置，initrd文件位置等信息</p>
<p>–&gt;读取grub的配置信息，grub的配置信息中包含了操作系统的内核位置和初始化程序包（硬件驱动程序）</p>
<p>–&gt;内核执行init程序，获取默认的运行信息（/etc/inittab）</p>
<p>–&gt;init程序执行/etc/rc.d/rc.sysinit文件，重新挂载根文件系统</p>
<p>–&gt;启动核心的外挂模块</p>
<p>–&gt;init运行各个脚本文件（/etc/rc.d/init.d）</p>
<p>–&gt;init执行/etc/rc.d/rc.local</p>
<p>–&gt;执行/bin/login程序，等待用户登录</p>
<p>–&gt;用户登录，以shell控制主机</p>
<h4 id="centos6的最小系统制作"><a href="#centos6的最小系统制作" class="headerlink" title="centos6的最小系统制作"></a>centos6的最小系统制作</h4><p>所需条件：</p>
<p>1.vmlinuz内核文件，initrawfs.img 镜像模块文件</p>
<p>2.grub引导，grub-install –root-directory=/root /dev/sda，以及grub.conf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">default&#x3D;0</span><br><span class="line">timeout&#x3D;5</span><br><span class="line">title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">kernel &#x2F;vmlinuz root&#x3D;&#x2F;dev&#x2F;sda2 init&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">initrd &#x2F;initramfs.img</span><br></pre></td></tr></table></figure>

<p>3.必要的目录和启动程序及命令脚本，启动程序和目录脚本可以用busybox代替，在</p>
<p>busybox源码编译完成后，生成了_install文件，里面有/bin,/sbin,/usr 这里面有基本所有的命令，他们都指向/bin/busybox。</p>
<h4 id="centos6删除-boot-以及-etc-fstab后如何自救"><a href="#centos6删除-boot-以及-etc-fstab后如何自救" class="headerlink" title="centos6删除 /boot/*以及/etc/fstab后如何自救"></a>centos6删除 /boot/*以及/etc/fstab后如何自救</h4><p>1.进入救援模式，此时是看不到硬盘分区信息的，所以第一个目的就是恢复分区信息，尤其是找到/root，因为找到这个目录就能自己编写/etc/fstab了</p>
<p>使用fdisk -l 可以看到硬盘的分区情况，但是都没有挂载，需要新建一个文件夹来挂载测试，看看哪个分区是/root</p>
<p>2.找到/root后，编写fstab文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UUID&#x3D;4d61dbb0-c5bb-4403-a7a3-8fbac43d112d &#x2F;                       xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;61ad2930-f49f-4257-86b7-a530310a949b &#x2F;boot                   xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;23b80602-17b8-4a93-a9fa-a8d4b45838f3 &#x2F;data                   xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;e024b373-e102-42e1-ae6e-cc83cd135eec swap                    swap    defaults        0 0</span><br><span class="line">UUID&#x3D;95a42eaa-cc05-484d-ae5e-88b98add2c39 &#x2F;edata          ext4    defaults        0 0          </span><br></pre></td></tr></table></figure>

<p>这里面 UUID那里可以直接写硬盘的分区名，比如 /dev/sda1 这样，后面写挂载点</p>
<p>然后重启</p>
<p>3.重启后还是不能打开系统，因为没有启动引导了，所以还要进救援模式</p>
<p>4.这次进救援模式就是为了重新生成引导文件，所以需要这么几步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.切换根，chroot &#x2F;mnt&#x2F;sysimage&#x2F; </span><br><span class="line">2.恢复内核文件和模块镜像文件，可以用下面的命令生成</span><br><span class="line">rpm -ivh &#x2F;mnt&#x2F;Packages&#x2F;kernelxxxxxxx.rpm --force</span><br><span class="line">3.生成grub文件夹以及里面除了grub.conf以外的文件 grub-install &#x2F;dev&#x2F;sda1</span><br><span class="line">4.编写grub.conf</span><br><span class="line">	default&#x3D;0</span><br><span class="line">	timeout&#x3D;5</span><br><span class="line">	title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">	kernel &#x2F;vmlinuz root&#x3D;&#x2F;dev&#x2F;sda2 init&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">	initrd &#x2F;initramfs.img</span><br><span class="line">5.sync 同步</span><br><span class="line">6.重启</span><br></pre></td></tr></table></figure>



<h4 id="systemd：system-daemon！"><a href="#systemd：system-daemon！" class="headerlink" title="systemd：system daemon！"></a><strong>systemd</strong>：system daemon！</h4><p> centos7,8的技术，超级守护进程，顶替了xinetd</p>
<p>systemd代替其他的服务程序去监听端口，按需要唤醒服务</p>
<p>socket：套接字  端口:IP_ADDR</p>
<p>service：服务程序</p>
<p>unit：统统都叫unit</p>
<p>unit类型：</p>
<ul>
<li><p>service unit：文件扩展名为.service，用于定义系统服务</p>
</li>
<li><p>Socket unit：.socket，定义进程间通信用的socket，也可以在系统启动时，延迟启动服务，实现按需启动</p>
</li>
<li><p>Target unit：文件扩展名为.target，用于模拟实现运行级别</p>
</li>
<li><p>Device unit：.device，用于定义内核识别的设备</p>
</li>
<li><p>Mount unit：.mount，定义文件系统挂载点</p>
</li>
</ul>
<p>涉及到的文件路径：</p>
<p><strong>/usr/lib/systemd/system</strong> 这个目录下放着启动服务.service文件，类似启动脚本，这里是发行版软件</p>
<p><strong>/lib/systemd/system</strong>  这里也是放启动服务，类似脚本，这里是系统自带</p>
<p><strong>/run/systemd/system</strong> 系统执行过程中所产生的服务脚本</p>
<p><strong>/etc/systemd/system</strong> 这个目录下包含了哪些运行级别下哪些服务要被启动或禁用</p>
<p>/usr/lib/systemd/system/ 和 /lib/systemd/system 之间存在特殊关系，我在这两个文件夹下创建name.service文件后，两边会同时生成name.service文件，在启用这个name.service服务时，建立的软链接是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;systemd&#x2F;systemd&#x2F;multi-user.target.wants&#x2F;hello.service -&gt; &#x2F;user&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;hello.service</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.systemctl命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl start name.service</span><br><span class="line">systemctl stop name.service</span><br><span class="line">systemctl restart naem.service</span><br><span class="line">systemctl status name.service</span><br><span class="line">systemctl is-active name.service</span><br><span class="line">systemctl is-enabled name.service</span><br><span class="line">systemctl mask name.service </span><br><span class="line">systemctl unmask name.service </span><br><span class="line">systemctl list-units -t service #列出运行的服务</span><br><span class="line">systemctl list-units --type service -a  #列出所有服务</span><br><span class="line">systemctl enbale name.service</span><br><span class="line">systemclt disable name.service</span><br><span class="line">ll &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;*.wants&#x2F; #列出哪些服务在哪些运行级别下启用和禁用</span><br><span class="line">systemctl --failed --type service #列出失败的服务</span><br><span class="line">systemctl list-dependencies name.service #列出服务的依赖关系</span><br><span class="line">systemctl kill unitname #杀掉进程</span><br><span class="line">systemctl list-unit-files #列出unit的状态</span><br></pre></td></tr></table></figure>

<ul>
<li>loaded unit配置文件已处理</li>
<li>active(running) 一次或多次秩序处理的运行</li>
<li>active(exited) 成功完成一次性的配置</li>
<li>active(waiting) 运行中，等待一个事件</li>
<li>inactive 不运行</li>
<li>enabled 开机启动</li>
<li> disabled 开机不启动</li>
<li>static 开机不启动，但可被另一个启用的服务激活</li>
<li>indirect 重定向到别处</li>
</ul>
<p><strong>2.service unit</strong></p>
<p>unit格式说明：</p>
<ul>
<li>以“#”开头的行后面的内容会被认为是注释</li>
<li>相关布尔值，1，yes，on，true都是开启，0，no，off，false都是关闭</li>
<li>时间单位默认是秒，所以要用毫秒（ms）、分钟（m）等需要显式说明</li>
</ul>
<p>service unit file 通常由三部分组成：</p>
<ul>
<li>[Unit]：定义与Unit类型无关的通用选项；用于提供unit的描述信息、unit行为及依赖关系等</li>
<li>[Service]：与特定类型相关的专用选项；此处为Service类型</li>
<li>[Install]：定义由“systemctl enable”以及“systemctl disable”命令在实现服务启用或禁用时用到的一些选项</li>
</ul>
<p>Unit段常用选项：</p>
<ul>
<li>Description：描述信息</li>
<li>After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反</li>
<li>Requires：依赖到的其他units，强依赖，被依赖的units无法激活时，当前unit也无法激活</li>
<li>Wants：依赖到的其他units，若依赖</li>
<li>Conflict：定义units间的冲突关系</li>
</ul>
<p>Service段的常用选项：</p>
<ul>
<li>Type：定义影响ExecStart及相关参数的功能的unit进程启动类型<ul>
<li>simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后常驻与内存中</li>
<li>forKing：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此daemon的主要服务，原生父程序在启动结束后就会终止</li>
<li>oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻与内存</li>
<li>dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才会继续运作，因此通常也要同时设定BusName= 才行</li>
<li>notify：在启动完成后会发送一个通知信息，还需要配合NotifyAccess来让Systemd接收消息</li>
<li>idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕后才执行。这类的daemon通常是开机到最后才执行即可的服务。</li>
</ul>
</li>
<li>EnvironmentFile：环境配置文件</li>
<li>ExecStart：指明启动unit要运行命令或脚本的绝对路径</li>
<li>ExecStartPre：ExecStart前运行</li>
<li>ExecStartPost：ExecStart后运行</li>
<li>ExecStop：指明停止unit要运行的命令或脚本</li>
<li>Restart：当设定Restart=1时，则当daemon服务意外终止后，会再次启动此服务</li>
<li>PrivateTmp：设定为yes时，会生成/tmp/systemd-private-UUID-NAME.service-XXXX/tmp/ 目录</li>
</ul>
<p>Install段的常用选项：</p>
<ul>
<li>Alias：别名，可使用systemctl command Alias.service</li>
<li>RequireBy：被哪些units所依赖，强依赖</li>
<li>WantedBy：被哪些units所依赖，弱依赖</li>
<li>Also：安装脚本服务的时候还要安装别的相关服务</li>
</ul>
<p>注意：新建或者修改了unit文件，需要通知systemd重新加载此文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>



<p>3.target units：相当于centos 6 之前的runlevel，unit配置文件：.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;*.target</span><br><span class="line">systemctl list-units --type target -a #显示全部target</span><br></pre></td></tr></table></figure>

<p>运行级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">o &#x3D;&#x3D;&gt; runlevel0.target，poweroff.target</span><br><span class="line">1 &#x3D;&#x3D;&gt; runlevel1.target，rescue.target</span><br><span class="line">2 &#x3D;&#x3D;&gt; runlevel2.target，multi-user.target</span><br><span class="line">3 &#x3D;&#x3D;&gt; runlevel3.target，multi-user.target</span><br><span class="line">4 &#x3D;&#x3D;&gt; runlevel4,target，multi-user.target</span><br><span class="line">5 &#x3D;&#x3D;&gt; runlevel5,target，graphical.target</span><br><span class="line">6 &#x3D;&#x3D;&gt; runlevel6，target,reboot.target</span><br></pre></td></tr></table></figure>

<p>查看target的依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units dependencies  name.target</span><br></pre></td></tr></table></figure>

<p>运行级别切换：相当于 init N</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysetmctl isslate name.target</span><br></pre></td></tr></table></figure>

<p>查看当前默认运行级别、进入默认运行级别、设定默认运行级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl get-default</span><br><span class="line">systemctl default</span><br><span class="line">systemctl set-default name.target</span><br></pre></td></tr></table></figure>

<p>生产环境禁用ctrl+alt+delete重启快捷键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ll &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ctrl-alt-del.target</span><br><span class="line">systemctl mask ctrl-alt-del.target</span><br><span class="line">Created symlink &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ctrl-alt-del.target -&gt; &#x2F;dev&#x2F;null</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>



<h4 id="centos-7之后的linux启动流程"><a href="#centos-7之后的linux启动流程" class="headerlink" title="centos 7之后的linux启动流程"></a>centos 7之后的linux启动流程</h4><p>–&gt;加电自检</p>
<p>–&gt;加载BIOS，选择启动的硬件存储设备</p>
<p>–&gt;引导装载程序，centos7之后是grub2，配置文件是</p>
<p>/etc/grub.d  /etc/default/grub  /boot/grub2/grub.cfg</p>
<p>–&gt;加载initramfs驱动模块</p>
<p>–&gt;加载内核选项</p>
<p>–&gt;内核初始化，centos7使用systemd代替init</p>
<p>–&gt;执行initrd.target所有单元，包括挂载/etc/fstab</p>
<p>–&gt;从initramfs根文件切换到磁盘根目录</p>
<p>–&gt;systemd执行默认target配置，配置文件/etc/systemd/system/system.target</p>
<p>–&gt;systemd执行sysint.target初始化系统及basic.target准备操作系统</p>
<p>–&gt;systemd启动multi-user.target下的本机与服务器服务</p>
<p>–&gt;systemd执行multi-user.target下的/etc/rc.d/rc.local</p>
<p>–&gt;systemd执行multi-user.target下的getty.target及登录服务</p>
<p>–&gt;systemd执行graphical需要的服务</p>
<p>执行命令可以看到systemd的执行过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze blame</span><br><span class="line">systemd-analyze plot &gt; boot.html #这个命令可以生成一个html文件</span><br></pre></td></tr></table></figure>

<h4 id="破解centos7-8的root密码："><a href="#破解centos7-8的root密码：" class="headerlink" title="破解centos7,8的root密码："></a>破解centos7,8的root密码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在系统启动过程中，在内核选择界面按e,然后在linux开头那行的最后加上：rd.break，然后ctrl+x启动，进入一个shell界面，这时需要重新挂载根目录，</span><br><span class="line">mount -o remount,rw &#x2F;sysroot</span><br><span class="line">chroot &#x2F;sysroot</span><br><span class="line">passwd root</span><br><span class="line">更改密码，然后exit,reboot，ok了</span><br></pre></td></tr></table></figure>

<p>破解centos6的root密码，更简单，在系统启动过程中，在内核选择界面按e，然后在linux开头的行最后写上 1或者s,S,single都行，意思是进入单用户模式，然后按b启动，然后就OK了，进入系统后passwd改密码就行</p>
<p>grub2增加密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grub2-password</span><br><span class="line">输入两遍密码</span><br><span class="line">这个密码其实是生成了一个&#x2F;boot&#x2F;grub2&#x2F;user.cfg文件，如果不想要密码了就把这个文件删除就行</span><br></pre></td></tr></table></figure>

<h4 id="grub2"><a href="#grub2" class="headerlink" title="grub2"></a>grub2</h4><p>grub2的修复：</p>
<p>1.修复配置文件grub.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg</span><br></pre></td></tr></table></figure>

<p>2.完整修复grub2文件夹中除了grub.cfg以外的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub-install &#x2F;dev&#x2F;sda  #此时的根是真正的根目录时，不需要写 --root-directory&#x3D;xxx，如果此时是光盘的救援模式等情况，根不是真根，那么就需要写真正的根目录</span><br></pre></td></tr></table></figure>

<p>3.修改默认启动内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;boot&#x2F;grub2&#x2F;grubenv</span><br><span class="line">#里面有一行：saved_entry&#x3D;xxxx，修改成想要的内核名称</span><br></pre></td></tr></table></figure>









<p>今日重点：</p>
<p>1.systemctl start stop restart enable disable is-actice is-enable reload mask systemctl get-default</p>
<p>2.service 文件格式</p>
<p>3.centos7,8启动流程，systemd （启动流程）</p>
<p>4.grub2</p>
<p>5.破解centos7,8 root秘密，grub加密</p>
<p>6.rm -rf /boot centos7的修复实验</p>
<p>7.安全，加密算法：对称，非对称，哈希，综合使用</p>
<p>8.证书和CA的工作原理</p>
<p>9.https的工作原理 (重要)</p>
<p>gpg sha512sum  grub2-mkconfig grub2-setpassword systemd-analize plot reset </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/DNS%E6%9C%8D%E5%8A%A1%E5%92%8CBIND%E8%BD%AF%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/DNS%E6%9C%8D%E5%8A%A1%E5%92%8CBIND%E8%BD%AF%E4%BB%B6/" class="post-title-link" itemprop="url">DNS服务和BIND软件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：21:56:55" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="DNS服务和BIND软件"><a href="#DNS服务和BIND软件" class="headerlink" title="DNS服务和BIND软件"></a>DNS服务和BIND软件</h2><p>2.DNS实现主服务器</p>
<p>3.DNS实现从服务器</p>
<p>4.DNS实现子域</p>
<p>5.DNS实现域名转发</p>
<p>6.DNS实现反向区域解析</p>
<h3 id="1-名字解析介绍"><a href="#1-名字解析介绍" class="headerlink" title="1.名字解析介绍"></a>1.名字解析介绍</h3><p>TCP/IP协议–&gt;IP地址是访问的开始–&gt;IP地址难记–&gt;用一种好记的名字代替IP，域名出现</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.222  www.dawang.org</span><br><span class="line">203.23.44.222  www.xiaowang.org</span><br></pre></td></tr></table></figure>

<p>DNS domain name system 域名系统，应用层协议，是互联网的一项服务。</p>
<p>C/S架构</p>
<p>53/udp：同步和查询</p>
<p>53/tcp：同步</p>
<p>DNS级别：</p>
<ul>
<li>根域</li>
<li>一级域名<ul>
<li>三类：组织域、国家域、反向域</li>
</ul>
</li>
<li>二级域名：xxxxxx.com</li>
<li>三级域名：aaa.xxxx.com</li>
<li>最多127级域名</li>
</ul>
<h3 id="2-DNS服务工作原理"><a href="#2-DNS服务工作原理" class="headerlink" title="2.DNS服务工作原理"></a>2.DNS服务工作原理</h3><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200912170407556.png" alt="image-20200912170407556"></p>
<p>DNS的查询类型：</p>
<ul>
<li>递归查询：一般客户端和本地DNS服务端之间属于递归查询，即当客户机向DNS服务器发出请求后，若DNS服务器本身不能解析，则会向另外的DNS服务器发出查询请求，得到最终的肯定或者否定的结构后转交给客户机。此查询的源和目标保持不变，为了查询结果只需要发起一次查询。</li>
<li>迭代查询：一般情况下本地的DNS服务器向其他DNS服务器的查询属于迭代查询，如：若对方不能返回权威的结果，则它会向下一个DNS服务器再次发起查询，直到返回查询的结果为止。此查询的源不变，但查询的目标不断变化，为查询结果一般需要发起多次查询。</li>
</ul>
<p>小工具：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whois xxxxx.com</span><br><span class="line">可以查出域名信息</span><br></pre></td></tr></table></figure>

<p>FQDN:Fully Qualified Domain Name 全限定域名，同时带有主机名和域名的名称。</p>
<p>比如：主机名是big，域名是hhh.com，FQDN就是 big.hhh.com</p>
<p>解析的类型：</p>
<ul>
<li>FQDN –&gt; IP正向解析</li>
<li>IP –&gt; FQDN反向解析</li>
</ul>
<p>一个完整的查询请求经过的流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client --&gt; hosts文件 --&gt; Client DNS Service Local Cache --&gt; DNS Server（recursion） --&gt; DNS Server Cache --&gt; DNS iteration（迭代） --&gt; 根 --&gt; 顶级域名DNS --&gt; 二级域名DNS</span><br></pre></td></tr></table></figure>

<p>DNS服务器的类型：</p>
<ul>
<li>主DNS服务器：管理和维护所负责解析的域内解析库的服务器</li>
<li>从DNS服务器：从主服务器或从服务器复制解析库副本<ul>
<li>序列号：主服务器的DNS数据库版本号</li>
<li>刷新时间间隔：从主服务器请求同步解析的时间间隔</li>
<li>重试时间间隔：从服务器请求同步失败时，再次尝试的时间间隔</li>
<li>过期时长：从服务器联系不上主服务器时，多久后停止服务</li>
<li>通知机制：主服务器解析库发生变化时，会主动通知从服务器</li>
</ul>
</li>
<li>缓存DNS服务器（转发器）：</li>
</ul>
<p>权威DNS服务器：真正保存你要找的域名的IP的服务器</p>
<p>资源记录：RR Resource Record</p>
<ul>
<li><p>SOA：Start Of Authority，起始授权记录，一个区域解析库有且仅有一个SOA记录，必须位于解析库的第一条记录</p>
</li>
<li><p>A：Internet Address，正向解析</p>
</li>
<li><p>AAAA：正向解析，IPV6</p>
</li>
<li><p>PTR：PoinTeR，反向解析</p>
</li>
<li><p>NS：Name Server，专用于标明当前区域的DNS服务器</p>
</li>
<li><p>CNAME：Canonical Name，别名记录</p>
</li>
<li><p>MX：Mail exchanger，邮件交换器</p>
</li>
<li><p>TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name		[TTL]		IN			rr_type			value</span><br></pre></td></tr></table></figure>

<p>TTL：time to live 一个DNS记录在DNS服务器上的缓存时间，可以被继承</p>
<p>@：表示引用当前区域的名字</p>
<p>相邻的两个记录name相同时，后一个的name可以省略</p>
</li>
</ul>
<h3 id="3-实现主服务器"><a href="#3-实现主服务器" class="headerlink" title="3.实现主服务器"></a>3.实现主服务器</h3><p>bind软件实现</p>
<ul>
<li>bind主程序：/usr/sbin/named</li>
<li>主配置文件：/etc/named.conf,/etc/named.rfc1921.zones,/etc/rndc.key</li>
<li>管理工具：/usr/sbin/rndc  remote name domain controller ，默认与bind安装在同一主机，且只能通过127.0.0.1连接named进程，提供辅助性的管理功能；953/tcp</li>
<li>解析库文件：/var/named/ZONE_NAME&gt;ZONE<ul>
<li>一台物理服务器可以同时为多个区域提供解析</li>
<li>必须有两个根区域文件；named.cd</li>
<li>应该有两个实现localhost和本地回环地址的解析库</li>
</ul>
</li>
</ul>
<p>实现需要的资料：</p>
<ul>
<li><p>对主配置文件进行修改</p>
<p>/etc/named.conf</p>
</li>
<li><p>自定义区域解析库文件</p>
</li>
</ul>
<p>/var/named/xxxxx.zone</p>
<ul>
<li>生效工具</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">三种方式</span><br><span class="line">rndc reload</span><br><span class="line">systemctl reload named</span><br><span class="line">service named reload</span><br></pre></td></tr></table></figure>

<ul>
<li>测试工具</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">主配置文件语法检查</span><br><span class="line">named-checkconf</span><br><span class="line">解析库文件语法检查</span><br><span class="line">named-checkzone &quot;lvlvl.dota&quot; &#x2F;var&#x2F;named&#x2F;xxxx.dota.zone</span><br><span class="line">dig命令，只用于测试DNS，不会查询hosts文件</span><br><span class="line">host命令</span><br><span class="line">nsloopup命令，可以支持交互和非交互式</span><br></pre></td></tr></table></figure>

<p>实现步骤：</p>
<p>1.安装软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#yum -y insatll bind bind-utils</span><br></pre></td></tr></table></figure>

<p>2.主配置文件修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;etc&#x2F;named.conf</span><br><span class="line">注释掉这两行：</span><br><span class="line">&#x2F;&#x2F;  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">&#x2F;&#x2F;  allow-query     &#123; localhost; &#125;;</span><br><span class="line">[root@localhost etc]#vim named.rfc1912.zones</span><br><span class="line">添加下面的内容：</span><br><span class="line">zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line">     type master;</span><br><span class="line">     file &quot;lv.dota.zone&quot;;</span><br><span class="line">&#125;;         </span><br></pre></td></tr></table></figure>

<p>3.DNS区域数据库文件 位于 /var/named/ 文件夹下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#cp -p &#x2F;var&#x2F;named&#x2F;named.localhost &#x2F;var&#x2F;named&#x2F;lv.dota.zone</span><br><span class="line">[root@localhost named]#vim named.localhost</span><br><span class="line">  1 $TTL 1D                                                                  </span><br><span class="line">  2 @   IN SOA  @ rname.invalid. (</span><br><span class="line">  3                     0   ; serial</span><br><span class="line">  4                     1D  ; refresh</span><br><span class="line">  5                     1H  ; retry</span><br><span class="line">  6                     1W  ; expire</span><br><span class="line">  7                     3H )    ; minimum</span><br><span class="line">  8     NS  @</span><br><span class="line">  9     A   127.0.0.1</span><br><span class="line"> 10     AAAA    ::1</span><br><span class="line"> </span><br><span class="line">[root@localhost named]#vim &#x2F;var&#x2F;named&#x2F;lv.dota.zone </span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN SOA  master admin.lv.dota. (</span><br><span class="line">  3                     0   ; serial</span><br><span class="line">  4                     1D  ; refresh</span><br><span class="line">  5                     1H  ; retry</span><br><span class="line">  6                     1W  ; expire</span><br><span class="line">  7                     3H )    ; minimum</span><br><span class="line">  8     NS  master</span><br><span class="line">  9 master  A   10.0.0.7                                                     </span><br><span class="line"> 10 www     A   10.0.0.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.检查主配置文件和区域数据库文件的格式是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">named-checkconf</span><br><span class="line">named-checkzone lv.dota &#x2F;var&#x2F;named&#x2F;lv.dota.zone</span><br><span class="line">检查无误后启动服务</span><br></pre></td></tr></table></figure>

<p>5.启动服务，配合一台http主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named</span><br><span class="line">rndc reload #这是重新加载</span><br><span class="line">去http主机上开启服务</span><br><span class="line">systemctl start httpd</span><br><span class="line">echo &quot;for your love&quot; &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>6.去一台客户端服务器上测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">首先将客户端的DNS地址配成10.0.0.7</span><br><span class="line">vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br><span class="line">DNS1&#x3D;10.0.0.7</span><br><span class="line">service network restart</span><br><span class="line">检查DNS是不是改过来了</span><br><span class="line">cat &#x2F;etc&#x2F;resolv.conf</span><br><span class="line">出现nameserver 10.0.0.7就是成功了</span><br><span class="line">用curl命令行浏览器测试</span><br><span class="line">curl www.lv.dota</span><br><span class="line">for your love</span><br><span class="line">成功</span><br></pre></td></tr></table></figure>

<h3 id="4-实现反向解析"><a href="#4-实现反向解析" class="headerlink" title="4.实现反向解析"></a>4.实现反向解析</h3><p>1.修改/etc/named.conf配置，</p>
<ul>
<li>监听socket改成当前IP地址，这样才能让监听到其他主机的访问请求</li>
<li>把访问请求开关打开</li>
<li>上面两项都可以调成//注释，这样默认都开了</li>
</ul>
<p>2.修改/etc/named.rfc1912.zones，将反向解析的zone输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;0.0.10.in-addr.arpa.&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;10.0.0.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.去/var/named/下面写这个文件：10.0.0.zone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim 10.0.0.zone</span><br><span class="line">$TTL 1D</span><br><span class="line">@	SOA		IN		ns1		admin.lv.dota.(</span><br><span class="line">			0;#序列号</span><br><span class="line">			1D;#刷新时间间隔</span><br><span class="line">			1H;#重试时间间隔</span><br><span class="line">			1W；过期时长，expire</span><br><span class="line">			3H ) ；通知机制</span><br><span class="line">		NS 		ns1.lv.dota.</span><br><span class="line">199		PTR		www.lv.dota.</span><br><span class="line">99		PTR		fun.lv.dota.</span><br><span class="line">#* 序列号：主服务器的DNS数据库版本号</span><br><span class="line">#* 刷新时间间隔：从主服务器请求同步解析的时间间隔</span><br><span class="line">#* 重试时间间隔：从服务器请求同步失败时，再次尝试的时间间隔</span><br><span class="line">#* 过期时长：从服务器联系不上主服务器时，多久后停止服务</span><br><span class="line">#* 通知机制：主服务器解析库发生变化时，会主动通知从服务器</span><br></pre></td></tr></table></figure>

<p>4.去客户端测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$dig -x 10.0.0.100</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 &lt;&lt;&gt;&gt; -x 10.0.0.100</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 10215</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;100.0.0.10.in-addr.arpa.	IN	PTR</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">0.0.10.in-addr.arpa.	10800	IN	SOA	ns1.0.0.10.in-addr.arpa. admin.lv.dota. 0 86400 3600 604800 10800</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: 10.0.0.7#53(10.0.0.7)</span><br><span class="line">;; WHEN: Sun Sep 13 08:58:38 2020</span><br><span class="line">;; MSG SIZE  rcvd: 94</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$host 10.0.0.199</span><br><span class="line">199.0.0.10.in-addr.arpa domain name pointer www.lv.dota.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$nslookup 10.0.0.99</span><br><span class="line">Server:		10.0.0.7</span><br><span class="line">Address:	10.0.0.7#53</span><br><span class="line"></span><br><span class="line">99.0.0.10.in-addr.arpa	name &#x3D; fun.lv.dota.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-实现从服务器"><a href="#5-实现从服务器" class="headerlink" title="5.实现从服务器"></a>5.实现从服务器</h3><p>只有一台主DNS服务器存在单点失败问题，可以建立主DNS服务器的备份服务器，即从服务器，从而实现DNS的容错机制。从服务器可以自动和主服务器进行单向的数据同步，从而和主DNS服务器一样，也拥有区域解析数据库，也可以对外提供查询服务，但从服务器不提供数据更新服务。</p>
<p>从服务器的要求：</p>
<ul>
<li>一台独立的服务器</li>
<li>在主服务器的区域解析库文件中必须有一条NS记录指向从服务器</li>
<li>从服务器只需要定义区域，而不需要提供解析库文件，他从主服务器拿解析库文件，解析库文件应该放在/var/named/slaves/下</li>
<li>主服务器得允许从服务器作区域传送</li>
<li>主从服务器的时间应该同步</li>
<li>bind程序的版本应该保持一致，否则应该从服务器版本高，主服务器版本低</li>
</ul>
<p>主服务器的配置步骤：</p>
<p>1.配置/etc/named.conf，设置允许从服务器传输解析库文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;etc&#x2F;named.conf</span><br><span class="line">allow-transfer &#123; 10.0.0.153; &#125;;  &#123;&#125; 中填写从服务器的地址</span><br></pre></td></tr></table></figure>

<p>2.记住/etc/named.rfc1912.zones中设置的zone配置，待会拿到从服务器改改使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">43 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line">44     type master;</span><br><span class="line">45     file &quot;lv.dota.zone&quot;;</span><br><span class="line">46 &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.配置解析库文件/var/named/xxx.zone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;var&#x2F;named&#x2F;lv.dota.zone</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN SOA  master admin.lv.dota. (</span><br><span class="line">  3                     0   ; serial</span><br><span class="line">  4                     1D  ; refresh</span><br><span class="line">  5                     1H  ; retry</span><br><span class="line">  6                     1W  ; expire</span><br><span class="line">  7                     3H )    ; minimum</span><br><span class="line">  8     NS  master</span><br><span class="line">  9     NS  slave			#添加的从服务器</span><br><span class="line"> 10 master  A   10.0.0.7 </span><br><span class="line"> 11 slave   A   10.0.0.153   #添加的从服务器解析                                     </span><br><span class="line"> 12 www     A   10.0.0.3</span><br><span class="line">#添加上两条：</span><br><span class="line">		NS slave</span><br><span class="line">	slave	A	10.0.0.153</span><br></pre></td></tr></table></figure>

<p>4.重新加载配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#rndc reload</span><br><span class="line">server reload successful</span><br></pre></td></tr></table></figure>

<p>从服务器的配置步骤：</p>
<p>1.开启允许其他主机访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;etc&#x2F;named.conf</span><br><span class="line">&#x2F;&#x2F;  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">&#x2F;&#x2F;  allow-query     &#123; localhost; &#125;;</span><br><span class="line"> allow-transfer &#123; none; &#125;;  #这一步是设置不允许其他主机从这台从服务器上同步解析库文件</span><br></pre></td></tr></table></figure>

<p>2.配置/etc/named.rfc1912.zones</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">添加一个zone</span><br><span class="line"> 42 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line"> 43     type slave;</span><br><span class="line"> 44     masters &#123; 10.0.0.7; &#125;;</span><br><span class="line"> 45     file &quot;slaves&#x2F;lv.dota.slave&quot;;</span><br><span class="line"> 46 &#125;;</span><br><span class="line"> 这里的zone名称跟主服务器一样，下面的type改成slave，添加一行设置主服务器地址设置，解析库文件位置是用于放置一会从主服务器同步过来的解析库文件的</span><br></pre></td></tr></table></figure>

<p>3.启动服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#systemctl start named</span><br></pre></td></tr></table></figure>

<p>4.去客户端验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$dig www.lv.dota @10.0.0.153</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 &lt;&lt;&gt;&gt; www.lv.dota @10.0.0.153</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 56037</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 2</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.lv.dota.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.lv.dota.		86400	IN	A	10.0.0.3</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">lv.dota.		86400	IN	NS	master.lv.dota.</span><br><span class="line">lv.dota.		86400	IN	NS	slave.lv.dota.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">master.lv.dota.		86400	IN	A	10.0.0.7</span><br><span class="line">slave.lv.dota.		86400	IN	A	10.0.0.153</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: 10.0.0.153#53(10.0.0.153)</span><br><span class="line">;; WHEN: Sun Sep 13 10:15:28 2020</span><br><span class="line">;; MSG SIZE  rcvd: 118</span><br></pre></td></tr></table></figure>

<p>成功</p>
<h3 id="6-实现子域"><a href="#6-实现子域" class="headerlink" title="6.实现子域"></a>6.实现子域</h3><p>子域父域是两台masterDNS主机，父域里面写上子域的域名和地址，子域里面只写自己的区域解析，不用写父域地址。DNS有这个规律，上级知道下级和根域，下级知道自己的区域解析和根域。</p>
<p>父域设置：父DNS主机设置</p>
<p>1.关闭加密验证，允许服务器进行区域传输</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow-transfer &#123; 子域服务器IP;&#125;;</span><br><span class="line">dnssec-enable no;</span><br><span class="line">dnssec-validation no;</span><br></pre></td></tr></table></figure>

<p>2.配置zone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;etc&#x2F;named.rfc1912.zones</span><br><span class="line"> 43 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line"> 44     type master;</span><br><span class="line"> 45     file &quot;lv.dota.zone&quot;;</span><br><span class="line"> 46 &#125;;</span><br></pre></td></tr></table></figure>

<p>3.在/var/named/xxx.zone文件中加入子域的一些项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;var&#x2F;named&#x2F;lv.dota.zone</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN SOA  master admin.lv.dota. (</span><br><span class="line">  3                     1   ; serial</span><br><span class="line">  4                     1D  ; refresh</span><br><span class="line">  5                     1H  ; retry</span><br><span class="line">  6                     1W  ; expire</span><br><span class="line">  7                     3H )    ; minimum</span><br><span class="line">  8     NS  master</span><br><span class="line">  9 shanghai    NS  shanghains   #添加子域的NS</span><br><span class="line"> 10 master  A   10.0.0.7</span><br><span class="line"> 11 shanghains    A   10.0.0.153   #子域的IP地址</span><br><span class="line"> 12 fff     A   10.0.0.3</span><br><span class="line"> 13 www     CNAME   fff</span><br></pre></td></tr></table></figure>

<p>4.重新加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rndc reload</span><br></pre></td></tr></table></figure>

<p>子域设置：子DNS主机设置</p>
<p>1.禁止区域传输</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;named.conf</span><br><span class="line">allow-transfer &#123; none;&#125;;</span><br></pre></td></tr></table></figure>

<p>2.配置zone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;etc&#x2F;named.rfc1912.zones</span><br><span class="line">添加下面的内容，注意zone名称</span><br><span class="line"> 42 zone &quot;shanghai.lv.dota&quot; IN &#123;</span><br><span class="line"> 43     type master;</span><br><span class="line"> 44     file &quot;shanghai.lv.dota.zone&quot;;</span><br><span class="line"> 45 &#125;;</span><br></pre></td></tr></table></figure>

<p>3.创建zone文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost named]#vim &#x2F;var&#x2F;named&#x2F;shanghai.lv.dota.zone </span><br><span class="line">子域中不需要写父域信息</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN SOA  master admin.lv.dota. (</span><br><span class="line">  3                     0   ; serial</span><br><span class="line">  4                     1D  ; refresh</span><br><span class="line">  5                     1H  ; retry</span><br><span class="line">  6                     1W  ; expire</span><br><span class="line">  7                     3H )    ; minimum</span><br><span class="line">  8     NS  master</span><br><span class="line">  9 master  A   10.0.0.153</span><br><span class="line"> 10 fff     A   10.0.0.4</span><br><span class="line"> 11 www     CNAME   fff  </span><br></pre></td></tr></table></figure>

<p>真正起作用的是zone名称</p>
<p>4.测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host www.lv.dota</span><br><span class="line">host www.shanghai.lv.dota</span><br></pre></td></tr></table></figure>

<h3 id="7-实现转发"><a href="#7-实现转发" class="headerlink" title="7.实现转发"></a>7.实现转发</h3><p>转发：利用DNS转发，可以将用户的DNS请求，转发至指定的DNS服务，而非默认的根DNS服务器，并将指定服务器查询的返回结果进行缓存，提高效率</p>
<p>转发需要关闭dnssec功能</p>
<p>转发的方式：</p>
<ul>
<li>全局转发</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">		forward first|only;</span><br><span class="line">		forwarders &#123;ip;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>特定区域转发，仅转发对特定区域的请求，比全局转发优先级高</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;zone_name&quot; IN &#123;</span><br><span class="line">	type forward;</span><br><span class="line">	forward first|only;</span><br><span class="line">	forwarders &#123;ip;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>first:先转发至指定的DNS服务器，如果无法解析查询请求，则本服务器再去根服务器查询</p>
<p>only：先转发至指定DNS服务器，如果无法解析查询请求，则本服务器将不再去根服务器查询</p>
<p>主服务器配置：</p>
<p>主服务器正常配置一个DNS，其他不用配置</p>
<p>转发（缓存服务器）配置：</p>
<p>1.配置/etc/named.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;listen-on port 53 &#123;127.0.0.1;&#125;;</span><br><span class="line">&#x2F;&#x2F;allow-query &#123;localhost&#125;</span><br><span class="line">添加下面两行</span><br><span class="line">forward first;</span><br><span class="line">forwarders &#123; 10.0.0.7; &#125;; #主服务器的地址</span><br><span class="line">关闭dnssec功能</span><br><span class="line">dnssec-enable no;</span><br><span class="line">dnssec-validation no;</span><br></pre></td></tr></table></figure>

<p>2.重新加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rndc reload</span><br></pre></td></tr></table></figure>

<p>3.测试</p>
<h3 id="8-实现智能DNS"><a href="#8-实现智能DNS" class="headerlink" title="8.实现智能DNS"></a>8.实现智能DNS</h3><p>1.GSLB概念：Global Server Load Balance全局负载均衡</p>
<p>GSLB是对服务器和链路进行综合判断来决定由哪个地点的服务器来提供服务，实现异地服务器群服务质量的保证</p>
<p>GSLB主要的目的是在整个网络范围内将用户的请求定向到最近的节点，GSBL分为基于DNS实现、基于重定向实现、基于路由协议实现，其中最通用的是基于DNS解析方式。</p>
<p>举个例子，从郑州dig测试<a target="_blank" rel="noopener" href="http://www.jd.com和从北京dig测试www.jd.com,你会发现解析到的ip地址不一样,分别是郑州的ip和北京的ip./">www.jd.com和从北京dig测试www.jd.com，你会发现解析到的IP地址不一样，分别是郑州的IP和北京的IP。</a></p>
<p>2.CDN 内容分发网络 Content Delivery Network</p>
<p>公用DNS比如阿里的233.5.5.5，他们都有自己的技术，可以自动判断你的IP是哪个地区的，然后让你的IP地址请求域名解析的时候指向他们当地的DNS服务器，这样根据当地DNS服务器的位置就可以让GSLB知道你的地区，然后把当前地区的内容服务器地址发给你的DNS，你就能享受CDN带来的快速访问了。</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200914212757775.png" alt="image-20200914212757775"></p>
<p>工作原理：</p>
<p>1.用户访问<a target="_blank" rel="noopener" href="http://www.jd.com,发送域名解析请求到dns服务器,比如阿里的223.5.5.5,这时候有个情况,阿里或者国内其他的公用dns服务器有些技术,比如bgp/">www.jd.com，发送域名解析请求到DNS服务器，比如阿里的223.5.5.5，这时候有个情况，阿里或者国内其他的公用DNS服务器有些技术，比如bgp</a> anycast（多个服务器用了一个IP地址），可以让你访问距离你最近的DNS服务器，所以本来223.5.5.5服务器在浙江杭州，但是你访问的223.5.5.5就在郑州。</p>
<p>2.DNS服务器收到你的解析请求后，就去检查自己的解析库和缓存中有没有<a target="_blank" rel="noopener" href="http://www.jd.com的地址,如果有,就发给你;如果没有,就会从根域开始逐级查找,直到找到www.jd.com的解析地址.因为cdn技术,所以dns服务器找到的地址不是真的ip地址,而是一个cname,别名,指向了京东的gslb,全局负载均衡服务器,负载均衡服务器会根据dns的ip地址判断dns所在的地区,从而把距离该地区最近的内容分发服务器ip解析给dns/">www.jd.com的地址，如果有，就发给你；如果没有，就会从根域开始逐级查找，直到找到www.jd.com的解析地址。因为CDN技术，所以DNS服务器找到的地址不是真的IP地址，而是一个CNAME，别名，指向了京东的GSLB，全局负载均衡服务器，负载均衡服务器会根据DNS的IP地址判断DNS所在的地区，从而把距离该地区最近的内容分发服务器IP解析给DNS</a></p>
<p>3.DNS收到解析地址后把IP地址返还给用户</p>
<p>4.用户去访问这个IP地址，获取信息</p>
<p>5.如果这个IP地址对应的内容分发服务器上有用户需要的全部信息，那么就把全部信息发送给用户；如果内容分发服务器上没有足够的信息，那么它就会找临近的分发服务器查询是否有这个信息，如果有就从其他服务器上拿过来，如果没有，它就会找源服务器要，然后再发送给用户</p>
<p>6.上面的流程就是CDN的实现，通过DNS服务器，用户得以访问距离自己最近的内容分发服务器，可以用得到最快的信息加载速度，并且CDN还大大缓解了源服务器的访问带宽压力，缓解了运营商的带宽压力。</p>
<p>通过Linux实现智能DNS：</p>
<p>1.创建acl</p>
<p>acl的格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">11 acl beijingnet &#123;</span><br><span class="line">12     10.0.0.5;</span><br><span class="line">13 &#125;;</span><br><span class="line">14 acl shanghainet &#123;</span><br><span class="line">15     10.0.0.151;</span><br><span class="line">16 &#125;;</span><br><span class="line">17 acl shenzhennet &#123;</span><br><span class="line">18     any;</span><br><span class="line">19 &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.创建view</p>
<p>view的格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">63 view beijingview &#123;</span><br><span class="line">64     match-clients &#123; beijingnet ; &#125;;</span><br><span class="line">65     include &quot;&#x2F;etc&#x2F;named.rfc1912.zones.beijing&quot;;</span><br><span class="line">66 &#125;;</span><br><span class="line">67 view shanghaiview &#123;</span><br><span class="line">68     match-clients &#123; shanghainet ; &#125;;</span><br><span class="line">69     include &quot;&#x2F;etc&#x2F;named.rfc1912.zones.shanghai&quot;;</span><br><span class="line">70 &#125;;</span><br><span class="line">71 view shenzhenview &#123;</span><br><span class="line">72     match-clients &#123; shenzhennet ; &#125;;</span><br><span class="line">73     include &quot;&#x2F;etc&#x2F;named.rfc1912.zones.shenzhen&quot;;</span><br><span class="line">74 &#125;;</span><br><span class="line">75 include &quot;&#x2F;etc&#x2F;named.root.key&quot;;</span><br></pre></td></tr></table></figure>

<p>3.创建view规定的/etc/named.rfc1912.zones.xxx文件，里面写上zone</p>
<p>文件格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">第一个view的zone</span><br><span class="line"> 43 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line"> 44     type master;</span><br><span class="line"> 45     file &quot;beijing.lv.dota.zone&quot;;</span><br><span class="line"> 46 &#125;;</span><br><span class="line"> 47 zone &quot;.&quot; IN &#123;</span><br><span class="line"> 48     type hint;</span><br><span class="line"> 49     file &quot;named.ca&quot;;</span><br><span class="line"> 50 &#125;;   </span><br><span class="line">第二个view的zone</span><br><span class="line"> 43 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line"> 44     type master;</span><br><span class="line"> 45     file &quot;shanghai.lv.dota.zone&quot;;</span><br><span class="line"> 46 &#125;;</span><br><span class="line"> 47 zone &quot;.&quot; IN &#123;</span><br><span class="line"> 48     type hint;</span><br><span class="line"> 49     file &quot;named.ca&quot;;</span><br><span class="line"> 50 &#125;;</span><br><span class="line">第三个view的zone</span><br><span class="line"> 43 zone &quot;lv.dota&quot; IN &#123;</span><br><span class="line"> 44     type master;</span><br><span class="line"> 45     file &quot;shenzhen.lv.dota.zone&quot;;</span><br><span class="line"> 46 &#125;;</span><br><span class="line"> 47 zone &quot;.&quot; IN &#123;</span><br><span class="line"> 48     type hint;</span><br><span class="line"> 49     file &quot;named.ca&quot;;</span><br><span class="line"> 50 &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.创建zone文件规定的.zone解析库文件，放在/var/named/xxxx.zone</p>
<p>格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> 第一个.zone文件</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN  SOA     master  admin.lv.dota. (</span><br><span class="line">  3                       1  ;serial</span><br><span class="line">  4                       1D  ;refresh</span><br><span class="line">  5                       1H ;retry</span><br><span class="line">  6                       1W   ;expire</span><br><span class="line">  7                      3H  ) ; minimal</span><br><span class="line">  8         NS      master</span><br><span class="line">  9 master  A       10.0.0.7</span><br><span class="line"> 10 www     A       10.0.0.7 #不同的地方就是这里，www.lv.dota解析到了不同的IP地址</span><br><span class="line">第二个.zone文件</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN  SOA     master  admin.lv.dota. (</span><br><span class="line">  3                       1  ;serial</span><br><span class="line">  4                       1D  ;refresh</span><br><span class="line">  5                       1H ;retry</span><br><span class="line">  6                       1W   ;expire</span><br><span class="line">  7                      3H  ) ; minimal</span><br><span class="line">  8         NS      master</span><br><span class="line">  9 master  A       10.0.0.7</span><br><span class="line"> 10 www     A       10.0.0.3 #这里就是不同点</span><br><span class="line">第三个.zone文件</span><br><span class="line">  1 $TTL 1D</span><br><span class="line">  2 @   IN  SOA     master  admin.lv.dota. (</span><br><span class="line">  3                       1  ;serial</span><br><span class="line">  4                       1D  ;refresh</span><br><span class="line">  5                       1H ;retry</span><br><span class="line">  6                       1W   ;expire</span><br><span class="line">  7                      3H  ) ; minimal</span><br><span class="line">  8         NS      master</span><br><span class="line">  9 master  A       10.0.0.7</span><br><span class="line"> 10 www     A       10.0.0.4 #这里是不同点</span><br></pre></td></tr></table></figure>

<p>OK，分别从三个acl规定的区域中的IP解析<a target="_blank" rel="noopener" href="http://www.lv.dota,就会得到三个不同的ip地址了!/">www.lv.dota，就会得到三个不同的IP地址了！</a></p>
<h3 id="9-综合实验：DNS的使用"><a href="#9-综合实验：DNS的使用" class="headerlink" title="9.综合实验：DNS的使用"></a>9.综合实验：DNS的使用</h3><p>1.关于缓存（转发）服务器：</p>
<p>A是本地DNS服务器</p>
<p>B是转发服务器</p>
<p>A上面只配置开启转发，关闭安全加密选项</p>
<p>B上面配置一些域解析库，关闭安全加密选项</p>
<p>forward firest 是本地DNS首先会把客户端的解析请求转发到转发DNS服务器上，如果转发DNS服务器无法解析，那么本地DNS服务器会自己去找根服务器去迭代查询，直到有一个成功或失败的结果。</p>
<p>forward only 是本地DNS直接把客户端的解析请求转发到转发DNS服务器上，如果转发DNS服务器无法解析，那么本地DNS服务器也不管了，给客户端返回一个失败。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/LVS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/LVS/" class="post-title-link" itemprop="url">LVS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：21:59:43" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux-Virtual-Server"><a href="#Linux-Virtual-Server" class="headerlink" title="Linux Virtual Server"></a>Linux Virtual Server</h1><p>LVS：负载均衡服务器</p>
<p>Linux Virtual Server</p>
<p>尝试使用80/20方法进行LVS的学习，得分步骤做：80%的需要是在20%的内容中的</p>
<p>LVS的重要的20%是：</p>
<ul>
<li>LVS的工作原理</li>
<li>LVS-DR模型的实现方法</li>
<li>LVS-DR的实际操作</li>
</ul>
<h2 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h2><ul>
<li><strong>集群概念</strong></li>
<li><strong>LVS模型</strong></li>
<li><strong>LVS调度算法</strong></li>
<li><strong>LVS实现</strong></li>
<li><strong>Idirectord</strong></li>
</ul>
<h1 id="1-集群和分布式"><a href="#1-集群和分布式" class="headerlink" title="1.集群和分布式"></a>1.集群和分布式</h1><p>系统性能扩展方式：</p>
<ul>
<li>Scale Up：垂直扩展，向上扩展，增强单个服务器的性能</li>
<li>Scale Out：水平扩展，向外扩展，增加更多设备</li>
</ul>
<p>水平扩展更合适，性价比高，所以需要一个调度器</p>
<h2 id="1-1-集群-Cluster"><a href="#1-1-集群-Cluster" class="headerlink" title="1.1 集群 Cluster"></a>1.1 集群 Cluster</h2><p>Cluster分为三个类型</p>
<ul>
<li><p>LB：Load Balancing 负载均衡，多个主机组成，每个主机只承担一部分访问请求</p>
</li>
<li><p>HA：High Availiablity，高可用，避免单点失败问题</p>
<p>考核指标：MTBF：Mean Time Between failure 平均无故障时间，即正常时间</p>
<p>MTTR：Mean Time To Restoration  平均恢复前时间，即故障时间</p>
<p>故障时间 / 全部时间    的比值，99% 99.9% 99.99% 99.999%，按年来算</p>
<p>SLA：服务等级协议，就是看你能有几个9</p>
<p>计划外的停机时间是我们需要关注的</p>
</li>
<li><p>HPC：</p>
</li>
</ul>
<h2 id="1-2-分布式系统"><a href="#1-2-分布式系统" class="headerlink" title="1.2 分布式系统"></a>1.2 分布式系统</h2><p>分布式存储：Ceph，Gluster，FastDFS，MogileFS</p>
<p>分布式计算：Hadoop，Spark</p>
<p>1.3 集群和分布式的区别</p>
<p>1.4 集群设计原则</p>
<p>1.5 集群涉及实现</p>
<p>1.5.1 基础设施层面</p>
<p>1.5.2 业务层面</p>
<h2 id="1-6-LB-Cluster-负载均衡集群"><a href="#1-6-LB-Cluster-负载均衡集群" class="headerlink" title="1.6 LB Cluster 负载均衡集群"></a>1.6 LB Cluster 负载均衡集群</h2><p>1.6.1 实现方式</p>
<ul>
<li>硬件实现</li>
<li>软件</li>
</ul>
<h1 id="2-LVS"><a href="#2-LVS" class="headerlink" title="2.LVS"></a>2.LVS</h1><p>LVS工作原理：LVS是内核级功能，工作在INPUT链的位置，将发往INPUT链的数据报文根据目标IP和目标端口及协议将其调度转发到真实的业务服务器上，转发的依据是多种调度算法</p>
<p>查看内核对LVS的支持：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ grep -i -C 10 ipvs /boot/config-3.10.0-1127.el7.x86_64</span><br><span class="line"><span class="comment"># IPVS transport protocol load balancing support    #支持的协议</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_PROTO_TCP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_UDP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH=y</span><br><span class="line">CONFIG_IP_VS_PROTO_SCTP=y</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS scheduler    #调度算法</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_RR=m</span><br><span class="line">CONFIG_IP_VS_WRR=m</span><br><span class="line">CONFIG_IP_VS_LC=m</span><br><span class="line">CONFIG_IP_VS_WLC=m</span><br><span class="line">CONFIG_IP_VS_LBLC=m</span><br><span class="line">CONFIG_IP_VS_LBLCR=m</span><br><span class="line">CONFIG_IP_VS_DH=m</span><br><span class="line">CONFIG_IP_VS_SH=m</span><br><span class="line">CONFIG_IP_VS_SED=m</span><br><span class="line">CONFIG_IP_VS_NQ=m</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS SH scheduler</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_SH_TAB_BITS=8</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS application helper</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_FTP=m</span><br><span class="line">CONFIG_IP_VS_NFCT=y</span><br><span class="line">CONFIG_IP_VS_PE_SIP=m</span><br></pre></td></tr></table></figure>



<h2 id="LVS集群中的术语"><a href="#LVS集群中的术语" class="headerlink" title="LVS集群中的术语"></a>LVS集群中的术语</h2><p>VS：Virtual Server，Load Balancer</p>
<p>RS：Real Server(LSV)，upstream server(nginx)，backend server(haproxy)</p>
<p>CIP：Client Server</p>
<p>VIP：Virtual server IP，面对用户的IP</p>
<p>DIP：Director IP，面对业务服务器的IP</p>
<p>RIP：Real Server IP</p>
<p>访问流程：CIP–&gt;VIP–&gt;DIP–&gt;RIP</p>
<h2 id="LVS工作模式和相关命令"><a href="#LVS工作模式和相关命令" class="headerlink" title="LVS工作模式和相关命令"></a>LVS工作模式和相关命令</h2><p>TCP/IP在各个层数据单位是什么？</p>
<p>应用层：报文</p>
<p>传输层：报文段</p>
<p>网络层：数据包</p>
<p>链路层：帧</p>
<h3 id="1-LVS集群的工作模式"><a href="#1-LVS集群的工作模式" class="headerlink" title="1 LVS集群的工作模式"></a>1 LVS集群的工作模式</h3><ul>
<li>lvs-nat：本质是多目标IP的DNAT；重点：对报文的修改！</li>
<li>lvs-dr：Direct Routing 直接路由，基于数据链路层的MAC地址进行修改</li>
<li>lvs-tun：tunnel，隧道，在原请求的IP报文之外新添加一个IP首部</li>
<li>lvs-fullnat：修改请求报文的源和目标IP</li>
</ul>
<h4 id="LVS-NAT"><a href="#LVS-NAT" class="headerlink" title="LVS-NAT"></a>LVS-NAT</h4><p>本质：是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为根据调度算法选择出的一个RS的RIP和Port实现转发；同时把从RS回来的响应报文的目标地址和目标端口修改为客户端的IP和端口</p>
<p>特征：</p>
<blockquote>
<p>1.RIP和DIP应该在同一个IP网络，且应该使用私网地址；RS的网关要指向DIP</p>
<p>2.请求报文和响应报文都必须经由Director转发，因此Director容易成为系统瓶颈</p>
<p>3.支持端口映射，可以修改请求报文的目标Port</p>
<p>4.因为使用的技术是Linux的内核技术LVS，因此Director必须是Linux操作系统，RS可以是任意系统</p>
<p>5.Director需要开启FORWORD选项，net.ipv4.ip_forward</p>
</blockquote>
<p>画报文图，应该画两个，去方向一个图，回方向一个图</p>
<p>请求报文流程图：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105223908434.png" alt="image-20201105223908434"></p>
<p>响应报文流程图：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105224836162.png" alt="image-20201105224836162"></p>
<h4 id="LVS-DR：最主流的使用模型、默认的模型"><a href="#LVS-DR：最主流的使用模型、默认的模型" class="headerlink" title="LVS-DR：最主流的使用模型、默认的模型"></a>LVS-DR：最主流的使用模型、默认的模型</h4><p>Direct Routing</p>
<p>工作方式：通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是根据调试算法挑选出的RS的RIP所在接口的MAC地址，需要注意的是，源IP/PORT以及目标IP/PORT是在整个请求过程中是不被改变的；当RS发送响应报文时，根本不经过Director，而是自己把这个响应报文发送给路由器，由路由器把响应报文发给客户端</p>
<p>特点：</p>
<blockquote>
<p>1.DR模型可以降低LVS的负载压力，因为回复报文不需要经过LVS了</p>
<p>2.需要确保前端的路由器将目标IP为VIP的请求报文真的发送给Director而不是具有相同VIP的RS，方法大体上有三种：</p>
<p>​    1）在前端的路由器上做静态的IP和MAC地址的绑定，把VIP绑定到Director的MAC地址</p>
<p>​    2）在RS上使用arptables工具</p>
<p>​    3）在RS上修改内核参数，本质上是对绑定了VIP的网卡的arp协议的广播和接收进行了关闭</p>
<p>​    修改的参数是：/proc/sys/net/ipv4/conf/all/arp_ignore</p>
<p>​                 /proc/sys/net/ipv4/conf/all/arp_announce</p>
<p>​    上面的参数是对一个主机的arp的总开关，对于我们需要真正要修改的、VIP的网卡还需要开小开关</p>
<p>​                 /proc/sys/net/ipv4/conf/lo/arp_ignore</p>
<p>​                 /prof/sys/net/ipv4/conf/lo/arp_announce</p>
<p>3.RS的RIP可以使用私网地址，也可以是公网地址，只要RIP和DIP在同一个网络就行；RIP的网关不能指向DIP，以确保响应报文不会经由Director</p>
<p>4.RS和Director要在同一个物理网络</p>
<p>5.请求报文要经由Director，但响应报文不经由Director，而是由RS之间发送给路由器，路由器再发送给客户端</p>
<p>6.因为是对数据链路层的MAC地址的改变，因此不支持端口映射</p>
<p>7.Director不需要开启路由转发，因为数据不经过他的FORWARD链</p>
<p>8.因为使用的技术是Linux的内核技术LVS，因此Director必须是Linux操作系统，RS可以是大多数系统</p>
</blockquote>
<p>LVS-DR模型中的重点问题：</p>
<blockquote>
<p>如何解决IP地址冲突问题？—&gt;地址冲突是因为arp的广播和接收，导致每个主机都会通知其他主机自己的IP和MAC的对应关系，而通过修改内核参数，关闭RS的arp广播和接收选项，而Director正常广播自己的VIP和MAC的对应关系，这样就不冲突了</p>
<p>支持端口映射吗？—&gt;LVS-DR模型只修改数据链路层，因此不支持端口映射；</p>
<p>为什么Director和RS之间必须在交换机环境，不可以有路由器？—&gt;因为LVS-DR模型是Director通过对请求报文中MAC地址的修改进行转发和调度的，而在转发的过程中是把目标MAC从Director改成了RS的MAC，因此Director和RS需要知道彼此的MAC地址，而MAC地址又是通过arp协议来获取的，而arp协议是通过广播来实现的，而广播又不能穿过路由器，因此，Director和RS要在同一个路由器下，所以他们中间不能是路由器</p>
<p>重点：对ARP的理解；免费ARP是？，自问自答，判断IP地址冲突；</p>
<p>根据ARP协议的工作流程，修改ARP协议中的发送和接收选项；修改的是内核参数</p>
<p>配置在回环网卡上，lo，网络地址稳定，不影响其他网卡</p>
</blockquote>
<h4 id="LVS-DR模型的数据流程图："><a href="#LVS-DR模型的数据流程图：" class="headerlink" title="LVS-DR模型的数据流程图："></a>LVS-DR模型的数据流程图：</h4><blockquote>
<p><strong>注意：Web服务器网关要指向防火墙（路由器），因为响应报文不需要经过LVS，而是Web服务器自己发往客户端</strong></p>
</blockquote>
<blockquote>
<p><strong>注意：图中的防火墙提供了DNAT功能，把目标地址为172.30.0.200的请求都转发到了10.0.0.200上</strong></p>
</blockquote>
<blockquote>
<p>注意：图中我认为客户端不应该之间知道内网LVS的地址，因此使用了防火墙的DNAT，对于LVS来说，目标IP是没变过的，一致是VIP</p>
</blockquote>
<blockquote>
<p>注意：因为LVS-DR要让LVS和多台Web服务器使用一个相同的VIP，所以涉及地址冲突问题，但是可以通过修改所有Web服务器上的内核arp参数来解决这一问题，这样可以实现在这个局域网中，所有主机都认为拥有VIP地址的主机是LVS，因此防火墙会把报文先发送给LVS</p>
</blockquote>
<blockquote>
<p>注意：因为VIP是绑定在回环网卡lo上的，而lo网卡没有MAC地址，因此其实是使用了每个主机的其他网卡进行信息传输的，所以在报文中的MAC地址都是本机的其他网卡的</p>
</blockquote>
<p>图中IP地址和MAC的对应关系</p>
<table>
<thead>
<tr>
<th align="center">网卡IP</th>
<th align="center">MAC地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center">172.30.0.100</td>
<td align="center">5a</td>
</tr>
<tr>
<td align="center">172.30.0.200</td>
<td align="center">5b</td>
</tr>
<tr>
<td align="center">10.0.0.100</td>
<td align="center">5c</td>
</tr>
<tr>
<td align="center">10.0.0.200</td>
<td align="center">5d</td>
</tr>
<tr>
<td align="center">10.0.0.130</td>
<td align="center">5e</td>
</tr>
<tr>
<td align="center">10.0.0.140</td>
<td align="center">5f</td>
</tr>
</tbody></table>
<p>请求报文的数据流：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105231944974.png" alt="image-20201105231944974"></p>
<p>响应报文的数据流：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201106082943359.png" alt="image-20201106082943359"></p>
<h4 id="LVS-TUN：为了跨网段通信"><a href="#LVS-TUN：为了跨网段通信" class="headerlink" title="LVS-TUN：为了跨网段通信"></a>LVS-TUN：为了跨网段通信</h4><p>Tunnel</p>
<p>转发方式：Director不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而是在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP）后，将报文发往由调度算法选出的目标RS；RS在发送响应报文时，将直接把报文发送给路由器，路由器再把报文发送回客户端，因此tun模式的响应报文也不经过Director</p>
<p>特点：</p>
<blockquote>
<p>1.RIP和DIP可以不处于同一个物理网络中，RS的网关一般不能指向DIP，而是指向路由器。因此RS和Director是可以跨互联网的，DIP，RIP，VIP都可以是公网IP</p>
<p>2.RS的tun接口上需要配置VIP地址，以便于接收Director转发过来的数据包，以及作为响应的报文源IP</p>
<p>3.Director转发给RS时需要借助隧道，隧道外层的IP头部的源IP是DIP，目标IP是RIP，而RS响应给客户端的IP头是根据隧道内层的IP头分析得到的，源IP是VIP，目标IP是CIP</p>
<p>4.请求报文要经由Director，但响应不经由Director，响应由RS自己完成</p>
<p>5.不支持端口映射</p>
<p>6.RS的操作系统必须支持隧道功能</p>
<p>7.使用的很少，因为在广域网模式下使用代理服务比如nginx和DNS更多</p>
</blockquote>
<h4 id="LVS-FULLNAT模式："><a href="#LVS-FULLNAT模式：" class="headerlink" title="LVS-FULLNAT模式："></a>LVS-FULLNAT模式：</h4><p>转发原理：通过同时修改请求报文的源IP地址和目标IP地址进行转发</p>
<p>特点：</p>
<blockquote>
<p>1.请求和响应报文都经由Director</p>
<p>2.支持端口映射</p>
<p>3.VIP是公网地址，RIP和DIP是私网地址，且通常不在同一个IP网络中，因此RIP的网关不指向DIP</p>
<p>4.相对NAT模式，可以更好地实现RS间跨VLAN通讯</p>
<p>5.这个模式Kernel默认不支持</p>
</blockquote>
<h4 id="LVS工作模式总结和比较"><a href="#LVS工作模式总结和比较" class="headerlink" title="LVS工作模式总结和比较"></a>LVS工作模式总结和比较</h4><table>
<thead>
<tr>
<th>对比种类</th>
<th>NAT</th>
<th>TUN</th>
<th>DR</th>
</tr>
</thead>
<tbody><tr>
<td>RS的操作系统要求</td>
<td>任意操作系统</td>
<td>支持隧道</td>
<td>支持禁止arp广播和接收的系统</td>
</tr>
<tr>
<td>RS所处的网络类型</td>
<td>私网</td>
<td>公网/私网</td>
<td>私网，而且必须与调度器在同一个路由器中</td>
</tr>
<tr>
<td>支持的RS数量</td>
<td>10~20</td>
<td>100+</td>
<td>100+</td>
</tr>
<tr>
<td>RS的网关配置</td>
<td>需要指向调度器</td>
<td>指向自身的路由器</td>
<td>指向自身的路由器</td>
</tr>
<tr>
<td>优点</td>
<td>可以进行端口转换</td>
<td>可以跨WAN</td>
<td>性能最好</td>
</tr>
<tr>
<td>缺点</td>
<td>性能差</td>
<td>系统需要支持隧道</td>
<td>不可以跨网段</td>
</tr>
</tbody></table>
<h3 id="2-LVS调试算法"><a href="#2-LVS调试算法" class="headerlink" title="2 LVS调试算法"></a>2 LVS调试算法</h3><p>Ipvs scheduler：根据其调度时是否考虑各RS当前的负载状态</p>
<p>根据其调度时是否考虑RS当前负载状态分为静态和动态算法</p>
<h4 id="1-静态算法"><a href="#1-静态算法" class="headerlink" title="1 静态算法"></a>1 静态算法</h4><ul>
<li>RR：roundrobin，轮询，使用较多</li>
<li>WRR：Weighted RR，加权轮询，使用较多</li>
<li>SH：Source Hashing，源地址哈希，实现session sticky，会话绑定</li>
<li>DH：Destination Hashing，目标地址哈希,典型使用场景是正向代理缓存场景中的负载均衡，比如Web缓存</li>
</ul>
<h4 id="2-动态算法"><a href="#2-动态算法" class="headerlink" title="2 动态算法"></a>2 动态算法</h4><p>根据后端RS的负载状态进行调度</p>
<p>活动连接：建立连接并且有数据交互</p>
<ul>
<li>LC：least connections 最短连接算法，适用于长连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;activeConnections*256+inactiveConnections</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>WLC：WeightedLC，带权重的最短连接算法，默认调度方法，较常用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;(activeConnections*256+inactiveConnections)&#x2F;weight</span><br></pre></td></tr></table></figure>

<ul>
<li>SED：Shortest Expection Delay，初始连接高权重优先，只检查活动连接，而不考虑非活动连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;(activeConnections+1)*256&#x2F;weight</span><br></pre></td></tr></table></figure>

<ul>
<li>NQ：Never Queue，第一轮均匀分配，后续使用SED</li>
<li>LBLC：Locallity-Based LC，动态的DH算法</li>
<li>LBLCR：LBLC with Replication，带复制功能的LBLC，解决LBLC负载不均衡的问题</li>
<li>内核版本4.15之后新增调度算法：FO和OVF</li>
</ul>
<h1 id="3-LVS相关软件"><a href="#3-LVS相关软件" class="headerlink" title="3 LVS相关软件"></a>3 LVS相关软件</h1><h2 id="1-ipvsadm"><a href="#1-ipvsadm" class="headerlink" title="1 ipvsadm"></a>1 ipvsadm</h2><p>程序包：ipvsadm</p>
<p>主程序：/usr/sbin/ipvsadm</p>
<p>规则保存程序：/usr/sbin/ipvsadm-save</p>
<p>规则加载工具：/usr/sbin/ipvsadm-restore</p>
<p>配置文件：/etc/sysconfig/ipvsadm-config</p>
<p>调度规则文件：/etc/sysconfig/ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br><span class="line">[root@node_7 ~]$rpm -ql ipvsadm</span><br><span class="line">&#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm-config</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ipvsadm.service</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm-restore</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm-save</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;ipvsadm-1.27</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;ipvsadm-1.27&#x2F;README</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm-restore.8.gz</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm-save.8.gz</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm.8.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2-ipvsadm-使用"><a href="#2-ipvsadm-使用" class="headerlink" title="2 ipvsadm 使用"></a>2 ipvsadm 使用</h2><p>ipvsadm与iptables很像，他们的服务开启都是加载规则，所以不需要开服务，只需要写规则，他们都是对内核功能的调用</p>
<p>核心功能：</p>
<ul>
<li>集群的管理：增加、删除、修改</li>
<li>集群中业务服务器的管理：增加、删除、修改</li>
<li>查看：<code>ipvsadm -Ln</code></li>
</ul>
<h4 id="创建一个完整的集群的步骤："><a href="#创建一个完整的集群的步骤：" class="headerlink" title="创建一个完整的集群的步骤："></a>创建一个完整的集群的步骤：</h4><p>分两步：</p>
<p>第一步：创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t VIP:port -s 调度算法</span><br><span class="line">-A：--add-service add virtual service with options 表示添加虚拟服务器</span><br><span class="line">-t：--tcp-service service-address is host[:port]  添加tcp协议的服务器IP和端口</span><br><span class="line">-s：scheduler one of rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq,the default scheduler 	is wlc.</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t 172.30.0.200:80 -s rr</span><br></pre></td></tr></table></figure>

<p>第二步：添加集群中的服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t VIP:port -r RS的IP:RS的端口 -工作模式</span><br><span class="line">-a：--add-server add real server with options 表示添加真实的业务服务器</span><br><span class="line">-t：添加tcp协议的服务器的IP和端口</span><br><span class="line">工作模式：</span><br><span class="line">-m：masquerading (NAT) NAT模式</span><br><span class="line">-g：gatewaying (direct routing) (default) DR模式</span><br><span class="line">-i：ipip encapsulation (tunneling) TUN模式</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.7:80 -m</span><br><span class="line">ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.14:80 -m</span><br></pre></td></tr></table></figure>

<h4 id="集群的管理操作："><a href="#集群的管理操作：" class="headerlink" title="集群的管理操作："></a>集群的管理操作：</h4><p>增加、修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br><span class="line">-A：增加虚拟服务</span><br><span class="line">-E：修改虚拟服务</span><br><span class="line">-t：使用tcp协议  -u：使用udp  -f：firewall Mark，防火墙标记，是一个数字</span><br><span class="line">-s：使用的调度算法</span><br><span class="line">-p：持久连接的保存时间，-p 后面不跟时间就是代表360秒</span><br></pre></td></tr></table></figure>

<p>删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -D -t|u|f service-address</span><br></pre></td></tr></table></figure>

<h4 id="集群中的RS的增、删、改："><a href="#集群中的RS的增、删、改：" class="headerlink" title="集群中的RS的增、删、改："></a>集群中的RS的增、删、改：</h4><p>增、改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]</span><br><span class="line">-a：增加RS服务器</span><br><span class="line">-e：修改RS服务器</span><br><span class="line">-t|u|f：tcp,udp,firewall mark</span><br><span class="line">-r：real server 的IP和Port</span><br><span class="line">-g：DR模式，默认模式</span><br><span class="line">-i：TUN模式</span><br><span class="line">-m：NAT模式</span><br><span class="line">-w：权重</span><br></pre></td></tr></table></figure>

<p>删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -d -t|u|f service-address -r server-address</span><br></pre></td></tr></table></figure>

<h4 id="清空集群命令："><a href="#清空集群命令：" class="headerlink" title="清空集群命令："></a>清空集群命令：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<h4 id="清空计数器："><a href="#清空计数器：" class="headerlink" title="清空计数器："></a>清空计数器：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -Z [-t|u|f service-address]</span><br></pre></td></tr></table></figure>

<h4 id="保存规则：建议保存到-etc-sysconfig-ipvsadm"><a href="#保存规则：建议保存到-etc-sysconfig-ipvsadm" class="headerlink" title="保存规则：建议保存到/etc/sysconfig/ipvsadm"></a>保存规则：建议保存到/etc/sysconfig/ipvsadm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-save &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">或者</span><br><span class="line">ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">或者</span><br><span class="line">systemctl stop ipvsadm.service <span class="comment">#这个service文件中调用的命令有保存</span></span><br></pre></td></tr></table></figure>

<h4 id="载入规则：会自动加载-etc-sysconfig-ipvsadm"><a href="#载入规则：会自动加载-etc-sysconfig-ipvsadm" class="headerlink" title="载入规则：会自动加载/etc/sysconfig/ipvsadm"></a>载入规则：会自动加载/etc/sysconfig/ipvsadm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-restore &lt; /path/from/ipvsadm_file</span><br><span class="line">或者</span><br><span class="line">systemctl start ipvsadm.service <span class="comment">#会自动加载/etc/sysconfig/ipvsadm</span></span><br></pre></td></tr></table></figure>

<h4 id="防火墙标记"><a href="#防火墙标记" class="headerlink" title="防火墙标记"></a>防火墙标记</h4><p>FWM：FireWall Mark</p>
<p>Mark target 可用于给特定的报文打标记，–set-mark value，其中value可以是十六进制数字</p>
<p>工作原理：借助于防火墙标记来分类报文，而后基于标记定义集群服务，可以将多个不同的应用使用同一个集群服务进行调度</p>
<p>实现方法：</p>
<p>在Director主机打标记：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -d $&#123;VIP&#125; -p $&#123;protocol&#125; -m multiport --dport $&#123;port1&#125;,$&#123;port2&#125;,... -j MARK --set-mark NUMBER</span><br></pre></td></tr></table></figure>

<p>之后在ipvsadm中可以直接利用这个标记来标记集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -f NUMBER [options]</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<h4 id="LVS持久连接"><a href="#LVS持久连接" class="headerlink" title="LVS持久连接"></a>LVS持久连接</h4><p>session绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现</p>
<p>持久连接（lvs persistence）模板：实现无论使用任何调度算法，在一段时间内（默认360s），能够实现将来自同一个地址的请求始终发往同一个RS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br><span class="line">使用-p选项就代表了持久连接，默认是360秒</span><br></pre></td></tr></table></figure>

<p>持久连接的实现方法：</p>
<ul>
<li>按照端口，PPC，每端口持久，每个端口定义为一个集群服务，每个集群服务单独调度</li>
<li>按照防火墙标记，PFWMC，每防火墙标记持久，基于防火墙标记定义集群服务，可以实现将多个端口上的应用同意调度，即port Affinity</li>
</ul>
<p>例子：</p>
<h2 id="3-LVS的操作实例"><a href="#3-LVS的操作实例" class="headerlink" title="3 LVS的操作实例"></a>3 LVS的操作实例</h2><h3 id="1-NAT模式的操作"><a href="#1-NAT模式的操作" class="headerlink" title="1 NAT模式的操作"></a>1 NAT模式的操作</h3><p>环境说明：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105153045726.png" alt="image-20201105153045726"></p>
<p>操作步骤</p>
<h4 id="第一步：环境配置"><a href="#第一步：环境配置" class="headerlink" title="第一步：环境配置"></a>第一步：环境配置</h4><p>1.准备两个网段，</p>
<p>2.配置IP地址</p>
<p>3.这个图里画了防火墙，但是其实防火墙和LVS是一台主机</p>
<p>配置192段主机的网关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先把原来的指向0.0.0.0的默认路由删掉</span><br><span class="line">ip route del default dev eth0 </span><br><span class="line">然后把默认路由指向防火墙一侧</span><br><span class="line">ip route add default dev eth0 via 172.30.0.200</span><br></pre></td></tr></table></figure>

<p>配置10段主机的网关，这个网关是指向Director的，因为响应报文要先发给Director进行处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先把原来的指向0.0.0.0的默认路由删掉</span><br><span class="line">ip route del default dev eth0 </span><br><span class="line">然后把默认路由指向防火墙一侧</span><br><span class="line">ip route add default dev eth0 via 10.0.0.100</span><br></pre></td></tr></table></figure>

<p>4.注意一点，防火墙两边的主机的网关都要指向防火墙，而且防火墙上不要配置Iptables规则，尤其是nat表的规则，因为LVS的ipvsadm是作用在INPUT表的</p>
<p>5.防火墙要开启路由转发功能 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;net.ipv4.ip_forward &#x3D; 1&quot; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p;让sysctl.conf的内容生效</span><br></pre></td></tr></table></figure>



<h4 id="第二步：LVS的操作"><a href="#第二步：LVS的操作" class="headerlink" title="第二步：LVS的操作"></a>第二步：LVS的操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$yum install ipvsadm</span><br><span class="line">[root@node_7 ~]$ipvsadm -A -t 172.30.0.200:80 -s rr</span><br><span class="line">[root@node_7 ~]$ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.30.0.200:80 rr</span><br><span class="line">[root@node_7 ~]$ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.7:80 -m</span><br><span class="line">[root@node_7 ~]$ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.14:80 -m</span><br><span class="line">[root@node_7 ~]$ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.30.0.200:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Masq    1      0          0         </span><br><span class="line">  -&gt; 10.0.0.14:80                 Masq    1      0          0 </span><br></pre></td></tr></table></figure>

<h4 id="第三步：在外网进行访问"><a href="#第三步：在外网进行访问" class="headerlink" title="第三步：在外网进行访问"></a>第三步：在外网进行访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends! this is 7</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends! this is 7</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试成功！</p>
<p>保存规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm</span><br></pre></td></tr></table></figure>

<p>清除规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<p>重新导入规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm</span><br></pre></td></tr></table></figure>

<p>设置开机自动导入规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ipvsadm.service</span><br><span class="line">前提是保存的规则文件确实是&#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm才行，为什么，因为ipvsadm.service文件里面是：</span><br><span class="line">  7 ExecStart&#x3D;&#x2F;bin&#x2F;bash -c &quot;exec &#x2F;sbin&#x2F;ipvsadm-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm&quot;</span><br><span class="line">  8 ExecStop&#x3D;&#x2F;bin&#x2F;bash -c &quot;exec &#x2F;sbin&#x2F;ipvsadm-save -n &gt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm&quot;</span><br><span class="line">  9 ExecStop&#x3D;&#x2F;sbin&#x2F;ipvsadm -C</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-DR模式的操作"><a href="#2-DR模式的操作" class="headerlink" title="2.DR模式的操作"></a>2.DR模式的操作</h3><h4 id="杂谈："><a href="#杂谈：" class="headerlink" title="杂谈："></a>杂谈：</h4><p>单网段和多网段</p>
<p>LVS也需要配置一个路由</p>
<p>网络环境的配置尽量按照一个方向配置</p>
<p>修改内核参数需要修改ALL和lo网卡</p>
<p>如何永久添加一个网卡上的两个IP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eth0 +ipv4.address 172.16.0.200&#x2F;24 ifname eth0</span><br><span class="line">其实就是在ifcfg-eth0的配置文件中添加了ipaddr1&#x3D;172.16.0.200 prefix1&#x3D;24 这样的行</span><br></pre></td></tr></table></figure>

<h4 id="LVS-DR单网段"><a href="#LVS-DR单网段" class="headerlink" title="LVS-DR单网段"></a>LVS-DR单网段</h4><p>DR模型中LVS和各个RS主机上都需要配置VIP，但是他们不是同一台主机，因此会出现一个VIP地址有三个MAC地址的问题，也就是地址冲突问题，所以要解决这个问题，解决这个问题的方法大概有三种：</p>
<p>1）在前端的路由器上做VIP地址和LVS服务器MAC的绑定</p>
<p>2）在各个RS上使用arptables工具</p>
<p>3）在各个RS上修改内核参数（arp的广播和接收），来限制arp响应和通告的级别</p>
<p>方法一存在问题，那就是每当更换LVS服务器时，都需要修改路由器上的绑定关系，因此不推荐使用</p>
<p>方法二的配置还需要学习，因此暂时不用，arptables的思路与iptables思路一样，只不过协议变了</p>
<p>方法三好配置，因此推荐使用</p>
<p>需要修改的内核参数：arp_ignore,arp_announce</p>
<p><strong>注意：这两个参数都是有一个总的配置和每个网卡上的配置，因此修改的时候需要修改总的配置和需要配置VIP的网卡的配置</strong></p>
<blockquote>
<p> arp_ignore：限制响应级别</p>
<ul>
<li>0：默认值，表示可以使用本地任意接口上配置的任意地址进行响应</li>
<li>1：仅在请求的目标IP配置在本地主机的接收请求报文的接口上时，才给予响应</li>
</ul>
</blockquote>
<blockquote>
<p>arp_announce：限制通告级别</p>
<ul>
<li>0：默认值，把本机所有接口的所有信息向每个接口的网络进行通告</li>
<li>1：尽量避免将接口信息向非直接连接的网络进行通告</li>
<li>2：必须避免将接口信息向非本网络进行通告</li>
</ul>
</blockquote>
<p>范例1：</p>
<p>环境：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105161821292.png" alt="image-20201105161821292"></p>
<p>环境准备：5台主机，两个网段，注意网关的配置，每个主机的网关都要指向路由器，路由器要开启路由转发</p>
<p><strong>注意：LVS服务器和两台RS服务器上，都要配置VIP，VIP都配置到lo网卡上</strong></p>
<p>配置网络环境中最主要的命令：</p>
<p>修改路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip route del default dev eth0</span><br><span class="line">ip route add default dev etho via 10.0.0.100</span><br></pre></td></tr></table></figure>

<p>查看路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">route -n</span><br><span class="line">或者</span><br><span class="line">ip route</span><br></pre></td></tr></table></figure>

<p>添加IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address add 10.0.0.200&#x2F;32 dev lo</span><br></pre></td></tr></table></figure>



<p>步骤：</p>
<p>1.两台RS的配置，即arp参数的修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_ignore </span><br><span class="line">➜  ~ echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_announce </span><br><span class="line">➜  ~ echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;lo&#x2F;arp_ignore </span><br><span class="line">➜  ~ echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;lo&#x2F;arp_announce</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.LVS服务器的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ipvsadm -A -t 10.0.0.200:80 -s wrr</span><br><span class="line">➜  ~ ipvsadm -a -t 10.0.0.200:80 -r 10.0.0.7:80 -g </span><br><span class="line">➜  ~ ipvsadm -a -t 10.0.0.200:80 -r 10.0.0.14:80 -g</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.172网段的主机进行访问测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 7</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 7</span><br></pre></td></tr></table></figure>

<p>测试成功</p>
<p>想要对LVS-DR模式的修改MAC地址进行了解，那么就抓包查看</p>
<p>首先开启抓包软件，然后监听NAT网卡，也就是VMNET8，然后在172.30.0.100上curl；</p>
<p>注意：因为抓的是VMNET8网段，所以看不到172主机与路由器之间的通讯，下面我们看到的通讯已经经过了路由器的转发了，也就是说，172.30.0.100这个IP所带的MAC其实已经是路由器的MAC了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.0.0.200</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105174819989.png" alt="image-20201105174819989"></p>
<p>下面对这个报文进行分析</p>
<blockquote>
<p>1.请求报文： SRC 172.30.0.100 SRC-MAC 8a DEST 10.0.0.200 DEST-MAC 0d<br>2.请求报文： SRC 172.30.0.100 SRC-MAC 0d DEST 10.0.0.200 DEST-MAC a5<br>3.响应报文： SRC 10.0.0.200 SRC-MAC a5 DEST 172.30.0.100 DEST-MAC 8a</p>
</blockquote>
<p>通过对报文的分析，可以看到：</p>
<p>首先，172主机向10.0.0.200的IP地址发起请求，这个时候的10.0.0.200的MAC是LVS主机</p>
<p>然后，LVS主机根据调度算法，向一个MAC地址是a5（IP是10.0.0.14）的主机转发了这个报文，可以注意到，此时的源IP地址和源MAC并没有改变，目标IP也没有改变，但是目标MAC改变了</p>
<p>最后，10.0.0.14主机向172.30.0.100主机发出响应报文，此时可以看到，源IP地址是10.0.0.200，源MAC是10.0.0.14的MAC，目标IP是172.30.0.100，目标MAC是路由器的MAC</p>
<h4 id="LVS-DR模式多网段"><a href="#LVS-DR模式多网段" class="headerlink" title="LVS-DR模式多网段"></a>LVS-DR模式多网段</h4><p>环境搭建</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105191226209.png" alt="image-20201105191226209"></p>
<p>这个实验与上一个实验的区别就是对VIP是一个与RS服务器不在同一个网段的IP，因此在路由器上需要增加一个192.168.0.0/24的地址；还有一个区别，那就是LVS服务器的网关，这个网关其实是没用的，因为它接收到报文后，通过修改MAC的方式调度到RS服务器上了，它不需要跨网段通信，但是不设置这个网关还真不行，随便设置一个就行</p>
<p>在这里还碰到了问题，那就是通过命令临时添加的路由和IP会自动消失（虚拟机环境），因此我写到了配置文件中，给一个网卡上永久保存两个IP的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eth0 +ipv4.address 192.168.0.200&#x2F;24 ifname eth0</span><br></pre></td></tr></table></figure>

<p>这个命令其实是修改了ifcfg-eth0的配置文件，所以也需要通过命令重新加载网卡配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection reload</span><br><span class="line">nmcli connection up eth0</span><br></pre></td></tr></table></figure>

<p>查看ifcfg-eth0文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> 1 DEVICE&#x3D;eth0                                                                  </span><br><span class="line"> 2 NAME&#x3D;eth0</span><br><span class="line"> 3 ONBOOT&#x3D;yes</span><br><span class="line"> 4 BOOTPROTO&#x3D;static</span><br><span class="line"> 5 IPADDR&#x3D;10.0.0.100</span><br><span class="line"> 6 NETMASK&#x3D;255.255.255.0</span><br><span class="line"> 7 GATEWAY&#x3D;10.0.0.1</span><br><span class="line"> 8 DNS1&#x3D;180.76.76.76</span><br><span class="line"> 9 DNS2&#x3D;223.6.6.6</span><br><span class="line">10 TYPE&#x3D;Ethernet</span><br><span class="line">11 PROXY_METHOD&#x3D;none</span><br><span class="line">12 BROWSER_ONLY&#x3D;no</span><br><span class="line">13 PREFIX&#x3D;24</span><br><span class="line">14 IPADDR1&#x3D;192.168.0.200</span><br><span class="line">15 PREFIX1&#x3D;24</span><br><span class="line">16 NETMASK1&#x3D;255.255.255.0</span><br><span class="line">17 DEFROUTE&#x3D;yes</span><br><span class="line">18 IPV4_FAILURE_FATAL&#x3D;no</span><br><span class="line">19 IPV6INIT&#x3D;no</span><br><span class="line">20 UUID&#x3D;5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>脚本：</p>
<p>自动配置LVS服务器、RS服务器，其实就是修改arp内核参数，配置VIP到lo网卡上</p>
<h3 id="3-tunnel模式的操作"><a href="#3-tunnel模式的操作" class="headerlink" title="3.tunnel模式的操作"></a>3.tunnel模式的操作</h3><p>ip addr add xxxx dev tunl0</p>
<p>ip link set tunl0 up</p>
<p>防火墙标记</p>
<p>使用mangle表的标记</p>
<p>LVS的持久连接</p>
<p>一段时间内让一个用户访问同一个业务服务器，这样可以保留session信息</p>
<p>这个时间可以设置</p>
<h2 id="4-LVS的高可用"><a href="#4-LVS的高可用" class="headerlink" title="4 LVS的高可用"></a>4 LVS的高可用</h2><p>使用keepalive实现LVS的高可用</p>
<h3 id="LVS的两个痛点："><a href="#LVS的两个痛点：" class="headerlink" title="LVS的两个痛点："></a>LVS的两个痛点：</h3><p>高可用的解决方法：</p>
<p>Keepalive，使用一个虚拟IP，谁工作，VIP就是谁的</p>
<p>对业务服务器状态无法感知的解决方法：</p>
<p>KeepAlive，定期检查业务服务器的状态</p>
<p>要求：LVS-DR模型操作</p>
<p>在实验中加入LVS+</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/Linux%E9%98%B2%E7%81%AB%E5%A2%99/" class="post-title-link" itemprop="url">Linux防火墙</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：21:59:05" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux防火墙"><a href="#Linux防火墙" class="headerlink" title="Linux防火墙"></a>Linux防火墙</h2><p><strong>1.防火墙的概念</strong></p>
<p><strong>2.防火墙工具</strong></p>
<p><strong>3.iptables</strong></p>
<p><strong>4.firewalld</strong></p>
<p><strong>5.ntf</strong></p>
<h3 id="1-防火墙概念"><a href="#1-防火墙概念" class="headerlink" title="1.防火墙概念"></a>1.防火墙概念</h3><h4 id="1-安全技术："><a href="#1-安全技术：" class="headerlink" title="1.安全技术："></a>1.安全技术：</h4><ul>
<li>入侵检测系统</li>
<li>入侵防御系统</li>
<li>防火墙</li>
</ul>
<h4 id="2-防火墙分类"><a href="#2-防火墙分类" class="headerlink" title="2.防火墙分类"></a>2.防火墙分类</h4><p>按保护范围划分：</p>
<ul>
<li>主机防火墙：服务范围为当前一台主机</li>
<li>网络防火墙：服务范围为防火墙一侧的局域网</li>
</ul>
<p>按实现方式划分：</p>
<ul>
<li>硬件防火墙：在专用硬件级别实现部分功能的防火墙</li>
<li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件</li>
</ul>
<p>按网络协议划分：</p>
<ul>
<li>网络层防火墙：OSI模型下四层，又称为包过滤防火墙</li>
<li>应用层防火墙/代理服务器：代理网关，OSI模型七层</li>
</ul>
<p><strong>包过滤防火墙：</strong></p>
<p>网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控制列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议状态等因素，或他们的组合来确定是否允许该数据包通过</p>
<p>优点：对用户来说透明，处理速度快且易于维护</p>
<p>缺点：无法检查应用层数据，如病毒等</p>
<p><strong>应用层防火墙/代理服务型防火墙，也称为代理服务器（Proxy Server）</strong></p>
<p>将所有跨越防火墙的网络通信链路分为两段</p>
<p>内外网用户的访问都是通过代理服务器上的”链接“来实现</p>
<p>优点：在应用层对数据进行检查，比较安全</p>
<p>缺点：增加防火墙的负载</p>
<p>现实生产环境中所使用的防火墙一般都是二者结合体，即先检查网络数据，通过之后再送到应用层去检查。</p>
<h4 id="3-Linux防火墙"><a href="#3-Linux防火墙" class="headerlink" title="3.Linux防火墙"></a>3.Linux防火墙</h4><h5 id="1-Netfilter"><a href="#1-Netfilter" class="headerlink" title="1.Netfilter"></a>1.Netfilter</h5><p>Linux防火墙是由Netfilter组件提供的，Netfilter工作在内核空间，集成在LINux内核中</p>
<h5 id="2-Netfilter的五个钩子函数和报文流向"><a href="#2-Netfilter的五个钩子函数和报文流向" class="headerlink" title="2.Netfilter的五个钩子函数和报文流向"></a>2.Netfilter的五个钩子函数和报文流向</h5><p>Netfilter在内核中选取五个位置放了五个钩子函数，这五个钩子函数向用户开放，用户可以通过一个命令工具向函数中写入规则，工具可以是：iptables firewalld ntfables</p>
<table>
<thead>
<tr>
<th>FUNCTION</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>INPUT</td>
<td></td>
</tr>
<tr>
<td>OUTPUT</td>
<td></td>
</tr>
<tr>
<td>FORWARD</td>
<td></td>
</tr>
<tr>
<td>PRE_ROUTING</td>
<td></td>
</tr>
<tr>
<td>POST_ROUTING</td>
<td></td>
</tr>
</tbody></table>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915174710914.png" alt="image-20200915174710914"></p>
<p>三种数据流向：</p>
<ul>
<li>流入本机：PRE_ROUTING–&gt;INPUT–&gt;用户进程空间</li>
<li>流出本机：用户进程空间–&gt;OUTPUT–&gt;POST_ROUTING</li>
<li>转发：PRE_ROUTING–&gt;FORWARD–&gt;POST_ROUTING</li>
</ul>
<h5 id="3-iptables组成–-gt-五表五链"><a href="#3-iptables组成–-gt-五表五链" class="headerlink" title="3.iptables组成–&gt;五表五链"></a>3.iptables组成–&gt;五表五链</h5><p><strong>链 chain：</strong></p>
<ul>
<li>内置链：每个内置链对应一个钩子函数 INPUT、OUTPUT、FORWARD、PRE_ROUTING、POST_ROUTING</li>
<li>自定义链：用于对内置链进行扩展或补充，可实现更灵活地规则组织管理机制；只有钩子调用自定义链的时候才能生效。</li>
</ul>
<p><strong>表 table ：filter、nat、mangle、raw、security</strong></p>
<ul>
<li>filter：过滤规则表，根据定义的规则过滤符合条件的数据包，也是iptables的默认表</li>
<li>nat：network address translation 地址转换规则表</li>
<li>mangle：修改数据标记为规则表</li>
<li>raw：关闭启用的连接跟踪机制，加快封包穿越防火墙速度</li>
<li>security：用于强制访问控制（MAC）网络规则，有Linux安全模块实现</li>
</ul>
<p>表的优先级：从大到小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security&gt;raw&gt;mangle&gt;nat&gt;filter</span><br></pre></td></tr></table></figure>

<p>表和链的对应关系</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915180126223.png" alt="image-20200915180126223"></p>
<p>内核中数据包的传输过程</p>
<ul>
<li>当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包目的IP判断是否需要转送出去</li>
<li>如果数据包是进入本机的，数据包就会沿着图向下移动，到达INPUT链。数据包到达INPUT链后，任何进程都会受到它。本机上运行的程序可以发送数据包，这些数据包经过OUTPUT链，然后到达POSTROUTING链输出</li>
<li>如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200915191228621.png" alt="image-20200915191228621"></p>
<h4 id="4-iptables"><a href="#4-iptables" class="headerlink" title="4.iptables"></a>4.iptables</h4><h5 id="1-iptables规则"><a href="#1-iptables规则" class="headerlink" title="1.iptables规则"></a>1.iptables规则</h5><p>规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义的处理动作做出处理，规则在链接上的次序即为其检查时的生效次序</p>
<p><strong>匹配条件</strong>：默认为与条件，同时满足</p>
<p><strong>基本匹配</strong>：IP、端口、TCP的Flags（SYN、ACK、FIN）</p>
<p><strong>扩展匹配</strong>：通过复杂高级功能匹配</p>
<p><strong>处理动作</strong>：称为target，跳转目标</p>
<ul>
<li>内建处理动作：ACCEPT、DROP、REJECT、SNAT、DNAT、MASQUERADE、MARK、LOG</li>
<li>自定义处理动作：自定义chain，利用分类管理复杂情形</li>
</ul>
<p>规则要添加在内置链上才能生效；添加在自定义链上不会生效，还需要把自定义链加到内置链上。</p>
<p>因为本质上这个规则就是利用了那5个钩子函数，也就是5个链。我们写的规则就是这5个函数的参数。</p>
<p>iptables规则添加时的考量点：</p>
<ul>
<li>要实现哪种功能：判断添加在哪张表上</li>
<li>报文流经的路径：判断添加在哪个链上</li>
<li>报文的流向：判断源和目的</li>
<li>匹配规则：业务需要</li>
</ul>
<p><strong>注意一点：Iptables等防火墙工具他们的服务开启和关闭都是在控制链和表，所以关闭了防火墙，其实是清空了防火墙规则，方便我们自己去定义规则</strong></p>
<p>2.iptables用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@localdns ~]#iptables --help</span><br><span class="line">iptables v1.4.21</span><br><span class="line"></span><br><span class="line">Usage: iptables -[ACD] chain rule-specification [options]</span><br><span class="line">       iptables -I chain [rulenum] rule-specification [options]</span><br><span class="line">       iptables -R chain rulenum rule-specification [options]</span><br><span class="line">       iptables -D chain rulenum [options]</span><br><span class="line">       iptables -[LS] [chain [rulenum]] [options]</span><br><span class="line">       iptables -[FZ] [chain] [options]</span><br><span class="line">       iptables -[NX] chain</span><br><span class="line">       iptables -E old-chain-name new-chain-name</span><br><span class="line">       iptables -P chain target [options]</span><br><span class="line">       iptables -h (print this help information)</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">Either long or short options are allowed.</span><br><span class="line">  --append  -A chain		Append to chain</span><br><span class="line">  --check   -C chain		Check for the existence of a rule</span><br><span class="line">  --delete  -D chain		Delete matching rule from chain</span><br><span class="line">  --delete  -D chain rulenum</span><br><span class="line">				Delete rule rulenum (1 &#x3D; first) from chain</span><br><span class="line">  --insert  -I chain [rulenum]</span><br><span class="line">				Insert in chain as rulenum (default 1&#x3D;first)</span><br><span class="line">  --replace -R chain rulenum</span><br><span class="line">				Replace rule rulenum (1 &#x3D; first) in chain</span><br><span class="line">  --list    -L [chain [rulenum]]</span><br><span class="line">				List the rules in a chain or all chains</span><br><span class="line">  --list-rules -S [chain [rulenum]]</span><br><span class="line">				Print the rules in a chain or all chains</span><br><span class="line">  --flush   -F [chain]		Delete all rules in  chain or all chains</span><br><span class="line">  --zero    -Z [chain [rulenum]]</span><br><span class="line">				Zero counters in chain or all chains</span><br><span class="line">  --new     -N chain		Create a new user-defined chain</span><br><span class="line">  --delete-chain</span><br><span class="line">            -X [chain]		Delete a user-defined chain</span><br><span class="line">  --policy  -P chain target</span><br><span class="line">				Change policy on chain to target</span><br><span class="line">  --rename-chain</span><br><span class="line">            -E old-chain new-chain</span><br><span class="line">				Change chain name, (moving any references)</span><br><span class="line">Options:</span><br><span class="line">    --ipv4	-4		Nothing (line is ignored by ip6tables-restore)</span><br><span class="line">    --ipv6	-6		Error (line is ignored by iptables-restore)</span><br><span class="line">[!] --protocol	-p proto	protocol: by number or name, eg. &#96;tcp&#39;</span><br><span class="line">[!] --source	-s address[&#x2F;mask][...]</span><br><span class="line">				source specification</span><br><span class="line">[!] --destination -d address[&#x2F;mask][...]</span><br><span class="line">				destination specification</span><br><span class="line">[!] --in-interface -i input name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line"> --jump	-j target</span><br><span class="line">				target for rule (may load target extension)</span><br><span class="line">  --goto      -g chain</span><br><span class="line">                              jump to chain with no return</span><br><span class="line">  --match	-m match</span><br><span class="line">				extended match (may load extension)</span><br><span class="line">  --numeric	-n		numeric output of addresses and ports</span><br><span class="line">[!] --out-interface -o output name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line">  --table	-t table	table to manipulate (default: &#96;filter&#39;)</span><br><span class="line">  --verbose	-v		verbose mode</span><br><span class="line">  --wait	-w [seconds]	maximum wait to acquire xtables lock before give up</span><br><span class="line">  --wait-interval -W [usecs]	wait time to try to acquire xtables lock</span><br><span class="line">				default is 1 second</span><br><span class="line">  --line-numbers		print line numbers when listing</span><br><span class="line">  --exact	-x		expand numbers (display exact values)</span><br><span class="line">[!] --fragment	-f		match second or further fragments only</span><br><span class="line">  --modprobe&#x3D;&lt;command&gt;		try to insert modules using this command</span><br><span class="line">  --set-counters PKTS BYTES	set the counter during insert&#x2F;append</span><br><span class="line">[!] --version	-V		print package version.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>iptables命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table]  &#123;-A|-I|-R|-D|...&#125; chain    rule      -j targetname</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-t table 这个可以不写，默认是filter表</span><br><span class="line">-A append 追加一个规则，排在最后一条</span><br><span class="line">-I number 插入到第几行，可以自由选择规则顺序</span><br><span class="line">-R replace 代替哪个链的第几行</span><br><span class="line">-D 删除</span><br><span class="line">-N	new 新建一个链</span><br><span class="line">-E	重命名自定义链</span><br><span class="line">-X：delete，删除自定义的空的规则链 注意一定得是空链，里面不能有规则</span><br><span class="line">-P：policy，设置默认策略；filter表的默认策略是ACCEPT，可以改成DROP，只有这两种</span><br><span class="line">-F：flush 清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line">	(1)匹配到的报文的个数</span><br><span class="line">	(2)匹配到的所有报文的大小之和</span><br></pre></td></tr></table></figure>

<p>例子：拒绝10.0.0.5访问本主机的TCP80端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -A INPUT -s  10.0.0.5 -p tcp -m multiport --dports 80 -j REJECT</span><br><span class="line">[root@forwarddns named]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br><span class="line">    0     0 REJECT     tcp  --  *      *       10.0.0.5             0.0.0.0&#x2F;0     </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination   </span><br></pre></td></tr></table></figure>

<p>例子：新建web_chain控制网页访问的几个端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -N web_chain </span><br><span class="line">[root@forwarddns named]#iptables -E web_chain WEB_CHAIN  #改了个大写名字</span><br><span class="line">[root@forwarddns named]#iptables -A WEB_CHAIN -p tcp -m multiport --dports 80,443,8080 -j REJECT  #此时规则时无法生效的，因为自定义链还没有插入到内置链中</span><br><span class="line">[root@forwarddns named]#iptables -A INPUT -j WEB_CHAIN   #插入链的操作是 —j</span><br><span class="line">[root@forwarddns named]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   28  1848 WEB_CHAIN  all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain WEB_CHAIN (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 REJECT     tcp  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            multiport dports 80,443,8080 reject-with icmp-port-unreachable</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例子：删除自定义链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns named]#iptables -F WEB_CHAIN #先把链里的规则清空</span><br><span class="line">[root@forwarddns named]#iptables -D INPUT 1  #删除自定义链和内置链的关联关系</span><br><span class="line">[root@forwarddns named]#iptables -X WEB_CHAIN  #删除自定义链</span><br></pre></td></tr></table></figure>

<p><strong>2.匹配条件</strong></p>
<ul>
<li>基本匹配：通用的，PARAMENTERS</li>
<li>扩展：需加载模块，MATCH EXTENSIONS</li>
</ul>
<p><strong>3.处理动作</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-j targetname</span><br><span class="line">ACCEPT </span><br><span class="line">DROP</span><br><span class="line">REJECT</span><br><span class="line">RETURN 返回调用链</span><br><span class="line">REDIRECT 端口重定向</span><br><span class="line">LOG 记录日志</span><br><span class="line">MARK 做防火墙标记</span><br><span class="line">DNAT 目标地址转换</span><br><span class="line">SNAT 源地址转换</span><br><span class="line">MASQUERADE 地址伪装</span><br><span class="line">自定义链  添加到内置链的时候是 ‘-j 自定义链’    </span><br></pre></td></tr></table></figure>

<h5 id="2-iptables的匹配条件"><a href="#2-iptables的匹配条件" class="headerlink" title="2.iptables的匹配条件"></a>2.iptables的匹配条件</h5><p>1.基本匹配条件：无需加载模块，由iptables/netfilter自行提供</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-s source address 源IP地址</span><br><span class="line">-d destination address目标IP地址</span><br><span class="line">-p protocol 协议，tcp,udp,icmp ...  查看&#x2F;etc&#x2F;protocols</span><br><span class="line">-i in-interface 报文流入的接口</span><br><span class="line">-o out-interface 报文流出的接口</span><br></pre></td></tr></table></figure>

<p>2.扩展匹配条件</p>
<p>扩展匹配条件需要加载扩展模块：/usr/lib64/xtables/*.so</p>
<p>扩展模块的查看帮助：man iptables-extensions</p>
<p>扩展匹配条件：</p>
<ul>
<li>隐式扩展</li>
<li>显式扩展</li>
</ul>
<p>3.隐式扩展</p>
<p>iptables在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块</p>
<p>tcp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--sport port 匹配报文源端口</span><br><span class="line">--dport port 匹配报文目的端口</span><br><span class="line">--tcp-flags mask,comp</span><br><span class="line">	mask 需要检查的标示位，用“，”分隔，例如 SYN,FIN,ACK,RST</span><br><span class="line">	COMP 在mask需要检查的标示位中必须为1的那个标识位，比如 SYN,FIN,ACK SYN 这个意思是在这三个标示位里SYN必须是1</span><br></pre></td></tr></table></figure>

<p>udp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--sport</span><br><span class="line">--dport</span><br></pre></td></tr></table></figure>

<p>icmp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--icmp-type type&#x2F;code</span><br><span class="line">	0&#x2F;0 echo-reply ICMP应答</span><br><span class="line">	8&#x2F;0 echo-request ICMP请求</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.5 -p tcp -m multiport --dport 22,23,24,25 -j REJECT </span><br><span class="line">这里用了显示扩展条件</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.7 -p tcp --tcp-flags SYN,ACK,FIN SYN -j REJECT</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns xtables]#iptables -A INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.显式扩展及相关模块</p>
<p>显示扩展必须使用-m选项指明要调用的模块，需要手动加载扩展模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m matchname</span><br></pre></td></tr></table></figure>

<p>帮助文档：</p>
<p>centos7,8：man iptables-extensions</p>
<p>centos6：man iptables</p>
<p>4.1multiport扩展</p>
<p>以离散方式定义多端口匹配，最多指定15个端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--sports port</span><br><span class="line">--dports port</span><br><span class="line">--ports port</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -s 10.0.0.0&#x2F;24  -p tcp -m multiport --dports 20:22,80 -j ACCEPT </span><br></pre></td></tr></table></figure>

<p>4.2 iprange扩展</p>
<p>指明连续的IP地址范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--src-range from</span><br><span class="line">--dst-range from</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -m iprange --src-range 10.0.0.1-10.0.0.10 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.3 mac扩展</p>
<p>mac扩展用于指明MAC地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--mac-source xx:xx:xx:xx:xx:xx</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -m mac --mac-source 00:0c:29:f4:f0:1c -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.4 string扩展</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--algo &#123;bm|kmp&#125; 字符串匹配检测算法</span><br><span class="line">	bm:Boyer-Moore</span><br><span class="line">	kmp:Knuth-Pratt-Morris</span><br><span class="line">--from offset 开始偏移</span><br><span class="line">--to offset 结束偏移</span><br><span class="line">--string pattern 要检测的字符串</span><br><span class="line">--hex-string 要检测字符串模式，16进制</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A OUTPUT -p tcp --sport 80 -m string --algo bm --from 62 --string &quot;google&quot; -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.5 time扩展</p>
<p>将根据报文到达的时间与指定的时间范围进行匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--datestart 日期</span><br><span class="line">--datestop 日期</span><br><span class="line">--timestart 时间</span><br><span class="line">--timestop 时间</span><br><span class="line">--monthdays day 每个月的几号</span><br><span class="line">--weekdays day 星期几</span><br><span class="line">--kerneltz 内核时间</span><br></pre></td></tr></table></figure>

<p>4.6 connlimit扩展</p>
<p>根据客户端IP做并发连接数数量匹配</p>
<p>可防止Dos（Denial of service，拒绝服务）攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--connlimit-upto N   #连接的数量小于等于N时匹配</span><br><span class="line">--connlimit-above N  #连接的数量大于N时匹配</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT -d 10.0.0.0&#x2F;24 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br></pre></td></tr></table></figure>

<p>4.7 limit扩展</p>
<p>基于收发报文的速率做匹配，令牌桶过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--limit-burst number #前多少个包不限制</span><br><span class="line">--limit #</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@forwarddns ~]#iptables -A INPUT  -p icmp --icmp-type 8 -m limit --limit 10&#x2F;minute --limit-burst 5 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.8 state扩展</p>
<p>state扩展模块，可以根据“连接追踪机制”去检查连接的状态，比较消耗资源</p>
<p>conntrack机制：连接追踪机制，追踪本机上的请求和响应之间的关系</p>
<p>-m state –state NEW/ESTABLISHED/….</p>
<p>NEW:新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</p>
<p>ESTABLISHED</p>
<p>RELATED</p>
<p>第一个：已经追踪到的并记录下来的连接信息库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;net&#x2F;nf_contrack</span><br></pre></td></tr></table></figure>

<p>第二个：连接追踪功能所能容纳的最大连接数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;netfilter&#x2F;nf_conntrack_max</span><br><span class="line"></span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;nf_conntrack_max</span><br></pre></td></tr></table></figure>

<p>第三个：查看连接追踪有多少条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;netfilter&#x2F;nf_conntrack_count</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>连接追踪需要加载模块 modprobe nf_conntrack_ipv4</li>
<li>当服务器连接多于最大连接数时，dmesg可以观察到日志：kernel:ip_conntrack:table full,dropping packet错误，并且导致建立TCP连接很慢  tail -f /var/log/message</li>
<li>各种状态的超时后，链接会从表中删除</li>
</ul>
<h5 id="3-target"><a href="#3-target" class="headerlink" title="3.target"></a>3.target</h5><p>自定义链、ACCEPT、REJECT、DROP、RETURN、LOG、SNAT、DNAT、REDIRECT、MASQUERADE</p>
<h5 id="4-规则优化最佳实践："><a href="#4-规则优化最佳实践：" class="headerlink" title="4.规则优化最佳实践："></a>4.规则优化最佳实践：</h5><p>1.安全放行所有入站和出站的状态为ESTABLISHED状态连接，建议放在第一条，效率更高</p>
<p>2.谨慎放行入站的新请求</p>
<p>3.有特殊目的限制访问功能，要在放行规则之前加以拒绝</p>
<p>4.同类规则（访问同一应用，比如：http），匹配范围小的放前面，用于特殊处理</p>
<p>5.不同类的规则，匹配范围大的放在前面，效率更高，就是访问次数多的端口放前面，更加高效</p>
<h5 id="6-iptables规则保存"><a href="#6-iptables规则保存" class="headerlink" title="6.iptables规则保存"></a>6.iptables规则保存</h5><p>使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限</p>
<p>持久保存规则的方法：</p>
<p>防火墙的规则都是保存在文件里的，我们可以把自己配置好的防火墙规则保存成一个文件，然后通过开机自动加载这个文件的方式实现规则的永久保存</p>
<p><strong>centos7之后：</strong></p>
<p>iptables-save</p>
<p>iptables-restore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">iptables-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables #然后把这行命令放到&#x2F;etc&#x2F;rc.local 中，这样每次开机都会执行这行命令，从而达到防火墙规则的永久保存</span><br></pre></td></tr></table></figure>

<p><strong>centos6：</strong></p>
<p>/etc/sysconfig/iptables</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br><span class="line">service iptables restart #centos 6每次启动服务都会重新加载防火墙规则的，只要我们之前手动保存过就可以永久保存了</span><br></pre></td></tr></table></figure>

<h5 id="7-网络防火墙"><a href="#7-网络防火墙" class="headerlink" title="7.网络防火墙"></a>7.网络防火墙</h5><p>iptables/netfilter利用filter表的forward链，可以充当网络防火墙</p>
<p>注意的问题：</p>
<p>​    （1）请求-响应报文均会经由FORWARD链，要注意规则的方向性</p>
<p>​    （2）如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行</p>
<p>实验：防火墙利用forward链实现内外网的访问控制，同时对路由进行理解</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200917105248428.png" alt="image-20200917105248428"></p>
<p>1.通过标准模块实现内网访问外网，反之禁止</p>
<p>注意先开通转发功能：ip_forward = 1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.con</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">iptables -t fliter -A FORWARD -j REJECT  禁止所有的转发</span><br><span class="line">iptables -t filter -A FORWARD -s 10.0.0.0&#x2F;24 -p tcp --dport 80  -j ACCEPT  允许内网向外网的数据传输</span><br><span class="line">iptables -I FORWARD -d 10.0.0.0&#x2F;24 -p tcp --dport 80 -j ACCEPT 允许外网的80端口的回复</span><br></pre></td></tr></table></figure>

<p>2.通过state模块实现内网访问外网所有资源，反之禁止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -j REJECT  禁止所有转发</span><br><span class="line">iptables -I FORWARD -s 10.0.0.0&#x2F;24 -m state --state NEW -j ACCEPT  允许内网向外网建立连接</span><br><span class="line">iptables -I FORWARD  -m state --state ESTABLISHED,RELATED -j ACCEPT  允许所有已经了建立连接的主机之间数据的传输</span><br></pre></td></tr></table></figure>

<p>3.允许内网指定主机被外网访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -j REJECT  禁止所有转发</span><br><span class="line">iptables -I FORWARD -s 10.0.0.0&#x2F;24 -m state --state NEW -j ACCEPT  允许内网向外网建立连接</span><br><span class="line">iptables -I FORWARD  -m state --state ESTABLISHED,RELATED -j ACCEPT  允许所有已经了建立连接的主机之间数据的传输</span><br><span class="line">[root@centos8 network-scripts]#iptables -I FORWARD -d 10.0.0.5&#x2F;32 -p tcp --dport 8080 -j ACCEPT 允许内网的10.0.0.5主机的8080端口被访问</span><br></pre></td></tr></table></figure>

<p>4.一句命令实现内部访问外部，外部禁止访问内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 network-scripts]#iptables -R FORWARD 1 -d 10.0.0.0&#x2F;24 -m state --state NEW -j REJECT  利用state模块，实现禁止外部主动与内部通讯</span><br></pre></td></tr></table></figure>

<h3 id="NAT表"><a href="#NAT表" class="headerlink" title="NAT表"></a>NAT表</h3><p>SNAT，DNAT都是TARGET，是跟在“-j”后面的参数</p>
<h4 id="1-SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP"><a href="#1-SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP" class="headerlink" title="1.SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP"></a>1.SNAT：源地址转换，配合POSTROUTING链，将数据来源的IP地址转换成指定IP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s IP -t tcp|udp --dport xxx -j SNAT --to-source extened IP</span><br></pre></td></tr></table></figure>

<h4 id="2-DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP"><a href="#2-DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP" class="headerlink" title="2.DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP"></a>2.DNAT：目标地址转换，配合PERROUTING链，将数据目的IP地址转换成指定IP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d IP -t tcp|udp|icmp --dport xx  -j DNAT --to-destination IP:[port] </span><br></pre></td></tr></table></figure>

<p>PAT：端口IP都转换，可以实现端口的对应关系，比如防火墙上IP的80端口对应内网web服务器IP的8080端口</p>
<p>综合实验：互联网中防火墙的实际NAT使用，SNAT和DNAT配合使用，还有最后在目标主机上配置本地端口转发</p>
<p>配置内外网的访问限制</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200916193650280.png" alt="image-20200916193650280"></p>
<p>​                                                                                    架构图</p>
<p>准备阶段：</p>
<ul>
<li>3个网段：10.0.0.0/8    172.16.0.0/12     192.168.0.0/16        为什么是这三个网段呢？因为这三个网段是私网网段，公网上没有这三种IP。</li>
<li>4台主机</li>
</ul>
<h4 id="3-REDIRECT转发"><a href="#3-REDIRECT转发" class="headerlink" title="3.REDIRECT转发"></a>3.REDIRECT转发</h4><p>REDIRECT，是NAT表的target，通过改变目标IP和端口，将接受的包转发至同一个主机的不同端口，可用于PREROUTING OUTPUT链</p>
<p><strong>适用于本地主机使用，不是让防火墙来使用的！！</strong></p>
<p>REDIRECT选项：</p>
<ul>
<li>–to-ports xx</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d ip -t tcp|udp --dport 80 -j REDIRECT --to-ports 80</span><br><span class="line">把原来发给IP：80端口的数据转发给了IP:8080端口</span><br></pre></td></tr></table></figure>



<h4 id="究极实验："><a href="#究极实验：" class="headerlink" title="究极实验："></a>究极实验：</h4><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200917154841708.png" alt="image-20200917154841708"></p>
<p>1.环境准备：包括三个网段、四台主机、开启路由转发功能、配置路由等操作</p>
<ul>
<li>路由转发功能：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward #查看当前主机是否开启路由转发功能，0是关闭，1是开启</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf </span><br><span class="line">添加一行</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">#保存退出</span><br><span class="line">sysctl -p #sysctl 是专门的内核参数命令，包括</span><br><span class="line">-a 显示所有内核参数 </span><br><span class="line">-p 读取 &#x2F;etc&#x2F;sysctl.conf文件中的配置</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置路由：本来只使用SNAT和DNAT的话可以不配置路由，但是为了体现FORWARD的功能，我专门配置了路由，使得 192.168.0.0/24 和 172.16.0.0/24 段能够互联互通。</p>
<ul>
<li>原本不通的原因：！！！ 原本192.168.0.0/24和10.0.0.3都不通，按理说不应该</li>
</ul>
<p>本来从192.168.0.0/24段通过防火墙的192.168.0.710.0.0.7这两个地址是可以找到10.0.0.3的，但是，10.0.0.3找不到192.168.0.0/24网段的路由！！！所以ping不通，所以需要写上去192.168.0.0/24网段的路由</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">配置10.0.0.7的路由：</span><br><span class="line">[root@localhost ~]#route -n  #显示当前路由</span><br><span class="line">Kernel IP routing table</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     102    0        0 eth0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.255.0   U     101    0        0 eth1</span><br><span class="line">通过实测发现，通过默认路由192.168.0.0&#x2F;24和172.16.0.0&#x2F;24是不能通信的，是因为10.0.0.7不知道怎么去172.16.0.0&#x2F;24网段，10.0.0.3不知道怎么去192.168.0.0&#x2F;24网段，所以要加上路由，告诉他们怎么去</span><br><span class="line"></span><br><span class="line">[root@localhost ~]#ip route add default dev eth0 via 10.0.0.3 #添加默认路由</span><br><span class="line">[root@localhost ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.0.0.3        0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     102    0        0 eth0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.255.0   U     101    0        0 eth1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同理配置10.0.0.3的路由</p>
<p>2.filter表的FORWARD链规则配置，目的是控制内外网之间的通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#iptables -t filter -A FORWARD -j REJECT #拒绝所有转发</span><br><span class="line">[root@localhost ~]#iptables -t filter -I FORWARD 1 -s 192.168.0.0&#x2F;24 -m state --state NEW -j ACCEPT #只允许内网向外网发起连接请求，也就是内网可以主动访问外网</span><br><span class="line">[root@localhost ~]#iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT #已经建立了的链接可以被转发</span><br><span class="line">[root@localhost ~]#iptables -I FORWARD 3 -d 192.168.0.100 -p tcp --dport 80 -j ACCEPT #开放内网的部分主机的部分服务给外网访问</span><br><span class="line">下面是配置好的filter的全部规则</span><br><span class="line">[root@localhost ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 47 packets, 3128 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    9   896 ACCEPT     all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            state RELATED,ESTABLISHED</span><br><span class="line">    2   136 ACCEPT     all  --  *      *       192.168.0.0&#x2F;24       0.0.0.0&#x2F;0            state NEW</span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0&#x2F;0            192.168.0.100        tcp dpt:80</span><br><span class="line">   18  1232 REJECT     all  --  *      *       0.0.0.0&#x2F;0            0.0.0.0&#x2F;0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 25 packets, 2348 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination </span><br></pre></td></tr></table></figure>

<p>同理配置另一个公司的防火墙filter表的FORWARD链规则</p>
<p>3.NAT，利用NAT实现私网地址和公网地址的转换，涉及到nat表的PREROUTING和POSTROUTING链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#iptables -t nat -A POSTROUTING -s 192.168.0.0&#x2F;24 -p tcp -j  MASQUERADE</span><br><span class="line">[root@localhost ~]#iptables -t nat -A PREROUTING -d 10.0.0.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.0.100:8080</span><br><span class="line">注意：这里除了设定了DNAT，还设定了端口转换，本来是发送给80端口的，但是转换成了8080端口，所以上面的FORWARD规则就要改一下，把允许外网通过的tcp端口改成8080</span><br></pre></td></tr></table></figure>

<p>4.测试，可以实现</p>
<p>5.防火墙规则保存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sysconfig]#iptables-save &gt; &#x2F;data&#x2F;iptables.conf</span><br><span class="line">[root@localhost data]#vim iptables.conf</span><br><span class="line">  1 # Generated by iptables-save v1.4.21 on Thu Sep 17 18:45:26 2020</span><br><span class="line">  2 *nat</span><br><span class="line">  3 :PREROUTING ACCEPT [21:2684]</span><br><span class="line">  4 :INPUT ACCEPT [4:916]</span><br><span class="line">  5 :OUTPUT ACCEPT [19:1420]</span><br><span class="line">  6 :POSTROUTING ACCEPT [31:2212]</span><br><span class="line">  7 -A PREROUTING -d 10.0.0.7&#x2F;32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.0.100:8080</span><br><span class="line">  8 -A POSTROUTING -s 192.168.0.0&#x2F;24 -p tcp -j MASQUERADE</span><br><span class="line">  9 COMMIT</span><br><span class="line"> 10 # Completed on Thu Sep 17 18:45:26 2020</span><br><span class="line"> 11 # Generated by iptables-save v1.4.21 on Thu Sep 17 18:45:26 2020</span><br><span class="line"> 12 *filter</span><br><span class="line"> 13 :INPUT ACCEPT [561:40565]</span><br><span class="line"> 14 :FORWARD ACCEPT [0:0]</span><br><span class="line"> 15 :OUTPUT ACCEPT [363:66484]</span><br><span class="line"> 16 -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"> 17 -A FORWARD -s 192.168.0.0&#x2F;24 -m state --state NEW -j ACCEPT</span><br><span class="line"> 18 -A FORWARD -d 192.168.0.100&#x2F;32 -p tcp -m tcp --dport 8080 -j ACCEPT</span><br><span class="line"> 19 -A FORWARD -j REJECT --reject-with icmp-port-unreachable</span><br><span class="line"> 20 COMMIT</span><br><span class="line"> 21 # Completed on Thu Sep 17 18:45:26 2020  </span><br><span class="line"> 设置为开机自动导入规则，配合开机自动启动防火墙服务，可以实现永久保存规则</span><br><span class="line"> [root@localhost data]#iptables-restore &lt; &#x2F;data&#x2F;iptables.conf</span><br><span class="line"> [root@localhost data]#vim &#x2F;etc&#x2F;rc.local</span><br><span class="line">  1 #!&#x2F;bin&#x2F;bash</span><br><span class="line">  2 # THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span><br><span class="line">  3 #</span><br><span class="line">  4 # It is highly advisable to create own systemd services or udev rules</span><br><span class="line">  5 # to run scripts during boot instead of using this file.</span><br><span class="line">  6 #</span><br><span class="line">  7 # In contrast to previous versions due to parallel execution during boot</span><br><span class="line">  8 # this script will NOT be run after all other services.</span><br><span class="line">  9 #</span><br><span class="line"> 10 # Please note that you must run &#39;chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local&#39; to ensure</span><br><span class="line"> 11 # that this script will be executed during boot.</span><br><span class="line"> 12 </span><br><span class="line"> 13 touch &#x2F;var&#x2F;lock&#x2F;subsys&#x2F;local</span><br><span class="line"> 14 iptables-restore &lt; &#x2F;data&#x2F;iptables.conf </span><br></pre></td></tr></table></figure>



<p>firewalld</p>
<p>firewall-cmd</p>
<p>zone</p>
<p>nft netfiltertables</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/KVM%20---%20Kernel-Based%20Virtual%20Machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/KVM%20---%20Kernel-Based%20Virtual%20Machine/" class="post-title-link" itemprop="url">Linux启动和内核管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：22:10:23" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="KVM-—-Kernel-Based-Virtual-Machine"><a href="#KVM-—-Kernel-Based-Virtual-Machine" class="headerlink" title="KVM — Kernel-Based Virtual Machine"></a>KVM — Kernel-Based Virtual Machine</h1><p>是什么：一种主流的、集成在内核的虚拟化技术<br>为什么：应运而生，是Rea Hat的公司<br>怎么使用：1.CPU对KVM技术的支持；<br>         2.内核加载KVM模块<br>         3.安装libvirt包<br>         4.配合qemu、virtio等技术实现完整的虚拟化<br>掌握什么：半虚拟化、全虚拟化、KVM原理、KVM管理工具（OpenStack、CloudStack）<br>内容概述</p>
<ul>
<li>   虚拟化基础</li>
<li>   虚拟化KVM</li>
<li>   创建虚拟机</li>
<li>   管理虚拟机</li>
<li>   存储管理</li>
<li>   网络管理</li>
<li>   综合实战案例<h1 id="1-虚拟化基础"><a href="#1-虚拟化基础" class="headerlink" title="1 虚拟化基础"></a>1 虚拟化基础</h1><h2 id="1-1-虚拟化出现的原因"><a href="#1-1-虚拟化出现的原因" class="headerlink" title="1.1 虚拟化出现的原因"></a>1.1 虚拟化出现的原因</h2>传统物理机部署时间周期长、耗费大、资源利用率不高，部署无法自动化实现<h2 id="1-2-虚拟化和虚拟机"><a href="#1-2-虚拟化和虚拟机" class="headerlink" title="1.2 虚拟化和虚拟机"></a>1.2 虚拟化和虚拟机</h2>虚拟化是一种资源管理技术，将计算机实体的各种资源进行抽象、转换后呈现出来并可提供分隔、组合为一个或多个计算机配置环境，并重新分隔、重新组合，以达到最大化合理利用物理资源的目的。<br>虚拟计算机称为“虚拟机”（VM，Virtual Machine），它是一种严密隔离且内含操作系统和应用的软件容器。每个虚拟机都是完全独立的。通过将多台虚拟机放置在一台物理计算机上，可以仅在一台物理服务器或“主机”上运行多个操作系统和应用，名为“hypervisor”的精简软件层可以将虚拟机与主机分离开来，并根据需要为每个虚拟机动态分配计算资源。<br>虚拟机的主要特征：分区、隔离、封装、独立于硬件<h2 id="1-3-虚拟化类型"><a href="#1-3-虚拟化类型" class="headerlink" title="1.3 虚拟化类型"></a>1.3 虚拟化类型</h2></li>
</ul>
<p>4.虚拟化的类型：主机虚拟化、网络虚拟化、桌面虚拟化、应用虚拟化、存储虚拟化、库虚拟化、容器虚拟化</p>
<h2 id="1-4-Hypervisor类型"><a href="#1-4-Hypervisor类型" class="headerlink" title="1.4 Hypervisor类型"></a>1.4 Hypervisor类型</h2><h3 id="Hypervisor是什么："><a href="#Hypervisor是什么：" class="headerlink" title="Hypervisor是什么："></a>Hypervisor是什么：</h3><ul>
<li>   Hypervisor是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可叫做VMM（Virtual Machine Monitor），即虚拟机监视器。</li>
<li>   Hypervisor是所有虚拟化技术的核心，非中断地支持多工作负载迁移的能力是Hypervisor的基本功能，当服务器启动并执行Hypervisor时，它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘，并加载所有虚拟机的客户端操作系统。</li>
<li>   多数的虚拟化采用虚拟机管理程序Hypervisor</li>
<li>   允许多种操作系统在相同的物理系统中运行</li>
<li>   控制硬件并向来宾操作系统提供访问底层硬件的途径</li>
<li>   向来宾操作系统提供虚拟化的硬件</li>
</ul>
<h3 id="X86-CPU的保护环：限制代码的作用范围"><a href="#X86-CPU的保护环：限制代码的作用范围" class="headerlink" title="X86 CPU的保护环：限制代码的作用范围"></a>X86 CPU的保护环：限制代码的作用范围</h3><ul>
<li>   Ring 0 ：内核</li>
<li>   Ring 1 ：设备驱动程序</li>
<li>   Ring 2 ：设备驱动程序</li>
<li>   Ring 3 ：用户空间<br>主要是Ring 0 和 Ring 3，下面介绍一下Ring 0 和Ring 3<br>Ring 0 ：Kernel Mode，是Host Kernel运行的模式，运行在内核态的代码可以无限制的对系统内存、设备驱动程序、网卡接口、显卡接口等外围设备进行访问。只有Host OS可以无限制的访问磁盘、键盘灯外围设备的数据，但是首先要在Host OS上安装驱动程序<br>Ring 3 ：User Mode，运行在用户态的程序代码需要受到CPU的检查，用户态代码只能访问规定可以访问的内存地址，不能直接访问外围设备、不能抢占CPU，所有的应用程序都运行在用户态上，当应用程序需要调用只能被内核态直接访问的硬件设备时，CPU会通过特定的接口去调用内核态代码，通过这样的方式让应用程序访问硬件。</li>
</ul>
<h3 id="Hypervisor分类："><a href="#Hypervisor分类：" class="headerlink" title="Hypervisor分类："></a>Hypervisor分类：</h3><p>裸金属型，Hypervisor直接运行在物理机–&gt;KVM属于裸金属型<br>宿主型，Hypervisor运行在一个操作系统上–&gt;Vm Ware</p>
<h2 id="1-5-虚拟化技术分类"><a href="#1-5-虚拟化技术分类" class="headerlink" title="1.5 虚拟化技术分类"></a>1.5 虚拟化技术分类</h2><p>模拟器/软件仿真：QEMU<br>全虚拟化/本地虚拟化：特权接触、陷入模拟<br>    软件辅助的全虚拟化<br>    硬件辅助的全虚拟化–&gt;CPU直接支持，KVM就是基于硬件辅助的全虚拟化，通过在内核加载KVM模块，把Host OS 转换为一个VMM<br>    需要X86架构CPU；Intel VT，AMD-V支持<br>    KVM是硬件辅助的虚拟化技术，主要负责比较繁琐的CPU和内存虚拟化，而QEMU则负责I/O虚拟化，两者合作发挥自身的优势<br>半虚拟化–&gt;XEN，代表软件，virtio驱动<br>虚拟化技术发展过程：模拟和仿真 –&gt;软件辅助的全虚拟化–&gt;半虚拟化–&gt;硬件辅助的全虚拟化</p>
<h2 id="1-6-云计算"><a href="#1-6-云计算" class="headerlink" title="1.6 云计算"></a>1.6 云计算</h2><p>云计算：以虚拟化为基础，以网络为中心，为用户提供数据存储和网络计算服务的方案，不是一种技术，云计算的技术是虚拟化<br>特征：按量付费、按需配置、运营成本低<br>云计算分类：<br>    公有云：为所有人提供的云服务<br>    私有云：政企喜欢用，安全和私有化，定制化<br>    混合云：私密的数据放在私有云，服务跑在公有云，安全和省钱的结合<br>云计算分层：<br>    传统模式： Internet Data Center，IDC，用户需要负责所有事情<br>    iaas：Infrastructure As A Service，基础硬件作为了一个服务提供给用户，用户需要管理操作系统及以上的事情<br>    paas：Platform As A Service，平台作为一个服务提供给用户，用户需要管理应用程序和用户数据<br>    saas：Software As A Service，应用程序作为一个服务提供给用户，用户只需要管理自己的用户数据<br>云计算和虚拟化：<br>云计算是一种服务模式，虚拟化是一种技术，他们是独立的，不存在谁一定依赖谁的问题，都能独立使用</p>
<h1 id="2-虚拟化技术KVM架构和部署"><a href="#2-虚拟化技术KVM架构和部署" class="headerlink" title="2 虚拟化技术KVM架构和部署"></a>2 虚拟化技术KVM架构和部署</h1><h2 id="2-1-KVM概述"><a href="#2-1-KVM概述" class="headerlink" title="2.1 KVM概述"></a>2.1 KVM概述</h2><p>可加载的内核模块kvm.ko以及硬件支持模块，例如：kvm_intel<br>KVM（把Host OS变成VMM，也就是Hypervisor，提供CPU和内存的虚拟化接口）+QEMU（模拟其他所有设备）+libvirt（用户对虚拟机的管理工具） = 目前主流的虚拟化技术<br>KVM：模拟CPU和内存，它是在宿主机上的<br>QEMU：模拟/                  仿真其他设备，本身就是一个独立的软件，被KVM所依赖使用，它是在客户机上使用的<br>virtio：半虚拟化技术模拟磁盘I/O，比QEMU模拟的磁盘I/O快而被使用<br>libvirt：针对各种虚拟化平台的虚拟机管理API库，virsh、virt-install、virt-manager和云计算框架都在底层使用libvirt，libvirt包括三部分：API库、守护进程libvirtd和一个命令行工具virsh<br>红帽官网对KVM的介绍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KVM介绍</span><br><span class="line">https:&#x2F;&#x2F;www.redhat.com&#x2F;zh&#x2F;topics&#x2F;virtualization&#x2F;what-is-KVM</span><br><span class="line">KVM的教程</span><br><span class="line">https:&#x2F;&#x2F;access.redhat.com&#x2F;documentation&#x2F;zh-cn&#x2F;red_hat_enterprise_linux&#x2F;7&#x2F;html&#x2F;virtualization_getting_started_guide&#x2F;index</span><br><span class="line">在红帽上使用KVM安装虚拟机的个数限制</span><br><span class="line">https:&#x2F;&#x2F;access.redhat.com&#x2F;articles&#x2F;rhel-kvm-limits</span><br></pre></td></tr></table></figure>
<p>KVM工作模式：<br>    模拟和仿真：QEMU-KVM<br>    半虚拟化设备，性能好：virtio，需要在客户机上安装<br>    透传物理主机设备，性能好，但迁移受到影响：之间使用USB</p>
<p>KVM集中管理平台：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.linux-kvm.org&#x2F;page&#x2F;Management_Tools</span><br></pre></td></tr></table></figure>
<p>OpenStack：开源，主流，复杂<br>Porxmox vritualization environment：免费，简单</p>
<h2 id="2-2-KVM宿主机环境准备"><a href="#2-2-KVM宿主机环境准备" class="headerlink" title="2.2 KVM宿主机环境准备"></a>2.2 KVM宿主机环境准备</h2><p>因为是做实验，使用虚拟机跑虚拟机，因此我们的虚拟机需要开启CPU支持，Inter-VT或者AMD-V</p>
<p>验证开启虚拟化的方法，只要能搜出内容就是支持<br><code>lsmod | grep kvm</code></p>
<p><code>grep -Em 1 &quot;vmx|svm&quot; /proc/cpuinfo</code></p>
<p><code>ll /dev/kvm</code></p>
<h2 id="KVM工具包介绍"><a href="#KVM工具包介绍" class="headerlink" title="KVM工具包介绍"></a>KVM工具包介绍</h2><ul>
<li>   qemu-kvm：为kvm提供底层仿真支持</li>
<li>   libvirt-daemon：libvirtd守护进程，管理虚拟机</li>
<li>   libvirt-client：用户端软件，提供客户端管理命令</li>
<li>   libvirt-daemon-driver-qemu：libvirtd连接qemu的驱动</li>
<li>   libvirt：使用最多的KVM虚拟机管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机，libvirt是KVM通用的访问API，它不但能管理KVM，还能管理VMware、Xen、Hyper-V、VirtualBox</li>
<li>   virt-manager：图形界面虚拟机管理工具，它通过底层调用libvirt实现对虚拟机的管理功能</li>
<li>   virt-install：命令行虚拟机安装工具</li>
<li>   virsh：命令行形式的虚拟机管理工具</li>
<li>   virt-viewer：通过VNC和SPICE协议显示虚拟机图形控制台的最小工具，软件包是virtviewer</li>
<li>   cockpit：Centos8提供的基于Web的虚拟机管理界面</li>
</ul>
<h3 id="libvirt包"><a href="#libvirt包" class="headerlink" title="libvirt包"></a>libvirt包</h3><p>一个调用KVM接口或其他虚拟化技术接口的API工具包，为用户空间的应用程序提供API</p>
<h3 id="安装KVM相关包"><a href="#安装KVM相关包" class="headerlink" title="安装KVM相关包"></a>安装KVM相关包</h3><p>1.qemu-kvm，提供虚拟机除了CPU和内存之外硬件的模拟功能<br>2.libvirt，调用KVM接口，为虚拟机管理软件提供API<br>3.virt-manager,virt-install，虚拟机管理软件<br>4.Centos8还提供了一个Web管理虚拟机的软件，cockpit，启动服务后，浏览器方位<a href="http://localhost:9090；我没装上">http://localhost:9090；我没装上</a><br>5.Ubuntu安装KVM的包：qemu-kvm vir-manager libvirt-daemon-system；使用kvm-ok进行验证</p>
<p>使用X11 server的方法：</p>
<p>1.export DISPLAY=10.0.0.2:0.0<br>2.在Linux上使用一个需要图形的软件，比如virt-manager<br>3.这时候在Windows上就可以看到Linux上的软件的图形了</p>
<p>安装完libvirt后，会生成一个virbr0网卡，类似VMware上的VMNet8网卡，充当虚拟机的NAT网卡，还有一个virbr0-nic，它是代表桥接到virbr0上的网卡，每当开启一个虚拟机，都会生成一个vir网卡，并且桥接在virbr0网卡上</p>
<h3 id="准备ISO文件"><a href="#准备ISO文件" class="headerlink" title="准备ISO文件"></a>准备ISO文件</h3><p>创建一个文件夹专门存放ISO<br><code>mkdir -p /data/isos</code></p>
<h1 id="3-创建虚拟机"><a href="#3-创建虚拟机" class="headerlink" title="3 创建虚拟机"></a>3 创建虚拟机</h1><p>使用MobaXterm软件！！！，我的xshell的x11server转发可能是有问题导致的卡死<br>使用干净的主机！<br>重启大法<br>创建虚拟机的方法大概是：</p>
<ul>
<li>   使用virt-manager图形化安装，这样的方式慢，需要人工值守</li>
<li>   使用virt-install命令行安装，配合kickstart文件，可以快速安装<br>图形化连接guest的方法：</li>
<li>   使用virt-manger,virt-viewer，连接方式是spice</li>
<li>   使用VNC连接，需要查看不同guest运行时的不同的VNC端口，大概是5900+</li>
</ul>
<h2 id="3-1-使用virt-manager图形化安装"><a href="#3-1-使用virt-manager图形化安装" class="headerlink" title="3.1 使用virt-manager图形化安装"></a>3.1 使用virt-manager图形化安装</h2><p>systemctl enable –now libvirtd<br>打开virt-manager，然后选择镜像，安装<br>查看虚拟机网络配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@LAMP2 ~]$cat &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;networks&#x2F;default.xml</span><br></pre></td></tr></table></figure>

<h2 id="3-2-使用virt-install命令行安装"><a href="#3-2-使用virt-install命令行安装" class="headerlink" title="3.2 使用virt-install命令行安装"></a>3.2 使用virt-install命令行安装</h2><p>通过命令行的安装适合批量操作，而且节省磁盘文件，因为qemu创建的虚拟磁盘是根据实际需求来占用真实磁盘空间的，比如要求20G的虚拟磁盘，实际占用1 ~ 2 G，而使用virt-manager创建的虚拟机会实际占用20G真实磁盘空间<br>virt-install –help 安装选项<br>qemu-img create  创建一个虚拟磁盘<br>osinfo-query os  查看支持的OS版本</p>
<h3 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h3><p>使用virt-install的步骤：<br>首先通过osinfo-query os 查看支持的系统版本，然后通过qemu-img创建一个虚拟磁盘，最后通过virt-install把镜像安装到指定的虚拟磁盘上去</p>
<p>qemu-img的选项说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8-1.qcow2 20G</span><br><span class="line"></span><br><span class="line">create：创建一个虚拟磁盘</span><br><span class="line">-f：指定磁盘格式</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8.qcow2：磁盘路径</span><br><span class="line">20G：指定虚拟磁盘大小</span><br></pre></td></tr></table></figure>

<p>virt-install的选项说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm --name centos8-1 --ram 1024 --vcpus 2 --cdrom&#x3D;&#x2F;data&#x2F;isos&#x2F;CentOS-8.2.2004-x86_64-dvd1.iso --disk path&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8-1.qcow2 --network network&#x3D;default --graphics vnc,listen&#x3D;0.0.0.0 --noautoconsole --os-variant&#x3D;centos8</span><br><span class="line"></span><br><span class="line">--virt-type：Hypervisor name to use (kvm, qemu, xen, ...)</span><br><span class="line">--name：指定虚拟机名称</span><br><span class="line">--ram：指定分配给虚拟机的内存大小</span><br><span class="line">--vcpus：Number of vcpus to configure for your guest</span><br><span class="line">--cdrom：CD-ROM installation media</span><br><span class="line">--disk：Specify storage with various options. 后面跟着的path就是指定磁盘路径</span><br><span class="line">--network：Configure a guest network interface  default就是默认模式，network一共有bridge、network、none、name几个选项</span><br><span class="line">--graphics：指定guest被什么类型的图形化连接</span><br><span class="line">--noautoconsole：不自动连接guest</span><br><span class="line">--os-variant：指定guest系统类型，比如centos8，win10</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用kickstart自动化安装"><a href="#使用kickstart自动化安装" class="headerlink" title="使用kickstart自动化安装"></a>使用kickstart自动化安装</h3><p>步骤是一样的，只是在virt-install命令中的参数不同，多了指向ks文件的选项，同时也需要提前在局域网中搭建一个Http服务，用于提供ks文件，记得文件的权限中要有可读</p>
<p>先生成虚拟磁盘文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8_3.qcow2 20G</span><br></pre></td></tr></table></figure>
<p>再使用virt-install安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm --name centos8_3 --ram 8192 --vcpus 8 --disk path&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8_3.qcow2 --network network&#x3D;default --graphics vnc,listen&#x3D;0.0.0.0 --location&#x3D;&#x2F;data&#x2F;isos&#x2F;CentOS-8.2.2004-x86_64-minimal.iso --extra-args&#x3D;&quot;ks&#x3D;http:&#x2F;&#x2F;10.0.0.7&#x2F;centos8.conf&quot;</span><br></pre></td></tr></table></figure>
<p>ks文件是我先手工安装了一个，然后把anaconda文件拷贝出来，修改了一下vda，因为直接写vda会报错，不太清楚为什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#version&#x3D;RHEL8</span><br><span class="line">#ignoredisk --only-use&#x3D;vda</span><br><span class="line"># System bootloader configuration</span><br><span class="line">bootloader --append&#x3D;&quot; crashkernel&#x3D;auto&quot; --location&#x3D;mbr #--boot-drive&#x3D;vda</span><br><span class="line">autopart --type&#x3D;lvm</span><br><span class="line"># Partition clearing information</span><br><span class="line">clearpart --linux --initlabel #--drives&#x3D;vda</span><br><span class="line"># Use text mode install</span><br><span class="line">text</span><br><span class="line"># Use CDROM installation media</span><br><span class="line">cdrom</span><br><span class="line"># Keyboard layouts</span><br><span class="line">keyboard --vckeymap&#x3D;us --xlayouts&#x3D;&#39;&#39;</span><br><span class="line"># System language</span><br><span class="line">lang en_US.UTF-8</span><br><span class="line"></span><br><span class="line"># Network information</span><br><span class="line">network  --bootproto&#x3D;dhcp --device&#x3D;enp1s0 --onboot&#x3D;on --ipv6&#x3D;auto --no-activate</span><br><span class="line">network  --hostname&#x3D;localhost.localdomain</span><br><span class="line">repo --name&#x3D;&quot;Minimal&quot; --baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;run&#x2F;install&#x2F;repo&#x2F;Minimal</span><br><span class="line"># Root password</span><br><span class="line">rootpw --iscrypted $6$h.Rq28GBTxyMGx31$VDCuSzoEw1lMH7rGnWemEDp9.utp4aZLVVUF0PSZXUycWSE6Lkk1ryIP.K91fqSMELvScnaGGPx34IjC0fQ&#x2F;J0</span><br><span class="line"># Run the Setup Agent on first boot</span><br><span class="line">firstboot --enable</span><br><span class="line"># Do not configure the X Window System</span><br><span class="line">skipx</span><br><span class="line"># System services</span><br><span class="line">services --enabled&#x3D;&quot;chronyd&quot;</span><br><span class="line"># System timezone</span><br><span class="line">timezone America&#x2F;New_York --isUtc</span><br><span class="line">reboot</span><br><span class="line">%packages</span><br><span class="line">@^minimal-environment</span><br><span class="line">kexec-tools</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump --enable --reserve-mb&#x3D;&#39;auto&#39;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后还是使用virt-manager去观察</p>
<h3 id="使用现有的虚拟机文件直接复制一份，然后使用virt-install或者virt-manager导入就行"><a href="#使用现有的虚拟机文件直接复制一份，然后使用virt-install或者virt-manager导入就行" class="headerlink" title="使用现有的虚拟机文件直接复制一份，然后使用virt-install或者virt-manager导入就行"></a>使用现有的虚拟机文件直接复制一份，然后使用virt-install或者virt-manager导入就行</h3><p>虚拟机会生成一个配置文件，要修改硬件配置，只需要改配置文件就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@LAMP2 qemu]$ll &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F; </span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x 2 root root   27 Nov  7 18:49 autostart</span><br><span class="line">-rw------- 1 root root 5411 Nov  7 18:26 centos8_1.xml</span><br><span class="line">-rw------- 1 root root 3595 Nov  7 20:24 centos8_3.xml</span><br><span class="line">-rw------- 1 root root 5711 Nov  7 19:57 centos8.xml</span><br><span class="line">drwx------ 3 root root   42 Nov  7 09:49 networks</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-管理虚拟机"><a href="#4-管理虚拟机" class="headerlink" title="4 管理虚拟机"></a>4 管理虚拟机</h1><h2 id="4-1-使用半虚拟化驱动-virtio"><a href="#4-1-使用半虚拟化驱动-virtio" class="headerlink" title="4.1 使用半虚拟化驱动 virtio"></a>4.1 使用半虚拟化驱动 virtio</h2><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201111095822937.png" alt="image-20201111095822937"></p>
<p>kvm+qemu+guest的写入磁盘工作流程:<br>guest的应用程序发起–&gt;调用guest的驱动–&gt;调用宿主机cpu和内存(即调用KVM虚拟的cpu和内存)–&gt;调用guest的磁盘I/O等设备(qemu虚拟出来的硬件)–&gt;调用宿主机的硬件驱动–&gt;写入磁盘</p>
<p>使用了半虚拟化驱动virtio后写入磁盘的工作流程：<br>guest的应用程序发起–&gt;virtio驱动传输–&gt;virtio模拟的设备(scsi控制器、网卡)以及qemu模拟的设备–&gt;调用宿主机的硬件驱动–&gt;写入磁盘</p>
<p>Linux支持，Windows需要额外下载后安装驱动<br>Windows下获取驱动的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;fedorapeople.org&#x2F;groups&#x2F;virt&#x2F;virtio-win&#x2F;direct-downloads&#x2F;archive-virtio&#x2F;virtio-win-0.1.185-2&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-安装QEMU-guest-agent功能"><a href="#4-2-安装QEMU-guest-agent功能" class="headerlink" title="4.2 安装QEMU guest agent功能"></a>4.2 安装QEMU guest agent功能</h2><p>一个优化虚拟机的软件<br>安装方法：<br>centos：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install qemu-guest-agent</span><br></pre></td></tr></table></figure>
<p>Windows需要自己找软件下载</p>
<h1 id="5"><a href="#5" class="headerlink" title="5"></a>5</h1><h2 id="5-1-libvirt-架构"><a href="#5-1-libvirt-架构" class="headerlink" title="5.1 libvirt 架构"></a>5.1 libvirt 架构</h2><p>基于libvirtd（守护进程），virsh,virt-install,virt-manager可以使用–&gt;发送信息给qemu-kvm（调用guest）–&gt;/dev/kvm/–&gt;KVM kernel module（内核）</p>
<h2 id="5-2-virt-manager-管理虚拟机"><a href="#5-2-virt-manager-管理虚拟机" class="headerlink" title="5.2 virt-manager 管理虚拟机"></a>5.2 virt-manager 管理虚拟机</h2><p>虚拟机的迁移，需要事先把虚拟机文件放在NFS共享文件夹中</p>
<h2 id="5-3-virsh命令"><a href="#5-3-virsh命令" class="headerlink" title="5.3 virsh命令"></a>5.3 virsh命令</h2><p>virsh有两种工作模式：</p>
<ul>
<li>   交互模式</li>
<li>   非交互模式<br>virsh list</li>
</ul>
<p>virsh主要功能</p>
<p>virsh help</p>
<p>virsh启动和关闭虚拟机<br>virsh shutdown<br>virsh list –uuid –name<br>virsh start </p>
<p>强制关机<br>virsh destory</p>
<p>暂停和恢复虚拟机</p>
<p>virsh suspend </p>
<p>virsh resume</p>
<p>查看虚拟机参数</p>
<p>virsh dump</p>
<p>删除虚拟机</p>
<p>virsh undefined</p>
<p>配置虚拟机自动启动</p>
<p>virsh autostart<br>virsh autostart –disable</p>
<p>ll /etc/libvirt/qemu/autostart/</p>
<p>今日重点：</p>
<blockquote>
<p>虚拟化的发展过程<br>仿真（QEMU）–&gt;软件辅助全虚拟化–&gt;半虚拟化（XEN）–&gt;硬件辅助全虚拟化（KVM）<br>KVM的搭建，virtio<br>工具的使用</p>
</blockquote>
<p>桥接是什么？把两个局域网（两个网段）的主机通过数据链路层连接起来<br>冲突域是什么？<br>广播域是什么？<br>一个IP地址的掩码是32位意味着什么？其他人怎么访问它？</p>
<h1 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h1><h2 id="KVM存储模式"><a href="#KVM存储模式" class="headerlink" title="KVM存储模式"></a>KVM存储模式</h2><p>存储池、存储卷<br>libvirt以存储池的形式对存储进行统一管理、简化操作<br>virsh和virt-manager是功能相近的命令行/图形化的对虚拟机进行管理的工具</p>
<p>存储模式分类：<br>1.基于文件系统的存储：</p>
<ul>
<li>   dir：Filesystem Directory 需要有挂载点的文件系统</li>
<li>   fs：Pre-Formatted Block Device 无需挂载的文件系统，如位于SAN存储的文件系统，可以支持多个主机同时访问，而本地文件系统不支持</li>
<li>   netfs：Network Exported Directory 网络文件系统，比如：NFS，SAMBA</li>
</ul>
<p>2.基于设备的存储<br>无需文件系统，性能更好，但可管理性差，无法实现快照</p>
<ul>
<li>   Disk：Physical Disk Device</li>
<li>   Iscsi：iscsi target</li>
<li>   Logical：LVM Volume Group</li>
</ul>
<h2 id="虚拟磁盘类型"><a href="#虚拟磁盘类型" class="headerlink" title="虚拟磁盘类型"></a>虚拟磁盘类型</h2><ul>
<li><p> 固定Fixed<br>  在配置时，指定磁盘大小，不管在磁盘中实际占用多少，都占用相同大小的空间</p>
</li>
<li><p> 动态Dynamic<br>  刚创建出来很小，随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间</p>
</li>
<li><p> 差异Difference<br>  因为创建是差异磁盘，所以只保存变更的数据</p>
</li>
</ul>
<h2 id="虚拟镜像文件格式"><a href="#虚拟镜像文件格式" class="headerlink" title="虚拟镜像文件格式"></a>虚拟镜像文件格式</h2><p>镜像文件存储在主机文件系统中，它可以存储在本地文件系统中，如ext4或xfs；或网络文件系统中，如NFS。<br>例如libguestfs这样的工具，能管理、备份及监控文件，KVM上的磁盘镜像格式包括：</p>
<ul>
<li>   raw：<br>默认的磁盘格式，它不是一种真正的磁盘格式，而是代表虚拟机所使用的原始镜像，它性能好，但是占用空间大。<br>raw可以是预分配（pre-allocated）或稀疏（sprase），预分配和稀疏的区别就是在真实磁盘上占用的空间是不是连续的。</li>
<li>   cow：copy-on-write，昙花一现</li>
<li>   qcow：过渡性方案</li>
<li>   qcow2：<br>提供快照、压缩及加密等高级镜像功能，它按需分配磁盘空间，不管文件系统是否支持<br>优点是空间节约，功能丰富；缺点是性能较差</li>
<li>   vmdk：VMware默认使用的磁盘格式</li>
<li>   vhd：微软默认使用的文件格式</li>
<li>   vdi：VirtualBox采用的文件格式<br>使用<code>qemu-img --help | grep Support</code> 查看支持的格式</li>
</ul>
<h2 id="使用qemu-img管理虚拟磁盘文件"><a href="#使用qemu-img管理虚拟磁盘文件" class="headerlink" title="使用qemu-img管理虚拟磁盘文件"></a>使用qemu-img管理虚拟磁盘文件</h2><p>qemu-img是一个功能强大的磁盘镜像管理工具</p>
<h3 id="创建虚拟磁盘文件"><a href="#创建虚拟磁盘文件" class="headerlink" title="创建虚拟磁盘文件"></a>创建虚拟磁盘文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create [options]</span><br></pre></td></tr></table></figure>
<p>查看磁盘文件的详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img info xxx</span><br></pre></td></tr></table></figure>
<p>raw的非稀疏文件和稀疏文件<br>非稀疏文件：文件大小和实际占用空间相同<br>稀疏文件：文件大小和实际占用空间不同</p>
<p>磁盘预分配策略<br>raw文件的预分配策略和文件系统是否支持有关，而qcow2与文件系统无关<br>预分配策略</p>
<ul>
<li>   off：默认，即不使用预分配策略，不算稀疏，生成的磁盘文件很小，随着使用，磁盘文件会变大</li>
<li>   metadata：只预分配元数据，预分配后的磁盘文件属于稀疏映像类型</li>
<li>   falloc：分配文件的块并标识他们的状态为位初始化，即只分配空间，但不置零，预分配后的虚拟磁盘属于非稀疏映像类型，相对于full模式，创建虚拟磁盘的速度要快相当于vmware中的磁盘置备选项：厚置备延迟置零</li>
<li>   full：分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏，创建最慢，相当于vmware中的磁盘置备选项：厚置备置零<br>举例：使用不同的模式创建磁盘文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">第一种：默认模式，其实就是off</span><br><span class="line">qemu-img create -f qcow2 test1.qcow2 1g</span><br><span class="line">第二种：写明使用off</span><br><span class="line">qemu-img create -f qcow2 test2.qcow2 1g -o preallocation&#x3D;off</span><br><span class="line">第三种：metadata模式，只预分配元数据，其他数据不分配</span><br><span class="line">qemu-img create -f qcow2 test3.qcow2 1g -o preallocation&#x3D;metadata</span><br><span class="line">第四种：falloc，磁盘空间占用了，但是其实空间中是空的</span><br><span class="line">qemu-img create -f qcow2 test4.qcow2 1g -o preallocation&#x3D;falloc</span><br><span class="line">第五种：full，实打实的占用</span><br><span class="line">qemu-img create -f qcow2 test5.qcow2 1g -o preallocation&#x3D;full</span><br><span class="line"></span><br><span class="line">把他们上面四种（默认和off是一样的）的空间大小对比一下</span><br><span class="line">[root@centos8 ~]$ll -h</span><br><span class="line">total 2.1G</span><br><span class="line">-rw-r--r-- 1 root root 193K Nov  9 21:15 test1.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Nov  9 21:19 test2.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Nov  9 21:24 test3.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Nov  9 21:25 test4.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Nov  9 21:27 test5.qcow2</span><br><span class="line">上面的4种模式，只有metadata(test3文件)是虚的，文件系统占用了1个G，但是使用磁盘占用工具du -h 查看，就只有八百多K</span><br><span class="line">使用qemu-img info 工具查看，也很明显的能看到</span><br></pre></td></tr></table></figure>
<h3 id="后备差异虚拟磁盘"><a href="#后备差异虚拟磁盘" class="headerlink" title="后备差异虚拟磁盘"></a>后备差异虚拟磁盘</h3>性能差，多个虚拟机共同使用一套磁盘文件<br>概念上与链接克隆类似</li>
</ul>
<h3 id="虚拟磁盘的格式转换"><a href="#虚拟磁盘的格式转换" class="headerlink" title="虚拟磁盘的格式转换"></a>虚拟磁盘的格式转换</h3><p>qemu-img可以将不同格式的虚拟磁盘进行格式转换<br>比如将vmdk格式转换为qcow2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert centos8.vmdk centos8.qcow2</span><br><span class="line">[root@centos8 isos]$ll -h</span><br><span class="line">total 7.8G</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1.1G Nov 10  2020  CentOS-7-x86_64-Minimal-2003.iso</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1.7G Nov 10  2020  CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">-rw-r--r-- 1 root root 200G Nov  9 21:48  centos8-3.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 2.7G Nov  9 21:44 &#39;CentOS 8-cl1.vmdk&#39;</span><br><span class="line"></span><br><span class="line">[root@centos8 isos]$du -h .&#x2F;*</span><br><span class="line">1.1G    .&#x2F;CentOS-7-x86_64-Minimal-2003.iso</span><br><span class="line">1.7G    .&#x2F;CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">2.6G    .&#x2F;centos8-3.qcow2</span><br><span class="line">2.7G    .&#x2F;CentOS 8-cl1.vmdk</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="调整虚拟磁盘大小"><a href="#调整虚拟磁盘大小" class="headerlink" title="调整虚拟磁盘大小"></a>调整虚拟磁盘大小</h3><p>注意事项：</p>
<ul>
<li>   操作之前一定要备份！缩减更要备份!</li>
<li>   增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行一些操作，才能真正让客户机使用到增加后的镜像空间</li>
<li>   xfs文件系统类型不支持缩减</li>
<li>   qcow2不支持缩小镜像操作<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img resize [--shrink] filename [+|-] size</span><br></pre></td></tr></table></figure>
逻辑卷的添加过程：<br>下载软件包：<code>yum install lvm2</code><br>pvs<br>vgs<br>lvs</li>
</ul>
<p>1.把分区变成lvm格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fdisk &#x2F;dev&#x2F;vda&#x2F;</span><br><span class="line">t</span><br><span class="line">8e #意思是分区是Linux LVM</span><br></pre></td></tr></table></figure>
<p>2.把分区变成pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pvcreate &#x2F;dev&#x2F;vda3</span><br><span class="line">#物理卷删除</span><br><span class="line">pvremove &#x2F;dev&#x2F;vda3</span><br></pre></td></tr></table></figure>
<p>3.添加进vg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#创建新的vg</span><br><span class="line">vgcreate vg1 &#x2F;dev&#x2F;vda3</span><br><span class="line">#扩展vg</span><br><span class="line">vgextend vg1 &#x2F;dev&#x2F;vda3</span><br><span class="line">#缩减vg</span><br><span class="line">vgreduce vg1 &#x2F;dev&#x2F;vda3</span><br><span class="line">#删除vg，注意要先使用pvmove，再使用vgremove</span><br><span class="line">vgremove vg1</span><br></pre></td></tr></table></figure>
<p>4.添加进lv，同时扩展文件系统大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#下面的方法是一步操作，既增加了逻辑卷，把文件系统也扩展了</span><br><span class="line">lvresize -r -l +100%free &#x2F;dev&#x2F;vda3&#x2F;lv3</span><br><span class="line">#下面是分步操作</span><br><span class="line">1.扩展lvm的空间</span><br><span class="line">lvextend -L + 100G &#x2F;dev&#x2F;vg1&#x2F;LV_name </span><br><span class="line">2.扩展文件系统大小</span><br><span class="line">#针对ext4的文件系统</span><br><span class="line">resize2fs &#x2F;dev&#x2F;VG_NAME&#x2F;LV_NAME</span><br><span class="line">#针对xfs</span><br><span class="line">xfs_growfs mountpoint</span><br><span class="line"></span><br><span class="line">#逻辑卷的普通操作</span><br><span class="line">lvcreate -L 100G -n LV_NAME VG_NAME</span><br></pre></td></tr></table></figure>

<h2 id="磁盘快照"><a href="#磁盘快照" class="headerlink" title="磁盘快照"></a>磁盘快照</h2><h3 id="磁盘快照分类"><a href="#磁盘快照分类" class="headerlink" title="磁盘快照分类"></a>磁盘快照分类</h3><p>快照分类：</p>
<ul>
<li>   磁盘分类：对磁盘数据快照，用于虚拟机备份</li>
<li>   内存快照：对虚拟机的内存/设备信息进行保存，用于迁移，使用virsh save实现，只能对运行的虚拟机进行</li>
<li>   检查点checkpoint快照：同时保存磁盘和内存，保证数据一致性 </li>
</ul>
<p>按快照信息保存分为：</p>
<ul>
<li>   内置快照：快照信息和qcow2磁盘文件一个文件存放</li>
<li>   外置快照：快照是一个单独的qcow2文件</li>
</ul>
<p>按虚拟机运行状态分为：</p>
<ul>
<li>   关机态快照</li>
<li>   运行态快照<br>按磁盘数量可以分为：</li>
<li>   单盘</li>
<li>   多盘，涉及原子性</li>
</ul>
<h3 id="qemu-img-snapshot"><a href="#qemu-img-snapshot" class="headerlink" title="qemu-img snapshot"></a>qemu-img snapshot</h3><p>需要关闭虚拟机后操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#列出某个磁盘文件的快照</span><br><span class="line">qemu-img snapshot -l [snapshot_name] file_name</span><br><span class="line">#给某个磁盘文件生成快照，需要关闭虚拟机操作</span><br><span class="line">qemu-img snapshot -c snapshot_name file_name </span><br><span class="line">#给某个磁盘文件应用快照</span><br><span class="line">qemu-img snapshot -a snapshot_name file_name</span><br><span class="line">#删除某个磁盘文件的快照</span><br><span class="line">qemu-img snapshot -d </span><br></pre></td></tr></table></figure>
<h4 id="对虚拟机做快照，使用virsh"><a href="#对虚拟机做快照，使用virsh" class="headerlink" title="对虚拟机做快照，使用virsh"></a>对虚拟机做快照，使用virsh</h4><p>可以开机拍快照</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#创建一个快照</span><br><span class="line">virsh snapshot-create system_name</span><br><span class="line">#列出快照</span><br><span class="line">virsh snapshot-list system_name</span><br><span class="line">#还原快照</span><br><span class="line">virsh snapshot-revert  centos8 --snapshotname&#x3D;1605003503</span><br></pre></td></tr></table></figure>


<h2 id="存储池"><a href="#存储池" class="headerlink" title="存储池"></a>存储池</h2><p>libvirt可以以存储池的形式对存储进行统一管理、简化操作<br>对于虚拟机操作，存储池和存储卷不是必须的；一个存储池中可以有多个存储卷<br>使用virsh命令管理存储池，或者使用virt-manager图形化管理存储池</p>
<h3 id="显示存储池信息"><a href="#显示存储池信息" class="headerlink" title="显示存储池信息"></a>显示存储池信息</h3><p>virsh command –help<br>存储池相关配置文件在<br><code>/etc/libvirt/storage/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-list</span><br><span class="line">virsh pool-list --all</span><br><span class="line">virsh pool-list --uuid</span><br><span class="line">virsh pool-info pool_name</span><br></pre></td></tr></table></figure>

<p>存储池的分类，在命令行上的区别就是 –dir,–source-dev</p>
<h3 id="基于目录的存储池"><a href="#基于目录的存储池" class="headerlink" title="基于目录的存储池"></a>基于目录的存储池</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define-as pool_name --dir &#x2F;path&#x2F;to&#x2F;file</span><br><span class="line">virsh pool-start pool_name</span><br><span class="line">virsh pool-destory --pool pool_name #停止存储池</span><br><span class="line">virsh pool-delete --pool pool_name  #删除存储池文件目录</span><br><span class="line">#存储池的xml文件还没有删除</span><br><span class="line">virsh pool-undefine --pool pool_name #这个是删除存储池xml文件</span><br></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#先生成定义文件</span><br><span class="line">[root@centos8 images]$virsh pool-define-as vm_images dir --target &#x2F;data&#x2F;pool_1&#x2F;</span><br><span class="line">Pool vm_images defined</span><br><span class="line">[root@centos8 images]$virsh pool-list --all</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"> vm_images            inactive   no</span><br><span class="line">#启动存储池</span><br><span class="line">[root@centos8 images]$virsh pool-start vm_images</span><br><span class="line">Pool vm_images started</span><br><span class="line"></span><br><span class="line">[root@centos8 images]$virsh pool-list</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"> vm_images            active     no</span><br><span class="line">[root@centos8 images]$ll &#x2F;etc&#x2F;libvirt&#x2F;storage&#x2F;</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root  41 Nov 10 17:24 autostart</span><br><span class="line">-rw------- 1 root root 538 Nov 10 17:21 default.xml</span><br><span class="line">-rw------- 1 root root 519 Nov 10 17:24 isos.xml</span><br><span class="line">-rw------- 1 root root 531 Nov 10 18:30 vm_images.xml</span><br><span class="line">#使用virt-manager此时就能在存储那看到多了一个存储池</span><br><span class="line"></span><br><span class="line">#删除存储池</span><br><span class="line">#先停止</span><br><span class="line">virsh pool-destroy --pool vm_images</span><br><span class="line">#再删除数据目录</span><br><span class="line">virsh pool-delete --pool vm_images</span><br><span class="line">#还得删除定义</span><br><span class="line">virsh pool-undefine --pool vm_images</span><br><span class="line">#这个时候，存储池的数据目录也被删除了，配置文件也被删除了</span><br></pre></td></tr></table></figure>
<h3 id="基于文件系统的存储池"><a href="#基于文件系统的存储池" class="headerlink" title="基于文件系统的存储池"></a>基于文件系统的存储池</h3><p>1.准备分区并给分区创建文件系统<br>2.准备存储池的挂载点<br>3.创建分区的存储池</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define-as vm_images_fs fs --source-dev &quot;&#x2F;dev&#x2F;xxx&quot; --target &quot;&#x2F;vm_images&quot;</span><br></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#创建一个新的分区</span><br><span class="line">fdisk &#x2F;dev&#x2F;sda</span><br><span class="line">n</span><br><span class="line"></span><br><span class="line">+10G</span><br><span class="line"></span><br><span class="line">w</span><br><span class="line"></span><br><span class="line">创建成功</span><br><span class="line">[root@centos8 images]$lsblk</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  200G  0 disk</span><br><span class="line">├─sda1   8:1    0    1G  0 part &#x2F;boot</span><br><span class="line">├─sda2   8:2    0  100G  0 part &#x2F;</span><br><span class="line">├─sda3   8:3    0   50G  0 part &#x2F;data</span><br><span class="line">├─sda4   8:4    0    1K  0 part</span><br><span class="line">├─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">├─sda6   8:6    0    1M  0 part</span><br><span class="line">└─sda7   8:7    0   10G  0 part</span><br><span class="line">sr0     11:0    1 1024M  0 rom</span><br><span class="line"></span><br><span class="line">#给新创建的sda7创建文件系统</span><br><span class="line">[root@centos8 images]$mkfs.ext4 &#x2F;dev&#x2F;sda7</span><br><span class="line">[root@centos8 images]$lsblk -lf</span><br><span class="line">NAME FSTYPE LABEL UUID                                 MOUNTPOINT</span><br><span class="line">sda</span><br><span class="line">sda1 ext4         26dbae7b-2ad4-4a96-97ec-48e343249d70 &#x2F;boot</span><br><span class="line">sda2 xfs          139e57fe-ff2f-4cc6-9279-5d073c558a92 &#x2F;</span><br><span class="line">sda3 xfs          20aad351-436f-4446-ad61-97ccba34bdcf &#x2F;data</span><br><span class="line">sda4</span><br><span class="line">sda5 swap         c988289a-5120-43a1-9ff4-a2079294d345 [SWAP]</span><br><span class="line">sda6</span><br><span class="line">sda7 ext4         361de4d5-39c3-4341-b735-8c7bef6e20d9</span><br><span class="line">sr0</span><br><span class="line"></span><br><span class="line">#创建存储池定义</span><br><span class="line">[root@centos8 images]$virsh pool-define-as vm_images_fs fs --source-dev &quot;&#x2F;dev&#x2F;sda7&quot; --target &quot;&#x2F;data&#x2F;vm_images&quot;</span><br><span class="line">#target后面跟的是文件夹，这个文件夹不需要手动创建，下面的命令可以自动生成</span><br><span class="line">#构建存储池</span><br><span class="line">[root@centos8 images]$virsh pool-build vm_images_fs</span><br><span class="line">#开启存储池</span><br><span class="line">[root@centos8 images]$virsh pool-start vm_images_fs</span><br><span class="line">Pool vm_images_fs started</span><br><span class="line">#开启存储池的开机自启动</span><br><span class="line">[root@centos8 images]$virsh pool-autostart vm_images_fs</span><br><span class="line">Pool vm_images_fs marked as autostarted</span><br><span class="line">#这个时候就可以看到，分区已经挂载了</span><br><span class="line">[root@centos8 images]$df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        3.8G     0  3.8G   0% &#x2F;dev</span><br><span class="line">tmpfs           3.9G     0  3.9G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           3.9G  9.2M  3.8G   1% &#x2F;run</span><br><span class="line">tmpfs           3.9G     0  3.9G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sda2       100G   24G   77G  24% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda3        50G  2.0G   48G   4% &#x2F;data</span><br><span class="line">&#x2F;dev&#x2F;sda1       976M  135M  775M  15% &#x2F;boot</span><br><span class="line">tmpfs           779M   16K  779M   1% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">&#x2F;dev&#x2F;sda7       9.8G   37M  9.3G   1% &#x2F;data&#x2F;vm_images</span><br><span class="line"></span><br><span class="line">#在virt-manager中也可以看到多了一个存储池</span><br><span class="line"></span><br><span class="line">#存储池的删除</span><br><span class="line">[root@centos8 images]$virsh pool-destroy vm_images_fs</span><br><span class="line">[root@centos8 images]$virsh pool-delete vm_images_fs</span><br><span class="line">[root@centos8 images]$virsh pool-undefine vm_images_fs</span><br><span class="line">#这个时候就删除完成了</span><br></pre></td></tr></table></figure>
<p>这个是同步磁盘分区命令，如果创建完分区没显示，就用一用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">partprobe</span><br></pre></td></tr></table></figure>

<h3 id="基于磁盘的存储池"><a href="#基于磁盘的存储池" class="headerlink" title="基于磁盘的存储池"></a>基于磁盘的存储池</h3><p>创建前需要添加一个新的磁盘<br>规定磁盘的格式，MBR|GPT<br>使用XML文件定义存储池</p>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#添加硬盘，然后需要使用扫描，让系统识别</span><br><span class="line">for i in &#x2F;sys&#x2F;class&#x2F;scsi_host&#x2F;host*&#x2F;scan;do echo &quot;- - -&quot; &gt; $i;done</span><br><span class="line">[root@centos8 images]$lsblk</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  200G  0 disk</span><br><span class="line">├─sda1   8:1    0    1G  0 part &#x2F;boot</span><br><span class="line">├─sda2   8:2    0  100G  0 part &#x2F;</span><br><span class="line">├─sda3   8:3    0   50G  0 part &#x2F;data</span><br><span class="line">├─sda4   8:4    0    1K  0 part</span><br><span class="line">├─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">├─sda6   8:6    0    1M  0 part</span><br><span class="line">└─sda7   8:7    0   10G  0 part</span><br><span class="line">sdb      8:16   0  200G  0 disk</span><br><span class="line">#给硬盘规定分区格式</span><br><span class="line">[root@centos8 images]$parted &#x2F;dev&#x2F;sdb mklabel gpt</span><br><span class="line">[root@centos8 images]$parted &#x2F;dev&#x2F;sdb print</span><br><span class="line">Model: VMware, VMware Virtual S (scsi)</span><br><span class="line">Disk &#x2F;dev&#x2F;sdb: 215GB</span><br><span class="line">Sector size (logical&#x2F;physical): 512B&#x2F;512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">#准备磁盘存储池对应的XML文件</span><br><span class="line">vim vm_images_disk.xml</span><br><span class="line">  1 &lt;pool type&#x3D;&#39;disk&#39;&gt;</span><br><span class="line">  2     &lt;name&gt;vm_images_disk&lt;&#x2F;name&gt;</span><br><span class="line">  3     &lt;source&gt;</span><br><span class="line">  4         &lt;device path&#x3D;&#39;&#x2F;dev&#x2F;sdb&#39;&#x2F;&gt;</span><br><span class="line">  5         &lt;format type&#x3D;&#39;gpt&#39;&#x2F;&gt;</span><br><span class="line">  6     &lt;&#x2F;source&gt;</span><br><span class="line">  7     &lt;target&gt;</span><br><span class="line">  8         &lt;path&gt;&#x2F;dev&#x2F;&lt;&#x2F;path&gt;</span><br><span class="line">  9     &lt;&#x2F;target&gt;</span><br><span class="line"> 10 &lt;&#x2F;pool&gt;</span><br><span class="line"></span><br><span class="line">#基于xml创建存储池</span><br><span class="line">[root@centos8 ~]$virsh pool-define vm_images_disk.xml</span><br><span class="line">Pool vm_images_disk defined from vm_images_disk.xml</span><br><span class="line">[root@centos8 ~]$virsh pool-start --pool vm_images_disk</span><br><span class="line">Pool vm_images_disk started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-list</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"> vm_images_disk       active     no</span><br><span class="line"></span><br><span class="line">#删除的时候，需要先停止存储池，然后删除定义，但是不能使用delete了，因为是磁盘，无法删除</span><br><span class="line">[root@centos8 ~]$virsh pool-destroy vm_images_disk</span><br><span class="line">Pool vm_images_disk destroyed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-undefine vm_images_disk</span><br><span class="line">Pool vm_images_disk has been undefined</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="基于LVM的存储池"><a href="#基于LVM的存储池" class="headerlink" title="基于LVM的存储池"></a>基于LVM的存储池</h3><p>其实是基于卷组（VG）<br>要求使用VG中的全部磁盘空间</p>
<p>创建存储池的方法：</p>
<ul>
<li>   使用现有的VG创建存储池</li>
<li>   创建新的VG创建存储池</li>
</ul>
<h4 id="原来没有逻辑卷组，直接连逻辑卷组和存储池一起创建"><a href="#原来没有逻辑卷组，直接连逻辑卷组和存储池一起创建" class="headerlink" title="原来没有逻辑卷组，直接连逻辑卷组和存储池一起创建"></a>原来没有逻辑卷组，直接连逻辑卷组和存储池一起创建</h4><p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#需要添加一个磁盘，专门用于LVM</span><br><span class="line">[root@centos8 ~]$virsh pool-define-as vm_images_lvm logical --source-dev&#x3D;&#x2F;dev&#x2F;sdb</span><br><span class="line">#构建lvm</span><br><span class="line">[root@centos8 ~]$virsh pool-build vm_images_lvm</span><br><span class="line">Pool vm_images_lvm built</span><br><span class="line">[root@centos8 ~]$pvs</span><br><span class="line">  PV         VG            Fmt  Attr PSize   PFree</span><br><span class="line">  &#x2F;dev&#x2F;sdb   vm_images_lvm lvm2 a--  &lt;20.00g &lt;20.00g</span><br><span class="line">[root@centos8 ~]$vgs</span><br><span class="line">  VG            #PV #LV #SN Attr   VSize   VFree</span><br><span class="line">  vm_images_lvm   1   0   0 wz--n- &lt;20.00g &lt;20.00g</span><br><span class="line">[root@centos8 ~]$virsh pool-start vm_images_lvm</span><br><span class="line">Pool vm_images_lvm started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-list</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"> vm_images_lvm        active     no</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="利用已存在的逻辑卷组创建存储池"><a href="#利用已存在的逻辑卷组创建存储池" class="headerlink" title="利用已存在的逻辑卷组创建存储池"></a>利用已存在的逻辑卷组创建存储池</h4><p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh pool-define-as vm_images_lvm2 logical --source-name&#x3D;vm_images_lvm</span><br><span class="line">Pool vm_images_lvm2 defined</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-start vm_images_lvm2</span><br><span class="line">Pool vm_images_lvm2 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-list --all</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"> vm_images_lvm        active     no</span><br><span class="line"> vm_images_lvm2       active     no</span><br><span class="line"></span><br><span class="line">#删除存储池</span><br><span class="line">[root@centos8 ~]$virsh pool-destroy --pool vm_images_lvm2</span><br><span class="line">[root@centos8 ~]$virsh pool-delete --pool vm_images_lvm2</span><br><span class="line">[root@centos8 ~]$virsh pool-undefine vm_images_lvm2</span><br><span class="line">Pool vm_images_lvm2 has been undefined</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="基于NFS的存储池"><a href="#基于NFS的存储池" class="headerlink" title="基于NFS的存储池"></a>基于NFS的存储池</h3><p>需要两个宿主机，一个宿主机充当NFS服务器，另一个使用NFS</p>
<h4 id="创建NFS共享"><a href="#创建NFS共享" class="headerlink" title="创建NFS共享"></a>创建NFS共享</h4><p>例子：<br>在10.0.0.18上搭建NFS服务，10.0.0.8上使用服务<br>在10.0.0.18上操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y nfs-utils</span><br><span class="line">systemctl start nfs-server.service</span><br><span class="line">mkdir -p &#x2F;data&#x2F;share</span><br><span class="line">vim &#x2F;etc&#x2F;exports</span><br><span class="line">1 &#x2F;data&#x2F;share *(rw,no_root_squash,sync,no_all_squash)</span><br><span class="line">[root@centos8 ~]$exportfs -r</span><br><span class="line">[root@centos8 ~]$exportfs -v</span><br><span class="line">&#x2F;data&#x2F;share     &lt;world&gt;(sync,wdelay,hide,no_subtree_check,sec&#x3D;sys,rw,secure,no_root_squash,no_all_squash)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="创建基于NFS的存储池"><a href="#创建基于NFS的存储池" class="headerlink" title="创建基于NFS的存储池"></a>创建基于NFS的存储池</h4><p>在10.0.0.8上操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$showmount -e 10.0.0.18</span><br><span class="line">Export list for 10.0.0.18:</span><br><span class="line">&#x2F;data&#x2F;share *</span><br><span class="line">#创建基于NFS的存储池的定义</span><br><span class="line">[root@centos8 ~]$virsh pool-define-as vm_images_nfs netfs --source-host 10.0.0.18 --source-path &#x2F;data&#x2F;share --target &#x2F;data&#x2F;vm_images_nfs</span><br><span class="line">Pool vm_images_nfs defined</span><br><span class="line">#自动生成挂载点</span><br><span class="line">[root@centos8 ~]$virsh pool-build vm_images_nfs</span><br><span class="line">Pool vm_images_nfs built</span><br><span class="line">#开启存储池后自动挂载</span><br><span class="line">[root@centos8 ~]$virsh pool-start vm_images_nfs</span><br><span class="line">Pool vm_images_nfs started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$df -h</span><br><span class="line">Filesystem             Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs               3.8G     0  3.8G   0% &#x2F;dev</span><br><span class="line">tmpfs                  3.9G     0  3.9G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                  3.9G   18M  3.8G   1% &#x2F;run</span><br><span class="line">tmpfs                  3.9G     0  3.9G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sda2              100G   11G   90G  11% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda3               50G  3.0G   47G   6% &#x2F;data</span><br><span class="line">&#x2F;dev&#x2F;sda1              976M  135M  775M  15% &#x2F;boot</span><br><span class="line">tmpfs                  779M  8.0K  779M   1% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">10.0.0.18:&#x2F;data&#x2F;share   50G  2.0G   48G   4% &#x2F;data&#x2F;vm_images_nfs</span><br><span class="line"></span><br><span class="line">#删除存储池</span><br><span class="line">[root@centos8 ~]$virsh pool-destroy vm_images_nfs</span><br><span class="line">Pool vm_images_nfs destroyed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-undefine vm_images_nfs</span><br><span class="line">Pool vm_images_nfs has been undefined</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-list --all</span><br><span class="line"> Name                 State      Autostart</span><br><span class="line">-------------------------------------------</span><br><span class="line"> default              active     yes</span><br><span class="line"> isos                 active     yes</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        3.8G     0  3.8G   0% &#x2F;dev</span><br><span class="line">tmpfs           3.9G     0  3.9G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           3.9G   18M  3.8G   1% &#x2F;run</span><br><span class="line">tmpfs           3.9G     0  3.9G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sda2       100G   11G   90G  11% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda3        50G  3.0G   47G   6% &#x2F;data</span><br><span class="line">&#x2F;dev&#x2F;sda1       976M  135M  775M  15% &#x2F;boot</span><br><span class="line">tmpfs           779M  8.0K  779M   1% &#x2F;run&#x2F;user&#x2F;0</span><br></pre></td></tr></table></figure>


<h2 id="存储卷管理"><a href="#存储卷管理" class="headerlink" title="存储卷管理"></a>存储卷管理</h2><p>一个存储池被分为多个存储卷，存储卷可以是：</p>
<ul>
<li>   文件</li>
<li>   块设备，比如物理分区、LVM</li>
<li>   libvirt管理的其他类型存储的抽象<br>存储卷管理相关命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vol-clone #克隆卷</span><br><span class="line">vol-create-as #通过一组参数创建卷</span><br><span class="line">vol-create #通过XML文件创建卷</span><br><span class="line">vol-delete #删除一个卷</span><br><span class="line">vol-download #下载卷到一个文件</span><br><span class="line">vol-info #存储卷的信息</span><br><span class="line">vol-list #列出卷</span><br></pre></td></tr></table></figure>
<h3 id="基于目录的存储池的存储卷管理"><a href="#基于目录的存储池的存储卷管理" class="headerlink" title="基于目录的存储池的存储卷管理"></a>基于目录的存储池的存储卷管理</h3>先创建存储池，然后创建存储卷<br>例子：<br>创建存储池<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$mkdir -p &#x2F;data&#x2F;vm_images_dir</span><br><span class="line">[root@centos8 ~]$virsh pool-define-as vm_images_dir dir --target &#x2F;data&#x2F;vm_images_dir</span><br><span class="line">Pool vm_images_dir defined</span><br><span class="line">[root@centos8 ~]$virsh pool-start vm_images_dir</span><br><span class="line">Pool vm_images_dir started</span><br><span class="line">[root@centos8 ~]$virsh pool-dumpxml vm_images_dir</span><br><span class="line">&lt;pool type&#x3D;&#39;dir&#39;&gt;</span><br><span class="line">  &lt;name&gt;vm_images_dir&lt;&#x2F;name&gt;</span><br><span class="line">  &lt;uuid&gt;c72d03c3-aa8b-420d-8218-97664f7daa17&lt;&#x2F;uuid&gt;</span><br><span class="line">  &lt;capacity unit&#x3D;&#39;bytes&#39;&gt;53660876800&lt;&#x2F;capacity&gt;</span><br><span class="line">  &lt;allocation unit&#x3D;&#39;bytes&#39;&gt;3211886592&lt;&#x2F;allocation&gt;</span><br><span class="line">  &lt;available unit&#x3D;&#39;bytes&#39;&gt;50448990208&lt;&#x2F;available&gt;</span><br><span class="line">  &lt;source&gt;</span><br><span class="line">  &lt;&#x2F;source&gt;</span><br><span class="line">  &lt;target&gt;</span><br><span class="line">    &lt;path&gt;&#x2F;data&#x2F;vm_images_dir&lt;&#x2F;path&gt;</span><br><span class="line">    &lt;permissions&gt;</span><br><span class="line">      &lt;mode&gt;0755&lt;&#x2F;mode&gt;</span><br><span class="line">      &lt;owner&gt;0&lt;&#x2F;owner&gt;</span><br><span class="line">      &lt;group&gt;0&lt;&#x2F;group&gt;</span><br><span class="line">    &lt;&#x2F;permissions&gt;</span><br><span class="line">  &lt;&#x2F;target&gt;</span><br><span class="line">&lt;&#x2F;pool&gt;</span><br></pre></td></tr></table></figure>
创建存储卷<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh vol-create-as vm_images_dir test1.qcow2 1g --format qcow2</span><br><span class="line">[root@centos8 ~]$virsh vol-list vm_images_dir</span><br><span class="line"> Name                 Path</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"> test1.qcow2          &#x2F;data&#x2F;vm_images_dir&#x2F;test1.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh vol-info test1.qcow2 --pool vm_images_dir</span><br><span class="line">Name:           test1.qcow2</span><br><span class="line">Type:           file</span><br><span class="line">Capacity:       1.00 GiB</span><br><span class="line">Allocation:     196.00 KiB</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$ll &#x2F;data&#x2F;vm_images_dir&#x2F;</span><br><span class="line">total 196</span><br><span class="line">-rw------- 1 root root 196624 Nov 10 14:15 test1.qcow2</span><br><span class="line">[root@centos8 ~]$qemu-img info &#x2F;data&#x2F;vm_images_dir&#x2F;test1.qcow2</span><br><span class="line">image: &#x2F;data&#x2F;vm_images_dir&#x2F;test1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 0.10</span><br><span class="line">    refcount bits: 16</span><br><span class="line"></span><br><span class="line">#删除基于目录的存储池的存储卷</span><br><span class="line">[root@centos8 ~]$virsh vol-delete test1.qcow2 vm_images_dir</span><br><span class="line">Vol test1.qcow2 deleted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$ll &#x2F;data&#x2F;vm_images_dir&#x2F;</span><br><span class="line">total 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="基于LVM的存储池的存储卷管理"><a href="#基于LVM的存储池的存储卷管理" class="headerlink" title="基于LVM的存储池的存储卷管理"></a>基于LVM的存储池的存储卷管理</h3></li>
<li>*基于LVM的存储池的存储卷是一个块设备**<br>LVM存储池是VG，他的存储卷就是逻辑卷<br>例子：<br>同样的，需要先创建存储池，然后创建存储卷<br>创建存储池<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh pool-define-as vm_images_lvm logical --source-dev&#x3D;&#x2F;dev&#x2F;sdc</span><br><span class="line">Pool vm_images_lvm defined</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh pool-build vm_images_lvm</span><br><span class="line">Pool vm_images_lvm built</span><br><span class="line">[root@centos8 ~]$virsh pool-start vm_images_lvm</span><br><span class="line">Pool vm_images_lvm started</span><br></pre></td></tr></table></figure>
创建存储卷<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh vol-create-as vm_images_lvm lvmvol1 10G</span><br><span class="line">Vol lvmvol1 created</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh vol-list vm_images_lvm</span><br><span class="line"> Name                 Path</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"> lvmvol1              &#x2F;dev&#x2F;vm_images_lvm&#x2F;lvmvol1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$lvs</span><br><span class="line">  LV      VG            Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  lvmvol1 vm_images_lvm -wi-a----- 10.00g</span><br></pre></td></tr></table></figure>
可以使用创建好的存储卷进行虚拟机的安装，把存储卷当成磁盘去使用就可以了</li>
</ul>
<h3 id="克隆存储卷"><a href="#克隆存储卷" class="headerlink" title="克隆存储卷"></a>克隆存储卷</h3><p>克隆只能在同一个存储池内进行，使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh vol-clone volume_name volume_new_name pool_name</span><br></pre></td></tr></table></figure>
<p>就可以了</p>
<h4 id="基于文件的克隆"><a href="#基于文件的克隆" class="headerlink" title="基于文件的克隆"></a>基于文件的克隆</h4><h4 id="基于逻辑卷的克隆"><a href="#基于逻辑卷的克隆" class="headerlink" title="基于逻辑卷的克隆"></a>基于逻辑卷的克隆</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh vol-clone lvmvol1 lvmvol2 vm_images_lvm</span><br></pre></td></tr></table></figure>
<h3 id="向虚拟机添加存储卷"><a href="#向虚拟机添加存储卷" class="headerlink" title="向虚拟机添加存储卷"></a>向虚拟机添加存储卷</h3><p>通过attach-device和attach-disk给现有虚拟机添加存储卷，从而实现给虚拟机添加虚拟磁盘</p>
<h4 id="attach-device通过XML文件给已有虚拟机添加存储卷"><a href="#attach-device通过XML文件给已有虚拟机添加存储卷" class="headerlink" title="attach-device通过XML文件给已有虚拟机添加存储卷"></a>attach-device通过XML文件给已有虚拟机添加存储卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#需要先创建XML配置文件</span><br><span class="line">  1 &lt;disk type&#x3D;&#39;file&#39; device&#x3D;&#39;disk&#39;&gt;</span><br><span class="line">  2 &lt;driver name&#x3D;&#39;qemu&#39; type&#x3D;&#39;qcow2&#39; cache&#x3D;&#39;none&#39;&#x2F;&gt;</span><br><span class="line">  3 &lt;source file&#x3D;&#39;&#x2F;data&#x2F;vm_images_dir&#x2F;test1.qcow2&#39;&#x2F;&gt;</span><br><span class="line">  4 &lt;target dev&#x3D;&#39;vdb&#39;&#x2F;&gt;</span><br><span class="line">  5 &lt;&#x2F;disk&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$vim disk.xml</span><br><span class="line">[root@centos8 ~]$virsh attach-device centos7.0 disk.xml --persistent</span><br><span class="line">Device attached successfully</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh domblklist centos7.0</span><br><span class="line">Target     Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">vda        &#x2F;dev&#x2F;vm_images_lvm&#x2F;lvmvol1</span><br><span class="line">vdb        &#x2F;data&#x2F;vm_images_dir&#x2F;test1.qcow2</span><br><span class="line">sda        -</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="attach-disk给已有虚拟机添加存储卷"><a href="#attach-disk给已有虚拟机添加存储卷" class="headerlink" title="attach-disk给已有虚拟机添加存储卷"></a>attach-disk给已有虚拟机添加存储卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk --domain centos7.0 --sourcetype block --source &#x2F;dev&#x2F;vm_images_lvm&#x2F;lvmvol1 --target vdb</span><br><span class="line">#--domain是指虚拟机名称</span><br><span class="line">#--sourcetype表示虚拟磁盘类型，lvm类型的就是块设备</span><br><span class="line">#--source表示源文件或设备</span><br><span class="line">#--target表示添加到虚拟机上变成哪个盘</span><br></pre></td></tr></table></figure>


<h2 id="离线工具"><a href="#离线工具" class="headerlink" title="离线工具"></a>离线工具</h2><p>不启动虚拟机的情况下，直接访问管理虚拟机对应的磁盘，即离线访问<br>一个虚拟机包含的东西：</p>
<ul>
<li>   描述硬件信息的xml文件</li>
<li>   磁盘文件</li>
</ul>
<h3 id="工具安装和使用"><a href="#工具安装和使用" class="headerlink" title="工具安装和使用"></a>工具安装和使用</h3><p>可以使用guestfs工具对磁盘文件进行直接访问<br>软件包：<br>libguestfs-tools<br>几个工具：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$guestfish --ro -a &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8-2.qcow2</span><br><span class="line">#加-i选项，可以自动挂载，-d选项是读写方式</span><br><span class="line">[root@centos8 ~]$guestfish -d centos8-2 -i</span><br><span class="line"></span><br><span class="line">Welcome to guestfish, the guest filesystem shell for</span><br><span class="line">editing virtual machine filesystems and disk images.</span><br><span class="line"></span><br><span class="line">Type: ‘help’ for help on commands</span><br><span class="line">      ‘man’ to read the manual</span><br><span class="line">      ‘quit’ to quit the shell</span><br><span class="line"></span><br><span class="line">Operating system: CentOS Linux release 8.2.2004 (Core)</span><br><span class="line">&#x2F;dev&#x2F;cl&#x2F;root mounted on &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1 mounted on &#x2F;boot</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h1><p>官方文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;wiki.libvirt.org&#x2F;page&#x2F;VirtualNetworking</span><br></pre></td></tr></table></figure>
<p>为了实现不同宿主机之间的虚拟机的通信</p>
<h2 id="Linux网桥实现"><a href="#Linux网桥实现" class="headerlink" title="Linux网桥实现"></a>Linux网桥实现</h2><p>宿主机：virbr0网卡、virbr0-nic网卡<br>每创建一个虚拟机，宿主机就会创建一个网卡，这个网卡一半在虚拟机，一半在宿主机，而且网卡桥接在宿主机的br0网卡，体现出来就是这是一个NAT模式<br>nic：network interface controller</p>
<p>重点：如何软件实现网桥</p>
<p>使用命令nmcli connection实现<br>创建网桥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add type bridge con-name br0 ifname br0</span><br><span class="line">nmcli connection modify br0 ipv4.address 10.0.0.7&#x2F;24 ipv4.method manual</span><br><span class="line">nmcli connection up br0</span><br></pre></td></tr></table></figure>
<p>把网卡加入网桥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add type bridge-slave con-name br0-port0 ifname eth0 master br0</span><br><span class="line">nmcli connection add type bridge-slave con-anem br0-port1 ifname eth1 master br0</span><br><span class="line">nmcli connection up br0-port0</span><br><span class="line">nmcli connection up br0-port1</span><br></pre></td></tr></table></figure>
<p>查看网桥配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-br0</span><br><span class="line">DEVICE&#x3D;br0</span><br><span class="line">NAME&#x3D;br0</span><br><span class="line">STP&#x3D;yes</span><br><span class="line">TYPE&#x3D;Bridge</span><br><span class="line">BOOTPROTO&#x3D;static</span><br><span class="line">IPADDR&#x3D;10.0.0.7</span><br><span class="line">PREFIX&#x3D;24</span><br></pre></td></tr></table></figure>
<p>查看网卡配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-br0-port0</span><br><span class="line">DEVICE&#x3D;eth0</span><br><span class="line">NAME&#x3D;br0-port0</span><br><span class="line">TYPE&#x3D;Ethernet</span><br><span class="line">ONBOOT&#x3D;yes</span><br><span class="line">BRIDGE&#x3D;br0</span><br></pre></td></tr></table></figure>
<p>通过命令工具查看网桥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br><span class="line">ip link show master br0</span><br><span class="line">bridge link show</span><br></pre></td></tr></table></figure>
<p>删除网桥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection down br0</span><br><span class="line">rm -f &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-br0*</span><br><span class="line">nmcli connection reload</span><br></pre></td></tr></table></figure>
<h2 id="qemu-kvm支持的网络"><a href="#qemu-kvm支持的网络" class="headerlink" title="qemu-kvm支持的网络"></a>qemu-kvm支持的网络</h2><p>虚拟机的网络模式：</p>
<ul>
<li>   基于NAT的虚拟网络，这是virt-install的默认模式</li>
<li>   基于自定义桥接的虚拟网络</li>
<li>   用户自定义的隔离的虚拟网络</li>
<li>   直接分配物理网络设备，性能好<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection show ifname</span><br><span class="line">dhcp软件：dnsmasq；dhcp端口67,68，UDP</span><br><span class="line">ip link show master virbr0</span><br><span class="line">brctl show </span><br><span class="line">bridge link show </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="默认的网络配置NAT模式"><a href="#默认的网络配置NAT模式" class="headerlink" title="默认的网络配置NAT模式"></a>默认的网络配置NAT模式</h2>在libvirtd服务启动后，会在宿主机的nat表中添加规则<br>NAT模式的问题：不同宿主机的虚拟机之间不能通信<br>这个libvirt的中间存在什么？防火墙(NAT)，DHCP(分配IP)，DNS<br>图片：</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201111095115933.png" alt="image-20201111095115933"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh domifaddr name</span><br><span class="line">virsh domifstat name</span><br><span class="line">virsh domiflist name</span><br></pre></td></tr></table></figure>
<p>查看dnsmasq信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$cat &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;dnsmasq&#x2F;default.conf</span><br><span class="line">##WARNING:  THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span><br><span class="line">##OVERWRITTEN AND LOST.  Changes to this configuration should be made using:</span><br><span class="line">##    virsh net-edit default</span><br><span class="line">## or other application using the libvirt API.</span><br><span class="line">##</span><br><span class="line">## dnsmasq conf file created by libvirt</span><br><span class="line">strict-order</span><br><span class="line">pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;libvirt&#x2F;network&#x2F;default.pid</span><br><span class="line">except-interface&#x3D;lo</span><br><span class="line">bind-dynamic</span><br><span class="line">interface&#x3D;virbr0</span><br><span class="line">dhcp-range&#x3D;192.168.122.2,192.168.122.254</span><br><span class="line">dhcp-no-override</span><br><span class="line">dhcp-authoritative</span><br><span class="line">dhcp-lease-max&#x3D;253</span><br><span class="line">dhcp-hostsfile&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;dnsmasq&#x2F;default.hostsfile</span><br><span class="line">addn-hosts&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;dnsmasq&#x2F;default.addnhosts</span><br></pre></td></tr></table></figure>
<p>查看虚拟机网络信息命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$virsh domiflist centos8</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      network    default    virtio      52:54:00:52:71:7a</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh domifaddr centos8</span><br><span class="line"> Name       MAC address          Protocol     Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"> vnet0      52:54:00:52:71:7a    ipv4         192.168.122.172&#x2F;24</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$virsh domifstat centos8 vnet0</span><br><span class="line">vnet0 rx_bytes 3078703</span><br><span class="line">vnet0 rx_packets 13234</span><br><span class="line">vnet0 rx_errs 0</span><br><span class="line">vnet0 rx_drop 0</span><br><span class="line">vnet0 tx_bytes 89990</span><br><span class="line">vnet0 tx_packets 1349</span><br><span class="line">vnet0 tx_errs 0</span><br><span class="line">vnet0 tx_drop 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置虚拟机网卡桥接到宿主机的物理网卡"><a href="#配置虚拟机网卡桥接到宿主机的物理网卡" class="headerlink" title="配置虚拟机网卡桥接到宿主机的物理网卡"></a>配置虚拟机网卡桥接到宿主机的物理网卡</h2><p>配置虚拟机桥接到宿主机的eth0网卡上，而不是默认的NAT到virbr0网卡<br>这样每个虚拟机之间可以互相通信<br>通过virt-manager图形化操作<br>有个问题，虚拟机和宿主机之间为什么使用IP互相ping不通？明明虚拟机可以与其他宿主机通信？</p>
<h2 id="基于自定义网桥的虚拟网络"><a href="#基于自定义网桥的虚拟网络" class="headerlink" title="基于自定义网桥的虚拟网络"></a>基于自定义网桥的虚拟网络</h2><p>与上面的模式相比，这个模式路径短一些，可能这就是使用这个模式更多的原因？<br>最常用的方式，这个模式可以让运行在宿主机上的虚拟机使用和宿主机相同网段的IP，并且可以从外部直接访问到虚拟机。</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201111095027971.png" alt="image-20201111095027971"></p>
<p>自建网桥：</p>
<ul>
<li>   使用命令行</li>
<li>   编写配置文件<br>命令行：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add type bridge con-name virbr1 ifname virbr1</span><br><span class="line">nmcli connection modify virbr1 ipv4.address 10.0.0.8&#x2F;24 ipv4.method manual</span><br><span class="line"></span><br><span class="line">nmcli connection add type bridge-slave con-name eth0 ifname eth0 master virbr1</span><br><span class="line">nmcli connection up virbr1</span><br><span class="line">nmcli connection up eth0</span><br></pre></td></tr></table></figure>
编写配置文件：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-virbr1</span><br><span class="line"></span><br><span class="line">  1 TYPE&#x3D;Bridge</span><br><span class="line">  2 NAME&#x3D;virbr1</span><br><span class="line">  3 DEVICE&#x3D;virbr1</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 BOOTPROTO&#x3D;static</span><br><span class="line">  6 IPADDR&#x3D;10.0.0.8</span><br><span class="line">  7 PREFIX&#x3D;24</span><br><span class="line">  8 GATEWAY&#x3D;10.0.0.1</span><br><span class="line">  9 DNS1&#x3D;223.5.5.5</span><br><span class="line"> 10 DNS2&#x3D;180.76.76.76</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br><span class="line"></span><br><span class="line">  1 TYPE&#x3D;Ethernet</span><br><span class="line">  2 NAME&#x3D;eth0</span><br><span class="line">  3 DEVICE&#x3D;eth0</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 BRIDGE&#x3D;virbr1</span><br></pre></td></tr></table></figure>
配置完成后，当前的宿主机网络环境<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1&#x2F;128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:6e:5e:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:22:51:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1&#x2F;24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:22:51:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">7: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:6e:5e:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.8&#x2F;24 brd 10.0.0.255 scope global noprefixroute virbr1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe6e:5e4c&#x2F;64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
测试：使用配置过桥接的宿主机来通过cobbler服务器安装虚拟机</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#创建磁盘，注意啊，这个磁盘空间要跟cobbler的应答文件里写的一样才行</span><br><span class="line">[root@centos8 ~]$qemu-img create -f qcow2 &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8-pxe.qcow2 200G</span><br><span class="line">#开始安装，注意，下面的所有选项都有他的意义；cobbler的应答文件中的磁盘要从sda变成vda</span><br><span class="line">[root@centos8 ~]$virt-install --virt-type kvm --name centos8-pxe --ram 2048 --vcpus 2 --disk bus&#x3D;virtio,path&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;centos8-pxe.qcow2 --network&#x3D;bridge:virbr1,model&#x3D;virtio --pxe</span><br><span class="line">#--disk bus&#x3D;virtio 这个选项必须有，否则vda没有意义，也就是说，因为virtio才有的vda</span><br><span class="line">#--network&#x3D;bridge:virbr1,model&#x3D;virtio 这里面的virbr1是宿主机桥接网卡的名字，model&#x3D;virtio是表示使用virtio半虚拟化的网卡</span><br><span class="line">#--pxe表示使用pxe安装</span><br></pre></td></tr></table></figure>
<p>成功！<br>这样单独配置一个桥接网卡的方式，虚拟机与宿主机是可以ping通的，也可以访问互联网</p>
<p>把之前生成的虚拟机进行克隆<br>使用virt-manager克隆就行</p>
<p>使用qemu-img的方式也可以，之间复制qcow2文件，然后用这个文件启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp 模板.qcow2 123.qcow2</span><br><span class="line">virt-install --virt-type kvm --name 123 --ram 2048 --vcpus 2 --disk bus&#x3D;virtio,path&#x3D;&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;123.qcow2 --network:bridge&#x3D;virbr1,model&#x3D;virtio --boot hd</span><br></pre></td></tr></table></figure>


<h2 id="用户自定义的隔离的虚拟网络"><a href="#用户自定义的隔离的虚拟网络" class="headerlink" title="用户自定义的隔离的虚拟网络"></a>用户自定义的隔离的虚拟网络</h2><p>只有虚拟机和虚拟机、虚拟机和宿主机之间可以通信，其他都不能通信<br>类似VMware的仅主机模式<br>需要使用virt-manager去配置，在网络配置那里添加一个新的isolated网络就可以</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201111094930736.png" alt="image-20201111094930736"></p>
<p>配置完成后宿主机的IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1&#x2F;128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:6e:5e:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:22:51:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1&#x2F;24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:22:51:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">7: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:6e:5e:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.8&#x2F;24 brd 10.0.0.255 scope global noprefixroute virbr1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe6e:5e4c&#x2F;64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">15: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether fe:54:00:b2:a4:1d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc54:ff:feb2:a41d&#x2F;64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">16: virbr2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:9f:0e:a8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.1&#x2F;24 brd 192.168.100.255 scope global virbr2</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr2 state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:9f:0e:a8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">18: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr2 state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether fe:54:00:35:26:10 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc54:ff:fe35:2610&#x2F;64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">19: vnet2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr2 state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether fe:54:00:32:c5:fc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc54:ff:fe32:c5fc&#x2F;64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="操作案例"><a href="#操作案例" class="headerlink" title="操作案例"></a>操作案例</h1><h2 id="连接NAS共享存储实现虚拟机实时迁移"><a href="#连接NAS共享存储实现虚拟机实时迁移" class="headerlink" title="连接NAS共享存储实现虚拟机实时迁移"></a>连接NAS共享存储实现虚拟机实时迁移</h2><p>环境：三台主机，一台NFS，两台宿主机，每台宿主机都要做自定义的桥接模式，一样的网络配置，每台宿主机版本最好一致，如果不一致，最好从低版本迁移到高版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.8</span><br><span class="line">10.0.0.18</span><br><span class="line">10.0.0.4 NFS</span><br></pre></td></tr></table></figure>
<p>步骤：<br>1.配置NFS服务器的共享文件<br>2.配置两台宿主机，需要做好自定义的桥接、安装好虚拟机<br>3.把原本位于/var/lib/libvirt/images/下的文件先移走，然后都挂载nfs<br>4.迁移</p>
<p>1.配置NFS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils</span><br><span class="line">vim &#x2F;etc&#x2F;exports</span><br><span class="line">  1 &#x2F;data&#x2F;share    *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">systemctl start nfs</span><br><span class="line">mkdir -p &#x2F;data&#x2F;share</span><br><span class="line">exportfs -r</span><br><span class="line">exportfs -v</span><br><span class="line">&#x2F;data&#x2F;share     &lt;world&gt;(sync,wdelay,hide,no_subtree_check,sec&#x3D;sys,rw,secure,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure>
<p>2.两台宿主机的桥接配置<br>桥接配置的时候，命令行和配置文件都可以，结合使用比较好<br>虚拟机的安装参考之前的方法，拷贝、PXE都很快</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$nmcli c add type bridge con-name virbr1 ifname virbr1 ipv4.address 10.0.0.18&#x2F;24 ipv4.method manual</span><br><span class="line">#然后需要添加eth0网卡到网桥中，这个时候之间去修改eth0的配置文件，别用命令，因为可能修改不进去</span><br><span class="line">vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br><span class="line">  1 DEVICE&#x3D;eth0</span><br><span class="line">  2 NAME&#x3D;eth0</span><br><span class="line">  3 ONBOOT&#x3D;yes</span><br><span class="line">  4 TYPE&#x3D;Ethernet</span><br><span class="line">  5 BRIDGE&#x3D;virbr1</span><br><span class="line">然后使用命令启动两个网卡</span><br><span class="line">nmcli connection up virbr1</span><br><span class="line">nmcli connection up eth0</span><br><span class="line"></span><br><span class="line">#配置完的网桥配置文件</span><br><span class="line">[root@centos8 ~]$vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-virbr1</span><br><span class="line"></span><br><span class="line">  1 STP&#x3D;yes</span><br><span class="line">  2 BRIDGING_OPTS&#x3D;priority&#x3D;32768</span><br><span class="line">  3 TYPE&#x3D;Bridge</span><br><span class="line">  4 PROXY_METHOD&#x3D;none</span><br><span class="line">  5 BROWSER_ONLY&#x3D;no</span><br><span class="line">  6 BOOTPROTO&#x3D;none</span><br><span class="line">  7 DEFROUTE&#x3D;yes</span><br><span class="line">  8 IPV4_FAILURE_FATAL&#x3D;no</span><br><span class="line">  9 IPV6INIT&#x3D;yes</span><br><span class="line"> 10 IPV6_AUTOCONF&#x3D;yes</span><br><span class="line"> 11 IPV6_DEFROUTE&#x3D;yes</span><br><span class="line"> 12 IPV6_FAILURE_FATAL&#x3D;no</span><br><span class="line"> 13 IPV6_ADDR_GEN_MODE&#x3D;stable-privacy</span><br><span class="line"> 14 NAME&#x3D;virbr1</span><br><span class="line"> 15 UUID&#x3D;53710e51-3eba-4a02-9672-582527341f92</span><br><span class="line"> 16 DEVICE&#x3D;virbr1</span><br><span class="line"> 17 ONBOOT&#x3D;yes</span><br><span class="line"> 18 IPADDR&#x3D;10.0.0.18</span><br><span class="line"> 19 PREFIX&#x3D;24</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.转移文件，挂载NFS文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$mkdir -p &#x2F;data&#x2F;tmp</span><br><span class="line">[root@centos8 ~]$mv &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;* &#x2F;data&#x2F;tmp</span><br><span class="line"></span><br><span class="line">#挂载使用图形工具virt-manager，挂载完成后再把文件移动回去</span><br><span class="line"></span><br><span class="line">mv &#x2F;data&#x2F;tmp&#x2F;* &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;</span><br></pre></td></tr></table></figure>
<p>4.进行迁移，使用virt-manager图形化工具<br>在迁移之前，需要给两个宿主机做ssh的key验证<br>迁移的时候需要勾选上unsafe选项，否则迁移失败</p>
<h2 id="多网卡绑定操作"><a href="#多网卡绑定操作" class="headerlink" title="多网卡绑定操作"></a>多网卡绑定操作</h2><p>容错、提高带宽</p>
<p>将多块网卡绑定同一IP地址对外提供服务，可以实现高可用或者负载均衡，直接给两块网卡同一IP地址是不可以的，需要通过bongding，虚拟一块网卡对外提供链接，物理网卡被修改为相同的MAC地址</p>
<p>Bonding工作模式：</p>
<p>一共7种工作模式，0-6</p>
<ul>
<li>Mode 0（balance-rr）：轮询（Round-robin）策略，从头到尾顺序的在每一个slave接口上面发送数据包。提供负载均衡和容错的能力</li>
<li>Mode 1（active-backup）：活动-备份策略，只有一个slave被激活，当且仅当活动的slave接口失败时才会激活其他slave，为了避免交换机发生混乱，此时绑定的MAC地址只有一个外部端口上可见</li>
<li>Mode 3（broadcast）：广播策略，在所有slave接口上传送所有的报文，提供容错能力</li>
</ul>
<p>说明：active-backup、balance-backup和balance-alb模式不需要交换机的任何特殊配置，其他绑定模式需要配置交换机以便整合连接</p>
<p>Bonding配置</p>
<p>文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;Documentation&#x2F;networking&#x2F;bonding.txt</span><br></pre></td></tr></table></figure>

<p>两种实现方式：</p>
<p>1.写配置文件实现</p>
<p>创建bonding设备的配置文件，相当于把bond0当做一个物理网卡，IP什么的都在他这里配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-bond0</span><br><span class="line">  1 NAME&#x3D;bond0</span><br><span class="line">  2 TYPE&#x3D;bond</span><br><span class="line">  3 DEVICE&#x3D;bond0</span><br><span class="line">  4 BOOTPROTO&#x3D;none</span><br><span class="line">  5 BONDING_OPTS&#x3D;&quot;mode&#x3D;1 miimon&#x3D;100&quot;</span><br><span class="line">  </span><br><span class="line">vim ifcfg-eth0</span><br><span class="line">  1 TYPE&#x3D;Ethernet</span><br><span class="line">  2 NAME&#x3D;eth0</span><br><span class="line">  3 DEVICE&#x3D;eth0</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 MASTER&#x3D;bond0</span><br><span class="line">  6 SLAVE&#x3D;yes</span><br><span class="line">  </span><br><span class="line">vim ifcfg-eth1  </span><br><span class="line">  1 TYPE&#x3D;Ethernet</span><br><span class="line">  2 NAME&#x3D;eth1</span><br><span class="line">  3 DEVICE&#x3D;eth1</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 MASTER&#x3D;bond0</span><br><span class="line">  6 SLAVE&#x3D;yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.命令行实现</p>
<p>我感觉，最好要先创建出来每个网卡的配置文件ifcfg-eth0这样的，然后再使用命令行工具，这样可以知道改了什么配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#添加一个绑定网卡，这个命令没有添加IP地</span><br><span class="line">nmcli connection add type bond con-name bond1 ifname bond1 mode active-backup </span><br><span class="line"></span><br><span class="line">#把单个网卡添加到绑定网卡中</span><br><span class="line">nmcli connection add type bond-slave ifname eth2 master bond1</span><br><span class="line">nmcli connection add type bond-slave ifname eth3 master bond1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果要桥接，还需要把绑定的网卡添加到桥接网卡上</p>
<p>查看桥接的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bridge link show</span><br></pre></td></tr></table></figure>

<p>查看绑定的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;net&#x2F;bonding&#x2F;bond0</span><br></pre></td></tr></table></figure>



<h2 id="内外网络隔离综合"><a href="#内外网络隔离综合" class="headerlink" title="内外网络隔离综合"></a>内外网络隔离综合</h2><p>实现一个外网的web服务和内网的数据库相互隔离的环境<br>两台宿主机host1和host2<br>每个宿主机上面各有两个虚拟机，分别连接外网和内网交换机</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201111094845730.png" alt="image-20201111094845730"></p>
<p>内网：使用VMware的仅主机模式的网卡，4个</p>
<p>外网：使用VMware的NAT模式的网卡，4个</p>
<p>使用两台宿主机，四台虚拟机，最主要的问题就是虚拟机系统的安装、网络的配置</p>
<p>安装虚拟机的关键点：干净的安装环境、合适的X11server软件、够大的内存</p>
<p>宿主机网络配置关键点：</p>
<p>1.网卡绑定</p>
<p>绑定还是使用配置文件，好理解一些</p>
<p>2.网卡桥接</p>
<p>桥接可以使用命令行</p>
<p>3.绑定和桥接的先后顺序：这两个应该是先绑定、后桥接</p>
<p>绑定的基本操作单位是网卡，网卡的配置文件中只需要指定自己的bonding网卡</p>
<p>bonding网卡如果不桥接，那么需要在配置文件中写自己的IP，如果要桥接，那么bonding网卡的配置文件中需要指定桥接网卡，IP不需要写</p>
<p>桥接网卡的配置文件中一定有IP地址</p>
<p>下面是两个网卡绑定，然后绑定网卡桥接到桥接网卡的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 network-scripts]$ll</span><br><span class="line">total 32</span><br><span class="line">-rw-r--r-- 1 root root  97 Nov 11 15:37 ifcfg-bond0</span><br><span class="line">-rw-r--r-- 1 root root  70 Nov 11 11:30 ifcfg-eth0</span><br><span class="line">-rw-r--r-- 1 root root  70 Nov 11 11:31 ifcfg-eth1</span><br><span class="line">-rw-r--r-- 1 root root 142 Nov 10 17:50 ifcfg-virbr1</span><br></pre></td></tr></table></figure>

<p>下面是两个网卡的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">eth0</span><br><span class="line">  1 TYPE&#x3D;Ethernet</span><br><span class="line">  2 NAME&#x3D;eth0</span><br><span class="line">  3 DEVICE&#x3D;eth0</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 MASTER&#x3D;bond0</span><br><span class="line">  6 SLAVE&#x3D;yes</span><br><span class="line">eth1</span><br><span class="line">  1 TYPE&#x3D;Ethernet</span><br><span class="line">  2 NAME&#x3D;eth1</span><br><span class="line">  3 DEVICE&#x3D;eth1</span><br><span class="line">  4 ONBOOT&#x3D;yes</span><br><span class="line">  5 MASTER&#x3D;bond0</span><br><span class="line">  6 SLAVE&#x3D;yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面是绑定网卡的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 NAME&#x3D;bond0</span><br><span class="line">2 TYPE&#x3D;bond</span><br><span class="line">3 DEVICE&#x3D;bond0</span><br><span class="line">4 BOOTPROTO&#x3D;none</span><br><span class="line">5 BONDING_OPTS&#x3D;&quot;mode&#x3D;1 miimon&#x3D;100&quot;</span><br><span class="line">6 BRIDGE&#x3D;virbr1</span><br></pre></td></tr></table></figure>

<p>下面是桥接网卡的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 1 TYPE&#x3D;Bridge</span><br><span class="line"> 2 NAME&#x3D;virbr1</span><br><span class="line"> 3 DEVICE&#x3D;virbr1</span><br><span class="line"> 4 ONBOOT&#x3D;yes</span><br><span class="line"> 5 BOOTPROTO&#x3D;static</span><br><span class="line"> 6 IPADDR&#x3D;10.0.0.8</span><br><span class="line"> 7 PREFIX&#x3D;24</span><br><span class="line"> 8 GATEWAY&#x3D;10.0.0.1</span><br><span class="line"> 9 DNS1&#x3D;223.5.5.5</span><br><span class="line">10 DNS2&#x3D;180.76.76.76</span><br></pre></td></tr></table></figure>










      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/HTTP%E5%8D%8F%E8%AE%AE%E5%92%8CAPACHE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/HTTP%E5%8D%8F%E8%AE%AE%E5%92%8CAPACHE/" class="post-title-link" itemprop="url">HTTP协议和APACHE</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：21:58:06" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HTTP协议和APACHE"><a href="#HTTP协议和APACHE" class="headerlink" title="HTTP协议和APACHE"></a>HTTP协议和APACHE</h1><h2 id="杂谈"><a href="#杂谈" class="headerlink" title="杂谈"></a>杂谈</h2><p>HTTP协议</p>
<p>Httpd是软件包和运行程序名，Apache是服务名称</p>
<p>网络连接五个元素：</p>
<ul>
<li>协议</li>
<li>源地址</li>
<li>源端口</li>
<li>目的地址</li>
<li>目的端口</li>
</ul>
<p>Apache并发最高1万连接</p>
<p>Nginx并发最高10万连接</p>
<p>HTTP协议分层：</p>
<p>TCP/IP分层：4层</p>
<p>OSI参考模型分层：7层</p>
<p>参考学习网站：</p>
<p>W3school</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://www.w3school.com.cn/index.html</span></span><br></pre></td></tr></table></figure>



<h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><h3 id="1-1-HTTP-超文本传输协议"><a href="#1-1-HTTP-超文本传输协议" class="headerlink" title="1.1 HTTP 超文本传输协议"></a>1.1 HTTP 超文本传输协议</h3><p>Hyper Text Transfer Protocol</p>
<p>互联网：是世界的网络，是所有类型网络的母集</p>
<p>因特网：世界上最大的互联网网络，即因特网属于互联网概念</p>
<p>万维网：WWW   B/S架构，Browser和Server，万维网并非是一个特殊的计算机网络，而是一个大规模的、联机式的信息贮藏库，使用链接的方法能非常方便地从因特网上的一个站点访问另一个站点（超链接），具有提供分布式服务的特点。万维网是一个分布式的超媒体系统，是超文本系统的扩充。万维网是一个互联网的应用系统，采用HTTP、HTTPS的传输协议。因特网上还有其他应用系统，比如FTP、SMTP。</p>
<p>URL：统一资源定位符（Uniform Resource Locator） ，用来标识万维网上的各种文档，并使每个文档在整个因特网的范围内具有唯一的标识符</p>
<p>HTTP：协议，为了解决<code>用什么样的网络协议来实现整个因特网上的万维网文档的传输</code>这一问题而产生，规定了文档发送端和接收端之间的通信流程，Hyper Text Transfer Protocol。</p>
<p>HTML：文档格式 超文本标记语言，为了解决<code>怎么使不同创作者创作的不同风格的万维网文档，都能在因特网上的各种主机上显示出来，同时使用户清楚地知道在什么地方存在着链接</code>这一问题而产生。Hyper Text Markup Language，它可以使人们方便地使用链接从页面的某处链接到因特网的任何万维网页面。</p>
<h3 id="打开一个网页发生了什么之浏览器是如何工作的"><a href="#打开一个网页发生了什么之浏览器是如何工作的" class="headerlink" title="打开一个网页发生了什么之浏览器是如何工作的"></a>打开一个网页发生了什么之浏览器是如何工作的</h3><p>1.在浏览器中输入域名</p>
<p>2.浏览器检查本机DNS缓存，如果有该域名的缓存就调用，如果没有就向本地DNS服务器发起递归查询，询问域名对应的IP</p>
<p>3.本地DNS服务器收到浏览器请求后，查询服务器DNS缓存，如果有该域名的缓存就调用，把域名对应的IP地址返回给浏览器，如果没有该域名的缓存，那么就检查服务器是否有该域名顶级域服务器的缓存，如果有，就向顶级域发起迭代查询，一路向下询问该域名的地址，直到接收到该域名主机的IP地址为止；如果没有该域名的顶级域服务器缓存，那么就向DNS根服务器发起迭代查询，直到接收到该域名主机的IP地址，当然这样的情况很少了，绝大多数本地DNS服务器都会缓存各个顶级域的缓存，减少向根域服务器的查询。本地DNS服务器接收到IP后，把该IP返回给浏览器。这里还有一个CDN，内容分发网络，Content Delivery Network，它是一种可以根据用户所在位置(其实是用户本地DNS服务器所在位置)，来把就近的本网站的服务器IP地址返回给用户，从而让用户和服务器之间的距离变短，访问变快的一种网络架构。它的工作流程是这样的：网站的架构师在注册本网站的域名和IP地址关系的时候，不会写上真正的web服务器的IP地址，而是写上一个别名，CNAME，以及CNAME对应的IP地址，而这个CNAME所对应的IP地址的主机是干嘛的呢？它是一个使用了GSLB技术的基于DNS实现的服务器，GSLB，Global Server Load Balance，全局负载均衡技术，它能干嘛呢？它能根据向它发起询问的本地DNS服务器的IP地址，判断出这个DNS服务器的地理位置，然后把距离这个位置最近的、这个网站的服务器IP地址发送给本地DNS，让本地DNS把这个IP地址返回给浏览器，从而让浏览器直接去访问这个最近的主机，从而减少服务器网络和用户网络之间的距离，让用户的访问可以更快速，得到响应更快速。而为什么用户访问的明明不是原本想要访问的web主机，还能获得几乎一样的内容呢？那是因为使用了CDN架构，它是一种把源web服务器上的内容分发到全国各地的人口较多的城市中的其他web服务器上的一种架构。每一个本地的web服务器都会响应本地用户的请求，但是它服务器上的内容是要不断地从主服务器或其他临近的本地服务器上获取来的，网站管理人员不会直接在本地web服务器上进行内容修改。当用户访问的资源在本地web服务器上有时，它直接返回给用户；当用户访问的资源在本地web服务器上没有时，它会向邻居的其他本地web服务器进行查询，如果其他本地web服务器上有这个资源，就拷贝过来，然后存住，然后把资源返回给用户，如果其他本地web服务器没有这个资源时，那么它需要通过专用的网络去访问源web服务器，去获取资源，然后保存在本地，然后返回给用户。</p>
<p>4.浏览器接收到域名对应的IP后，向该IP发起访问基于HTTP协议的请求，HTTP请求从浏览器应用生成，叫HTTP请求报文，然后根据TCP/IP协议，浏览器程序的进程把HTTP请求报文通过TCP协议套接字传送给传输层、网络层、链路层、物理层从而发往该主机，再经过物理层、链路层、网络层、传输层，通过该主机的TCP套接字进入该主机对应的监听进程中去，这里面重点要说的是TCP协议的连接建立和断开，TCP是一种面向连接的传输协议，可以保证传输的完整性。TCP连接的建立是三次握手，首先客户端向服务器端发出连接申请，服务器端接收该报文段，判断是否同意与客户端建立连接，如果不同意就返回拒绝，连接拒绝；如果同意，那么就向客户端发出同意连接报文段和同步请求，这个时候的服务器端已经进入了同步接收状态，客户端收到报文段后，为了减少服务器的性能浪费，还会向服务器端发送同意报文段，这样客户端和服务器端就建立了连接。为什么要三次握手？</p>
<p>TCP断开连接是四次挥手，TCP客户端向服务器端发出连接终止请求，此时客户端进入终止等待1状态，服务器端收到请求后，如果不同意，会向客户端发出不同意请求；如果同意，会向客户端发出同意请求，同时如果还有数据没发送完成，就继续把没有发送完的数据发送完，服务器端此时进入关闭等待状态；客户端收到同意请求后，进入终止等待2状态，同时等待服务器端的终止请求，这个时候客户端不会向服务器端发送数据了，客户端到服务器端的连接被释放了，这叫做TCP的半关闭状态；服务器端把数据发送完毕后，向客户端发出终止请求，此时服务器端进入最后确认状态；客户端收到终止请求后，向服务器端回复同意报文，然后等待2MSL后，关闭连接；服务器端收到同意报文后，关闭连接。为什么有第四次挥手？</p>
<p>5.TCP连接建立后，开始通过套接字进行与应用层的通信，套接字Socket是进程间通信IPC的一种实现，允许位于不同主机的不同进程之间的通信和数据交换，Socket API是实现socket的方式，Socket有两个标志：IP地址和端口，合称为套接字地址，Socket Address，客户端套接字地址定义了唯一的客户进程，服务器套接字地址定义了唯一的服务器进程。</p>
<p>我认为socket API就是操作系统中传输层的体现，因为IP地址和端口本就是传输层的东西；socket是一个逻辑层面的东西，介于应用层和传输层之间；</p>
<p>Socket API介绍：</p>
<p>Socket API封装了内核中所提供的socket通信相关的系统调用，包括：</p>
<p>Socket Domain：</p>
<ul>
<li>AF_INET：Address Family ，IPV4</li>
<li>AF_INET6：IPV6</li>
<li>AF_UNIX：同一主机上不同进程之间通信时使用的</li>
</ul>
<p>Socket Type：根据使用的传输层协议</p>
<ul>
<li>SOCK_STREAM：流，tcp套接字，可靠地传递、面向连接</li>
<li>SOCK_DGRAM：数据报，udp套接字，不可靠地传递、无连接</li>
<li>SOCK_RAW：裸套接字，无须tcp或udp，APP直接通过IP包通信</li>
</ul>
<p>套接字相关的系统调用：</p>
<ul>
<li>socket() 创建一个套接字</li>
<li>bind() 绑定IP和端口</li>
<li>listen() 监听</li>
<li>accept() 接收请求</li>
<li>connect() 请求连接建立</li>
<li>write() 发送</li>
<li>read() 接收</li>
<li>close() 关闭连接</li>
</ul>
<p>6.开始进行以应用层的HTTP协议通讯，目前HTTP协议是2.0和1.1混合使用的，浏览器向服务器端发出获取资源的申请，比如说GET方法<code>GET /images/1.jpg  HTTP/2.0</code>，然后服务器返回请求，比如<code>HTTP/2.0 200 0K</code>，同时返回数据内容</p>
<h3 id="web前端开发语言："><a href="#web前端开发语言：" class="headerlink" title="web前端开发语言："></a>web前端开发语言：</h3><p>html：超文本标记语言，用于规定www的统一的文档格式</p>
<p>css：格式套用</p>
<p>javascript：实现网页动画效果，但是属于静态资源</p>
<p>静态资源和动态资源的区别：</p>
<p>服务器端的资源和发送给客户端的资源是否一致，一致的是静态资源，不一致的是动态资源</p>
<h3 id="MIME"><a href="#MIME" class="headerlink" title="MIME"></a>MIME</h3><p>MIME：多用途互联网邮件扩展</p>
<p><code>/etc/mime.types</code>，里面写了服务器支持的数据类型，来源于mailcap包</p>
<p>多种资源的传输</p>
<h3 id="URI和URL"><a href="#URI和URL" class="headerlink" title="URI和URL"></a>URI和URL</h3><p>URI：Uniform Resource Identifier 统一资源标识，URI分为了URN和URL</p>
<p>URN：Uniform Resource Nameing 统一资源命名</p>
<p>例如：<code>P2P下载中使用的磁力链接</code>  P2P协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magnet:?xt&#x3D;urn:btih:xxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>URL：Uniform Resource Locator 统一资源定位符</p>
<p>URL的格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;schema&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</span><br><span class="line">参数说明：</span><br><span class="line"><span class="attribute">schema：方案，访问服务器使用什么协议</span></span><br><span class="line"><span class="attribute"></span>: 分隔符</span><br><span class="line">// 指定url的人规定有的，应该是没有意义的</span><br><span class="line"><span class="attribute">user：用户名</span></span><br><span class="line"><span class="attribute">password：密码</span></span><br><span class="line"><span class="attribute">host：主机</span></span><br><span class="line"><span class="attribute">port：端口</span></span><br><span class="line"><span class="attribute">path：资源在服务器上的路径</span></span><br><span class="line"><span class="attribute">params：参数，指定传入的参数</span></span><br><span class="line"><span class="attribute">query：查询，传递参数给程序，比如给数据库，用?分隔，多个参数使用&amp;分隔</span></span><br><span class="line"><span class="attribute">frag：fragment，片段，一小片或一部分资源的名字，此组件在客户端使用，用#分隔</span></span><br></pre></td></tr></table></figure>

<p>apache的官网：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd.apache.org</span><br></pre></td></tr></table></figure>



<h3 id="网站访问量统计"><a href="#网站访问量统计" class="headerlink" title="网站访问量统计"></a>网站访问量统计</h3><ul>
<li>IP：通过IP计算，一天内来自相同客户机的IP地址只算一次</li>
<li>PV：Page View，通过页面刷新计算</li>
<li>UV：Unique Visitor，通过cookie统计</li>
<li>QPS：Request Per Seconds，每秒请求数</li>
</ul>
<h3 id="HTTP的工作机制"><a href="#HTTP的工作机制" class="headerlink" title="HTTP的工作机制"></a>HTTP的工作机制</h3><p><strong>一次http事务包括：</strong></p>
<ul>
<li>http请求：http request</li>
<li>http响应：http response</li>
</ul>
<p><strong>Web资源：</strong>web resource，一个网页由多个资源构成，打开一个页面，通常会有多个资源展示出来，但是每个资源都要单独请求。因此，一个“web页面“通常并不是单个资源，而是一组资源的集合</p>
<p><strong>资源分类：</strong></p>
<p>​    静态资源：</p>
<p>​    .javascript，.css，.html</p>
<p>​    动态资源：</p>
<p>​    .php，.jsp，.asp</p>
<h3 id="HTTP连接请求-？"><a href="#HTTP连接请求-？" class="headerlink" title="HTTP连接请求 ？"></a>HTTP连接请求 ？</h3><p>串行和并行：</p>
<ul>
<li>串行：每次发起TCP连接完成一个事务，然后断开连接，下一次事务还需要建立TCP连接</li>
<li>并行：通过多条TCP连接发起并行的HTTP请求</li>
</ul>
<p>串行，持久连接和管道</p>
<ul>
<li>持久连接：keep-alive，重用TCP连接，以消除多次连接和关闭的时延，以事务个数和时间来决定是否关闭连接</li>
<li>管道：通过共享TCP连接，发起并行的连接</li>
</ul>
<p>提升HTTP连接性能：管道化的持久连接，还有个实验阶段的，复用的连接，交替传送请求和相应报文</p>
<h3 id="HTTP协议版本"><a href="#HTTP协议版本" class="headerlink" title="HTTP协议版本"></a>HTTP协议版本</h3><p><strong>http/0.9：</strong></p>
<p>最初的版本，只有一个命令GET，只支持一个格式，HTML</p>
<p><strong>http/1.0：</strong></p>
<ul>
<li>每个TCP连接只能发送一个请求，发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接</li>
<li>引入了post和head命令</li>
<li>头信息是ASCII码，后面数据可以是任何格式。服务器会告诉客户端，数据是什么格式，即 Content-Type字段</li>
</ul>
<p><strong>http/1.1：</strong>1997年</p>
<ul>
<li>引入了持久连接，persistence connection，即TCP默认不关闭，可以被多个请求复用。对于同一个域名，大多数浏览器允许建立6个持久连接，引入了管道机制，即在同一个TCP连接中，客户端可以同时发送多个请求，近一步改善了HTTP协议的效率</li>
<li>新增方法：PUT、PATCH、OPTIONS、DELETE</li>
<li>同一个TCP连接里，所有数据通信都是有序进行的，服务器只能顺序处理回应，前面的回应慢，会有许多请求排队，造成“队头阻塞”(Head-of-line blocking)，为了避免这种情况，要：减少请求数、同时开放多个持久连接</li>
</ul>
<h3 id="http-1-0和http-1-1存在的区别"><a href="#http-1-0和http-1-1存在的区别" class="headerlink" title="http/1.0和http/1.1存在的区别"></a>http/1.0和http/1.1存在的区别</h3><ul>
<li>缓存处理方法，在HTTP1.0中主要是使用header中的If-Modified-Since，Expires来作为缓存判断的标准，HTTP1.1则引入了更多的缓存控制策略，如Entity tag，If-Unmodified-Since，If-Match，If-None-Match等更多可供选择的缓存头来控制缓存策略</li>
<li>带宽优化以及网络连接的使用，在HTTP1.0中，存在一些浪费带宽的现象，例如，客户端只需要某个对象的一部分，但服务器只能将整个对象发送给客户端，并且不支持断点续传功能，HTTP1.1则在请求头引入了range头域，它允许只请求资源的某个部分，即返回码是206（Partial Content），方便了开发者自由的选择以便于充分利用带宽和连接</li>
<li>错误通知的管理，在HTTP1.1中新增24个状态相应码，如409（Conflict）表示请求的资源与资源当前状态冲突；410（Gone）表示服务器上的某个资源被永久性的删除</li>
<li>Host头处理，HTTP1.0默认每台服务器绑定一个IP地址，因此URL中没有hostname；HTTP1.1的请求和响应报文中都有host，而且请求中如果没有host头会报告错误400（Bad Request）</li>
<li>长连接，HTTP1.1支持持久连接和管道，在一个TCP连接上可以处理多个请求，减少了建立和关闭连接的消耗和延迟，HTTP1.0没有</li>
</ul>
<p><strong>HTTP1.X共同的问题：</strong></p>
<ul>
<li>安全问题，HTTP1.X传输过程内容都是明文</li>
<li>HTTP1.X在传输连接时，每次都需要重新建立连接，这增大了延迟</li>
<li>HTTP1.X在使用时，header里携带的内容过大，增加了传输的成本，并且每次请求header基本不怎么变化，尤其在移动端增加用户流量</li>
<li>HTTP1.1支持了keep-alive虽然弥补了多次连接产生的延迟，但是keep-alive本身用多了也会给服务器端带来大量的性能压力，并且对于单个文件被多次请求的服务，keep-alive会极大的影响性能，因为它会在连接建立后还保持一段时间的连接</li>
</ul>
<p><strong>HTTPS：</strong>HTTP+TLS 正式版是2000年</p>
<ul>
<li>HTTPS协议需要使用证书，证书需要到CA申请，需要花钱</li>
<li>HTTPS运行在TCP+TLS之上，内容都是被加密的</li>
<li>HTTP和HTTPS使用的是不同的连接方式，HTTPS是443端口</li>
<li>HTTPS实现过程会降低访问速度，但是优化优化还是可以接受的，毕竟安全多了</li>
</ul>
<p><strong>HTTP2.0</strong>：2015年</p>
<ul>
<li>头信息和数据体都是二进制，称为头信息帧和数据帧</li>
<li>复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，且不用按顺序一一对应，避免了“队头阻塞”，此双向的实时通信称为多工(Multiplexing)</li>
<li>引入头信息压缩机制（header compression），头信息使用gzip或compress压缩后再发送；客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，不发送同样字段，只发送索引号，提高速度</li>
<li>HTTP/2.0允许服务器未经请求，主动向客户端发送数据，即服务器推送（server push）</li>
</ul>
<h3 id="HTTP请求访问的完整过程"><a href="#HTTP请求访问的完整过程" class="headerlink" title="HTTP请求访问的完整过程"></a>HTTP请求访问的完整过程</h3><p>复用的多线程I/O结构</p>
<p>7个过程</p>
<p><strong>1.建立连接：</strong>接收或拒绝连接请求</p>
<p><strong>2.接收请求：</strong>接收客户端请求报文中对某资源的一次请求过程</p>
<ul>
<li>单进程I/O模型：启动一个进程处理用户请求，而且每次只处理一个，多个请求被串行响应</li>
<li>多进程I/O模型：并行启动多个进程，每个进程响应一个连接请求</li>
<li>复用I/O结构：启动一个进程，同时响应N个连接请求</li>
<li>复用的多进程I/O模型：启动M个进程，每个进程响应N个连接请求，同时接收M*N个请求</li>
</ul>
<p><strong>3.处理请求：</strong>服务器对请求报文进行解析，并获取请求的资源及请求方法等相关信息，根据方法，资源，首部和可选的主体部分对请求进行处理</p>
<ul>
<li>常用的请求方法：GET、POST、HEAD、PUT、DELETE、TRACE、OPTIONS</li>
</ul>
<p><strong>4.访问资源：</strong>服务器获取请求报文中请求的资源web服务器，即存放了web资源的服务器，负责向请求者提供对方请求的静态资源，或动态运行后生成的资源</p>
<p><strong>5.构建响应报文：</strong>一旦web服务器识别出了资源，就执行请求方法中描述的动作，并返回响应报文。响应报文中包含有响应状态码、响应首部，如果生成了响应主体，还包括响应实体。</p>
<p>1）响应实体：如果事务处理产生了响应实体，就将内容放在响应报文中会送回去。响应报文中包括：</p>
<ul>
<li>描述了响应主体MIME类型的Content-Type首部</li>
<li>描述了响应主体长度的Content-Length</li>
<li>实际报文的主体内容</li>
</ul>
<p>2）URL重定向：web服务构建的响应并非客户端请求的资源，而是资源另外一个访问路径</p>
<p>3）MIME类型：web服务器要负责确定响应主体的MIME类型。多种配置服务器的方法可以将MIME类型与资源管理起来</p>
<p><strong>6.发送响应报文：</strong>web服务器通过连接发送响应数据也会面临与接收数据一样的问题，服务器可能有很多条到各个客户端的连接，有些是空闲的，有些在向服务器发送数据，还有一些在想客户端会送响应数据。服务器要记录连接的状态，还要特别注意对持久连接的处理。非持久连接可以自己关闭，持久连接需要服务器端确定怎么关闭、什么时候关闭，所以服务器端要计算好Content-Length首部，不然客户端就无法知道响应什么时候结束。</p>
<p><strong>7.记录日志：</strong>最后，当事务结束，web服务器会在日志文件中添加一个条目，来描述已执行的事务</p>
<h2 id="2-HTTPD安装和组成"><a href="#2-HTTPD安装和组成" class="headerlink" title="2 HTTPD安装和组成"></a>2 HTTPD安装和组成</h2><h3 id="1-常见HTTP服务器程序"><a href="#1-常见HTTP服务器程序" class="headerlink" title="1.常见HTTP服务器程序"></a>1.常见HTTP服务器程序</h3><ul>
<li>httpd Apache，存在C10K问题（10K connections）</li>
<li>Nginx 解决C10K问题</li>
</ul>
<p>官方帮助文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://httpd.apache.org/docs/current/</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Apache介绍"><a href="#2-Apache介绍" class="headerlink" title="2.Apache介绍"></a>2.Apache介绍</h3><p>目前版本：httpd 2.4</p>
<p>Apache特性：</p>
<ul>
<li>高度模块化：core + modules</li>
<li>DSO：Dynamic Shared Object 动态加载/卸载共享库</li>
<li>MPM：Multi-Processing Module 多路处理模块</li>
</ul>
<p>Apache功能：</p>
<ul>
<li>反向代理</li>
<li>负载均衡</li>
<li>路径别名</li>
<li>丰富的用户认证机制：basic，digest</li>
<li>支持第三方模块</li>
</ul>
<h3 id="MPM-multi-processing-module"><a href="#MPM-multi-processing-module" class="headerlink" title="MPM multi-processing module"></a>MPM multi-processing module</h3><ul>
<li><p><strong>prefork：</strong>预派生模式–&gt;多进程I/O结构–&gt;一个进程一个线程，一个请求一个进程，请求几个就开几个进程；</p>
<p>CentOS7的httpd默认模式</p>
<p> 一个主进程，生成和回收多个子进程，创建套接字，不响应请求</p>
<p>多个子进程，工作进程，每个子进程处理一个请求</p>
<p>系统初始化时，默认预先生成几个子进程等待请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ pstree -p | grep httpd</span><br><span class="line">           |-httpd(2895)-+-httpd(2896)</span><br><span class="line">           |             |-httpd(2897)</span><br><span class="line">           |             |-httpd(2898)</span><br><span class="line">           |             |-httpd(2899)</span><br><span class="line">           |             &#96;-httpd(2900)</span><br></pre></td></tr></table></figure>

<p>这种模式稳定，占内容，适用于访问量不大的场景</p>
</li>
<li><p><strong>worker：</strong>复用的多进程I/O模型，多线程多进程，Windows的IIS使用此模型</p>
<p>一个主进程，生成多个m子进程，每个子进程负责生n个线程，每个线程响应一个请求，并发响应</p>
<p>请求：m * n</p>
<p>worker MPM是一种多进程多线程混合的模型，有一个控制进程，启动多个子进程，每个子进程里面包含固定数量的线程，使用线程来处理请求，当线程不够用的使用再启动一个新的子进程，然后在子进程里面再启动线程去处理请求，由于它使用了线程处理请求，因此可以承受更高的并发。</p>
<p>优点：相比prefork占用的内存少，可以处理更多的请求</p>
<p>缺点：使用keep-alive的长连接方式，某个线程会一直被占用，即使没有数据传输，也一定要等到超时才能断开连接，如果过多的线程被这样占用，会导致在高并发情况下的无服务线程可用的情况</p>
</li>
<li><p><strong>event：</strong>事件驱动模式；CentOS8默认模式</p>
<p> event是worker模式的进步改良，它也是一个主进程生成m个子进程，子进程再生成n个线程，每个线程接收一个请求，但是它改进了一点，它的每个子进程的一个线程是监听线程，专门对其他线程进行管理。当有真实请求来临的时候，监工线程把一个线程分配给这个请求，当这个线程执行完毕后，工作线程会把接下来的会话监听工作交给监工线程，自己去处理新的请求。而监工进程会监听会话，如果超时，监工线程就把这个socket删除。</p>
<p>利用了TCP的一个选项TCP_DEFER_ACCEPT，只有数据发送的时候才开始建立连接。这样可以实现简单的防攻击（大量TCP连接）</p>
<p>优点：单线程响应多请求，占用更少的内存，高并发下表现更优秀，会有一个专门的线程来管理keep-alive类型的线程，当有请求过来的时候，将请求传递给服务线程，执行完毕后，又运行它释放</p>
<p>缺点：没有线程安全控制？</p>
</li>
</ul>
<h3 id="3-相关文件"><a href="#3-相关文件" class="headerlink" title="3.相关文件"></a>3.相关文件</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a><strong>配置文件</strong></h4><ul>
<li>/etc/httpd/conf/httpd.conf  主配置文件</li>
<li>/etc/httpd/conf.d/*.conf  子配置文件</li>
<li>/etc/httpd/conf.d/conf.modules.d/  模块加载的配置文件</li>
</ul>
<p>配置文件的组成：</p>
<ul>
<li>Global Environment</li>
<li>Main Server Configuration</li>
<li>Virtual Host</li>
</ul>
<p>格式说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">directive value</span><br><span class="line">指令 值</span><br></pre></td></tr></table></figure>



<h4 id="服务单元文件："><a href="#服务单元文件：" class="headerlink" title="服务单元文件："></a>服务单元文件：</h4><ul>
<li>/lib/systemd/system/httpd.service  服务管理文件</li>
<li>/etc/sysconfig/httpd     给service文件提供变量，如果在服务启动或停止中有什么想写的变量可以写在这里</li>
</ul>
<h4 id="语法检查命令：http-t"><a href="#语法检查命令：http-t" class="headerlink" title="语法检查命令：http -t"></a>语法检查命令：<code>http -t</code></h4><h4 id="控制工具：apachectl"><a href="#控制工具：apachectl" class="headerlink" title="控制工具：apachectl"></a>控制工具：<code>apachectl</code></h4><h4 id="站点网页文档存放目录：-var-www-html"><a href="#站点网页文档存放目录：-var-www-html" class="headerlink" title="站点网页文档存放目录：/var/www/html"></a>站点网页文档存放目录：/var/www/html</h4><h4 id="模块文件存放路径："><a href="#模块文件存放路径：" class="headerlink" title="模块文件存放路径："></a>模块文件存放路径：</h4><ul>
<li>/etc/httpd/modules</li>
<li>/usr/lib64/httpd/modules</li>
</ul>
<h4 id="日志路径：-var-log-httpd"><a href="#日志路径：-var-log-httpd" class="headerlink" title="日志路径：/var/log/httpd"></a>日志路径：/var/log/httpd</h4><ul>
<li>access_log：访问日志</li>
<li>error_log：错误日志</li>
</ul>
<h3 id="4-编译安装"><a href="#4-编译安装" class="headerlink" title="4.编译安装"></a>4.编译安装</h3><p>Centos7上由于APR版本低，编译2.4版本的HTTPD会失败，因此要先编译安装一个APR</p>
<p>ABI：Application binary interface</p>
<p>API：Application Programming interface</p>
<p>APR：Apache Portable Run-time libraries，Apache可移植运行库，Apache强依赖于这个库</p>
<p>编译安装HTTPD脚本，记得要把APR的编译加入</p>
<p>下载HTTPD的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;apache&#x2F;&#x2F;httpd&#x2F;httpd-2.4.46.tar.bz2</span><br></pre></td></tr></table></figure>

<p>下载APR的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mirrors.bfsu.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;apr-1.7.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>下载APR-util的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mirrors.bfsu.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;apr-util-1.6.1.tar.gz</span><br></pre></td></tr></table></figure>

<p>APR的这两个包下载完，解压，然后把解压出来的内容都放到HTTPD解压的文件夹下</p>
<p><code>/httpd_source_tree_root/srclib/apr</code> and <code>/httpd_source_tree_root/srclib/apr-util</code></p>
<p>然后在配置的时候加上<code>./configure --with-included-apr</code>，这样就可以一起编译安装了</p>
<p>依赖的软件包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc make pcre-devel openssl-devel expat-devel bzip2</span><br></pre></td></tr></table></figure>

<p>开始编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd httpd-2.4.26</span><br><span class="line">➜  httpd-2.4.46 .&#x2F;configure \</span><br><span class="line">&gt; --prefix&#x3D;&#x2F;apps&#x2F;httpd \</span><br><span class="line">&gt; --enable-so \</span><br><span class="line">&gt; --enable-ssl \</span><br><span class="line">&gt; --enable-cgi \</span><br><span class="line">&gt; --enable-rewrite \</span><br><span class="line">&gt; --with-zlib \</span><br><span class="line">&gt; --with-pcre \</span><br><span class="line">&gt; --with-included-apr \</span><br><span class="line">&gt; --enable-modules&#x3D;most \</span><br><span class="line">&gt; --enable-mpms-shared&#x3D;all \</span><br><span class="line">&gt; --with-mpm&#x3D;prefork</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>创建用户和组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin -M -d /apps/httpd  -U apache</span><br><span class="line">vim /apps/httpd/conf/httpd.conf</span><br><span class="line">User daemon</span><br><span class="line">Group daemon  都改成 apache</span><br></pre></td></tr></table></figure>

<p>修改环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile.d/httpd.sh</span><br><span class="line">PATH=/apps/httpd/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>修改帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;man_db.conf</span><br><span class="line">MANDATORY_MANPATH       &#x2F;apps&#x2F;httpd&#x2F;man</span><br></pre></td></tr></table></figure>

<p>创建service文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  1 [Unit]</span><br><span class="line">  2 Description&#x3D;The Apache HTTP Server</span><br><span class="line">  3 After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line">  4 Documentation&#x3D;man:httpd(8)</span><br><span class="line">  5 Documentation&#x3D;man:apachectl(8)</span><br><span class="line">  6 </span><br><span class="line">  7 [Service]</span><br><span class="line">  8 Type&#x3D;forking</span><br><span class="line">  9 ExecStart&#x3D;&#x2F;apps&#x2F;httpd&#x2F;bin&#x2F;apachectl -k start</span><br><span class="line"> 10 ExecReload&#x3D;&#x2F;apps&#x2F;httpd&#x2F;bin&#x2F;apachectl -k graceful</span><br><span class="line"> 11 ExecStop&#x3D;&#x2F;apps&#x2F;httpd&#x2F;bin&#x2F;apachectl -k stop</span><br><span class="line"> 12 # We want systemd to give httpd some time to finish gracefully, but still want</span><br><span class="line"> 13 # it to kill httpd after TimeoutStopSec if something went wrong during the</span><br><span class="line"> 14 # graceful stop. Normally, Systemd sends SIGTERM signal right after the</span><br><span class="line"> 15 # ExecStop, which would kill httpd. We are sending useless SIGCONT here to give</span><br><span class="line"> 16 # httpd time to finish.</span><br><span class="line"> 17 KillSignal&#x3D;SIGCONT                                                                      </span><br><span class="line"> 18 PrivateTmp&#x3D;true</span><br><span class="line"> 19 </span><br><span class="line"> 20 [Install]</span><br><span class="line"> 21 WantedBy&#x3D;multi-user.target</span><br><span class="line">~                                                      </span><br></pre></td></tr></table></figure>



<p>脚本：编译安装HTTPD 2.4.46</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-27</span><br><span class="line">#FileName:	install_httpd_2.4.46.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line"></span><br><span class="line">#定义软件的压缩包名称</span><br><span class="line">APR&#x3D;apr-1.7.0.tar.gz</span><br><span class="line">APR_UTIL&#x3D;apr-util-1.6.1.tar.gz</span><br><span class="line">HTTPD&#x3D;httpd-2.4.46.tar.bz2</span><br><span class="line">#取出.tar前的字符</span><br><span class="line">FILENAME_HTTPD&#x3D;$&#123;HTTPD%.tar*&#125;</span><br><span class="line">FILENAME_APR&#x3D;$&#123;APR%.tar*&#125;</span><br><span class="line">FILENAME_APR_UTIL&#x3D;$&#123;APR_UTIL%.tar*&#125;</span><br><span class="line">#定义下载目录和安装目录</span><br><span class="line">DOWNLOAD_DIR&#x3D;&#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">INSTALL_DIR&#x3D;&#x2F;apps&#x2F;httpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check_env ()</span><br><span class="line">&#123;</span><br><span class="line">    id apache &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;apache用户名已存在，脚本退出&quot;</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    if [ -d $&#123;INSTALL_DIR&#125; ];then</span><br><span class="line">        echo &quot;$&#123;INSTALL_DIR&#125;已存在，脚本退出&quot;</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    if [ -f $&#123;DOWNLOAD_DIR&#125;&#x2F;$&#123;HTTPD&#125; ];then</span><br><span class="line">        echo &quot;$&#123;DOWNLOAD_DIR&#125;目录下已存在$&#123;HTTPD&#125;，脚本退出&quot;</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;没有干扰项，可以进行安装！&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_httpd () </span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;开始编译安装HTTPD&quot;</span><br><span class="line">    yum -y install install gcc make pcre-devel openssl-devel expat-devel bzip2 &amp;&gt;&#x2F;dev&#x2F;null \</span><br><span class="line">    &amp;&amp; action &quot;依赖包安装完成!&quot; || &#123; action false &quot;安装依赖包失败&quot; ;exit 3; &#125; </span><br><span class="line">    mkdir -p &#x2F;apps&#x2F;httpd</span><br><span class="line">    useradd -r -s &#x2F;sbin&#x2F;nologin -d &#x2F;apps&#x2F;httpd -M -U -u 80 apache</span><br><span class="line">    echo &quot;开始下载压缩文件&quot;</span><br><span class="line">    cd $&#123;DOWNLOAD_DIR&#125;</span><br><span class="line">    wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;apache&#x2F;&#x2F;httpd&#x2F;$&#123;HTTPD&#125; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    wget https:&#x2F;&#x2F;mirrors.bfsu.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;$&#123;APR&#125; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    wget https:&#x2F;&#x2F;mirrors.bfsu.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;$&#123;APR_UTIL&#125; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    echo &quot;开始解压文件到：$&#123;DOWNLOAD_DIR&#125;&quot;</span><br><span class="line">    tar xf $&#123;HTTPD&#125; </span><br><span class="line">    tar xf $&#123;APR&#125; </span><br><span class="line">    tar xf $&#123;APR_UTIL&#125; </span><br><span class="line">    mv $&#123;FILENAME_APR&#125; $&#123;FILENAME_APR_UTIL&#125; $&#123;FILENAME_HTTPD&#125;&#x2F;srclib&#x2F;</span><br><span class="line">    mv $&#123;FILENAME_HTTPD&#125;&#x2F;srclib&#x2F;$&#123;FILENAME_APR&#125; $&#123;FILENAME_HTTPD&#125;&#x2F;srclib&#x2F;apr</span><br><span class="line">    mv $&#123;FILENAME_HTTPD&#125;&#x2F;srclib&#x2F;$&#123;FILENAME_APR_UTIL&#125; $&#123;FILENAME_HTTPD&#125;&#x2F;srclib&#x2F;apr-util</span><br><span class="line">    cd $&#123;FILENAME_HTTPD&#125;</span><br><span class="line">    #开始编译环节</span><br><span class="line">    .&#x2F;configure \</span><br><span class="line">    --prefix&#x3D;&#x2F;apps&#x2F;httpd \</span><br><span class="line">    --enable-so \</span><br><span class="line">    --enable-ssl \</span><br><span class="line">    --enable-cgi \</span><br><span class="line">    --enable-rewrite \</span><br><span class="line">    --with-zlib \</span><br><span class="line">    --with-pcre \</span><br><span class="line">    --with-included-apr \</span><br><span class="line">    --enable-modules&#x3D;most \</span><br><span class="line">    --enable-mpms-shared&#x3D;all \</span><br><span class="line">    --with-mpm&#x3D;prefork &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &quot;Configuration successful!&quot;</span><br><span class="line">    else</span><br><span class="line">        action false &quot;Configuration false,please check .&#x2F;configure options&quot;</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    TIME_1&#x3D;&#96;date +%s&#96;</span><br><span class="line">    make &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; make install &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &quot;Making Finished&quot;</span><br><span class="line">        TIME_2&#x3D;&#96;date +%s&#96;</span><br><span class="line">        TIME_USED&#x3D;$(( TIME_2 - TIME2 ))</span><br><span class="line">    else</span><br><span class="line">        action false &quot;Making false&quot;</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    #编译完成，开始修改配置文件 </span><br><span class="line">    sed -i.bak -e &#39;s&#x2F;^User daemon&#x2F;User apache&#x2F;&#39; \</span><br><span class="line">        -e &#39;s&#x2F;^Group daemon&#x2F;Group apache&#x2F;&#39; $&#123;INSTALL_DIR&#125;&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">    cat&gt;&#x2F;etc&#x2F;profile.d&#x2F;httpd.sh&lt;&lt;EOF</span><br><span class="line">PATH&#x3D;$&#123;INSTALL_DIR&#125;&#x2F;bin:\$PATH</span><br><span class="line">EOF</span><br><span class="line">    source &#x2F;etc&#x2F;profile.d&#x2F;httpd.sh</span><br><span class="line">    echo &quot;MANDATORY_MANPATH       $&#123;INSTALL_DIR&#125;&#x2F;man&quot; &gt;&gt; &#x2F;etc&#x2F;man_db.conf</span><br><span class="line">    #生成service文件</span><br><span class="line">    cat&gt;&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;httpd.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;The Apache HTTP Server</span><br><span class="line">After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line">Documentation&#x3D;man:httpd(8)</span><br><span class="line">Documentation&#x3D;man:apachectl(8)</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">ExecStart&#x3D;$&#123;INSTALL_DIR&#125;&#x2F;bin&#x2F;apachectl -k start</span><br><span class="line">ExecReload&#x3D;$&#123;INSTALL_DIR&#125;&#x2F;httpd&#x2F;bin&#x2F;apachectl -k graceful</span><br><span class="line">ExecStop&#x3D;$&#123;INSTALL_DIR&#125;&#x2F;bin&#x2F;apachectl -k stop</span><br><span class="line"># We want systemd to give httpd some time to finish gracefully, but still want</span><br><span class="line"># it to kill httpd after TimeoutStopSec if something went wrong during the</span><br><span class="line"># graceful stop. Normally, Systemd sends SIGTERM signal right after the</span><br><span class="line"># ExecStop, which would kill httpd. We are sending useless SIGCONT here to give</span><br><span class="line"># httpd time to finish.</span><br><span class="line">KillSignal&#x3D;SIGCONT                                                                      </span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line">    chown -R apache.apache $&#123;INSTALL_DIR&#125;</span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl enable --now httpd.service &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &quot;httpd服务启动成功！&quot;</span><br><span class="line">    else</span><br><span class="line">        action false &quot;httpd服务启动失败&quot;</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;编译用时：$&#123;TIME_USED&#125;s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_env</span><br><span class="line"></span><br><span class="line">install_httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-HTTPD常用配置选项"><a href="#3-HTTPD常用配置选项" class="headerlink" title="3 HTTPD常用配置选项"></a>3 HTTPD常用配置选项</h2><p>主配置文件：<code>httpd.conf</code></p>
<p>子配置文件夹，<code>/conf</code>，只要名称后缀是<code>.conf</code>就可以</p>
<p>默认配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ grep -Ev <span class="string">&#x27;^#|^$|^ &#x27;</span> /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerRoot <span class="string">&quot;/etc/httpd&quot;</span>				<span class="comment">#默认目录</span></span><br><span class="line">Listen 80							<span class="comment">#监听端口，可以设置多个监听IP和端口</span></span><br><span class="line">Include conf.modules.d/*.conf</span><br><span class="line">User apache</span><br><span class="line">Group apache</span><br><span class="line">ServerAdmin root@localhost</span><br><span class="line">&lt;Directory /&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/var/www&quot;</span>&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;Directory <span class="string">&quot;/var/www/html&quot;</span>&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">&lt;Files <span class="string">&quot;.ht*&quot;</span>&gt;</span><br><span class="line">&lt;/Files&gt;</span><br><span class="line">ErrorLog <span class="string">&quot;logs/error_log&quot;</span></span><br><span class="line">LogLevel warn</span><br><span class="line">&lt;IfModule log_config_module&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">&lt;IfModule alias_module&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">&lt;Directory <span class="string">&quot;/var/www/cgi-bin&quot;</span>&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;IfModule mime_module&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">AddDefaultCharset UTF-8</span><br><span class="line">&lt;IfModule mime_magic_module&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">EnableSendfile on</span><br><span class="line">IncludeOptional conf.d/*.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-serverName"><a href="#1-serverName" class="headerlink" title="1.serverName"></a>1.serverName</h3><p><strong>解决总是提示ServerName异常：在httpd.conf中设置一个ServerName就行了</strong></p>
<h3 id="2-包含其他配置文件"><a href="#2-包含其他配置文件" class="headerlink" title="2.包含其他配置文件"></a>2.包含其他配置文件</h3><p>指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Include conf&#x2F;extra&#x2F;proxy-html.conf</span><br><span class="line">IncludeOptional conf&#x2F;extra&#x2F;proxy-html.conf</span><br><span class="line">#他们两个的区别就是，Include后面的文件如果写错位置或者不存在会报错，IncludeOptional后面的不会</span><br></pre></td></tr></table></figure>

<h3 id="3-监听的IP和Port"><a href="#3-监听的IP和Port" class="headerlink" title="3.监听的IP和Port"></a>3.监听的IP和Port</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listen [IP:]Port</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>（1）省略IP表示为本机所有IP</p>
<p>（2）Listen指令至少一个，可重复出现多次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Listen 192.168.0.1:8080</span><br><span class="line">Listen 80</span><br></pre></td></tr></table></figure>

<h3 id="4-持久连接"><a href="#4-持久连接" class="headerlink" title="4.持久连接"></a>4.持久连接</h3><p>Persistence Connection：连接建立，每个资源获取完成后不会断开连接，而是继续等待其他的请求完成，默认开启持久连接</p>
<p>断开条件：</p>
<ul>
<li>时间限制：以秒为单位，默认5s，httpd支持毫秒级</li>
<li>请求数量：请求数达到指定值，也会断开</li>
</ul>
<p>副作用：对并发量大的服务器，持久连接会使有些请求得不到响应</p>
<p>折中：使用较短的持久连接时间</p>
<p>持久连接时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KeepAlive On|Off</span><br><span class="line">KeepAliveTimeout 15  #持久连接时间15s，默认是5s</span><br><span class="line">MaxKeepAliveRequests 500 #持久连接的最大接收请求数，默认值1000</span><br></pre></td></tr></table></figure>

<p>测试：使用Telnet模拟一次Http的GET请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ telnet 10.0.0.11 80</span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: 10.0.0.11</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Tue, 27 Oct 2020 13:51:03 GMT</span><br><span class="line">Server: Apache&#x2F;2.4.46 (Unix)</span><br><span class="line">Last-Modified: Tue, 27 Oct 2020 13:50:44 GMT</span><br><span class="line">ETag: &quot;2d-5b2a7554f01a3&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 45</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;&#x2F;h1&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;   #网页内容</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-DSO（Dynamic-Shared-Object）"><a href="#5-DSO（Dynamic-Shared-Object）" class="headerlink" title="5.DSO（Dynamic Shared Object）"></a>5.DSO（Dynamic Shared Object）</h3><p>加载动态模块配置，不需重启即生效</p>
<p>动态模块的路径：/usr/lib64/httpd/modules/，如果是编译安装，那么是在/path_to_install/httpd/modules</p>
<p>在主配置中指定加载模块配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ServerRoot &quot;&#x2F;apps&#x2F;httpd&quot;</span><br><span class="line">Include conf&#x2F;extra&#x2F;*.conf</span><br></pre></td></tr></table></figure>

<p>加载指定模块的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule &lt;mod_name&gt; &lt;mod_path&gt;</span><br></pre></td></tr></table></figure>

<p>查看httpd加载的模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">httpd -l  #静态编译的模块</span><br><span class="line">httpd -M  #静态和动态编译的模块</span><br></pre></td></tr></table></figure>

<h3 id="6-MPM（Multi-Processing-Module）多路处理模块"><a href="#6-MPM（Multi-Processing-Module）多路处理模块" class="headerlink" title="6.MPM（Multi-Processing Module）多路处理模块"></a>6.MPM（Multi-Processing Module）多路处理模块</h3><ul>
<li>prefork，预派生模式，多进程单线程，稳定，并发性不好，centos7默认</li>
<li>worker，多进程多线程，资源利用率好，但是在高并发时可能出现线程被占用</li>
<li>event，事件模式，有一个线程去管理其他线程，利用率高，centos8默认</li>
</ul>
<p>具体加载模块是在主配置文件，模块中的各种配置是在conf/extra文件下的http-mpm.conf中修改和查看</p>
<p>例如：修改MPM的工作模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim httpd.conf</span><br><span class="line"> 63 # Example:</span><br><span class="line"> 64 # LoadModule foo_module modules&#x2F;mod_foo.so</span><br><span class="line"> 65 #</span><br><span class="line"> 66 LoadModule mpm_event_module modules&#x2F;mod_mpm_event.so                                    </span><br><span class="line"> 67 #LoadModule mpm_prefork_module modules&#x2F;mod_mpm_prefork.so</span><br><span class="line"> 68 #LoadModule mpm_worker_module modules&#x2F;mod_mpm_worker.so</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="查看每个MPM模块的配置：prefork"><a href="#查看每个MPM模块的配置：prefork" class="headerlink" title="查看每个MPM模块的配置：prefork"></a>查看每个MPM模块的配置：prefork</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim conf&#x2F;extra&#x2F;httpd-mpm.conf</span><br><span class="line"></span><br><span class="line"> 21 # prefork MPM</span><br><span class="line"> 22 # StartServers: number of server processes to start</span><br><span class="line"> 23 # MinSpareServers: minimum number of server processes which are kept spare</span><br><span class="line"> 24 # MaxSpareServers: maximum number of server processes which are kept spare</span><br><span class="line"> 25 # MaxRequestWorkers: maximum number of server processes allowed to start</span><br><span class="line"> 26 # MaxConnectionsPerChild: maximum number of connections a server process serves</span><br><span class="line"> 27 #                         before terminating</span><br><span class="line"> 28 &lt;IfModule mpm_prefork_module&gt;</span><br><span class="line"> 29     StartServers             5</span><br><span class="line"> 30     MinSpareServers          5</span><br><span class="line"> 31     MaxSpareServers         10</span><br><span class="line"> 32     MaxRequestWorkers      250</span><br><span class="line"> 33     MaxConnectionsPerChild   0</span><br><span class="line"> 34 &lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">36 # worker MPM</span><br><span class="line">37 # StartServers: initial number of server processes to start</span><br><span class="line">38 # MinSpareThreads: minimum number of worker threads which are kept spare</span><br><span class="line">39 # MaxSpareThreads: maximum number of worker threads which are kept spare</span><br><span class="line">40 # ThreadsPerChild: constant number of worker threads in each server process</span><br><span class="line">41 # MaxRequestWorkers: maximum number of worker threads</span><br><span class="line">42 # MaxConnectionsPerChild: maximum number of connections a server process serves</span><br><span class="line">43 #                         before terminating</span><br><span class="line">44 &lt;IfModule mpm_worker_module&gt;</span><br><span class="line">45     StartServers             3</span><br><span class="line">46     MinSpareThreads         75</span><br><span class="line">47     MaxSpareThreads        250 </span><br><span class="line">48     ThreadsPerChild         25</span><br><span class="line">49     MaxRequestWorkers      400</span><br><span class="line">50     MaxConnectionsPerChild   0</span><br><span class="line">51 &lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="event"><a href="#event" class="headerlink" title="event"></a>event</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">53 # event MPM</span><br><span class="line">54 # StartServers: initial number of server processes to start</span><br><span class="line">55 # MinSpareThreads: minimum number of worker threads which are kept spare</span><br><span class="line">56 # MaxSpareThreads: maximum number of worker threads which are kept spare</span><br><span class="line">57 # ThreadsPerChild: constant number of worker threads in each server process</span><br><span class="line">58 # MaxRequestWorkers: maximum number of worker threads</span><br><span class="line">59 # MaxConnectionsPerChild: maximum number of connections a server process serves</span><br><span class="line">60 #                         before terminating</span><br><span class="line">61 &lt;IfModule mpm_event_module&gt;</span><br><span class="line">62     StartServers             3</span><br><span class="line">63     MinSpareThreads         75</span><br><span class="line">64     MaxSpareThreads        250</span><br><span class="line">65     ThreadsPerChild         25</span><br><span class="line">66     MaxRequestWorkers      400</span><br><span class="line">67     MaxConnectionsPerChild   0</span><br><span class="line">68 &lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-修改主页路径，需要添加授权选项"><a href="#7-修改主页路径，需要添加授权选项" class="headerlink" title="7.修改主页路径，需要添加授权选项"></a>7.修改主页路径，需要添加授权选项</h3><p><code>vim httpd.conf</code></p>
<p>DocumentRoot选项指定了访问httpd服务时访问的主目录，下面的标签中都是对选项的控制操作</p>
<ul>
<li>DocumentRoot指向的路径为URL的起始路径</li>
<li>/path必须显示授权后才可以访问</li>
</ul>
<p>URL和磁盘文件路径的映射关系：</p>
<p><code>http://10.0.0.11:80/index.html --&gt; /apps/httpd/htdocs/index.html</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">227 DocumentRoot &quot;/apps/httpd/htdocs&quot;</span><br><span class="line">228 &lt;Directory &quot;/apps/httpd/htdocs&quot;&gt;</span><br><span class="line">229     #</span><br><span class="line">230     # Possible values for the Options directive are &quot;None&quot;, &quot;All&quot;,</span><br><span class="line">231     # or any combination of:</span><br><span class="line">232     #   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews</span><br><span class="line">233     #</span><br><span class="line">234     # Note that &quot;MultiViews&quot; must be named *explicitly* --- &quot;Options All&quot;</span><br><span class="line">235     # doesn&#x27;t give it to you.</span><br><span class="line">236     #</span><br><span class="line">237     # The Options directive is both complicated and important.  Please see</span><br><span class="line">238     # http://httpd.apache.org/docs/2.4/mod/core.html#options</span><br><span class="line">239     # for more information.</span><br><span class="line">240     #</span><br><span class="line">241     Options Indexes FollowSymLinks</span><br><span class="line">242 </span><br><span class="line">243     #</span><br><span class="line">244     # AllowOverride controls what directives may be placed in .htaccess files.</span><br><span class="line">245     # It can be &quot;All&quot;, &quot;None&quot;, or any combination of the keywords:</span><br><span class="line">246     #   AllowOverride FileInfo AuthConfig Limit</span><br><span class="line">247     #</span><br><span class="line">248     AllowOverride None</span><br><span class="line">249 </span><br><span class="line">250     #</span><br><span class="line">251     # Controls who can get stuff from this server.</span><br><span class="line">252     #</span><br><span class="line">253     Require all granted</span><br><span class="line">254 &lt;/Directory&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-定义站点主页面"><a href="#8-定义站点主页面" class="headerlink" title="8.定义站点主页面"></a>8.定义站点主页面</h3><p>这个指的是Apache默认会使用哪个文件作为起始页面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">257 <span class="comment"># DirectoryIndex: sets the file that Apache will serve if a directory</span></span><br><span class="line">258 <span class="comment"># is requested.</span></span><br><span class="line">259 <span class="comment">#</span></span><br><span class="line">260 &lt;IfModule dir_module&gt;</span><br><span class="line">261     DirectoryIndex index.html</span><br><span class="line">262 &lt;/IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-对访问资源的控制"><a href="#9-对访问资源的控制" class="headerlink" title="9.对访问资源的控制"></a>9.对访问资源的控制</h3><p>可以针对文件系统的资源进行访问控制</p>
<p>文件系统路径：</p>
<h5 id="基于目录的控制"><a href="#基于目录的控制" class="headerlink" title="基于目录的控制"></a><strong>基于目录的控制</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;directory &quot;&#x2F;path&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;directory&gt;</span><br></pre></td></tr></table></figure>

<h5 id="基于文件的控制"><a href="#基于文件的控制" class="headerlink" title="基于文件的控制"></a>基于文件的控制</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;File &quot;&#x2F;path&#x2F;file&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;File&gt;</span><br></pre></td></tr></table></figure>

<h5 id="基于文件通配符"><a href="#基于文件通配符" class="headerlink" title="基于文件通配符"></a>基于文件通配符</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;File &quot;&#x2F;path&#x2F;*.conf&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;File&gt;</span><br></pre></td></tr></table></figure>

<h5 id="基于扩展正则表达式"><a href="#基于扩展正则表达式" class="headerlink" title="基于扩展正则表达式"></a>基于扩展正则表达式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FileMatch &quot;regex&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;&#x2F;FileMatch&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">268 &lt;Files &quot;.ht*&quot;&gt;</span><br><span class="line">269     Require all denied</span><br><span class="line">270 &lt;&#x2F;Files&gt;</span><br></pre></td></tr></table></figure>

<h3 id="10-针对目录和URL实现访问控制"><a href="#10-针对目录和URL实现访问控制" class="headerlink" title="10.针对目录和URL实现访问控制"></a>10.针对目录和URL实现访问控制</h3><p>（1）Options指令：</p>
<p>​    后面跟一个或多个空白字符分隔的选项列表，在选项前的<code>+,-</code>，表示增加或减少指定选项</p>
<p>​    常见选项：</p>
<ul>
<li>Indexes：指明的URL路径下不存在与定义的主页面资源向符的资源文件时，返回索引列表给用户</li>
<li>FollowSymLinks：允许访问符号链接文件所指向的源文件</li>
<li>None：全部禁用</li>
<li>All：全部允许</li>
</ul>
<p>（2）Allowoverride指令</p>
<p>与访问控制相关的指令可以放在指定目录下的.htaccess（由AccessFileName指令指定，AccessFileName .htaccess为默认值）文件中，覆盖之前的配置命令，只对语句有效</p>
<p>常用选项：</p>
<ul>
<li>AllowOverride ALL     #.htaccess中所有指令都有效</li>
<li>AllowOverride None  #.htaccess文件无效，httpd2.3.9之后的版本的默认值</li>
<li>AllowOverride AuthConfig   #.htaccess文件中，除了AuthConfig其他指令都无法生效</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">option indexes</span><br><span class="line">实现目录</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.htaccess 文件  在这个文件中写入控制命令，然后调用</span><br></pre></td></tr></table></figure>



<h3 id="11-基于客户端IP地址实现访问控制"><a href="#11-基于客户端IP地址实现访问控制" class="headerlink" title="11.基于客户端IP地址实现访问控制"></a>11.基于客户端IP地址实现访问控制</h3><p>两种控制方法：</p>
<ul>
<li>基于IP地址</li>
<li>基于用户账号</li>
</ul>
<p>基于客户端的IP地址的访问控制：</p>
<ul>
<li><p>无明确授权的目录，默认拒绝</p>
</li>
<li><p>允许所有主机访问：Require all granted</p>
</li>
<li><p>拒绝所有主机访问：Require all denied</p>
</li>
<li><p>控制特定的IP访问：</p>
<p>Require ip IPADDR：授权特定IP的访问</p>
<p>Require not ip IPADDR：拒绝特定IP的方位</p>
</li>
<li><p>控制特定主机访问：</p>
<p>Require host HOSTNAME：授权特定主机访问</p>
<p>Require not host HOSTNAME：拒绝特定主机访问</p>
</li>
</ul>
<p>特定的Require格式：</p>
<p>第一种：在这个Require标签中的命令必须全部匹配的IP才能访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;RequireAll&gt;</span><br><span class="line">	Require all granted</span><br><span class="line">	Require not ip 10.0.0.9</span><br><span class="line">&lt;&#x2F;RequireAll&gt;</span><br></pre></td></tr></table></figure>

<p>第二种：有一个成功匹配的条件就能访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;RequireAny&gt;</span><br><span class="line">	Require all denied</span><br><span class="line">	Require ip 10.0.0.7</span><br><span class="line">&lt;&#x2F;RequireAny&gt;</span><br></pre></td></tr></table></figure>

<h3 id="12-日志设定"><a href="#12-日志设定" class="headerlink" title="12.日志设定"></a>12.日志设定</h3><p>httpd有两种日志类型</p>
<ul>
<li>访问日志</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">访问日志有两个地方需要知道，第一个是存放位置，第二个是日志的格式</span><br><span class="line">存放位置：CustomLog &quot;logs&#x2F;access_log&quot; combined  后面的这个combined是自己定义的</span><br><span class="line">日志的格式：</span><br><span class="line"></span><br><span class="line">196     LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br><span class="line">197     LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common</span><br><span class="line">198 </span><br><span class="line">199     &lt;IfModule logio_module&gt;</span><br><span class="line">200       # You need to enable mod_logio.c to use %I and %O</span><br><span class="line">201       LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; %I %O&quot; combinedio</span><br><span class="line">202     &lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>格式的具体说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">大概说明：</span><br><span class="line">http:&#x2F;&#x2F;httpd.apache.org&#x2F;docs&#x2F;current&#x2F;mod&#x2F;mod_log_config.html#logformat</span><br><span class="line">具体参数：</span><br><span class="line">http:&#x2F;&#x2F;httpd.apache.org&#x2F;docs&#x2F;current&#x2F;mod&#x2F;mod_log_config.html#formats</span><br></pre></td></tr></table></figure>

<p>大概格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定义日志格式的格式：</span><br><span class="line">LogFormat &quot;xxx&quot; nickname</span><br><span class="line">使用日志的格式：</span><br><span class="line">CustomLog filename.log nickname        #这个nickname就是上面定义的nickname，可以定义多个格式，然后选择其中一个，然后把他的nickname写在customlog这里</span><br></pre></td></tr></table></figure>

<p>几个常见的格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%h	客户端IP地址</span><br><span class="line">%l	远程用户，启用mod_ident生效，如果没有使用用户，那么就是&quot;-&quot;</span><br><span class="line">%u	验证远程用户，basic digest，非登录用户时，是“-”</span><br><span class="line">%t	服务器接收到请求的时间，可以加格式，%&#123;%F %T&#125;t</span><br><span class="line">%r	请求报文的首行，记录了方法，请求资源，以及协议版本</span><br><span class="line">%&gt;s	响应码</span><br><span class="line">%b	以字节显示响应报文的大小，不包括响应报文的首部</span><br><span class="line">%&#123;VARNAME&#125;i	请求报文首部中，VARNAME，这个字段的值，比如Refer字段，就表示从哪里跳转过来的，User-Agent表示用户的代理程序，也就是浏览器</span><br></pre></td></tr></table></figure>



<ul>
<li>错误日志</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">错误日志一个是存放位置，另一个是日志的记录等级</span><br><span class="line">ErrorLog &quot;logs&#x2F;error_log&quot;</span><br><span class="line"># LogLevel: Control the number of messages logged to the error_log.</span><br><span class="line">186 # Possible values include: debug, info, notice, warn, error, crit,</span><br><span class="line">187 # alert, emerg.</span><br><span class="line">188 #</span><br><span class="line">189 LogLevel warn</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<p>自定义格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogFormat &quot;%h %l %u \&quot;%&#123;%F %T&#125;t\&quot; %&gt;s %&#123;User-Agent&#125;i&quot; testlog</span><br><span class="line">#主机IP，用户名，认证，设定了时间格式，首部行，状态码，浏览器信息，nickname是testlog</span><br><span class="line">CustomLog &quot;logs&#x2F;access_log&quot; testlog</span><br><span class="line"></span><br><span class="line">tail -f &#x2F;var&#x2F;log&#x2F;httpd&#x2F;access_log</span><br><span class="line">10.0.0.2 - - &quot;2020-10-29 17:14:03&quot; &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 304 Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;86.0.4240.111 Safari&#x2F;537.36 Edg&#x2F;86.0.622.56</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="13-设定默认字符集"><a href="#13-设定默认字符集" class="headerlink" title="13.设定默认字符集"></a>13.设定默认字符集</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddDefaultCharset UTF-8</span><br></pre></td></tr></table></figure>

<h3 id="14-定义路径别名"><a href="#14-定义路径别名" class="headerlink" title="14.定义路径别名"></a>14.定义路径别名</h3><p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alias &#x2F;URL&#x2F; &quot;&#x2F;PATH&#x2F;&quot;</span><br></pre></td></tr></table></figure>

<p>注意一点：一个目录就算写了别名，也一定要声明他的访问权限才可以，否则还是无法访问</p>
<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> 1 &lt;Directory &#x2F;data&#x2F;&gt;</span><br><span class="line"> 2     allowoverride none</span><br><span class="line"> 3     options Indexes</span><br><span class="line"> 4     &lt;RequireAny&gt;</span><br><span class="line"> 5         require ip 10.0.0.119</span><br><span class="line"> 6         require all denied                                                              </span><br><span class="line"> 7     &lt;&#x2F;RequireAny&gt;</span><br><span class="line"> 8 &lt;&#x2F;Directory&gt;</span><br><span class="line"> 9 </span><br><span class="line">10 &lt;IfModule alias_module&gt;</span><br><span class="line">11     Alias &#x2F;download  &quot;&#x2F;data&#x2F;&quot;</span><br><span class="line">12 &lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="15-基于用户名的访问控制"><a href="#15-基于用户名的访问控制" class="headerlink" title="15.基于用户名的访问控制"></a>15.基于用户名的访问控制</h3><p>分两步：</p>
<ul>
<li>认证质询：响应码为401，拒绝客户端请求，并说明客户端需要账号和密码</li>
<li>认证：客户端发来的报文中的账号和密码匹配成功了，那么服务器才返回资源</li>
</ul>
<p>认证的方式：</p>
<ul>
<li>basic：明文认证</li>
<li>digest：消息摘要认证，兼容性差</li>
</ul>
<p>安全域：需要用户认证后才能访问的路径</p>
<p>需要的条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.一个目录</span><br><span class="line">&lt;Directory &#x2F;path&gt;</span><br><span class="line">Options None</span><br><span class="line">AllowOverride None</span><br><span class="line">AuthType Basic               #认证的方式</span><br><span class="line">AuthName &quot;Prompt&quot;			 #提示用户的话</span><br><span class="line">AuthUserFile &quot;&#x2F;path&#x2F;user_password_file&quot;  	#认证文件，里面应该有账号和密码</span><br><span class="line">require user user1 user2   #或者写全部，require valid-user  #要求哪些用户可以来认证</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line"></span><br><span class="line">2.一个文件</span><br><span class="line">用于存放账号密码的文件是用命令生成的：</span><br><span class="line">htpasswd [options] &#x2F;path&#x2F;filename username</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<p>先写一个目录，然后规定认证方式，认证文件，认证用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Directory &#x2F;var&#x2F;www&#x2F;html&#x2F;test&#x2F;&gt;</span><br><span class="line">2 AuthType Basic                                                                          </span><br><span class="line">3 Authname &quot;验证&quot;</span><br><span class="line">4 Authuserfile &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;.htpasswd&quot;</span><br><span class="line">5 Require valid-user</span><br><span class="line">6 &lt;&#x2F;Directory&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建密码文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c &#x2F;var&#x2F;www&#x2F;html&#x2F;.htpasswd xiaohong</span><br></pre></td></tr></table></figure>



<h3 id="操作：实现家目录共享"><a href="#操作：实现家目录共享" class="headerlink" title="操作：实现家目录共享"></a>操作：实现家目录共享</h3><p>基于模块实现：mod_userdir.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_userdir.c&gt;</span><br><span class="line">	UserDir html</span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br><span class="line">&lt;Directory &#x2F;home&#x2F;lv&#x2F;html&gt;</span><br><span class="line">	require all granted</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line">访问的时候：http:&#x2F;&#x2F;IP&#x2F;~lv&#x2F;html&#x2F;</span><br></pre></td></tr></table></figure>



<h3 id="16-操作：隐藏服务器版本信息"><a href="#16-操作：隐藏服务器版本信息" class="headerlink" title="16.操作：隐藏服务器版本信息"></a>16.操作：隐藏服务器版本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServerTokens prod  建议使用</span><br><span class="line">使用之前：</span><br><span class="line">Server: Apache&#x2F;2.4.6 (CentOS)</span><br><span class="line">使用之后的版本信息：</span><br><span class="line">Server: Apache</span><br></pre></td></tr></table></figure>

<p>PHP也可以隐藏版本信息，是在<code>/etc/php.ini</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expose_php &#x3D; Off</span><br><span class="line">这个开启之后连PHP都不写，什么都没了</span><br></pre></td></tr></table></figure>

<p>通过curl检查报文头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http:&#x2F;&#x2F;10.0.0.7&#x2F;</span><br></pre></td></tr></table></figure>

<p>操作：隐藏服务器错误信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServerSignature ON | Off | EMail</span><br></pre></td></tr></table></figure>



<h3 id="17-操作：禁止trace方法"><a href="#17-操作：禁止trace方法" class="headerlink" title="17.操作：禁止trace方法"></a>17.操作：禁止trace方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TraceEnable On | Off | Extended</span><br></pre></td></tr></table></figure>

<p>默认是开启的，不安全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 html]$curl -IX OPTIONS 127.0.0.1</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Thu, 29 Oct 2020 10:57:42 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Allow: POST,OPTIONS,GET,HEAD,TRACE</span><br><span class="line">Content-Length: 0</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关闭后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 html]$curl -IX OPTIONS 127.0.0.1</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Thu, 29 Oct 2020 10:58:38 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Allow: POST,OPTIONS,GET,HEAD</span><br><span class="line">Content-Length: 0</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="18-操作：状态页面"><a href="#18-操作：状态页面" class="headerlink" title="18.操作：状态页面"></a>18.操作：状态页面</h3><p>通过模块实现：mod_status.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule status_module modules&#x2F;mod_status.so</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Location &quot;&#x2F;status&quot;&gt;</span><br><span class="line">2     SetHandler server-status</span><br><span class="line">3     &lt;RequireAny&gt;</span><br><span class="line">4         require all denied</span><br><span class="line">5         require ip 10.0.0.2</span><br><span class="line">6         require ip 10.0.0.7                                                             </span><br><span class="line">7     &lt;&#x2F;RequireAny&gt;</span><br><span class="line">8 &lt;&#x2F;Location&gt;</span><br></pre></td></tr></table></figure>



<h3 id="多虚拟主机"><a href="#多虚拟主机" class="headerlink" title="多虚拟主机"></a>多虚拟主机</h3><p>一台物理主机上实现多个网站</p>
<p>网站的唯一标识：</p>
<ul>
<li>IP相同，但端口不同 –&gt;只要访问的是一个物理主机，那么不管是哪个IP地址，只要端口一样网站就一样</li>
<li>IP不同，但端口均为默认端口</li>
<li>FQDN不同，IP和端口都相同</li>
</ul>
<p>使用FQDN更好，FQDN：Full Qualified Domain Name</p>
<h4 id="第一种：使用端口进行区分"><a href="#第一种：使用端口进行区分" class="headerlink" title="第一种：使用端口进行区分"></a>第一种：使用端口进行区分</h4><p>1.创建独立的文件目录 –&gt;每个网站</p>
<p>2.修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen port1</span><br><span class="line">listen port2</span><br><span class="line">&lt;virutallhost *:port1&gt;</span><br><span class="line">documentroot &#x2F;data&#x2F;web1</span><br><span class="line">&lt;directory &#x2F;data&#x2F;web1&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;&#x2F;directory&gt;</span><br><span class="line">&lt;&#x2F;virutalhost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="第二种：使用IP进行区分"><a href="#第二种：使用IP进行区分" class="headerlink" title="第二种：使用IP进行区分"></a>第二种：使用IP进行区分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;virtualhost IP:80&gt;，使用IP进行区别</span><br></pre></td></tr></table></figure>

<p>问题：一个网卡多个IP如何临时设置和写入配置文件？</p>
<h4 id="第三种：基于全限定域名进行区分"><a href="#第三种：基于全限定域名进行区分" class="headerlink" title="第三种：基于全限定域名进行区分"></a>第三种：基于全限定域名进行区分</h4><p>servername 进行区别，所以需要多个域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v www.a.com</span><br></pre></td></tr></table></figure>

<p>顺序的重要性，如果不写host，那么是基于主机头在配置文件中的顺序来进行默认访问的，没有主机头的网站将不能访问</p>
<p>基本配置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost IP:PORT&gt;</span><br><span class="line">ServerName FQDN</span><br><span class="line">DocumentRoot &quot;&#x2F;path&quot;</span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>建议把虚拟主机的配置文件放在独立的配置文件中</p>
<p>其他可以使用的指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServerAlias：虚拟主机的别名</span><br><span class="line">ErrorLog：错误日志，如果不写，那么虚拟主机的日志都会写到&#x2F;var&#x2F;log&#x2F;httpd&#x2F;error_log中</span><br><span class="line">CustomerLog：访问日志</span><br><span class="line">&lt;Directory&gt;  xxx  &lt;&#x2F;Directory&gt;</span><br></pre></td></tr></table></figure>

<p>只使用FQDN方式，因为这个是最好的</p>
<p>需要生成三个主目录，需要让访问这个IP的三个网站的用户机器上，有他们的DNS解析，可以通过手动修改<code>/etc/hosts</code>文件来完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.11   www.a.com www.b.com www.c.com</span><br></pre></td></tr></table></figure>

<p>配置文件：存放在<code>conf.d/</code>下，这个配置文件三个网站，每个配置文件都差不多，主要是几个部分：</p>
<p>1.定义虚拟主机部分</p>
<p><code>&lt;VirtualHost IP:Port&gt;  &lt;/VirtualHost&gt;</code>，这里面写网站名称，这是区分这三个网页的关键，在报文中体现为<code>Host字段</code>，还有定义网页的主目录，<code>DocumentRoot</code>，这里定义了每个网站的默认目录，也就是访问这个URL的时候<code>http://www.xxx.com/</code>，默认在哪个目录</p>
<p>2.给目录授权</p>
<p><code>&lt;Directory&gt;  &lt;/Directory&gt;</code></p>
<p>具体配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> 1 &lt;VirtualHost *:80&gt;</span><br><span class="line"> 2 ServerName www.a.com</span><br><span class="line"> 3 DocumentRoot &quot;&#x2F;data&#x2F;a.com&#x2F;htdocs&quot;</span><br><span class="line"> 4 ErrorLog &quot;logs&#x2F;error_log&quot;</span><br><span class="line"> 5 CustomLog &quot;logs&#x2F;access_log&quot; testlog</span><br><span class="line"> 6 &lt;Directory &quot;&#x2F;data&#x2F;a.com&#x2F;htdocs&quot;&gt;</span><br><span class="line"> 7 require all granted</span><br><span class="line"> 8 &lt;&#x2F;Directory&gt;</span><br><span class="line"> 9 &lt;&#x2F;VirtualHost&gt;</span><br><span class="line">10 </span><br><span class="line">11 &lt;VirtualHost *:80&gt;</span><br><span class="line">12 ServerName www.b.com</span><br><span class="line">13 DocumentRoot &quot;&#x2F;data&#x2F;b.com&#x2F;htdocs&quot;</span><br><span class="line">14 ErrorLog &quot;logs&#x2F;error_log&quot;</span><br><span class="line">15 CustomLog &quot;logs&#x2F;access_log&quot; testlog</span><br><span class="line">16 &lt;Directory &quot;&#x2F;data&#x2F;b.com&#x2F;htdocs&quot;&gt;</span><br><span class="line">17 require all granted</span><br><span class="line">18 &lt;&#x2F;Directory&gt;</span><br><span class="line">19 &lt;&#x2F;VirtualHost&gt;</span><br><span class="line">20 </span><br><span class="line">21 &lt;VirtualHost *:80&gt;</span><br><span class="line">22 ServerName www.c.com</span><br><span class="line">23 DocumentRoot &quot;&#x2F;data&#x2F;c.com&#x2F;htdocs&quot;</span><br><span class="line">24 ErrorLog &quot;logs&#x2F;error_log&quot;</span><br><span class="line">25 CustomLog &quot;logs&#x2F;access_log&quot; testlog                                                     </span><br><span class="line">26 &lt;Directory &quot;&#x2F;data&#x2F;c.com&#x2F;htdocs&quot;&gt;</span><br><span class="line">27 require all granted</span><br><span class="line">28 &lt;&#x2F;Directory&gt;</span><br><span class="line">29 &lt;&#x2F;VirtualHost&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 phpmyadmin]$curl www.a.com</span><br><span class="line">a:nihao,pengyou!</span><br><span class="line">[root@centos8 phpmyadmin]$curl www.b.com</span><br><span class="line">b:nihao,pengyou!</span><br><span class="line">[root@centos8 phpmyadmin]$curl www.c.com</span><br><span class="line">c:nihao,pengyou!</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>使用模块的方法实现：mod_deflate</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadMOdule deflate_module modules&#x2F;mod_deflate.so</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetOutputFilter DEFLATE</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I --compressed www.a.com&#x2F;m.html</span><br></pre></td></tr></table></figure>



<h3 id="实现HTTPS"><a href="#实现HTTPS" class="headerlink" title="实现HTTPS"></a>实现HTTPS</h3><p>Apache实现HTTPS的过程</p>
<p>1.为服务器申请数字证书，可以通过私有CA实现，创建CA，自签名，创建证书申请，签发证书</p>
<p>2.配置httpd支持使用SSL(TLS)，以及使用的证书</p>
<p>3.测试基于https访问相应的主机</p>
<p>下载模块，<code>mod_ssl</code>，这个模块中带了几个httpd的配置文件，里面开启了监听443端口和加载了ssl模块</p>
<p>CA，证书</p>
<p>怎么开的443端口？配置文件里写<code>Listen 443</code>就开了，证书和私钥和CA的证书写入到ssl.conf配置文件中</p>
<p>例子：</p>
<p>/etc/pki/tls/certs下自带了证书，可以直接通过https访问</p>
<h3 id="URL重定向"><a href="#URL重定向" class="headerlink" title="URL重定向"></a>URL重定向</h3><p>301：Moved Permanently</p>
<p>302：Moved Temporarily</p>
<p>307：Internal Redirect，曾经访问过一个网站后，再输入http时，浏览器会自动跳转到https，只对301生效</p>
<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redirect status url url1</span><br></pre></td></tr></table></figure>

<p>对于http重定向https不能这么设置，因为会无限套娃</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Redirect permanent &#x2F; https:&#x2F;&#x2F;10.0.0.11&#x2F;</span><br><span class="line">这么写，当访问的时候是这样：</span><br><span class="line">curl: (47) Maximum (50) redirects followed  重定向次数过多</span><br></pre></td></tr></table></figure>

<p><strong>如果想用这个格式写，需要用特殊格式写</strong></p>
<h3 id="HSTS技术"><a href="#HSTS技术" class="headerlink" title="HSTS技术"></a>HSTS技术</h3><p>HSTS：Http Strict-Transport-Security </p>
<p><code>Header always set Strict-Transport-Security</code></p>
<p>利用首次访问http服务器时获得的302重定向缓存，之后的302规定的有效期内，每次都是307访问，更快速，更安全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1 Header always set Strict-Transport-Security &quot;max-age&#x3D;31536000&quot;                    </span><br><span class="line">  2 RewriteEngine on</span><br><span class="line">  3 RewriteRule ^(&#x2F;.*)$ https:&#x2F;&#x2F;%&#123;HTTP_HOST&#125;$1 [redirect&#x3D;302]</span><br><span class="line">参数说明：</span><br><span class="line">max-age：The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS.</span><br></pre></td></tr></table></figure>



<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 phpmyadmin]$curl -I http:&#x2F;&#x2F;10.0.0.11</span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Date: Thu, 29 Oct 2020 12:53:39 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Strict-Transport-Security: max-age&#x3D;31536000</span><br><span class="line">Location: https:&#x2F;&#x2F;10.0.0.11&#x2F;</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node_7 conf.d]$curl -LkI 127.0.0.1</span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Date: Fri, 30 Oct 2020 00:58:48 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Strict-Transport-Security: max-age&#x3D;31536000</span><br><span class="line">Location: https:&#x2F;&#x2F;127.0.0.1&#x2F;</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Fri, 30 Oct 2020 00:58:48 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Strict-Transport-Security: max-age&#x3D;31536000</span><br><span class="line">Last-Modified: Thu, 29 Oct 2020 07:07:23 GMT</span><br><span class="line">ETag: &quot;1b-5b2c9ee889711&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 27</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="正向代理和反向代理"><a href="#正向代理和反向代理" class="headerlink" title="正向代理和反向代理"></a>正向代理和反向代理</h3><p>正向代理：用户知道，用户去配置，我觉得正向代理就是一个内容服务器的缓存服务器</p>
<p>反向代理：用户不知道，负责调度用户应该访问哪个后端内容服务器</p>
<h3 id="Sendfile-机制"><a href="#Sendfile-机制" class="headerlink" title="Sendfile 机制"></a>Sendfile 机制</h3><p>内核复制</p>
<p>减少CPU在内核空间和用户空间的切换时间，提高效率</p>
<h3 id="指定文件类型-content-type"><a href="#指定文件类型-content-type" class="headerlink" title="指定文件类型 content type"></a>指定文件类型 content type</h3><h2 id="http-协议和报文头结构"><a href="#http-协议和报文头结构" class="headerlink" title="http 协议和报文头结构"></a>http 协议和报文头结构</h2><p>http协议自身是无状态的，他的设计之初是为了展示的</p>
<p>http请求和http响应</p>
<p>curl -I</p>
<p>curl -vI 可以看到请求头</p>
<p>一个HTTP连接的过程中，应用层是请求和响应两种动作</p>
<h3 id="请求报文格式："><a href="#请求报文格式：" class="headerlink" title="请求报文格式："></a>请求报文格式：</h3><hr>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201028191354432.png" alt="image-20201028191354432"></p>
<p><strong>开始行：方法 /资源 HTTP/协议版本</strong></p>
<p><strong>首部字段行</strong></p>
<p><strong>空行</strong></p>
<p><strong>实体</strong></p>
<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HEAD &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: www.jd.com</span><br><span class="line">User-Agent: curl&#x2F;7.61.1</span><br><span class="line">Accept: *&#x2F;*</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="响应报文格式："><a href="#响应报文格式：" class="headerlink" title="响应报文格式："></a>响应报文格式：</h3><hr>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201028191754710.png" alt="image-20201028191754710"></p>
<p><strong>开始行：HTTP/协议版本 状态码 短语</strong></p>
<p><strong>首部字段行</strong></p>
<p><strong>空行</strong></p>
<p><strong>实体</strong></p>
<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Wed, 28 Oct 2020 11:16:36 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 111469</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age&#x3D;30</span><br><span class="line">Expires: Wed, 28 Oct 2020 11:16:57 GMT</span><br><span class="line">Ser: 45.242</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Via: BJ-Y-NX-102(EXPIRED), http&#x2F;1.1 ORI-CLOUD-HB-MIX-23 (jcs [cRs f ]), http&#x2F;1.1 HB-CM-1-MIX-171 (jcs [cRs f ])</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">X-Xss-Protection: 1; mode&#x3D;block</span><br><span class="line">Age: 9</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Timing-Allow-Origin: *</span><br><span class="line">X-Trace: 200;200-1603883792026-0-0-0-1-1;200-1603883796681-0-0-0-1-1</span><br><span class="line">Strict-Transport-Security: max-age&#x3D;360</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="HTTP报文格式解释"><a href="#HTTP报文格式解释" class="headerlink" title="HTTP报文格式解释"></a>HTTP报文格式解释</h3><h4 id="Method-方法"><a href="#Method-方法" class="headerlink" title="Method 方法"></a>Method 方法</h4><p>请求方法，标明客户端希望服务器对资源执行的动作，包括：</p>
<ul>
<li>GET：从服务器获取一个资源</li>
<li>HEAD：只从服务器获取文档的响应首部</li>
<li>POST：向服务器输入数据，通常会再由网关程序继续处理</li>
<li>PUT：将请求的主体部分存储在服务器中，比如上传文件</li>
<li>DELETE：请求删除服务器上指定的文档</li>
<li>TRACE：追踪请求到达服务器中间经过的代理服务器</li>
<li>OPTIONS：请求服务器返回对指定资源支持使用的请求方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -IX OPTIONS https:&#x2F;&#x2F;www.jd.com</span><br></pre></td></tr></table></figure>

<ul>
<li>CONNECT：建立一个到由目标资源表示的服务器的隧道</li>
<li>PATCH：用于对资源应用部分修改</li>
</ul>
<h4 id="Version-版本"><a href="#Version-版本" class="headerlink" title="Version 版本"></a>Version 版本</h4><p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HTTP/&lt;major&gt;.&lt;minor&gt;</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1</span><br><span class="line">HTTP&#x2F;2.0</span><br></pre></td></tr></table></figure>

<h4 id="http协议状态码"><a href="#http协议状态码" class="headerlink" title="http协议状态码"></a>http协议状态码</h4><p>由三位数字组成，标记请求处理过程中发生的情况</p>
<p>Mozilla的帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;Web&#x2F;HTTP&#x2F;Status?utm_source&#x3D;mozilla&amp;utm_medium&#x3D;devtools-netmonitor&amp;utm_campaign&#x3D;default</span><br></pre></td></tr></table></figure>

<p>http状态码分类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">100 - 199：信息响应</span><br><span class="line">200 - 299：成功响应</span><br><span class="line">300 - 399：重定向</span><br><span class="line">400 - 499：客户端错误</span><br><span class="line">500 - 599：服务器端错误</span><br></pre></td></tr></table></figure>

<hr>
<p>状态码由：section 10 of RFC 2616定义，地址<br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2616#section-10">https://tools.ietf.org/html/rfc2616#section-10</a></p>
<p>常用的状态码：</p>
<p><strong>200：OK</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">200：OK</span><br><span class="line">	The request has succeeded. The information returned with the responseis dependent on the method used in the request.</span><br></pre></td></tr></table></figure>

<p><strong>301：Move Permanently</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">301：Move Permanently</span><br><span class="line">   	The requested resource has been assigned a new permanent URI and any</span><br><span class="line">   future references to this resource SHOULD use one of the returned</span><br><span class="line">   URIs.  Clients with link editing capabilities ought to automatically</span><br><span class="line">   re-link references to the Request-URI to one or more of the new</span><br><span class="line">   references returned by the server, where possible. This response is</span><br><span class="line">   cacheable unless indicated otherwise.</span><br><span class="line"></span><br><span class="line">   	The new permanent URI SHOULD be given by the Location field in the</span><br><span class="line">   response. Unless the request method was HEAD, the entity of the</span><br><span class="line">   response SHOULD contain a short hypertext note with a hyperlink to</span><br><span class="line">   the new URI(s).</span><br><span class="line"></span><br><span class="line">   	If the 301 status code is received in response to a request other</span><br><span class="line">   than GET or HEAD, the user agent MUST NOT automatically redirect the</span><br><span class="line">   request unless it can be confirmed by the user, since this might</span><br><span class="line">   change the conditions under which the request was issued.</span><br><span class="line"></span><br><span class="line">      Note: When automatically redirecting a POST request after</span><br><span class="line">      receiving a 301 status code, some existing HTTP&#x2F;1.0 user agents</span><br><span class="line">      will erroneously change it into a GET request.</span><br></pre></td></tr></table></figure>

<p><strong>302：Move Temporary</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">The requested resource resides temporarily under a different URI.</span><br><span class="line">  Since the redirection might be altered on occasion, the client SHOULD</span><br><span class="line">  continue to use the Request-URI for future requests.  This response</span><br><span class="line">  is only cacheable if indicated by a Cache-Control or Expires header</span><br><span class="line">  field.</span><br><span class="line"></span><br><span class="line">  	The temporary URI SHOULD be given by the Location field in the</span><br><span class="line">  response. Unless the request method was HEAD, the entity of the</span><br><span class="line">  response SHOULD contain a short hypertext note with a hyperlink to</span><br><span class="line">  the new URI(s).</span><br><span class="line">  </span><br><span class="line">  	If the 302 status code is received in response to a request other</span><br><span class="line">  than GET or HEAD, the user agent MUST NOT automatically redirect the</span><br><span class="line">  request unless it can be confirmed by the user, since this might</span><br><span class="line">  change the conditions under which the request was issued.</span><br><span class="line"></span><br><span class="line">     Note: RFC 1945 and RFC 2068 specify that the client is not allowed</span><br><span class="line">     to change the method on the redirected request.  However, most</span><br><span class="line">     existing user agent implementations treat 302 as if it were a 303</span><br><span class="line">     response, performing a GET on the Location field-value regardless</span><br><span class="line">     of the original request method. The status codes 303 and 307 have</span><br><span class="line">     been added for servers that wish to make unambiguously clear which</span><br><span class="line">     kind of reaction is expected of the client.</span><br></pre></td></tr></table></figure>

<p><strong>304：Not Modified</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">If the client has performed a conditional GET request and access is</span><br><span class="line">  allowed, but the document has not been modified, the server SHOULD</span><br><span class="line">  respond with this status code. The 304 response MUST NOT contain a</span><br><span class="line">  message-body, and thus is always terminated by the first empty line</span><br><span class="line">  after the header fields.</span><br><span class="line"></span><br><span class="line">  The response MUST include the following header fields:</span><br><span class="line">     - Date, unless its omission is required by section 14.18.1</span><br><span class="line">	If a clockless origin server obeys these rules, and proxies and</span><br><span class="line">  		clients add their own Date to any response received without one (as</span><br><span class="line">  		already specified by [RFC 2068], section 14.19), caches will operate</span><br><span class="line">  		correctly.</span><br><span class="line"></span><br><span class="line">     - ETag and&#x2F;or Content-Location, if the header would have been sent</span><br><span class="line">       in a 200 response to the same request</span><br><span class="line"></span><br><span class="line">     - Expires, Cache-Control, and&#x2F;or Vary, if the field-value might</span><br><span class="line">       differ from that sent in any previous response for the same</span><br><span class="line">       variant</span><br><span class="line"></span><br><span class="line">  If the conditional GET used a strong cache validator (see section</span><br><span class="line">  13.3.3), the response SHOULD NOT include other entity-headers.</span><br><span class="line">  Otherwise (i.e., the conditional GET used a weak validator), the</span><br><span class="line">  response MUST NOT include other entity-headers; this prevents</span><br><span class="line">  inconsistencies between cached entity-bodies and updated headers.</span><br><span class="line"></span><br><span class="line">  If a 304 response indicates an entity not currently cached, then the</span><br><span class="line">  cache MUST disregard the response and repeat the request without the</span><br><span class="line">  conditional.</span><br><span class="line"></span><br><span class="line">  If a cache uses a received 304 response to update a cache entry, the</span><br><span class="line">  cache MUST update the entry to reflect any new field values given in</span><br><span class="line">  the response.</span><br></pre></td></tr></table></figure>

<p><strong>307：Temporary Redirect (Internal Redirect)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">The requested resource resides temporarily under a different URI.</span><br><span class="line">Since the redirection MAY be altered on occasion, the client SHOULD</span><br><span class="line">continue to use the Request-URI for future requests.  This response</span><br><span class="line">is only cacheable if indicated by a Cache-Control or Expires header</span><br><span class="line">field.</span><br><span class="line"></span><br><span class="line">The temporary URI SHOULD be given by the Location field in the</span><br><span class="line">response. Unless the request method was HEAD, the entity of the</span><br><span class="line">response SHOULD contain a short hypertext note with a hyperlink to</span><br><span class="line">the new URI(s) , since many pre-HTTP&#x2F;1.1 user agents do not</span><br><span class="line">understand the 307 status. Therefore, the note SHOULD contain the</span><br><span class="line">information necessary for a user to repeat the original request on</span><br><span class="line">the new URI.</span><br><span class="line"></span><br><span class="line">If the 307 status code is received in response to a request other</span><br><span class="line">than GET or HEAD, the user agent MUST NOT automatically redirect the</span><br><span class="line">request unless it can be confirmed by the user, since this might</span><br><span class="line">change the conditions under which the request was issued.</span><br></pre></td></tr></table></figure>

<p><strong>401：Unauthorized</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The request requires user authentication. The response MUST include a</span><br><span class="line"> WWW-Authenticate header field (section 14.47) containing a challenge</span><br><span class="line"> applicable to the requested resource. The client MAY repeat the</span><br><span class="line"> request with a suitable Authorization header field (section 14.8). If</span><br><span class="line"> the request already included Authorization credentials, then the 401</span><br><span class="line"> response indicates that authorization has been refused for those</span><br><span class="line"> credentials. If the 401 response contains the same challenge as the</span><br><span class="line"> prior response, and the user agent has already attempted authentication at least once, then    the user SHOULD be presented the entity that was given in the response, since that entity      might include relevant diagnostic information. HTTP access authentication is explained in     &quot;HTTP  Authentication: Basic and Digest Access Authentication&quot; [43].</span><br></pre></td></tr></table></figure>

<p><strong>403：Forbidden</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> The server understood the request, but is refusing to fulfill it.</span><br><span class="line">Authorization will not help and the request SHOULD NOT be repeated.</span><br><span class="line">If the request method was not HEAD and the server wishes to make</span><br><span class="line">public why the request has not been fulfilled, it SHOULD describe the</span><br><span class="line">reason for the refusal in the entity.  If the server does not wish to</span><br><span class="line">make this information available to the client, the status code 404</span><br><span class="line">(Not Found) can be used instead.</span><br></pre></td></tr></table></figure>

<p><strong>404：Not Found</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	The server has not found anything matching the Request-URI. No</span><br><span class="line">indication is given of whether the condition is temporary or</span><br><span class="line">permanent. The 410 (Gone) status code SHOULD be used if the server</span><br><span class="line">knows, through some internally configurable mechanism, that an old</span><br><span class="line">resource is permanently unavailable and has no forwarding address.</span><br><span class="line">This status code is commonly used when the server does not wish to</span><br><span class="line">reveal exactly why the request has been refused, or when no other</span><br><span class="line">response is applicable.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>500：Internal Server Error</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The server encountered an unexpected condition which prevented it from fulfilling the request.</span><br></pre></td></tr></table></figure>

<p><strong>502：Bad Gateway</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The server, while acting as a gateway or proxy, received an invalid</span><br><span class="line">response from the upstream server it accessed in attempting to</span><br><span class="line">fulfill the request.</span><br></pre></td></tr></table></figure>

<p><strong>503：Service Unavailable</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The server is currently unable to handle the request due to a</span><br><span class="line">temporary overloading or maintenance of the server. The implication</span><br><span class="line">is that this is a temporary condition which will be alleviated after</span><br><span class="line">some delay. If known, the length of the delay MAY be indicated in a</span><br><span class="line">Retry-After header. If no Retry-After is given, the client SHOULD</span><br><span class="line">handle the response as it would for a 500 response.</span><br><span class="line"></span><br><span class="line">   Note: The existence of the 503 status code does not imply that a</span><br><span class="line">   server must use it when becoming overloaded. Some servers may wish</span><br><span class="line">   to simply refuse the connection.</span><br></pre></td></tr></table></figure>

<p><strong>504：Gateway Timeout</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The server, while acting as a gateway or proxy, did not receive a</span><br><span class="line">timely response from the upstream server specified by the URI (e.g.</span><br><span class="line">HTTP, FTP, LDAP) or some other auxiliary server (e.g. DNS) it needed</span><br><span class="line">to access in attempting to complete the request.</span><br><span class="line"></span><br><span class="line">   Note: Note to implementors: some deployed proxies are known to</span><br><span class="line">   return 400 or 500 when DNS lookups time out.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="头部字段"><a href="#头部字段" class="headerlink" title="头部字段"></a>头部字段</h3><p>如果想查哪个头部字段，就去下面的帮助文档中查找，里面可以点开每个字段，查看具体介绍</p>
<p>Mozilla的帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;Web&#x2F;HTTP&#x2F;Headers</span><br></pre></td></tr></table></figure>

<p>键值对形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key: value1 value2</span><br></pre></td></tr></table></figure>

<p>根据不同上下文，可将消息头分为：</p>
<ul>
<li>通用消息头：General headers，同时适用于请求和响应消息，但与最终消息主体中传输的数据无关的消息头</li>
<li>请求消息头：Request headers，包含更多有关要获取的资源或客户端本身信息的消息头</li>
<li>响应消息头：Response headers，包含有关响应的补充信息，如其位置或服务器本身（名称和版本）的消息头</li>
<li>实体消息头：Entity headers，包含有关实体主体的更多信息，比如主体长（Content-Length）读或其他MIME类型</li>
</ul>
<p><strong>查询过的字段：</strong></p>
<p>age：资源存在于代理服务器中的时间，单位是秒</p>
<p>expires：资源的过期时间，这个时间取决于客户端本地的时间</p>
<p>cache-control：</p>
<ul>
<li>max-age：缓存资源的生存时间，这个时间取决于请求报文发送时间，即请求报文发送时间加max-age，就是这个缓存需要刷新的时间</li>
</ul>
<h3 id="Cookie和Session"><a href="#Cookie和Session" class="headerlink" title="Cookie和Session"></a>Cookie和Session</h3><p>介绍文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;Web&#x2F;HTTP&#x2F;Cookies</span><br></pre></td></tr></table></figure>

<p>HTTP协议本身无状态，无法记录用户信息；</p>
<p>因为HTTP协议在最初设计的目的是为了传输文档，后面文档定义了格式，也就是HTML，因此对HTTP来说没有必要有状态；</p>
<p>可是随着Web的不断发展，很多业务都需要状态–&gt;会话管理机制；</p>
<p><strong>会话管理：管理浏览器客户端和服务器端之间会话过程中产生的会话数据</strong>；</p>
<p>为了会话管理，HTTP就需要传输大量重复会话信息，造成了大量的网络带宽消耗，于是出现了Cookie和Session技术；</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><blockquote>
<p>​    Cookie基于HTTP协议，也叫Web Cookie或浏览器Cookie，是服务器发送到用户浏览器并保存在客户端本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一个浏览器，它可以保持用户的登录状态。它可以让无状态的HTTP记录状态信息。</p>
</blockquote>
<p><strong>Cookie主要使用：</strong></p>
<ul>
<li>会话状态管理，比如用户登录状态、购物车、游戏分数</li>
<li>个性化设置，比如用户自定义设置、主题</li>
<li>浏览器行为追踪</li>
</ul>
<p>Cookie的工作流程：</p>
<p>客户端浏览器连接服务器端–&gt;服务器端在向客户端发送响应报文时添加上一个<code>Set-Cookie</code>字段–&gt;客户端浏览器保存Cookie，下次给服务器发送报文时加上Cookie–&gt;服务器端收到报文后，检查Cookie是哪个主机的，然后根据Cookie记录的信息把之前的状态信息发给客户端</p>
<p>Set-Cookie字段：</p>
<ul>
<li>Name=VALUE 赋予Cookie的名称和值</li>
<li>expire=DATE  Cookie的有效期，如果没写明白，那么就是会话结束时到期；过期时间由客户端时间决定<ul>
<li>会话期Cookie：在一个会话期中的Cookie，会话结束就删除</li>
<li>持久性Cookie：基于硬盘保存的Cookie，有特殊的expire和age</li>
</ul>
</li>
<li>path=/PATH ，指明了主机下哪些路径可以接受Cookie</li>
<li>domain=域名，指定了哪些主机可以接受Cookie</li>
<li>Secure：标记为Secure的Cookie应该只通过HTTPS协议传输。但是敏感信息不应该通过Cookie传输</li>
<li>HTTPOnly  <code>HttpOnly</code> 类型的 Cookie 用于阻止了JavaScript 对其的访问性而能在一定程度上缓解此类攻击。</li>
</ul>
<p>浏览器对Cookie的限制：一个页面的Cookie个数应该小于20个，总大小小于4KB</p>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id&#x3D;123; Expires&#x3D;Wed, 21 Oct 2020 15:22:00 GMT;</span><br></pre></td></tr></table></figure>

<p>Cookie和Session与浏览器有关，更换浏览器就需要更换Cookie</p>
<p>Cookie和sessionID：都是服务器生成的</p>
<p>Cookie把sessionID传给用户；</p>
<p>Cookie把sessionID传回服务器；</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>session是相对于cookie的另外一个状态保持的解决方案，它是通过服务器来保持状态的。session指的是服务器上为每个客户端所开辟的独立存储空间，在其中保持的信息就是用于保存状态的。</p>
<p>服务器在程序运行过程中生成session，每个session有唯一的sessionid。sessionid就像是session的主键，用来标识这个session空间中的内容。</p>
<p>sessionid是怎么给客户端的？</p>
<ul>
<li>URL重写，让客户端获得sessionid</li>
<li>通过cookie存取，但是这个cookie是特殊的cookie，它不是一个磁盘文件，而是存在于内存中</li>
</ul>
<h4 id="session和cookie的区别"><a href="#session和cookie的区别" class="headerlink" title="session和cookie的区别"></a>session和cookie的区别</h4><ul>
<li>cookie通常是服务器端生成，保存在客户端，而session是在服务器端生成，保存在服务器端的内存中，session对服务器来说是一个负载</li>
<li>session比cookie安全，因为session在服务器端，cookie在客户端</li>
<li>cookie有会话级的cookie和持久的cookie，session没有时间限制，需要定期清除</li>
<li>session中有很多数据，只是他只把sessionid这个主要的数据发送给客户端，客户端下次访问的时候带上sessionid就可以匹配到session的所有数据</li>
</ul>
<p>cookie缺点：</p>
<ul>
<li>cookie不安全</li>
<li>cookie占带宽</li>
</ul>
<p>session缺点：</p>
<ul>
<li>不容易在多台服务器之间共享</li>
<li>session保存在服务器内存中，对服务器是个负载</li>
</ul>
<p>实际生产过程是cookie和session混合使用</p>
<h2 id="Web相关工具"><a href="#Web相关工具" class="headerlink" title="Web相关工具"></a>Web相关工具</h2><h3 id="1-links"><a href="#1-links" class="headerlink" title="1 links"></a>1 links</h3><p>命令行浏览器</p>
<h3 id="2-wget"><a href="#2-wget" class="headerlink" title="2 wget"></a>2 wget</h3><p>可以当浏览器用，在容器中常用，因为容器中很可能缺少curl等工具，下面的命令可以把网页内容下载下来，使用cat进行查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO a.html www.jd.com</span><br></pre></td></tr></table></figure>

<h3 id="3-curl"><a href="#3-curl" class="headerlink" title="3 curl"></a>3 curl</h3><p>测试使用</p>
<p>下载网页</p>
<p>curl -o a.hrml <a target="_blank" rel="noopener" href="http://www.xxx.haha/html">www.xxx.haha/html</a></p>
<p>性能测试工具</p>
<p>ab，不要乱用，本身就是有攻击性质</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -c 100 -n 2000 www.baidu.com</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/" class="post-title-link" itemprop="url">Redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：22:00:20" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="NoSQL数据库Redis"><a href="#NoSQL数据库Redis" class="headerlink" title="NoSQL数据库Redis"></a>NoSQL数据库Redis</h1><p><strong>nosql: not only sql</strong></p>
<h2 id="1-缓存技术"><a href="#1-缓存技术" class="headerlink" title="1 缓存技术"></a>1 缓存技术</h2><p>缓存是在物理速度有差距的两个硬件中间的过渡</p>
<p>一级缓存：</p>
<p>二级缓存：</p>
<p>三级缓存：</p>
<p>LRU：近期最少使用算法</p>
<p>凡事有利有弊，缓存也有问题；例如缓存中的数据与硬盘中的数据不一致；缓存价格高</p>
<h3 id="1-1-缓存"><a href="#1-1-缓存" class="headerlink" title="1.1 缓存"></a>1.1 缓存</h3><h4 id="1-1-1-buffer与cache"><a href="#1-1-1-buffer与cache" class="headerlink" title="1.1.1 buffer与cache"></a>1.1.1 buffer与cache</h4><p>buffer：缓冲，也叫写缓冲，一般用作写操作</p>
<p>清除缓存的方法：<code>echo 3 &gt; /proc/sys/vm/drop_caches</code>，查看帮助：<code>man proc</code>然后搜索<code>drop_caches</code></p>
<p>cache：缓存，也叫读缓存，一般用于读操作</p>
<h4 id="1-1-2-缓存保存位置及分层结构"><a href="#1-1-2-缓存保存位置及分层结构" class="headerlink" title="1.1.2 缓存保存位置及分层结构"></a>1.1.2 缓存保存位置及分层结构</h4><p>缓存技术是<code>互联网应用快速</code>的核心技术</p>
<ul>
<li>用户层：浏览器DNS缓存，应用程序DNS缓存，操作系统DNS缓存客户端</li>
<li>代理层：CDN，反向代理缓存</li>
<li>Web层：解释器Opcache，Web服务器缓存</li>
<li>应用层：页面静态化</li>
<li>数据层：分布式缓存，数据库</li>
<li>系统层：操作系统cache</li>
<li>物理层：磁盘cahche，Raid Cache</li>
</ul>
<h4 id="1-1-3-cache的特性"><a href="#1-1-3-cache的特性" class="headerlink" title="1.1.3 cache的特性"></a>1.1.3 cache的特性</h4><p>自动过期：给缓存的数据加上有效时间，超出时间后自动过期删除</p>
<p>强制过期：源网站更新图片后CDN是不会更新的，需要强制图片缓存过期，通过CDN后台设置</p>
<p>命中率：即缓存的读取命中率</p>
<h3 id="1-2-用户层缓存"><a href="#1-2-用户层缓存" class="headerlink" title="1.2 用户层缓存"></a>1.2 用户层缓存</h3><h4 id="1-2-1-DNS缓存"><a href="#1-2-1-DNS缓存" class="headerlink" title="1.2.1 DNS缓存"></a>1.2.1 DNS缓存</h4><p>浏览器的DNS缓存默认60秒</p>
<h4 id="1-2-2-查看浏览器的缓存"><a href="#1-2-2-查看浏览器的缓存" class="headerlink" title="1.2.2 查看浏览器的缓存"></a>1.2.2 查看浏览器的缓存</h4><p>火狐：about:cache</p>
<h4 id="1-2-2-前端使用的技术–dns-prefetch"><a href="#1-2-2-前端使用的技术–dns-prefetch" class="headerlink" title="1.2.2 前端使用的技术–dns-prefetch"></a>1.2.2 前端使用的技术–dns-prefetch</h4><p>HTML5的技术，可以在加载页面时提前将一些域名转换成IP地址</p>
<h4 id="1-2-4-浏览器缓存过期机制："><a href="#1-2-4-浏览器缓存过期机制：" class="headerlink" title="1.2.4 浏览器缓存过期机制："></a>1.2.4 浏览器缓存过期机制：</h4><p><strong>HTTP的状态码：304 Not Modified</strong> </p>
<p>304：服务器判断本地缓存文件与服务器上的文件一致，无需再次从服务器下载时，返回给用户304状态码</p>
<p><strong>if-last-modified：最后修改时间</strong></p>
<p><strong>Etags标记：Entity tag</strong></p>
<p>报文中有：If-None-Match  服务器会比较自己的文件的Etag值与if-None-Match的值是否一致</p>
<p>Etag：对文件的<strong>哈希运算（？）</strong>得到的值，每次都进行对比</p>
<p><strong>expire：有效期</strong></p>
<p>在有效期来临之前，不会重新向服务器发出该资源的请求</p>
<p><strong>混合使用前面提到的几种方式</strong></p>
<ul>
<li>Last-Modified和Expire，每次刷新都有新的Last-Modified</li>
<li>Etag和Expire一起使用，先判断Expire，然后判断Etag</li>
<li>三个一起用，先判断Expire，然后判断Last-Modified，再判断Etag</li>
</ul>
<p>缓存的刷新：</p>
<ul>
<li>第一次访问，获取最新数据，返回200响应码</li>
<li>鼠标点击或输入地址后回车（cache），浏览器对所有没有过期的内容直接使用本地缓存</li>
<li>F5或点刷新，浏览器会向服务器发送请求缓存协商信息，Last-Modified和Etag会有影响，但Expire不受影响，如果没有变化，返回304</li>
<li>ctrl+F5：不使用所有缓存，直接访问地址</li>
</ul>
<p><strong>Cookie和session</strong></p>
<p>cookie：访问网站时保持在本地的相关信息，比如账号密码，下次再访问的时候会在报文中增加cookie，方便一点</p>
<p>cookies：是服务器在客户单浏览器上存储的小段文本并随着每一个请求发送至同一个服务器，是一种实现客户端保持状态的方案</p>
<p>session：会话信息，位于web服务器上，主要负责访问者与网站之间的交互，当浏览器请求http地址时，可以基于之前的session实现会话保持、session共享。</p>
<h3 id="1-3-CDN缓存"><a href="#1-3-CDN缓存" class="headerlink" title="1.3 CDN缓存"></a>1.3 CDN缓存</h3><p>302重定向技术</p>
<p>CDN分层缓存技术</p>
<h3 id="1-4应用层缓存"><a href="#1-4应用层缓存" class="headerlink" title="1.4应用层缓存"></a>1.4应用层缓存</h3><p>Nginx、PHP等web服务器可以设置应用缓存以加速响应速度，另外有些解释性语言，比如：Python/PHP/Java不能直接运行，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候会出现程序代码上线后字节码没有更新的现象。所以上线新版前，需要先将应用缓存清理，再上线新版。</p>
<h3 id="1-5-数据层缓存"><a href="#1-5-数据层缓存" class="headerlink" title="1.5 数据层缓存"></a>1.5 数据层缓存</h3><p>分布式缓存服务：</p>
<ul>
<li>Redis</li>
<li>Memcache</li>
</ul>
<p>数据库</p>
<ul>
<li>Mysql查询缓存（不使用了）</li>
<li>InnoDB缓存、MYISAM缓存</li>
</ul>
<h3 id="1-6-CPU缓存"><a href="#1-6-CPU缓存" class="headerlink" title="1.6 CPU缓存"></a>1.6 CPU缓存</h3><p>CPU缓存（L1）、二级缓存（L2）、三级缓存（L3）</p>
<h2 id="2-Redis-部署和使用"><a href="#2-Redis-部署和使用" class="headerlink" title="2 Redis 部署和使用"></a>2 Redis 部署和使用</h2><h3 id="2-1-RDBMS和NOSQL的各自优缺点"><a href="#2-1-RDBMS和NOSQL的各自优缺点" class="headerlink" title="2.1 RDBMS和NOSQL的各自优缺点"></a>2.1 RDBMS和NOSQL的各自优缺点</h3><p>Redis (Remote Dictionary Server) ：是一个开源的、键值数据库</p>
<p>Redis在高并发、低延迟方面很好</p>
<p>NOSQL的根本优势在于云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高</p>
<p>NOSQL的事务支持弱，join的操作弱，通用性差</p>
<p>官方网站：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis特性"><a href="#2-2-Redis特性" class="headerlink" title="2.2 Redis特性"></a>2.2 Redis特性</h3><ul>
<li>速度快：10W并发，C语言开发，单线程</li>
<li>持久化</li>
<li>支持多种数据结构</li>
<li>支持多种变成语言</li>
<li>功能丰富：支持Luau脚本，发布订阅，事务，pipeline等功能</li>
<li>简单：代码短小精悍（23000行左右代码）</li>
<li>主从复制</li>
<li>支持高可用和分布式</li>
</ul>
<h3 id="2-3-单线程"><a href="#2-3-单线程" class="headerlink" title="2.3 单线程"></a>2.3 单线程</h3><p>单线程为什么这么快？</p>
<ul>
<li>纯内存</li>
<li>非阻塞</li>
<li>避免线程切换和竟态消耗</li>
</ul>
<p>注意：</p>
<ul>
<li>一次只运行一条命令</li>
<li>拒绝长命令</li>
<li>其实不是单线程：早期是单线程，3版本后还有其他线程，fysnc file,descriptor,close file descriptor</li>
</ul>
<p>能用来解决问题的技术</p>
<ul>
<li>session共享</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>互联网的计数器，比如微博的点赞，排行榜</li>
<li>微博/微信社交场合：共同好友、粉丝数、关注、点赞等</li>
<li>消息队列</li>
<li>地理位置</li>
</ul>
<h3 id="2-4-Redis-安装和使用"><a href="#2-4-Redis-安装和使用" class="headerlink" title="2.4 Redis 安装和使用"></a>2.4 Redis 安装和使用</h3><p><strong>1.yum安装，需要epel源</strong></p>
<p><strong>2.Redis的编译安装</strong></p>
<h4 id="2-1-编译安装步骤"><a href="#2-1-编译安装步骤" class="headerlink" title="2.1 编译安装步骤"></a>2.1 编译安装步骤</h4><p>下载</p>
<p>下载地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;</span><br></pre></td></tr></table></figure>

<p>选择一个5.x版本的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd redis-5.0.9</span><br><span class="line">make --PREFIX&#x3D;&#x2F;app&#x2F; install</span><br></pre></td></tr></table></figure>



<h4 id="2-2-内核参数修改"><a href="#2-2-内核参数修改" class="headerlink" title="2.2 内核参数修改"></a>2.2 内核参数修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn  #Redis需要511，系统默认是128，改成1024</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">#操作</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">To fix this issue run the command &#39;echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent    _hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the     setting after a reboot. Redis must be restarted after THP is disabled (set to &#39;madvise&#39; or &#39;never&#39;).</span><br><span class="line">#操作</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">#添加</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br></pre></td></tr></table></figure>

<h4 id="2-3-配置文件修改"><a href="#2-3-配置文件修改" class="headerlink" title="2.3 配置文件修改"></a>2.3 配置文件修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">11 # 1k &#x3D;&gt; 1000 bytes</span><br><span class="line">12 # 1kb &#x3D;&gt; 1024 bytes</span><br><span class="line">13 # 1m &#x3D;&gt; 1000000 bytes</span><br><span class="line">14 # 1mb &#x3D;&gt; 1024*1024 bytes                                                    </span><br><span class="line">15 # 1g &#x3D;&gt; 1000000000 bytes</span><br><span class="line">16 # 1gb &#x3D;&gt; 1024*1024*1024 bytes</span><br><span class="line">#文档中关于数据单位的说明</span><br></pre></td></tr></table></figure>

<p>配置文件讲解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">protected-mode yes #默认开启，这个是管理其他主机登录本机redis数据库的安全设置，本机只有设置了bind地址或者配置了密码才能被登录</span><br><span class="line">port 6379  #监听端口，TCP</span><br><span class="line">daemonize yes  #是否后台使用守护进程运行，默认是前台执行的</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid  </span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;    #生成数据文件的存放目录</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br><span class="line">timeout 0 #客户端和redis服务端的连接超时时间，默认是0，表示永不超时</span><br><span class="line">requirepass centos #密码</span><br><span class="line">maxclients  100000   #最大连接数</span><br><span class="line">maxmemory &lt;bytes&gt;  #Redis使用的最大内存，单位为字节，0是不限制，建议设置为物理内存的一半</span><br><span class="line">					注意不要出现OOM，Out Of Memory</span><br><span class="line">supervised systemd #默认为no，如果想用systemd管理，就设置成systemd</span><br><span class="line"></span><br><span class="line">#主从复制相关的选项</span><br><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt; #配置主服务器的IP和端口</span><br><span class="line">masterauth &lt;master-password&gt; #如果主服务器开启requirepass了，那么从服务器也需要输入密码</span><br><span class="line">replica-read-only yes #从服务器默认为只读</span><br><span class="line">repl-diskless-sync no #实验阶段，不推荐使用，默认就是拒绝</span><br><span class="line">rename-command  #重命名一些危险的命令，相当于屏蔽掉命令，比如keys * ,flushdb,flushall</span><br><span class="line">appendonly no #默认是no，appendonly是一种类似二进制的日志方式，而且优先级高于默认的rdb方式，当启				用appendonly后，redis启动时会从aof文件恢复数据</span><br><span class="line">appendfilename &quot;appendonly.aof&quot; aof文件，目录是dir指定的</span><br><span class="line">appendfsync everysec #默认的，每秒钟写一次</span><br><span class="line">#appendfsync always  #这个是安全，每次修改数据库都会写入磁盘，但是性能差</span><br><span class="line">no-appendfsync-on-rewrite no #建议设置为yes，这个是说在append重写的时候是否可以继续写磁盘，默								认是no，最安全，可以写磁盘，但是会阻塞；</span><br><span class="line">								设置为yes会写在缓冲区内，等重新结束后才写磁盘，这个性能好，但是								会不安全，因为最多有30秒时间的数据可能会因为断电等原因写不进磁盘</span><br><span class="line">auto-aof-rewrite-percentage 100 #自动重写检测的百分比，因为rewrite会根据aof中的清理数据库操作，比如del,flushdb等来删除数据，缩小文件大小，同时数据也是安全的。这个值的意思是aof增长超过一倍，那么就执行一次重写操作。</span><br><span class="line">auto-aof-rewrite-min-size 64mb  #触发rewrite的最小文件大小</span><br><span class="line">auto-load-truncated yes  #是否加载由于某些原因导致的末尾异常的AOF文件（主进程被kill&#x2F;断电等），建议yes</span><br><span class="line"></span><br><span class="line">#集群相关：</span><br><span class="line">cluster-enabled yes #是否开启集群模式，默认是不开启的</span><br><span class="line">cluster-config-file nodes-6379.conf #由node节点自动生成的集群配置文件名称</span><br><span class="line">cluster-node-timeout 15000  #集群中node节点连接超时时间，单位ms，超过此时间，会踢出集群</span><br><span class="line">cluster-replica-validity-factor 10 #单位是 “次数” </span><br><span class="line">cluster-migration-barrier 1 #集群迁移屏障，一个主节点至少拥有一个正常工作的从节点，即如果主节点的slave节点								故障后会将多余的从节点分配到当前主节点称为其新的从节点</span><br><span class="line">cluster-require-full-coverage yes #建议为no</span><br><span class="line">cluster-replica-no-failover no #默认是no，建议no</span><br><span class="line"></span><br><span class="line">#慢日志相关：</span><br><span class="line">slowlog-log-slower-than 10000 #以微妙为单位的慢日志记录，这个是10ms</span><br><span class="line">slowlog-max-len 128  #最多记录多少条慢日志的保存队列长度，滚动更新。先进先出，队列固定长度</span><br></pre></td></tr></table></figure>

<p>额外介绍</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LRU means Least Recently Used</span><br><span class="line">LFU means Least Frequently Used</span><br></pre></td></tr></table></figure>

<p>使用systemd的方式启动redis-server  </p>
<p><strong>注意：这个service是redis6.x版本的，不同版本之间的差异还是有的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;下建立redis_6379.service文件</span><br><span class="line">  1 [Unit]</span><br><span class="line">  2 Description&#x3D;Redis persistent key-value database</span><br><span class="line">  3 Wants&#x3D;network-online.target</span><br><span class="line">  4 After&#x3D;network-online.target</span><br><span class="line">  5 </span><br><span class="line">  6 [Service]</span><br><span class="line">  7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;conf&#x2F;redis_6379.conf --supervised systemd</span><br><span class="line">  8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line">  9 Type&#x3D;forking         #重点是这里，6.X的redis要写成forKing，后台模式，不能写notify                                                                                                                        </span><br><span class="line"> 10 User&#x3D;redis</span><br><span class="line"> 11 Group&#x3D;redis</span><br><span class="line"> 12 TimeoutStartSec&#x3D;infinity</span><br><span class="line"> 13 TimeoutStopSec&#x3D;infinity</span><br><span class="line"> 14 [Install]</span><br><span class="line"> 15 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.4编译安装和参数修改和配置文件修改的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	install_redis_5.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line"></span><br><span class="line">BASEDIR&#x3D;&#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">VERSION&#x3D;redis-5.0.9</span><br><span class="line">APPDIR&#x3D;&#x2F;app&#x2F;redis</span><br><span class="line">PASSWORD&#x3D;&quot;centos&quot;</span><br><span class="line">START_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line"></span><br><span class="line">check_env () </span><br><span class="line">&#123;</span><br><span class="line">    id redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &#39;redis用户已存在，请检查环境&#39; false </span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ -f $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;.tar.gz ];then</span><br><span class="line">        action &#39;源码包已存在，请检查环境&#39; false </span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    if [ -d $APPDIR ];then</span><br><span class="line">        action &quot;$&#123;APPDIR&#125;已存在，请检查环境&quot; false</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    action &quot;环境检查完成，开始安装$&#123;VERSION&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">install_redis () </span><br><span class="line">&#123;</span><br><span class="line">    yum -y install wget gcc jemalloc-devel  &amp;&gt;&#x2F;dev&#x2F;null || &#123; action &#39;依赖包安装失败&#39; false;exit 10;&#125;</span><br><span class="line">   </span><br><span class="line">    wget -P $&#123;BASEDIR&#125; https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;$&#123;VERSION&#125;.tar.gz &amp;&gt;&#x2F;dev&#x2F;null || action &#39;下载源码包失败&#39; false</span><br><span class="line">    cd $&#123;BASEDIR&#125;</span><br><span class="line">    tar xf $&#123;VERSION&#125;.tar.gz </span><br><span class="line">    </span><br><span class="line">    cd $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125; </span><br><span class="line">    echo &quot;开始编译安装&quot;</span><br><span class="line">    echo &quot;...&quot;</span><br><span class="line">    make PREFIX&#x3D;$&#123;APPDIR&#125; install &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;编译安装成功!&quot; || &#123; action &quot;编译安装失败&quot; false;exit 4; &#125;</span><br><span class="line">    </span><br><span class="line">    mkdir -p $&#123;APPDIR&#125;&#x2F;&#123;etc,data,run,log&#125; </span><br><span class="line">    </span><br><span class="line">    useradd -r -s &#x2F;sbin&#x2F;nologin redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">   </span><br><span class="line">    ln -s $&#123;APPDIR&#125;&#x2F;bin&#x2F;*  &#x2F;usr&#x2F;local&#x2F;bin&#x2F; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">    cp $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;&#x2F;redis.conf $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line">    sysctl -p</span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;rc.d&#x2F;rc.local&lt;&lt;EOF</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">EOF</span><br><span class="line">    chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    sed -i -E &quot;s&#x2F;^daemonize no&#x2F;daemonize yes&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^(bind ).*&#x2F;\10.0.0.0&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^supervised no&#x2F;supervised systemd&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(pidfile).*#\1 $&#123;APPDIR&#125;&#x2F;run&#x2F;redis.pid#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(logfile).*#\1 $&#123;APPDIR&#125;&#x2F;log&#x2F;redis.log#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dbfilename).*#\1 dump.rdb#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dir).*#\1 $&#123;APPDIR&#125;&#x2F;data&#x2F;#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;&#x2F;^# requirepass foobared&#x2F;a requirepass $&#123;PASSWORD&#125;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    chown -R redis.redis $&#123;APPDIR&#125;</span><br><span class="line">    </span><br><span class="line">    cat&gt;&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Redis persistent key-value database</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;$&#123;APPDIR&#125;&#x2F;bin&#x2F;redis-server $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf --supervised systemd</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT \$MAINPID</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">User&#x3D;redis</span><br><span class="line">Group&#x3D;redis</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl start redis &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;redis服务启动！&quot; || action &quot;redis服务启动失败，检查&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service，$&#123;APPDIR&#125;下的文件属性、配置文件&quot; false</span><br><span class="line">    END_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line">    USED_TIME&#x3D;$(( $END_TIME - $START_TIME ))    </span><br><span class="line">    echo &quot;脚本总用时：$&#123;USED_TIME&#125;s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_env</span><br><span class="line">install_redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.5写成playbook，使用角色实现</p>
<p><strong>3.Redis的多实例</strong></p>
<p>下面的这些选项中6379都改成其他端口，比如6380,6381等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>做好的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 redis]$tree</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── redis-benchmark</span><br><span class="line">│   ├── redis-check-aof</span><br><span class="line">│   ├── redis-check-rdb</span><br><span class="line">│   ├── redis-cli</span><br><span class="line">│   ├── redis-sentinel -&gt; redis-server</span><br><span class="line">│   └── redis-server</span><br><span class="line">├── conf</span><br><span class="line">│   ├── redis_6379.conf</span><br><span class="line">│   ├── redis_6380.conf</span><br><span class="line">│   └── redis_6381.conf</span><br><span class="line">├── data</span><br><span class="line">├── log</span><br><span class="line">│   ├── redis_6379.log</span><br><span class="line">│   ├── redis_6380.log</span><br><span class="line">│   ├── redis_6381.log</span><br><span class="line">│   └── redis.log</span><br><span class="line">└── run</span><br><span class="line">    ├── redis_6379.pid</span><br><span class="line">    ├── redis_6380.pid</span><br><span class="line">    └── redis_6381.pid</span><br><span class="line"></span><br><span class="line">5 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改内核参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn &#x3D; 1024 #Redis默认511，linux默认是128，太小了，所以要调整大一点</span><br><span class="line"></span><br><span class="line">vm.overcommit_memory &#x3D; 1 #linux默认是0，Redis建议设置为1</span><br><span class="line"></span><br><span class="line">&#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39;  ，然后把这个加入到&#x2F;etc&#x2F;rc.local中，因为这个是sys目录下的变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;apps&#x2F;redis&#x2F;etc&#x2F;redis.conf  #</span><br></pre></td></tr></table></figure>



<h3 id="2-5-慢查询"><a href="#2-5-慢查询" class="headerlink" title="2.5 慢查询"></a>2.5 慢查询</h3><p>slowlog-log-slower-than 10000  #单位是微秒，这个是10ms的意思，Redis的慢是指超过10ms</p>
<p>配置文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128 </span><br></pre></td></tr></table></figure>

<p>命令行指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slowlog len</span><br><span class="line">slowlog get N #查看具体的慢查询，可以限制个数</span><br><span class="line">slowlog reset</span><br></pre></td></tr></table></figure>

<p>一个命令大约在5us</p>
<h3 id="2-5-Redis-持久化"><a href="#2-5-Redis-持久化" class="headerlink" title="2.5 Redis 持久化"></a>2.5 Redis 持久化</h3><p>持久化：按照一定的策略把Redis内存中的数据存放到磁盘中，从而实现数据持久保存的目的</p>
<p>目前Redis支持两种方式的数据持久化保存机制，分别是RDB和AOF</p>
<p>RDB ~ MYSQL DUMP  –&gt;快照</p>
<p>AOF ~ MYSQL BINLOG  –&gt;写日志</p>
<h4 id="2-5-1-RDB模式"><a href="#2-5-1-RDB模式" class="headerlink" title="2.5.1 RDB模式"></a>2.5.1 RDB模式</h4><p>Redis-Server –&gt; fork子进程[专门用于dump操作] –&gt; 临时文件[temp-‘子进程PID’] –&gt; 覆盖到dump文件</p>
<p>配置文件中选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 294 #   In the example below the behaviour will be to save:</span><br><span class="line"> 295 #   after 900 sec (15 min) if at least 1 key changed</span><br><span class="line"> 296 #   after 300 sec (5 min) if at least 10 keys changed</span><br><span class="line"> 297 #   after 60 sec if at least 10000 keys changed</span><br><span class="line">#这个是自动保存规则，通过条件触发RDB保存</span><br><span class="line"> 307 save 900 1</span><br><span class="line"> 308 save 300 10</span><br><span class="line"> 309 save 60 10000</span><br></pre></td></tr></table></figure>

<p>手动执行RDB</p>
<ul>
<li><pre><code>save --&gt; 直接进行RDB备份，备份目录是配置文件中写好的
#同步执行，但是会阻塞其他命令，不推荐使用
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* &#96;&#96;&#96;</span><br><span class="line">  bgsave --&gt; 异步后台执行，不影响其他命令的执行，推荐使用，使用的时候参考一个参数，rdb_bgsave_in_progress &#x3D; 0  是0的时候就是执行完成了</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>数据还原：</p>
<p>把数据文件名称改成配置文件中规定的文件名，然后重启服务</p>
<p><strong>优劣势：</strong></p>
<p>优点：</p>
<ul>
<li>就像快照，可以保存多个版本，恢复数据的时候可以选择恢复到哪个时间点</li>
<li>性能好，它可以使用子进程进行备份操作，父进程在fork出一个子进程后将不参与I/O，所以不影响本身的读写操作</li>
<li>RDB在恢复大量数据时比AOF快</li>
</ul>
<p>缺点：</p>
<ul>
<li>在断电等情况发生时，可能会丢失两次备份之间的内存数据</li>
<li>当数据量比较大时，父进程fork一个子进程需要一点时间，因为redis单线程，会阻塞</li>
</ul>
<p><strong>脚本：手动方式备份RDB文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#注意：使用RDB恢复数据就不要开启AOF</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	backup_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILE&#x3D;&quot;dump&quot;</span><br><span class="line">PASSWD&#x3D;&quot;centos&quot;</span><br><span class="line"></span><br><span class="line">#For test path</span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning bgsave</span><br><span class="line">[ -d $BACKDIR ] || mkdir -p $BACKDIR </span><br><span class="line"></span><br><span class="line">single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line"></span><br><span class="line">until [ $single -eq 0 ];do</span><br><span class="line">    sleep 1</span><br><span class="line">    single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">DATE&#x3D;&#96;date +%F_%H-%M_%S&#96;</span><br><span class="line">cp $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILE&#125;.rdb $BACKDIR&#x2F;$&#123;DATAFILE&#125;_$&#123;DATE&#125;.rdb </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>脚本：手动方式还原最新的数据文件到redis</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	recover_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line">#recover the latest rdb file </span><br><span class="line"></span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILENAME&#x3D;&quot;dump.rdb&quot;</span><br><span class="line"></span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">systemctl stop redis</span><br><span class="line"></span><br><span class="line">LASTEST_FILENAME&#x3D;&#96;ls -lt $&#123;BACKDIR&#125; | awk &#39;NR&#x3D;&#x3D;2&#123;print $NF&#125;&#39;&#96;  #找出最新的备份文件</span><br><span class="line"></span><br><span class="line">rm -f $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125; </span><br><span class="line"></span><br><span class="line">cp $&#123;BACKDIR&#125;&#x2F;$&#123;LASTEST_FILENAME&#125; $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125;</span><br><span class="line"></span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-5-2-AOF模式"><a href="#2-5-2-AOF模式" class="headerlink" title="2.5.2 AOF模式"></a>2.5.2 AOF模式</h4><p><strong>AOF：AppendOnlyFile，按照顺序依次将操作追加到指定日志末尾</strong></p>
<p>fsync策略：</p>
<ul>
<li>每1秒钟写入一次文件；</li>
<li>每次变更数据时写入文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfsync everysec  #默认的everysec是每秒钟写入磁盘，改成always就是每次变更都写入文件</span><br></pre></td></tr></table></figure>

<p>默认是RDB，AOF需要开启配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;，数据文件的存放路径还是由 dir决定的</span><br></pre></td></tr></table></figure>

<p>AOF优先级比RDB高</p>
<p>从配置文件设定AOF启动后，重启服务时会使用AOF的数据文件，之前使用的RDB数据文件就没有被使用，因此有些问题。</p>
<p>正确的使用AOF的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.开启服务，默认使用RDB</span><br><span class="line">2.保存数据</span><br><span class="line">3.在命令行用config set appendonly yes 开启AOF</span><br><span class="line">4.观察数据目录中，是否已经将之前的RDB的数据文件写入AOF数据文件中了</span><br><span class="line">5.完成后，再去配置文件中启动AOF</span><br></pre></td></tr></table></figure>

<p>数据恢复操作：</p>
<p>在aof日志中删除之前的误操作动作，然后重启服务就好了</p>
<p><strong>AOF rewrite 重写</strong></p>
<p>将一些重复的，可以合并的，过期的数据重新写入一个新的AOF文件，从而节约AOF备份占用的硬盘空间，也能加速恢复过程</p>
<p>通过flushdb进行db0数据库的清空</p>
<p>bgwrite –&gt; 父进程 –&gt; fork一个子进程 –&gt; 子进程创建新的aof日志 –&gt; 父进程把rewrite数据写入新的aof日志 –&gt; 子进程把新的aof日志覆盖原来的aof日志</p>
<p>手动执行重新：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewriteaof</span><br></pre></td></tr></table></figure>

<p><strong>AOF的优缺点：</strong></p>
<p>优点：</p>
<ul>
<li>数据安全性高</li>
<li>写入日志的模式是追加的方式，更高效和安全</li>
<li>Redis可以在AOF文件体积变得过大时，自动地在后台对AOF进行重写，重写后的新AOF文件包含了恢复当前数据集的最小命令集合。整个重写过程是安全的，因为Redis是fork一个子进程来写入新的AOF日志，而append模式也就是父进程不断的将修改的数据追加到现有的AOF日志，即使重写过程发生停机，现有的AOF文件也不会丢失。而一旦新AOF文件创建完毕，Redis就会从旧AOF文件切换到新AOF文件，并开始对新AOF文件进行追加操作。</li>
<li>AOF包含一个格式清晰、易于理解的日志文件用于记录有所的修改操作。事实上，也可以通过该文件完成数据的重建。</li>
</ul>
<p>缺点：</p>
<ul>
<li>即使有些操作是重复的也会全部记录，AOF的文件大小要大于RDB模式的文件</li>
<li>AOF在恢复大数据集时的数据比RDB的恢复速度要慢</li>
<li>根据fsync策略不同，AOF速度可能慢于RDB</li>
<li>bug出现的可能性更多</li>
</ul>
<h3 id="2-6-Redis常用命令"><a href="#2-6-Redis常用命令" class="headerlink" title="2.6 Redis常用命令"></a>2.6 Redis常用命令</h3><p>官方文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;commands</span><br></pre></td></tr></table></figure>

<h4 id="2-6-1-INFO"><a href="#2-6-1-INFO" class="headerlink" title="2.6.1 INFO"></a>2.6.1 INFO</h4><p>获取信息</p>
<h4 id="2-6-2-SELECT"><a href="#2-6-2-SELECT" class="headerlink" title="2.6.2 SELECT"></a>2.6.2 SELECT</h4><h4 id="2-6-3-KEYS"><a href="#2-6-3-KEYS" class="headerlink" title="2.6.3 KEYS"></a>2.6.3 KEYS</h4><p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keys pattern</span><br><span class="line"></span><br><span class="line">例子</span><br><span class="line"></span><br><span class="line">keys * ......#这个是明令禁止的操作.....</span><br></pre></td></tr></table></figure>



<h4 id="2-6-4-BGSAVE"><a href="#2-6-4-BGSAVE" class="headerlink" title="2.6.4  BGSAVE"></a>2.6.4  BGSAVE</h4><h4 id="2-6-5-DBSIZE"><a href="#2-6-5-DBSIZE" class="headerlink" title="2.6.5 DBSIZE"></a>2.6.5 DBSIZE</h4><h4 id="2-6-6-FLUSHDB"><a href="#2-6-6-FLUSHDB" class="headerlink" title="2.6.6 FLUSHDB"></a><strong>2.6.6 FLUSHDB</strong></h4><h4 id="2-6-7-FLUSHALL"><a href="#2-6-7-FLUSHALL" class="headerlink" title="2.6.7 FLUSHALL"></a>2.6.7 FLUSHALL</h4><h4 id="2-6-8-SHUTDOWN"><a href="#2-6-8-SHUTDOWN" class="headerlink" title="2.6.8 SHUTDOWN"></a>2.6.8 SHUTDOWN</h4><p>禁用危险命令！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中找到rename-command</span><br><span class="line">配置：</span><br><span class="line">rename-command key* &#39;&#39;</span><br><span class="line">rename-command flushdb &#39;&#39;</span><br><span class="line">rename-command flushall &#39;&#39;</span><br></pre></td></tr></table></figure>



<h3 id="2-7-Redis的数据类型"><a href="#2-7-Redis的数据类型" class="headerlink" title="2.7 Redis的数据类型"></a>2.7 Redis的数据类型</h3><h4 id="2-7-1-字符串-string"><a href="#2-7-1-字符串-string" class="headerlink" title="2.7.1 字符串 string"></a>2.7.1 字符串 string</h4><p><strong>set命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set key value [ EX|PX ] time [NX|XX]</span><br><span class="line">EX：有效时间，单位是秒</span><br><span class="line">PX：有效时间，单位是毫秒</span><br><span class="line">NX：判断该键是否有值了，有值了就不动，没有值了才设置，XX相反</span><br></pre></td></tr></table></figure>

<p><strong>查看有效时间的命令ttl</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl key</span><br></pre></td></tr></table></figure>

<p><strong>get命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<p><strong>批量的命令mset，mget</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mget key1 key2 ..</span><br><span class="line">mset key1 value1 key2 value2...</span><br></pre></td></tr></table></figure>

<p><strong>字符串追加append，返回值是字节长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key1 ‘xxxxx’</span><br></pre></td></tr></table></figure>

<p><strong>返回字符串长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<p><strong>设置新值，返回旧值getset</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getset key1 new_value</span><br><span class="line">return old_value</span><br></pre></td></tr></table></figure>

<p><strong>判断键是否存在</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key1</span><br></pre></td></tr></table></figure>

<p><strong>数值递增递减</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INCR KEY1  加1</span><br><span class="line">DECR KEY1  减1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数值增加/减少</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INCRBY KEY1 NUMBER</span><br><span class="line">incrby age 20</span><br><span class="line">incrby age -20</span><br><span class="line"></span><br><span class="line">DECRBY KEY1 NUMBER</span><br><span class="line">decrby age 20</span><br><span class="line">decrby age -20</span><br></pre></td></tr></table></figure>



<h4 id="2-7-2-列表-list"><a href="#2-7-2-列表-list" class="headerlink" title="2.7.2 列表 list"></a>2.7.2 列表 list</h4><p>lpush：从左侧开始往列表中增加元素</p>
<p>rpush：从右侧开始往列表中增加元素</p>
<p>lrange：</p>
<p>lindex：</p>
<p>lpop：</p>
<p>rpop：</p>
<p>ltrim</p>
<h4 id="2-7-3-集合-set"><a href="#2-7-3-集合-set" class="headerlink" title="2.7.3 集合 set"></a>2.7.3 集合 set</h4><p>集合是唯一的，不能重复</p>
<p>sadd</p>
<p>smembers</p>
<p>srem</p>
<p>集合间操作</p>
<p>sinter</p>
<p>sunion</p>
<p>sdiff</p>
<p>有序集合 sorted set： –&gt; 排行榜</p>
<ul>
<li>有序</li>
<li>无重复元素</li>
<li>每个元素由score和value组成</li>
<li>score可以重复</li>
<li>value不可以重复</li>
</ul>
<p>zadd</p>
<p>zrange music 0 -1  #取出全部元素  </p>
<p>zcard music  #取出元素个数</p>
<p>zscore music  #取出分值</p>
<p>zrank</p>
<p>zrem</p>
<h4 id="2-7-4-哈希-hash"><a href="#2-7-4-哈希-hash" class="headerlink" title="2.7.4 哈希 hash"></a>2.7.4 哈希 hash</h4><p>hset </p>
<p>hgetall</p>
<p>type</p>
<p>hget </p>
<p>hmget</p>
<p>hdel</p>
<h3 id="2-8-消息队列"><a href="#2-8-消息队列" class="headerlink" title="2.8 消息队列"></a>2.8 消息队列</h3><p>消息队列：把要传输的数据放在队列中</p>
<p>功能：可以实现多个系统之间解耦，异步，削峰/限流等</p>
<p>消息队列主要分为两种，Redis都支持：</p>
<ul>
<li>生产者消费者模式</li>
<li>发布者订阅者模式</li>
</ul>
<p>生产者消费者：</p>
<p>先生产，后消费</p>
<p>列表的push和pop技术，生产数据，被消费，消费一次数据就没了</p>
<p>发布者和订阅者：</p>
<p>先订阅，后发布</p>
<p>订阅</p>
<p>发布</p>
<p>频道</p>
<p>subscribe channel </p>
<p>publish channel message</p>
<p>psubscribe 10*  #psubscribe支持通配符</p>
<h2 id="3-Redis-高可用性和集群"><a href="#3-Redis-高可用性和集群" class="headerlink" title="3 Redis 高可用性和集群"></a>3 Redis 高可用性和集群</h2><p>解决单点问题；</p>
<p>解决单机性能瓶颈问题</p>
<p>Redis的中间件（代理）是开发自己写，实现读写分离</p>
<h3 id="3-1-Redis-主从复制"><a href="#3-1-Redis-主从复制" class="headerlink" title="3.1 Redis 主从复制"></a>3.1 Redis 主从复制</h3><p>Redis自带高可用方案</p>
<p>复制缓冲区大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 512mb #需要设置一个足够大的缓冲区大小，否则从服务在获取数据时无法获取完整数据</span><br></pre></td></tr></table></figure>

<p><strong>启用主从</strong></p>
<p>在从节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip port</span><br><span class="line">config set masterauth password</span><br></pre></td></tr></table></figure>



<p>在主节点设置密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set masterauth password</span><br><span class="line">#配置文件修改</span><br><span class="line">requirepass centos</span><br></pre></td></tr></table></figure>



<p>搭好主从之后，从节点自动变成只读，能读不能写</p>
<p>主从节点的配置文件一定要一致，因为Redis主从复制时是对命令的复现，主节点输入什么，从节点也输入什么，比如对命令的rename-command，一定要一致，否则你主节点rename了一个flushdb命令，变成了hahahaah，那么当主节点输入这个命令时，执行了清空命令，但是，从节点不识别hahahahah，所以从节点没有执行清空命令</p>
<p>runid是主从复制的关键点，每当主从某一方的runid发生改变，那么都会发生全量的复制</p>
<p>runid在Redis服务重启后会重新生成一个新的</p>
<p>查看主从复制的信息：info replication</p>
<p>写入Redis的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip</span><br><span class="line"></span><br><span class="line">masterauth passwd</span><br></pre></td></tr></table></figure>



<p><strong>主从同步过程：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.从服务连接主服务器，发送PSYNC命令</span><br><span class="line"></span><br><span class="line">2.主服务器接收到PSYNC命令后，开始执行BGSAVE命令生成RDB快照文件并使用缓冲区记录这个记录点之后的所有写类型</span><br><span class="line"></span><br><span class="line">3.主服务器BGSAVE执行完成后，向所有从服务器发送RDB快照文件，并在发送期间继续记录被执行的写命令</span><br><span class="line"></span><br><span class="line">4.从服务器收到快照文件后丢弃所有旧数据，载入收到的快照到内存</span><br><span class="line"></span><br><span class="line">5.主服务器快照发送完毕后，开始向服务器发送缓冲区中的写命令</span><br><span class="line"></span><br><span class="line">6.从服务器完成对快照的载入，开始接收读命令请求，并执行来自主服务器缓冲区的命令</span><br><span class="line"></span><br><span class="line">7.后期同步会先发送自己salve_repl_offset位置，只同步新增加的数据，不再全量同步</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205309861.png" alt="image-20201022205309861"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205320223.png" alt="image-20201022205320223"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205326907.png" alt="image-20201022205326907"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205347005.png" alt="image-20201022205347005"></p>
<p>复制缓冲区（环形队列）</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205354193.png" alt="image-20201022205354193"></p>
<p>复制缓冲区（环形队列）的配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 1mb</span><br><span class="line"></span><br><span class="line">repl-backlog-ttl 3600</span><br></pre></td></tr></table></figure>



<h4 id="3-1-1-主从复制的优化："><a href="#3-1-1-主从复制的优化：" class="headerlink" title="3.1.1 主从复制的优化："></a><strong>3.1.1 主从复制的优化：</strong></h4><p>1.复制缓冲区尽量大，因为它承载着全量复制开始后写入主节点的数据</p>
<p>2.避免全量复制，第一次的全量复制不可避免，之后的可能产生全量复制的操作，比如主节点重启导致RUNID改变引起的复制或者是复制缓冲区小，导致主节点临时写入的、超出缓冲区的数据没有复制给从节点而导致的全量复制等情况要避免，可以使用哨兵或者Cluster</p>
<p>3.避免复制风暴，比如一个主，三个从，当主节点重启服务后启动，会让三个从节点同时去复制数据，造成大量数据传输，可以使用级联架构。</p>
<h3 id="3-2-哨兵-Sentinel"><a href="#3-2-哨兵-Sentinel" class="headerlink" title="3.2 哨兵 Sentinel"></a>3.2 哨兵 Sentinel</h3><p>功能：高可用，当主节点宕机，自动提升一个从节点为主节点</p>
<p>版本选择：在redis的2.8版本后sentinel就稳定了，生产环境建议使用2.8之后的redis</p>
<p><strong>使用的协议：流言协议(gossip protocols)来接收关于Master是否下线的消息，投票协议(Agreement Protocols)来决定否是执行自动故障迁移，以及选择哪个Slave作为新的Master</strong></p>
<p>一台主机可以被多个哨兵监控</p>
<p>哨兵可以监控多组主从；</p>
<p><strong>哨兵的故障转移步骤：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.多个sentinel发现并确认master有问题</span><br><span class="line">2.选举出一个sentinel作为领导</span><br><span class="line">3.选出一个salve作为master</span><br><span class="line">4.通知其余slave成为新master的slave</span><br><span class="line">5.通知客户端主从变换</span><br><span class="line">6.老的master修好重启后，将会成为新master的slave</span><br></pre></td></tr></table></figure>

<p>每个主从集群组要有一个名字，不同组的名字不能一样，否则sentinel无法识别；</p>
<blockquote>
<p> 主观down：SDOWN SubjectDown</p>
<p>客观down：ODOWN  ObjectDown</p>
<p>哨兵个数要设定为奇数个，防止脑裂</p>
</blockquote>
<blockquote>
<p>Sentinel实际上是一个特殊的redis服务器，有些redis指令支持，但更多的指令是不支持的。</p>
<p>默认监听端口：26379/TCP</p>
<p>Sentinel可以不和Redis服务器部署在一起，但一般部署在一起，所有Redis节点使用相同的配置</p>
</blockquote>
<p>哨兵的定时任务：</p>
<ul>
<li>每10s每个sentinel对master和slave执行info，发现节点的主从关系</li>
<li>每2s每个sentinel通过master节点的channel交换信息(pub/sub)，通过sentinel_:hello频道交互对节点的“看法”和自身信息</li>
<li>每1秒每个sentinel对其他sentinel和redis执行ping</li>
</ul>
<h4 id="3-2-1-实现主服务器的切换"><a href="#3-2-1-实现主服务器的切换" class="headerlink" title="3.2.1 实现主服务器的切换"></a>3.2.1 实现主服务器的切换</h4><p>操作：</p>
<blockquote>
<p>1.搭建主从，从节点比主节点多了一步，就是把主节点IP填写上<br>2.配置哨兵，哨兵可以理解为另一个redis-server，哨兵和客户端是发布-订阅模式</p>
</blockquote>
<p>1.搭建主从：一主两从</p>
<p>主节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>从节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">replicaof 10.0.0.7 6379</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>配置完成后，检查info信息，可以看到replication列表中有很多相关信息</p>
<p>哨兵的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim redis-sentinel.conf</span><br><span class="line">...</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis-sentinel.log</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 10.0.0.7 2 #最后的选项“2”，是投票选项，有两个哨兵认为主节点宕机了，那哨兵们就都认为它宕机了</span><br><span class="line"></span><br><span class="line">sentinel auth-pass mymaster password</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 3000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1 #当故障发生后，提拔了新的主节点后，新的主节点会按照这个选项，允许同时有几个从节点可以进行复制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-cli -a centos -p 26379 </span><br><span class="line"></span><br><span class="line">看到sentinel的数量与之前设置的sentinel数量匹配才是设置正确</span><br></pre></td></tr></table></figure>

<p>编译安装的redis的哨兵配置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;local&#x2F;src&#x2F;redis-5.0.9&#x2F;sentinel.conf &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br><span class="line">chown redis.redis &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br></pre></td></tr></table></figure>

<p>开启哨兵的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;redis-server &#x2F;etc&#x2F;sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<p>写一个service文件，参考redis.service的写法，只要改一下启动项就行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervised systemd</span><br></pre></td></tr></table></figure>

<p>完整的哨兵启动服务文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1 [Unit]</span><br><span class="line"> 2 Description&#x3D;Redis Sentinel</span><br><span class="line"> 3 Wants&#x3D;network-online.target</span><br><span class="line"> 4 After&#x3D;network-online.target</span><br><span class="line"> 5 </span><br><span class="line"> 6 [Service]</span><br><span class="line"> 7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervis    ed systemd</span><br><span class="line"> 8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line"> 9 Type&#x3D;notify</span><br><span class="line">10 User&#x3D;redis</span><br><span class="line">11 Group&#x3D;redis</span><br><span class="line">12                                                                                         </span><br><span class="line">13 [Install]</span><br><span class="line">14 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登录sentinel的方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 </span><br></pre></td></tr></table></figure>

<p>查看sentinel的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name&#x3D;mymaster,status&#x3D;ok,address&#x3D;10.0.0.7:6379,slaves&#x3D;2,sentinels&#x3D;3</span><br></pre></td></tr></table></figure>



<p>使用命令让一个主节点下线，实现切换主从</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 sentinel failover mymaster </span><br></pre></td></tr></table></figure>

<p>通过这个命令实现了把当前主服务器变成从服务器，提升一个原本的从服务器为主服务器！</p>
<blockquote>
<p>而且sentinel可以修改redis的配置文件，这点很好！</p>
</blockquote>
<h4 id="3-2-2-应用程序连接sentinel"><a href="#3-2-2-应用程序连接sentinel" class="headerlink" title="3.2.2 应用程序连接sentinel"></a>3.2.2 应用程序连接sentinel</h4><p>因为涉及到主节点的改变，所以程序在写入数据时需要动态获取主节点IP，这一点可以通过让客户端连接哨兵，因为哨兵是可以动态获取主服务器IP地址的，所以客户端只需要一直与哨兵联系就能获得实时的主服务器地址，那么这时候就客户端和哨兵之间就可以使用：订阅者-发布者模式。客户端订阅哨兵的频道，哨兵有新消息就发送到频道。</p>
<p>例如使用Python写的连接哨兵的客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3 python3-redis</span><br><span class="line"></span><br><span class="line">  1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">  2 </span><br><span class="line">  3 import redis</span><br><span class="line">  4 </span><br><span class="line">  5 from redis.sentinel import Sentinel                                            </span><br><span class="line">  6 </span><br><span class="line">  7 sentinel &#x3D; Sentinel([(&#39;10.0.0.7&#39;, 26379),</span><br><span class="line">  8                      (&#39;10.0.0.101&#39;, 26379),</span><br><span class="line">  9                      (&#39;10.0.0.110&#39;, 26379)],</span><br><span class="line"> 10                     socket_timeout &#x3D; 0.5)</span><br><span class="line"> 11 redis_auth_pass &#x3D; &#39;centos&#39;</span><br><span class="line"> 12 master &#x3D; sentinel.discover_master(&#39;mymaster&#39;)</span><br><span class="line"> 13 print(master)</span><br><span class="line"> 14 </span><br><span class="line"> 15 slave &#x3D; sentinel.discover_slaves(&#39;mymaster&#39;)</span><br><span class="line"> 16 print(slave)</span><br><span class="line"> 17 </span><br><span class="line"> 18 master &#x3D; sentinel.master_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 19                              password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 20 w_ret &#x3D; master.set(&#39;name&#39;, &#39;huihui&#39;)</span><br><span class="line"> 21 </span><br><span class="line"> 22 slave &#x3D; sentinel.slave_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 23                            password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 24 r_ret &#x3D; slave.get(&#39;name&#39;)</span><br><span class="line"> 25 print(r_ret)</span><br><span class="line"></span><br><span class="line">➜  ~ redis-cli -a centos</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-3-Redis-Cluster集群"><a href="#3-3-Redis-Cluster集群" class="headerlink" title="3.3 Redis Cluster集群"></a>3.3 Redis Cluster集群</h3><p>功能：解决单机写入的瓶颈问题</p>
<p>1.之前使用各个中间件：中间件本身存在单点失败问题</p>
<p>2.Redis 3.0之后推出了Cluster，无中心，每个节点保存当前节点数据和整个集群状态，每个节点都和其他所有节点连接。其实就是cluster集成在了redis程序中，需要使用的时候选择开启cluster模式，那么开启了cluster模式的redis就组成了cluster。因此客户端软件中只要写入了所有redis服务器的地址，就能够实现不需要一个管理服务器而以集群的方式访问redis数据库</p>
<p>Redis Cluster的特点：</p>
<ul>
<li>所有Redis节点使用PING机制互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点检测都失效，才能算真正的失效</li>
<li>客户端不需要proxy就可以直接连接redis，但是客户端中需要配置全部的redis服务器的IP</li>
<li>redis cluster把所有的redis node平均映射到0-16383个槽位(slot)上，读写需要到指定的redis node上进行操作，因此有多少个redis node就相当于redis并发扩展了多少倍，每个redis node承担 16384/N个槽位，当然这个得工程师自己设置分配的大小</li>
<li>Redis Cluster程序预先分配16384个槽位，当需要在redis集群中写入一个键值对的时候，会使用<strong>CRC16(key) mod 16384</strong> 来得出这个key的放置槽位应该是哪个，从而根据工程师自己分配的槽位和节点的关系来知道把这个键值对放置到哪个node服务器上，从而有效解决了单机瓶颈问题</li>
<li>Redis Cluster只是解决了单机瓶颈问题，但是在高可用方面还没解决，可以通过对每一个节点设置主从复制来解决这个问题，它也可以实现主服务器宕机自动提升从服务器为主的操作</li>
</ul>
<p><strong>注意：槽位是个逻辑概念，真实的数据还是在redis服务器上</strong></p>
<p>Cluster的执行过程</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201024192759734.png" alt="image-20201024192759734"></p>
<h4 id="3-3-1-Cluster集群的实现"><a href="#3-3-1-Cluster集群的实现" class="headerlink" title="3.3.1 Cluster集群的实现"></a>3.3.1 Cluster集群的实现</h4><p>Cluster实现：</p>
<ul>
<li>多个主，解决单点写入失败问题和单点性能瓶颈问题</li>
<li>每个主都建立一个从，实现主从复制，并且cluster支持主宕机自动切换主从</li>
</ul>
<p>Cluster的部署有多种方式：</p>
<ul>
<li>原生命令安装，用于理解Redis Cluster架构，生产环境就不推荐了</li>
<li>官方工具安装，高效、快速，生产环境可以用</li>
<li>自主开发工具，可以实现可视化的自动化部署</li>
</ul>
<h4 id="操作：使用原生命令部署"><a href="#操作：使用原生命令部署" class="headerlink" title="操作：使用原生命令部署"></a>操作：使用原生命令部署</h4><p>1.六个节点，三主三从</p>
<p>2.cluster中只有数据库0，分成了16384个槽位（slot）2^14</p>
<p>3.每个主节点承担 16384 / 3 个槽位</p>
<p>4.还需要用Python写客户端，用来连接服务器</p>
<p>5.扩容、缩容需要先删除源数据，然后扩容、缩容，再然后重新导入数据</p>
<p>6.原生命令手动部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">部署redis，全部节点开启cluster</span><br><span class="line">meet命令：先开会</span><br><span class="line">给每个节点分配槽位</span><br><span class="line">确立每个节点的主从关系</span><br></pre></td></tr></table></figure>

<p><strong>1.部署redis，全部节点开启cluster，其他的bind，requirepass，masterauth也需要有，这里没记录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &#39;&#x2F;# cluster-enabled yes&#x2F;a cluster-enabled yes&#39; -e &#39;&#x2F;cluster-enabled yes&#x2F;a cluster-config-file nodes-6379.conf&#39; -e &#39;&#x2F;# cluster-require-full-coverage yes&#x2F;a cluster-require-full-coverage no&#39;  &#x2F;app&#x2F;redis&#x2F;etc&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>先监控日志，然后启动redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis.log #开多个ssh窗口，一个监控日志，一个执行命令</span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br><span class="line">#查看到日志中：</span><br><span class="line"> 1705                 _._                                                  </span><br><span class="line"> 1706            _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line"> 1707       _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 5.0.9 (00000000&#x2F;0) 64 bit</span><br><span class="line"> 1708   .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> 1709  (    &#39;      ,       .-&#96;  | &#96;,    )     Running in cluster mode  #重点是这个，cluster mode</span><br><span class="line"> 1710  |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 6379</span><br><span class="line"> 1711  |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 2607</span><br><span class="line"> 1712   &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1713  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1714  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line"> 1715   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1716  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1717  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line"> 1718   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1719       &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line"> 1720           &#96;-._        _.-&#39;                                           </span><br><span class="line"> 1721               &#96;-.__.-&#39;                                                </span><br><span class="line">2607:M 24 Oct 2020 14:38:07.058 * Ready to accept connections</span><br><span class="line">2607:M 24 Oct 2020 14:38:09.143 # Cluster state changed: ok</span><br><span class="line"></span><br><span class="line">redis-cli -a centos info cluster</span><br><span class="line"></span><br><span class="line"># Cluster</span><br><span class="line">cluster_enabled:1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.meet，认识Cluster中的其他成员</strong></p>
<p>通过一台node就可以设置全部的node，meet具有传播性，A meet B，那么A接下来meet其他主机，B也就都知道了，因此这个命令操作5次就可以了</p>
<p>记得在操作前检查是否已经存在日志文件，如果有记得先备份了，然后删除日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.7 -a centos --no-auth-warning cluster meet 10.0.0.101 6379</span><br></pre></td></tr></table></figure>

<p>查看cluster命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster help</span><br><span class="line"> 1) CLUSTER &lt;subcommand&gt; arg arg ... arg. Subcommands are:</span><br><span class="line"> 2) ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.</span><br><span class="line"> 3) BUMPEPOCH -- Advance the cluster config epoch.</span><br><span class="line"> 4) COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports for &lt;node-id&gt;.</span><br><span class="line"> 5) COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys in &lt;slot&gt;.</span><br><span class="line"> 6) DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.</span><br><span class="line"> 7) FAILOVER [force|takeover] -- Promote current replica node to being a master.</span><br><span class="line"> 8) FORGET &lt;node-id&gt; -- Remove a node from the cluster.</span><br><span class="line"> 9) GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node in a slot.</span><br><span class="line">10) FLUSHSLOTS -- Delete current node own slots information.</span><br><span class="line">11) INFO - Return onformation about the cluster.</span><br><span class="line">12) KEYSLOT &lt;key&gt; -- Return the hash slot for &lt;key&gt;.</span><br><span class="line">13) MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.</span><br><span class="line">14) MYID -- Return the node id.</span><br><span class="line">15) NODES -- Return cluster configuration seen by node. Output format:</span><br><span class="line">16)     &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;</span><br><span class="line">17) REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.</span><br><span class="line">18) RESET [hard|soft] -- Reset current node (default: soft).</span><br><span class="line">19) SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.</span><br><span class="line">20) SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.</span><br><span class="line">21) REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.</span><br><span class="line">22) SLOTS -- Return information about slots range mappings. Each range is made of:</span><br><span class="line">23)     start, end, master and replicas IP addresses, ports and ids</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>meet后的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603526520177 1 connected</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603526520000 0 connected</span><br><span class="line">735a7e7371db2986b860248e26b2028f9d57df69 10.0.0.7:6379@16379 myself,master - 0 1603526522000 5 connected</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603526523234 2 connected</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603526521198 3 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603526522211 4 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.给每个节点分配槽位</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p password -a centos cluster addslots slotId</span><br><span class="line">#使用上面的命令一个一个的加很费劲，写一个脚本加</span><br><span class="line"></span><br><span class="line">#槽位的分配可以平均分配，我们是3个主3个从节点，那么就分三份，因为从节点只用来主从，不使用写操作</span><br></pre></td></tr></table></figure>

<p>写一个分配槽位的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-10-24</span><br><span class="line"> 7 #FileName:  redis_allocate_slots.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 </span><br><span class="line">11 #need three arguments,$1 for IP, $2 for start position, $3 for stop position</span><br><span class="line">12 HOST&#x3D;&#39;&#39;</span><br><span class="line">13 PORT&#x3D;6379</span><br><span class="line">14 PASSWORD&#x3D;&#39;centos&#39;</span><br><span class="line">15 HOST&#x3D;$1</span><br><span class="line">16 START_POSITION&#x3D;$2</span><br><span class="line">17 STOP_POSITION&#x3D;$3</span><br><span class="line">18 </span><br><span class="line">19 for ((SLOTID&#x3D;$START_POSITION;SLOTID&lt;&#x3D;$STOP_POSITION;SLOTID++));                      </span><br><span class="line">20 do</span><br><span class="line">21     echo &quot;slot:$SLOTID&quot; </span><br><span class="line">22     redis-cli -h $HOST -p $PORT -a $PASSWORD --no-auth-warning cluster addslots \</span><br><span class="line">23         $SLOTID</span><br><span class="line">24 done</span><br><span class="line">25 </span><br><span class="line">26 #other method</span><br><span class="line">27 </span><br><span class="line">28 #for SLOTID in &#96;seq $2 $3&#96;;do</span><br><span class="line">29 # xxxxx</span><br><span class="line">30 #done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用脚本进行分配：0<del>5461 5462</del>10922 10923~16383</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash redis_allocate_slots.sh 10.0.0.7 0 5461</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.101 5462 10992</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.7 10993 10683</span><br></pre></td></tr></table></figure>

<p>如果错误了，执行这两个命令清除本节点的槽位，并且让其他节点忘记自己，或者把全部的Cluster生成的Node-6379.conf文件删除，重启服务，然后重新添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#进入redis，注意情况槽位命令是在本槽位执行，忘记节点的命令是在其他所有节点都要执行，然后本节点重新meet</span><br><span class="line">cluster flushslots</span><br><span class="line"></span><br><span class="line">cluster forget nodeId</span><br></pre></td></tr></table></figure>

<p>槽位分配完成后查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531283731 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603531284755 3 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531284000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603531285000 0 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603531285771 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531286786 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>4.确定主从关系</strong></p>
<p>使用下面的命令，把当前节点设置为该Node号对应的redis的从节点</p>
<p>比如第一个：让11节点变成bee1594fe4100436e04459ff516c2f52ebe18f41对应的redis服务器的从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.11 -a centos --no-auth-warning cluster replicate bee1594fe4100436e04459ff516c2f52ebe18f41</span><br></pre></td></tr></table></figure>

<p>执行完成的效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531877891 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 slave bee1594fe4100436e04459ff516c2f52ebe18f41 0 1603531876000 6 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531876000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 slave 5a2604519a94555225231bacdbef54f9f41be38a 0 1603531876873 2 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 slave 1ff2c9229779ea27d54890a9adda44b80e199157 0 1603531876000 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531875848 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试cluster的写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name huihui</span><br><span class="line">(error) MOVED 5798 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set k1 huihui</span><br><span class="line">(error) MOVED 12706 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set k2 huihui</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br><span class="line">#根据Key的不同，放入不同的槽位</span><br></pre></td></tr></table></figure>

<p>cluster中有关键和槽位的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster keyslot keyname</span><br><span class="line">#返回这个键存储在哪个槽位中</span><br><span class="line"></span><br><span class="line">cluster getkeysinslot slot 1  </span><br><span class="line">#返回本节点的某个槽位中是什么键</span><br></pre></td></tr></table></figure>

<p>如果想不去重定向寻找的话，可以在redis-cli后跟-c选项，这个选项可以自动重定向到指定redis服务器寻找键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br></pre></td></tr></table></figure>

<p>如果要从从节点上查看数据，需要开启readonly选项，这个选项是专门开启集群中的从节点的读模式的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help readonly</span><br><span class="line"></span><br><span class="line">  READONLY -</span><br><span class="line">  summary: Enables read queries for a connection to a cluster replica node</span><br><span class="line">  since: 3.0.0</span><br><span class="line">  group: cluster</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试主从切换：</p>
<p>关闭10.0.0.7的redis服务，然后他的从节点11在10s左右后，成为了主节点，并继承了7的槽位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1598:S 24 Oct 2020 17:53:40.651 * Connecting to MASTER 10.0.0.7:6379</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.652 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.654 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.961 # Starting a failover election for epoch 7.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # Failover election won: I&#39;m the new master.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # configEpoch set to 7 after successful failover</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 # Setting secondary replication ID to 6d95441d58cb6f12eb56b1bc5495434fb08f3f57, valid up to offset: 2073. New replication ID is a01291fd6ff422a13139bc5fa71f17687845f37e</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 * Discarding previously cached master state.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>恢复了7后，7成了11的从节点！</p>
<p><strong>redis涉及到的几个端口：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis:6379</span><br><span class="line">sentinel:26379</span><br><span class="line">cluster:16379</span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-5-0部署Cluster"><a href="#操作：使用Redis-5-0部署Cluster" class="headerlink" title="操作：使用Redis 5.0部署Cluster"></a>操作：使用Redis 5.0部署Cluster</h4><p>需要使用到的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br></pre></td></tr></table></figure>

<p><strong>注意：在操作前先监控日志</strong></p>
<p>部署要求：</p>
<ul>
<li>每个redis节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何书籍</li>
<li>先启动为单机redis且没有任何key value</li>
</ul>
<p>1.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster create 10.0.0.7:6379 10.0.0.101:6379 10.0.0.110:6379 1</span><br><span class="line">0.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line">#命令说明：</span><br><span class="line">--cluster create  表示创建集群</span><br><span class="line">后面跟着的主机名:端口，表示要加入集群的主机和端口</span><br><span class="line">--cluster-replicas 1  表示集群中主从复制，并且每个主节点配合一个从节点</span><br><span class="line">cluster会自动把前面三个变成主节点，后面三个变成从节点</span><br></pre></td></tr></table></figure>

<p>创建的过程中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383                       #分配槽位</span><br><span class="line">Adding replica 10.0.0.12:6379 to 10.0.0.7:6379</span><br><span class="line">Adding replica 10.0.0.13:6379 to 10.0.0.101:6379</span><br><span class="line">Adding replica 10.0.0.11:6379 to 10.0.0.110:6379       #分配主从节点</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept):  #需要接受或拒绝</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完成的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">........</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看当前的集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6           #节点个数</span><br><span class="line">cluster_size:3                  #主节点个数，也是主从对的个数</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:92</span><br><span class="line">cluster_stats_messages_pong_sent:94</span><br><span class="line">cluster_stats_messages_sent:186</span><br><span class="line">cluster_stats_messages_ping_received:89</span><br><span class="line">cluster_stats_messages_pong_received:92</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:186</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试多个主节点分别写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set huihui jiayou</span><br><span class="line">(error) MOVED 16071 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota haowan</span><br><span class="line">(error) MOVED 7267 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota2 haowan</span><br><span class="line">(error) MOVED 14116 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>测试主从的切换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关闭主节点7，看它的从节点11会怎么样</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.826 # Starting a failover election for epoch 7.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # Failover election won: I&#39;m the new master.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # configEpoch set to 7 after successful failover</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 # Setting secondary replication ID to 1786540a1dc01f327cbde7f520591090c96a9f4d, valid up to offset: 715. New replication ID is 6e95b3f60a28e9510a43da88105357924d1e344d</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 * Discarding previously cached master state.</span><br><span class="line">切换成功！</span><br></pre></td></tr></table></figure>

<p>写一个可以向集群写入数据的Python脚本：用redis-cli -c 可能更方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line"> 2 </span><br><span class="line"> 3 from rediscluster import RedisCluster</span><br><span class="line"> 4 startup_nodes &#x3D; [</span><br><span class="line"> 5     &#123;&quot;host&quot;:&quot;10.0.0.7&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 6     &#123;&quot;host&quot;:&quot;10.0.0.101&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 7     &#123;&quot;host&quot;:&quot;10.0.0.110&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 8     &#123;&quot;host&quot;:&quot;10.0.0.11&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 9     &#123;&quot;host&quot;:&quot;10.0.0.12&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line">10     &#123;&quot;host&quot;:&quot;10.0.0.13&quot;, &quot;port&quot;:6379&#125;</span><br><span class="line">11 ]</span><br><span class="line">12 redis_conn &#x3D; RedisCluster(startup_nodes &#x3D; startup_nodes, password &#x3D; &#39;centos&#39;, \</span><br><span class="line">13                          decode_responses &#x3D; True)</span><br><span class="line">14 </span><br><span class="line">15 for i in range(0, 10000):</span><br><span class="line">16     redis_conn.set(&#39;huihuide&#39; + str(i), &#39;xinxinde&#39; + str(i))</span><br><span class="line">17     print(&#39;huihuide&#39; + str(i) + &#39;:&#39;, redis_conn.get(&#39;huihuide&#39; + str(i)) )</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-4-x-部署Cluster"><a href="#操作：使用Redis-4-x-部署Cluster" class="headerlink" title="操作：使用Redis 4.x 部署Cluster"></a>操作：使用Redis 4.x 部署Cluster</h4><p>1.编译安装，用ansible安装一遍</p>
<p>使用了ansible的角色，角色目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  redis tree</span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── redis-4.0.14.tar.gz</span><br><span class="line">│   └── redis_arguments.sh</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── copy_redis_config.yml</span><br><span class="line">│   ├── copy_redis_service.yml</span><br><span class="line">│   ├── groupadd.yml</span><br><span class="line">│   ├── homedir.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── make_install.yml</span><br><span class="line">│   ├── modify_arguments.yml</span><br><span class="line">│   ├── start_redis.yml</span><br><span class="line">│   ├── symbolic_link.yml</span><br><span class="line">│   ├── unarchive.yml</span><br><span class="line">│   └── useradd.yml</span><br><span class="line">└── templates</span><br><span class="line">    ├── redis.conf.j2</span><br><span class="line">    ├── redis.service.j2</span><br><span class="line">    └── sentinel.conf.j2</span><br><span class="line"></span><br><span class="line">4 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总体需要什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.一个调用角色的playbook，我这里是：role_redis_4.yml，注意这个文件需要跟roles目录同级别，redis角色应该是在roles目录下一个叫redis的目录，角色名称和目录名称要一致</span><br><span class="line">2.一个角色目录，包括：tasks,handlers,files,temples</span><br><span class="line">3.每个目录下的若干文件</span><br></pre></td></tr></table></figure>

<p>执行之后，在六台主机上部署了redis</p>
<p>2.使用ruby脚本</p>
<p>需要首先编译安装ruby，因为yum自带的ruby版本太老了，无法使用。</p>
<p>去ruby官网下载源码，然后根据官网的指导编译安装即可，安装完成后还得gem安装一个redis</p>
<p>官网地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;downloads&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;documentation&#x2F;installation&#x2F;#building-from-source</span><br></pre></td></tr></table></figure>

<p>安装ruby的redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>

<p>3.使用redis自带的ruby脚本，位于源码包的src文件中，叫redis-trib.rb，可以把它软链接到/usr/local/bin/下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb </span><br><span class="line">Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;</span><br><span class="line"></span><br><span class="line">  create          host1:port1 ... hostN:portN</span><br><span class="line">                  --replicas &lt;arg&gt;</span><br><span class="line">  check           host:port</span><br><span class="line">  info            host:port</span><br><span class="line">  fix             host:port</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">  reshard         host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --to &lt;arg&gt;</span><br><span class="line">                  --slots &lt;arg&gt;</span><br><span class="line">                  --yes</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">  rebalance       host:port</span><br><span class="line">                  --weight &lt;arg&gt;</span><br><span class="line">                  --auto-weights</span><br><span class="line">                  --use-empty-masters</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --simulate</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">                  --threshold &lt;arg&gt;</span><br><span class="line">  add-node        new_host:new_port existing_host:existing_port</span><br><span class="line">                  --slave</span><br><span class="line">                  --master-id &lt;arg&gt;</span><br><span class="line">  del-node        host:port node_id</span><br><span class="line">  set-timeout     host:port milliseconds</span><br><span class="line">  call            host:port command arg arg .. arg</span><br><span class="line">  import          host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --copy</span><br><span class="line">                  --replace</span><br><span class="line">  help            (show this help)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb create --replicas 1 10.0.0.101:6379 10.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 10.0.0.14:6379 10.0.0.110:6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>操作和5.X版本redis没有区别，就是执行脚本不一样，4.X是用ruby，5.X是集成到了redis-cli中！</p>
<h4 id="3-3-2-集群的扩容"><a href="#3-3-2-集群的扩容" class="headerlink" title="3.3.2 集群的扩容"></a>3.3.2 集群的扩容</h4><p><strong>注意：先让开发把数据导出，然后备份数据，然后清空数据库，然后再扩容</strong></p>
<p>1.成主从对的扩容，也就是一对一对的增加，但是注意，整体集群的个数要保持在奇数个</p>
<p>2.新加主从对的配置</p>
<p>3.添加主从对里的主节点到集群</p>
<p>4.重新分配槽位</p>
<p>5.添加主从对里的从节点到集群，先添加进去，然后设置为从</p>
<p><strong>添加节点准备：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">新的节点全部配置要和集群中的节点配置相同，且新加入的节点也应该为一主一从</span><br></pre></td></tr></table></figure>

<p>需要使用的命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line">redis-cli 5.0.9</span><br><span class="line"></span><br><span class="line">Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]</span><br><span class="line">  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).</span><br><span class="line">  -p &lt;port&gt;          Server port (default: 6379).</span><br><span class="line">  -s &lt;socket&gt;        Server socket (overrides hostname and port).</span><br><span class="line">  -a &lt;password&gt;      Password to use when connecting to the server.</span><br><span class="line">                     You can also use the REDISCLI_AUTH environment</span><br><span class="line">                     variable to pass this password more safely</span><br><span class="line">                     (if both are used, this argument takes predecence).</span><br><span class="line">  -u &lt;uri&gt;           Server URI.</span><br><span class="line">  -r &lt;repeat&gt;        Execute specified command N times.</span><br><span class="line">  -i &lt;interval&gt;      When -r is used, waits &lt;interval&gt; seconds per command.</span><br><span class="line">                     It is possible to specify sub-second times like -i 0.1.</span><br><span class="line">  -n &lt;db&gt;            Database number.</span><br><span class="line">  -x                 Read last argument from STDIN.</span><br><span class="line">  -d &lt;delimiter&gt;     Multi-bulk delimiter in for raw formatting (default: \n).</span><br><span class="line">  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br><span class="line">  --raw              Use raw formatting for replies (default when STDOUT is</span><br><span class="line">                     not a tty).</span><br><span class="line">  --no-raw           Force formatted output even when STDOUT is not a tty.</span><br><span class="line">  --csv              Output in CSV format.</span><br><span class="line">  --stat             Print rolling stats about server: mem, clients, ...</span><br><span class="line">  --latency          Enter a special mode continuously sampling latency.</span><br><span class="line">                     If you use this mode in an interactive session it runs</span><br><span class="line">                     forever displaying real-time stats. Otherwise if --raw or</span><br><span class="line">                     --csv is specified, or if you redirect the output to a non</span><br><span class="line">                     TTY, it samples the latency for 1 second (you can use</span><br><span class="line">                     -i to change the interval), then produces a single output</span><br><span class="line">                     and exits.</span><br><span class="line">  --latency-history  Like --latency but tracking latency changes over time.</span><br><span class="line">                     Default time interval is 15 sec. Change it using -i.</span><br><span class="line">  --latency-dist     Shows latency as a spectrum, requires xterm 256 colors.</span><br><span class="line">                     Default time interval is 1 sec. Change it using -i.</span><br><span class="line">  --lru-test &lt;keys&gt;  Simulate a cache workload with an 80-20 distribution.</span><br><span class="line">  --replica          Simulate a replica showing commands received from the master.</span><br><span class="line">  --rdb &lt;filename&gt;   Transfer an RDB dump from remote server to local file.</span><br><span class="line">  --pipe             Transfer raw Redis protocol from stdin to server.</span><br><span class="line">  --pipe-timeout &lt;n&gt; In --pipe mode, abort with error if after sending all data.</span><br><span class="line">                     no reply is received within &lt;n&gt; seconds.</span><br><span class="line">                     Default timeout: 30. Use 0 to wait forever.</span><br><span class="line">  --bigkeys          Sample Redis keys looking for keys with many elements (complexity).</span><br><span class="line">  --memkeys          Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">  --memkeys-samples &lt;n&gt; Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">                     And define number of key elements to sample</span><br><span class="line">  --hotkeys          Sample Redis keys looking for hot keys.</span><br><span class="line">                     only works when maxmemory-policy is *lfu.</span><br><span class="line">  --scan             List all keys using the SCAN command.</span><br><span class="line">  --pattern &lt;pat&gt;    Useful with --scan to specify a SCAN pattern.</span><br><span class="line">  --intrinsic-latency &lt;sec&gt; Run a test to measure intrinsic system latency.</span><br><span class="line">                     The test will run for the specified amount of seconds.</span><br><span class="line">  --eval &lt;file&gt;      Send an EVAL command using the Lua script at &lt;file&gt;.</span><br><span class="line">  --ldb              Used with --eval enable the Redis Lua debugger.</span><br><span class="line">  --ldb-sync-mode    Like --ldb but uses the synchronous Lua debugger, in</span><br><span class="line">                     this mode the server is blocked and script changes are</span><br><span class="line">                     not rolled back from the server memory.</span><br><span class="line">  --cluster &lt;command&gt; [args...] [opts...]</span><br><span class="line">                     Cluster Manager command and arguments (see below).</span><br><span class="line">  --verbose          Verbose mode.</span><br><span class="line">  --no-auth-warning  Don&#39;t show warning message when using password on command</span><br><span class="line">                     line interface.</span><br><span class="line">  --help             Output this help and exit.</span><br><span class="line">  --version          Output version and exit.</span><br><span class="line"></span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  Use --cluster help to list all available cluster manager commands.</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  cat &#x2F;etc&#x2F;passwd | redis-cli -x set mypasswd</span><br><span class="line">  redis-cli get mypasswd</span><br><span class="line">  redis-cli -r 100 lpush mylist x</span><br><span class="line">  redis-cli -r 100 -i 1 info | grep used_memory_human:</span><br><span class="line">  redis-cli --eval myscript.lua key1 key2 , arg1 arg2 arg3</span><br><span class="line">  redis-cli --scan --pattern &#39;*:12345*&#39;</span><br><span class="line"></span><br><span class="line">  (Note: when using --eval the comma separates KEYS[] from ARGV[] items)</span><br><span class="line"></span><br><span class="line">When no command is given, redis-cli starts in interactive mode.</span><br><span class="line">Type &quot;help&quot; in interactive mode for information on available commands</span><br><span class="line">and settings.</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port  #需要使用这个命令添加</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>开始添加主节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster add-node 10.0.0.112:6379 10.0.0.110:6379</span><br><span class="line"></span><br><span class="line">redis-cli -a centos cluster nodes</span><br><span class="line">25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379@16379 master - 0 1603542788089 0 connected</span><br><span class="line">#新主节点已经添加成功</span><br></pre></td></tr></table></figure>

<p>检查当前的集群情况：注意，redis的命令行中–cluster和进入redis输入的cluster是两个方式，他们的内容不一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112:6379</span><br></pre></td></tr></table></figure>

<p><strong>给新的节点分配槽位（slot）：</strong></p>
<p><strong>注意：重新分配槽位需要清空数据！请备份好数据后再操作</strong></p>
<p>利用的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster reshard 10.0.0.110:6379 #这里填写任意一个集群中的节点</span><br><span class="line">reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">需要被询问：</span><br><span class="line">1.需要分配多少槽位？</span><br><span class="line">2.需要分配给哪个主节点</span><br><span class="line">3.分配的槽位是从哪些主节点上来的（也就是从哪里再分一些槽位出来给新的主节点，如果是想要把某个老的主节点替换掉，那么就把它的全部槽位分配给新节点），有一个智能的ALL选项，可以平均的从其他主节点上获取槽位</span><br><span class="line">4.是否接受分配规则？</span><br></pre></td></tr></table></figure>

<p>分配完成后，检查当前集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.112:6379)</span><br><span class="line">M: 25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">已经有了槽位</span><br></pre></td></tr></table></figure>

<p><strong>添加从节点：</strong></p>
<p>两个方法：</p>
<p><strong>1.第一个方法：</strong></p>
<p>一步添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379 --cluster-slave --cluster-master-id 25a3f4642c96aa8da5895fe6948c16add5737036</span><br><span class="line">#cluster的id填新的主节点的id</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line">6803c4e25d23980fba3ff2d336126f4f000a4418 10.0.0.14:6379@16379 myself,slave 25a3f4642c96aa8da5895fe6948c16add5737036 0 1603544102000 0 connected</span><br><span class="line">已经添加成为了从节点</span><br></pre></td></tr></table></figure>

<p>2.第二个方法：</p>
<p>两步添加为从节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate 25a3f4642c96aa8da5895fe6948c16add5737036</span><br></pre></td></tr></table></figure>



<h4 id="3-3-3-集群的缩容"><a href="#3-3-3-集群的缩容" class="headerlink" title="3.3.3 集群的缩容"></a>3.3.3 集群的缩容</h4><p>1.缩容之前需要把原本的槽位分给其他主节点</p>
<p><strong>注意：缩容操作中，需要分三次，均匀的把槽位分配给剩余的主节点</strong></p>
<p>分配槽位，使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster reshard 10.0.0.112:6379</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 1365  #这里设置每次分配的槽位，4096 &#x2F; 3 </span><br><span class="line">What is the receiving node ID? 819d053d78d249570b5bd610436fdb0e4ac59627 #这里写分配给哪个主节点</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: 25a3f4642c96aa8da5895fe6948c16add5737036  #这里写要把哪个主节点分配了，也就是缩容了</span><br><span class="line"></span><br><span class="line">这个操作做三次，并且确保要缩容的节点上已经没有槽位</span><br></pre></td></tr></table></figure>

<p>把槽位分配完成后，原本的从节点也自动变成了其他主节点的从节点</p>
<p>2.删除节点，先删除主，后删除从</p>
<p>使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~ redis-cli -a centos --cluster del-node 10.0.0.112:6379 25a3f4642c96aa8da5895fe6948c16ad</span><br><span class="line">d5737036</span><br><span class="line"></span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Removing node 25a3f4642c96aa8da5895fe6948c16add5737036 from cluster 10.0.0.112:6379</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node</span><br></pre></td></tr></table></figure>

<p>此时这个主节点的redis服务也被关闭了，然后下一步我们把他的cluster自动生成的nodes-6379.conf文件删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;*  #注意：cluster的配置文件存放到哪里，是由redis.conf文件中dir选项决定的</span><br></pre></td></tr></table></figure>

<p>检查当前集群信息，发现已经没有被缩容的主节点了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del-node ip:port</span><br></pre></td></tr></table></figure>

<p>删除从节点：从节点只需要删除节点，删除自动生成的nodes-6379.conf文件即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster del-node 10.0.0.14:6379 42339be4491341520d59219d685530fcc61655ec</span><br><span class="line"></span><br><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;* </span><br></pre></td></tr></table></figure>

<p>此时检查集群信息，已经没有这个从节点了，缩容结束。</p>
<h4 id="3-3-5-把数据导入集群"><a href="#3-3-5-把数据导入集群" class="headerlink" title="3.3.5 把数据导入集群"></a>3.3.5 把数据导入集群</h4><p><strong>注意：慎用！</strong></p>
<p>用之前把所有涉及到的redis服务的密码全设置为空，包括导入数据的redis和被导入数据的redis集群的全部节点</p>
<p>然后使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster import 10.0.0.110:6379 --cluster-from 10.0.0.112:6379 --cluster-copy --cluster-replace</span><br><span class="line">参数说明：</span><br><span class="line">--cluster import 后面跟上集群中的一个节点IP和端口</span><br><span class="line">--cluster-from 后面跟上从哪里导入数据</span><br><span class="line">--cluster-copy  这个参数表示复制数据到集群</span><br><span class="line">--cluster-replace 这个参数表示如果出现相同的key，那么使用导入的数据替换了原来的数据</span><br></pre></td></tr></table></figure>



<h4 id="3-3-6-集群偏斜"><a href="#3-3-6-集群偏斜" class="headerlink" title="3.3.6 集群偏斜"></a>3.3.6 集群偏斜</h4><ul>
<li>节点和槽位分配不均</li>
<li>不同槽位对应键值数量差异较大</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看槽位中的键值对个数</span><br><span class="line">countkeysinslot NUMBER</span><br></pre></td></tr></table></figure>

<p>有一个重新分配槽位的命令，但是慎用！会影响客户端的访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster rebalance 集群IP:端口</span><br></pre></td></tr></table></figure>



<ul>
<li>包含bigkey，建议少用</li>
<li>内存相关配置不一致</li>
<li>热点数据不均衡：一致性不高时，可以使用本机缓存和MQ</li>
</ul>
<h4 id="3-3-7-Redis-cluster的局限性"><a href="#3-3-7-Redis-cluster的局限性" class="headerlink" title="3.3.7 Redis cluster的局限性"></a>3.3.7 Redis cluster的局限性</h4><ul>
<li>跨槽位查询不支持，不是说跨节点的问题，槽位都不能跨</li>
<li>性能降低</li>
<li>客户端维护更复杂</li>
<li>不支持多个数据库，只使用db0</li>
<li>复制只有一层，不支持级联复制</li>
<li>key事务和Lua支持有限</li>
</ul>
<p>1.主从复制</p>
<p>2.哨兵</p>
<p>3.Cluster 创建  两个版本  4,5都试试</p>
<p>4.扩容</p>
<p>5.缩容</p>
<p>6.导入</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-title-link" itemprop="url">MYSQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-18 08:48:10 / 修改时间：22:00:00" itemprop="dateCreated datePublished" datetime="2020-11-18T08:48:10+08:00">2020-11-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MySQL是什么"><a href="#MySQL是什么" class="headerlink" title="MySQL是什么"></a>MySQL是什么</h2><ul>
<li><p>关系型数据库管理软件–RDBMS</p>
<ul>
<li>数据库是数据库，MySQL是管理数据库的软件</li>
<li>实体-联系模型E-R<ul>
<li>实体Entity：客观存在并且可以相互区分的客观事物或抽象事件称为实体</li>
<li>属性：实体所具有的特征或性质</li>
<li>联系：联系是数据之间的关联集合，是客观存在的应用语义链<ul>
<li>实体和属性之间的联系</li>
<li>实体和实体之间的联系</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>数据冗余和性能的矛盾关系，冗余越小，在查询数据的时候就会越消耗性能</p>
</li>
<li><p>数据库的范式，有很多范式，但是一般数据只需满足第三范式（3NF）即可</p>
<ul>
<li><p>第一范式：1NF（normal form）</p>
<p>无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性，确保每一列的原子性。除去同类型的字段，就是无重复的列。</p>
<p>总结：消除重复列</p>
<p>比如下面表中xiaolv，他的年龄只能有一个，不能有两个</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">xiaoli</td>
<td align="center">20</td>
</tr>
<tr>
<td align="center">xiaolv</td>
<td align="center">20,22（两个值是错误的）</td>
</tr>
</tbody></table>
<ul>
<li><p>第二范式</p>
<p>第二范式必须先满足第一范式，属性完全依赖于主键，要求表中的每个行必须可以被唯一的区分，通常为表加上每行的唯一标识PK，非PK的字段需要与整个PK有直接的相关性</p>
<p>总结：消除部分依赖</p>
<p>比如下面的ID就是主键，每行都不相同，name和age字段依赖于ID</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">name</th>
<th align="center">age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">xiaolv</td>
<td align="center">20</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">xiaohui</td>
<td align="center">21</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">xiaozhe</td>
<td align="center">20</td>
</tr>
</tbody></table>
<ul>
<li><p>第三范式</p>
<p>第三范式必须先满足第二范式，不依赖于其他非主属性。第三范式要求一个数据表中不包含已在其他表中已包含的非主键字信息，非PK的字段间不能有从属关系</p>
<p>总结：消除全部依赖</p>
</li>
</ul>
</li>
<li><p>mysql客户端工具：</p>
<ul>
<li>mysql</li>
<li>mysqladmin</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ppasswd -Pport</span><br><span class="line"></span><br><span class="line">mysql [options] [database]</span><br><span class="line">-A,--no-auto-rehash 禁止补全</span><br><span class="line">-u,--user&#x3D; 用户名，默认为root</span><br><span class="line">-h,--host&#x3D; 服务器名，默认为localhost</span><br><span class="line">-p,--password 用户密码，默认为空密码</span><br><span class="line">-P,--port&#x3D; 服务器端口</span><br><span class="line">-S,--socket 指定连接socket文件路径</span><br><span class="line">-D，--datebase&#x3D; 指定默认数据库</span><br><span class="line">-C，--compress 启用压缩</span><br><span class="line">-e &quot;SQL&quot; 执行SQL命令</span><br><span class="line">-V,--version 显示版本</span><br><span class="line">-v,--verbos 显示详细信息</span><br><span class="line">--print-defaults 获取程序默认使用的配置</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -ppasswd ping</span><br><span class="line">mysqladmin [options] command command ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器端配置</p>
</li>
</ul>
<p>服务器端（mysqld）配置：</p>
<p>1.命令行选项</p>
<p>2.配置文件</p>
<ul>
<li><p>/etc/my.cnf</p>
</li>
<li><p>/etc/my.cnf.d/mysql-server.cnf</p>
<ul>
<li><p>```<br> 13 [mysqld]<br> 14 datadir=/var/lib/mysql<br> 15 socket=/var/lib/mysql/mysql.sock<br> 16 log-error=/var/log/mysql/mysqld.log<br> 17 pid-file=/run/mysqld/mysqld.pid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">socket地址：</span><br><span class="line"></span><br><span class="line">* ip socket地址：监听在tcp的3306端口，支持远程通信，侦听3306&#x2F;tcp端口可以绑定有一个或全部接口的IP上</span><br><span class="line">* Unix sock：监听在sock文件上，仅支持本机通信，如：&#x2F;var&#x2F;lib&#x2F;mysql.sock,说明，host为localhost时自动使用unix sock</span><br><span class="line"></span><br><span class="line">## MySQL数据库怎么安装</span><br><span class="line"></span><br><span class="line">在实际生产环境中大多使用编译安装或二进制安装</span><br><span class="line"></span><br><span class="line">* 编写脚本，实现二进制方式安装MySQL</span><br><span class="line"></span><br><span class="line">MySQL的三大分支</span><br><span class="line"></span><br><span class="line">* mysql</span><br><span class="line">* mariadb</span><br><span class="line">* percona server</span><br><span class="line"></span><br><span class="line">数据库应该尽量少被访问，尽量分担数据库的压力</span><br><span class="line"></span><br><span class="line">脚本在二进制安装.md中</span><br><span class="line"></span><br><span class="line">* yum install </span><br><span class="line">* 编译安装</span><br><span class="line">  * 建议内存4G以上</span><br><span class="line">  </span><br><span class="line">  * 下载并解压源码包</span><br><span class="line">  </span><br><span class="line">  * 源码编译安装，使用cmake，指定一些环境</span><br><span class="line">  </span><br><span class="line">  * &#96;&#96;&#96;</span><br><span class="line">    cd mariadb-10.2.18&#x2F;cmake . \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX&#x3D;&#x2F;app&#x2F;mysql \</span><br><span class="line">    -DMYSQL_DATADIR&#x3D;&#x2F;data&#x2F;mysql&#x2F; \</span><br><span class="line">    -DSYSCONFDIR&#x3D;&#x2F;etc&#x2F;  \</span><br><span class="line">    -DMYSQL_USER&#x3D;mysql \</span><br><span class="line">    -DWITH_INNOBASE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_ARCHIVE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_BLACKHOLE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_PARTITION_STORAGE_ENGINE&#x3D;1  \</span><br><span class="line">    -DWITHOUT_MROONGA_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_DEBUG&#x3D;0 \</span><br><span class="line">    -DWITH_READLINE&#x3D;1 \</span><br><span class="line">    -DWITH_SSL&#x3D;system \</span><br><span class="line">    -DWITH_ZLIB&#x3D;system\</span><br><span class="line">    -DWITH_LIBWRAP&#x3D;0 \</span><br><span class="line">    -DENABLED_LOCAL_INFILE&#x3D;1  \</span><br><span class="line">    -DMYSQL_UNIX_ADDR&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock \</span><br><span class="line">    -DDEFAULT_CHARSET&#x3D;utf8 \</span><br><span class="line">    -DDEFAULT_COLLATION&#x3D;utf8_general_ci</span><br><span class="line">    make &amp;&amp; make install </span><br></pre></td></tr></table></figure>

<p>提示：如果出错，执行rm -f CMakeCache.txt</p>
<p>剩下的步骤与二进制安装相同</p>
</li>
</ul>
</li>
<li><p>二进制安装，相比编译安装就是少了编译过程</p>
<ul>
<li>1.创建mysql组和用户</li>
<li>2.创建数据库存放目录，修改这个目录所有者、所有组的信息</li>
<li>3.下载源码，解压到/usr/local下</li>
<li>4.创建软链接 ln -s /usr/local/mysqlxxxx   mysql</li>
<li>5.配置文件复制到/etc/my.cnf</li>
<li>6.使用自带脚本生成数据库文件</li>
<li>7.使用自带脚本制作开机启动脚本</li>
<li>8.配置开机启动</li>
<li>9.启动安全加固脚本</li>
</ul>
</li>
</ul>
<p>1.MySQL账户</p>
<p>2.MySQL配置文件</p>
<p>3.MySQL工具</p>
<p>4.MySQL数据库文件</p>
<p>5.MySQL登录方式文件</p>
<p>mysql</p>
<p>mysqladmin</p>
<h2 id="SQL语言"><a href="#SQL语言" class="headerlink" title="SQL语言"></a>SQL语言</h2><p>SQL的注释：</p>
<ul>
<li>– 注释内容 单行注释，注意有空格</li>
<li>/**/ 多行注释</li>
</ul>
<p>MySQL注释：</p>
<ul>
<li>“#”号后面跟注释内容，有空格</li>
</ul>
<p>SQL关键字建议大写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;passwd&#39; WITH GRANT OPTION;</span><br><span class="line">#这个是指定访问的IP和账号</span><br><span class="line">delete from user where host&#x3D;xxx and user&#x3D;xxx;</span><br><span class="line">#这个是删除一个用户</span><br><span class="line">flush privileges;</span><br><span class="line">#刷新数据库</span><br></pre></td></tr></table></figure>

<p>数据库的组件：</p>
<p>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器</p>
<p>命名规则：</p>
<ul>
<li>必须以字母开头，可包括数字和三个特殊字符（# _ $）</li>
<li>不要使用MySQL的保留字</li>
</ul>
<p>SQL的语句分类：</p>
<ul>
<li><p>DDL:数据定义语言 Data Defination Language</p>
<p>表：二维关系</p>
<p>设计表：遵循规范</p>
<p>定义：字段，索引</p>
<p>​    字段：字段名，字段数据类型，修饰符</p>
<p>​    约束，索引：应该创建在经常用作查询条件的字段上</p>
<ul>
<li><p>CREATE</p>
<p>第一种创建表的方式：直接创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table if not exists student (</span><br><span class="line">id int UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">name VARCHAR(20) NOT NULL,</span><br><span class="line">age tinyint UNSIGNED,</span><br><span class="line">gender ENUM(&#39;F&#39;,&#39;M&#39;) default &#39;M&#39;)ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;10 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line">(root@localhost) [ahui]&gt;desc student;</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field  | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id     | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name   | varchar(20)         | NO   |     | NULL    |                |</span><br><span class="line">| age    | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| gender | enum(&#39;F&#39;,&#39;M&#39;)       | YES  |     | M       |                |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">(root@localhost) [ahui]&gt;insert student (name,age)values(&#39;xiaolv&#39;,20);</span><br><span class="line">(root@localhost) [ahui]&gt;insert student (name,age,gender)values(&#39;xiaohong&#39;,20,&#39;f&#39;);</span><br><span class="line">(root@localhost) [ahui]&gt;select * from student;</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">| id | name     | age  | gender |</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">| 10 | xiaolv   |   20 | M      |</span><br><span class="line">| 11 | xiaohong |   20 | F      |</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>关于AUTO_INCREMENT，通过更改系统参数可以修改步进值和默认起始的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show variables like &#39;auto_increment%&#39;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| auto_increment_increment | 10    |</span><br><span class="line">| auto_increment_offset    | 3     |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">#上面的参数是修改过的，默认都是1</span><br><span class="line">(root@localhost) [ahui]&gt;set @@auto_increment_increment&#x3D;10;</span><br><span class="line">(root@localhost) [ahui]&gt;set @@auto_increment_offset&#x3D;3;</span><br><span class="line">(root@localhost) [ahui]&gt;desc autoincre;</span><br><span class="line">(root@localhost) [ahui]&gt;desc autoincre;</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra          |</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">| col   | int(11) | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(root@localhost) [ahui]&gt;select * from autoincre;</span><br><span class="line">+-----+</span><br><span class="line">| col |</span><br><span class="line">+-----+</span><br><span class="line">|   3 |</span><br><span class="line">|  13 |</span><br><span class="line">|  23 |</span><br><span class="line">|  33 |</span><br><span class="line">+-----+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>第二种创建表的方式：通过查询现存表创建：查询到的数据之间插入表中成为新表的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table human select user,host from mysql.user;</span><br><span class="line">(root@localhost) [ahui]&gt;select * from human;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| root          | 10.0.0.%  |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>第三种方式：通过复制现存表的表结构创建，但是不复制数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table teacher like student;</span><br><span class="line">(root@localhost) [ahui]&gt;desc teacher;</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field  | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id     | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name   | varchar(20)         | NO   |     | NULL    |                |</span><br><span class="line">| age    | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| gender | enum(&#39;F&#39;,&#39;M&#39;)       | YES  |     | M       |                |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">(root@localhost) [ahui]&gt;select * from teacher;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">#表中没有数据，是空的，只有数据表的结构</span><br></pre></td></tr></table></figure>

<p>查看engine</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show engines;</span><br></pre></td></tr></table></figure>

<p>查看表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show tables;</span><br></pre></td></tr></table></figure>

<p>查看表结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;desc student;</span><br></pre></td></tr></table></figure>

<p>查看创建表命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show create table student;</span><br></pre></td></tr></table></figure>

<p>查看表状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show table  status like &#39;student&#39;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: student</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 2</span><br><span class="line"> Avg_row_length: 8192</span><br><span class="line">    Data_length: 16384</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 0</span><br><span class="line">      Data_free: 0</span><br><span class="line"> Auto_increment: 12</span><br><span class="line">    Create_time: 2020-09-22 20:33:27</span><br><span class="line">    Update_time: 2020-09-22 20:37:04</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8_general_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#\G是竖着显示内容</span><br></pre></td></tr></table></figure>

<p>查看数据库中全部表的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show table status from ahui ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DROP</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [(none)]&gt;drop database if exists ahui;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ALTER</p>
<p>add,change,modify</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [(none)]&gt;alter database ahui character set utf8;</span><br><span class="line">mysql&gt; alter table info change name1 name varchar(20);</span><br></pre></td></tr></table></figure>

<p>查看所有数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>DML：数据库操纵语言 Data Manipulation Language</p>
<ul>
<li><p>INSERT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert table_name [(column1,...)] values (value1,...) (value2...)...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;insert info (id,name,gender,age) values (4,&#39;ming&#39;,&#39;M&#39;,24);</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<ul>
<li><p>DELETE</p>
<p>删除表中的数据，但不会自动缩减数据文件的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE [] FROM TABLE_NAME</span><br><span class="line">	[WHERE CONDITIONS]</span><br><span class="line">	[ORDER BY]</span><br><span class="line">	[LIMIT ROW_COUNT]</span><br><span class="line">	可以先排序再指定删除的行数</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;delete from info where id &#x3D;4;</span><br></pre></td></tr></table></figure>

<p>注意一定要有限制条件，否则将清空表中的所有数据</p>
<p>如果想清空表，保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE TABLE TABLE_NAME</span><br></pre></td></tr></table></figure>

<p>缩减表大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE TABLE_NAME</span><br></pre></td></tr></table></figure>
</li>
<li><p>UPDATE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UPDATE [] TABLE_REFERENCE</span><br><span class="line">	SET COL_NAME&#x3D;&#123;exper1|default&#125;...</span><br><span class="line">	[WHERE CONDITIONS]</span><br><span class="line">	[ORDER BY]</span><br><span class="line">	[LIMIT ROW_COUNT]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update info set id&#x3D;6 where name &#x3D; &#39;hui&#39;;</span><br></pre></td></tr></table></figure>

<p>注意要有限制条件，否则将修改所有行的指定字段，可以用mysql选项避免此错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -U | --safe-updates | --i-am-a-dummy </span><br><span class="line">可以把 mysql -U 做成别名，</span><br><span class="line">alias mysql&#x3D;&quot;mysql -U&quot;</span><br><span class="line">设置了 -U 选项后使用删除的时候必须跟上一个主键的条件！</span><br></pre></td></tr></table></figure>
</li>
<li><p>DQL：数据查询语言 Data Query Language</p>
<ul>
<li>SELECT</li>
</ul>
</li>
</ul>
<p>select语句处理的顺序</p>
<p>SQL解析–&gt;FROM–&gt;ON–&gt;JOIN和WHERE并列地位–&gt;GROUP BY–&gt;HAVING–&gt;SELECT–&gt;ORDER BY–&gt;LIMIT</p>
<p>执行查询路径中的组件：</p>
<p><img src="C:\Users\a\Desktop\dfff6efbab0d51a715a36f867daeacf8.png" alt="dfff6efbab0d51a715a36f867daeacf8"></p>
<pre><code>* 单表操作</code></pre>
<p>  between … and</p>
<p>  distinct </p>
<p>  模糊查询:like %,_ </p>
<p>  ​    数据库、数据表是区分大小写的，因为他们都是文件（目录）</p>
<p>  ​    字段名、数据是不区分大小写的</p>
<p>  GROUP分组，涉及到前后次序</p>
<p>  ​    groupby xxx having conditions=xxx</p>
<p>  ​    where conditions = xxx groupby xxx</p>
<p>  正则表达式查询：rlike,regexp</p>
<p>  order by asc desc</p>
<p>  字段的别名</p>
<p>  limit N 或者可以跳过前几条后开始显示</p>
<p>  对查询结果加锁</p>
<pre><code>* 多表查询

  子查询

  ​    普通子查询

  ​    IN 子查询

  ​    exists 和 not exists

  exists（包括 not exists）子句的返回值是一个BOOL值。exists内部有一个子查询语句，将其称为exists的内查询语句。其内查询语句返回一个结果集，exists子句根据其内查询的结果集空或非空，返回一个布尔值。将外查询的每一行带入内查询作为检验，如果内查询返回的结果为非空值，则exists子句返回true，外查询的这一行数据便可作为外查询的结果返回，否则不能作为结果。

  联合查询 union，union all

  交叉连接：笛卡尔乘积，两个表完全组合一遍 cross join

  内连接 inner join table_name on 涉及到别名

  外连接 涉及到别名

  ​    左外连接 left outer join table_name on 

  ​    有外连接 right outer join table_name on

  ​    只取非交集 左连接或右连接再加一个key的where条件

  ​    全外连接 full outer join table_name on 

  ​    mysql不支持 full outer写法，但是可以通过组合左右连接来union实现

  自连接</code></pre>
<ul>
<li>DCL：数据控制语言 Data Control Language<ul>
<li>GRANT</li>
<li>REVOKE</li>
<li>COMMIT</li>
<li>ROLLBACK</li>
</ul>
</li>
</ul>
<p>软件开发：CRUD 增删改查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table1</span><br><span class="line">WHERE price&gt;666;</span><br></pre></td></tr></table></figure>

<p>字符集：UTF8MB4 4个字节，生产环境记得修改字符集</p>
<ul>
<li>SHOW COLLATION  字符集的排序规则</li>
<li>SHOW VARIABLES LIKE ‘collation%’</li>
<li>SHOW CHARACTER SET</li>
<li>SHOW variables like ‘character%’ 查看当前数据库中使用的字符集</li>
</ul>
<p>数据类型：</p>
<p>数据长什么样</p>
<p>数据需要多少空间来存放</p>
<p>系统内置数据类型</p>
<p>用户定义数据类型</p>
<p>选择正确的数据类型对于获得高性能至关重要，三大原则：</p>
<p>1.更小的通常更好，尽量使用可正确存储数据的最小数据类型</p>
<p>2.简单就好，简单数据类型的操作通常需要更少的CPU周期</p>
<p>3.尽量避免NULL，包含为NULL的列，对MySQL更难优化</p>
<ul>
<li><p>整数型</p>
<ul>
<li>tinyint 1个字节</li>
<li>int 4个字节</li>
</ul>
</li>
<li><p>浮点型</p>
</li>
<li><p>定数型</p>
</li>
<li><p>字符串</p>
<ul>
<li>char(n) 固定长度，最多255个字符，注意不是字节</li>
<li>varchar(n) 可变长度，最多65535个字符</li>
</ul>
</li>
<li><p>修饰符</p>
<ul>
<li>NULL    数据列可包含NULL值，默认值</li>
<li>NOT NULL 数据列不允许包含NULL值，*为必填选项</li>
<li>DEFAULT 默认值</li>
<li>ENUM（’’,’’）限制值只能是设定的</li>
<li>PRIMARY KEY 主键，所有记录中此字段的值不能重复，且不能为NULL</li>
<li>UNIQUE KEY  唯一键，所有记录中此字段的值不能重复，但可以为NULL</li>
<li>CHARACTER SET name 指定一个字符集</li>
<li>适合数值型的修饰符<ul>
<li>AUTO_INCREMENT 自动递增，适用于整数类型 最大是2^32次方-1 4294967295</li>
<li>UNSIGNED 无符号</li>
</ul>
</li>
<li>日期时间类型<ul>
<li>data 日期 ‘2020-09-22’</li>
<li>time 时间 ‘20:20:20’</li>
<li>datatime 日期时间 ‘2020-09-22 20:20:30’</li>
<li>timestamp 自动存储记录修改时间</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>视图 VIEW</p>
<p>视图是虚拟的表，类似表的别名，视图存在于数据库目录下，是以文件形式存放的</p>
<p>视图可以隐藏数据表的结构</p>
<p>视图可以修改原始表的数据，视图中的数据实际存储在基表中，因此对视图数据的修改也会对基表修改，视图的修改操作受基表限制</p>
<p>创建视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW view_name [(column_list)]</span><br><span class="line">	as select_statement</span><br><span class="line">	[with[cascaded|local] check option]</span><br></pre></td></tr></table></figure>

<p>查看视图定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#显示创建视图和表的过程</span><br><span class="line">show create table v_name;</span><br><span class="line">或</span><br><span class="line">show create view v_name;</span><br></pre></td></tr></table></figure>

<p>删除视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW [if exists]</span><br><span class="line">	view_name[,view_name] ...</span><br><span class="line">	[restrict|cascade]</span><br></pre></td></tr></table></figure>

<p>函数 FUNCTION</p>
<p>​    函数必须有()</p>
<p>​    内置函数和自定义函数</p>
<p>​    mysql数据库的proc表中</p>
<p>​    函数只能被调用select function_name()，不能独立使用;</p>
<p>创建函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE [AGGREAGTE] FUNCTION function_name(parameter_name type,....)</span><br><span class="line">	RETURN &#123;STRING|INTEGER|REAL&#125;</span><br><span class="line">	runtime_body</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>参数可以有多个，也可以没有</li>
<li>无论有没有参数，必须有()</li>
<li>必须有且只有一个返回值</li>
</ul>
<p>查看函数列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW FUNCTION STATUS;</span><br></pre></td></tr></table></figure>

<p>查看函数定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE FUNCTION function_name</span><br></pre></td></tr></table></figure>

<p>删除自定义函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP FUNCTION function_name</span><br></pre></td></tr></table></figure>

<p>调用函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select function_name();</span><br></pre></td></tr></table></figure>

<p>Mysql中的变量</p>
<p>​    系统变量 @@var_name 引用</p>
<p>​    普通变量 @var_name 适用于当前会话</p>
<p>​    局部变量 var_name 函数体内部有效，其他地方无效</p>
<p>存储过程 PROCEDURE</p>
<p>​    存储过程：多表SQL的语句的集合，可以独立执行，存储过程保存在mysql.proc表中</p>
<p>​    call procdure_name;</p>
<p>创建存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE procedure_name ([parameter]...)</span><br><span class="line">routime_body</span><br><span class="line">proc_parameter :[IN|OUT|INOUT] parameter_name type</span><br></pre></td></tr></table></figure>

<p>查看存储过程列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROCEDURE STATUS</span><br></pre></td></tr></table></figure>

<p>查看存储过程定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE PROCEDURE procedure_name</span><br></pre></td></tr></table></figure>

<p>调用存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call procedure_name [(parameter)]</span><br><span class="line">#说明：当没有参数时可以不写 ()</span><br></pre></td></tr></table></figure>

<p>存储过程通过ALTER只能修改注释等无关紧要的东西，不能修改存储过程体，所以要修改存储过程，方法就是删除重建</p>
<p>删除存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP PROCEDURE [if exists] procedure_name</span><br></pre></td></tr></table></figure>

<p>触发器 TRIGGER</p>
<p>​    触发器的执行不是由程序调用，也不是由手动启动，而是由时间来触发、激活从而实现执行</p>
<p>​    触发器只对insert,delete,update这三个动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE [ DEFINER &#x3D; &#123;USER|CURRENT_USER&#125; ]</span><br><span class="line">	TRIGGER trigger_name</span><br><span class="line">	trigger_time &#123;before|after&#125; trigger_event</span><br><span class="line">	on table_name for each row</span><br><span class="line">	trigger_body</span><br></pre></td></tr></table></figure>

<p>触发器文件在/var/lib/mysql/dbname/trigger_name.TRN</p>
<p>查看触发器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#通过show命令查看</span><br><span class="line">SHOW TRIGGERs ;</span><br><span class="line">#通过查看information_schema.triggers表</span><br><span class="line">mysql&gt; select * from information_schema.triggers where trigger_name &#x3D; &#39;student_count_delete&#39;;</span><br></pre></td></tr></table></figure>

<p>删除触发器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TRIGGER trigger_name</span><br></pre></td></tr></table></figure>

<p>事件 EVENT</p>
<p>​    存放在mysql.event表中</p>
<p>​    秒钟级别</p>
<p>​    环境变量：@@event_scheduler</p>
<p>查看事件管理器是否开启，默认是关闭0,1是开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@event_scheduler;</span><br></pre></td></tr></table></figure>

<p>事件管理器开启后会开启一个线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHWO PROCESSLIST</span><br></pre></td></tr></table></figure>

<p>可以通过在配置文件中添加 event_scheduler = on  来永久开启</p>
<h3 id="用户账户管理"><a href="#用户账户管理" class="headerlink" title="用户账户管理"></a>用户账户管理</h3><p>mysql.user表中存放用户信息</p>
<p>用户账户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#39;USERNAME&#39;@&#39;HOST&#39;</span><br><span class="line">USERNAME :操作系统的用户名</span><br><span class="line">@HOST：主机名，IP地址或者Network</span><br><span class="line">	通配符：% 表示所有  _ 表示任意一个字符</span><br><span class="line">	示例：172.16.%.% user@192.168.1.%</span><br></pre></td></tr></table></figure>



<h4 id="账号创建-CREATE-USER"><a href="#账号创建-CREATE-USER" class="headerlink" title="账号创建 CREATE USER"></a>账号创建 CREATE USER</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;USERNAME&#39;@&#39;HOSTNAME&#39; [IDENTIFIED BY &#39;密码&#39;]</span><br><span class="line">新建用户默认权限：USEAGE</span><br><span class="line">mysql&gt; create user &#39;lv&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br></pre></td></tr></table></figure>

<p>用户重命名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RENAME USER old_user_name TO new_user_name;</span><br></pre></td></tr></table></figure>



<h4 id="账号删除"><a href="#账号删除" class="headerlink" title="账号删除"></a>账号删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP USER &#39;user_name&#39;@&#39;hostname&#39;</span><br></pre></td></tr></table></figure>

<h4 id="账号密码修改"><a href="#账号密码修改" class="headerlink" title="账号密码修改"></a>账号密码修改</h4><p>注意：</p>
<ul>
<li>新版MYSQL中用户密码可以保存在mysql.user表的authentication_string字段</li>
<li>旧版的密码在mysql.password字段，如果两个字段都存在数据，那么authentication_string优先级更高</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set password for root@&#39;localhost&#39;  password(&#39;centos&#39;) </span><br></pre></td></tr></table></figure>

<p>官方推荐这样操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter user user_name&#39;@&#39;hostname identified by &#39;password&#39; ;</span><br></pre></td></tr></table></figure>

<p>忘记密码的操作</p>
<p>1.关闭验证环节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--skip-grant-tables</span><br><span class="line">--skip-networking</span><br></pre></td></tr></table></figure>

<p>2.登录mysql数据库，修改密码</p>
<h4 id="账号授权"><a href="#账号授权" class="headerlink" title="账号授权"></a>账号授权</h4><p>权限的类型</p>
<ul>
<li>管理类<ul>
<li>用户管理等</li>
</ul>
</li>
<li>程序类<ul>
<li>函数、存储过程等的控制</li>
</ul>
</li>
<li>数据库级别<ul>
<li>数据库的增改删</li>
</ul>
</li>
<li>表级别<ul>
<li>数据表的增改删</li>
</ul>
</li>
<li>字段级别<ul>
<li>规定哪些字段可以操作，比如select ((col1),(col2)…)</li>
</ul>
</li>
</ul>
<p>操作符：GRANT,REVOKE</p>
<p>所有权限：ALL PRIVILEGES 或 ALL</p>
<p>授权：GRANT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GRANT priv_type [(column_list)]，...ON [object_type] priv_level TO &#39;user&#39;@&#39;host&#39;</span><br><span class="line">[IDENTIFIED BY &#39;PASSWORD&#39;] [WITH GRANT OPTION];</span><br><span class="line"></span><br><span class="line">priv_type：all [privileges]</span><br><span class="line">object_type：table | function | procedure</span><br><span class="line">priv_level：*(所有库) | *.* | db_name.* | db_name.table_name | table_name(当前库的表) | db_name.routine_name(指定库的函数，存储过程，触发器)</span><br><span class="line">with_option：grant option</span><br><span class="line">	| max_queries_per_hour count</span><br><span class="line">	| max_updates_per_hour count</span><br><span class="line">	| max_connections_per_hour count</span><br><span class="line">	| max_user_connections count</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT  ALL PRIVILEGES ON *.* TO &#39;USER_NAME&#39;@&#39;HOSTNAME&#39; IDENTIFIED BY &#39;PASSWORD&#39;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all on hellodb.* to &#39;lv&#39;@&#39;10.0.0.%&#39; ;</span><br><span class="line">#把hellodb下的所有权限发给lv@10.0.0.%用户</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant select on mysql.* to &#39;lv&#39;@&#39;10.0.0.%&#39;;</span><br></pre></td></tr></table></figure>

<p>取消授权：REVOKE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REVOKE priv_type [(column_list)]... on [object_type] priv_level from user..</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; revoke select on mysql.* from &#39;lv&#39;@&#39;10.0.0.%&#39; ;</span><br></pre></td></tr></table></figure>

<p>查看用户权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GRANTS FOR XXX@XXX;</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show grants for &#39;lv&#39;@&#39;10.0.0.%&#39;;</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| Grants for lv@10.0.0.%                                 |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &#39;lv&#39;@&#39;10.0.0.%&#39;                  |</span><br><span class="line">| GRANT ALL PRIVILEGES ON &#96;hellodb&#96;.* TO &#39;lv&#39;@&#39;10.0.0.%&#39; |</span><br><span class="line">| GRANT SELECT ON &#96;mysql&#96;.* TO &#39;lv&#39;@&#39;10.0.0.%&#39;           |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>注意：数据库启动的时候会自动读取mysql库中的全部权限表到内存，对于不能及时重读授权表的命令，可以手动执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>




<h2 id="MySQL架构和性能优化"><a href="#MySQL架构和性能优化" class="headerlink" title="MySQL架构和性能优化"></a>MySQL架构和性能优化</h2><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200925200135006.png" alt="image-20200925200135006"></p>
<p>Mysql是单进程多线程的</p>
<p>连接器：一个API，支持各种语言开发的连接工具</p>
<p>连接池：认证，线程控制，内存检查</p>
<p>SQL接口：解释器，进行语法检查</p>
<p>解析器：查询翻译、权限检查</p>
<p>寻路优化：访问路径统计</p>
<p>缓存和缓冲区：这个不是上面的缓存访问，而是跟内存和磁盘打交道的缓存</p>
<p>插件存储引擎：面试常问，工作中对于引擎的选择是比较固定的</p>
<p>文件系统：</p>
<p>文件和日志：</p>
<h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><p>mysql是插件式存储引擎，它能够替换使用选择多种不同的引擎</p>
<p>存储引擎负责把具体分析结果完成对磁盘上文件路径访问的转换，数据库中的行数据是存储在磁盘块上的，因此存储引擎要把数据库数据映射为磁盘块，并把磁盘块加载至内存中；（逻辑关系转化成物理数据文件）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">show engines</span><br><span class="line">show variables like &#39;%engine%&#39;</span><br><span class="line">--default_storage_engines,default_storage_engines</span><br><span class="line">storage_engine</span><br><span class="line">show table status from table_name</span><br><span class="line">show create table table_name</span><br><span class="line">create TABLE table_name () ENGINE&#x3D;INNODB</span><br><span class="line">ALTER TABLE table_name ENGINE&#x3D;INNODB</span><br></pre></td></tr></table></figure>

<p><strong>MyISAM和InnoDB的区别</strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>锁的颗粒度</td>
<td>表级锁</td>
<td>行级锁</td>
</tr>
<tr>
<td>集群索引</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>MVCC</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>存储空间</td>
<td>256TB</td>
<td>64TB</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>速度</td>
<td>相对快</td>
<td>相对慢</td>
</tr>
</tbody></table>
<blockquote>
<p>InnoDB：Supports transactions, row-level locking, foreign keys and encryption for tables</p>
<p>MyISAM：Non-transactional engine with good performance and small data footprint</p>
</blockquote>
<p>MVCC：多版本并发控制机制 </p>
<p>​    数据的时间戳，INSERT和DELETE</p>
<p>InnoDB的数据文件是两个，一个数据定义，一个存放数据  </p>
<blockquote>
<p>name.frm  数据定义</p>
<p>name.ibd   真实数据以及索引</p>
</blockquote>
<p>MyISAM数据文件三个，一个索引，一个数据，一个定义</p>
<p>行–&gt;页–&gt;extent–&gt;segment</p>
<p>数据库的读取是以一页作为基本单位，一个页16KB，对比文件系统的块，文件系统的块Block是4KB</p>
<p>存储引擎是对表来说的，是对表的管理，同一个数据库中的表可以用不同的存储引擎</p>
<h3 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h3><ul>
<li><p>MySQL数据库</p>
<p>是MYsql的核心数据库，主要负责存储数据库的用户、权限设置、关键字等Mysql自己需要使用的控制和管理信息</p>
</li>
<li><p>performance_schema</p>
<p>MYsql 5.5 新增的数据库，主要用户手机数据库服务器性能参数，库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PREFORMANCE_SHCEMA的表</p>
</li>
<li><p>information_schema</p>
<p>一个虚拟数据库，物理上并不存在information_schema数据库类似于”数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表明，列类型，访问权限等</p>
</li>
<li><p>sys</p>
<p>MYSQL5.7之后新增加的数据库，库中的所有数据来源于performance_schma，目标是把performance_schema的复杂程度降低，让DBA能更好的阅读这个库里的内容。</p>
</li>
</ul>
<h3 id="服务器配置和状态"><a href="#服务器配置和状态" class="headerlink" title="服务器配置和状态"></a>服务器配置和状态</h3><p>通过mysqld的选项、服务器系统变量和服务器状态变量进行MySQL的配置和查看状态</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html">https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/">https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/</a></p>
<h4 id="服务器选项"><a href="#服务器选项" class="headerlink" title="服务器选项"></a>服务器选项</h4><p>写入配置文件，持久保存</p>
<p>Default options are read from the following files in the given order:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;my.cnf &#x2F;etc&#x2F;mysql&#x2F;my.cnf ~&#x2F;.my.cnf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#打印出当前服务启动时的默认选项</span><br><span class="line">[root@localhost local]#mysqld --print-defaults</span><br><span class="line">mysqld would have been started with the following arguments:</span><br><span class="line">--datadir&#x3D;&#x2F;data&#x2F;mysql --socket&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock --skip_name_resolve&#x3D;on --port&#x3D;3306</span><br><span class="line">#打印出可用选项</span><br><span class="line">[root@localhost local]#mysql --verbose --help</span><br></pre></td></tr></table></figure>



<h4 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h4><p>变量临时修改，无法持久保存</p>
<p>系统变量分为全局（GLOBAL）和会话（session）两种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show global variables;#查看全局变量</span><br><span class="line">show [session] variables;#查看所有变量</span><br><span class="line">select @@variable;#查看某个变量的值</span><br><span class="line">SET GLOBAL system_var_name&#x3D;value;</span><br><span class="line">SET @@GLOBAL.SYSTEM_VAR_NAME&#x3D;value;</span><br><span class="line">SET system_var_name&#x3D;value;</span><br><span class="line">SET @@system_var_name&#x3D;value;</span><br></pre></td></tr></table></figure>

<p>max_connection 最大连接数，一个数据库1000左右的连接数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--character_set_server,character_set_server</span><br><span class="line">--max_connections,max_connections</span><br><span class="line">#如果该最大连接数不成功，应该是ulimits限制的，可以在&#x2F;etc&#x2F;my.cnf中加一句</span><br><span class="line">LimitNOFILE&#x3D;65535</span><br></pre></td></tr></table></figure>





<h4 id="服务器状态变量"><a href="#服务器状态变量" class="headerlink" title="服务器状态变量"></a>服务器状态变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;variables&#39;;</span><br><span class="line">show global status;</span><br><span class="line">show status;</span><br></pre></td></tr></table></figure>



<h4 id="服务器变量SQL-MODE"><a href="#服务器变量SQL-MODE" class="headerlink" title="服务器变量SQL_MODE"></a>服务器变量SQL_MODE</h4><p>SQL_MODE：对其设置可以完成一些约束检查的工作，可分别进行全局的设置或当前会话的设置</p>
<p>文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/sql-mode/">https://mariadb.com/kb/en/library/sql-mode/</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode">https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--sql_mode,sql_mode</span><br><span class="line">select @@sql_mode;</span><br></pre></td></tr></table></figure>

<p>常见MODE：</p>
<ul>
<li>NO_AUTO_CREATE_USER：禁止GRANT创建密码为空的用户</li>
<li>NO_ZERO_DATE：在严格模式，不允许使用”0000000”的时间</li>
<li>ONLY_FULL_GROUP_BY：对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将认为这个SQL是不合法的</li>
<li>NO_BACKSLASH_ESCAPES：反斜杠“\”被视为普通字符而不是逃逸符</li>
<li>PIPES_AS_CONCAT：将“||”视为连接操作符而非“或”运算符</li>
</ul>
<h3 id="Query-Cache-查询缓存"><a href="#Query-Cache-查询缓存" class="headerlink" title="Query Cache 查询缓存"></a>Query Cache 查询缓存</h3><p>Redis代替</p>
<p>能用别的应用解决，就不要用数据库实现</p>
<p>查询缓存的启用和使用，hash算法，因此对语句的要求很高，必须一模一样，连空格什么的都得一样才能从缓存中读取</p>
<p>查询缓存优化</p>
<h3 id="索引-INDEX"><a href="#索引-INDEX" class="headerlink" title="索引 INDEX"></a>索引 INDEX</h3><h4 id="索引介绍"><a href="#索引介绍" class="headerlink" title="索引介绍"></a>索引介绍</h4><p>索引是排序的快速查找的特殊数据结构，定义作为查找条件的字段上，又称为键key，索引通过存储引擎实现</p>
<p>适合读操作；不适合频繁更改的数据表</p>
<p>优点</p>
<ul>
<li>索引可以降低服务器需要扫描的数据量，减少了IO次数</li>
<li>索引可以帮助服务器避免排序和使用临时表</li>
<li>索引可以帮助将随机I/O转为顺序I/O</li>
</ul>
<p>缺点</p>
<ul>
<li>占用额外空间，影响插入速度</li>
</ul>
<p>索引类型：</p>
<ul>
<li>B+ TREE,HASH,R TREE,FULL TEXT</li>
<li>聚簇索引，非聚簇索引：数据和索引是否存储在一起</li>
<li>主键索引、二级索引</li>
<li>稠密索引、稀疏索引：是否引用了每一个数据项</li>
<li>简单索引、组合索引</li>
<li>左前缀索引：取前面的字符做索引</li>
<li>覆盖索引：从索引中即可取出要查询的数据，性能高</li>
</ul>
<h5 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h5><p>参考链接 : <a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">https://www.cs.usfca.edu/~galles/visualization/Algorithms.html</a></p>
<ul>
<li><p>二叉树</p>
</li>
<li><p>红黑树</p>
</li>
<li><p>B树</p>
</li>
<li><p>Hash索引</p>
<p>基于哈希表实现，只有精确匹配索引中的所有列的查询才有效，索引自身只存储索引列对应哈希值和数据指针，索引结构紧凑，查询性能好；Memory存储引擎支持显式HASH索引，适用于：= &lt;=&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&#x3D;&gt; 符号是专门比较NULL值的，表示等于NULL，也就是 IS NULL</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>B+树，INNODB就是用B+树作为索引</li>
</ul>
<p>B+树索引的特点：</p>
<p>1.查询类型</p>
<ul>
<li>全值匹配：精确所有索引列，如：姓lv,名zhehui,年龄25</li>
<li>匹配最左侧前缀：即只使用索引的第一列，如：姓lv</li>
<li>匹配列前缀：只匹配一列值的开头部分，如：姓以l开头的记录</li>
<li>匹配范围值：如：姓lv和wang之间</li>
<li>精确匹配某一列范围并范围匹配另一列：如：姓lv，名以z开头的记录</li>
<li>只访问索引的查询</li>
<li>如果不从最左列开始，则无法使用索引，如：查询名为zhehui,或姓的结尾是g</li>
<li>不能跳过索引中的列：？如：查找姓wang，年龄30，只能使用索引第一列</li>
</ul>
<p>mysql中 a% 可以利用索引模糊查询 %a就不可以利用索引了</p>
<p>B+树具有查询次数少，可查询数据数量大的特点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">B+树的数据存放量计算：</span><br><span class="line">1.B+树的高度</span><br><span class="line">2.根节点的指针数</span><br><span class="line">3.单个叶子记录的行数</span><br><span class="line">1*2*3 得到的就是总的行数据</span><br><span class="line">例子：</span><br><span class="line">1.B+树高2层</span><br><span class="line">2.根节点的指针数：大小16KB，一个指针6B，主键ID的数据类型是bigint，占8B，那么指针数就是：16KB&#x2F;14B&#x3D;1170个指针</span><br><span class="line">3.单个叶子记录的行数:大小16KB，一个记录1KB，那么就是16条记录</span><br><span class="line">所以总的记录数是：16*1170&#x3D;18720</span><br><span class="line">当B+树是3层的时候就是 16*1170*1170&#x3D;21902400，两千万级别的数据量</span><br></pre></td></tr></table></figure>



<h4 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h4><ul>
<li>独立地使用列：尽量避免其参与运算，独立的列指索引列不能是表达式的一部分，也不能是函数的参数，在where条件中，始终将索引列单独放在比较符号的一侧，尽量不要在列上进行运算</li>
<li>左前缀索引：构建指定索引字段的左侧的字符数，要通过索引选择性（不重复的索引值和数据表的记录总数的比值）来评估，尽量使用短索引，如果可以，应该制定一个前缀长度</li>
<li>多列索引：AND操作时适合使用多列索引，而非为每个列创建单独的索引</li>
<li>选择合适的索引列顺序：无排序和分组时，将选择性最高的列放左侧</li>
<li>只要列中含有NULL值，就最好不要在此列设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引</li>
<li>对于经常在where子句使用的列，最好设置索引</li>
<li>对于有多个列where或者order by子句，应该建立复合索引</li>
<li>对于like子句，以%或_开头的列不会使用索引，以%结尾会使用索引</li>
<li>尽量不要使用not in 和 &lt;&gt; 操作，虽然可以使用索引，但是性能不高</li>
<li>不要使用RLIKE正则表达式，这会导致索引失效</li>
<li>查询时，能不要使用“*”就不要使用，尽量写字段名，比如：select id,name,age from students;</li>
<li>大部分情况连接效率远大于子查询</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启查询缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的SQL语句优化</li>
</ul>
<h4 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h4><ul>
<li>创建索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX INDEX_NAME ON table_name(col(length));</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name ADD  INDEX index_name(index_col_name[length]);</span><br></pre></td></tr></table></figure>

<ul>
<li>查看索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEXES FROM table_name;</span><br><span class="line"></span><br><span class="line">set global userstat&#x3D;1;#开启统计</span><br><span class="line">show index_statistics;#统计有多少查询利用了索引</span><br></pre></td></tr></table></figure>

<ul>
<li>优化表空间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE table_name;</span><br></pre></td></tr></table></figure>



<ul>
<li>删除索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEXES INDEX_NAME ON table_name;</span><br></pre></td></tr></table></figure>

<p>ExPLAIN工具</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">explain select_statment</span><br><span class="line">例子：</span><br><span class="line">MariaDB [hellodb]&gt; explain select stuid,name,age,classid from students where stuid&#x3D;10;</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">| id   | select_type | table    | type  | possible_keys | key     | key_len | ref   | rows | Extra |</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">|    1 | SIMPLE      | students | const | PRIMARY       | PRIMARY | 4       | const | 1    |       |</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>explain输出信息说明：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>执行编号，标识select所属的行</td>
</tr>
<tr>
<td>select_type</td>
<td>SIMPLE|PRIMARY</td>
</tr>
<tr>
<td>table</td>
<td>访问引用哪个表</td>
</tr>
<tr>
<td>type</td>
<td>关联类型或访问类型，即MYSQL决定的如何去查询表中的行的方式</td>
</tr>
<tr>
<td>possible_keys</td>
<td>查询可能会用到的索引</td>
</tr>
<tr>
<td>key</td>
<td>显示mysql决定采用哪个索引来优化查询</td>
</tr>
<tr>
<td>key_len</td>
<td>显示mysql在索引里使用的字节数</td>
</tr>
<tr>
<td>ref</td>
<td>根据索引返回表中匹配某单个值的所有行</td>
</tr>
<tr>
<td>rows</td>
<td>为了找到所需的行而需要读取的行数，估算值，不精确</td>
</tr>
<tr>
<td>extra</td>
<td>额外信息</td>
</tr>
</tbody></table>
<p>type类型：type类型是访问类型，结果值从好到坏依次是：</p>
<p>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; all，一般来说，得保证查询至少到达range级别，最好到ref</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>最坏的情况，全表扫描</td>
</tr>
<tr>
<td>index</td>
<td>和全表一样。</td>
</tr>
<tr>
<td>range</td>
<td>范围扫描，一个有限制的索引扫描</td>
</tr>
<tr>
<td>ref</td>
<td>一种索引访问，它返回所有匹配某单个值的行</td>
</tr>
<tr>
<td>eq_ref</td>
<td>最多只返回一条符合条件的记录</td>
</tr>
<tr>
<td>const</td>
<td>当确定最多只会有一行匹配的时候，mysql优化器会在查询前读取它而且只读取一次，因此非常快</td>
</tr>
<tr>
<td>system</td>
<td>这个const连接类型的一种特例，表仅有一行满足条件</td>
</tr>
<tr>
<td>null</td>
<td>意味着mysql能在优化阶段分解查询语句，在执行阶段甚至用不到访问表或索引</td>
</tr>
</tbody></table>
<h3 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h3><h4 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h4><p>锁：</p>
<ul>
<li>读锁，共享锁，也称S锁，只读不可写（包括当前事务），多个读互不阻塞</li>
<li>写锁：独占锁，排他锁，也称为X锁，写锁会阻塞其他事务的读和写</li>
</ul>
<p>读锁和读锁是兼容的，写锁和其他锁都不兼容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如：</span><br><span class="line">  S锁和S锁是兼容的，X锁和其他锁都不兼容，举个例子，事务T1获取了一个行r1的S锁，另一个事务T2还可以获得行r1的S锁，此时T1和T2共同获得r1的S锁，此种情况称为锁兼容；但是当另外一个事务T3此时如果想获得行r1的X锁，则必须等到r1的全部锁释放之后才可以，此种情况称为锁冲突</span><br></pre></td></tr></table></figure>

<p>锁的颗粒度</p>
<ul>
<li>表级锁：MyISAM</li>
<li>行级锁：InnoDB</li>
</ul>
<p>实现：</p>
<ul>
<li>存储引擎</li>
<li>服务器级</li>
</ul>
<p>分类：</p>
<ul>
<li>隐式锁：由搜索引擎自动加锁</li>
<li>显式锁：用户手动请求</li>
</ul>
<p>锁策略：在锁颗粒度及数据安全性寻求的平衡机制</p>
<h4 id="显式使用锁"><a href="#显式使用锁" class="headerlink" title="显式使用锁"></a>显式使用锁</h4><p>帮助:<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/lock-tables/">https://mariadb.com/kb/en/lock-tables/</a></p>
<p>加锁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lock tables table_name lock_type;</span><br><span class="line">lock_type:READ和WRITE</span><br></pre></td></tr></table></figure>

<p>解锁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock  tables;</span><br></pre></td></tr></table></figure>

<p>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH TABLES [table_name] [with read lock]</span><br></pre></td></tr></table></figure>



<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>事务：Transactions 一组原子性的SQL语句，或一个独立的工作单元</p>
<p>事务日志：记录事务信息，实现undo,redo等故障恢复功能</p>
<h5 id="事务特性"><a href="#事务特性" class="headerlink" title="事务特性"></a>事务特性</h5><p><strong>ACID特性：</strong></p>
<p>A：automicity 原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</p>
<p>C：consistency 一致性；数据库总是从一个一致性状态转换成另一个一致性状态</p>
<p>I：isolation 隔离性；一个事务所做出的的操作在提交之前，是不能为其他事务所见；隔离有多种隔离级别，实现并发</p>
<p>D：durability 持久性；一旦事务提交，其所做的修改会永久保存于数据库中</p>
<p>Transcation 生命周期</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200926192208219.png" alt="image-20200926192208219"></p>
<h5 id="管理事务"><a href="#管理事务" class="headerlink" title="管理事务"></a>管理事务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--autocommit,autocommit</span><br></pre></td></tr></table></figure>

<p>显示启动事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">BEGIN WORK</span><br><span class="line">START TRANSACTION</span><br></pre></td></tr></table></figure>

<p>结束事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#提交</span><br><span class="line">COMMIT</span><br><span class="line">#回滚</span><br><span class="line">ROLLBACK</span><br></pre></td></tr></table></figure>

<p>注意：1.只有事务性存储引擎支持（存储引擎支持事务）</p>
<p>​            2.只有DML语句可以,DDL语句无法回滚!(CREATE,DROP,TRUNCATE,ALTER)</p>
<p>自动提交：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set autocommit&#x3D;&#123;1|0&#125;</span><br><span class="line">默认为1，为0时设为非自动提交</span><br><span class="line">建议：显示请求和提交事务，而不要使用“自动提交”功能</span><br></pre></td></tr></table></figure>

<p>事务支持保存点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SAVEPOINT identifier</span><br><span class="line">ROLLBACK [WORK] TO [SAVEPOINT] identifier</span><br><span class="line">RELEASE SAVEPOINT identifier</span><br></pre></td></tr></table></figure>

<p>查看事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查看当前正在进行的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line">#查看当前锁定的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;</span><br><span class="line">#查看当前等锁的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br><span class="line">#查看当前进程，如果有事务被锁可以通过进程号杀死</span><br><span class="line">show processlist;</span><br><span class="line">#杀死</span><br><span class="line">kill id;</span><br></pre></td></tr></table></figure>



<h5 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h5><p>MYsql支持四种隔离级别</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>加读锁</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td>可以出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>读提交</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>可重复读</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>序列化</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>是</td>
</tr>
</tbody></table>
<p>读未提交：READ UNCOMMITTED</p>
<p>​    可读取到未提交数据，产生脏读</p>
<p>读提交：READ COMMITTED</p>
<p>​    可读取到提交数据，但未提交数据不可读，产生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致</p>
<p>可重复读：REPETABLE READ</p>
<p>​    可重复读，多次读取数据都一致，产生幻读，即读取过程中，即使有其他提交的事务修改数据，仍只能读取到未修改前的旧数据。此为mysql默认设置</p>
<p>序列化：SERIALIZABLE</p>
<p>​    可串行化，未提交的读事务阻塞修改事务（加读锁，但不阻塞读事务），或者未提交的修改事务阻塞读事务（加写锁，其他事务的读，写都不可以执行）。会导致并发性能差</p>
<p>MVCC和事务的隔离级别：</p>
<p>MVCC（多版本并发控制机制）只在REPETABLE READ 和 READ COMMITED 两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为READ UNCOMMITED总是读取最新的数据行，而不是符合当前事务版本的数据行。而SERIALIZABLE则会对所有读取的行都加锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MVCC：Multi-Version Concurrency Control</span><br></pre></td></tr></table></figure>

<p>插入时间戳，根据时间戳来管理要查询到的数据；MVCC只对读有效果，对写无效；</p>
<p>幻读：幻读产生的原因是事务的写操作；T1事务第一次select出来的内容是A，然后T2事务执行了一个插入数据的操作并提交了，本来这样的操作在可重复读的隔离级别中T1是看不到数据改变的，但是T1接下来执行了一个UPDATE操作，update操作修改的数据恰好匹配到了T2刚刚提交的数据，那么这个数据就会被T1修改，接下来T1执行select就会看到T2提交的数据，当然已经被update修改过了。这就是幻读，第一次select和第二次select看到的内容不一致。</p>
<p>指定事务隔离级别：</p>
<p>变量：tx_isolation</p>
<p>服务器选项：transaction-isolation</p>
<ul>
<li>服务器变量tx_isolation指定，默认为REPETABLE READ，可在GLOBAL和SESSION级进行设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET tx_isolation&#x3D;&#39;READ-UNCOMMITED|READ-COMMITED|REPETABLE-READ|SERIALIZABLE&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务器选项中指定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[myslqd]</span><br><span class="line">transaction-isolation&#x3D;SERIALIZABLE</span><br></pre></td></tr></table></figure>

<p>死锁：</p>
<p>两个或多个事务在同一资源互相占用，并请求锁定对方占用的资源的状态</p>
<p>当要出现死锁时，数据库会自动发现并解决，解决方式是停止执行时间短的那个事务</p>
<h3 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h3><p>Mysql支持丰富的日志类型，如下：</p>
<ul>
<li>事务日志：transaction log</li>
</ul>
<blockquote>
<p>事务日志的写入类型为“追加”，因此其操作为“顺序IO”；通常也被称为：预写式日志 write ahead logging</p>
</blockquote>
<blockquote>
<p>事务日志文件：ib_logfile0,ib_logfile1</p>
</blockquote>
<ul>
<li>错误日志 error log</li>
<li>通用日志 general log</li>
<li>慢查询日志 slow query log</li>
<li>二进制日志 binary log</li>
<li>中继日志 reley log，在主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件</li>
</ul>
<h4 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h4><p>事务日志：transaction log</p>
<ul>
<li>redo log：实现WAL（Write Ahead Log），数据更新前先记录redo log  具体名字是：ib_logfile 默认最多50M，默认两个文件，写满就重新写，建议把这个存储值的大小调整大一些，文件个数调整成3个，存放的位置建议是一个干净的只放日志的分区，这样速度更快</li>
<li>undo log：保存与执行的操作相反的操作，用于实现rollback  具体的文件是在每个数据表的name.ibd中</li>
</ul>
<p>事务型存储引擎自行管理和使用，建议和数据文件分开存放</p>
<p>Innodb事务日志相关配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show variables like &#39;%innodb_log%&#39;;</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">| Variable_name               | Value     |</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">| innodb_log_buffer_size      | 16777216  |</span><br><span class="line">| innodb_log_checksums        | ON        |</span><br><span class="line">| innodb_log_compressed_pages | ON        |</span><br><span class="line">| innodb_log_file_size        | 100663296 |</span><br><span class="line">| innodb_log_files_in_group   | 1         |</span><br><span class="line">| innodb_log_group_home_dir   | .&#x2F;        |</span><br><span class="line">| innodb_log_optimize_ddl     | OFF       |</span><br><span class="line">| innodb_log_write_ahead_size | 8192      |</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">8 rows in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">innodb_log_file_size #每个日志文件大小</span><br><span class="line">innodb_log_files_in_group #日志组成员个数</span><br><span class="line">innodb_log_group_home_dir #事务文件路径</span><br><span class="line">innodb_flush_log_at_trx_commit #默认为1</span><br></pre></td></tr></table></figure>

<p>事务日志性能优化</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201009104011312.png" alt="image-20201009104011312"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit&#x3D;0|1|2</span><br><span class="line">1 此为默认值，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。完全遵循ACID特性，但是磁盘I&#x2F;O会变多，对数据来说最安全</span><br><span class="line">0 提交时没有写磁盘的操作；而是每秒执行一次将日志缓冲区的提交的事务写入刷新到磁盘。这样可提供更好的性能，但数据库服务崩溃可能丢失最后一秒的事务，速度最快，I&#x2F;O</span><br><span class="line">2 每次提交后都会写入OS的缓冲区，但每秒才会进行一次刷新到磁盘文件的操作。性能比0略差一些，但操作系统或停电可能导致最后一秒的数据丢失。</span><br><span class="line">1模式最慢但最安全；</span><br><span class="line">0模式最快但不安全；</span><br><span class="line">2模式中等速度中等安全</span><br><span class="line">推荐2模式</span><br></pre></td></tr></table></figure>



<h4 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h4><p>mysql启动和关闭过程中输出的事件信息</p>
<p>记录mysql运行过程中产生的错误信息</p>
<p>event_scheduler运行一个event时产生的日志信息</p>
<p>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</p>
<p>错误文件路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOABL VARIABLES LIKE &#39;log_error&#39;;</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| Variable_name | Value                  |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| log_error     | &#x2F;data&#x2F;mysql&#x2F;mysqld.log |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">1 row in set (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>记录哪些警告信息至错误日志文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log_warnings&#x3D;0|1|2|3...</span><br><span class="line">MariaDB [(none)]&gt; show variables like &#39;log_warnings&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_warnings  | 2     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure>

<h4 id="通用日志"><a href="#通用日志" class="headerlink" title="通用日志"></a>通用日志</h4><p>通用日志：记录对数据库的通用操作，包括错误的SQL语句</p>
<p>通用日志可以保存在file(默认值)或table(mysql.general_log)</p>
<p>通用日志相关设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">general_log&#x3D;ON|OFF</span><br><span class="line">general_log_file&#x3D;HOSTNAME.log</span><br><span class="line">log_output&#x3D;TABLE|FILE|NONE</span><br></pre></td></tr></table></figure>

<p>范例：查找执行次数最多的前三个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select argument,count(argument) from general_log group by argument order by count(argument) desc limit 3</span><br></pre></td></tr></table></figure>

<p>范例：对访问的语句进行排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#mysql -uroot -p&#39;centos&#39; -e &quot;select argument from mysql.general_log&quot; | awk &#39;&#123;sql[$0]++&#125;END&#123;for (i in sql) &#123;print sql[i],i&#125;&#125;&#39;|sort -nr</span><br></pre></td></tr></table></figure>



<h4 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h4><p>慢查询日志：记录执行查询时长超出指定时长的操作</p>
<p>慢查询相关变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log&#x3D;ON|OFF #开启或关闭慢查询，支持全局和会话，只有全局设置才会生成慢查询</span><br><span class="line">long_query_time&#x3D;N #慢查询的阈值，单位秒，默认为10s</span><br><span class="line">slow_query_log_file&#x3D;HOSTNAME-slow.log #慢查询日志</span><br><span class="line">log_slow_filter&#x3D;admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk</span><br><span class="line">#只有是上述查询类型且查询时长超过long_query_time阈值，才记录日志</span><br><span class="line">log_queries_not_using_indexes&#x3D;ON #不使用索引或使用全索引扫描的情况下，不论是否达到慢查询阈值。是不是要记录，默认是不记录的</span><br><span class="line">log_slow_rate_limit&#x3D;1 #多少次查询才记录，mariadb特有</span><br><span class="line">log_slow_verbosity&#x3D;query_plan,explain #记录内容</span><br><span class="line">log_slow_queries&#x3D;off #同slow_query_log</span><br></pre></td></tr></table></figure>

<p>慢查询分析工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#mysqldumpslow -s c -t 10 &#x2F;data&#x2F;mysql&#x2F;slow.log</span><br></pre></td></tr></table></figure>



<h4 id="使用profile工具"><a href="#使用profile工具" class="headerlink" title="使用profile工具"></a>使用profile工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启profile工具</span><br><span class="line">set profiling &#x3D; on</span><br><span class="line">#查看查询语句的执行时间</span><br><span class="line">show profiles;</span><br><span class="line">#显示语句的详细执行步骤和时长</span><br><span class="line">show profile for query N;  # N 是通过show profiles 看到的ID</span><br><span class="line">#显示CPU使用情况</span><br><span class="line">show profile cpu for query N # N 是 看到的ID</span><br></pre></td></tr></table></figure>



<h4 id="二进制日志（备份）"><a href="#二进制日志（备份）" class="headerlink" title="二进制日志（备份）"></a>二进制日志（备份）</h4><h5 id="二进制日志的作用："><a href="#二进制日志的作用：" class="headerlink" title="二进制日志的作用："></a>二进制日志的作用：</h5><ul>
<li>记录导致数据改变或潜在导致数据改变的SQL语句</li>
<li>记录已提交的日志</li>
<li>不依赖于存储引擎类型</li>
</ul>
<p>通过“重放”二进制日志文件中的事件来生成数据副本</p>
<p>建议二进制文件和数据文件分开存放</p>
<h5 id="二进制日志记录的三种模式"><a href="#二进制日志记录的三种模式" class="headerlink" title="二进制日志记录的三种模式"></a>二进制日志记录的三种模式</h5><ul>
<li>基于“语句”记录：statement，记录语句，默认模式（mariadb 10.2.3以下），日志量较少</li>
<li>基于“行”记录：row，记录数据，日志量较大，更加安全，建议使用的格式</li>
<li>混合模式：mixed，让系统自行判断该基于哪种方式进行，默认模式（mariadb 10.2.4以上）</li>
</ul>
<h5 id="格式配置"><a href="#格式配置" class="headerlink" title="格式配置"></a>格式配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#mariadb 10.5.5 默认是mixed</span><br><span class="line">MariaDB [hellodb]&gt; show variables like &#39;binlog_format&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | MIXED |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">#MYsql 8.0 中默认是row</span><br><span class="line">mysql&gt; show variables like &#39;binlog_format&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.06 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="二进制文件的构成"><a href="#二进制文件的构成" class="headerlink" title="二进制文件的构成"></a>二进制文件的构成</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">有两类文件</span><br><span class="line">1.日志文件，mysql|mariadb-bin.文件名后缀，二进制格式，如：mariabd-bin.00001</span><br><span class="line">2.索引文件：mysql|mariadb-bin.index，文本格式</span><br></pre></td></tr></table></figure>

<p>二进制日志相关的服务器变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sql_log_bin&#x3D;ON|OFF #是否记录二进制文件，默认on，支持动态修改，系统变量，不是服务器参数</span><br><span class="line"></span><br><span class="line">log_bin&#x3D;&#x2F;path&#x2F;bin_log_file #指定文件位置，默认为OFF</span><br><span class="line">将需要存储二进制日志的目录加上权限：chown -R mysql:mysql &#x2F;data</span><br><span class="line"></span><br><span class="line">binlog_format&#x3D;statement|row|mixed #二进制日志记录的格式，默认为</span><br><span class="line">statement</span><br><span class="line"></span><br><span class="line">max_binlog_size&#x3D;1073741824 #单个二进制文件的最大体积，到达最大值会自动滚动，默认为1G。但是文件达到上限时的文件大小未必为指定的精确值</span><br><span class="line"></span><br><span class="line">binlog_cache_size&#x3D;4M #此变量确定在每次事务中保存二进制日志更改记录的缓存的大小</span><br><span class="line"></span><br><span class="line">max_binlog_cache_size&#x3D;512M #限制用于缓存多事务查询的字节的大小</span><br><span class="line"></span><br><span class="line">sync_binlog&#x3D;1|0 #设定是否启动二进制日志即时同步磁盘功能，默认为0，由操作系统负责同步日志到磁盘</span><br><span class="line"></span><br><span class="line">expire_logs_days&#x3D;N #二进制日志可以自动删除的天数，默认为0，即不自动删除</span><br></pre></td></tr></table></figure>

<h5 id="二进制日志相关的配置"><a href="#二进制日志相关的配置" class="headerlink" title="二进制日志相关的配置"></a>二进制日志相关的配置</h5><p>查看数据库自行管理使用中的二进制日志文件列表和大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binary logs;</span><br></pre></td></tr></table></figure>

<p>查看使用中的二进制日志文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status</span><br></pre></td></tr></table></figure>

<p>查看二进制文件中的指定内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binlog events [in &#39;log_name&#39;] [from pos][limit [offset,] row_count]</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binlog events in &#39;bin.xxxxx&#39; from number1 limit xxx,xxx</span><br></pre></td></tr></table></figure>

<p>生成新的二进制文件的方式：</p>
<p>1.重启数据库服务</p>
<p>2.单个文件达到最大值，max_binlog_size</p>
<p>3.flush logs;</p>
<h5 id="myslqbinlog"><a href="#myslqbinlog" class="headerlink" title="myslqbinlog"></a>myslqbinlog</h5><p>mysqlbinlog:二进制日志的客户端命令工具，支持离线查看二进制日志</p>
<p>命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [options] logfile...</span><br><span class="line">	--start-position&#x3D; #开始位置</span><br><span class="line">	--stop-position&#x3D;</span><br><span class="line">	--start-datatime&#x3D; #开始时间，时间格式是：YYYY-MM-DD hh:mm:ss</span><br><span class="line">	--stop-datetime&#x3D;</span><br><span class="line">	--base64-output[&#x3D;name]</span><br><span class="line">	-v -vvv</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 mysql]#mysqlbinlog --start-position&#x3D;678 --stop-position&#x3D;752 binlog.000001 -v</span><br></pre></td></tr></table></figure>

<p>二进制日志事件的格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># at 328</span><br><span class="line">#151105 16:31:30 server id 1 end_log_pos 431 query thread_id&#x3D;1</span><br><span class="line">exec_time&#x3D;0 error_code&#x3D;0</span><br><span class="line">use &#96;mydb&#96;&#x2F;*!*&#x2F;;</span><br><span class="line">set timestamp&#x3D;1446712300&#x2F;*!*&#x2F;;</span><br><span class="line">create table tb1 (id int,name char(30))</span><br><span class="line">&#x2F;*!*&#x2F;;</span><br><span class="line">事件发生的日期和时间：151105 16:31:30</span><br><span class="line">事件发生的服务器标识：server id 1</span><br><span class="line">事件的结束位置：end_log_pos 431</span><br><span class="line">事件的类型：query</span><br><span class="line">事件发生时所在服务器执行此时间的线程的ID：thread_id&#x3D;1</span><br><span class="line">语句的时间戳与将其写入二进制文件中的时间差：exec_time&#x3D;0</span><br><span class="line">错误代码：error_code&#x3D;0</span><br><span class="line">事件内容：</span><br><span class="line">use &#96;mydb&#96;&#x2F;*!*&#x2F;;</span><br><span class="line">set timestamp&#x3D;1446712300&#x2F;*!*&#x2F;;</span><br><span class="line">create table tb1 (id int,name char(30))</span><br><span class="line">&#x2F;*!*&#x2F;;</span><br></pre></td></tr></table></figure>

<p>清除指定二进制日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PURGE &#123;BINARY|MASTER&#125; LOGS &#123;TO &#39;log_name&#39; |BEFROE datetime_expr&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PURGE BINARY LOGS TO &#39;bin.xxxx&#39;;</span><br><span class="line">PURGE BINARY LOGS BEFROE &#39;2018-01-01&#39;</span><br></pre></td></tr></table></figure>

<p>删除所有二进制日志，index文件重新计数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESET MASTER [TO NUMBER]；#删除所有二进制日志文件，并重新生成日志文件，文件名从&#39;NUMBER&#39;开始计数，默认从1开始，一般是master主机第一次启动时执行</span><br></pre></td></tr></table></figure>

<p>切换日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FULSH LOGS;</span><br></pre></td></tr></table></figure>






<h2 id="MySQL备份和恢复"><a href="#MySQL备份和恢复" class="headerlink" title="MySQL备份和恢复"></a>MySQL备份和恢复</h2><h3 id="备份恢复概述"><a href="#备份恢复概述" class="headerlink" title="备份恢复概述"></a>备份恢复概述</h3><p>1.为什么要备份：</p>
<p>​    灾难恢复；硬件故障；软件故障；自然灾害；黑客攻击；误操作；</p>
<p>2.备份的类型：</p>
<ul>
<li>完全备份，部分备份<ul>
<li>完全备份：整个数据库全部数据</li>
<li>部分备份：只备份数据，是一个子集</li>
</ul>
</li>
<li>完全备份、增量备份、差异备份<ul>
<li>增量备份：在完全备份以及之前的增量备份的基础上，只备份变化的数据，备份较快，恢复复杂，也就是下一次增量备份是建立在之前备份的基础上的，增量备份文件个数会越来越多，他的备份参照物是第一次完全备份文件以及之后每次的增量备份文件</li>
<li>差异备份：在完全备份的基础上，只备份与完全备份时不相同的数据。备份较慢，恢复简单。他的参照物就是第一次的完全备份，之后每次的差异备份都会把当今的数据和完全备份的数据进行对比，然后把有差异的部分备份下来。他的备份文件就是两部分，一部分是完全备份，一部分是差异备份，但是时间长了，差异备份文件就会变大，备份起来也更慢</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200928095706768.png" alt="增量备份"></p>
<p>​                                    图1.增量备份</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200928095754867.png" alt="差异备份"></p>
<p>​                                    图2.差异备份</p>
<ul>
<li><p>冷备份、温备份、热备份</p>
<ul>
<li>冷备份：读、写操作均不可进行，数据库停止服务</li>
<li>温备份：读操作可执行，但写操作不可执行</li>
<li>热备份：读、写操作均可执行</li>
</ul>
<p>注：MyISAM支持冷备份和温备份，不支持热备份；InnoDB三种备份都支持</p>
</li>
<li><p>物理备份和逻辑备份</p>
<ul>
<li>物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快</li>
<li>逻辑备份：从数据库中“导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度</li>
</ul>
</li>
</ul>
<p>3.备份什么</p>
<ul>
<li><p>数据</p>
</li>
<li><p>二进制日志、InnoDB事务日志</p>
</li>
<li><p>用户账户，权限设置，程序代码（存储过程、函数、触发器、事件调度器）</p>
</li>
<li><p>服务器的配置文件</p>
</li>
<li><p>表、视图、触发器存放在对应数据库的文件夹下</p>
<p>函数、存储过程存放在mysql.proc表中</p>
<p>事件存放在mysql.event表中</p>
</li>
</ul>
<p>物理备份：</p>
<ul>
<li>/data/mysql/* 所有数据文件</li>
<li>/etc/my.cnf 服务配置文件</li>
<li>/data/logbin/* 二进制日志</li>
</ul>
<p>逻辑备份：</p>
<ul>
<li>mysql库（这里也包括了函数、存储过程、事件）</li>
<li>用户数据库</li>
</ul>
<p>4.备份注意要点</p>
<ul>
<li>能容忍最多丢失多少数据</li>
<li>备份产生的负载</li>
<li>备份过程的时长</li>
<li>温备份的持续锁多久</li>
<li>恢复数据需要在多长时间内完成</li>
<li>需要备份和恢复哪些数据</li>
</ul>
<p>5.还原要点</p>
<ul>
<li><strong>做还原测试，用于测试备份的可用性</strong></li>
<li><strong>还原演练，写成规范的技术文档</strong></li>
</ul>
<p>6.备份工具</p>
<ul>
<li>cp,tar等复制归档工具；物理备份工具，适用于所有存储引擎；只支持冷备；完全和部分备份</li>
<li>LVM的快照：先加读锁，做快照后解锁，几乎热备；借助文件系统工具进行备份</li>
<li>mysqldump：逻辑备份工具，适用于所有存储引擎，支持完全备份和部分备份；对InnoDB存储引擎支持热备，结合binlog的增量备份；对MyISAM存储引擎进行温备份；</li>
<li>xtrabackup：由Percona提供的支持对InnoDB做热备（物理备份）的工具，支持完全备份、增量备份</li>
<li>MariaDB Backup：从MariaDB10.1.26开始集成</li>
<li>mysqlbackup：热备份</li>
<li>mysqlhotcopy：Perl语言实现，几乎冷备份，仅适用于MyISAM存储引擎，使用LOCK TABLES、FLUSH TABLES和cp或scp来快速备份数据库</li>
</ul>
<h3 id="mysqldump备份工具"><a href="#mysqldump备份工具" class="headerlink" title="mysqldump备份工具"></a>mysqldump备份工具</h3><p>避免DDL语句的出现</p>
<h4 id="mysqldump-说明"><a href="#mysqldump-说明" class="headerlink" title="mysqldump 说明"></a>mysqldump 说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqldump database [table]  #支持指定数据库和数据表的备份，但是数据库本身的定义没有备份，不推荐使用</span><br><span class="line">OR</span><br><span class="line">mysqldump [options] -B database1 [db2,db3...]  #支持指定数据库备份，包含数据库本身定义也会备份，推荐使用</span><br><span class="line">OR</span><br><span class="line">mysqldump [options] -A [options]   #备份所有数据库，包含数据库本身定义也会备份，注意information_schema和performance_schema表不会备份，这两个是内存中使用的表</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-A,--all-databases #备份所有数据库，包含数据库定义语句；不备份Information_schema和performance_schema表</span><br><span class="line">-B --database db_name  #指定备份的数据库，包括数据库定义语句</span><br><span class="line">-E --events  #备份相关的所有event scheduler</span><br><span class="line">-R --routines  #备份所有函数和存储过程</span><br><span class="line">--triggers  #备份所有触发器，默认启用</span><br><span class="line">--default-character-set&#x3D;  #指定默认字符集</span><br><span class="line">--master-data[&#x3D;N]  #这个选项必须开启二进制日志使用</span><br><span class="line">#选项是1或者2；默认是1；</span><br><span class="line">#这个选项本身的意思是在生成的备份文件中（*.sql）添加一句 CHANGE MASTER TO 语句，1是不注释这句话，适合用于主从复制，2是注释这句话，适合单机使用</span><br><span class="line">#CHANGE MASTER TO 指明了备份完的数据库后面的内容从哪里继续了，给人一个明确的文件和文件位置</span><br><span class="line">#这个选项会默认打开-x或者--lock-all-tables功能，也就是锁全表功能，除非打开了--single-transaction选项</span><br><span class="line">-F --flush-logs  #锁表完成后刷新日志，从新的日志文件开始，配合-A或-B的话会导致多次刷新日志，可以配合--single-transaction，--master-data，这样就只刷新一次</span><br><span class="line">--compact   #去掉注释的内容，适合调试时使用，节约一些空间，生产中不用</span><br><span class="line">-d --no-data  #只备份数据结构，不备份数据，即备份create xxxx</span><br><span class="line">-t --no-create-info  #只备份数据，不备份结构，即没有create xxx</span><br><span class="line">-n --no-create-db  #不备份create database，可以被-A和-B覆盖</span><br><span class="line">--flush-privileges  #刷新权限，备份mysql库时要使用</span><br><span class="line">-f --force #忽略SQL错误，继续执行</span><br><span class="line">--hex-blob  #使用十六进制符号转储二进制列，当包含BINARY,VARBINARY,BLOB,BIT的数据类型的列时使用</span><br><span class="line">-q --quick  #不缓存查询，直接输出，加快备份速度</span><br><span class="line"></span><br><span class="line">与MyISAM存储引擎有关的备份选项：</span><br><span class="line">MyISAM不支持事务，只能支持温备，不支持热备，所以备份前要锁定要备份的数据库，而后启动备份操作</span><br><span class="line">-x --lock-all-tables  #加全局读锁，锁定所有库的所有表</span><br><span class="line">-l --lock-tables  #对于需要备份的每个数据库，在启动备份之前分别锁定其所有表</span><br><span class="line"></span><br><span class="line">与InnoDB存储引擎有关的备份选项：</span><br><span class="line">InnoDB存储引擎支持事务，可以利用事务的相应的隔离级别，实现热备，也可以实现温备，但不建议使用</span><br><span class="line">--single-transaction</span><br><span class="line">此选项在备份前开启一个事务，start transaction。</span><br><span class="line">注意，事务的基础是MVCC，多版本并发控制。MVCC是由存储引擎支持的（只有InnoDB支持）。</span><br><span class="line">MVCC可以管理DML语句，但是DDL语句就无能为力了，因此在开启一个事务时其他人不要使用DDL语句（CREATE,ALTER,DROP,TRUNCATE,RENAME）。</span><br></pre></td></tr></table></figure>



<p>InnoDB备份建议命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -F -E -R --single-transaction --master-data&#x3D;1 --flush-privileges --default-character-set&#x3D;utf8mb4 --hex-blob | gzip &gt; &#x2F;backup&#x2F;full.sql.gz</span><br></pre></td></tr></table></figure>



<p>MyISAM备份建议命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -E -R -F -x --master-date&#x3D;1 --flush-privileges --default-character-set&#x3D;utf8mb4 --hex-blob | gzip &gt; &#x2F;backup&#x2F;full.sql.gz</span><br></pre></td></tr></table></figure>



<h4 id="mysql分库备份实战"><a href="#mysql分库备份实战" class="headerlink" title="mysql分库备份实战"></a>mysql分库备份实战</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -B database  | gzip &gt; backup.sql.gz</span><br></pre></td></tr></table></figure>

<p>范例：分库备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for db in &#96;mysql -uroot -pcentos -e &#39;show databases&#39; | grep -vE &quot;Database|information_schema|performance_schema&quot;&#96;;do mysqldump -uroot -pcentos -B $db | gzip &gt; &#x2F;backup&#x2F;$db-&#96;date +%F-%H-%M-%S&#96;.sql.gz;done;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pcentos -e &#39;show databases&#39; | grep -Ev &quot;Database|information_schema|performance_schema&quot;|while read db;do mysqldump -uroot -pcentos -B $db | gzip &gt; &#x2F;backup&#x2F;$db-&#96;date +%F_%H-%M-%S&#96;.sql.gz;done</span><br></pre></td></tr></table></figure>



<h4 id="mysqldump-备份还原实战案例"><a href="#mysqldump-备份还原实战案例" class="headerlink" title="mysqldump 备份还原实战案例"></a>mysqldump 备份还原实战案例</h4><p>如何开启二进制日志；二进制日志的结构，是不是可以直接阅读的；是不是可以直接修改二进制日志文件中的drop,delete等行就可以把数据恢复回来了；数据备份了如何还原；</p>
<p>没有二进制文件也可以备份，把想要备份的数据库备份了就行</p>
<p>数据库的恢复：在mysql命令行中 source /backup/xxx.sql  直接进行恢复</p>
<p>分数据库进行备份</p>
<p>下面的操作是把需要备份的数据库名字找到，找到后使用 mysqldump -B 进行备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#mysql -uroot -p -e &#39;show databases&#39;|grep -Ev &#39;^(Database|information_schema|performance_schema)$&#39;|while read db;do echo &quot;备份$db&quot;;done</span><br><span class="line">Enter password: </span><br><span class="line">备份hellodb</span><br><span class="line">备份mysql</span><br></pre></td></tr></table></figure>

<p>全部备份，实现增量备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">备份文件放在&#x2F;backup下</span><br><span class="line">日志文件放在&#x2F;data&#x2F;mysql&#x2F;mylogbin-xxxx </span><br></pre></td></tr></table></figure>

<p>1.全部备份，依靠二进制文件，生成一个.sql文件</p>
<p>2.对数据库进行操作，增加删除数据，修改数据表等操作</p>
<p>3.发现删错数据了，想要还原</p>
<p>4.还原需要依靠一直开着的二进制日志才能完成，要不然只能回复到备份状态，中间所有操作都会丢失。开启二进制日志的话，不管中间做了什么，都能保留下来，只把删除语句删除了就行</p>
<p>5.去完全备份文件中找到备份结束的标志：CHANGE MASTER TO ，并查看它把下一步日志指向了哪个二进制日志文件，位置是哪里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE&#x3D;&#39;mylogbin.000002&#39;, MASTER_LOG_POS&#x3D;383;</span><br></pre></td></tr></table></figure>

<p>6.找到这个二进制日志文件，找到这个位置，用mysqlbinlog</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myslqbinlog &#x2F;data&#x2F;mysql&#x2F;mylogbin.000002 --start-position&#x3D;383</span><br></pre></td></tr></table></figure>

<p>7.把从这个位置之后的内容重定向到一个新文件inc.sql中，这代表了从完全备份后的增量日志文件，通过这个文件可以把增量的数据都找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog &#x2F;data&#x2F;mysql&#x2F;mylogbin.000002 --start-position&#x3D;383</span><br><span class="line"> &gt; &#x2F;backup&#x2F;inc.sql</span><br></pre></td></tr></table></figure>

<p>8.因为是错误删除数据了，所以去这个增量文件中找到删除命令 ‘DROP TABLE’,然后把这行删除就行了，这样再把这个文件还原了就能获得没有被删除的数据了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak &#39;&#x2F;^DROP TABLE&#x2F;d&#39; inc.sql</span><br></pre></td></tr></table></figure>

<p>9.停止访问数据库，在mysql客户端命令行中关闭二进制日志，准备还原 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set sql_log_bin&#x3D;0</span><br></pre></td></tr></table></figure>

<p>10.还原，先还原完全备份，然后再还原增量文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;backup&#x2F;full_backup.sql</span><br><span class="line">source &#x2F;backup&#x2F;inc.sql</span><br></pre></td></tr></table></figure>

<p>11.查看数据库，发现数据都回来了</p>
<h3 id="xtrabackup备份工具"><a href="#xtrabackup备份工具" class="headerlink" title="xtrabackup备份工具"></a>xtrabackup备份工具</h3><h4 id="xtrabackup工具介绍"><a href="#xtrabackup工具介绍" class="headerlink" title="xtrabackup工具介绍"></a>xtrabackup工具介绍</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html">https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html</a></p>
<p>自MariaDB10.2.7（含）以上版本，不再支持使用Percona XtraBackup工具在线物理热备份。使用mariabackup</p>
<h4 id="xtrabackup安装"><a href="#xtrabackup安装" class="headerlink" title="xtrabackup安装"></a>xtrabackup安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install xtrabackup</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl-Digest-MD5</span><br></pre></td></tr></table></figure>

<h4 id="xtrabackup用法"><a href="#xtrabackup用法" class="headerlink" title="xtrabackup用法"></a>xtrabackup用法</h4><p>xtrabackup使用分三步：</p>
<p>1.备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#xtrabackup --user&#x3D;root --password&#x3D;&#39;centos&#39; -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<p>2.预准备</p>
<p>这一步是为了让二进制日志文件和数据库中的数据保持一致性。</p>
<p>因为在对数据库进行操作时，会先把操作写入日志，然后经过提交事务后才会对数据库进行操作。所以要把日志中还没提交的事务回滚，把已经提交的事务同步给数据库。这样就能让日志和数据库保持一致性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 data]#xtrabackup --prepare --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>



<p>3.还原</p>
<p>这一步中有要求：</p>
<ul>
<li>数据库服务要停了</li>
<li>存放数据文件的文件夹必须为空</li>
</ul>
<p>然后执行还原命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 data]#xtrabackup --copy-back --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<p>最后把数据文件的所有者和所有组修改成mysql</p>
<h4 id="利用xtrabackup实现完全备份及还原"><a href="#利用xtrabackup实现完全备份及还原" class="headerlink" title="利用xtrabackup实现完全备份及还原"></a>利用xtrabackup实现完全备份及还原</h4><h4 id="利用xtrabackup实现完全，增量备份及还原"><a href="#利用xtrabackup实现完全，增量备份及还原" class="headerlink" title="利用xtrabackup实现完全，增量备份及还原"></a>利用xtrabackup实现完全，增量备份及还原</h4><p>增量备份</p>
<p>1.完全备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;&#39;centos&#39; -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;bak</span><br></pre></td></tr></table></figure>

<p>2.修改数据，实现增量数据</p>
<p>3.增量备份一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;inc --incremental-basedir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>

<p>4.再次修改数据，实现增量数据</p>
<p>5.增量备份一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;inc2 --incremental-basedir&#x3D;&#x2F;backup&#x2F;inc&#x2F;</span><br></pre></td></tr></table></figure>

<p>6.出现错误想要还原数据</p>
<p>7.相比完全备份的还原，增量备份的还原在prepare阶段需要进行一次完全备份准备以及多次增量备份准备（增量备份了几次就还原几次）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare --apply-log-only --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare --apply-log-only --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F; --incremental-dir&#x3D;&#x2F;backup&#x2F;inc&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare  --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F; --incremental-dir&#x3D;&#x2F;backup&#x2F;inc2&#x2F;</span><br></pre></td></tr></table></figure>

<p>8.还原过程与完全备份一样，需要停止服务，清空数据文件的存放目录，以及最后把所有者和所有组改成mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysqld stop</span><br><span class="line">rm -rf &#x2F;data&#x2F;mysql&#x2F;*</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --copy-back --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure>



<h4 id="xtrabackup单表导出和导入"><a href="#xtrabackup单表导出和导入" class="headerlink" title="xtrabackup单表导出和导入"></a>xtrabackup单表导出和导入</h4><p>单表导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos --backup --target-dir&#x3D;&#x2F;backup&#x2F; --tables&#x3D;&#39;^hellodb[.]students&#39; -S &#x2F;tmp&#x2F;mysql.sock</span><br></pre></td></tr></table></figure>



<h2 id="MySQL集群Cluster"><a href="#MySQL集群Cluster" class="headerlink" title="MySQL集群Cluster"></a>MySQL集群Cluster</h2><h3 id="MySQL主从复制"><a href="#MySQL主从复制" class="headerlink" title="MySQL主从复制"></a>MySQL主从复制</h3><h4 id="1-主从复制架构和原理"><a href="#1-主从复制架构和原理" class="headerlink" title="1.主从复制架构和原理"></a>1.主从复制架构和原理</h4><p>1.1 服务性能扩展方式</p>
<ul>
<li>Scale Up，向上扩展，垂直扩展</li>
<li>Scale Out，向外扩展，横向扩展</li>
</ul>
<p>1.2 MySQL的扩展</p>
<ul>
<li>读写分离</li>
<li>复制：每个节点都有相同的数据集，向外扩展，基于二进制日志的单向复制</li>
</ul>
<p>1.3 复制的功用</p>
<ul>
<li>实现数据分布</li>
<li>实现负载可以均衡地读</li>
<li>实现备份</li>
<li>实现高可用和故障切换</li>
<li>MySQL升级测试</li>
</ul>
<p>1.4 复制的架构</p>
<p>一主一从的复制架构</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929165555349.png" alt="image-20200929165555349"></p>
<p>一主多从的复制架构</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929165621541.png" alt="image-20200929165621541"></p>
<p>1.5 主从复制的原理</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929171429834.png" alt="image-20200929171429834"></p>
<p>主从复制相关线程：</p>
<p>主节点：</p>
<ul>
<li>dump Thread：为每个Slave的 I/O Thread启动一个dump线程，用于向其发送binary log events</li>
</ul>
<p>从节点：</p>
<ul>
<li>I/O Thread：向Master请求二进制日志事件，并保存于中继日志(RELAY LOG)中</li>
<li>SQL Thread：从中继日志中读取日志事件，在本地完成重放</li>
</ul>
<p>根复制相关的文件：</p>
<ul>
<li>master.info：用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等</li>
<li>relay-log.info：保存在当前slave节点上已经复制的当前二进制日志和本地relay log日志的对应关系</li>
<li>mariadb-relay-bin.00000#：中继日志，保存从主节点复制过来的二进制日志，本质就是二进制日志</li>
</ul>
<p>1.6 主从复制特点</p>
<ul>
<li>异步复制</li>
<li>主从数据不一致比较常见</li>
</ul>
<p>1.7 各种复制架构</p>
<ul>
<li>一主一从</li>
<li>一主多从</li>
<li>从服务器可以再有从服务器</li>
<li>主主</li>
<li>一从多主：适用于多个不同数据库</li>
<li>环状复制</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929173016961.png" alt="image-20200929173016961"></p>
<p>复制时需要考虑二进制日志事件的记录格式</p>
<ul>
<li>STATEMENT（5.0之前）</li>
<li>ROW（目前推荐）</li>
<li>MIXED</li>
</ul>
<h4 id="2-实现主从复制配置"><a href="#2-实现主从复制配置" class="headerlink" title="2.实现主从复制配置"></a>2.实现主从复制配置</h4><p>配置分为主节点的配置和从节点的配置</p>
<p><strong>主节点配置：</strong></p>
<p>（1）启用二进制日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin </span><br><span class="line">#或者指定log_bin&#x3D;&#x2F;backup&#x2F;logbin，这样指定路径的方式一定要给备份路径更改用户组和用户为mysql，否则会导致服务无法启动</span><br></pre></td></tr></table></figure>

<p>（2）为当前节点设置一个全局唯一的ID号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id &#x3D; NUMBER </span><br><span class="line">log-basename &#x3D; master #可选性，设置二进制日志名称，确保不依赖于主机名</span><br></pre></td></tr></table></figure>

<p>说明：server-id的取值范围</p>
<p>1 to 4294967295 (2^32) （mariadb 10.2.2 以上版本）默认值为1</p>
<p>0 to 4294967295 (2^32) （mariadb 10.2.1 以下版本）默认值为0</p>
<p>（3）创建有复制权限的用户账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;repluser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#39;repluser&#39;@&#39;10.0.0.%&#39;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（4）查看从二进制日志的文件和位置开始进行复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER status;</span><br><span class="line"> binlog.000016 |      725 </span><br></pre></td></tr></table></figure>

<p><strong>从节点配置</strong></p>
<p>（1）启动中继日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id &#x3D; NUMBER #为当前节点设置一个全局唯一的ID号</span><br><span class="line">log-bin</span><br><span class="line">read_only &#x3D; ON   #设置数据库只读，针对supper user无效，注意这个意思是从服务器的超级用户是可以更改数据的！！！</span><br><span class="line">relay_log &#x3D; relay-log  #relay log的文件路径，默认值hostname-relay-bin</span><br><span class="line">relay_log_index &#x3D; relay-log.index #默认值hostname-relay-bin.index</span><br></pre></td></tr></table></figure>

<p>（2）登录本机的数据库，并启动复制线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.登录本机的数据库</span><br><span class="line">2.开始设置：</span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;192.168.8.8&#39;,</span><br><span class="line">MASTER_USER&#x3D;&#39;repluser&#39;,</span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;centos&#39;,</span><br><span class="line">MASTER_PORT&#x3D;3306,</span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;mariadb-bin.000002&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;545;</span><br><span class="line"></span><br><span class="line">START SLAVE;  #启动复制线程</span><br><span class="line">SHOW SLAVE STATUS;</span><br><span class="line"></span><br><span class="line">change master to  是个命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果主节点是新建的库，那么就按照这个步骤执行；如果主节点已经运行了，新增从节点，那么就需要做这几件事：</p>
<p>1.给主节点全部备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -pcentos -A -E -R -F --single-transaction --master-data&#x3D;1 --flush-privileges --hex-blob --default-character-set&#x3D;utf8mb4 | gzip &gt; &#x2F;backup&#x2F;test1&#x2F;full.sql.gz </span><br></pre></td></tr></table></figure>

<p>2.查看主节点当前的二进制日志和日志中的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show master status</span><br><span class="line">binlog.xxxx   727</span><br></pre></td></tr></table></figure>

<p>3.从节点导入全部备份，并且设置开始复制的主节点二进制日志和日志中的位置，这样设置的意思就是，之前的内容我从节点都有了，之后的内容就从你现在的位置开始复制</p>
<h4 id="3-主从复制相关设置"><a href="#3-主从复制相关设置" class="headerlink" title="3.主从复制相关设置"></a>3.主从复制相关设置</h4><p>1.解决复制冲突</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--sql_skip_errors,sql_slave_skip_counter</span><br><span class="line">可以在从服务器忽略几个主服务器的复制事件，或跳过事件的ID</span><br><span class="line">通过 SHOW SLAVE STATUS; 可以看到错误码，然后两种方法跳过：</span><br><span class="line">第一种：</span><br><span class="line">stop slave; #关闭slave线程</span><br><span class="line">set global sql_slave_skip_counter &#x3D; 1;</span><br><span class="line">start slave; #开启slave线程</span><br><span class="line">第二种：</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">slave_skip_errors&#x3D;ERROR_CODE | ALL  #这里填写错误码</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>2.保证主从复制的事务安全</p>
<p>在master节点启用参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sync_binlog&#x3D;1;#每次写后都把二进制日志同步到磁盘，性能差</span><br><span class="line">#Innodb存储引擎的设置</span><br><span class="line">innodb_flush_log_at_trx_commit&#x3D;1 #每次事务提交立即同步日志写磁盘</span><br><span class="line">innodb_support_xa&#x3D;on  #分布式mariadb10.3.0废除</span><br><span class="line">sync_master_info&#x3D;NUMBER #number次事件后，master.info同步到磁盘</span><br></pre></td></tr></table></figure>

<p>在slave节点启用服务器选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skip-slave-start&#x3D;ON</span><br></pre></td></tr></table></figure>

<p>在slave节点启用参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sync_relay_log&#x3D;NUMBER #number次后同步relay_log到磁盘</span><br><span class="line">sync_relay_log_info&#x3D;NUMBER #number次事务后同步relay-log.info到磁盘</span><br></pre></td></tr></table></figure>

<p>范例：当一个主服务器宕机，临时提升一个从服务器成为新的主服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">步骤：</span><br><span class="line">1.查看哪个从节点的数据是最新的，让它成为新的主服务器</span><br><span class="line">cat &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;relay-log.info或者在数据库中执行show slave status\G 查看POS值</span><br><span class="line">2.新的主服务器修改配置文件，关闭read-only配置，清除旧主服务器的复制信息</span><br><span class="line">stop slave;</span><br><span class="line">reset slave all;</span><br><span class="line">flush privileges;#这个命令不输入，会导致其他从服务器无法连接到新主服务器</span><br><span class="line">3.在新主服务器上全量备份</span><br><span class="line">4.分析旧的主服务器的二进制日志，把没有同步给新主服务器的内容导出来，还原到新主服务器，尽可能恢复数据</span><br><span class="line">5.其他所有从服务器重新还原数据库，指向新的主服务器</span><br></pre></td></tr></table></figure>

<h4 id="4-实现级联复制"><a href="#4-实现级联复制" class="headerlink" title="4.实现级联复制"></a>4.实现级联复制</h4><p>三台服务器：</p>
<p>master</p>
<p>级联</p>
<p>slave</p>
<p>就是级联服务器上配置了一项，然后最下级服务器的主服务器指向级联服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_slave_updates   #这个选项开启后级联服务器也可以修改二进制日志</span><br></pre></td></tr></table></figure>

<p>slave服务器的主服务器指向了级联服务器</p>
<h4 id="5-主主复制"><a href="#5-主主复制" class="headerlink" title="5.主主复制"></a>5.主主复制</h4><p>两个节点都可以更新数据，并且互为主从，容易差生数据不一致的问题，要慎用</p>
<p>可以通过这个设置避免出现插入同样的数据；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset&#x3D;1  #这个是起始的数字</span><br><span class="line">auto_increment_increment&#x3D;2 #这个是增长量</span><br><span class="line">#两台服务器配置不同的起始数字，相同的增长量，这样可以变成奇偶，不冲突</span><br></pre></td></tr></table></figure>



<h4 id="6-半同步复制"><a href="#6-半同步复制" class="headerlink" title="6.半同步复制"></a>6.半同步复制</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/semisynchronous-replication/#enabling-semisynchronous-replication">https://mariadb.com/kb/en/semisynchronous-replication/#enabling-semisynchronous-replication</a></p>
<p>默认情况下，MySQL的复制功能是异步的，异步复制可以提供最好的性能，主库把binary log发送给从库即结束，并不验证从库是否接收完毕。这意味着当主服务器或从服务器端发生故障时，有可能从服务器没有接收到主服务器发送过来的binlog日志，这就会导致主服务和从服务器数据不一致。</p>
<p>半同步会有确认的过程，这个是通过一个插件实现的  Plugin: rpl_semi_sync_master</p>
<p>半同步复制的意思是，一主多从的情况下，当主服务器的数据发生变化后，主服务要先把数据同步给至少一台从服务器（只要有一台从服务器返回给主服务器同步成功的信号）或者同步时间超过预设的等待时间后，然后才会返回客户端，表示数据修改成功。</p>
<p>这个插件有两个部分，master和slave，通过INSTALL SONAME的方式安装以及在配置文件中写上插件选项及名称</p>
<p>mariadb10.3.3之前版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.安装插件</span><br><span class="line">#通过命令行安装插件</span><br><span class="line">#主服务配置</span><br><span class="line">INSTALL SONAME &#39;semisync_master&#39;;</span><br><span class="line"></span><br><span class="line">#从服务器配置</span><br><span class="line">INSTALL SONAME &#39;semisync_slave&#39;</span><br><span class="line"></span><br><span class="line">#服务器配置添加插件</span><br><span class="line">#主服务器配置</span><br><span class="line">[mariadb]</span><br><span class="line">...</span><br><span class="line">plugin_load_add &#x3D; semisync_master</span><br><span class="line"></span><br><span class="line">#从服务器配置</span><br><span class="line">[mariadb]</span><br><span class="line">...</span><br><span class="line">plugin_load_add &#x3D; semisync_slave</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.开启变量</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;1</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000 #超时时间，这个3秒</span><br></pre></td></tr></table></figure>

<p>但是在mariadb 10.3.3开始这个插件就内置在数据库了，不需要去安装插件</p>
<p>在主从服务器上都打开这个选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#这两个都是既是服务器选项又是全局变量</span><br><span class="line">#主服务配置</span><br><span class="line">rpl_semi_sync_mastere_enabled &#x3D; ON</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000 #最大等待时间，这个代表3s</span><br><span class="line">#从服务器配置</span><br><span class="line">rpl_semi_sync_slave_enabled &#x3D; ON</span><br></pre></td></tr></table></figure>

<p>mysql 5.6,5.7,8.0开启半同步复制的方法：SONAME就是 .so文件的名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">服务器选项：</span><br><span class="line">plugin-load-add&#x3D;semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;on</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000;</span><br><span class="line"></span><br><span class="line">1.安装插件</span><br><span class="line">#安装主服务器的插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_snyc_master SONAME &#39;semisync_master.so&#39;</span><br><span class="line">#安装从服务器的插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_snyc_slave SONAME &#39;semisync_slave.so&#39;</span><br><span class="line">2.开启半同步变量</span><br><span class="line">#主服务器配置</span><br><span class="line">SET GLOBAL rpl_semi_sync_master_enabled&#x3D;1;</span><br><span class="line">SET GLOBAL rpl_semi_sync_master_timeout&#x3D;N;#这里的单位是毫秒，如果要设置成3秒，就写3000</span><br><span class="line">#从服务器配置</span><br><span class="line">SET GLOBAL rpl_semi_sync_slave_enabled&#x3D;1;</span><br><span class="line"></span><br><span class="line">#或者通过服务器配置，这几个变量都是服务器选项</span><br></pre></td></tr></table></figure>



<h4 id="7-复制过滤器"><a href="#7-复制过滤器" class="headerlink" title="7.复制过滤器"></a>7.复制过滤器</h4><p>让从节点仅复制指定的数据库，或指定数据库的指定表</p>
<p>复制过滤器的两种实现方式：类似黑名单，一个是二进制日志黑名单，一个是中继日志黑名单</p>
<p>（1）服务器选项：主服务仅向二进制日志中记录与特定数据库相关的事件</p>
<p>也有优点：仅需要在主服务器上配置一次，从服务器都会生效；</p>
<p>缺点：主服务器仅把白名单中的数据库备份到二进制日志，其他数据库不记录，会造成数据风险；</p>
<p>不建议使用</p>
<p>（2）从服务器SQL_THREAD在读取relay log中的事件时，仅读取与特定数据库（表）相关的事件并应用于本地</p>
<p>会造成网络和磁盘I/O浪费</p>
<p>选项中配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">replication_do_db&#x3D;db1</span><br><span class="line">replication_do_db&#x3D;db2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>命令行中设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replication_do_db&#x3D;&quot;db1,db2,db3&quot;</span><br></pre></td></tr></table></figure>



<h4 id="8-复制主从加密"><a href="#8-复制主从加密" class="headerlink" title="8.复制主从加密"></a>8.复制主从加密</h4><p>因为mysql的主从复制默认是不加密的，通信中的数据都是明文，很危险</p>
<p>通过SSL/TLS加密 transport layer security protocol，ssl是不安全的了，只是大家都这么叫这个协议，所以还留着他的名字</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/replication-with-secure-connections/">https://mariadb.com/kb/en/library/replication-with-secure-connections/</a></p>
<p>需要CA Certificate Authority x509 非对称密钥对 openssl</p>
<p>需要开启ssl，需要生成一个必须经过ssl认证的账户</p>
<p>1.生成CA</p>
<p>2.生成私钥</p>
<p>3.生成证书</p>
<p>4.一共需要：CA证书、私钥、主服务器私钥、证书、从服务器私钥、证书六样东西</p>
<p>5.具体步骤不写了。</p>
<h4 id="9-GTID"><a href="#9-GTID" class="headerlink" title="9.GTID"></a>9.GTID</h4><p>Global Transaction Identity 全局事务标识符</p>
<p>mysql5.6之后支持，GTID不像传统的复制方式（异步复制、半同步复制）需要找到binlog文件名和position，它只需要知道master的IP、端口、账户、密码即可。开启GTID后，执行</p>
<p>change master to master_auto_position=1即可，它会自动寻找到相应的位置开始同步</p>
<p>配置：</p>
<p>主服务器配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br></pre></td></tr></table></figure>

<p>从服务器配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">重启mysql服务后在命令输入：</span><br><span class="line">mysql&gt; change master to master_host&#x3D;&#39;10.0.0.7&#39;,</span><br><span class="line">    -&gt; master_user&#x3D;&#39;repluser&#39;,</span><br><span class="line">    -&gt; master_password&#x3D;&#39;centos&#39;,</span><br><span class="line">    -&gt; master_port&#x3D;3306,</span><br><span class="line">    -&gt; master_auto_position&#x3D;1;</span><br></pre></td></tr></table></figure>



<h4 id="10-复制的监控和维护"><a href="#10-复制的监控和维护" class="headerlink" title="10.复制的监控和维护"></a>10.复制的监控和维护</h4><p>1.清理日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PURGE &#123;BINARY|MASTER&#125; LOGS &#123; TO &#39;log_name&#39; | before datetime_expr&#125;</span><br><span class="line"></span><br><span class="line">RESET  SLAVE ALL;</span><br><span class="line"></span><br><span class="line">RESET MASTER TO N;#mysql不支持</span><br></pre></td></tr></table></figure>

<p>2.状态监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS;</span><br><span class="line">SHOW MASTER LOGS;</span><br><span class="line"></span><br><span class="line">SHOW SLAVE STATUS;</span><br><span class="line">SHOW PROCESSLIST;</span><br><span class="line"></span><br><span class="line">SHOW BINLOG EVENTS;</span><br></pre></td></tr></table></figure>

<p>3.判断从服务器是否落后于主服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW SLAVE STATUS;</span><br><span class="line">然后查看这个字段</span><br><span class="line">Seconds_Behind_Master;0 #0就是不落后，非0就是落后</span><br></pre></td></tr></table></figure>



<h4 id="11-复制的问题和解决方案"><a href="#11-复制的问题和解决方案" class="headerlink" title="11.复制的问题和解决方案"></a>11.复制的问题和解决方案</h4><p>1.造成不一致的原因：</p>
<ul>
<li>主数据库binlog格式为Statement，同步到从库后可能造成主从不一致</li>
<li>主数据库更改前执行set sql_log_bin=0，会使主库不记录binlog，从库也无法变更这部分数据</li>
<li>从节点未设置只读，误操作写入数据</li>
<li>主库或从库以外宕机，可能会造成binlog或者relaylog文件出现损坏，导致主从不一致</li>
<li>主从实例版本不一致，特别是高版本是主，低版本是从，主数据库上面支持的功能，从数据库上面可能不支持该功能</li>
<li>mysql自身bug导致</li>
</ul>
<p>2.不一致的修复方法</p>
<ul>
<li>手动重建</li>
<li>使用perconna-toolkit工具辅助</li>
</ul>
<p>3.如何避免不一致</p>
<ul>
<li>主库binlog采用ROW模式  binlog_format=row</li>
<li>主从实例数据库版本保持一致</li>
<li>主库做好账号权限把控，不可以执行  set sql_log_bin=0</li>
<li>从库开启只读，不允许人为写入</li>
<li>定期进行一致性检验</li>
</ul>
<h3 id="MySQL中间件代理服务器"><a href="#MySQL中间件代理服务器" class="headerlink" title="MySQL中间件代理服务器"></a>MySQL中间件代理服务器</h3><h4 id="1-关系型数据库和非关系型数据库-NO-SQL-数据库"><a href="#1-关系型数据库和非关系型数据库-NO-SQL-数据库" class="headerlink" title="1.关系型数据库和非关系型数据库(NO SQL)数据库"></a>1.关系型数据库和非关系型数据库(NO SQL)数据库</h4><h4 id="2-数据切分"><a href="#2-数据切分" class="headerlink" title="2.数据切分"></a>2.数据切分</h4><ul>
<li>垂直切分：把不同的数据表分离开，这些表在业务中应当不使用join</li>
<li>水平切分：按照行进行切分，比如前1000行放入一个服务器，后1000行放入另一个服务器，以此降低单个服务器的负载</li>
</ul>
<p>需要使用分片管理服务器，也就是中间件。</p>
<h4 id="3-MySQL中间件各种应用"><a href="#3-MySQL中间件各种应用" class="headerlink" title="3.MySQL中间件各种应用"></a>3.MySQL中间件各种应用</h4><p>常用的两个中间件</p>
<ul>
<li>Mycat：国人二次开发，国内使用较多</li>
<li>proxySQL：外国软件</li>
</ul>
<h4 id="4-Mycat"><a href="#4-Mycat" class="headerlink" title="4.Mycat"></a>4.Mycat</h4><h5 id="Mycat的工作原理："><a href="#Mycat的工作原理：" class="headerlink" title="Mycat的工作原理："></a>Mycat的工作原理：</h5><p>​    搞清楚Mycat和mysql的区别。我们把上层看作是对下层的抽象，例如操作系统是对各类计算机硬件的抽象。那么我们什么时候需要抽象？假如只有一种硬件的时候，我们需要开发一个操作系统吗？再比如一个项目只需要一个人完成的时候需要leader吗？但是当一个项目十几个人的时候，就应该有一个管理者，发挥沟通协调作用，而这个管理者就是我们用户对于这个项目组所有人的抽象。</p>
<p>同样的，当我们的应用只需要一台数据库服务器的时候我们不需要中间件Mycat，而如果你需要分库甚至分表，应用要面对很多个数据库时，就需要对数据库进行一个抽象，来管理这些数据库，而最上面的应用只需要面对一个数据库的抽象或者说数据库中间件就好了，这就是Mycat的核心作用。</p>
<p>所以可以这样理解：数据库是对底层存储数据文件的抽象，而Mycat是对数据库的抽象。</p>
<h5 id="实验：通过Mycat中间件和mysql-5-7-30版本数据库实现读写分离"><a href="#实验：通过Mycat中间件和mysql-5-7-30版本数据库实现读写分离" class="headerlink" title="实验：通过Mycat中间件和mysql 5.7.30版本数据库实现读写分离"></a>实验：通过Mycat中间件和mysql 5.7.30版本数据库实现读写分离</h5><p>一共三台主机，一台mycat管理机，一台主服务器，一台从服务器，主从复制是用GTID实现的</p>
<p>1.在Mycat管理机上安装Java环境，记得要把内存调整大一些，比如2GB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install java -y</span><br><span class="line">java -version</span><br><span class="line">1.8</span><br></pre></td></tr></table></figure>

<p>2.安装Mycat，去官网下载，版本我下的是1.6.7.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;dl.mycat.org.cn&#x2F;1.6.7.5&#x2F;2020-4-10&#x2F;Mycat-server-1.6.7.5-release-20200410174409-linux.tar.gz</span><br><span class="line">mkdir &#x2F;app</span><br><span class="line">tar xvf Mycat-server-1.6.7.5-release-20200410174409-linux.tar.gz -C &#x2F;app</span><br><span class="line">cd &#x2F;app&#x2F;mycat</span><br><span class="line">[root@localhost mycat]$ls</span><br><span class="line">bin  catlet  conf  lib  logs  version.txt</span><br><span class="line">➜  mycat vim &#x2F;etc&#x2F;profile.d&#x2F;mycat.sh</span><br><span class="line">PATH&#x3D;&#x2F;app&#x2F;mycat&#x2F;bin&#x2F;:$PATH</span><br><span class="line">➜  mycat source &#x2F;etc&#x2F;profile.d&#x2F;mycat.sh </span><br></pre></td></tr></table></figure>

<p>3.配置两台服务器作为主从复制机器，并且开启通用日志，通用日志是一会为了检测读写分离</p>
<p>这里的配置很简单，主、从服务器都开启gtid和二进制日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_bin</span><br><span class="line">10 gtid_mode&#x3D;on</span><br><span class="line">11 enforce_gtid_consistency&#x3D;on</span><br><span class="line"></span><br><span class="line">开启通用日志在命令行用变量开启：</span><br><span class="line">set global general_log&#x3D;on;</span><br><span class="line">show variables like &#39;%general_log%&#39;;</span><br></pre></td></tr></table></figure>

<p>几个重要的配置文件</p>
<ul>
<li>server.xml：Mycat软件本身的相关配置</li>
<li>schema.xml：配置物理数据库，包括读写分离、高可用等</li>
<li>rule.xml：分库分表规则</li>
</ul>
<p>4.配置server.xml文件，之后在安装了Mycat的服务器上就可以使用这个账号密码登录了，登录方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pcentos -h 127.0.0.1 -P 8066</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">106     &lt;user name&#x3D;&quot;root&quot; defaultAccount&#x3D;&quot;true&quot;&gt;                                            </span><br><span class="line">107         &lt;property name&#x3D;&quot;password&quot;&gt;centos&lt;&#x2F;property&gt;#这里是登录mycat的密码，可以修改</span><br><span class="line">108         &lt;property name&#x3D;&quot;schemas&quot;&gt;t1,t2,t3&lt;&#x2F;property&gt;#这里是允许用户使用的数据库，名称和数量都是自己设置的，注意这里的数据库名称需要跟schema.xml中的数据库名称对应上</span><br><span class="line">109         &lt;property name&#x3D;&quot;defaultSchema&quot;&gt;t1&lt;&#x2F;property&gt;#默认数据库名</span><br><span class="line"></span><br><span class="line">123     &lt;user name&#x3D;&quot;user&quot;&gt;</span><br><span class="line">124         &lt;property name&#x3D;&quot;password&quot;&gt;user&lt;&#x2F;property&gt;</span><br><span class="line">125         &lt;property name&#x3D;&quot;schemas&quot;&gt;t1&lt;&#x2F;property&gt;#这里也要改</span><br><span class="line">126         &lt;property name&#x3D;&quot;readOnly&quot;&gt;true&lt;&#x2F;property&gt;</span><br><span class="line">127         &lt;property name&#x3D;&quot;defaultSchema&quot;&gt;t1&lt;&#x2F;property&gt;#这里也要改</span><br><span class="line">128     &lt;&#x2F;user&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.配置schema.xml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  1 &lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;                                      </span><br><span class="line">  2 &lt;mycat:schema xmlns:mycat&#x3D;&quot;http:&#x2F;&#x2F;io.mycat&#x2F;&quot;&gt;</span><br><span class="line">  3 &lt;schema name&#x3D;&quot;t1&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn1&quot;&gt;&lt;&#x2F;schema&gt; </span><br><span class="line">  4 &lt;schema name&#x3D;&quot;t2&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn2&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">  5 &lt;schema name&#x3D;&quot;t3&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn3&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">  ##schema的名称这里是什么，server.xml中也得写成什么，这个代表逻辑数据库，提供给用户使用，逻辑数据库会跟实际数据库中的数据库对应，通过dataNode标签，建立关系。</span><br><span class="line">  6 &lt;dataNode name&#x3D;&quot;dn1&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;hellodb&quot; &#x2F;&gt;</span><br><span class="line">  7 &lt;dataNode name&#x3D;&quot;dn2&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;mysql&quot; &#x2F;&gt;</span><br><span class="line">  8 &lt;dataNode name&#x3D;&quot;dn3&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;db1&quot; &#x2F;&gt;</span><br><span class="line">  ##datahost标签中，定义了具体的数据库实例、读写分离配置和心跳语句。</span><br><span class="line">  #dbDriver分两个：native和jdbc</span><br><span class="line">  9 &lt;dataHost name&#x3D;&quot;localhost1&quot; maxCon&#x3D;&quot;1000&quot; minCon&#x3D;&quot;10&quot; balance&#x3D;&quot;1&quot; writeType&#x3D;&quot;0&quot; dbType&#x3D;&quot;    mysql&quot; dbDriver&#x3D;&quot;jdbc&quot; switchType&#x3D;&quot;1&quot;  slaveThreshold&#x3D;&quot;100&quot;&gt;</span><br><span class="line"> 10 &lt;heartbeat&gt;select user()&lt;&#x2F;heartbeat&gt;</span><br><span class="line"> 11 &lt;writeHost host&#x3D;&quot;hostM1&quot; url&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;10.0.0.101:3306&quot; user&#x3D;&quot;mycat&quot; password&#x3D;&quot;12345    6&quot;&gt;</span><br><span class="line"> 12 &lt;readHost host&#x3D;&quot;hostS2&quot; url&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;10.0.0.110:3306&quot; user&#x3D;&quot;mycat&quot; password&#x3D;&quot;123456    &quot;&#x2F;&gt;</span><br><span class="line"> 13 &lt;&#x2F;writeHost&gt;</span><br><span class="line"> 14 &lt;&#x2F;dataHost&gt;</span><br><span class="line"> 15 &lt;&#x2F;mycat:schema&gt;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">&lt;dataHost&gt;这里有一个 dbDriver  字段，我这里默认是jdbc，所以下面的IP地址都要写成：</span><br><span class="line">jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;</span><br><span class="line">注意：</span><br><span class="line">&lt;schema name&#x3D;&quot;TESTDB&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn1&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">这里有个dataNode字段，我这里默认是RandomDataNode，需要改成dataNode</span><br></pre></td></tr></table></figure>

<p>6.开启mycat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mycat start</span><br><span class="line">#启动日志是这个：&#x2F;app&#x2F;mycat&#x2F;logs&#x2F;wrapper.log</span><br><span class="line">#运行日志是：&#x2F;app&#x2F;mycat&#x2F;logs&#x2F;mycat.log</span><br></pre></td></tr></table></figure>

<p>7.测试读写分离：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">持续监测主和从服务器的通用日志</span><br><span class="line">tail -f &#x2F;data&#x2F;mysql&#x2F;localhost.log #这个是通用日志</span><br><span class="line">连接到在mycat服务器上操作：</span><br><span class="line">mysql -uroot -pcentos -h127.0.0.1 -P 8066   #这里的用户名和密码都是在server.xml中设置的，必须指定 -h，因为mycat本身不带有sockt文件，-P 是指定连接端口，mycat模拟的数据库端口是8066</span><br><span class="line"></span><br><span class="line">查询数据库，发现mycat会把查询请求发送到从服务器；</span><br><span class="line">写入数据，发现mycat会把写入请求发送到主服务器；</span><br><span class="line">关闭从服务器，发现mycat读和写都会请求到主服务器，再次开启从服务器，发现读请求立刻发送到了从服务器；</span><br><span class="line">有30秒左右的等待时间</span><br><span class="line">关闭主服务器，发现mycat读可以发送到从服务器，但是写操作被拒绝</span><br><span class="line">MySQL [t1]&gt; insert into teachers values (7,&#39;mengzi&#39;,77,&#39;M&#39;);</span><br><span class="line">ERROR: No operations allowed after connection closed.</span><br><span class="line">再次开启主服务，等待30秒左右，写操作执行成功。</span><br></pre></td></tr></table></figure>



<p>操作步骤：</p>
<p>1.创建MySQL主从数据库</p>
<p>2.在MySQL代理服务器上安装mycat并启动</p>
<p>3.在mycat服务器上修改server.xml文件配置Mycat的连接信息</p>
<p>4.修改schema.xml实现读写分离</p>
<p>5.在Master数据库上创建用户并对mycat授权</p>
<p>6.在mycat上连接并测试</p>
<p>7.通过通用日志确认实现读写分离</p>
<p>8.停止从节点，mycat自动调度请求到主节点</p>
<h4 id="5-ProxySQL"><a href="#5-ProxySQL" class="headerlink" title="5.ProxySQL"></a>5.ProxySQL</h4><h3 id="MySQL高可用"><a href="#MySQL高可用" class="headerlink" title="MySQL高可用"></a>MySQL高可用</h3><h4 id="1-常用的MySQL高可用解决方案"><a href="#1-常用的MySQL高可用解决方案" class="headerlink" title="1.常用的MySQL高可用解决方案"></a>1.常用的MySQL高可用解决方案</h4><ul>
<li>MMM</li>
<li>MHA</li>
<li>Glara Cluster</li>
</ul>
<h4 id="2-MHA-Master-High-Availability"><a href="#2-MHA-Master-High-Availability" class="headerlink" title="2.MHA Master High Availability"></a>2.MHA Master High Availability</h4><h5 id="MHA的工作原理："><a href="#MHA的工作原理：" class="headerlink" title="MHA的工作原理："></a>MHA的工作原理：</h5><p>1.从宕机崩溃的master主机保存二进制日志事件（binlog events）</p>
<p>2.识别含有最新更新的slave</p>
<p>3.应用差异的中继日志（relay log）到其他的slave</p>
<p>4.应用从master保存的二进制日志事件</p>
<p>5.提升一个slave为新的master</p>
<p>6.使其他的slave连接新的master进行复制</p>
<p>7.注意，为了尽量减少主库宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL的半同步复制</p>
<h5 id="MHA软件"><a href="#MHA软件" class="headerlink" title="MHA软件"></a>MHA软件</h5><p>MHA软件由两部分组成，Manager工具包和Node工具包</p>
<h5 id="实验：使用MHA实现高可用"><a href="#实验：使用MHA实现高可用" class="headerlink" title="实验：使用MHA实现高可用"></a>实验：使用MHA实现高可用</h5><p>一共四台机器，一台是MHA的管理机，一台主服务器，两台从服务器</p>
<p>操作系统都是centos7，数据库使用mysql 5.7.30</p>
<p>MHA使用mha4mysql-manager-0.58-0.el7.centos.noarch.rpm和mha4mysql-node-0.58-0.el7.centos.noarch.rpm</p>
<p>1.在管理节点安装manager包和node包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mha4mysql-node-0.58-0.el7.centos.noarch.rpm </span><br><span class="line">yum -y install mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">注意先装node包，manager包依赖node包</span><br><span class="line">rpm -ql mha4mysql-node-0.58-0.el7.centos.noarch </span><br><span class="line">rpm -ql mha4mysql-manager-0.58-0.el7.centos.noarch</span><br></pre></td></tr></table></figure>

<p>2.在其他三台数据库服务器上安装node包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mha4mysql-node-0.58-0.el7.centos.noarch.rpm </span><br></pre></td></tr></table></figure>

<p>3.安装必要的工具，rsync,mailx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install rsync</span><br><span class="line">yum -y install mailx</span><br></pre></td></tr></table></figure>

<p>4.各个节点之间实现ssh key验证功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id 10.0.0.112#MHA管理节点自己的IP</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.101:&#x2F;root&#x2F;</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.7:&#x2F;root&#x2F;</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.110:&#x2F;root&#x2F;</span><br><span class="line">#这个操作的目的就是生成私钥，然后利用ssh-copy-id 把公钥也生成并拷贝给自己，同时，这样也生成了认证文件。这样的话，把这个生成好的.ssh文件夹拷贝给其他主机，那么所有有.ssh这个文件夹的主机之间就都可以实现ssh密钥认证了。</span><br></pre></td></tr></table></figure>

<p>5.实现master主机，基于GTID实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line">log_bin</span><br><span class="line">server-id&#x3D;xxx</span><br><span class="line">开启半同步复制</span><br><span class="line">plugin-load-add&#x3D;semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;on</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000</span><br><span class="line"></span><br><span class="line">新建复制账号和MHA管理账号</span><br><span class="line">CREATE USER &#39;repluser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line">CREATE USER &#39;mhauser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line"></span><br><span class="line">GRANT replication slave on *.* to &#39;repluser&#39;@&#39;10.0.0.%&#39;</span><br><span class="line">GRANT all on *.* to &#39;mhauser&#39;@&#39;10.0.0.%&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.实现slave主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line">plugin-load-add&#x3D;semisync_slave.so</span><br><span class="line">rpl_semi_sync_slave_enabled&#x3D;on</span><br><span class="line"></span><br><span class="line">change master to master_host&#x3D;&#39;10.0.0.112&#39;,</span><br><span class="line"> master_user&#x3D;&#39;repluser&#39;,</span><br><span class="line"> master_password&#x3D;&#39;centos&#39;,</span><br><span class="line"> master_auto_position;</span><br></pre></td></tr></table></figure>

<p>7.在管理节点建立配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">  1 [server default]</span><br><span class="line">  2 user&#x3D;mhauser</span><br><span class="line">  3 password&#x3D;centos</span><br><span class="line">  4 manager_workdir&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;</span><br><span class="line">  5 manager_log&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;manager.log</span><br><span class="line">  6 remote_workdir&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;</span><br><span class="line">  7 ssh_user&#x3D;root</span><br><span class="line">  8 repl_user&#x3D;repluser</span><br><span class="line">  9 repl_password&#x3D;centos</span><br><span class="line"> 10 ping_interval&#x3D;1</span><br><span class="line"> 11 master_ip_failover_script&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;master_ip_failover</span><br><span class="line"> 12 report_script&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;sendmail.sh</span><br><span class="line"> 13 check_repl_delay&#x3D;0</span><br><span class="line"> 14 master_binlog_dir&#x3D;&#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"> 15 </span><br><span class="line"> 16 [server1]</span><br><span class="line"> 17 hostname&#x3D;10.0.0.101</span><br><span class="line"> 18 candidate_master&#x3D;1</span><br><span class="line"> 19 </span><br><span class="line"> 20 [server2]</span><br><span class="line"> 21 hostname&#x3D;10.0.0.7                                                              </span><br><span class="line"> 22 candidate_master&#x3D;1</span><br><span class="line"> 23 </span><br><span class="line"> 24 [server3]</span><br><span class="line"> 25 hostname&#x3D;10.0.0.110</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Perl脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">这个脚本要放到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line">➜  bin cat master_ip_failover </span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env perl</span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL &#x3D;&gt; &#39;all&#39;;</span><br><span class="line">use Getopt::Long;</span><br><span class="line">my (</span><br><span class="line">$command, $ssh_user, $orig_master_host, $orig_master_ip,</span><br><span class="line">$orig_master_port, $new_master_host, $new_master_ip, $new_master_port</span><br><span class="line">);</span><br><span class="line">my $vip &#x3D; &#39;10.0.0.100&#39;;#设置Virtual IP</span><br><span class="line">my $gateway &#x3D; &#39;10.0.0.254&#39;;#网关Gateway IP</span><br><span class="line">my $interface &#x3D; &#39;eth0&#39;;</span><br><span class="line">my $key &#x3D; &quot;1&quot;;</span><br><span class="line">my $ssh_start_vip &#x3D; &quot;&#x2F;sbin&#x2F;ifconfig $interface:$key $vip;&#x2F;sbin&#x2F;arping -I $interface -c 3 -s $vip $gateway &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;;</span><br><span class="line">my $ssh_stop_vip &#x3D; &quot;&#x2F;sbin&#x2F;ifconfig $interface:$key down&quot;;</span><br><span class="line">GetOptions(</span><br><span class="line">&#39;command&#x3D;s&#39; &#x3D;&gt; \$command,</span><br><span class="line">&#39;ssh_user&#x3D;s&#39; &#x3D;&gt; \$ssh_user,</span><br><span class="line">&#39;orig_master_host&#x3D;s&#39; &#x3D;&gt; \$orig_master_host,</span><br><span class="line">&#39;orig_master_ip&#x3D;s&#39; &#x3D;&gt; \$orig_master_ip,</span><br><span class="line">&#39;orig_master_port&#x3D;i&#39; &#x3D;&gt; \$orig_master_port,</span><br><span class="line">&#39;new_master_host&#x3D;s&#39; &#x3D;&gt; \$new_master_host,</span><br><span class="line">&#39;new_master_ip&#x3D;s&#39; &#x3D;&gt; \$new_master_ip,</span><br><span class="line">&#39;new_master_port&#x3D;i&#39; &#x3D;&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line">exit &amp;main();</span><br><span class="line">sub main &#123;</span><br><span class="line">print &quot;\n\nIN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;$ssh_stop_vip&#x3D;&#x3D;$ssh_start_vip&#x3D;&#x3D;&#x3D;\n\n&quot;;</span><br><span class="line">if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span><br><span class="line"># If you manage master ip address at global catalog database,</span><br><span class="line"># invalidate orig_master_ip here.</span><br><span class="line">my $exit_code &#x3D; 1;</span><br><span class="line">eval &#123;</span><br><span class="line">print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">&amp;stop_vip();</span><br><span class="line">$exit_code &#x3D; 0;</span><br><span class="line">&#125;;</span><br><span class="line">if ($@) &#123;</span><br><span class="line">warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"># all arguments are passed.</span><br><span class="line"># If you manage master ip address at global catalog database,</span><br><span class="line"># activate new_master_ip here.</span><br><span class="line"># You can also grant write access (create user, set read_only&#x3D;0, etc) here.</span><br><span class="line">my $exit_code &#x3D; 10;</span><br><span class="line">eval &#123;</span><br><span class="line">print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">&amp;start_vip();</span><br><span class="line">$exit_code &#x3D; 0;</span><br><span class="line">&#125;;</span><br><span class="line">if ($@) &#123;</span><br><span class="line">warn $@;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">&#96;ssh $ssh_user\@$orig_master_host \&quot; $ssh_start_vip \&quot;&#96;;</span><br><span class="line">exit 0;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">&amp;usage();</span><br><span class="line">exit 1;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that enable the VIP on the new master</span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">&#96;ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;&#96;;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that disable the VIP on the old_master</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">&#96;ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;&#96;;</span><br><span class="line">&#125;</span><br><span class="line">sub usage &#123;</span><br><span class="line">print</span><br><span class="line">&quot;Usage: master_ip_failover --command&#x3D;start|stop|stopssh|status --orig_master_host&#x3D;host --orig_master_ip&#x3D;ip --orig_master_port&#x3D;port --new_master_host&#x3D;host --new_master_ip&#x3D;ip --new_master_port&#x3D;port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送邮件的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#这个脚本要放到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;下</span><br><span class="line">echo &quot;MySQL is down&quot; | mail -s &quot;MHA Warning&quot; 734709865@qq.com</span><br></pre></td></tr></table></figure>

<p>8.MHA环境检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_ssh --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">#根据提示修改不符合要求的设置</span><br><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">app1 is stopped(2:NOT_RUNNING).</span><br><span class="line">现在还没开MHA，所以这个是正常的</span><br></pre></td></tr></table></figure>

<p>9.启动MHA</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  nohub src &#x2F;usr&#x2F;bin&#x2F;masterha_manager --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">这个是前台启动的，程序运行时命令行不会变化</span><br><span class="line">另外开一个窗口观察当前MHA状态</span><br><span class="line">➜  ~ &#x2F;usr&#x2F;bin&#x2F;masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf </span><br><span class="line">app1 (pid:5767) is running(0:PING_OK), master:10.0.0.101</span><br><span class="line">启动成功</span><br></pre></td></tr></table></figure>

<p>10.查看日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;data&#x2F;mastermha&#x2F;manager.log</span><br></pre></td></tr></table></figure>

<p>11.模拟故障</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#MHA有个特点，当master主机down后，MHA开始工作，提拔一个从服务器为主服务器，之后MHA服务就停止了</span><br><span class="line">当故障发生后，我测试几乎5秒不到就切换好了新主机，MHA发送了邮件，然后停止了服务</span><br></pre></td></tr></table></figure>

<p>12.如果需要再次运行MHA，需要先删除下面的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  src ls &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete </span><br><span class="line">&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete</span><br><span class="line">➜  src rm -f &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete </span><br><span class="line">➜  src nohup &#x2F;usr&#x2F;bin&#x2F;masterha_manager --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">➜  bin tail -f &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;manager.log </span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;sbin&#x2F;ifconfig eth0:1 down&#x3D;&#x3D;&#x2F;sbin&#x2F;ifconfig eth0:1 10.0.0.100;&#x2F;sbin&#x2F;arping -I eth0 -c 3 -s 10.0.0.100 10.0.0.254 &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info]  OK.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Starting ping health check on 10.0.0.7(10.0.0.7:3306)..</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&#39;t respond..</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>1.在管理节点上安装两个包：manager包和node包</p>
<p>2.在所有mysql服务器上安装node包</p>
<p>3.在管理节点和所有从节点之间实现ssh key 验证</p>
<p>4.在管理节点建立配置文件</p>
<p>5.实现Master</p>
<p>6.实现Slave</p>
<p>7.检查MHA的环境</p>
<p>8.启动MHA</p>
<p>9.查看日志</p>
<p>10.故障检测</p>
<h4 id="3-Galera-Cluster"><a href="#3-Galera-Cluster" class="headerlink" title="3.Galera Cluster"></a>3.Galera Cluster</h4><p>多主的集群，通过全局校验的方式保证多个主服务器之间数据不冲突，同时多个主服务器的集群也解决了单个主服务器的单点失败问题。</p>
<p>节点最少3个，最多8个</p>
<p>限制最少节点是为了避免脑裂，最好使用奇数个数的节点。脑裂指的是双方数据不一致，而且双方服务器数量一致，无法判断应该听从谁的。</p>
<ul>
<li>Percona Xtradb Cluster</li>
<li>Mariadb Galera Cluster</li>
</ul>
<p>Galera Cluster好的特点：</p>
<ul>
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
<li>热拔插：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务时间就会非常少。在节点故障期间，节点本身对集群的影响非常小。</li>
<li>自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不需要人工手动备份提供，Galera Cluster会自动拉取在线节点数据，最终集群会变成一致</li>
<li>对应用透明：集群的维护，对应用程序是透明的</li>
</ul>
<p>Galera Cluster缺点：</p>
<ul>
<li>由于DDL需要全局验证通过，则集群性能有集群中最差的服务器决定（一般集群节点配置都是一样的）</li>
<li>新节点加入或延后较大的节点重新加入需要全量拷贝数据（SST State Snapshot Transfer），作为doner（贡献者：同步数据时提供数据的服务器）的节点在同步过程中无法提供读写</li>
<li>只支持Innodb存储引擎的表</li>
</ul>
<p>PXC的官方文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.percona.com&#x2F;doc&#x2F;percona-xtradb-cluster&#x2F;LATEST&#x2F;overview.html</span><br></pre></td></tr></table></figure>

<p>PXC实现步骤：</p>
<p>1.配置PXC的专用yum源</p>
<p>2.在每台节点上都安装PXC</p>
<p>3.在每个节点都修改PXC配置文件 /etc/percona-xtradb-cluster.conf.d/wsrep.conf</p>
<p>​    配置节点IP</p>
<p>​    节点本身的IP</p>
<p>​    集群节点名称</p>
<p>​    认证的账号密码</p>
<p>4.开启PXC，注意第一个节点与其他节点不一样</p>
<p>5.其他节点开启</p>
<h4 id="4-TiDB"><a href="#4-TiDB" class="headerlink" title="4.TiDB"></a>4.TiDB</h4><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="压力测试工具"><a href="#压力测试工具" class="headerlink" title="压力测试工具"></a>压力测试工具</h3><h3 id="生产环境my-cnf配置案例"><a href="#生产环境my-cnf配置案例" class="headerlink" title="生产环境my.cnf配置案例"></a>生产环境my.cnf配置案例</h3><h3 id="MySQL配置最佳实践"><a href="#MySQL配置最佳实践" class="headerlink" title="MySQL配置最佳实践"></a>MySQL配置最佳实践</h3><p>重点：</p>
<p>1.表DML ！！！</p>
<p>2.表DQL 单表和多表 ！！！</p>
<p>3.视图、函数、触发器、存储过程、事件 作为了解</p>
<p>4.用户账号的创建、删除、修改密码  ！</p>
<p>5.用户授权管理  ！</p>
<p>1.存储引擎的区别</p>
<p>2.索引</p>
<p>3.事务</p>
<p>4.备份</p>
<p>5.数据库的主从</p>
<p>1.备份工具的使用：mysqldump,xtrabackup,mariadbbackup</p>
<p>两个问题：</p>
<p>1.如何把多行命令写进去，或者说CHANGE MASTER TO 到底什么要求</p>
<p>2.写进去了为什么还是连接不上级联节点</p>
<p>要做的事情，</p>
<p>重新配置级联节点和从服务器，如果写不进去也先手写进去，先保证写进去了能连接</p>
<p>CHANGE MASTER TO  MASTER_HOST=’source2.example.com’,  MASTER_USER=’replication’,  MASTER_PASSWORD=’<em>password</em>‘,  MASTER_PORT=3306,  MASTER_LOG_FILE=’source2-bin.001’,  MASTER_LOG_POS=4,  MASTER_CONNECT_RETRY=10;</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/09/hexo%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huihui">
      <meta itemprop="description" content="学习和看笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辉辉的数据库">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/09/hexo%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">hexo的环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-09 08:48:10" itemprop="dateCreated datePublished" datetime="2020-11-09T08:48:10+08:00">2020-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-18 21:07:36" itemprop="dateModified" datetime="2020-11-18T21:07:36+08:00">2020-11-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>1.安装nodejs：</p>
<p>​    下载慢的解决方法：在这里下载，速度很快</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nodejs.cn&#x2F;download&#x2F;</span><br></pre></td></tr></table></figure>

<p>2.修改npm的源为淘宝源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry https:&#x2F;&#x2F;registry.npm.taobao.org</span><br><span class="line">npm info express</span><br></pre></td></tr></table></figure>

<p>3.安装git，去淘宝镜像网找一个git的Windows客户端，然后下载安装配置</p>
<p>4.找一个目录，进入里面，然后右键，打开git bash</p>
<p>5.使用npm安装hexo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;jinmie0193&#x2F;article&#x2F;details&#x2F;81589661</span><br></pre></td></tr></table></figure>

<p>5.按照下面的方法，使用gitee而不是git去安装hexo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;weilining.cf&#x2F;5.html</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry http:&#x2F;&#x2F;registry.npm.taobao.org</span><br><span class="line">npm install hexo-cli@latest -g</span><br><span class="line">git clone --depth 1 https:&#x2F;&#x2F;gitee.com&#x2F;weilining&#x2F;hexo-starter.git blog</span><br><span class="line">cd blog</span><br><span class="line">## git submodule init</span><br><span class="line">## git submodule update</span><br><span class="line">git clone --depth 1 https:&#x2F;&#x2F;gitee.com&#x2F;weilining&#x2F;hexo-theme-landscape.git themes&#x2F;landscape</span><br><span class="line">npm i</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p>6.开始准备部署到github上</p>
<p>7.记得如果推送上去的hexo分支是master的话，在项目–&gt;settings里面把主页设置成master的，否则看不到页面</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">huihui</p>
  <div class="site-description" itemprop="description">学习和看笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">huihui</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
