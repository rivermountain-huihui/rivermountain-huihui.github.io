<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>辉辉的数据库</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="学习和看笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="辉辉的数据库">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="辉辉的数据库">
<meta property="og:description" content="学习和看笔记">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="huihui">
<meta property="article:tag" content="notes">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="辉辉的数据库" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">辉辉的数据库</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">我们要丈量大地！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-运维自动化部署" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.268Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="运维自动化之系统部署"><a href="#运维自动化之系统部署" class="headerlink" title="运维自动化之系统部署"></a>运维自动化之系统部署</h2><h3 id="linux的安装过程"><a href="#linux的安装过程" class="headerlink" title="linux的安装过程"></a>linux的安装过程</h3><ul>
<li>加载boot loader –&gt;主板上的软件</li>
<li>加载启动安装菜单–&gt;isolinux/isolinux.cfg</li>
<li>加载内核和initrd文件–&gt; vmlinux 和 initrd.img</li>
<li>加载根系统</li>
<li>运行anaconda的安装向导</li>
</ul>
<h3 id="kickstart文件介绍"><a href="#kickstart文件介绍" class="headerlink" title="kickstart文件介绍"></a>kickstart文件介绍</h3><p>直接用anaconda.cfg文件</p>
<p>官方文档推荐的方法就是先手动安装一遍，等安装好了，把生成的anaconda.cfg文件直接拿来用就行，顶多把里面的一些内容进行修改。</p>
<h3 id="1-DHCP服务"><a href="#1-DHCP服务" class="headerlink" title="1.DHCP服务"></a>1.DHCP服务</h3><h4 id="1-DHCP服务介绍"><a href="#1-DHCP服务介绍" class="headerlink" title="1.DHCP服务介绍"></a>1.DHCP服务介绍</h4><p>Dynamic Host Configuration Protocol</p>
<p>udp协议，C/S模式，服务端需要配置，客户端不需要配置</p>
<p>dhcp server 67/udp     dhcp client 68/udp</p>
<h4 id="2-DHCP的报文"><a href="#2-DHCP的报文" class="headerlink" title="2.DHCP的报文"></a>2.DHCP的报文</h4><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200910092219381.png" alt="image-20200910092219381"></p>
<p>DHCP DISCOVER </p>
<p>DHCP OFFER</p>
<p>DHCP REQUEST</p>
<p>DHCP ACK</p>
<p>DHCP NAK</p>
<p>DHCP NAK</p>
<p>DHCP DECLINE</p>
<p>DHCP RELEASE</p>
<p>DHCP INFORM</p>
<p><strong>DHCP服务续租：</strong></p>
<ul>
<li>50%：租赁期到达50%时前来续租</li>
<li>87.5%：如果50%时没有续租成功，在87.5%时再次广播一次续租</li>
</ul>
<p>同网段多个DHCP服务：</p>
<ul>
<li>几个DHCP服务器必须要分配好，谁分配的IP是什么范围，不要打架了</li>
<li>DHCP服务必须基于本地</li>
<li>DHCP先到先得</li>
</ul>
<p>跨网段：</p>
<ul>
<li>因为DHCP客户机本身是发送广播来获取ip地址的，所以无法跨越网段，跨网段需要路由器，路由器会隔绝广播。此时可以让路由器在端口上做中继代理，广播被发送到路由器的端口，这个端口是个代理，它通过单播通讯的方式跨网段发送到另一个DHCP服务器上</li>
<li>DHCP服务器本地网段优先，因为它可以分辨广播和单播，广播是本网段内的，分配本网段的地址；单播是其他网段的，分配其他网段地址</li>
</ul>
<h4 id="DHCP的实现："><a href="#DHCP的实现：" class="headerlink" title="DHCP的实现："></a>DHCP的实现：</h4><p>需要先将网络中已有的DHCP服务关闭</p>
<p>DHCP只需要服务器端配置，客户端不需要配置，它是广播的</p>
<p>dhcp包或dhcp-server包</p>
<p>配置这个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;dhcp&#x2F;dhcpd.conf</span><br><span class="line">注意这个文件是没内容的，只有个提示，告诉你有个例子文件在哪，把那个例子文件拷贝过来，改成这个配置文件的名字，然后改</span><br></pre></td></tr></table></figure>

<p>一般改这几个地方，其他的就注释掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">option domain-name &quot;lv.org&quot;;   dhcp服务器名</span><br><span class="line">option domain-name-servers 180.76.76.76, 223.5.5.5;		dns地址</span><br><span class="line">default-lease-time 86400;		默认的租期时间，调大一点，避免总有广播要地址</span><br><span class="line">max-lease-time 160000; 			最大租期时间，更大一点</span><br><span class="line">log-facility local7;			不知道，跟日志有关</span><br><span class="line">subnet 10.0.0.0 netmask 255.255.255.0 &#123;   第一行是网段和掩码</span><br><span class="line">    range 10.0.0.101 10.0.0.200;			这一行是分配网络的范围</span><br><span class="line">    option routers 10.0.0.1;				默认的网关</span><br><span class="line">    next-server 10.0.0.4;					这个是指向TFTP服务器的地址</span><br><span class="line">    filename &quot;pxelinux.0&quot;;					TFTP服务器上文件的名字</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dhcp还有一个地方记录了分配出去的IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;lib&#x2F;dhcpd&#x2F;dhcpd.leases</span><br></pre></td></tr></table></figure>



<h3 id="2-TFTP服务"><a href="#2-TFTP服务" class="headerlink" title="2.TFTP服务"></a>2.TFTP服务</h3><h4 id="1-TFTP服务介绍："><a href="#1-TFTP服务介绍：" class="headerlink" title="1.TFTP服务介绍："></a>1.TFTP服务介绍：</h4><p>Trivial File Transfer Protocol ，是一种用于传输文件的简单高级协议，是文件传输协议（FTP）的简化版本。使用UDP端口 69/UDP，基于C/S架构，基本不需要配置</p>
<h4 id="2-TFTP和FTP的比较"><a href="#2-TFTP和FTP的比较" class="headerlink" title="2.TFTP和FTP的比较"></a>2.TFTP和FTP的比较</h4><ul>
<li>它功能少，但体积小</li>
<li>FTP支持安全登录，TFTP没有安全可言，没有加密</li>
<li>FTP是TCP协议，TFTP是使用UDP协议</li>
<li>TFTP可以执行的命令很少</li>
</ul>
<h4 id="3-TFTP的实现"><a href="#3-TFTP的实现" class="headerlink" title="3.TFTP的实现"></a>3.TFTP的实现</h4><p>安装包：</p>
<ul>
<li>tftp-server    服务器包</li>
<li>tftp                 客户端包</li>
</ul>
<p>服务器端和客户端分别安装上这两个包就行了，记住这个文件位置，这个是服务端存放tftp数据的位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;lib&#x2F;tftpboot&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="3-HTTP服务"><a href="#3-HTTP服务" class="headerlink" title="3.HTTP服务"></a>3.HTTP服务</h3><p>包：httpd，配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">这里可以设置端口、文件存放位置等</span><br></pre></td></tr></table></figure>

<p>安装上就行，设置启动，网页文件放置的位置在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br></pre></td></tr></table></figure>

<p>把想要展示的东西在这个目录下就行了</p>
<h3 id="4-PXE实现自动化安装系统"><a href="#4-PXE实现自动化安装系统" class="headerlink" title="4.PXE实现自动化安装系统"></a>4.PXE实现自动化安装系统</h3><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200910171108609.png" alt="image-20200910171108609"></p>
<p>需要怎么做：</p>
<p>1.清楚需要的文件都是什么</p>
<ul>
<li>服务：<ul>
<li>DHCP</li>
<li>TFTP</li>
<li>HTTP</li>
</ul>
</li>
<li>软件：<ul>
<li>syslinux</li>
<li>system-config-kickstart</li>
<li>tftp</li>
<li>xhosts</li>
</ul>
</li>
<li>具体文件：<ul>
<li>bootloader–&gt;pxelinux.0</li>
<li>内核文件、挂载文件</li>
<li>应答文件</li>
<li>软件源</li>
<li>菜单文件</li>
</ul>
</li>
<li>需要我们自己写的文件<ul>
<li>应答文件，每个操作系统一份</li>
<li>菜单文件，总共一份就行</li>
<li>DHCP需要的配置文件</li>
</ul>
</li>
</ul>
<p>2.准备文件</p>
<ul>
<li>服务就直接下载安装启动</li>
<li>软件源就从光盘里面拿来用，PXE方式里就把光盘挂载到http文件下</li>
<li>应答文件用system-config-kickstart生成或者用anaconda改改用</li>
<li>pxelinux.0等文件是syslinux软件里提供的，下载下来拷贝过来用</li>
<li>菜单文件也是从光盘里拷贝来的，菜单配置文件是拿过来改改用</li>
</ul>
<p>3.实践</p>
<p>其他步骤不写了，照抄老王的，我把所有的配置文件拿过来</p>
<p>10.0.0.4：所有服务都在这个机子上</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200910172948957.png" alt="image-20200910172948957"></p>
<p>应答文件：</p>
<p>centos6</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ks]#grep -v &quot;^#&quot; centos6.cfg |grep -v &quot;^$&quot;</span><br><span class="line">install</span><br><span class="line">keyboard &#39;us&#39;</span><br><span class="line">rootpw --iscrypted $1$ZiykknD.$tW6lOicL&#x2F;4NPuaaGNkoDt.</span><br><span class="line">lang en_US</span><br><span class="line">auth  --useshadow  --passalgo&#x3D;sha512</span><br><span class="line">text</span><br><span class="line">selinux --disabled</span><br><span class="line">skipx</span><br><span class="line">reboot</span><br><span class="line">firewall --disabled</span><br><span class="line">network  --bootproto&#x3D;dhcp --device&#x3D;eth0</span><br><span class="line">timezone Asia&#x2F;Shanghai</span><br><span class="line">url --url&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;6&#x2F;os&#x2F;x86_64&#x2F;</span><br><span class="line">bootloader --append&#x3D;&quot;net.ifnames&#x3D;0&quot; --location&#x3D;mbr</span><br><span class="line">zerombr</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part &#x2F;boot --fstype&#x3D;&quot;ext4&quot; --size&#x3D;1024</span><br><span class="line">part swap --fstype&#x3D;&quot;swap&quot; --size&#x3D;2048</span><br><span class="line">part &#x2F; --fstype&#x3D;&quot;ext4&quot; --grow --size&#x3D;1</span><br><span class="line">%packages</span><br><span class="line">@core</span><br><span class="line">@server-policy</span><br><span class="line">@workstation-policy</span><br><span class="line">autofs</span><br><span class="line">vim-enhanced</span><br><span class="line">%end</span><br><span class="line">%post</span><br><span class="line">useradd lv</span><br><span class="line">echo centos | passwd --stdin lv &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">mkdir &#x2F;etc&#x2F;yum.repos.d&#x2F;bak</span><br><span class="line">mv &#x2F;etc&#x2F;yum.repos.d&#x2F;*.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;bak</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;yum.repos.d&#x2F;base.repo&lt;&lt;EOF</span><br><span class="line">[base]</span><br><span class="line">name&#x3D;base</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;6&#x2F;os&#x2F;x86_64&#x2F;</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">EOF</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>centos7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ks]#grep -v &quot;^#&quot; centos7.cfg |grep -v &quot;^$&quot;</span><br><span class="line">install</span><br><span class="line">keyboard &#39;us&#39;</span><br><span class="line">rootpw --iscrypted $1$MepAKGn3$Rk625iNXWxhRlzstqgw&#x2F;O&#x2F;</span><br><span class="line">lang en_US</span><br><span class="line">auth  --useshadow  --passalgo&#x3D;sha512</span><br><span class="line">text</span><br><span class="line">selinux --disabled</span><br><span class="line">skipx</span><br><span class="line">firewall --disabled</span><br><span class="line">network  --bootproto&#x3D;dhcp --device&#x3D;eth0</span><br><span class="line">reboot</span><br><span class="line">timezone Asia&#x2F;Shanghai</span><br><span class="line">url --url&#x3D;&quot;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;7&#x2F;os&#x2F;x86_64&#x2F;&quot;</span><br><span class="line">bootloader --append&#x3D;&quot;net.ifnames&#x3D;0&quot; --location&#x3D;mbr</span><br><span class="line">zerombr</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part &#x2F;boot --fstype&#x3D;&quot;ext4&quot; --size&#x3D;1024</span><br><span class="line">part swap --fstype&#x3D;&quot;swap&quot; --size&#x3D;2048</span><br><span class="line">part &#x2F; --fstype&#x3D;&quot;xfs&quot; --grow --size&#x3D;1</span><br><span class="line">%post</span><br><span class="line">useradd lv</span><br><span class="line">echo centos | passwd --stdin lv &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">mkdir &#x2F;etc&#x2F;yum.repos.d&#x2F;bak</span><br><span class="line">mv &#x2F;etc&#x2F;yum.repos.d&#x2F;*.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;bak</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;yum.repos.d&#x2F;base.repo&lt;&lt;EOF</span><br><span class="line">[base]</span><br><span class="line">name&#x3D;base</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;7&#x2F;os&#x2F;x86_64&#x2F;</span><br><span class="line">gpgcheck&#x3D;0                                                               </span><br><span class="line">EOF</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>centos8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ks]#grep -v &quot;^#&quot; centos8.cfg |grep -v &quot;^$&quot;</span><br><span class="line">ignoredisk --only-use&#x3D;sda</span><br><span class="line">clearpart --none --initlabel</span><br><span class="line">text</span><br><span class="line">keyboard --vckeymap&#x3D;us --xlayouts&#x3D;&#39;us&#39;</span><br><span class="line">lang en_US.UTF-8</span><br><span class="line">zerombr</span><br><span class="line">reboot</span><br><span class="line">network  --bootproto&#x3D;dhcp --device&#x3D;eth0 --ipv6&#x3D;auto --activate</span><br><span class="line">bootloader --append&#x3D;&quot;net.ifnames&#x3D;0&quot; --location&#x3D;mbr --boot-drive&#x3D;sda</span><br><span class="line">network --hostname&#x3D;centos8</span><br><span class="line">rootpw --iscrypted $6$.WXGx4DTb1S9eC9H$XBOWkiKR7bHJ2XEgzKnI5NR&#x2F;002iYL6gSDSKrpbLgaAxX77V0kox3hJsrGoHhTLPyzCNoBnLQ.v9apn6m2yMK.</span><br><span class="line">firstboot --enable</span><br><span class="line">skipx</span><br><span class="line">selinux --disabled</span><br><span class="line">firewall --disabled</span><br><span class="line">services --disabled&#x3D;&quot;chronyd&quot;</span><br><span class="line">url --url&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;8&#x2F;os&#x2F;x86_64&#x2F;</span><br><span class="line">timezone Asia&#x2F;Shanghai --isUtc</span><br><span class="line">user --name&#x3D;lv --password&#x3D;$6$jtOFntaGtXL.oyyf$pxKmhpL8xdKNtYOaykosBuEyGRgVyMKZHtlsqf8mdz1EeD4DagMeINPnpZwXobRdAlR3DPOM0rfigXv94nMzx0 --iscrypted --gecos&#x3D;&quot;lv&quot;</span><br><span class="line">part &#x2F;data --fstype&#x3D;&quot;xfs&quot; --ondisk&#x3D;sda --size&#x3D;51200</span><br><span class="line">part &#x2F;boot --fstype&#x3D;&quot;ext4&quot; --ondisk&#x3D;sda --size&#x3D;1024</span><br><span class="line">part &#x2F; --fstype&#x3D;&quot;xfs&quot; --ondisk&#x3D;sda --size&#x3D;102400</span><br><span class="line">part swap --fstype&#x3D;&quot;swap&quot; --ondisk&#x3D;sda --size&#x3D;2048</span><br><span class="line">%packages</span><br><span class="line">@^minimal-environment</span><br><span class="line">kexec-tools</span><br><span class="line">%end</span><br><span class="line">%addon com_redhat_kdump --enable --reserve-mb&#x3D;&#39;auto&#39;</span><br><span class="line">%end</span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen&#x3D;6 --minquality&#x3D;1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>DHCP配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ks]#grep -vE &quot;^#|^$&quot; &#x2F;etc&#x2F;dhcp&#x2F;dhcpd.conf </span><br><span class="line">option domain-name &quot;lv.org&quot;;</span><br><span class="line">option domain-name-servers 180.76.76.76, 223.5.5.5;</span><br><span class="line">default-lease-time 86400;</span><br><span class="line">max-lease-time 160000;</span><br><span class="line">log-facility local7;</span><br><span class="line">subnet 10.0.0.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    range 10.0.0.101 10.0.0.200;</span><br><span class="line">    option routers 10.0.0.1;</span><br><span class="line">    next-server 10.0.0.4;</span><br><span class="line">    filename &quot;pxelinux.0&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tftp的文件夹内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#pwd</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;tftpboot</span><br><span class="line">[root@centos7 tftpboot]#tree</span><br><span class="line">.</span><br><span class="line">├── centos6</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── centos7</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── centos8</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── ldlinux.c32 # centos8特别要的三个文件</span><br><span class="line">├── libcom32.c32 #</span><br><span class="line">├── libutil.c32 #</span><br><span class="line">├── menu.c32 # 启动菜单的格式，这个代表文本格式</span><br><span class="line">├── pxelinux.0</span><br><span class="line">└── pxelinux.cfg</span><br><span class="line">    └── default #菜单配置文件</span><br><span class="line"></span><br><span class="line">4 directories, 12 files</span><br></pre></td></tr></table></figure>

<p>菜单配置文件 pxelinux.cfg/default   它是从光盘的 isolinux/isolinux.cfg 改了改生成的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 html]#cat &#x2F;var&#x2F;lib&#x2F;tftpboot&#x2F;pxelinux.cfg&#x2F;default</span><br><span class="line">default menu.c32</span><br><span class="line">timeout 600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">menu title Install CentOS Linux </span><br><span class="line"></span><br><span class="line">label linux6</span><br><span class="line">  menu label Auto Install CentOS Linux ^6</span><br><span class="line">  kernel centos6&#x2F;vmlinuz</span><br><span class="line">  append initrd&#x3D;centos6&#x2F;initrd.img ks&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;ks&#x2F;centos6.cfg </span><br><span class="line"></span><br><span class="line">label linux7</span><br><span class="line">  menu label Auto Install CentOS Linux ^7</span><br><span class="line">  kernel centos7&#x2F;vmlinuz</span><br><span class="line">  append initrd&#x3D;centos7&#x2F;initrd.img ks&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;ks&#x2F;centos7.cfg </span><br><span class="line"></span><br><span class="line">label linux8</span><br><span class="line">  menu label Auto Install CentOS Linux ^8</span><br><span class="line">  kernel centos8&#x2F;vmlinuz</span><br><span class="line">  append initrd&#x3D;centos8&#x2F;initrd.img ks&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;ks&#x2F;centos8.cfg </span><br><span class="line"></span><br><span class="line">label manual </span><br><span class="line">  menu label ^Manual Install CentOS Linux 8</span><br><span class="line">  kernel centos8&#x2F;vmlinuz</span><br><span class="line">  append initrd&#x3D;centos8&#x2F;initrd.img inst.repo&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;8&#x2F;os&#x2F;x86_64&#x2F;</span><br><span class="line"></span><br><span class="line">label rescue</span><br><span class="line">  menu label ^Rescue a CentOS Linux system 8</span><br><span class="line">  text help</span><br><span class="line">	If the system will not boot, this lets you access files</span><br><span class="line">	and edit config files to try to get it booting again.</span><br><span class="line">  endtext</span><br><span class="line">  kernel centos8&#x2F;vmlinuz</span><br><span class="line">  append initrd&#x3D;centos8&#x2F;initrd.img inst.repo&#x3D;http:&#x2F;&#x2F;10.0.0.4&#x2F;centos&#x2F;8&#x2F;os&#x2F;x86_64&#x2F; rescue</span><br><span class="line"></span><br><span class="line">label local</span><br><span class="line">  menu default</span><br><span class="line">  menu label Boot from ^local drive</span><br><span class="line">  localboot 0xffff</span><br></pre></td></tr></table></figure>

<p>完成制作，去安装一台验证</p>
<h3 id="5-利用cobbler实现自动化安装"><a href="#5-利用cobbler实现自动化安装" class="headerlink" title="5.利用cobbler实现自动化安装"></a>5.利用cobbler实现自动化安装</h3><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200912102632113.png" alt="image-20200912102632113"></p>
<h4 id="5-1-cobbler的操作流程"><a href="#5-1-cobbler的操作流程" class="headerlink" title="5.1 cobbler的操作流程"></a><strong>5.1 cobbler的操作流程</strong></h4><ul>
<li>client裸机配置了从网络启动后，开机后会广播包请求DHCP服务器（cobbler server）发送其配好的IP</li>
<li>DHCP收到请求后发送response，包括其IP地址</li>
<li>client裸机拿到地址后再向cobbler server发送请求OS引导文件的请求</li>
<li>cobbler server告诉裸机OS引导文件的名字和TFTP server的IP和PORT</li>
<li>client裸机通过上面告知的TFTP server 地址通讯，下载引导文件</li>
<li>client裸机执行该引导文件，确定加载信息，选择要安装的OS，期间会向cobbler server请求kickstart文件和os image</li>
<li>cobbler server发送kickstart和os image</li>
<li>client裸机加载kickstart文件</li>
<li>client裸机接收os image，安装该os image</li>
</ul>
<h4 id="5-2-实现步骤"><a href="#5-2-实现步骤" class="headerlink" title="5.2 实现步骤"></a><strong>5.2 实现步骤</strong></h4><ul>
<li>软件包安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#yum -y install cobbler cobbler-web pykickstart</span><br></pre></td></tr></table></figure>

<ul>
<li>服务启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#systemctl enable --now cobblerd.service </span><br><span class="line">Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;cobblerd.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;cobblerd.service.</span><br></pre></td></tr></table></figure>

<ul>
<li>配置检查</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The &#39;server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &#39;next_server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : change &#39;disable&#39; to &#39;no&#39; in &#x2F;etc&#x2F;xinetd.d&#x2F;tftp</span><br><span class="line">4 : Some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run &#39;cobbler get-loaders&#39; to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &#39;cobbler get-loaders&#39; command is the easiest way to resolve these requirements.</span><br><span class="line">5 : enable and start rsyncd.service with systemctl</span><br><span class="line">6 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings) is still set to &#39;cobbler&#39; and should be changed, try: &quot;openssl passwd -1 -salt &#39;random-phrase-here&#39; &#39;your-password-here&#39;&quot; to generate new one</span><br><span class="line">8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &#39;cobbler sync&#39; to apply changes.</span><br></pre></td></tr></table></figure>

<ul>
<li>逐项修改</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#vim &#x2F;etc&#x2F;cobbler&#x2F;settings</span><br><span class="line">修改：</span><br><span class="line">server:10.0.0.4</span><br><span class="line">next_server:10.0.0.4</span><br><span class="line">[root@centos7 tftpboot]#vim &#x2F;etc&#x2F;xinetd.d&#x2F;tftp</span><br><span class="line">修改：</span><br><span class="line">disable         &#x3D; no</span><br><span class="line">[root@centos7 tftpboot]#cobbler get-loaders</span><br><span class="line">其他选项不需要变动就可以</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置选项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#vim &#x2F;etc&#x2F;cobbler&#x2F;settings</span><br><span class="line">manage_dhcp: 1</span><br><span class="line">manage_tftpd: 1</span><br><span class="line">pxe_just_once: 1</span><br></pre></td></tr></table></figure>

<ul>
<li>将linux发行版导入cobbler下的http服务文件夹下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 tftpboot]#cobbler import --name&#x3D;centos7 --path&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;centos7&#x2F;os&#x2F;x86_64&#x2F; --arch&#x3D;x86_64</span><br><span class="line">三个版本都导入一遍</span><br><span class="line">然后重启</span><br><span class="line">systemctl restart cobblerd.service</span><br><span class="line">注意要配置dhcp服务时，要配置cobbler提供的模板文件</span><br></pre></td></tr></table></figure>

<ul>
<li>将提前写好的ks文件放入/var/lib/cobbler/kickstarts文件夹下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 kickstarts]#cp &#x2F;var&#x2F;www&#x2F;html&#x2F;ks&#x2F;* .</span><br></pre></td></tr></table></figure>

<ul>
<li>将linux发行版镜像和对应的ks文件建立关联</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 kickstarts]#cobbler profile add --name&#x3D;centos7 --distro&#x3D;centos7-x86_64 --kickstart&#x3D;&#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;kickstarts&#x2F;ks7.cfg</span><br><span class="line">三个版本都导入一遍</span><br><span class="line">systemctl restart cobblerd.service</span><br><span class="line">cobbler sync</span><br></pre></td></tr></table></figure>

<ul>
<li>OK，去安装吧</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" data-id="ckhnf9hek000640ut6h06apwp" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-源码编译MYSQL8.0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91MYSQL8.0/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.264Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="源码编译MYSQL8-0"><a href="#源码编译MYSQL8-0" class="headerlink" title="源码编译MYSQL8.0"></a>源码编译MYSQL8.0</h1><p>1.环境准备</p>
<ul>
<li>依赖软件下载安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">cmake</span><br><span class="line">ssl</span><br><span class="line">c++ libraries</span><br><span class="line">ncurses libraries</span><br><span class="line">大点内存</span><br><span class="line">perl</span><br><span class="line">tar</span><br><span class="line"></span><br><span class="line">yum -y install bison bison-devel  zlib-devel libcurl-devel libarchive-devel  boost-devel  gcc  gcc-c++  cmake ncurses-devel gnutls-devel libxml2-devel openssl-devel libevent-devel libaio-devel</span><br><span class="line">yum install -y gcc-c++</span><br><span class="line">yum install -y libtirpc-devel</span><br><span class="line">yum -y install cmake3 #centos7需要使用cmake3</span><br></pre></td></tr></table></figure>

<ul>
<li>所需账户、文件目录准备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#groupadd mysql</span><br><span class="line">[root@localhost local]#useradd -r -g mysql -s &#x2F;bin&#x2F;false mysql</span><br><span class="line">[root@localhost local]#mkdir -p &#x2F;data&#x2F;mysql</span><br><span class="line">[root@localhost local]#chown -R mysql.mysql &#x2F;data&#x2F;mysql</span><br></pre></td></tr></table></figure>

<p>2.源码下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql官网，找SOURCE CODE,找一个版本下载</span><br></pre></td></tr></table></figure>

<p>3.解压源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#tar xf mysql-8.0.20.tar.gz</span><br><span class="line">[root@localhost local]#ln -s mysql-8.0.20 mysql</span><br><span class="line">[root@localhost local]#chown -R mysql.mysql mysql&#x2F;</span><br><span class="line">#centos8需要这个软件，需要手动编译安装</span><br><span class="line">[root@localhost &#x2F;usr&#x2F;local&#x2F;src]# wget https:&#x2F;&#x2F;github.com&#x2F;thkukuk&#x2F;rpcsvc-proto&#x2F;releases&#x2F;download&#x2F;v1.4&#x2F;rpcsvc-proto-1.4.tar.gz</span><br><span class="line">[root@localhost &#x2F;usr&#x2F;local&#x2F;src]# tar -zxvf rpcsvc-proto-1.4.tar.gz</span><br><span class="line">[root@localhost &#x2F;usr&#x2F;local&#x2F;src]# cd rpcsvc-proto-1.4&#x2F; &amp;&amp; .&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>4.开始编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdri bld #不允许在原目录编译</span><br><span class="line">cd bld</span><br><span class="line">cmake .. -DCMAKE_INSTALL_PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql -DMYSQL_DATADIR&#x3D;&#x2F;data&#x2F;mysql -DSYSCONFDIR&#x3D;&#x2F;etc -DMYSQL_USER&#x3D;mysql -DWITH_MYISAM_STORAGE_ENGINE&#x3D;1 -DWITH_INNOBASE_STORAGE_ENGINE&#x3D;1 -DMYSQL_UNIX_ADDR&#x3D;&#x2F;tmp&#x2F;mysql.sock -DMYSQL_TCP_PORT&#x3D;3306 -DEXTRA_CHARSETS&#x3D;all -DDEFAULT_CHARSET&#x3D;utf8mb4 -DDEFAULT_COLLATION&#x3D;utf8mb4_general_ci -DWITH_DEBUG&#x3D;0 -DMYSQL_MAINTAINER_MODE&#x3D;0 -DWITH_SYSTEMD&#x3D;1  -DDOWNLOAD_BOOST&#x3D;1 -DWITH_BOOST&#x3D;&#x2F;data&#x2F;</span><br><span class="line"></span><br><span class="line">make -j 8 &amp;&amp; make install #记得内存调大，cpu多给几个</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.准备配置文件，准备环境变量，生成数据库文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 bin]#ln -s &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">[root@centos8 mysql]#vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysqld.log</span><br><span class="line">pid-file&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.pid</span><br><span class="line">[root@centos8 mysql]#mysqld --initialize --user&#x3D;mysql --basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F; --datadir&#x3D;&#x2F;data&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure>

<p>7.启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files</span><br><span class="line">[root@centos8 support-files]#cp mysql.server &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;mysqld</span><br><span class="line">[root@centos8 support-files]#chkconfig --add mysqld</span><br><span class="line">[root@centos8 support-files]#service mysqld start</span><br><span class="line">Starting MySQL.Logging to &#39;&#x2F;data&#x2F;mysql&#x2F;mysqld.log&#39;.</span><br><span class="line">.. SUCCESS! </span><br></pre></td></tr></table></figure>

<p>8.密码修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 support-files]#mysqladmin -uroot -p&quot;sGje4gj)Z&#x2F;oi&quot; password &#39;centos&#39;</span><br></pre></td></tr></table></figure>

<p>9.用户权限分配</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91MYSQL8.0/" data-id="ckhnf9hej000540ut9zqn5fpy" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-日志管理-rsyslog" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-rsyslog/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.256Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="日志管理-rsyslog"><a href="#日志管理-rsyslog" class="headerlink" title="日志管理-rsyslog"></a>日志管理-rsyslog</h1><h1 id="1-系统日志"><a href="#1-系统日志" class="headerlink" title="1 系统日志"></a>1 系统日志</h1><h2 id="1-系统日志介绍"><a href="#1-系统日志介绍" class="headerlink" title="1 系统日志介绍"></a>1 系统日志介绍</h2><p>将系统和应用发生的事件记录到日志中，以助于拍错和分析使用</p>
<p>日志记录的内容包括：</p>
<ul>
<li>历史事件：事件，地点，人物，事件</li>
<li>日志级别：事件的关键性程序，Loglevel</li>
</ul>
<p>系统日志的发展过程：</p>
<ul>
<li>Centos 5 之前采用：syslogd，klogd</li>
<li>Centos 6 以后采用rsyslog</li>
</ul>
<p>Rsyslog特性：</p>
<ul>
<li>多线程</li>
<li>UDP，TCP，SSL，TLS，RELP</li>
<li>Mysql，PGSQL，Oracle数据库实现日志存储</li>
<li>强大的过滤器，可以实现过滤记录日志信息中任意部分</li>
<li>自定义输出格式</li>
</ul>
<p>ELK：由三个软件组成的非关系型分布式数据库</p>
<ul>
<li>Elasticsearch，开源的，分布式搜索引擎，可以处理大规模日志数据</li>
<li>Logstash：对日志进行收集、分析、过滤，并将其存储供以后使用</li>
<li>Kibana：可以提供的日志分析友好的Web界面</li>
</ul>
<h2 id="2-rsyslog-管理"><a href="#2-rsyslog-管理" class="headerlink" title="2 rsyslog 管理"></a>2 rsyslog 管理</h2><h3 id="1-术语"><a href="#1-术语" class="headerlink" title="1 术语"></a>1 术语</h3><ul>
<li>facility：设施，从功能或程序上对日志进行分类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">大概有：</span><br><span class="line">auth,authpriv,cron,daemon,ftp,kern,lpr,mail,syslogxxx</span><br><span class="line">还可以自定义</span><br><span class="line">local10-local17</span><br></pre></td></tr></table></figure>

<ul>
<li>Priority：优先级，从低到高排序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug，info，notice，warn，err，crit(critical),alert,emerg</span><br></pre></td></tr></table></figure>

<ul>
<li>参考帮助：man rsyslogd，man logger</li>
</ul>
<h3 id="2-rsyslog管理"><a href="#2-rsyslog管理" class="headerlink" title="2 rsyslog管理"></a>2 rsyslog管理</h3><p><code>/etc/rsyslog.conf,/etc/rsyslog.d/*.conf</code></p>
<p>日志的组成格式：</p>
<ul>
<li>MODULES：相关模块配置</li>
<li>GLOBAL DIRECTIVES：全局配置</li>
<li>RULES：日志记录相关的规则配置</li>
</ul>
<p>RULE的配置格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">facility.priority;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.info;mail.none;authpriv.none;cron.none                &#x2F;var&#x2F;log&#x2F;messages</span><br></pre></td></tr></table></figure>

<p>facility格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* #所有的facility</span><br><span class="line">facility1,,facility2,facility3...</span><br></pre></td></tr></table></figure>

<p>记录多个facility的日志，可以自己定义facility</p>
<p>priority格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*：所有级别</span><br><span class="line">none：没有级别，就是说不记录</span><br><span class="line">priority：指定级别及以上的所有级别</span><br><span class="line">&#x3D;priority：仅记录指定级别的日志信息</span><br></pre></td></tr></table></figure>

<p>target格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">文件路径：通常在&#x2F;var&#x2F;log&#x2F;，文件路径前面加&quot;-&quot;，表示异步写入，即不是事件发生立刻写入</span><br><span class="line">用户：将日志事件通知给指定的用户，* 表示登录的所有用户</span><br><span class="line">日志服务器：@host，把日志发送给指定的远程UDP日志服务器，@@host 将日志发送到远程TCP日志服务器</span><br><span class="line">管道： | COMMAND，转发给其他命令处理</span><br></pre></td></tr></table></figure>

<p>通常的日志格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">事件产生的时间   主机名称  进程(pid)：事件内容</span><br></pre></td></tr></table></figure>

<p>把日志记录到其他主机</p>
<p>1.本机配置远程主机的地址  一个@是upd，两个@@是tcp</p>
<p>2.远程主机开启imudp模块</p>
<p>例子：Centos8开启imtcp,imudp模块接收来自centos7的日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module(load&#x3D;&quot;imudp&quot;)</span><br><span class="line">input(type&#x3D;&quot;imudp&quot; port&#x3D;&quot;514&quot;)</span><br><span class="line"></span><br><span class="line">module(load&#x3D;&quot;imtcp&quot;)</span><br><span class="line">input(type&#x3D;&quot;imtcp&quot; port&#x3D;&quot;514&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>centos7配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">54 *.info;mail.none;authpriv.none;cron.none                &#x2F;var&#x2F;log&#x2F;messages</span><br><span class="line">55 *.info;mail.none;authpriv.none;cron.none                @10.0.0.119  #udp</span><br><span class="line">56 *.info;mail.none;authpriv.none;cron.none                @@10.0.0.119  #tcp</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>几个重要的日志：</p>
<p><code>/var/log/secure</code>：系统安全日志，文本格式</p>
<p><code>/var/log/btmp</code>：需要使用<code>lastb</code>查看，失败登录日志</p>
<p><code>/var/log/wtmp</code>：需要使用<code>last</code>查看，成功登陆日志</p>
<p><code>/var/log/lastlog</code>：查看用户的最后登录时间，使用<code>lastlog</code>查看</p>
<p><code>dmesg</code>：硬件的记录信息</p>
<p><code>/var/log/messages</code>：很多程序都会把日志写在这里，在<code>/etc/rsyslog.conf</code>中配置</p>
<p><code>/var/log/anaconda/*</code>：系统安装过程日志</p>
<h2 id="3-日志管理工具-journalctl"><a href="#3-日志管理工具-journalctl" class="headerlink" title="3 日志管理工具 journalctl"></a>3 日志管理工具 journalctl</h2><p>Centos7之后，利用systemd同一管理所有Unit的启动日志，带来的好处就是，可以只用journalctl一个命令，查看所有日志，包括内核日志和应用日志</p>
<p>日志的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;systemd&#x2F;journald.conf</span><br></pre></td></tr></table></figure>

<p>命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl [options] [matches]</span><br></pre></td></tr></table></figure>



<h1 id="2-实际操作"><a href="#2-实际操作" class="headerlink" title="2 实际操作"></a>2 实际操作</h1><h2 id="1-利用mysql存储日志信息"><a href="#1-利用mysql存储日志信息" class="headerlink" title="1 利用mysql存储日志信息"></a>1 利用mysql存储日志信息</h2><p>通过rsyslog-mysql模块来实现功能，注意要在数据库进行常规的账号和数据库创建和授权</p>
<p>两台主机，一台rsyslog，一台mysql</p>
<p>目标：利用rsyslog日志服务，将收集到的日志记录与mysql中</p>
<p>rsyslog：10.0.0.119</p>
<p>mysql：10.0.0.12</p>
<p>1.在rsyslog服务器上安装连接mysql模块的相关程序包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dnf install rsyslog-mysql</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$rpm -ql rsyslog-mysql</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;.build-id</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;.build-id&#x2F;08&#x2F;e7a8c0efc79474f9a8aac3afb7af7654665568</span><br><span class="line">&#x2F;usr&#x2F;lib64&#x2F;rsyslog&#x2F;ommysql.so</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;rsyslog&#x2F;mysql-createDB.sql  #这是一个数据文件，里面是创建用于rsyslog的SQL语句，把它复制到数据库服务器上，导入数据库</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.在数据库服务器上导入sql和创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]$scp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;rsyslog&#x2F;mysql-createDB.sql 10.0.0.12:&#x2F;root&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">source &#x2F;root&#x2F;mysql-createDB.sql</span><br><span class="line"></span><br><span class="line">MariaDB [Syslog]&gt; create user rsyslog@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.014 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [Syslog]&gt; grant all privileges on Syslog.* to rsyslog@&#39;10.0.0.%&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>3.配置日志服务器将日志发送至指定数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">开启模块，centos8是module，centos7和6是 $modload ommysql</span><br><span class="line">module(load&#x3D;&quot;ommysql&quot;)</span><br><span class="line">#指定日志传送到数据库服务器，格式是，模块，IP，数据库名，用户，密码</span><br><span class="line">*.info;mail.none;authpriv.none;cron.none                :ommysql:10.0.0.12,Syslog,rs yslog,centos</span><br><span class="line">systmectl restart rsyslog.service</span><br><span class="line"></span><br><span class="line">#测试日志</span><br><span class="line">logger &quot;this is a test log&quot;</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">*************************** 18. row ***************************</span><br><span class="line">                ID: 18</span><br><span class="line">        CustomerID: NULL</span><br><span class="line">        ReceivedAt: 2020-10-31 22:01:23</span><br><span class="line">DeviceReportedTime: 2020-10-31 22:01:23</span><br><span class="line">          Facility: 1</span><br><span class="line">          Priority: 5</span><br><span class="line">          FromHost: centos8</span><br><span class="line">           Message: this is a test log</span><br></pre></td></tr></table></figure>



<h2 id="2-loganalyzer"><a href="#2-loganalyzer" class="headerlink" title="2 loganalyzer"></a>2 loganalyzer</h2><p>loganalyzer是用PHP语言实现的日志管理系统，可以将Mysql数据库的日志用丰富的WEB方式进行展示</p>
<p>官网：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;loganalyzer.adiscon.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>一个网页展示日志的方式；</p>
<p>三台主机，一台rsyslog，一台mysql，一台httpd+php</p>
<p>rsyslog：10.0.0.119</p>
<p>mysql：10.0.0.12</p>
<p>httpd+php：10.0.0.111</p>
<p>在上一个实验的基础上，安装一个httpd和php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install httpd php php-fpm php-gd php-mysqlnd</span><br><span class="line">wget http:&#x2F;&#x2F;download.adiscon.com&#x2F;loganalyzer&#x2F;loganalyzer-4.1.11.tar.gz</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xf loganalyzer-4.1.11.tar.gz</span><br><span class="line">mkdir -p &#x2F;var&#x2F;www&#x2F;html&#x2F;log</span><br><span class="line">mv loganalyzer-4.1.11&#x2F;src&#x2F;* &#x2F;var&#x2F;www&#x2F;html&#x2F;log</span><br><span class="line">touch &#x2F;var&#x2F;www&#x2F;html&#x2F;log&#x2F;config.php</span><br><span class="line">chmod &#x2F;var&#x2F;www&#x2F;html&#x2F;log&#x2F;666 config.php</span><br></pre></td></tr></table></figure>

<p>通过<a target="_blank" rel="noopener" href="http://ip/log%E8%AE%BF%E9%97%AEloganalyzer">http://IP/log访问loganalyzer</a></p>
<p>配置的时候注意：如果配置不对需要重新配，就把config.php这个文件删除了，然后在touch一个新的</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201101094356620.png" alt="image-20201101094356620"></p>
<h1 id="3-logrotate-日志转储"><a href="#3-logrotate-日志转储" class="headerlink" title="3 logrotate 日志转储"></a>3 logrotate 日志转储</h1><h2 id="1-logrotate-介绍"><a href="#1-logrotate-介绍" class="headerlink" title="1 logrotate 介绍"></a>1 logrotate 介绍</h2><p>logrotate程序是一个日志文件管理工具，用来把旧的日志文件删除，并创建新的日志文件，称为日志转储或滚动，可以根据日志文件的大小，也可以根据其天数来转储，这个过程一般通过<code>cron</code>程序来执行</p>
<h2 id="2-logrotate-配置"><a href="#2-logrotate-配置" class="headerlink" title="2 logrotate 配置"></a>2 logrotate 配置</h2><p>软件包：<code>logrotate</code></p>
<p>相关文件</p>
<ul>
<li>计划任务：<code>/etc/cron.daily/logrotate</code></li>
<li>程序文件：<code>/usr/sbin/logrotate</code></li>
<li>配置文件：<code>/etc/logrotate.conf</code></li>
<li>日志文件：<code>/var/lib/logrotate/logrotate.status</code></li>
</ul>
<p>配置文件格式</p>
<p>日志文件的路径 {</p>
<p>​    命令  参数</p>
<p>​    命令  参数</p>
<p>​    ….</p>
<p>}</p>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 &#x2F;var&#x2F;log&#x2F;yum.log &#123;</span><br><span class="line">2     missingok</span><br><span class="line">3     notifempty</span><br><span class="line">4     maxsize 30k</span><br><span class="line">5     yearly</span><br><span class="line">6     create 0600 root root</span><br><span class="line">7 &#125;</span><br></pre></td></tr></table></figure>

<p>常用参数：</p>
<table>
<thead>
<tr>
<th>配置命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>compress</td>
<td>通过gzip压缩转储以后的日志</td>
</tr>
<tr>
<td>nocompress</td>
<td>不压缩</td>
</tr>
<tr>
<td>create mode owner group</td>
<td>指定转储文件的所属组和所属组</td>
</tr>
<tr>
<td>delaycompress</td>
<td>和compress一起使用时，表示转储的日志文件是在下一次转储时才压缩</td>
</tr>
<tr>
<td>ifempty</td>
<td>即使是空文件也转储，此项是默认选项</td>
</tr>
<tr>
<td>notifempty</td>
<td>如果是空文件，就不转储</td>
</tr>
<tr>
<td>mail address</td>
<td>把转储的日志文件发送到指定邮箱</td>
</tr>
<tr>
<td>olddir directory</td>
<td>把转储的日志文件存放在指定目录，必须和当前日志文件在同一个文件系统</td>
</tr>
<tr>
<td>prerotate/endscript</td>
<td>在转储以前需要执行的命令，这两个命令必须单独成行</td>
</tr>
<tr>
<td>postrotate/endscript</td>
<td>在转储以后需要执行的命令，这两个命令必须单独成行</td>
</tr>
<tr>
<td>daily/weekly/monthly</td>
<td>指定转储周期</td>
</tr>
<tr>
<td>rotate countNum</td>
<td>指定能够保存多少份转储日志文件，超过了就开始删除日志</td>
</tr>
<tr>
<td>size Num</td>
<td>指定日志文件大小达到多少时进行转储</td>
</tr>
<tr>
<td>missingok</td>
<td>如果日志文件不存在，不提示错误，继续处理下一个</td>
</tr>
<tr>
<td>nomissingok</td>
<td>如果日志文件不存在，提示错误，此为默认值</td>
</tr>
<tr>
<td>shardscripts</td>
<td>无论有多少个日志匹配到，都只执行一次prerotate或postrotate的脚本</td>
</tr>
<tr>
<td>noshardscripts</td>
<td>针对每一个日志，都执行一次prerotate或postrotate脚本，此为默认值</td>
</tr>
</tbody></table>
<p>范例：Nginx的日志转储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;apps&#x2F;nginx&#x2F;logs&#x2F;*.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        rotate 100</span><br><span class="line">        missingok</span><br><span class="line">        notifempty</span><br><span class="line">        create 644 nginx nginx</span><br><span class="line">        postrotate</span><br><span class="line">          if [ -f &#x2F;apps&#x2F;nginx&#x2F;logs&#x2F;nginx.pid ];then</span><br><span class="line">                kill -USR1 &#96;cat &#x2F;apps&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;</span><br><span class="line">          fi</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>范例：手动转储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -vf &#x2F;etc&#x2F;logrotate</span><br></pre></td></tr></table></figure>














      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-rsyslog/" data-id="ckhnf9hej000440utenfabfi1" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-加密和安全" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.256Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="加密和安全"><a href="#加密和安全" class="headerlink" title="加密和安全"></a>加密和安全</h3><h4 id="安全设计的基本原则："><a href="#安全设计的基本原则：" class="headerlink" title="安全设计的基本原则："></a>安全设计的基本原则：</h4><ul>
<li>使用成熟的安全系统</li>
<li>以小人之心度输入数据</li>
<li>外部系统是不安全的</li>
<li>最小授权</li>
<li>减少外部接口</li>
<li>缺省使用安全模式</li>
<li>安全不是似是而非</li>
<li>从假冒、篡改、否认、信息泄露、拒绝服务、提升权限方面思考</li>
<li>在入口处检查</li>
<li>从管理上保护好你的系统</li>
</ul>
<h4 id="常用的安全技术："><a href="#常用的安全技术：" class="headerlink" title="常用的安全技术："></a>常用的安全技术：</h4><ul>
<li>认证</li>
<li>授权</li>
<li>审计</li>
<li>安全通信</li>
</ul>
<h4 id="加密算法："><a href="#加密算法：" class="headerlink" title="加密算法："></a>加密算法：</h4><p><strong>1.对称式加密</strong>：加密和解密使用同一个密钥</p>
<p>特性：</p>
<ul>
<li>加密、解密使用同一个密钥，效率高</li>
<li>将原始数据分割成固定大小的块，逐个进行加密</li>
</ul>
<p>缺陷：</p>
<ul>
<li>密钥过多</li>
<li>密钥分发</li>
<li>数据来源无法确认</li>
</ul>
<p>常见对称加密算法：DES、3DES、AES、Blowfish、IDEA</p>
<p><strong>2.非对称式加密：公钥，私钥成对出现</strong></p>
<ul>
<li>公钥：public key，公开给所有人，主要给别人加密使用</li>
<li>私钥：secret key，private key自己留存，必须保证其私密性，用于自己加密签名</li>
</ul>
<p>特点：</p>
<ul>
<li>用公钥加密数据，只能使用与之对应的私钥进行解密；反之亦然</li>
</ul>
<p>功能：</p>
<ul>
<li>数字加密：适合加密较小数据，比如：加密对称加密密钥</li>
<li>数字签名：主要在于让接收方确认发送方身份</li>
</ul>
<p>缺陷：</p>
<ul>
<li>密钥长，算法复杂</li>
<li>加密效率低下</li>
</ul>
<p>公钥私钥的异同：</p>
<ul>
<li>公钥和私钥是通过非对称性加密算法同时得到的一对密钥</li>
<li>公钥和私钥是彼此的唯一，只有他们彼此可以解开彼此</li>
<li>公钥一般是发送给其他人的，私钥是自己保存的</li>
<li>公钥一般用于其他主机加密消息，私钥多用于解密公钥加密的、其他主机发送来的消息</li>
</ul>
<p>常见非对称加密算法：RSA、DSA、ECC</p>
<p><strong>gpg命令：</strong></p>
<p>gpg实现对称加密文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg -c file #加密，加密后生成file.gpg文件</span><br><span class="line">gpg -o file -d file.gpg #解密，-d后面是加密后的文件，-o后面是解密成什么名字的文件</span><br></pre></td></tr></table></figure>

<p>gpg实现非对称式加密：以A,B两台主机之间加密传输文件为例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gpg --gen-key #A主机生成密钥对，需要设置密钥的身份信息</span><br><span class="line">gpg --list-keys #查看A主机上的密钥</span><br><span class="line">gpg -a --export -o lv.pubkey #在A主机上导出公钥lv.pubkey</span><br><span class="line">将公钥发送给B主机</span><br><span class="line">gpg --import lv.pubkey #将公钥导入B主机</span><br><span class="line">gpg --list-keys #查看B主机上的密钥</span><br><span class="line">gpg -e -r lv filename #利用A的公钥lv.pubkey加密文件，生成filename.gpg文件</span><br><span class="line">将加密好的文件发送给A主机</span><br><span class="line">gpg -d filename.gpg #在A主机解密文件，这时候自动匹配使用A的私钥解密</span><br><span class="line">gpg --delete-keys lv #删除公钥</span><br><span class="line">gpg --delete-secret-keys lv #删除私钥</span><br></pre></td></tr></table></figure>

<p><strong>3.单向哈希算法</strong></p>
<p>哈希算法，也称为散列算法，将任意数据缩小成固定大小的“指纹”，称为digest，即摘要</p>
<p>特性：</p>
<ul>
<li>任意长度输入，固定长度输出</li>
<li>若修改数据，指纹也会改变，且具有雪崩效应，数据的一点微小改变，生成的指纹值变化非常大</li>
<li>无法从指纹中重新生成数据，即不可逆，具有单向性</li>
</ul>
<p>功能：检验数据完整性</p>
<p>常见算法：md5：128bits、sha1:160bits、sha224、sha256、sha384、sha512</p>
<p>常用工具：</p>
<ul>
<li>MD5sum | sha1sum [ –check ] file</li>
<li>openssl、gpg</li>
<li>rpm -V</li>
</ul>
<h5 id="4-数字签名："><a href="#4-数字签名：" class="headerlink" title="4.数字签名："></a><strong>4.数字签名：</strong></h5><p>数字签名是指：使用非对称加密算法加密了通过哈希算法得出的摘要。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">主机A，主机B</span><br><span class="line">主机A发送数据包data给主机B</span><br><span class="line">主机A首先对data使用哈希算法，得到摘要D</span><br><span class="line">然后使用非对称加密算法加密摘要D（使用A的私钥），得到签名S  #这个S就是数字签名</span><br><span class="line">这个时候主机A把data和S一起发送出去</span><br><span class="line">主机B接收到data和S</span><br><span class="line">主机B先对data使用哈希算法，得到D1</span><br><span class="line">主机B再使用主机A的公钥解密S，得到D</span><br><span class="line">主机B对比D和D1，如果D和D1相同，那么数据包data就是从主机A发送出来的，且数据没有被修改过；如果D和D1不同，那么数据就被修改过。</span><br></pre></td></tr></table></figure>

<p><strong>5.密钥交换：</strong></p>
<p>使用DH算法，可以让A,B主机得到安全的对称密钥。</p>
<h4 id="CA和证书"><a href="#CA和证书" class="headerlink" title="CA和证书"></a>CA和证书</h4><p>涉及几个名词概念：</p>
<p><strong>根CA：最高级CA，内置在操作系统中，是微软认为安全的CA</strong></p>
<p>CA：Certificate Authority  发证书权威–&gt;证书颁发机构</p>
<p>中间人：指站在网络通信双方之间拦截信息的人，</p>
<p>证书：我理解的证书就是签名，身份证件，就是用你自己的私钥加密的文件，能让别人用你的公钥解开，让别人知道这个数据是来自于你的。能提供这个功能的数据就是证书。</p>
<h5 id="CA的流程："><a href="#CA的流程：" class="headerlink" title="CA的流程："></a><strong>CA的流程：</strong></h5><p>互联网中有很多公钥，你不会随便相信你接收到的A的公钥是真正A的公钥，就像你不会相信一张用A4纸写的身份证是真的一样，所以出现了CA，类似于公安局，它可以给出权威证明，就像身份证一样，你在发送数据时附带上这个证件，别人就知道收到的数据真的是来自于你的，你也可以通过别人数据中附带的证书知道，你收到的数据真的是某某某发送来的。</p>
<p>这里面还有个信任问题：你信任CA1，小红信任CA2，但是你不信任CA2，小红不信任CA1，那你们是不能建立信任连接的。这个时候就需要一个大家都信任的根CA，它给CA1和CA2发证书，证明他们都是可信的，那么你和小红就能通过根CA，建立起信任。<strong>这个根CA是怎么让大家都信任的呢？它内置在操作系统中。</strong>这个就是微软自己认为一定安全的CA，那么我就把它内置在操作系统中，这样用户默认就信任这个CA了，然后通过这个CA给其他小CA发放的证书，我们就能知道其他CA是否可信任了，这样就解决了中间人问题。<strong>（还是通过公钥私钥的解密来确认的，如果小CA的证书能够通过根CA的公钥解密了，那么它一定可信）</strong></p>
<p><strong>安全协议：SSL/TLS</strong>：</p>
<p>SSL：Secure Socket Layer</p>
<p>TLS：Transport Layer Security</p>
<p>这个协议是在传输层和应用层中间</p>
<h5 id="HTTPS的工作流程"><a href="#HTTPS的工作流程" class="headerlink" title="HTTPS的工作流程"></a><strong>HTTPS的工作流程</strong></h5><p>HTTPS协议：HTTP协议和SSL/TLS协议的组合。对HTTP协议的文本数据进行加密处理后，称为二进制形式传输</p>
<p><strong>注意：HTTPS的传输中只要求服务器端有证书（公钥），客户端不需要</strong></p>
<p>HTTPS的工作流程：</p>
<ul>
<li>客户端发起HTTPS请求，用户在浏览器输入https网址，然后连接到服务器的443端口</li>
<li>服务器端收到请求后，发送携带有可以证明自己身份的公钥（证书）给客户端</li>
<li>客户端接收到数据后，将会通过TLS协议验证证书的有效性，比如颁发机构、过期时间等信息，如果发现异常，就会弹出警告框，提示证书存在问题；如果证书没有问题，那么就生成一个随机值，然后用证书中的服务器公钥对随机值进行加密（非对称加密）</li>
<li>客户端将加密信息发送给服务器端，这一步的目的就是让服务器端得到这个随机值，以后客户端和服务器端的通信就可以通过这个随机值来进行加密解密了</li>
<li>服务器端解密信息。服务器端收到数据后，使用自己的私钥进行解密，得到了客户端传来的随机值</li>
<li>服务器端将数据利用这个随机值进行对称加密，再发送给客户端</li>
<li>客户端接收并用随机值解密，获取解密后的数据内容</li>
<li>上面提到的随机值应该是服务器端和客户端都生成了，最后也是利用双方的随机值一起作为对称加密的密钥</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200903201235406.png" alt="image-20200903201235406"></p>
<h4 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h4><p>1.OpenSSL介绍：</p>
<ul>
<li><p>OpenSSL是一个开源项目，密码学和SSL/TLS 工具箱</p>
</li>
<li><p>包括三个组件</p>
<ul>
<li>libcrypto：用于实现加密和解密的库</li>
<li>libssl：用于实现ssl通信协议的安全库</li>
<li>openssl：多用途命令行工具</li>
</ul>
</li>
</ul>
<h5 id="Base64编码"><a href="#Base64编码" class="headerlink" title="Base64编码"></a>Base64编码</h5><p>Base64编码是一种常用于传输8bit字节码的编码方式，它基于64个可打印的字符来表示二进制数据。</p>
<p>平时的数据中会存在大量的乱码，这就是因为二进制组成了不可打印的字符，导致显示异常，用64个可以打印的字符去表示他们就会显示正常，只不过显示出来的不是数据原本的样子。</p>
<p>64个字符就是需要表示64个数，用二进制来表示需要6位，所以Base64是以6位为一个单位来传输数据的。Base64就是将数据看成一长串二进制，然后每6位一组去表示一个字符，破坏原来的8位字节结构，位数不够了就补零。</p>
<p>而由于计算机的发展历史，存储数据的基本单位是bite，它是8位（ASCII规定的，因为8位就可以安排完所有的英文字母数字符号），所以Base64的6位表示和一个字节的8位表示会导致有些字符在表示时需要去填充0才能显示正常，这样的表示需要用“=”表示出来。要看一个Base64表示的数据中有没有“=”，就看这个：6和8的最小公倍数是24，也就是3个字节，如果要表示的数据的字节长度是3的倍数，那么Base64表示出来的数据中就没有“=”；如果不是3的倍数，那么被3整除之后，余数是几就要写几个“=”，当然，最多两个。</p>
<p>Base64的64个字符</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200904200647617.png" alt="image-20200904200647617"></p>
<h5 id="OpenSSL命令："><a href="#OpenSSL命令：" class="headerlink" title="OpenSSL命令："></a>OpenSSL命令：</h5><p>两种运行模式：</p>
<ul>
<li>交互模式</li>
<li>批处理模式</li>
</ul>
<p>三种子命令：</p>
<ul>
<li>标准命令</li>
<li>消息摘要命令</li>
<li>加密命令</li>
</ul>
<p>OpenSSL的使用：</p>
<p>1.OpenSSL命令实现对称加密和解密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#加密</span><br><span class="line">openssl enc -e -des3 -a -salt -in testfile -out testfile.cipher</span><br><span class="line">#解密</span><br><span class="line">openssl enc -d -des3 -a -salt -in testfile.cipher -out testfile</span><br></pre></td></tr></table></figure>

<p>2.OpenSSL命令实现哈希加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl md5 filename</span><br><span class="line">openssl sha512 filename</span><br><span class="line">sha512sum filename</span><br></pre></td></tr></table></figure>

<p>3.OpenSSL命令生成用户密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -6 -salt Y16DiwuVqtl5xcqk </span><br><span class="line">echo lvzhehui | openssl passwd -6 -salt Y16DiwuVqtl5xcqk -stdin</span><br></pre></td></tr></table></figure>

<p>范例：创建新用户同时指定密码，在Centos和Ubuntu都通用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -p &#96;echo lvzhehui | openssl passwd -6 -salt Y16DiwuVqtl5xcqk -stdin&#96; lv</span><br></pre></td></tr></table></figure>

<p>4.OpenSSL生成随机数</p>
<p>随机数生成器：伪随机数字，利用键盘和鼠标，块设备中断生成随机数</p>
<p>/dev/random：仅从熵池返回随机数，随机数用尽就没了，需要等待，阻塞</p>
<p>/dev/urandom：从熵池返回随机数，随机数用尽，会利用软件生成伪随机数，不会阻塞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 NUM</span><br><span class="line">#NUM指的是几个字节，注意如果这个字节数不是3的倍数，后面会有等号</span><br><span class="line">openssl rand -base64 NUM | head -c xx</span><br><span class="line">#通过head -c 命令取出前面不带等号的部分</span><br><span class="line">其他的生成随机数的方法：</span><br><span class="line">cat &#x2F;dev&#x2F;urandom | tr -dc &#39;[:alnum:]&#39; | head -c 10 </span><br><span class="line">mkpasswd -l 10 </span><br></pre></td></tr></table></figure>

<p>5.OpenSSL命令实现PKI，公共密钥加密体系，也就是非对称加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out filename.key 2048</span><br><span class="line">#加上umask后，保证这个密钥的安全性，这样写也更具有通用性</span><br><span class="line">(umask 077;openssl genrsa -out filename.key 2048)</span><br><span class="line">#使用对称密钥再加密一下这个生成的密钥</span><br><span class="line">(umask 077;openssl genrsa -out filename.key -des3 2048)</span><br><span class="line">#从私钥中提取出公钥</span><br><span class="line">openssl rsa -in filename.key -pubout -out filename.key.pub</span><br><span class="line">#解密私钥 ？</span><br><span class="line">openssl rsa -in app.key -out app.key</span><br></pre></td></tr></table></figure>

<h5 id="建立私有CA实现证书申请颁发"><a href="#建立私有CA实现证书申请颁发" class="headerlink" title="建立私有CA实现证书申请颁发"></a>建立私有CA实现证书申请颁发</h5><p>建立私有CA：</p>
<ul>
<li>OpenCa：OpenCa开源组织使用Perl对OpenSSL进行二次开发而成的一套完善的PKI免费软件</li>
<li>openssl：相关包openssl和openssl-libs</li>
</ul>
<p>证书申请及签署步骤：</p>
<p>​    1.生成证书申请请求</p>
<ol start="2">
<li><p>CA核验</p>
<ol start="3">
<li>CA签署</li>
<li>获取证书</li>
</ol>
</li>
</ol>
<p>openssl的配置文件，这里规定了申请证书时的一些要求，可以人为修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;pki&#x2F;tls&#x2F;openssl.cnf</span><br></pre></td></tr></table></figure>

<p>在这个配置文件中有三种策略：match–匹配、optional–可选、supplied–提供</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match：要求申请填写的信息与CA设置信息必须一致</span><br><span class="line">optional：可有可无，跟CA设置可以不一样</span><br><span class="line">supplied：必须填写这项申请信息</span><br></pre></td></tr></table></figure>

<p>需要用到的命令</p>
<ul>
<li>生成私钥文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out xxx.pem </span><br><span class="line">注意，CA自己的密钥后缀写了pem，客户端生成密钥写了key</span><br></pre></td></tr></table></figure>

<ul>
<li>颁发证书</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#这个是自签名证书，CA给自己的颁发的命令</span><br><span class="line">openssl req -new -x509 -key xxxx.pem -days xx -out xxx.pem</span><br><span class="line">#这个是客户端申请时候用到命令，客户端这个命令只能生成申请，颁发还有一条CA的命令</span><br><span class="line">openssl req -new -key xxx.key -out xxx.csr</span><br><span class="line">#这个命令是CA的，CA根据客户端的.csr文件生成一个.crt文件，这才是客户端要的证书</span><br><span class="line">openssl ca -in xxx.csr -out xxx.crt -days xx</span><br></pre></td></tr></table></figure>

<ul>
<li>查看证书文件的命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in xxx.pem  -noout -text </span><br></pre></td></tr></table></figure>



<h5 id="创建私有CA的具体操作："><a href="#创建私有CA的具体操作：" class="headerlink" title="创建私有CA的具体操作："></a>创建私有CA的具体操作：</h5><p>1.创建CA所需要的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#根据&#x2F;etc&#x2F;pki&#x2F;tls&#x2F;openssl.cnf配置文件的要求，生成这几个文件夹</span><br><span class="line">mkdir -pv &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;&#123;certs,crl,newcerts,private&#125;</span><br><span class="line">#根据openssl.cnf生成文件，这里是CA的数据库，存放证书的编号、是否有效等信息</span><br><span class="line">touch &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;index.txt</span><br><span class="line">#根据openssl.cnf生成序列号文件，serial，里面写上自己设定的证书起始序号，序号是16进制表示的</span><br><span class="line">echo 01 &gt; &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;serial</span><br><span class="line">#根据openssl.cnf生成吊销序号文件，crlnumber，同serial，只不过存放的是吊销序列</span><br><span class="line">echo 01 &gt; &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;crlnumber</span><br></pre></td></tr></table></figure>

<p>2.生成CA私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(umask 066;openssl genrsa -out &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;private&#x2F;cakey.pem 2048) </span><br></pre></td></tr></table></figure>

<p>3.生成CA自签名证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -key &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;private&#x2F;cakey.pem -days 3650 -out &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;cacert.pem</span><br><span class="line">然后填写一些选项，CA就自建完成了</span><br></pre></td></tr></table></figure>

<h5 id="申请证书和颁发证书："><a href="#申请证书和颁发证书：" class="headerlink" title="申请证书和颁发证书："></a>申请证书和颁发证书：</h5><p>注意：本来在规则中，申请证书是客户端自己先生成自己的公钥和私钥后，把申请发送给CA，CA再去认证，然后颁发证书，但是在自建CA中，在CA的服务器上就直接生成客户端的公钥私钥了，然后直接自己认证，颁发证书，然后把证书和私钥一起发送给客户端。具体怎么用还没学习，目前了解的情况是这样。下面的步骤就是在CA服务器上做的</p>
<p>1.为需要使用证书的主机生成私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(umask 066;openssl genrsa -out &#x2F;data&#x2F;app.key 2048)</span><br></pre></td></tr></table></figure>

<p>2.为需要使用证书的主机生成证书申请文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key &#x2F;data&#x2F;app&#x2F;app.key -out &#x2F;data&#x2F;app&#x2F;app.csr</span><br><span class="line">需要填写一些信息，注意这些信息中按照openssl.cnf的要求，有些选项必须跟CA自签名证书一样</span><br></pre></td></tr></table></figure>

<p>3.在CA签署证书并将证书颁发给申请者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -in &#x2F;data&#x2F;app&#x2F;app.csr -out &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;certs&#x2F;app.crt -days 1000</span><br><span class="line">这一步就生成了用户的证书，需要按两次确认 y</span><br></pre></td></tr></table></figure>

<p>4.查看证书中的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#这个是通用的命令，可以查看pem和crt文件信息</span><br><span class="line">openssl x509 -in filename.pem -noout -text</span><br><span class="line">#这个选项后面的 -text选项可以换成 -issuer -subject -dates -serial 这些具体的，-text是全部信息</span><br></pre></td></tr></table></figure>

<p>5.验证指定编号证书的有效性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -status NUM</span><br><span class="line">显示出来的信息中，Valid(V)是有效，Revoked(R)是无效</span><br><span class="line">查看数据库文件index.txt文件</span><br><span class="line">cat &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;index.txt</span><br><span class="line">这里面也有有效无效信息</span><br></pre></td></tr></table></figure>

<p>6.把证书发送给客户端使用，注意之前生成的密钥也得发送，文件夹里应该有三个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;certs&#x2F;app.crt &#x2F;data&#x2F;app&#x2F;</span><br><span class="line">tree &#x2F;data&#x2F;app&#x2F;</span><br><span class="line">.</span><br><span class="line">├── app1.crt</span><br><span class="line">├── app1.csr</span><br><span class="line">└── app1.key</span><br><span class="line">要发这三个一起发了</span><br></pre></td></tr></table></figure>

<h5 id="吊销证书："><a href="#吊销证书：" class="headerlink" title="吊销证书："></a>吊销证书：</h5><p>1.在客户端获取要吊销的证书的serial</p>
<p>2.在CA上，根据客户提交额serial与subject信息，对比检验是否与index.txt文件中的信息一致，吊销证书</p>
<p>3.指定第一个吊销证书的编号，注意：第一次更新证书吊销列表前，才需要执行</p>
<p>4.更新证书吊销列表</p>
<p>5.查看crl文件</p>
<p>涉及到的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#吊销编号01的证书</span><br><span class="line">openssl ca -revoke &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;newcerts&#x2F;01.pem</span><br><span class="line">#查看01证书的状态</span><br><span class="line">openssl ca -status 01</span><br><span class="line">#生成吊销证书列表</span><br><span class="line">openssl ca -gencrl -out &#x2F;etc&#x2F;pki&#x2F;CA&#x2F;crl.pem</span><br><span class="line">#查看吊销证书列表</span><br><span class="line">openssl crl -in crl.pem -noout -text</span><br></pre></td></tr></table></figure>

<h4 id="SSH服务"><a href="#SSH服务" class="headerlink" title="SSH服务"></a>SSH服务</h4><h5 id="ssh介绍"><a href="#ssh介绍" class="headerlink" title="ssh介绍"></a>ssh介绍</h5><p>ssh：secure shell  ，protocol，22/tcp，安全的远程登录，实现加密通信，代替传统的Telnet协议</p>
<p>具体的软件实现：</p>
<ul>
<li>Openssh：ssh协议的开源实现，centos默认安装</li>
<li>dropbear：另一个ssh协议的开源项目的实现</li>
</ul>
<p>SSH协议版本</p>
<ul>
<li>v1：基于CRC-32做MAC，不安全；man-in-middle</li>
<li>v2：双方主机协议选择安全的MAC方式，基于DH算法做密钥交换，基于RSA或DSA实现身份认证</li>
</ul>
<p>SSH协议连接与HTTPS，SSL/TLS等存在一个区别，那就是它的连接过程中没有CA，所以它第一次建立连接的时候有些特殊，它无法确认服务器和客户端公钥是否是真的，只能通过在ssh远程连接时发出提醒信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The authenticity of host &#39;ssh-server.example.com (12.18.429.21)&#39; can&#39;t be established.</span><br><span class="line">RSA key fingerprint is 98:2e:d7:e0:de:9f:ac:67:28:c2:42:2d:37:16:58:4d.</span><br><span class="line">Are you sure you want to continue connecting (yes&#x2F;no)?</span><br></pre></td></tr></table></figure>

<p><strong>这里面RSA key fingerprint 就是服务器公钥使用哈希算法得出的值，我们需要直接物理登录服务器，看服务器的公钥使用哈希算法之后得出的值是不是跟这个相等，从而判断真实性，这就是它第一次建立连接时的安全考虑。</strong></p>
<p><strong>SSH首次建立链接</strong></p>
<ul>
<li>客户端发起链接请求</li>
<li>服务器端接收到请求后把自己的公钥和一个会话ID发送给客户端</li>
<li>客户端收到服务器消息后，得出了服务器端公钥</li>
<li>客户端也有自己的密钥对</li>
<li>客户端用自己的公钥异或会话ID，计算出一个值Res，并用服务端的公钥加密</li>
<li>客户端发送加密后的值到服务器，服务端用私钥解密，得到Res</li>
<li>服务端用解密后的值Res异或会话ID，计算出客户端的公钥</li>
<li>最终，客户端和服务器端都有三个密钥，自己的公钥，自己的私钥，彼此的公钥。</li>
<li>之后所有的通讯都会被公钥加密</li>
</ul>
<p><strong>SSH建立链接后的通讯</strong></p>
<ul>
<li>客户端使用服务器端的公钥加密数据，发送给服务器端</li>
<li>服务器端收到数据后，使用自己的私钥解密，得到数据</li>
<li>服务器端使用客户端的公钥加密数据，然后发送给客户端</li>
<li>客户端收到数据后，使用自己的私钥解密，得到数据</li>
</ul>
<p><strong>SSH和HTTPS的区别：</strong></p>
<ul>
<li>HTTPS协议是需要CA的，更安全，SSH协议没有CA，需要物理确认公钥的真实性</li>
<li>HTTPS协议中客户端不需要公钥和证书，SSH协议客户端也要公钥</li>
<li>HTTPS建立连接后传输数据是用变化的对称密钥加密数据的，SSH协议建立连接后是通过双方的公钥加密数据的，同时也有对称密钥加密。</li>
</ul>
<h5 id="Openssh服务"><a href="#Openssh服务" class="headerlink" title="Openssh服务"></a>Openssh服务</h5><p>Openssh是SSH协议的免费开源实现，一般在各种Linux版本中会默认安装，基于C/S结构。</p>
<p>Openssh软件相关包：</p>
<ul>
<li>openssh</li>
<li>openssh-clients</li>
<li>openssh-server</li>
</ul>
<p>涉及到的文件路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;ssh&#x2F;  #这里存放了公钥和私钥</span><br><span class="line">&#x2F;etc&#x2F;ssh&#x2F;ssh_config   #这个是ssh的配置文件</span><br></pre></td></tr></table></figure>

<p>客户端ssh命令</p>
<p>1.修改/etc/ssh/ssh_config文件中的选项，可以取消</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原来是</span><br><span class="line">#   StrictHostKeyChecking ask</span><br><span class="line">修改成</span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">这样可以取消首次登陆显示检查提示</span><br></pre></td></tr></table></figure>

<p>ssh [user@] host [COMMAND]</p>
<p>ssh常用选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-p port 指定远程服务器端口</span><br><span class="line">-t 强制伪tty分配，这个可以做到一条命令跳着连接</span><br></pre></td></tr></table></figure>

<p>ssh -t 10.0.0.3 ssh -t 10.0.0.7 -t 10.0.0.5<br>然后输入三次密码</p>
<p>范例：在远程主机运行本地shell脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 10.0.0.4 &#x2F;bin&#x2F;bash &lt; test.sh</span><br></pre></td></tr></table></figure>

<p>ssh登陆验证方式</p>
<ul>
<li>用户/口令</li>
<li>基于密钥</li>
</ul>
<p>1.用户/口令</p>
<ul>
<li>客户端发起ssh请求，服务器会把自己的公钥发送给用户</li>
<li>用户会根据服务器发来的公钥对密码进行加密</li>
<li>加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功</li>
</ul>
<p>2.基于密钥</p>
<ul>
<li>客户端已经有公钥和私钥</li>
<li>客户端主动把公钥ssh-copy-id拷贝到服务端</li>
<li>当客户端发送一个连接请求给服务器端，服务器端会去autuorized_keys中查找，如果有相应的IP和用户名，就会随机生成一个字符串</li>
<li>服务器端将使用客户端拷贝过来的公钥对数据进行加密，然后发送给客户端</li>
<li>客户端收到数据后，使用自己的私钥解密，然后将解密的字符串发送给服务器端</li>
<li>服务器端收到客户端发送来的字符串后，跟之前的字符串对比，如果一致就允许免密码登录</li>
</ul>
<p>实现基于密钥的登录方式</p>
<p>在客户端生成密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa [-P &#39;passwd&#39;] [-f &quot;~&#x2F;.ssh&#x2F;id_rsa&quot;]</span><br><span class="line">-t 是指定算法，不写就默认是rsa算法</span><br><span class="line">-P 是指定之前加密密钥的密码，没有就不写或者空</span><br><span class="line">-f 是指定密钥的文件，不写就默认是~&#x2F;.ssh&#x2F;id_rsa</span><br></pre></td></tr></table></figure>

<p>把公钥文件传输至远程服务器对应用户的家目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id [-i [identify_file]] [user@]host</span><br></pre></td></tr></table></figure>

<p>重设私钥口令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -p</span><br></pre></td></tr></table></figure>

<p>验证代理（authentication agent）保密解密后的密钥，口令就只要输入一次，在GNOME中，代理被自动提供给root用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#启用代理</span><br><span class="line">ssh-agent bash</span><br><span class="line">#钥匙通过命令添加给代理</span><br><span class="line">ssh-add</span><br></pre></td></tr></table></figure>

<p>上面写的这几个命令，其实是这个关系：</p>
<ul>
<li>首先生成密钥对</li>
<li>把密钥拷贝到服务端</li>
<li>重设私钥口令这个，它是去加密之前生成的那个私钥去了，这样一来，下次在使用这个私钥的时候（也就是使用私钥解密公钥的时候–&gt;登录服务端的时候），需要输入密码</li>
<li>这个代理更有意思，它是为了重设私钥口令服务的，开启代理，输入ssh-add，然后输入加密私钥的密码，成功之后，之后使用私钥的时候就不需要输入密码了。</li>
</ul>
<p><strong>一个自动登录ssh的工具：sshpass</strong></p>
<p>这个工具在epel源中，<strong>它可以满足在一行命令中提供IP和密码，实现非交互式建立ssh连接</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass [option] command parameters</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-p password #后面跟密码</span><br><span class="line">-f filename #后面跟保存密码的文件名，密码是文件内容的第一行</span><br><span class="line">-e #将环境变量SSHPASS作为密码，在脚本中提前设置好 export SSHPASS&#x3D;密码 ,然后在命令中就不用谢密码了，直接 -e</span><br><span class="line">例如：</span><br><span class="line">export SSHPASS&#x3D;centos</span><br><span class="line">sshpass -e ssh 10.0.0.3 </span><br></pre></td></tr></table></figure>



<p>通过脚本批量实现多台主机的基于ssh的key验证</p>
<p>脚本1：使用expect实现基于ssh的key的验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-09-06</span><br><span class="line"> 7 #FileName:  push_ssh_key.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 #顺序</span><br><span class="line">11 #目的：使用脚本，自动地生成本地ssh密钥--&gt;将密钥拷贝到其他主机--&gt;循环N个主</span><br><span class="line">   机--&gt;验证是否成功</span><br><span class="line">12 rpm -q expect &amp;&gt; &#x2F;dev&#x2F;null || yum -y install expect &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">13 ssh-keygen -t rsa -P &quot;&quot; -f &#x2F;root&#x2F;.ssh&#x2F;id_rsa &amp;&gt; &#x2F;dev&#x2F;null &amp;&amp; echo &quot;key ha    s been created&quot; || (echo &quot;error,please check your script&quot;;exit)</span><br><span class="line">14 while read IP PASS ; do</span><br><span class="line">15 expect &amp;&gt; &#x2F;dev&#x2F;null &lt;&lt;EOF</span><br><span class="line">16 set timeout 20</span><br><span class="line">17 spawn ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa root@$IP</span><br><span class="line">18 expect &#123;</span><br><span class="line">19     &quot;yes&#x2F;no&quot; &#123; send &quot;yes\n&quot;;exp_continue &#125;</span><br><span class="line">20     &quot;password&quot; &#123; send &quot;$PASS\n&quot; &#125;</span><br><span class="line">21 &#125;</span><br><span class="line">22 expect eof</span><br><span class="line">23 EOF</span><br><span class="line">24 ssh root@$IP hostname -I &lt; &#x2F;dev&#x2F;null</span><br><span class="line">25 echo $IP OK </span><br><span class="line">26 done &lt; host.txt    </span><br><span class="line"></span><br><span class="line">host.txt文件是这样的：</span><br><span class="line">1 10.0.0.5 centos                                                          </span><br><span class="line">2 10.0.0.3 centos</span><br></pre></td></tr></table></figure>

<p>脚本2：通过sshpass命令来方便地批量建立基于ssh的密钥的连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-09-06</span><br><span class="line"> 7 #FileName:  push_ssh_key2.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 HOSTS&#x3D;&#39;</span><br><span class="line">11 10.0.0.3</span><br><span class="line">12 10.0.0.5</span><br><span class="line">13 &#39;</span><br><span class="line">14 export SSHPASS&#x3D;centos</span><br><span class="line">15 rpm -q sshpass &amp;&gt; &#x2F;dev&#x2F;null  || yum -y install sshpass &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">16 ssh-keygen -t rsa -P &quot;&quot; -f &#x2F;root&#x2F;.ssh&#x2F;id_rsa &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">17 for i in $HOSTS</span><br><span class="line">18 do</span><br><span class="line">19 &#123;</span><br><span class="line">20     sshpass -e ssh-copy-id -o StrictHostKeyChecking&#x3D;no -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa  root@$i &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">21     echo $i is ready                                                     </span><br><span class="line">22 &#125;&amp;</span><br><span class="line">23 done</span><br><span class="line">24 wait</span><br></pre></td></tr></table></figure>

<p>脚本3：通过sshpass批量修改主机root密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-09-06</span><br><span class="line"> 7 #FileName:  random_passwd.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 rpm -q sshpass &amp;&gt; &#x2F;dev&#x2F;null || yum -y install sshpass &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">11 HOSTS&#x3D;&#39;</span><br><span class="line">12 10.0.0.3</span><br><span class="line">13 10.0.0.5</span><br><span class="line">14 &#39;</span><br><span class="line">15 export SSHPASS&#x3D;centos</span><br><span class="line">16 for i in $HOSTS</span><br><span class="line">17 do</span><br><span class="line">18 &#123;</span><br><span class="line">19     PASS&#x3D;&#96;openssl rand -base64 9&#96;                                        </span><br><span class="line">20     sshpass -e ssh -o StrictHostKeyChecking&#x3D;no $i &quot;echo $PASS | passwd --    stdin root &amp;&gt; &#x2F;dev&#x2F;null&quot;</span><br><span class="line">21     echo $i $PASS &gt;&gt; passwd.txt</span><br><span class="line">22 &#125;&amp;</span><br><span class="line">23 done</span><br><span class="line">24 wait</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>scp命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp [option] SOURCE ...DESTINATION&#x2F;</span><br><span class="line">scp [option] [user@]host1:&#x2F;sourcepath [user@]host2:&#x2F;destpath</span><br></pre></td></tr></table></figure>

<p>常用参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-C 压缩数据流</span><br><span class="line">-r 递归复制</span><br><span class="line">-p 保持原文件的属性信息</span><br><span class="line">-q 静默模式</span><br><span class="line">-p port 指定远程主机的监听端口，也就是访问端口</span><br></pre></td></tr></table></figure>

<p><strong>rsync命令</strong></p>
<p>rsync比scp更快，基于增量数据同步，是比scp更好的选择，来自于rsync包</p>
<p>注意：通信双方都要安装rsync</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -av &#x2F;etc 10.0.0.3:&#x2F;tmp</span><br><span class="line">rsync -av &#x2F;etc&#x2F; 10.0.0.3:&#x2F;tmp</span><br><span class="line">上面两个的区别：第一个会复制目录过去，第二个只复制文件内容过去</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-a 存档，禁忌的七重奏，相当于 -rlptgoD,但是不保留ACL和SELinux属性 -A和-X</span><br><span class="line">-v 显示详细过程</span><br><span class="line">-r 递归复制</span><br><span class="line">-p 保留权限</span><br><span class="line">-t 保留修改时间戳</span><br><span class="line">-g 保留组信息</span><br><span class="line">-o 保留所有者信息</span><br><span class="line">-l 将软链接文件本身进行复制</span><br><span class="line">-L 将软链接文件指向的文件复制</span><br><span class="line">-u 如果接受者的文件比发送者的文件新，将忽略同步</span><br><span class="line">-z 压缩，节约带宽</span><br><span class="line">--delete 源数据删除，目标数据也得同步删除，这个是保证双方文件一致的好金坷垃</span><br></pre></td></tr></table></figure>

<h5 id="ssh的端口转发功能"><a href="#ssh的端口转发功能" class="headerlink" title="ssh的端口转发功能"></a><strong>ssh的端口转发功能</strong></h5><p>ssh除了本身的安全通讯功能，还有更好的一个功能，它可以将其他TCP端口的数据通过SSH链接来转发，并且自动提供了相应的加密及解密服务，这个叫隧道（tunneling）。</p>
<p>ssh端口转发能够提供两大功能：</p>
<ul>
<li>加密SSH Client 端至 SSH Server 端之间的通讯数据</li>
<li>突破防火墙的限制完成一些之前无法建立的TCP连接</li>
</ul>
<p>1.SSH本地端口转发：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh -L localport:remotehost:remotehostport sshserver</span><br><span class="line">选项：</span><br><span class="line">-f 后台打开</span><br><span class="line">-N 不打开远程shell，处于等待状态</span><br><span class="line">-g 启用网关功能</span><br></pre></td></tr></table></figure>
<p>例如：发送到本地127.0.0.1:9999端口的数据，都会被ssh隧道转发到10.0.0.4主机上，然后10.0.0.4再建立与10.0.0.3:23的Telnet通讯，这就是本地端口转发。</p>
<p>10.0.0.4和10.0.0.3可以是防火墙里面的同一内网的主机，他们之间的通讯被认为是相对安全的。本地主机10.0.0.5被认为是在互联网上，只允许通过ssh的端口和防火墙内特定主机通讯。</p>
<p><strong>哪边建立连接的端口是22，哪边就是服务端</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个命令是在防火墙外面的主机10.0.0.5上敲的，9999端口是10.0.0.5的端口，这里需要默认这个主机跟防火墙里面的10.0.0.4主机可以通过ssh连接</span><br><span class="line">在本地端口转发中，ssh的客户端是防火墙外面的10.0.0.5，服务端是10.0.0.4</span><br><span class="line">ssh -fNL 9999:10.0.0.3:23 10.0.0.4</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200908111325630.png" alt="image-20200908111325630"></p>
<p>2.SSH远程端口转发：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个命令是在防火墙里面的10.0.0.4上敲的，从防火墙里面往外面更好连接，端口9999是防火墙外面主机的，10.0.0.3:80是最终想要访问的地址端口，10.0.0.5是防火墙外面的主机的地址。</span><br><span class="line">在远程端口转发中，ssh的客户端是防火墙里的10.0.0.4，服务端是防火墙外面的10.0.0.5</span><br><span class="line">ssh -fNR 9999:10.0.0.3:80 10.0.0.5</span><br></pre></td></tr></table></figure>
<p>下面的命令加上-g，就会监听所有IP地址，0.0.0.0:9999 不仅仅是本机地址，127.0.0.1：9999</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这里修改网关功能是修改的10.0.0.5，也就是防火墙外面的主机的</span><br><span class="line">vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line">找到#Gatewayports</span><br><span class="line">修改为Gatewayports yes，这样就打开了网关功能，让其他主机也可以通过你的IP地址加端口访问原来不能访问的地址</span><br><span class="line">ssh -fNgR 9999:10.0.0.3:80 10.0.0.5</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200908111546508.png" alt="image-20200908111546508"></p>
<p><strong>注意这个图片里面有一点问题，这里的SSH隧道应该是从里往外的</strong></p>
<p>3.SSH动态端口转发：</p>
<p>-D  的意思就是通过本地的9999端口出去的数据发送到10.0.0.4之后，会按照数据中的地址去访问原来访问不了的地址，不会规定具体访问IP和端口，具体访问什么端口、什么IP，只要10.0.0.4能访问的，就都能访问，这也是科学上网的原理</p>
<p>下面的命令是在本机上敲的，不是在VPS上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fND 9999 10.0.0.4</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fNDg 9999 10.0.0.4</span><br></pre></td></tr></table></figure>

<img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200908111644761.png" alt="image-20200908111644761" style="zoom:150%;" />

<p>例子：通过SSH实现科学上网</p>
<p>本地地址：10.0.0.5，VPS地址：10.0.0.4，这个命令是在VPS上敲的，这里默认本机可以正常与VPS建立SSH连接，然后VPS自己开网关路由功能，需要访问外网的时候，只需要去访问VPS10.0.0.4的9999端口，VPS就会代理你去访问外网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fNgD 9999 10.0.0.4</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200908111700029.png" alt="image-20200908111700029"></p>
<p>4.X协议转发</p>
<p>下载一个可以有图形的软件，比如浏览器，然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export DISPLAY&#x3D;你的IP:0.0</span><br><span class="line">firefox</span><br></pre></td></tr></table></figure>

<h5 id="ssh服务配置"><a href="#ssh服务配置" class="headerlink" title="ssh服务配置"></a>ssh服务配置</h5><p>配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;ssh&#x2F;sshd_config #服务端配置文件</span><br><span class="line">&#x2F;etc&#x2F;ssh&#x2F;ssh_config #客户端配置文件</span><br><span class="line">这两个文件都很有作用，具体看需要配什么就去具体查一下，这里主要说服务端配置</span><br></pre></td></tr></table></figure>

<p>查看sshd的日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">taif -f &#x2F;var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

<p>为了提高ssh连接速度，可以修改一下这两个选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GSSAPIAuthentication yes</span><br><span class="line">#UseDNS yes</span><br><span class="line">改成：</span><br><span class="line">GSSAPIAuthentication no</span><br><span class="line">UseDNS no</span><br></pre></td></tr></table></figure>

<p>ssh服务的建议操作：</p>
<ul>
<li>使用非默认端口</li>
<li>限制可登陆用户</li>
<li>设定空闲会话超时时间</li>
<li>利用防火墙设置ssh访问策略</li>
<li>仅监听特定的IP地址</li>
<li>使用基于密钥的认证</li>
<li>禁止root用户直接登陆</li>
<li>显示ssh的访问频度和并发在线数</li>
<li>经常分析日志</li>
</ul>
<p>ssh的几个好工具</p>
<ul>
<li>epel源，软件包：fuse-sshfs 命令：sshfs 10.0.0.3:/data /mnt</li>
<li>epel源，软件包：sshpass 命令：ssh [option] command parameters</li>
<li>epel源，软件包：pssh 命令：pssh [option] command […]</li>
</ul>
<p>dropbear：另一个开源ssh协议软件</p>
<h4 id="文件完整性检查"><a href="#文件完整性检查" class="headerlink" title="文件完整性检查"></a>文件完整性检查</h4><p><strong>AIDE Advanced Instrusion Detection Environment</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install aide</span><br><span class="line">vim &#x2F;etc&#x2F;aide.conf</span><br></pre></td></tr></table></figure>

<h4 id="sudo授权"><a href="#sudo授权" class="headerlink" title="sudo授权"></a>sudo授权</h4><h5 id="1-什么是sudo"><a href="#1-什么是sudo" class="headerlink" title="1.什么是sudo"></a>1.什么是sudo</h5><p>sudo是superuser do，允许系统管理员让普通用户执行一些或全部的root命令的一个工具。</p>
<p>sudo可以有效减少root用户的登录和管理实践，同时提高了系统安全性。</p>
<p>超级用户将普通用户的名字、可以执行的特定命令、按照那种用户或用户组的身份执行等信息登记在特殊的文件中（一般是/etc/sudoers），即完成对该用户的授权。</p>
<h5 id="2-sudo的组成"><a href="#2-sudo的组成" class="headerlink" title="2.sudo的组成"></a>2.sudo的组成</h5><p>包：sudo</p>
<p>配置文件：/etc/sudo.conf</p>
<p>授权规则配置文件：</p>
<p>/etc/sudoers</p>
<p>/etc/sudoers.d</p>
<p>安全编辑授权规则文件和语法检查文件</p>
<p>/usr/sbin/visudo</p>
<p>授权编辑规则文件的工具：</p>
<p>/usr/bin/sudoedit</p>
<p>执行授权命令：</p>
<p>/usr/bin/sudo</p>
<p>时间戳文件：</p>
<p>/var/db/sudo</p>
<p><strong>日志文件：</strong></p>
<p>/var/log/secure</p>
<h5 id="3-sudo的命令"><a href="#3-sudo的命令" class="headerlink" title="3.sudo的命令"></a>3.sudo的命令</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo</span><br><span class="line">sudo -i -u lv -i login -u 用户 切换用户，跟su类似，但是sudo必须提前授权，而且输入的密码是自己的密码，不是其他用户的密码</span><br><span class="line">sudo -u command</span><br><span class="line">-l 列出用户在主机上可用的和被禁止的命令</span><br><span class="line">-V 大写 显示版本信息等配置信息</span><br><span class="line">-u user 默认为root</span><br><span class="line">-v 小写 再延长密码有效期限5分钟，更新时间戳</span><br><span class="line">-k 清除时间戳，下次需要重新输入密码</span><br><span class="line">-K 大写 与-k类似，还要删除时间戳文件</span><br><span class="line">-b 在后台执行指令</span><br><span class="line">-p 改变询问密码的提示符号</span><br></pre></td></tr></table></figure>

<h5 id="4-sudo授权规则的配置"><a href="#4-sudo授权规则的配置" class="headerlink" title="4.sudo授权规则的配置"></a>4.sudo授权规则的配置</h5><p>/etc/sudoers</p>
<p>/etc/sudoers.d/</p>
<p>支持别名定义</p>
<p>授权格式规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户	登入主机&#x3D;（代表用户）	命令</span><br><span class="line">user	host&#x3D;(run as )	command</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root	ALL&#x3D;(ALL)	ALL</span><br></pre></td></tr></table></figure>

<p>注意command要写绝对路径</p>
<h5 id="5-一些例子"><a href="#5-一些例子" class="headerlink" title="5.一些例子"></a>5.一些例子</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!&#x2F;bin&#x2F;cat &#x2F;var&#x2F;log&#x2F;secure* *</span><br><span class="line">注意这个如果不加!后面的内容，用户可以执行如下命令cat &#x2F;var&#x2F;log&#x2F;secure &#x2F;etc&#x2F;shadow 这样的命令随便查看系统的文件。很危险。</span><br></pre></td></tr></table></figure>

<h4 id="PAM认证机制"><a href="#PAM认证机制" class="headerlink" title="PAM认证机制"></a>PAM认证机制</h4><h5 id="1-PAM是什么"><a href="#1-PAM是什么" class="headerlink" title="1.PAM是什么"></a>1.PAM是什么</h5><p>PAM：Pluggable Authentication Modules，插件式的验证模块，sun公司开发</p>
<p>PAM是一种架构，它可以让服务和服务的认证分开，从而使得运维可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序的一种认证框架</p>
<p>开发按照这个框架开发软件，开发好的软件让运维去配置，这个配置和软件是分开的</p>
<p>应用程序开发者通过在服务程序中使用PAM API 来实现对认证方法的调用；</p>
<p>PAM服务模块的开发者则利用PAM SPI 来编写模块；</p>
<p>PAM接口库则读取配置文件，将应用程序和相应的PAM服务模块联系起来</p>
<h5 id="2-PAM的组成"><a href="#2-PAM的组成" class="headerlink" title="2.PAM的组成"></a>2.PAM的组成</h5><p>包名：pam</p>
<p>模块文件目录：/lib64/secruity/*.so</p>
<p>特定模块相关的设置文件：/etc/security/</p>
<p>应用程序调用PAM模块的配置文件</p>
<ul>
<li>主配置文件：/etc/pam.conf，默认不存在，一般不使用主配置</li>
<li>为每种应用模块提供一个专用的配置文件：/etc/pam.d/APP_NAME</li>
<li>注意：如果/etc/pam.d存在，/etc/pam.conf将失效</li>
</ul>
<p>查看一个应用是否支持pam</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd &#96;which sshd&#96; | grep libpam</span><br></pre></td></tr></table></figure>

<h5 id="3-PAM的工作原理"><a href="#3-PAM的工作原理" class="headerlink" title="3.PAM的工作原理"></a>3.PAM的工作原理</h5><p>PAM认证一般遵循这样的顺序：Service（服务）–&gt;PAM（配置文件）–&gt;pam_*.so</p>
<p>PAM认证首先要确定哪一项服务，然后加载相应的PAM的配置文件（位于/etc/pam.d/），最后调用认证文件（位于/lib64/security/）进行安全认证</p>
<p>PAM的认证过程：</p>
<ul>
<li>使用者执行/usr/bin/passwd程序，并输入密码</li>
<li>passwd开始调用PAM模块，PAM模块会搜索passwd程序的PAM相关设置文件，这个设置文件一般是在/etc/pam.d里面的与程序同名的文件，即PAM会搜寻/etc/pam.d/passwd这个配置文件</li>
<li>经由/etc/pam.d/passwd设定文件的数据，取用PAM所提供的相关模块来进行验证</li>
<li>将验证结果返回给passwd程序，而passwd程序会根据返回的结果决定下一个动作（重新输入密码或者通过验证）</li>
</ul>
<h5 id="4-PAM的使用"><a href="#4-PAM的使用" class="headerlink" title="4.PAM的使用"></a>4.PAM的使用</h5><p>PAM的使用就是对配置文件的管理</p>
<p>下面是配置文件格式说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type	control	   modul-path	 arguments</span><br><span class="line">tyep：指模块类型，即功能</span><br><span class="line">control：PAM库该如何处理与该服务相关的PAM模块的成功或失败情况，一个关键词实现</span><br><span class="line">module-path：用来指明本模块对应的程序文件的路径名</span><br><span class="line">arguments：用来传递给该模块的参数</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">模块类型 module-type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Auth</td>
<td>账号的认证和授权</td>
</tr>
<tr>
<td align="left">Account</td>
<td>账户的有效性，与账号管理相关的非认证类的功能，如：用来限制/允许用户对某个服务的访问时间，限制用户的位置（如：root用户只能从控制台登录）</td>
</tr>
<tr>
<td align="left">Password</td>
<td>用户修改密码时密码复杂度检查机制等功能</td>
</tr>
<tr>
<td align="left">Session</td>
<td>用户会话期间的控制，如：最多打开的文件数，最多的进程数等</td>
</tr>
<tr>
<td align="left">-type</td>
<td>表示因为缺失而不能加载的模块将不记录到系统日志，对于那些不总是安装在系统上的模块有用</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Control</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>required</td>
<td>一票否决，表示本模块必须返回成功才能通过认证，但是如果该模块返回失败，失败结果也不会立即通知用户，而是要等到同一type中的所有模块全部执行完毕，再将失败结果返回给应用程序，这个是必要条件</td>
</tr>
<tr>
<td>requisite</td>
<td>一票否决，根required区别在于它认证失败马上将控制权返回给应用程序，不再等待同一type内的任何模块</td>
</tr>
<tr>
<td>sufficient</td>
<td>一票通过，表明本模块返回成功则通过身份认证的要求，不必再执行同一type内其他模块，但如果本模块返回失败则可以忽略，是充分条件</td>
</tr>
<tr>
<td>optional</td>
<td>可选的，返回值被忽略</td>
</tr>
<tr>
<td>include</td>
<td>调用其他的配置文件中定义的配置信息</td>
</tr>
</tbody></table>
<p>module-path：模块文件所在绝对路径，/lib64/security/下的不用写绝对路径</p>
<table>
<thead>
<tr>
<th>arguments</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>debug</td>
<td>该模块应当用syslog()将调试信息写入到系统日志文件</td>
</tr>
<tr>
<td>no_warn</td>
<td>表明该模块不应把警告信息发送给应用程序</td>
</tr>
<tr>
<td>use_first_pass</td>
<td>该模块不能提示用户输入密码，只能从前一个模块得到输入密码</td>
</tr>
<tr>
<td>try_first_pass</td>
<td>该模块首先用前一个模块从用户得到密码，，如果该密码验证不通过，再提示用户输入新密码</td>
</tr>
<tr>
<td>use_mapped_pass</td>
<td>该模块不能提示用户输入密码，而是使用映射过的密码</td>
</tr>
<tr>
<td>expose_account</td>
<td>允许该模块显示用户的账号名等信息，一般只能在安全的环境下使用，因为泄露用户名会对安全造成一定程度的威胁</td>
</tr>
</tbody></table>
<p>注意：修改PAM配置文件立即生效</p>
<p>建议：编辑pam规则时，保持至少一个root会话打开，以防止root身份验证错误</p>
<h5 id="5-常用的PAM模块"><a href="#5-常用的PAM模块" class="headerlink" title="5.常用的PAM模块"></a>5.常用的PAM模块</h5><p>1.pam_shells.so模块：检查有效shells</p>
<p>2.pam_securetty.so模块：只允许root用户在/etc/securetty列出的安全终端上登录</p>
<p>3.pam_nologin.so模块：如果/etc/nologin文件存在，将导致非root用户无法登录，当该用户登录时，会显示/etc/nologin文件内容，并拒绝登录</p>
<p>4.<strong>pam_limits.so模块</strong>：在用户级别实现对其可使用的资源的限制，例如：可打开的文件的数量，可运行的进程数量，可用内存空间</p>
<p>有自己独有的配置文件 /etc/security/limits.conf      /etc/security/limits.d/*.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">格式是</span><br><span class="line">每行一个定义：</span><br><span class="line">&lt;domain&gt;	&lt;type&gt;	 &lt;item&gt; 	&lt;value&gt;</span><br><span class="line">例如：</span><br><span class="line">*	soft	nproc	1024</span><br></pre></td></tr></table></figure>

<p><domain>应用对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username 单个用户</span><br><span class="line">@group 组内用户</span><br><span class="line">* 所有用户</span><br><span class="line">% 仅用于限制 最大登录限制，可以使用%group，限制一个组最大登录数量，只用一个 % 表示对所有用户的最大登录数量限制</span><br></pre></td></tr></table></figure>

<p><type>限制类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">soft 软限制，普通用户自己可以修改</span><br><span class="line">hard 硬限制，由root用户设定，且通过kernel强制生效</span><br><span class="line">- 两者同时限定</span><br></pre></td></tr></table></figure>

<p><item>限制资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nofile 能够同时打开最多的文件数量，默认1024</span><br><span class="line">nproc 同时运行的进程的最大数量，默认1024</span><br></pre></td></tr></table></figure>

<p>有自己的命令 ulimit，可以临时修改资源值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -a 显示系统默认资源值</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200908172447757.png" alt="image-20200908172447757"></p>
<p>建议生产环境这样配一下</p>
<p>5.pam_succeed_if模块：根据参数中的所有条件都满足才返回成功</p>
<p>6.pam_google_authenticator模块：实现ssh登录的两次身份验证，先验证APP的数字码，再验证root用户的密码，都通过才可以登录。目前只支持口令验证，不支持基于key验证。</p>
<h4 id="时间同步服务"><a href="#时间同步服务" class="headerlink" title="时间同步服务"></a>时间同步服务</h4><p>1.临时同步时间的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntpdate IP</span><br><span class="line">ip 填写NTP服务器的域名或者IP</span><br><span class="line">date -s &quot;-1 minute&quot;  修改时间为1分钟前</span><br><span class="line">hwclock   硬件时间</span><br><span class="line">hwclock -s 修改系统时间为硬件时间</span><br><span class="line">hwclock -w 修改硬件时间为系统时间</span><br></pre></td></tr></table></figure>

<p>2.ntp是一种协议，network time protocol</p>
<p>3.根据ntp协议实现的软件是ntp和chrony</p>
<p>4.chrony比ntp更加精确</p>
<p>5.chrony：</p>
<p>软件包：chrony</p>
<p>两个主要程序：chronyd和chronyc</p>
<ul>
<li>chronyd：后台运行的守护进程，用于调整内核中运行的系统时钟和时钟服务器同步。它确定计算机增减时间的比率，并对此进行补偿</li>
<li>chronyc：命令行用户工具，用于监控性能并进行多样化的配置。它可以在chronyd实例控制的计算机上工作，也可以在一台不同的远程计算机上工作。</li>
</ul>
<p>服务unit文件：/usr/lib/system/system/chronyd.service</p>
<p>监听端口：323/udp，123/udp</p>
<p>配置文件：/etc/chrony.conf</p>
<p>通过修改chrony.conf里面两个地方实现时间同步：</p>
<p>这是需要NTP同步服务器的配置，一个是配置NTP源，另一个是允许局域网内其他主机访问，获取时间，还一个是打开一个这个开关：哪怕远程NTP源都不能用了，也能把自己主机的时间同步给其他主机</p>
<p>配置NTP源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 # Use public servers from the pool.ntp.org project.                      </span><br><span class="line">2 # Please consider joining the pool (http:&#x2F;&#x2F;www.pool.ntp.org&#x2F;join.html).</span><br><span class="line">3 server ntp.aliyun.com  iburst</span><br><span class="line">4 server ntp1.aliyun.com  iburst</span><br><span class="line">5 server time1.cloud.tencent.com  iburst</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>允许其他主机访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">23 # Allow NTP client access from local network.</span><br><span class="line">24 #allow 192.168.0.0&#x2F;16</span><br><span class="line">25 allow 10.0.0.0&#x2F;24</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打开开关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">27 # Serve time even if not synchronized to a time source.</span><br><span class="line">28 local stratum 10</span><br></pre></td></tr></table></figure>

<p>其他需要同步的主机只需要把NTP源配置成这个服务器的地址就行，然后都把服务打开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2 # Please consider joining the pool (http:&#x2F;&#x2F;www.pool.ntp.org&#x2F;join.html).</span><br><span class="line">3 #pool 2.centos.pool.ntp.org iburst</span><br><span class="line">4 server 10.0.0.4 iburst</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>开启chronyd服务，并且开机自启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now chronyd.service</span><br></pre></td></tr></table></figure>

<h4 id="SELinux的禁用"><a href="#SELinux的禁用" class="headerlink" title="SELinux的禁用"></a>SELinux的禁用</h4><p>1.修改配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">  1 </span><br><span class="line">  2 # This file controls the state of SELinux on the system.</span><br><span class="line">  3 # SELINUX&#x3D; can take one of these three values:</span><br><span class="line">  4 #     enforcing - SELinux security policy is enforced.</span><br><span class="line">  5 #     permissive - SELinux prints warnings instead of enforcing.</span><br><span class="line">  6 #     disabled - No SELinux policy is loaded.                            </span><br><span class="line">  7 SELINUX&#x3D;enforcing</span><br></pre></td></tr></table></figure>

<p>把最后一行改成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELINUX&#x3D;disabled</span><br></pre></td></tr></table></figure>

<p>重启</p>
<p>2.查看selinux的状态命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sestatus</span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>

<p>3.临时设置selinux的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0|1</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" data-id="ckhnf9hew000a40uthgty7tav" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-二进制安装MySQL脚本" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85MySQL%E8%84%9A%E6%9C%AC/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.252Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="二进制安装MySQL脚本"><a href="#二进制安装MySQL脚本" class="headerlink" title="二进制安装MySQL脚本"></a>二进制安装MySQL脚本</h1><h2 id="MySQL-5-6-48"><a href="#MySQL-5-6-48" class="headerlink" title="MySQL 5.6.48"></a>MySQL 5.6.48</h2><p>1.创建用户和组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#groupadd -r -g 306 mysql</span><br><span class="line">[root@localhost local]#useradd -r -g 306 -u 306 -d &#x2F;data&#x2F;mysql mysql</span><br></pre></td></tr></table></figure>

<p>2.创建数据目录，并把目录的权限修改成mysql组和用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#mkdir -p &#x2F;data&#x2F;mysql</span><br><span class="line">[root@localhost local]#chown -R mysql:mysql &#x2F;data&#x2F;mysql</span><br></pre></td></tr></table></figure>

<p>3.准备二进制程序，传送到服务器上，然后解压到/urs/local</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#tar xf mysql-5.6.48-linux-glibc2.12-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br></pre></td></tr></table></figure>

<p>4.创建一个mysql软链接，改变mysql下的文件所属的组和用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#ln -s mysql-5.6.48-linux-glibc2.12-x86_64&#x2F; mysql</span><br><span class="line">[root@localhost local]#chown -R root:root &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure>

<p>5.准备配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost support-files]#cp -b my-default.cnf &#x2F;etc&#x2F;my.cnf</span><br><span class="line">填写</span><br><span class="line">[mysqld]</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql                                                     </span><br><span class="line">skip_name_resolve &#x3D; on</span><br><span class="line">basedir &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql                                                   </span><br><span class="line">port &#x3D; 3306</span><br><span class="line">log-error &#x3D; &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br></pre></td></tr></table></figure>

<p>6.创建数据库文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost scripts]#yum -y install perl-Data-Dumper numactl-devel</span><br><span class="line">[root@localhost mysql]#yum -y install libaio</span><br><span class="line">[root@localhost local]#cd &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">[root@localhost mysql]#.&#x2F;scripts&#x2F;mysql_install_db --datadir&#x3D;&#x2F;data&#x2F;mysql --user&#x3D;mysql</span><br><span class="line">[root@localhost mysql]#ll &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line">total 110592</span><br><span class="line">-rw-rw---- 1 mysql mysql 12582912 Sep 21 21:44 ibdata1</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Sep 21 21:44 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Sep 21 21:44 ib_logfile1</span><br><span class="line">drwx------ 2 mysql mysql        6 Sep 21 21:42 mysql</span><br><span class="line">drwx------ 2 mysql mysql        6 Sep 21 21:42 test</span><br></pre></td></tr></table></figure>

<p>7.准备服务脚本，并启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#cp .&#x2F;support-files&#x2F;mysql.server &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;mysqld</span><br><span class="line">[root@localhost mysql]#chkconfig --add mysqld</span><br><span class="line">[root@localhost mysql]#service mysqld start</span><br></pre></td></tr></table></figure>

<p>8.安全加固</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]$mysql_secure_installation </span><br><span class="line">回车</span><br><span class="line">y</span><br><span class="line">centos</span><br><span class="line">centos</span><br><span class="line">y</span><br><span class="line">y</span><br><span class="line">y</span><br><span class="line">y</span><br></pre></td></tr></table></figure>

<p>脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-09_21</span><br><span class="line">#FileName:	install_mysql_5.6.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line"></span><br><span class="line">NAME&#x3D;&#39;mysql-5.6.48-linux-glibc2.12-x86_64&#39;</span><br><span class="line">PASS&#x3D;&#39;centos&#39;</span><br><span class="line">cd &#x2F;usr&#x2F;local</span><br><span class="line">yum -y install perl-Data-Dumper libaio numactl-devel </span><br><span class="line">echo &#39;必要软件包安装完成&#39;</span><br><span class="line">groupadd mysql &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">id mysql</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">    useradd -r -g mysql -s &#x2F;bin&#x2F;false mysql &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">    echo &#39;mysql组和mysql用户创建完成&#39;</span><br><span class="line">else</span><br><span class="line">    echo &#39;用户mysql已经存在，退出脚本&#39;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">if [ ! -d &#x2F;data&#x2F;mysql ];then</span><br><span class="line">    mkdir -p &#x2F;data&#x2F;mysql</span><br><span class="line">    chown -R  mysql:mysql &#x2F;data&#x2F;mysql</span><br><span class="line">    echo &#39;数据目录创建完成&#39;</span><br><span class="line">else</span><br><span class="line">    echo &#39;数据目录已存在,退出脚本&#39;</span><br><span class="line">    exit </span><br><span class="line">fi</span><br><span class="line">if [ ! -f &#x2F;usr&#x2F;local&#x2F;$NAME ];then</span><br><span class="line">    tar xf $&#123;NAME&#125;.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">    echo &#39;mysql二进制文件解压完成&#39;</span><br><span class="line">else</span><br><span class="line">    echo &#39;mysql解压文件已存在,退出脚本&#39;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;$&#123;NAME&#125; &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">chown -R mysql:mysql  &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">echo &#39;创建mysql文件夹软链接&#39;</span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">echo &#39;添加mysql的环境变量到&#x2F;usr&#x2F;bin&#39;</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">.&#x2F;scripts&#x2F;mysql_install_db --user&#x3D;mysql --datadir&#x3D;&#x2F;data&#x2F;mysql </span><br><span class="line"></span><br><span class="line">cat &gt;&#x2F;etc&#x2F;my.cnf&lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql                                                     </span><br><span class="line">skip_name_resolve &#x3D; on</span><br><span class="line">basedir &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql                                                   </span><br><span class="line">port &#x3D; 3306</span><br><span class="line">log-error &#x3D; &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">sql_mode&#x3D;NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line">EOF</span><br><span class="line">cp &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">service mysqld start</span><br><span class="line"></span><br><span class="line">#安全加固</span><br><span class="line">mysql_secure_installation &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">y</span><br><span class="line">$PASS</span><br><span class="line">$PASS</span><br><span class="line">y</span><br><span class="line">y</span><br><span class="line">y</span><br><span class="line">y</span><br><span class="line">EOF</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    echo &#39;安全加固已完成，之后请使用密码进行登录&#39;</span><br><span class="line">    echo &#39;登录方式：mysql -uroot -p密码&#39;</span><br><span class="line">else</span><br><span class="line">	echo &#39;安全加固失败，退出&#39;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h2 id="MySQL-5-7-30"><a href="#MySQL-5-7-30" class="headerlink" title="MySQL 5.7.30"></a>MySQL 5.7.30</h2><p>1.创建用户和组，创建数据目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#groupadd -r -g 306 mysql</span><br><span class="line">[root@localhost local]#useradd -r -g 306 -u 306 -d &#x2F;data&#x2F;mysql mysql</span><br></pre></td></tr></table></figure>

<p>2.安装必要软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost scripts]#yum -y install perl-Data-Dumper numactl-devel</span><br></pre></td></tr></table></figure>

<p>3.准备程序文件，解压，创建软链接，改变所属组和所属用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]#tar xf mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz -C &#x2F;usr&#x2F;local</span><br><span class="line">[root@localhost local]#ln -s mysql-5.7.30-linux-glibc2.12-x86_64 mysql</span><br><span class="line">[root@localhost local]#chown -R root.root &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure>

<p>4.准备环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]#ln -s &#x2F;usr&#x2F;local&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<p>5.准备配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#grep -vE &#39;^$|^#&#39; &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql </span><br><span class="line">datadir &#x3D; &#x2F;data&#x2F;mysql</span><br><span class="line">socket &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">log-error &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.log</span><br><span class="line">pid-file &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.pid</span><br><span class="line">skip_name_resolve &#x3D; on</span><br><span class="line">[client]</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock</span><br></pre></td></tr></table></figure>

<p>6.生成数据库文件，并提取root密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#mysqld --initialize --user&#x3D;mysql --datadir&#x3D;&#x2F;data&#x2F;mysql</span><br><span class="line">[root@localhost mysql]#awk -F &quot; |:&quot; &#39;&#x2F;A temporary password is generated for&#x2F;&#123;print $NF&#125;&#39; &#x2F;data&#x2F;mysql&#x2F;mysql.log</span><br><span class="line">Y4bc)E!YPcgd</span><br></pre></td></tr></table></figure>

<p>7.准备服务脚本和启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#cp &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;mysqld</span><br><span class="line">[root@localhost mysql]#chkconfig --add mysqld</span><br><span class="line">[root@localhost mysql]#service mysqld start</span><br></pre></td></tr></table></figure>

<p>8.修改口令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#mysqladmin -uroot -p&#39;Y4bc)E!YPcgd&#39; password centos</span><br></pre></td></tr></table></figure>

<p>9.测试登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#mysql -uroot -pcentos</span><br></pre></td></tr></table></figure>

<p>脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-09-22</span><br><span class="line">#FileName:	install_mysql_5.7.30.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#5.7.30版本以及8.0版本的MySQL一键安装脚本</span><br><span class="line"></span><br><span class="line">#模块1：定义变量、调用系统函数</span><br><span class="line">. &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;functions</span><br><span class="line"></span><br><span class="line">MYSQL_RANDOM_PASS&#x3D;&#39;&#39;</span><br><span class="line">MYSQL_PASS&#x3D;&#39;centos&#39;</span><br><span class="line">FILE_NAME&#x3D;&#39;mysql-5.7.30-linux-glibc2.12-x86_64&#39;</span><br><span class="line">DATA_DIR&#x3D;&#39;&#x2F;data&#x2F;mysql&#39;</span><br><span class="line">BASE_DIR&#x3D;&#39;&#x2F;usr&#x2F;local&#x2F;mysql&#39;</span><br><span class="line"></span><br><span class="line">#模块2：定义函数</span><br><span class="line">#cecho的意思是colorful_echo,可以输出带颜色的行</span><br><span class="line">cecho () &#123;</span><br><span class="line">case $1 in </span><br><span class="line">green)</span><br><span class="line">    echo -e &quot;\e[1;32m$2\e[0m&quot;</span><br><span class="line">    ;;</span><br><span class="line">red)</span><br><span class="line">    echo -e &quot;\e[1;31m$2\e[0m&quot;</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_environment () &#123;</span><br><span class="line">if [ $UID -ne 0  ];then</span><br><span class="line">    cecho red &quot;当前账户不是root账户，安装取消&quot;</span><br><span class="line">    exit 88 </span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">id mysql &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">if [ $? -eq 0  ];then</span><br><span class="line">    cecho red &quot;mysql用户已存在，安装取消&quot;</span><br><span class="line">    exit 88</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -d $DATA_DIR  ];then</span><br><span class="line">    cecho red &quot;数据目录已存在，安装取消&quot;</span><br><span class="line">    exit 88</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -d &#x2F;var&#x2F;lib&#x2F;mysql  ];then</span><br><span class="line">    cecho red &quot;数据目录已存在，安装取消&quot;</span><br><span class="line">    exit 88</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -d $BASE_DIR  ];then</span><br><span class="line">    cecho red &quot;mysql软件目录已存在，安装取消&quot;</span><br><span class="line">    exit 88</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_mysql () &#123;</span><br><span class="line">yum -y install libaio numctl-libs perl-Data-Dumper</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s &#x2F;bin&#x2F;false mysql</span><br><span class="line">action &quot;mysql用户创建&quot;</span><br><span class="line">mkdir -p &#x2F;data&#x2F;mysql</span><br><span class="line">chown -R mysql:mysql &#x2F;data&#x2F;mysql</span><br><span class="line">action &quot;数据目录创建&quot;</span><br><span class="line"></span><br><span class="line">cd &#x2F;usr&#x2F;local</span><br><span class="line">if [ ! -f $&#123;FILE_NAME&#125;.tar.gz ];then</span><br><span class="line">    cecho red &quot;$&#123;FILE_NAME&#125;.tar.gz 不存在，请将此文件拷贝到&#x2F;usr&#x2F;local目录下&quot;</span><br><span class="line">    exit 88</span><br><span class="line">fi</span><br><span class="line">tar xf  $&#123;FILE_NAME&#125;.tar.gz -C &#x2F;usr&#x2F;local</span><br><span class="line">action &quot;$&#123;FILE_NAME&#125;.tar.gz解压&quot;</span><br><span class="line">ln -s $FILE_NAME mysql</span><br><span class="line">chown -R root:root usr&#x2F;local&#x2F;mysql </span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;* &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">action &quot;环境变量添加&quot;</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;my.cnf&lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql </span><br><span class="line">datadir &#x3D; &#x2F;data&#x2F;mysql</span><br><span class="line">socket &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">log-error &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.log</span><br><span class="line">pid-file &#x3D; &#x2F;data&#x2F;mysql&#x2F;mysql.pid</span><br><span class="line">skip_name_resolve &#x3D; on</span><br><span class="line">[client]</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">EOF</span><br><span class="line">action &quot;my.cnf配置文件创建&quot;</span><br><span class="line">mysqld --initialize --user&#x3D;mysql --datadir&#x3D;&#x2F;data&#x2F;mysql</span><br><span class="line">if [ $? -ne 0  ];then</span><br><span class="line">	action &quot;生成数据库文件&quot; false</span><br><span class="line">	exit 3</span><br><span class="line">fi</span><br><span class="line">action  &quot;生成数据库文件&quot; </span><br><span class="line">MYSQL_RANDOM_PASS&#x3D;&#96;awk -F &quot; |:&quot; &#39;&#x2F;A temporary password is generated for&#x2F;&#123;print $NF&#125;&#39; &#x2F;data&#x2F;mysql&#x2F;mysql.log&#96;</span><br><span class="line">cp &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">service mysqld start</span><br><span class="line">if [ $? -ne 0  ];then</span><br><span class="line">	aciton &quot;启动数据库&quot; false</span><br><span class="line">	exit 3</span><br><span class="line">fi</span><br><span class="line">action &quot;启动数据库&quot;</span><br><span class="line">mysqladmin -uroot -p&quot;$MYSQL_RANDOM_PASS&quot; password $MYSQL_PASS</span><br><span class="line">if [ $? -ne 0  ];then</span><br><span class="line">    action &quot;修改数据库口令&quot; false</span><br><span class="line">fi</span><br><span class="line">action &quot;修改数据库口令&quot;</span><br><span class="line">cecho green &quot;安装完成&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#模块3：函数调用，功能实现</span><br><span class="line">check_environment </span><br><span class="line">install_mysql </span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85MySQL%E8%84%9A%E6%9C%AC/" data-id="ckhnf9hei000340ut4r3u5tkc" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-VPN" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/VPN/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.248Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h2><p>实验图：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200919103731793.png" alt="image-20200919103731793"></p>
<p>大体步骤：</p>
<p>1.软件安装，包括VPN软件和证书管理软件，还包括客户端的OPENVPN软件安装</p>
<p>2.建立证书机构，颁发自签名证书、颁发VPN服务器证书、颁发VPN客户端证书，包括证书有效期等信息</p>
<p>3.把证书文件拷贝到openVPN服务要求放置的位置</p>
<p>4.配置openVPN服务器端文件</p>
<p>5.配置openVPN客户端文件</p>
<p>6.把客户端文件传送给客户端</p>
<p>7.证书的吊销</p>
<p>8.证书的申请颁发、吊销的自动化脚本</p>
<p>1.准备实验环境</p>
<p>客户端：linux和Windows</p>
<p>服务器端：vpn服务器、web服务器</p>
<p>2.服务器端安装软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.安装openvpn软件</span><br><span class="line">yum -y install openvpn</span><br><span class="line">2.安装证书管理软件</span><br><span class="line">yum -y install easy-rsa</span><br></pre></td></tr></table></figure>

<p>3.准备相关配置文件，因为很多配置文件默认不生成，需要从/usr/share/doc/openvpn/sample/和/usr/share/easy-rsa/下面复制过来改。总体就是三个</p>
<p>一个是VPN服务端配置文件</p>
<p>一个是证书颁发的相关文件</p>
<p>一个是证书相关的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#vpn服务器端配置文件</span><br><span class="line">[root@centos8 server]#cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;sample&#x2F;sample-config-files&#x2F;server.conf &#x2F;etc&#x2F;openvpn&#x2F;server&#x2F;</span><br><span class="line">#证书管理软件的必要目录和文件</span><br><span class="line">[root@centos8 openvpn]#cp -r &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F; &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server</span><br><span class="line">#证书颁发的变量文件，包括证书有效期等信息</span><br><span class="line">[root@centos8 easy-rsa-server]#cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;easy-rsa&#x2F;vars.example &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;vars</span><br></pre></td></tr></table></figure>

<p>4.提前配置证书有效期文件，CA机构自己颁发的证书的有效期尽可能时间长点，比如10年，给VPN服务器颁发的证书也可以设10年。这个vars文件有一点，一会给VPN客户端颁发的时候要改第二条 </p>
<p>“set_var EASY_CERT_EXPIRE  “  客户端不能设置这么长的有效期，建议90天左右，看生产需要 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#pwd</span><br><span class="line">&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3</span><br><span class="line">[root@centos8 3]#vim vars</span><br><span class="line">123 # In how many days should the root CA key expire?</span><br><span class="line">124 </span><br><span class="line">125 set_var EASYRSA_CA_EXPIRE   3650</span><br><span class="line">126 </span><br><span class="line">127 # In how many days should certificates expire?</span><br><span class="line">128 </span><br><span class="line">129 set_var EASYRSA_CERT_EXPIRE 3650</span><br></pre></td></tr></table></figure>



<p><strong>这下面都是CA的创建和证书的颁发</strong></p>
<p>基本都会通过一个脚本来操作，./easy-rsa  help  来查看命令帮助</p>
<p>5.通过easy-rsa脚本生成证书需要的所有目录，pki文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa init-pki</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3.0.7&#x2F;vars</span><br><span class="line"></span><br><span class="line">init-pki complete; you may now create a CA or requests.</span><br><span class="line">Your newly created PKI dir is: &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki</span><br><span class="line">[root@centos8 3]#tree</span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── pki</span><br><span class="line">│   ├── openssl-easyrsa.cnf</span><br><span class="line">│   ├── private</span><br><span class="line">│   ├── reqs</span><br><span class="line">│   └── safessl-easyrsa.cnf</span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line"></span><br><span class="line">4 directories, 13 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.创建CA机构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa build-ca</span><br><span class="line">带nopass就是不要密码</span><br><span class="line">[root@centos8 3]#tree pki</span><br><span class="line">pki</span><br><span class="line">├── ca.crt	#生成的自签名证书</span><br><span class="line">├── certs_by_serial</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── issued</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── private</span><br><span class="line">│   └── ca.key		#生成的私钥文件</span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial</span><br><span class="line">│   ├── private_by_serial</span><br><span class="line">│   └── reqs_by_serial</span><br><span class="line">├── reqs</span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial</span><br><span class="line">│   ├── private_by_serial</span><br><span class="line">│   └── reqs_by_serial</span><br><span class="line">├── safessl-easyrsa.cnf</span><br><span class="line">└── serial</span><br><span class="line"></span><br><span class="line">12 directories, 7 files</span><br><span class="line"></span><br><span class="line">[root@centos8 3]#openssl x509 -in pki&#x2F;ca.crt  -noout -text  #查看证书文件</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>7.创建VPN服务器端证书申请</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa gen-req server nopass</span><br><span class="line">这一步生成了VPN服务器端的私钥和证书申请</span><br></pre></td></tr></table></figure>

<p>8.签发VPN服务器端证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa sign-req server server</span><br><span class="line">这一步完成CA机构对VPN服务器端请求的认证，颁发出证书</span><br></pre></td></tr></table></figure>

<p>9.创建Diffie-Hellman密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa gen-dh</span><br></pre></td></tr></table></figure>



<p><strong>到此VPN服务器端证书配置完成</strong></p>
<p>10.准备客户端证书环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 openvpn]#cp -r &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F; &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-client</span><br><span class="line">[root@centos8 easy-rsa-client]#cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;easy-rsa&#x2F;vars.example  &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-client&#x2F;3&#x2F;vars</span><br><span class="line">[root@centos8 3]#.&#x2F;easyrsa init-pki</span><br></pre></td></tr></table></figure>

<p>11.创建客户端证书申请，这一步在/etc/openvpn/easy-rsa-client/3/下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa gen-req lvzhehui nopass</span><br></pre></td></tr></table></figure>

<p>12.颁发客户端证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">先进入easy-rsa-server文件夹下，把客户端申请拷贝过来，使用CA机构去认证</span><br><span class="line">[root@centos8 3]#.&#x2F;easyrsa import-req &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-client&#x2F;3&#x2F;pki&#x2F;reqs&#x2F;lvzhehui.req lvzhehui</span><br><span class="line">记得修改一下证书有效期</span><br><span class="line">vim vars</span><br><span class="line">set_var EASYRSA_CERT_EXPIRE 90</span><br><span class="line">[root@centos8 3]#.&#x2F;easyrsa sign-req client lvzhehui</span><br></pre></td></tr></table></figure>

<p>13.将CA和服务器证书相关文件复制到服务器相应的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#mkdir &#x2F;etc&#x2F;openvpn&#x2F;certs</span><br><span class="line">[root@centos8 ~]#cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki&#x2F;ca.crt &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">[root@centos8 ~]#cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki&#x2F;issued&#x2F;server.crt &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">[root@centos8 ~]#cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki&#x2F;private&#x2F;server.key &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">[root@centos8 ~]#cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki&#x2F;dh.pem &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">[root@centos8 ~]#tree &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;</span><br><span class="line">├── ca.crt</span><br><span class="line">├── dh.pem</span><br><span class="line">├── server.crt</span><br><span class="line">└── server.key</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>14.将客户端私钥与证书相关文件复制到服务器相关的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#find &#x2F;etc&#x2F;openvpn&#x2F; \( -name &quot;lvzhehui.key&quot; -o -name &quot;lvzhehui.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;lvzhehui&#x2F; \;</span><br><span class="line">这里就是复制三个文件 lvzhehui.key  lvzhehui.crt  ca.crt过来，使用了find的高级用法  </span><br><span class="line">-exec command &#123;&#125; \;  注意是格式要求  \; 必须要有</span><br></pre></td></tr></table></figure>

<p><strong>到此CA机构创建、证书申请和颁发就完成了</strong></p>
<p><strong>下面开始OpenVPN服务的配置</strong></p>
<p>15.准备OpenVPN服务器端配置文件，下面的选项是必须的，其他选项都要备注</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 server]#grep -Ev &#39;^#|^;|^$&#39; server.conf </span><br><span class="line">port 1194</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca   &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;ca.crt</span><br><span class="line">cert &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;server.crt</span><br><span class="line">key  &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;server.key  # This file should be kept secret</span><br><span class="line">dh &#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;dh.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push &quot;route 172.16.0.0 255.255.255.0&quot;</span><br><span class="line">keepalive 10 120</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">max-clients 1024</span><br><span class="line">user openvpn</span><br><span class="line">group  openvpn</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log-append  openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">#准备日志相关目录</span><br><span class="line">[root@centos8 server]#getent passwd openvpn</span><br><span class="line">openvpn:x:993:991:OpenVPN:&#x2F;etc&#x2F;openvpn:&#x2F;sbin&#x2F;nologin</span><br><span class="line">[root@centos8 server]#mkdir &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line">[root@centos8 server]#chown openvpn.openvpn &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line">[root@centos8 server]#ll -d &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line">drwxr-xr-x 2 openvpn openvpn 6 Sep 19 15:40 &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>16.配置iptables规则和内核参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#开启ip_forward数据转发功能</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">#iptables设置,相当于是客户端发给内网的信息都会被当成是VPN服务器发送的，这样内网服务器回复信息的时候知道发给VPN服务器，要不然内网服务器不知道10.0.0.0&#x2F;24网段的路由，会导致无法访问</span><br><span class="line">#临时设置</span><br><span class="line">[root@centos8 server]#iptables -t nat -A POSTROUTING -s 10.0.0.0&#x2F;24 -j MASQUERADE</span><br><span class="line">#永久保存</span><br><span class="line">[root@centos8 server]#echo &#39;iptables -t nat -A POSTROUTING -s 10.8.0.0&#x2F;24 -j MASQUERADE&#39; &gt;&gt; &#x2F;etc&#x2F;rc.local</span><br><span class="line">[root@centos8 server]#chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br></pre></td></tr></table></figure>

<p>17.VPN服务启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">centos8缺少一个unit文件，需要从centos7复制一个</span><br><span class="line">[root@localhost ~]#rpm -ql openvpn|grep systemd</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn-client@.service</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn-server@.service </span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn@.service  #centos8没有这个文件</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn-2.4.9&#x2F;README.systemd</span><br><span class="line"></span><br><span class="line">[root@centos8 server]#rpm -ql openvpn | grep systemd</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn-client@.service</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn-server@.service</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;README.systemd</span><br><span class="line"></span><br><span class="line">[root@localhost ~]#scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;openvpn@.service 10.0.0.3:&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;</span><br><span class="line"></span><br><span class="line">[root@centos8 openvpn]#systemctl start openvpn@server</span><br><span class="line">[root@centos8 openvpn]#systemctl status openvpn@server</span><br><span class="line">[root@centos8 openvpn]#ss -ntl</span><br></pre></td></tr></table></figure>

<p>18.OpenVPN客户端配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">生成的客户端配置文件后缀必须是.ovpn</span><br><span class="line">[root@centos8 lvzhehui]#vim &#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;sample&#x2F;sample-config-files&#x2F;client.conf</span><br><span class="line">[root@centos8 lvzhehui]#grep -Ev &#39;^$|^#|^;&#39; &#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;sample&#x2F;sample-config-files&#x2F;client.conf &gt;&gt; &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;lvzhehui&#x2F;client.ovpn</span><br><span class="line">[root@centos8 lvzhehui]#vim client.ovpn </span><br><span class="line">  1 client</span><br><span class="line">  2 dev tun</span><br><span class="line">  3 proto tcp</span><br><span class="line">  4 remote 10.0.0.3 1194</span><br><span class="line">  5 resolv-retry infinite</span><br><span class="line">  6 nobind</span><br><span class="line">  7 ca ca.crt</span><br><span class="line">  8 cert lvzhehui.crt</span><br><span class="line">  9 key lvzhehui.key</span><br><span class="line"> 10 remote-cert-tls server                                                 </span><br><span class="line"> 11 cipher AES-256-CBC</span><br><span class="line"> 12 verb 3</span><br></pre></td></tr></table></figure>

<p>19.在服务器打包证书并下载发送给Windows客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 lvzhehui]#tar cf lvzhehui.tar .&#x2F;</span><br><span class="line">tar: .&#x2F;lvzhehui.tar: file is the archive; not dumped</span><br><span class="line">[root@centos8 lvzhehui]#sz lvzhehui.tar</span><br></pre></td></tr></table></figure>

<p>20.客户端下载，把客户端配置文件放入config文件夹中，连接，成功</p>
<p>21.吊销证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]#.&#x2F;easyrsa revoke lvzhehui  #吊销证书</span><br><span class="line">[root@centos8 3]#.&#x2F;easyrsa gen-crl	#生成吊销列表文件</span><br><span class="line">[root@centos8 3]#vim &#x2F;etc&#x2F;openvpn&#x2F;server.conf</span><br><span class="line">#添加一行</span><br><span class="line">crl-verify &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa-server&#x2F;3&#x2F;pki&#x2F;crl.pem   #发布吊销列表</span><br><span class="line">[root@centos8 3]#systemctl restart openvpn@server  #重启服务生效</span><br></pre></td></tr></table></figure>

<p>22.证书过期，重新颁发证书</p>
<p>需要删除这个用户原来所有的文件，才能重新颁发证书</p>
<p>23.安全加固</p>
<p>1.放置Dos攻击的安全增强</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">237 # Generate with:</span><br><span class="line">238 #   openvpn --genkey --secret ta.key</span><br><span class="line">239 #</span><br><span class="line">240 # The server and each client must have</span><br><span class="line">241 # a copy of this key.</span><br><span class="line">242 # The second parameter should be &#39;0&#39;</span><br><span class="line">243 # on the server and &#39;1&#39; on the clients.</span><br><span class="line">244 ;tls-auth ta.key 0 # This file is secret </span><br><span class="line"></span><br><span class="line">tls-auth ta.key 0  服务器端；客户端是1 使用这个命令生成 openvpn --genkey  --secret ta.key</span><br><span class="line">然后把这个放到&#x2F;etc&#x2F;openvpn&#x2F;certs&#x2F;下，给客户端也放一个</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/VPN/" data-id="ckhnf9heh000240ut4b1pftie" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-NoSQL数据库Redis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.244Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="NoSQL数据库Redis"><a href="#NoSQL数据库Redis" class="headerlink" title="NoSQL数据库Redis"></a>NoSQL数据库Redis</h1><p><strong>nosql: not only sql</strong></p>
<h2 id="1-缓存技术"><a href="#1-缓存技术" class="headerlink" title="1 缓存技术"></a>1 缓存技术</h2><p>缓存是在物理速度有差距的两个硬件中间的过渡</p>
<p>一级缓存：</p>
<p>二级缓存：</p>
<p>三级缓存：</p>
<p>LRU：近期最少使用算法</p>
<p>凡事有利有弊，缓存也有问题；例如缓存中的数据与硬盘中的数据不一致；缓存价格高</p>
<h3 id="1-1-缓存"><a href="#1-1-缓存" class="headerlink" title="1.1 缓存"></a>1.1 缓存</h3><h4 id="1-1-1-buffer与cache"><a href="#1-1-1-buffer与cache" class="headerlink" title="1.1.1 buffer与cache"></a>1.1.1 buffer与cache</h4><p>buffer：缓冲，也叫写缓冲，一般用作写操作</p>
<p>清除缓存的方法：<code>echo 3 &gt; /proc/sys/vm/drop_caches</code>，查看帮助：<code>man proc</code>然后搜索<code>drop_caches</code></p>
<p>cache：缓存，也叫读缓存，一般用于读操作</p>
<h4 id="1-1-2-缓存保存位置及分层结构"><a href="#1-1-2-缓存保存位置及分层结构" class="headerlink" title="1.1.2 缓存保存位置及分层结构"></a>1.1.2 缓存保存位置及分层结构</h4><p>缓存技术是<code>互联网应用快速</code>的核心技术</p>
<ul>
<li>用户层：浏览器DNS缓存，应用程序DNS缓存，操作系统DNS缓存客户端</li>
<li>代理层：CDN，反向代理缓存</li>
<li>Web层：解释器Opcache，Web服务器缓存</li>
<li>应用层：页面静态化</li>
<li>数据层：分布式缓存，数据库</li>
<li>系统层：操作系统cache</li>
<li>物理层：磁盘cahche，Raid Cache</li>
</ul>
<h4 id="1-1-3-cache的特性"><a href="#1-1-3-cache的特性" class="headerlink" title="1.1.3 cache的特性"></a>1.1.3 cache的特性</h4><p>自动过期：给缓存的数据加上有效时间，超出时间后自动过期删除</p>
<p>强制过期：源网站更新图片后CDN是不会更新的，需要强制图片缓存过期，通过CDN后台设置</p>
<p>命中率：即缓存的读取命中率</p>
<h3 id="1-2-用户层缓存"><a href="#1-2-用户层缓存" class="headerlink" title="1.2 用户层缓存"></a>1.2 用户层缓存</h3><h4 id="1-2-1-DNS缓存"><a href="#1-2-1-DNS缓存" class="headerlink" title="1.2.1 DNS缓存"></a>1.2.1 DNS缓存</h4><p>浏览器的DNS缓存默认60秒</p>
<h4 id="1-2-2-查看浏览器的缓存"><a href="#1-2-2-查看浏览器的缓存" class="headerlink" title="1.2.2 查看浏览器的缓存"></a>1.2.2 查看浏览器的缓存</h4><p>火狐：about:cache</p>
<h4 id="1-2-2-前端使用的技术–dns-prefetch"><a href="#1-2-2-前端使用的技术–dns-prefetch" class="headerlink" title="1.2.2 前端使用的技术–dns-prefetch"></a>1.2.2 前端使用的技术–dns-prefetch</h4><p>HTML5的技术，可以在加载页面时提前将一些域名转换成IP地址</p>
<h4 id="1-2-4-浏览器缓存过期机制："><a href="#1-2-4-浏览器缓存过期机制：" class="headerlink" title="1.2.4 浏览器缓存过期机制："></a>1.2.4 浏览器缓存过期机制：</h4><p><strong>HTTP的状态码：304 Not Modified</strong> </p>
<p>304：服务器判断本地缓存文件与服务器上的文件一致，无需再次从服务器下载时，返回给用户304状态码</p>
<p><strong>if-last-modified：最后修改时间</strong></p>
<p><strong>Etags标记：Entity tag</strong></p>
<p>报文中有：If-None-Match  服务器会比较自己的文件的Etag值与if-None-Match的值是否一致</p>
<p>Etag：对文件的<strong>哈希运算（？）</strong>得到的值，每次都进行对比</p>
<p><strong>expire：有效期</strong></p>
<p>在有效期来临之前，不会重新向服务器发出该资源的请求</p>
<p><strong>混合使用前面提到的几种方式</strong></p>
<ul>
<li>Last-Modified和Expire，每次刷新都有新的Last-Modified</li>
<li>Etag和Expire一起使用，先判断Expire，然后判断Etag</li>
<li>三个一起用，先判断Expire，然后判断Last-Modified，再判断Etag</li>
</ul>
<p>缓存的刷新：</p>
<ul>
<li>第一次访问，获取最新数据，返回200响应码</li>
<li>鼠标点击或输入地址后回车（cache），浏览器对所有没有过期的内容直接使用本地缓存</li>
<li>F5或点刷新，浏览器会向服务器发送请求缓存协商信息，Last-Modified和Etag会有影响，但Expire不受影响，如果没有变化，返回304</li>
<li>ctrl+F5：不使用所有缓存，直接访问地址</li>
</ul>
<p><strong>Cookie和session</strong></p>
<p>cookie：访问网站时保持在本地的相关信息，比如账号密码，下次再访问的时候会在报文中增加cookie，方便一点</p>
<p>cookies：是服务器在客户单浏览器上存储的小段文本并随着每一个请求发送至同一个服务器，是一种实现客户端保持状态的方案</p>
<p>session：会话信息，位于web服务器上，主要负责访问者与网站之间的交互，当浏览器请求http地址时，可以基于之前的session实现会话保持、session共享。</p>
<h3 id="1-3-CDN缓存"><a href="#1-3-CDN缓存" class="headerlink" title="1.3 CDN缓存"></a>1.3 CDN缓存</h3><p>302重定向技术</p>
<p>CDN分层缓存技术</p>
<h3 id="1-4应用层缓存"><a href="#1-4应用层缓存" class="headerlink" title="1.4应用层缓存"></a>1.4应用层缓存</h3><p>Nginx、PHP等web服务器可以设置应用缓存以加速响应速度，另外有些解释性语言，比如：Python/PHP/Java不能直接运行，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候会出现程序代码上线后字节码没有更新的现象。所以上线新版前，需要先将应用缓存清理，再上线新版。</p>
<h3 id="1-5-数据层缓存"><a href="#1-5-数据层缓存" class="headerlink" title="1.5 数据层缓存"></a>1.5 数据层缓存</h3><p>分布式缓存服务：</p>
<ul>
<li>Redis</li>
<li>Memcache</li>
</ul>
<p>数据库</p>
<ul>
<li>Mysql查询缓存（不使用了）</li>
<li>InnoDB缓存、MYISAM缓存</li>
</ul>
<h3 id="1-6-CPU缓存"><a href="#1-6-CPU缓存" class="headerlink" title="1.6 CPU缓存"></a>1.6 CPU缓存</h3><p>CPU缓存（L1）、二级缓存（L2）、三级缓存（L3）</p>
<h2 id="2-Redis-部署和使用"><a href="#2-Redis-部署和使用" class="headerlink" title="2 Redis 部署和使用"></a>2 Redis 部署和使用</h2><h3 id="2-1-RDBMS和NOSQL的各自优缺点"><a href="#2-1-RDBMS和NOSQL的各自优缺点" class="headerlink" title="2.1 RDBMS和NOSQL的各自优缺点"></a>2.1 RDBMS和NOSQL的各自优缺点</h3><p>Redis (Remote Dictionary Server) ：是一个开源的、键值数据库</p>
<p>Redis在高并发、低延迟方面很好</p>
<p>NOSQL的根本优势在于云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高</p>
<p>NOSQL的事务支持弱，join的操作弱，通用性差</p>
<p>官方网站：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis特性"><a href="#2-2-Redis特性" class="headerlink" title="2.2 Redis特性"></a>2.2 Redis特性</h3><ul>
<li>速度快：10W并发，C语言开发，单线程</li>
<li>持久化</li>
<li>支持多种数据结构</li>
<li>支持多种变成语言</li>
<li>功能丰富：支持Luau脚本，发布订阅，事务，pipeline等功能</li>
<li>简单：代码短小精悍（23000行左右代码）</li>
<li>主从复制</li>
<li>支持高可用和分布式</li>
</ul>
<h3 id="2-3-单线程"><a href="#2-3-单线程" class="headerlink" title="2.3 单线程"></a>2.3 单线程</h3><p>单线程为什么这么快？</p>
<ul>
<li>纯内存</li>
<li>非阻塞</li>
<li>避免线程切换和竟态消耗</li>
</ul>
<p>注意：</p>
<ul>
<li>一次只运行一条命令</li>
<li>拒绝长命令</li>
<li>其实不是单线程：早期是单线程，3版本后还有其他线程，fysnc file,descriptor,close file descriptor</li>
</ul>
<p>能用来解决问题的技术</p>
<ul>
<li>session共享</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>互联网的计数器，比如微博的点赞，排行榜</li>
<li>微博/微信社交场合：共同好友、粉丝数、关注、点赞等</li>
<li>消息队列</li>
<li>地理位置</li>
</ul>
<h3 id="2-4-Redis-安装和使用"><a href="#2-4-Redis-安装和使用" class="headerlink" title="2.4 Redis 安装和使用"></a>2.4 Redis 安装和使用</h3><p><strong>1.yum安装，需要epel源</strong></p>
<p><strong>2.Redis的编译安装</strong></p>
<h4 id="2-1-编译安装步骤"><a href="#2-1-编译安装步骤" class="headerlink" title="2.1 编译安装步骤"></a>2.1 编译安装步骤</h4><p>下载</p>
<p>下载地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;</span><br></pre></td></tr></table></figure>

<p>选择一个5.x版本的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf redis-5.0.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd redis-5.0.9</span><br><span class="line">make --PREFIX&#x3D;&#x2F;app&#x2F; install</span><br></pre></td></tr></table></figure>



<h4 id="2-2-内核参数修改"><a href="#2-2-内核参数修改" class="headerlink" title="2.2 内核参数修改"></a>2.2 内核参数修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn  #Redis需要511，系统默认是128，改成1024</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#操作</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">#操作</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">To fix this issue run the command &#39;echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent    _hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the     setting after a reboot. Redis must be restarted after THP is disabled (set to &#39;madvise&#39; or &#39;never&#39;).</span><br><span class="line">#操作</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">#添加</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br></pre></td></tr></table></figure>

<h4 id="2-3-配置文件修改"><a href="#2-3-配置文件修改" class="headerlink" title="2.3 配置文件修改"></a>2.3 配置文件修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">11 # 1k &#x3D;&gt; 1000 bytes</span><br><span class="line">12 # 1kb &#x3D;&gt; 1024 bytes</span><br><span class="line">13 # 1m &#x3D;&gt; 1000000 bytes</span><br><span class="line">14 # 1mb &#x3D;&gt; 1024*1024 bytes                                                    </span><br><span class="line">15 # 1g &#x3D;&gt; 1000000000 bytes</span><br><span class="line">16 # 1gb &#x3D;&gt; 1024*1024*1024 bytes</span><br><span class="line">#文档中关于数据单位的说明</span><br></pre></td></tr></table></figure>

<p>配置文件讲解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">protected-mode yes #默认开启，这个是管理其他主机登录本机redis数据库的安全设置，本机只有设置了bind地址或者配置了密码才能被登录</span><br><span class="line">port 6379  #监听端口，TCP</span><br><span class="line">daemonize yes  #是否后台使用守护进程运行，默认是前台执行的</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid  </span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;    #生成数据文件的存放目录</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br><span class="line">timeout 0 #客户端和redis服务端的连接超时时间，默认是0，表示永不超时</span><br><span class="line">requirepass centos #密码</span><br><span class="line">maxclients  100000   #最大连接数</span><br><span class="line">maxmemory &lt;bytes&gt;  #Redis使用的最大内存，单位为字节，0是不限制，建议设置为物理内存的一半</span><br><span class="line">					注意不要出现OOM，Out Of Memory</span><br><span class="line">supervised systemd #默认为no，如果想用systemd管理，就设置成systemd</span><br><span class="line"></span><br><span class="line">#主从复制相关的选项</span><br><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt; #配置主服务器的IP和端口</span><br><span class="line">masterauth &lt;master-password&gt; #如果主服务器开启requirepass了，那么从服务器也需要输入密码</span><br><span class="line">replica-read-only yes #从服务器默认为只读</span><br><span class="line">repl-diskless-sync no #实验阶段，不推荐使用，默认就是拒绝</span><br><span class="line">rename-command  #重命名一些危险的命令，相当于屏蔽掉命令，比如keys * ,flushdb,flushall</span><br><span class="line">appendonly no #默认是no，appendonly是一种类似二进制的日志方式，而且优先级高于默认的rdb方式，当启				用appendonly后，redis启动时会从aof文件恢复数据</span><br><span class="line">appendfilename &quot;appendonly.aof&quot; aof文件，目录是dir指定的</span><br><span class="line">appendfsync everysec #默认的，每秒钟写一次</span><br><span class="line">#appendfsync always  #这个是安全，每次修改数据库都会写入磁盘，但是性能差</span><br><span class="line">no-appendfsync-on-rewrite no #建议设置为yes，这个是说在append重写的时候是否可以继续写磁盘，默								认是no，最安全，可以写磁盘，但是会阻塞；</span><br><span class="line">								设置为yes会写在缓冲区内，等重新结束后才写磁盘，这个性能好，但是								会不安全，因为最多有30秒时间的数据可能会因为断电等原因写不进磁盘</span><br><span class="line">auto-aof-rewrite-percentage 100 #自动重写检测的百分比，因为rewrite会根据aof中的清理数据库操作，比如del,flushdb等来删除数据，缩小文件大小，同时数据也是安全的。这个值的意思是aof增长超过一倍，那么就执行一次重写操作。</span><br><span class="line">auto-aof-rewrite-min-size 64mb  #触发rewrite的最小文件大小</span><br><span class="line">auto-load-truncated yes  #是否加载由于某些原因导致的末尾异常的AOF文件（主进程被kill&#x2F;断电等），建议yes</span><br><span class="line"></span><br><span class="line">#集群相关：</span><br><span class="line">cluster-enabled yes #是否开启集群模式，默认是不开启的</span><br><span class="line">cluster-config-file nodes-6379.conf #由node节点自动生成的集群配置文件名称</span><br><span class="line">cluster-node-timeout 15000  #集群中node节点连接超时时间，单位ms，超过此时间，会踢出集群</span><br><span class="line">cluster-replica-validity-factor 10 #单位是 “次数” </span><br><span class="line">cluster-migration-barrier 1 #集群迁移屏障，一个主节点至少拥有一个正常工作的从节点，即如果主节点的slave节点								故障后会将多余的从节点分配到当前主节点称为其新的从节点</span><br><span class="line">cluster-require-full-coverage yes #建议为no</span><br><span class="line">cluster-replica-no-failover no #默认是no，建议no</span><br><span class="line"></span><br><span class="line">#慢日志相关：</span><br><span class="line">slowlog-log-slower-than 10000 #以微妙为单位的慢日志记录，这个是10ms</span><br><span class="line">slowlog-max-len 128  #最多记录多少条慢日志的保存队列长度，滚动更新。先进先出，队列固定长度</span><br></pre></td></tr></table></figure>

<p>额外介绍</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LRU means Least Recently Used</span><br><span class="line">LFU means Least Frequently Used</span><br></pre></td></tr></table></figure>

<p>使用systemd的方式启动redis-server  </p>
<p><strong>注意：这个service是redis6.x版本的，不同版本之间的差异还是有的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;下建立redis_6379.service文件</span><br><span class="line">  1 [Unit]</span><br><span class="line">  2 Description&#x3D;Redis persistent key-value database</span><br><span class="line">  3 Wants&#x3D;network-online.target</span><br><span class="line">  4 After&#x3D;network-online.target</span><br><span class="line">  5 </span><br><span class="line">  6 [Service]</span><br><span class="line">  7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;conf&#x2F;redis_6379.conf --supervised systemd</span><br><span class="line">  8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line">  9 Type&#x3D;forking         #重点是这里，6.X的redis要写成forKing，后台模式，不能写notify                                                                                                                        </span><br><span class="line"> 10 User&#x3D;redis</span><br><span class="line"> 11 Group&#x3D;redis</span><br><span class="line"> 12 TimeoutStartSec&#x3D;infinity</span><br><span class="line"> 13 TimeoutStopSec&#x3D;infinity</span><br><span class="line"> 14 [Install]</span><br><span class="line"> 15 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.4编译安装和参数修改和配置文件修改的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	install_redis_5.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line"></span><br><span class="line">BASEDIR&#x3D;&#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">VERSION&#x3D;redis-5.0.9</span><br><span class="line">APPDIR&#x3D;&#x2F;app&#x2F;redis</span><br><span class="line">PASSWORD&#x3D;&quot;centos&quot;</span><br><span class="line">START_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line"></span><br><span class="line">check_env () </span><br><span class="line">&#123;</span><br><span class="line">    id redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &#39;redis用户已存在，请检查环境&#39; false </span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ -f $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;.tar.gz ];then</span><br><span class="line">        action &#39;源码包已存在，请检查环境&#39; false </span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    if [ -d $APPDIR ];then</span><br><span class="line">        action &quot;$&#123;APPDIR&#125;已存在，请检查环境&quot; false</span><br><span class="line">        exit 3</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    action &quot;环境检查完成，开始安装$&#123;VERSION&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">install_redis () </span><br><span class="line">&#123;</span><br><span class="line">    yum -y install wget gcc jemalloc-devel  &amp;&gt;&#x2F;dev&#x2F;null || &#123; action &#39;依赖包安装失败&#39; false;exit 10;&#125;</span><br><span class="line">   </span><br><span class="line">    wget -P $&#123;BASEDIR&#125; https:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;$&#123;VERSION&#125;.tar.gz &amp;&gt;&#x2F;dev&#x2F;null || action &#39;下载源码包失败&#39; false</span><br><span class="line">    cd $&#123;BASEDIR&#125;</span><br><span class="line">    tar xf $&#123;VERSION&#125;.tar.gz </span><br><span class="line">    </span><br><span class="line">    cd $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125; </span><br><span class="line">    echo &quot;开始编译安装&quot;</span><br><span class="line">    echo &quot;...&quot;</span><br><span class="line">    make PREFIX&#x3D;$&#123;APPDIR&#125; install &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;编译安装成功!&quot; || &#123; action &quot;编译安装失败&quot; false;exit 4; &#125;</span><br><span class="line">    </span><br><span class="line">    mkdir -p $&#123;APPDIR&#125;&#x2F;&#123;etc,data,run,log&#125; </span><br><span class="line">    </span><br><span class="line">    useradd -r -s &#x2F;sbin&#x2F;nologin redis &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">   </span><br><span class="line">    ln -s $&#123;APPDIR&#125;&#x2F;bin&#x2F;*  &#x2F;usr&#x2F;local&#x2F;bin&#x2F; &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">    cp $&#123;BASEDIR&#125;&#x2F;$&#123;VERSION&#125;&#x2F;redis.conf $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.core.somaxconn &#x3D; 1024</span><br><span class="line">vm.overcommit_memory &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line">    sysctl -p</span><br><span class="line">    cat&gt;&gt;&#x2F;etc&#x2F;rc.d&#x2F;rc.local&lt;&lt;EOF</span><br><span class="line">echo madvise &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">EOF</span><br><span class="line">    chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">    sed -i -E &quot;s&#x2F;^daemonize no&#x2F;daemonize yes&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^(bind ).*&#x2F;\10.0.0.0&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s&#x2F;^supervised no&#x2F;supervised systemd&#x2F;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(pidfile).*#\1 $&#123;APPDIR&#125;&#x2F;run&#x2F;redis.pid#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(logfile).*#\1 $&#123;APPDIR&#125;&#x2F;log&#x2F;redis.log#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dbfilename).*#\1 dump.rdb#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;s#^(dir).*#\1 $&#123;APPDIR&#125;&#x2F;data&#x2F;#&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">    sed -i -E &quot;&#x2F;^# requirepass foobared&#x2F;a requirepass $&#123;PASSWORD&#125;&quot; $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf</span><br><span class="line">      </span><br><span class="line">    chown -R redis.redis $&#123;APPDIR&#125;</span><br><span class="line">    </span><br><span class="line">    cat&gt;&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Redis persistent key-value database</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;$&#123;APPDIR&#125;&#x2F;bin&#x2F;redis-server $&#123;APPDIR&#125;&#x2F;etc&#x2F;redis.conf --supervised systemd</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT \$MAINPID</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">User&#x3D;redis</span><br><span class="line">Group&#x3D;redis</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl start redis &amp;&gt;&#x2F;dev&#x2F;null &amp;&amp; action &quot;redis服务启动！&quot; || action &quot;redis服务启动失败，检查&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;redis.service，$&#123;APPDIR&#125;下的文件属性、配置文件&quot; false</span><br><span class="line">    END_TIME&#x3D;&#96;date +%s&#96;</span><br><span class="line">    USED_TIME&#x3D;$(( $END_TIME - $START_TIME ))    </span><br><span class="line">    echo &quot;脚本总用时：$&#123;USED_TIME&#125;s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_env</span><br><span class="line">install_redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.5写成playbook，使用角色实现</p>
<p><strong>3.Redis的多实例</strong></p>
<p>下面的这些选项中6379都改成其他端口，比如6380,6381等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;app&#x2F;redis&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis_6379.log</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">dir &#x2F;app&#x2F;redis&#x2F;data&#x2F;</span><br><span class="line">bind 0.0.0.0 或者#bind 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>做好的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 redis]$tree</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── redis-benchmark</span><br><span class="line">│   ├── redis-check-aof</span><br><span class="line">│   ├── redis-check-rdb</span><br><span class="line">│   ├── redis-cli</span><br><span class="line">│   ├── redis-sentinel -&gt; redis-server</span><br><span class="line">│   └── redis-server</span><br><span class="line">├── conf</span><br><span class="line">│   ├── redis_6379.conf</span><br><span class="line">│   ├── redis_6380.conf</span><br><span class="line">│   └── redis_6381.conf</span><br><span class="line">├── data</span><br><span class="line">├── log</span><br><span class="line">│   ├── redis_6379.log</span><br><span class="line">│   ├── redis_6380.log</span><br><span class="line">│   ├── redis_6381.log</span><br><span class="line">│   └── redis.log</span><br><span class="line">└── run</span><br><span class="line">    ├── redis_6379.pid</span><br><span class="line">    ├── redis_6380.pid</span><br><span class="line">    └── redis_6381.pid</span><br><span class="line"></span><br><span class="line">5 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改内核参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn &#x3D; 1024 #Redis默认511，linux默认是128，太小了，所以要调整大一点</span><br><span class="line"></span><br><span class="line">vm.overcommit_memory &#x3D; 1 #linux默认是0，Redis建议设置为1</span><br><span class="line"></span><br><span class="line">&#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39;  ，然后把这个加入到&#x2F;etc&#x2F;rc.local中，因为这个是sys目录下的变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;apps&#x2F;redis&#x2F;etc&#x2F;redis.conf  #</span><br></pre></td></tr></table></figure>



<h3 id="2-5-慢查询"><a href="#2-5-慢查询" class="headerlink" title="2.5 慢查询"></a>2.5 慢查询</h3><p>slowlog-log-slower-than 10000  #单位是微秒，这个是10ms的意思，Redis的慢是指超过10ms</p>
<p>配置文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128 </span><br></pre></td></tr></table></figure>

<p>命令行指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slowlog len</span><br><span class="line">slowlog get N #查看具体的慢查询，可以限制个数</span><br><span class="line">slowlog reset</span><br></pre></td></tr></table></figure>

<p>一个命令大约在5us</p>
<h3 id="2-5-Redis-持久化"><a href="#2-5-Redis-持久化" class="headerlink" title="2.5 Redis 持久化"></a>2.5 Redis 持久化</h3><p>持久化：按照一定的策略把Redis内存中的数据存放到磁盘中，从而实现数据持久保存的目的</p>
<p>目前Redis支持两种方式的数据持久化保存机制，分别是RDB和AOF</p>
<p>RDB ~ MYSQL DUMP  –&gt;快照</p>
<p>AOF ~ MYSQL BINLOG  –&gt;写日志</p>
<h4 id="2-5-1-RDB模式"><a href="#2-5-1-RDB模式" class="headerlink" title="2.5.1 RDB模式"></a>2.5.1 RDB模式</h4><p>Redis-Server –&gt; fork子进程[专门用于dump操作] –&gt; 临时文件[temp-‘子进程PID’] –&gt; 覆盖到dump文件</p>
<p>配置文件中选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 294 #   In the example below the behaviour will be to save:</span><br><span class="line"> 295 #   after 900 sec (15 min) if at least 1 key changed</span><br><span class="line"> 296 #   after 300 sec (5 min) if at least 10 keys changed</span><br><span class="line"> 297 #   after 60 sec if at least 10000 keys changed</span><br><span class="line">#这个是自动保存规则，通过条件触发RDB保存</span><br><span class="line"> 307 save 900 1</span><br><span class="line"> 308 save 300 10</span><br><span class="line"> 309 save 60 10000</span><br></pre></td></tr></table></figure>

<p>手动执行RDB</p>
<ul>
<li><pre><code>save --&gt; 直接进行RDB备份，备份目录是配置文件中写好的
#同步执行，但是会阻塞其他命令，不推荐使用
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* &#96;&#96;&#96;</span><br><span class="line">  bgsave --&gt; 异步后台执行，不影响其他命令的执行，推荐使用，使用的时候参考一个参数，rdb_bgsave_in_progress &#x3D; 0  是0的时候就是执行完成了</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>数据还原：</p>
<p>把数据文件名称改成配置文件中规定的文件名，然后重启服务</p>
<p><strong>优劣势：</strong></p>
<p>优点：</p>
<ul>
<li>就像快照，可以保存多个版本，恢复数据的时候可以选择恢复到哪个时间点</li>
<li>性能好，它可以使用子进程进行备份操作，父进程在fork出一个子进程后将不参与I/O，所以不影响本身的读写操作</li>
<li>RDB在恢复大量数据时比AOF快</li>
</ul>
<p>缺点：</p>
<ul>
<li>在断电等情况发生时，可能会丢失两次备份之间的内存数据</li>
<li>当数据量比较大时，父进程fork一个子进程需要一点时间，因为redis单线程，会阻塞</li>
</ul>
<p><strong>脚本：手动方式备份RDB文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#注意：使用RDB恢复数据就不要开启AOF</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	backup_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">. &#x2F;etc&#x2F;init.d&#x2F;functions</span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILE&#x3D;&quot;dump&quot;</span><br><span class="line">PASSWD&#x3D;&quot;centos&quot;</span><br><span class="line"></span><br><span class="line">#For test path</span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning bgsave</span><br><span class="line">[ -d $BACKDIR ] || mkdir -p $BACKDIR </span><br><span class="line"></span><br><span class="line">single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line"></span><br><span class="line">until [ $single -eq 0 ];do</span><br><span class="line">    sleep 1</span><br><span class="line">    single&#x3D;&#96;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-cli -a $PASSWD --no-auth-warning info Persistence | sed -nE &#39;&#x2F;rdb_bgsave&#x2F;s&#x2F;.*:([0-9]&#123;1,&#125;).*$&#x2F;\1&#x2F;p&#39;&#96;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">DATE&#x3D;&#96;date +%F_%H-%M_%S&#96;</span><br><span class="line">cp $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILE&#125;.rdb $BACKDIR&#x2F;$&#123;DATAFILE&#125;_$&#123;DATE&#125;.rdb </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>脚本：手动方式还原最新的数据文件到redis</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#Author:	lvzhehui</span><br><span class="line">#QQ:		734709865</span><br><span class="line">#Date:		2020-10-22</span><br><span class="line">#FileName:	recover_redis.sh</span><br><span class="line">#Descripting:	</span><br><span class="line">#Copyright (C):	2020 All rights reserved</span><br><span class="line">#</span><br><span class="line">#recover the latest rdb file </span><br><span class="line"></span><br><span class="line">BACKDIR&#x3D;&#x2F;backup&#x2F;redis</span><br><span class="line">DATADIR&#x3D;&#x2F;app&#x2F;redis&#x2F;data</span><br><span class="line">DATAFILENAME&#x3D;&quot;dump.rdb&quot;</span><br><span class="line"></span><br><span class="line">echo $PATH</span><br><span class="line"></span><br><span class="line">systemctl stop redis</span><br><span class="line"></span><br><span class="line">LASTEST_FILENAME&#x3D;&#96;ls -lt $&#123;BACKDIR&#125; | awk &#39;NR&#x3D;&#x3D;2&#123;print $NF&#125;&#39;&#96;  #找出最新的备份文件</span><br><span class="line"></span><br><span class="line">rm -f $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125; </span><br><span class="line"></span><br><span class="line">cp $&#123;BACKDIR&#125;&#x2F;$&#123;LASTEST_FILENAME&#125; $&#123;DATADIR&#125;&#x2F;$&#123;DATAFILENAME&#125;</span><br><span class="line"></span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-5-2-AOF模式"><a href="#2-5-2-AOF模式" class="headerlink" title="2.5.2 AOF模式"></a>2.5.2 AOF模式</h4><p><strong>AOF：AppendOnlyFile，按照顺序依次将操作追加到指定日志末尾</strong></p>
<p>fsync策略：</p>
<ul>
<li>每1秒钟写入一次文件；</li>
<li>每次变更数据时写入文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfsync everysec  #默认的everysec是每秒钟写入磁盘，改成always就是每次变更都写入文件</span><br></pre></td></tr></table></figure>

<p>默认是RDB，AOF需要开启配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;，数据文件的存放路径还是由 dir决定的</span><br></pre></td></tr></table></figure>

<p>AOF优先级比RDB高</p>
<p>从配置文件设定AOF启动后，重启服务时会使用AOF的数据文件，之前使用的RDB数据文件就没有被使用，因此有些问题。</p>
<p>正确的使用AOF的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.开启服务，默认使用RDB</span><br><span class="line">2.保存数据</span><br><span class="line">3.在命令行用config set appendonly yes 开启AOF</span><br><span class="line">4.观察数据目录中，是否已经将之前的RDB的数据文件写入AOF数据文件中了</span><br><span class="line">5.完成后，再去配置文件中启动AOF</span><br></pre></td></tr></table></figure>

<p>数据恢复操作：</p>
<p>在aof日志中删除之前的误操作动作，然后重启服务就好了</p>
<p><strong>AOF rewrite 重写</strong></p>
<p>将一些重复的，可以合并的，过期的数据重新写入一个新的AOF文件，从而节约AOF备份占用的硬盘空间，也能加速恢复过程</p>
<p>通过flushdb进行db0数据库的清空</p>
<p>bgwrite –&gt; 父进程 –&gt; fork一个子进程 –&gt; 子进程创建新的aof日志 –&gt; 父进程把rewrite数据写入新的aof日志 –&gt; 子进程把新的aof日志覆盖原来的aof日志</p>
<p>手动执行重新：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewriteaof</span><br></pre></td></tr></table></figure>

<p><strong>AOF的优缺点：</strong></p>
<p>优点：</p>
<ul>
<li>数据安全性高</li>
<li>写入日志的模式是追加的方式，更高效和安全</li>
<li>Redis可以在AOF文件体积变得过大时，自动地在后台对AOF进行重写，重写后的新AOF文件包含了恢复当前数据集的最小命令集合。整个重写过程是安全的，因为Redis是fork一个子进程来写入新的AOF日志，而append模式也就是父进程不断的将修改的数据追加到现有的AOF日志，即使重写过程发生停机，现有的AOF文件也不会丢失。而一旦新AOF文件创建完毕，Redis就会从旧AOF文件切换到新AOF文件，并开始对新AOF文件进行追加操作。</li>
<li>AOF包含一个格式清晰、易于理解的日志文件用于记录有所的修改操作。事实上，也可以通过该文件完成数据的重建。</li>
</ul>
<p>缺点：</p>
<ul>
<li>即使有些操作是重复的也会全部记录，AOF的文件大小要大于RDB模式的文件</li>
<li>AOF在恢复大数据集时的数据比RDB的恢复速度要慢</li>
<li>根据fsync策略不同，AOF速度可能慢于RDB</li>
<li>bug出现的可能性更多</li>
</ul>
<h3 id="2-6-Redis常用命令"><a href="#2-6-Redis常用命令" class="headerlink" title="2.6 Redis常用命令"></a>2.6 Redis常用命令</h3><p>官方文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;redis.io&#x2F;commands</span><br></pre></td></tr></table></figure>

<h4 id="2-6-1-INFO"><a href="#2-6-1-INFO" class="headerlink" title="2.6.1 INFO"></a>2.6.1 INFO</h4><p>获取信息</p>
<h4 id="2-6-2-SELECT"><a href="#2-6-2-SELECT" class="headerlink" title="2.6.2 SELECT"></a>2.6.2 SELECT</h4><h4 id="2-6-3-KEYS"><a href="#2-6-3-KEYS" class="headerlink" title="2.6.3 KEYS"></a>2.6.3 KEYS</h4><p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keys pattern</span><br><span class="line"></span><br><span class="line">例子</span><br><span class="line"></span><br><span class="line">keys * ......#这个是明令禁止的操作.....</span><br></pre></td></tr></table></figure>



<h4 id="2-6-4-BGSAVE"><a href="#2-6-4-BGSAVE" class="headerlink" title="2.6.4  BGSAVE"></a>2.6.4  BGSAVE</h4><h4 id="2-6-5-DBSIZE"><a href="#2-6-5-DBSIZE" class="headerlink" title="2.6.5 DBSIZE"></a>2.6.5 DBSIZE</h4><h4 id="2-6-6-FLUSHDB"><a href="#2-6-6-FLUSHDB" class="headerlink" title="2.6.6 FLUSHDB"></a><strong>2.6.6 FLUSHDB</strong></h4><h4 id="2-6-7-FLUSHALL"><a href="#2-6-7-FLUSHALL" class="headerlink" title="2.6.7 FLUSHALL"></a>2.6.7 FLUSHALL</h4><h4 id="2-6-8-SHUTDOWN"><a href="#2-6-8-SHUTDOWN" class="headerlink" title="2.6.8 SHUTDOWN"></a>2.6.8 SHUTDOWN</h4><p>禁用危险命令！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中找到rename-command</span><br><span class="line">配置：</span><br><span class="line">rename-command key* &#39;&#39;</span><br><span class="line">rename-command flushdb &#39;&#39;</span><br><span class="line">rename-command flushall &#39;&#39;</span><br></pre></td></tr></table></figure>



<h3 id="2-7-Redis的数据类型"><a href="#2-7-Redis的数据类型" class="headerlink" title="2.7 Redis的数据类型"></a>2.7 Redis的数据类型</h3><h4 id="2-7-1-字符串-string"><a href="#2-7-1-字符串-string" class="headerlink" title="2.7.1 字符串 string"></a>2.7.1 字符串 string</h4><p><strong>set命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set key value [ EX|PX ] time [NX|XX]</span><br><span class="line">EX：有效时间，单位是秒</span><br><span class="line">PX：有效时间，单位是毫秒</span><br><span class="line">NX：判断该键是否有值了，有值了就不动，没有值了才设置，XX相反</span><br></pre></td></tr></table></figure>

<p><strong>查看有效时间的命令ttl</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl key</span><br></pre></td></tr></table></figure>

<p><strong>get命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<p><strong>批量的命令mset，mget</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mget key1 key2 ..</span><br><span class="line">mset key1 value1 key2 value2...</span><br></pre></td></tr></table></figure>

<p><strong>字符串追加append，返回值是字节长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key1 ‘xxxxx’</span><br></pre></td></tr></table></figure>

<p><strong>返回字符串长度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<p><strong>设置新值，返回旧值getset</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getset key1 new_value</span><br><span class="line">return old_value</span><br></pre></td></tr></table></figure>

<p><strong>判断键是否存在</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key1</span><br></pre></td></tr></table></figure>

<p><strong>数值递增递减</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INCR KEY1  加1</span><br><span class="line">DECR KEY1  减1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数值增加/减少</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INCRBY KEY1 NUMBER</span><br><span class="line">incrby age 20</span><br><span class="line">incrby age -20</span><br><span class="line"></span><br><span class="line">DECRBY KEY1 NUMBER</span><br><span class="line">decrby age 20</span><br><span class="line">decrby age -20</span><br></pre></td></tr></table></figure>



<h4 id="2-7-2-列表-list"><a href="#2-7-2-列表-list" class="headerlink" title="2.7.2 列表 list"></a>2.7.2 列表 list</h4><p>lpush：从左侧开始往列表中增加元素</p>
<p>rpush：从右侧开始往列表中增加元素</p>
<p>lrange：</p>
<p>lindex：</p>
<p>lpop：</p>
<p>rpop：</p>
<p>ltrim</p>
<h4 id="2-7-3-集合-set"><a href="#2-7-3-集合-set" class="headerlink" title="2.7.3 集合 set"></a>2.7.3 集合 set</h4><p>集合是唯一的，不能重复</p>
<p>sadd</p>
<p>smembers</p>
<p>srem</p>
<p>集合间操作</p>
<p>sinter</p>
<p>sunion</p>
<p>sdiff</p>
<p>有序集合 sorted set： –&gt; 排行榜</p>
<ul>
<li>有序</li>
<li>无重复元素</li>
<li>每个元素由score和value组成</li>
<li>score可以重复</li>
<li>value不可以重复</li>
</ul>
<p>zadd</p>
<p>zrange music 0 -1  #取出全部元素  </p>
<p>zcard music  #取出元素个数</p>
<p>zscore music  #取出分值</p>
<p>zrank</p>
<p>zrem</p>
<h4 id="2-7-4-哈希-hash"><a href="#2-7-4-哈希-hash" class="headerlink" title="2.7.4 哈希 hash"></a>2.7.4 哈希 hash</h4><p>hset </p>
<p>hgetall</p>
<p>type</p>
<p>hget </p>
<p>hmget</p>
<p>hdel</p>
<h3 id="2-8-消息队列"><a href="#2-8-消息队列" class="headerlink" title="2.8 消息队列"></a>2.8 消息队列</h3><p>消息队列：把要传输的数据放在队列中</p>
<p>功能：可以实现多个系统之间解耦，异步，削峰/限流等</p>
<p>消息队列主要分为两种，Redis都支持：</p>
<ul>
<li>生产者消费者模式</li>
<li>发布者订阅者模式</li>
</ul>
<p>生产者消费者：</p>
<p>先生产，后消费</p>
<p>列表的push和pop技术，生产数据，被消费，消费一次数据就没了</p>
<p>发布者和订阅者：</p>
<p>先订阅，后发布</p>
<p>订阅</p>
<p>发布</p>
<p>频道</p>
<p>subscribe channel </p>
<p>publish channel message</p>
<p>psubscribe 10*  #psubscribe支持通配符</p>
<h2 id="3-Redis-高可用性和集群"><a href="#3-Redis-高可用性和集群" class="headerlink" title="3 Redis 高可用性和集群"></a>3 Redis 高可用性和集群</h2><p>解决单点问题；</p>
<p>解决单机性能瓶颈问题</p>
<p>Redis的中间件（代理）是开发自己写，实现读写分离</p>
<h3 id="3-1-Redis-主从复制"><a href="#3-1-Redis-主从复制" class="headerlink" title="3.1 Redis 主从复制"></a>3.1 Redis 主从复制</h3><p>Redis自带高可用方案</p>
<p>复制缓冲区大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 512mb #需要设置一个足够大的缓冲区大小，否则从服务在获取数据时无法获取完整数据</span><br></pre></td></tr></table></figure>

<p><strong>启用主从</strong></p>
<p>在从节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip port</span><br><span class="line">config set masterauth password</span><br></pre></td></tr></table></figure>



<p>在主节点设置密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set masterauth password</span><br><span class="line">#配置文件修改</span><br><span class="line">requirepass centos</span><br></pre></td></tr></table></figure>



<p>搭好主从之后，从节点自动变成只读，能读不能写</p>
<p>主从节点的配置文件一定要一致，因为Redis主从复制时是对命令的复现，主节点输入什么，从节点也输入什么，比如对命令的rename-command，一定要一致，否则你主节点rename了一个flushdb命令，变成了hahahaah，那么当主节点输入这个命令时，执行了清空命令，但是，从节点不识别hahahahah，所以从节点没有执行清空命令</p>
<p>runid是主从复制的关键点，每当主从某一方的runid发生改变，那么都会发生全量的复制</p>
<p>runid在Redis服务重启后会重新生成一个新的</p>
<p>查看主从复制的信息：info replication</p>
<p>写入Redis的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicaof master_ip</span><br><span class="line"></span><br><span class="line">masterauth passwd</span><br></pre></td></tr></table></figure>



<p><strong>主从同步过程：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.从服务连接主服务器，发送PSYNC命令</span><br><span class="line"></span><br><span class="line">2.主服务器接收到PSYNC命令后，开始执行BGSAVE命令生成RDB快照文件并使用缓冲区记录这个记录点之后的所有写类型</span><br><span class="line"></span><br><span class="line">3.主服务器BGSAVE执行完成后，向所有从服务器发送RDB快照文件，并在发送期间继续记录被执行的写命令</span><br><span class="line"></span><br><span class="line">4.从服务器收到快照文件后丢弃所有旧数据，载入收到的快照到内存</span><br><span class="line"></span><br><span class="line">5.主服务器快照发送完毕后，开始向服务器发送缓冲区中的写命令</span><br><span class="line"></span><br><span class="line">6.从服务器完成对快照的载入，开始接收读命令请求，并执行来自主服务器缓冲区的命令</span><br><span class="line"></span><br><span class="line">7.后期同步会先发送自己salve_repl_offset位置，只同步新增加的数据，不再全量同步</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205309861.png" alt="image-20201022205309861"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205320223.png" alt="image-20201022205320223"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205326907.png" alt="image-20201022205326907"></p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205347005.png" alt="image-20201022205347005"></p>
<p>复制缓冲区（环形队列）</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201022205354193.png" alt="image-20201022205354193"></p>
<p>复制缓冲区（环形队列）的配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 1mb</span><br><span class="line"></span><br><span class="line">repl-backlog-ttl 3600</span><br></pre></td></tr></table></figure>



<h4 id="3-1-1-主从复制的优化："><a href="#3-1-1-主从复制的优化：" class="headerlink" title="3.1.1 主从复制的优化："></a><strong>3.1.1 主从复制的优化：</strong></h4><p>1.复制缓冲区尽量大，因为它承载着全量复制开始后写入主节点的数据</p>
<p>2.避免全量复制，第一次的全量复制不可避免，之后的可能产生全量复制的操作，比如主节点重启导致RUNID改变引起的复制或者是复制缓冲区小，导致主节点临时写入的、超出缓冲区的数据没有复制给从节点而导致的全量复制等情况要避免，可以使用哨兵或者Cluster</p>
<p>3.避免复制风暴，比如一个主，三个从，当主节点重启服务后启动，会让三个从节点同时去复制数据，造成大量数据传输，可以使用级联架构。</p>
<h3 id="3-2-哨兵-Sentinel"><a href="#3-2-哨兵-Sentinel" class="headerlink" title="3.2 哨兵 Sentinel"></a>3.2 哨兵 Sentinel</h3><p>功能：高可用，当主节点宕机，自动提升一个从节点为主节点</p>
<p>版本选择：在redis的2.8版本后sentinel就稳定了，生产环境建议使用2.8之后的redis</p>
<p><strong>使用的协议：流言协议(gossip protocols)来接收关于Master是否下线的消息，投票协议(Agreement Protocols)来决定否是执行自动故障迁移，以及选择哪个Slave作为新的Master</strong></p>
<p>一台主机可以被多个哨兵监控</p>
<p>哨兵可以监控多组主从；</p>
<p><strong>哨兵的故障转移步骤：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.多个sentinel发现并确认master有问题</span><br><span class="line">2.选举出一个sentinel作为领导</span><br><span class="line">3.选出一个salve作为master</span><br><span class="line">4.通知其余slave成为新master的slave</span><br><span class="line">5.通知客户端主从变换</span><br><span class="line">6.老的master修好重启后，将会成为新master的slave</span><br></pre></td></tr></table></figure>

<p>每个主从集群组要有一个名字，不同组的名字不能一样，否则sentinel无法识别；</p>
<blockquote>
<p> 主观down：SDOWN SubjectDown</p>
<p>客观down：ODOWN  ObjectDown</p>
<p>哨兵个数要设定为奇数个，防止脑裂</p>
</blockquote>
<blockquote>
<p>Sentinel实际上是一个特殊的redis服务器，有些redis指令支持，但更多的指令是不支持的。</p>
<p>默认监听端口：26379/TCP</p>
<p>Sentinel可以不和Redis服务器部署在一起，但一般部署在一起，所有Redis节点使用相同的配置</p>
</blockquote>
<p>哨兵的定时任务：</p>
<ul>
<li>每10s每个sentinel对master和slave执行info，发现节点的主从关系</li>
<li>每2s每个sentinel通过master节点的channel交换信息(pub/sub)，通过sentinel_:hello频道交互对节点的“看法”和自身信息</li>
<li>每1秒每个sentinel对其他sentinel和redis执行ping</li>
</ul>
<h4 id="3-2-1-实现主服务器的切换"><a href="#3-2-1-实现主服务器的切换" class="headerlink" title="3.2.1 实现主服务器的切换"></a>3.2.1 实现主服务器的切换</h4><p>操作：</p>
<blockquote>
<p>1.搭建主从，从节点比主节点多了一步，就是把主节点IP填写上<br>2.配置哨兵，哨兵可以理解为另一个redis-server，哨兵和客户端是发布-订阅模式</p>
</blockquote>
<p>1.搭建主从：一主两从</p>
<p>主节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>从节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">replicaof 10.0.0.7 6379</span><br><span class="line">masterauth centos</span><br></pre></td></tr></table></figure>

<p>配置完成后，检查info信息，可以看到replication列表中有很多相关信息</p>
<p>哨兵的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim redis-sentinel.conf</span><br><span class="line">...</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">logfile &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis-sentinel.log</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 10.0.0.7 2 #最后的选项“2”，是投票选项，有两个哨兵认为主节点宕机了，那哨兵们就都认为它宕机了</span><br><span class="line"></span><br><span class="line">sentinel auth-pass mymaster password</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 3000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1 #当故障发生后，提拔了新的主节点后，新的主节点会按照这个选项，允许同时有几个从节点可以进行复制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-cli -a centos -p 26379 </span><br><span class="line"></span><br><span class="line">看到sentinel的数量与之前设置的sentinel数量匹配才是设置正确</span><br></pre></td></tr></table></figure>

<p>编译安装的redis的哨兵配置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;local&#x2F;src&#x2F;redis-5.0.9&#x2F;sentinel.conf &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br><span class="line">chown redis.redis &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf</span><br></pre></td></tr></table></figure>

<p>开启哨兵的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;redis-server &#x2F;etc&#x2F;sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<p>写一个service文件，参考redis.service的写法，只要改一下启动项就行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervised systemd</span><br></pre></td></tr></table></figure>

<p>完整的哨兵启动服务文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1 [Unit]</span><br><span class="line"> 2 Description&#x3D;Redis Sentinel</span><br><span class="line"> 3 Wants&#x3D;network-online.target</span><br><span class="line"> 4 After&#x3D;network-online.target</span><br><span class="line"> 5 </span><br><span class="line"> 6 [Service]</span><br><span class="line"> 7 ExecStart&#x3D;&#x2F;app&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;app&#x2F;redis&#x2F;etc&#x2F;sentinel.conf --sentinel --supervis    ed systemd</span><br><span class="line"> 8 ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line"> 9 Type&#x3D;notify</span><br><span class="line">10 User&#x3D;redis</span><br><span class="line">11 Group&#x3D;redis</span><br><span class="line">12                                                                                         </span><br><span class="line">13 [Install]</span><br><span class="line">14 WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登录sentinel的方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 </span><br></pre></td></tr></table></figure>

<p>查看sentinel的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name&#x3D;mymaster,status&#x3D;ok,address&#x3D;10.0.0.7:6379,slaves&#x3D;2,sentinels&#x3D;3</span><br></pre></td></tr></table></figure>



<p>使用命令让一个主节点下线，实现切换主从</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 26379 sentinel failover mymaster </span><br></pre></td></tr></table></figure>

<p>通过这个命令实现了把当前主服务器变成从服务器，提升一个原本的从服务器为主服务器！</p>
<blockquote>
<p>而且sentinel可以修改redis的配置文件，这点很好！</p>
</blockquote>
<h4 id="3-2-2-应用程序连接sentinel"><a href="#3-2-2-应用程序连接sentinel" class="headerlink" title="3.2.2 应用程序连接sentinel"></a>3.2.2 应用程序连接sentinel</h4><p>因为涉及到主节点的改变，所以程序在写入数据时需要动态获取主节点IP，这一点可以通过让客户端连接哨兵，因为哨兵是可以动态获取主服务器IP地址的，所以客户端只需要一直与哨兵联系就能获得实时的主服务器地址，那么这时候就客户端和哨兵之间就可以使用：订阅者-发布者模式。客户端订阅哨兵的频道，哨兵有新消息就发送到频道。</p>
<p>例如使用Python写的连接哨兵的客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3 python3-redis</span><br><span class="line"></span><br><span class="line">  1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">  2 </span><br><span class="line">  3 import redis</span><br><span class="line">  4 </span><br><span class="line">  5 from redis.sentinel import Sentinel                                            </span><br><span class="line">  6 </span><br><span class="line">  7 sentinel &#x3D; Sentinel([(&#39;10.0.0.7&#39;, 26379),</span><br><span class="line">  8                      (&#39;10.0.0.101&#39;, 26379),</span><br><span class="line">  9                      (&#39;10.0.0.110&#39;, 26379)],</span><br><span class="line"> 10                     socket_timeout &#x3D; 0.5)</span><br><span class="line"> 11 redis_auth_pass &#x3D; &#39;centos&#39;</span><br><span class="line"> 12 master &#x3D; sentinel.discover_master(&#39;mymaster&#39;)</span><br><span class="line"> 13 print(master)</span><br><span class="line"> 14 </span><br><span class="line"> 15 slave &#x3D; sentinel.discover_slaves(&#39;mymaster&#39;)</span><br><span class="line"> 16 print(slave)</span><br><span class="line"> 17 </span><br><span class="line"> 18 master &#x3D; sentinel.master_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 19                              password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 20 w_ret &#x3D; master.set(&#39;name&#39;, &#39;huihui&#39;)</span><br><span class="line"> 21 </span><br><span class="line"> 22 slave &#x3D; sentinel.slave_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5,</span><br><span class="line"> 23                            password &#x3D; redis_auth_pass, db &#x3D; 0)</span><br><span class="line"> 24 r_ret &#x3D; slave.get(&#39;name&#39;)</span><br><span class="line"> 25 print(r_ret)</span><br><span class="line"></span><br><span class="line">➜  ~ redis-cli -a centos</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-3-Redis-Cluster集群"><a href="#3-3-Redis-Cluster集群" class="headerlink" title="3.3 Redis Cluster集群"></a>3.3 Redis Cluster集群</h3><p>功能：解决单机写入的瓶颈问题</p>
<p>1.之前使用各个中间件：中间件本身存在单点失败问题</p>
<p>2.Redis 3.0之后推出了Cluster，无中心，每个节点保存当前节点数据和整个集群状态，每个节点都和其他所有节点连接。其实就是cluster集成在了redis程序中，需要使用的时候选择开启cluster模式，那么开启了cluster模式的redis就组成了cluster。因此客户端软件中只要写入了所有redis服务器的地址，就能够实现不需要一个管理服务器而以集群的方式访问redis数据库</p>
<p>Redis Cluster的特点：</p>
<ul>
<li>所有Redis节点使用PING机制互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点检测都失效，才能算真正的失效</li>
<li>客户端不需要proxy就可以直接连接redis，但是客户端中需要配置全部的redis服务器的IP</li>
<li>redis cluster把所有的redis node平均映射到0-16383个槽位(slot)上，读写需要到指定的redis node上进行操作，因此有多少个redis node就相当于redis并发扩展了多少倍，每个redis node承担 16384/N个槽位，当然这个得工程师自己设置分配的大小</li>
<li>Redis Cluster程序预先分配16384个槽位，当需要在redis集群中写入一个键值对的时候，会使用<strong>CRC16(key) mod 16384</strong> 来得出这个key的放置槽位应该是哪个，从而根据工程师自己分配的槽位和节点的关系来知道把这个键值对放置到哪个node服务器上，从而有效解决了单机瓶颈问题</li>
<li>Redis Cluster只是解决了单机瓶颈问题，但是在高可用方面还没解决，可以通过对每一个节点设置主从复制来解决这个问题，它也可以实现主服务器宕机自动提升从服务器为主的操作</li>
</ul>
<p><strong>注意：槽位是个逻辑概念，真实的数据还是在redis服务器上</strong></p>
<p>Cluster的执行过程</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201024192759734.png" alt="image-20201024192759734"></p>
<h4 id="3-3-1-Cluster集群的实现"><a href="#3-3-1-Cluster集群的实现" class="headerlink" title="3.3.1 Cluster集群的实现"></a>3.3.1 Cluster集群的实现</h4><p>Cluster实现：</p>
<ul>
<li>多个主，解决单点写入失败问题和单点性能瓶颈问题</li>
<li>每个主都建立一个从，实现主从复制，并且cluster支持主宕机自动切换主从</li>
</ul>
<p>Cluster的部署有多种方式：</p>
<ul>
<li>原生命令安装，用于理解Redis Cluster架构，生产环境就不推荐了</li>
<li>官方工具安装，高效、快速，生产环境可以用</li>
<li>自主开发工具，可以实现可视化的自动化部署</li>
</ul>
<h4 id="操作：使用原生命令部署"><a href="#操作：使用原生命令部署" class="headerlink" title="操作：使用原生命令部署"></a>操作：使用原生命令部署</h4><p>1.六个节点，三主三从</p>
<p>2.cluster中只有数据库0，分成了16384个槽位（slot）2^14</p>
<p>3.每个主节点承担 16384 / 3 个槽位</p>
<p>4.还需要用Python写客户端，用来连接服务器</p>
<p>5.扩容、缩容需要先删除源数据，然后扩容、缩容，再然后重新导入数据</p>
<p>6.原生命令手动部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">部署redis，全部节点开启cluster</span><br><span class="line">meet命令：先开会</span><br><span class="line">给每个节点分配槽位</span><br><span class="line">确立每个节点的主从关系</span><br></pre></td></tr></table></figure>

<p><strong>1.部署redis，全部节点开启cluster，其他的bind，requirepass，masterauth也需要有，这里没记录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &#39;&#x2F;# cluster-enabled yes&#x2F;a cluster-enabled yes&#39; -e &#39;&#x2F;cluster-enabled yes&#x2F;a cluster-config-file nodes-6379.conf&#39; -e &#39;&#x2F;# cluster-require-full-coverage yes&#x2F;a cluster-require-full-coverage no&#39;  &#x2F;app&#x2F;redis&#x2F;etc&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>先监控日志，然后启动redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;app&#x2F;redis&#x2F;log&#x2F;redis.log #开多个ssh窗口，一个监控日志，一个执行命令</span><br><span class="line">systemctl start redis</span><br><span class="line"></span><br><span class="line">#查看到日志中：</span><br><span class="line"> 1705                 _._                                                  </span><br><span class="line"> 1706            _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line"> 1707       _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 5.0.9 (00000000&#x2F;0) 64 bit</span><br><span class="line"> 1708   .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> 1709  (    &#39;      ,       .-&#96;  | &#96;,    )     Running in cluster mode  #重点是这个，cluster mode</span><br><span class="line"> 1710  |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 6379</span><br><span class="line"> 1711  |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 2607</span><br><span class="line"> 1712   &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1713  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1714  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line"> 1715   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1716  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> 1717  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line"> 1718   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> 1719       &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line"> 1720           &#96;-._        _.-&#39;                                           </span><br><span class="line"> 1721               &#96;-.__.-&#39;                                                </span><br><span class="line">2607:M 24 Oct 2020 14:38:07.058 * Ready to accept connections</span><br><span class="line">2607:M 24 Oct 2020 14:38:09.143 # Cluster state changed: ok</span><br><span class="line"></span><br><span class="line">redis-cli -a centos info cluster</span><br><span class="line"></span><br><span class="line"># Cluster</span><br><span class="line">cluster_enabled:1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.meet，认识Cluster中的其他成员</strong></p>
<p>通过一台node就可以设置全部的node，meet具有传播性，A meet B，那么A接下来meet其他主机，B也就都知道了，因此这个命令操作5次就可以了</p>
<p>记得在操作前检查是否已经存在日志文件，如果有记得先备份了，然后删除日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.7 -a centos --no-auth-warning cluster meet 10.0.0.101 6379</span><br></pre></td></tr></table></figure>

<p>查看cluster命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster help</span><br><span class="line"> 1) CLUSTER &lt;subcommand&gt; arg arg ... arg. Subcommands are:</span><br><span class="line"> 2) ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.</span><br><span class="line"> 3) BUMPEPOCH -- Advance the cluster config epoch.</span><br><span class="line"> 4) COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports for &lt;node-id&gt;.</span><br><span class="line"> 5) COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys in &lt;slot&gt;.</span><br><span class="line"> 6) DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.</span><br><span class="line"> 7) FAILOVER [force|takeover] -- Promote current replica node to being a master.</span><br><span class="line"> 8) FORGET &lt;node-id&gt; -- Remove a node from the cluster.</span><br><span class="line"> 9) GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node in a slot.</span><br><span class="line">10) FLUSHSLOTS -- Delete current node own slots information.</span><br><span class="line">11) INFO - Return onformation about the cluster.</span><br><span class="line">12) KEYSLOT &lt;key&gt; -- Return the hash slot for &lt;key&gt;.</span><br><span class="line">13) MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.</span><br><span class="line">14) MYID -- Return the node id.</span><br><span class="line">15) NODES -- Return cluster configuration seen by node. Output format:</span><br><span class="line">16)     &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;</span><br><span class="line">17) REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.</span><br><span class="line">18) RESET [hard|soft] -- Reset current node (default: soft).</span><br><span class="line">19) SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.</span><br><span class="line">20) SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.</span><br><span class="line">21) REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.</span><br><span class="line">22) SLOTS -- Return information about slots range mappings. Each range is made of:</span><br><span class="line">23)     start, end, master and replicas IP addresses, ports and ids</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>meet后的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603526520177 1 connected</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603526520000 0 connected</span><br><span class="line">735a7e7371db2986b860248e26b2028f9d57df69 10.0.0.7:6379@16379 myself,master - 0 1603526522000 5 connected</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603526523234 2 connected</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603526521198 3 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603526522211 4 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.给每个节点分配槽位</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p password -a centos cluster addslots slotId</span><br><span class="line">#使用上面的命令一个一个的加很费劲，写一个脚本加</span><br><span class="line"></span><br><span class="line">#槽位的分配可以平均分配，我们是3个主3个从节点，那么就分三份，因为从节点只用来主从，不使用写操作</span><br></pre></td></tr></table></figure>

<p>写一个分配槽位的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;bin&#x2F;bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3 #</span><br><span class="line"> 4 #Author:    lvzhehui</span><br><span class="line"> 5 #QQ:        734709865</span><br><span class="line"> 6 #Date:      2020-10-24</span><br><span class="line"> 7 #FileName:  redis_allocate_slots.sh</span><br><span class="line"> 8 #Descripting:   </span><br><span class="line"> 9 #Copyright (C): 2020 All rights reserved</span><br><span class="line">10 </span><br><span class="line">11 #need three arguments,$1 for IP, $2 for start position, $3 for stop position</span><br><span class="line">12 HOST&#x3D;&#39;&#39;</span><br><span class="line">13 PORT&#x3D;6379</span><br><span class="line">14 PASSWORD&#x3D;&#39;centos&#39;</span><br><span class="line">15 HOST&#x3D;$1</span><br><span class="line">16 START_POSITION&#x3D;$2</span><br><span class="line">17 STOP_POSITION&#x3D;$3</span><br><span class="line">18 </span><br><span class="line">19 for ((SLOTID&#x3D;$START_POSITION;SLOTID&lt;&#x3D;$STOP_POSITION;SLOTID++));                      </span><br><span class="line">20 do</span><br><span class="line">21     echo &quot;slot:$SLOTID&quot; </span><br><span class="line">22     redis-cli -h $HOST -p $PORT -a $PASSWORD --no-auth-warning cluster addslots \</span><br><span class="line">23         $SLOTID</span><br><span class="line">24 done</span><br><span class="line">25 </span><br><span class="line">26 #other method</span><br><span class="line">27 </span><br><span class="line">28 #for SLOTID in &#96;seq $2 $3&#96;;do</span><br><span class="line">29 # xxxxx</span><br><span class="line">30 #done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用脚本进行分配：0<del>5461 5462</del>10922 10923~16383</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash redis_allocate_slots.sh 10.0.0.7 0 5461</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.101 5462 10992</span><br><span class="line">bash redis_allocate_slots.sh 10.0.0.7 10993 10683</span><br></pre></td></tr></table></figure>

<p>如果错误了，执行这两个命令清除本节点的槽位，并且让其他节点忘记自己，或者把全部的Cluster生成的Node-6379.conf文件删除，重启服务，然后重新添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#进入redis，注意情况槽位命令是在本槽位执行，忘记节点的命令是在其他所有节点都要执行，然后本节点重新meet</span><br><span class="line">cluster flushslots</span><br><span class="line"></span><br><span class="line">cluster forget nodeId</span><br></pre></td></tr></table></figure>

<p>槽位分配完成后查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531283731 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 master - 0 1603531284755 3 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531284000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 master - 0 1603531285000 0 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 master - 0 1603531285771 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531286786 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>4.确定主从关系</strong></p>
<p>使用下面的命令，把当前节点设置为该Node号对应的redis的从节点</p>
<p>比如第一个：让11节点变成bee1594fe4100436e04459ff516c2f52ebe18f41对应的redis服务器的从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.0.11 -a centos --no-auth-warning cluster replicate bee1594fe4100436e04459ff516c2f52ebe18f41</span><br></pre></td></tr></table></figure>

<p>执行完成的效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">5a2604519a94555225231bacdbef54f9f41be38a 10.0.0.110:6379@16379 master - 0 1603531877891 2 connected 10993-16383</span><br><span class="line">0ba277b6d109ffddf4e16a51fd57df7d61b72cf6 10.0.0.11:6379@16379 slave bee1594fe4100436e04459ff516c2f52ebe18f41 0 1603531876000 6 connected</span><br><span class="line">bee1594fe4100436e04459ff516c2f52ebe18f41 10.0.0.7:6379@16379 myself,master - 0 1603531876000 6 connected 0-5461</span><br><span class="line">e1e734120de8e23eb4ed8b38ee7da0c677b96c88 10.0.0.13:6379@16379 slave 5a2604519a94555225231bacdbef54f9f41be38a 0 1603531876873 2 connected</span><br><span class="line">343ba8d9b372526ed59aa8dd8aae614d6766d129 10.0.0.12:6379@16379 slave 1ff2c9229779ea27d54890a9adda44b80e199157 0 1603531876000 4 connected</span><br><span class="line">1ff2c9229779ea27d54890a9adda44b80e199157 10.0.0.101:6379@16379 master - 0 1603531875848 1 connected 5462-10992</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试cluster的写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name huihui</span><br><span class="line">(error) MOVED 5798 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set k1 huihui</span><br><span class="line">(error) MOVED 12706 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set k2 huihui</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;huihui&quot;</span><br><span class="line"></span><br><span class="line">#根据Key的不同，放入不同的槽位</span><br></pre></td></tr></table></figure>

<p>cluster中有关键和槽位的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster keyslot keyname</span><br><span class="line">#返回这个键存储在哪个槽位中</span><br><span class="line"></span><br><span class="line">cluster getkeysinslot slot 1  </span><br><span class="line">#返回本节点的某个槽位中是什么键</span><br></pre></td></tr></table></figure>

<p>如果想不去重定向寻找的话，可以在redis-cli后跟-c选项，这个选项可以自动重定向到指定redis服务器寻找键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br></pre></td></tr></table></figure>

<p>如果要从从节点上查看数据，需要开启readonly选项，这个选项是专门开启集群中的从节点的读模式的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help readonly</span><br><span class="line"></span><br><span class="line">  READONLY -</span><br><span class="line">  summary: Enables read queries for a connection to a cluster replica node</span><br><span class="line">  since: 3.0.0</span><br><span class="line">  group: cluster</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试主从切换：</p>
<p>关闭10.0.0.7的redis服务，然后他的从节点11在10s左右后，成为了主节点，并继承了7的槽位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1598:S 24 Oct 2020 17:53:40.651 * Connecting to MASTER 10.0.0.7:6379</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.652 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.654 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.961 # Starting a failover election for epoch 7.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # Failover election won: I&#39;m the new master.</span><br><span class="line">1598:S 24 Oct 2020 17:53:40.981 # configEpoch set to 7 after successful failover</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 # Setting secondary replication ID to 6d95441d58cb6f12eb56b1bc5495434fb08f3f57, valid up to offset: 2073. New replication ID is a01291fd6ff422a13139bc5fa71f17687845f37e</span><br><span class="line">1598:M 24 Oct 2020 17:53:40.981 * Discarding previously cached master state.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>恢复了7后，7成了11的从节点！</p>
<p><strong>redis涉及到的几个端口：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis:6379</span><br><span class="line">sentinel:26379</span><br><span class="line">cluster:16379</span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-5-0部署Cluster"><a href="#操作：使用Redis-5-0部署Cluster" class="headerlink" title="操作：使用Redis 5.0部署Cluster"></a>操作：使用Redis 5.0部署Cluster</h4><p>需要使用到的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br></pre></td></tr></table></figure>

<p><strong>注意：在操作前先监控日志</strong></p>
<p>部署要求：</p>
<ul>
<li>每个redis节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何书籍</li>
<li>先启动为单机redis且没有任何key value</li>
</ul>
<p>1.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster create 10.0.0.7:6379 10.0.0.101:6379 10.0.0.110:6379 1</span><br><span class="line">0.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line">#命令说明：</span><br><span class="line">--cluster create  表示创建集群</span><br><span class="line">后面跟着的主机名:端口，表示要加入集群的主机和端口</span><br><span class="line">--cluster-replicas 1  表示集群中主从复制，并且每个主节点配合一个从节点</span><br><span class="line">cluster会自动把前面三个变成主节点，后面三个变成从节点</span><br></pre></td></tr></table></figure>

<p>创建的过程中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383                       #分配槽位</span><br><span class="line">Adding replica 10.0.0.12:6379 to 10.0.0.7:6379</span><br><span class="line">Adding replica 10.0.0.13:6379 to 10.0.0.101:6379</span><br><span class="line">Adding replica 10.0.0.11:6379 to 10.0.0.110:6379       #分配主从节点</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept):  #需要接受或拒绝</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完成的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">........</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)</span><br><span class="line">M: 4566b927c1fa4d183de1e510300b27fe0fe3d96d 10.0.0.7:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 118ef9055d7465fbc6ba7999beaacf69b3892ad6 10.0.0.11:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15</span><br><span class="line">M: 6f7e7f5b60d527c9cb9f4a643f10b461d57d5b15 10.0.0.110:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 85b6872df50db7e8644b855cebd0a3ee3656e20f 10.0.0.13:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 276433f13427e2476a0b650b5b591397c06647e7</span><br><span class="line">M: 276433f13427e2476a0b650b5b591397c06647e7 10.0.0.101:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 819d053d78d249570b5bd610436fdb0e4ac59627 10.0.0.12:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4566b927c1fa4d183de1e510300b27fe0fe3d96d</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看当前的集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6           #节点个数</span><br><span class="line">cluster_size:3                  #主节点个数，也是主从对的个数</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:92</span><br><span class="line">cluster_stats_messages_pong_sent:94</span><br><span class="line">cluster_stats_messages_sent:186</span><br><span class="line">cluster_stats_messages_ping_received:89</span><br><span class="line">cluster_stats_messages_pong_received:92</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:186</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试多个主节点分别写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set huihui jiayou</span><br><span class="line">(error) MOVED 16071 10.0.0.110:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota haowan</span><br><span class="line">(error) MOVED 7267 10.0.0.101:6379</span><br><span class="line">127.0.0.1:6379&gt; set dota2 haowan</span><br><span class="line">(error) MOVED 14116 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>测试主从的切换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关闭主节点7，看它的从节点11会怎么样</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.826 # Starting a failover election for epoch 7.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # Failover election won: I&#39;m the new master.</span><br><span class="line">1688:S 24 Oct 2020 19:33:23.837 # configEpoch set to 7 after successful failover</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 # Setting secondary replication ID to 1786540a1dc01f327cbde7f520591090c96a9f4d, valid up to offset: 715. New replication ID is 6e95b3f60a28e9510a43da88105357924d1e344d</span><br><span class="line">1688:M 24 Oct 2020 19:33:23.837 * Discarding previously cached master state.</span><br><span class="line">切换成功！</span><br></pre></td></tr></table></figure>

<p>写一个可以向集群写入数据的Python脚本：用redis-cli -c 可能更方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line"> 2 </span><br><span class="line"> 3 from rediscluster import RedisCluster</span><br><span class="line"> 4 startup_nodes &#x3D; [</span><br><span class="line"> 5     &#123;&quot;host&quot;:&quot;10.0.0.7&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 6     &#123;&quot;host&quot;:&quot;10.0.0.101&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 7     &#123;&quot;host&quot;:&quot;10.0.0.110&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 8     &#123;&quot;host&quot;:&quot;10.0.0.11&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line"> 9     &#123;&quot;host&quot;:&quot;10.0.0.12&quot;, &quot;port&quot;:6379&#125;,</span><br><span class="line">10     &#123;&quot;host&quot;:&quot;10.0.0.13&quot;, &quot;port&quot;:6379&#125;</span><br><span class="line">11 ]</span><br><span class="line">12 redis_conn &#x3D; RedisCluster(startup_nodes &#x3D; startup_nodes, password &#x3D; &#39;centos&#39;, \</span><br><span class="line">13                          decode_responses &#x3D; True)</span><br><span class="line">14 </span><br><span class="line">15 for i in range(0, 10000):</span><br><span class="line">16     redis_conn.set(&#39;huihuide&#39; + str(i), &#39;xinxinde&#39; + str(i))</span><br><span class="line">17     print(&#39;huihuide&#39; + str(i) + &#39;:&#39;, redis_conn.get(&#39;huihuide&#39; + str(i)) )</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="操作：使用Redis-4-x-部署Cluster"><a href="#操作：使用Redis-4-x-部署Cluster" class="headerlink" title="操作：使用Redis 4.x 部署Cluster"></a>操作：使用Redis 4.x 部署Cluster</h4><p>1.编译安装，用ansible安装一遍</p>
<p>使用了ansible的角色，角色目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  redis tree</span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── redis-4.0.14.tar.gz</span><br><span class="line">│   └── redis_arguments.sh</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── copy_redis_config.yml</span><br><span class="line">│   ├── copy_redis_service.yml</span><br><span class="line">│   ├── groupadd.yml</span><br><span class="line">│   ├── homedir.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── make_install.yml</span><br><span class="line">│   ├── modify_arguments.yml</span><br><span class="line">│   ├── start_redis.yml</span><br><span class="line">│   ├── symbolic_link.yml</span><br><span class="line">│   ├── unarchive.yml</span><br><span class="line">│   └── useradd.yml</span><br><span class="line">└── templates</span><br><span class="line">    ├── redis.conf.j2</span><br><span class="line">    ├── redis.service.j2</span><br><span class="line">    └── sentinel.conf.j2</span><br><span class="line"></span><br><span class="line">4 directories, 17 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总体需要什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.一个调用角色的playbook，我这里是：role_redis_4.yml，注意这个文件需要跟roles目录同级别，redis角色应该是在roles目录下一个叫redis的目录，角色名称和目录名称要一致</span><br><span class="line">2.一个角色目录，包括：tasks,handlers,files,temples</span><br><span class="line">3.每个目录下的若干文件</span><br></pre></td></tr></table></figure>

<p>执行之后，在六台主机上部署了redis</p>
<p>2.使用ruby脚本</p>
<p>需要首先编译安装ruby，因为yum自带的ruby版本太老了，无法使用。</p>
<p>去ruby官网下载源码，然后根据官网的指导编译安装即可，安装完成后还得gem安装一个redis</p>
<p>官网地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;downloads&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;zh_cn&#x2F;documentation&#x2F;installation&#x2F;#building-from-source</span><br></pre></td></tr></table></figure>

<p>安装ruby的redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>

<p>3.使用redis自带的ruby脚本，位于源码包的src文件中，叫redis-trib.rb，可以把它软链接到/usr/local/bin/下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb </span><br><span class="line">Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;</span><br><span class="line"></span><br><span class="line">  create          host1:port1 ... hostN:portN</span><br><span class="line">                  --replicas &lt;arg&gt;</span><br><span class="line">  check           host:port</span><br><span class="line">  info            host:port</span><br><span class="line">  fix             host:port</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">  reshard         host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --to &lt;arg&gt;</span><br><span class="line">                  --slots &lt;arg&gt;</span><br><span class="line">                  --yes</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">  rebalance       host:port</span><br><span class="line">                  --weight &lt;arg&gt;</span><br><span class="line">                  --auto-weights</span><br><span class="line">                  --use-empty-masters</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --simulate</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">                  --threshold &lt;arg&gt;</span><br><span class="line">  add-node        new_host:new_port existing_host:existing_port</span><br><span class="line">                  --slave</span><br><span class="line">                  --master-id &lt;arg&gt;</span><br><span class="line">  del-node        host:port node_id</span><br><span class="line">  set-timeout     host:port milliseconds</span><br><span class="line">  call            host:port command arg arg .. arg</span><br><span class="line">  import          host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --copy</span><br><span class="line">                  --replace</span><br><span class="line">  help            (show this help)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-trib.rb create --replicas 1 10.0.0.101:6379 10.0.0.11:6379 10.0.0.12:6379 10.0.0.13:6379 10.0.0.14:6379 10.0.0.110:6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>操作和5.X版本redis没有区别，就是执行脚本不一样，4.X是用ruby，5.X是集成到了redis-cli中！</p>
<h4 id="3-3-2-集群的扩容"><a href="#3-3-2-集群的扩容" class="headerlink" title="3.3.2 集群的扩容"></a>3.3.2 集群的扩容</h4><p><strong>注意：先让开发把数据导出，然后备份数据，然后清空数据库，然后再扩容</strong></p>
<p>1.成主从对的扩容，也就是一对一对的增加，但是注意，整体集群的个数要保持在奇数个</p>
<p>2.新加主从对的配置</p>
<p>3.添加主从对里的主节点到集群</p>
<p>4.重新分配槽位</p>
<p>5.添加主从对里的从节点到集群，先添加进去，然后设置为从</p>
<p><strong>添加节点准备：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">新的节点全部配置要和集群中的节点配置相同，且新加入的节点也应该为一主一从</span><br></pre></td></tr></table></figure>

<p>需要使用的命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli --help</span><br><span class="line">redis-cli 5.0.9</span><br><span class="line"></span><br><span class="line">Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]</span><br><span class="line">  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).</span><br><span class="line">  -p &lt;port&gt;          Server port (default: 6379).</span><br><span class="line">  -s &lt;socket&gt;        Server socket (overrides hostname and port).</span><br><span class="line">  -a &lt;password&gt;      Password to use when connecting to the server.</span><br><span class="line">                     You can also use the REDISCLI_AUTH environment</span><br><span class="line">                     variable to pass this password more safely</span><br><span class="line">                     (if both are used, this argument takes predecence).</span><br><span class="line">  -u &lt;uri&gt;           Server URI.</span><br><span class="line">  -r &lt;repeat&gt;        Execute specified command N times.</span><br><span class="line">  -i &lt;interval&gt;      When -r is used, waits &lt;interval&gt; seconds per command.</span><br><span class="line">                     It is possible to specify sub-second times like -i 0.1.</span><br><span class="line">  -n &lt;db&gt;            Database number.</span><br><span class="line">  -x                 Read last argument from STDIN.</span><br><span class="line">  -d &lt;delimiter&gt;     Multi-bulk delimiter in for raw formatting (default: \n).</span><br><span class="line">  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br><span class="line">  --raw              Use raw formatting for replies (default when STDOUT is</span><br><span class="line">                     not a tty).</span><br><span class="line">  --no-raw           Force formatted output even when STDOUT is not a tty.</span><br><span class="line">  --csv              Output in CSV format.</span><br><span class="line">  --stat             Print rolling stats about server: mem, clients, ...</span><br><span class="line">  --latency          Enter a special mode continuously sampling latency.</span><br><span class="line">                     If you use this mode in an interactive session it runs</span><br><span class="line">                     forever displaying real-time stats. Otherwise if --raw or</span><br><span class="line">                     --csv is specified, or if you redirect the output to a non</span><br><span class="line">                     TTY, it samples the latency for 1 second (you can use</span><br><span class="line">                     -i to change the interval), then produces a single output</span><br><span class="line">                     and exits.</span><br><span class="line">  --latency-history  Like --latency but tracking latency changes over time.</span><br><span class="line">                     Default time interval is 15 sec. Change it using -i.</span><br><span class="line">  --latency-dist     Shows latency as a spectrum, requires xterm 256 colors.</span><br><span class="line">                     Default time interval is 1 sec. Change it using -i.</span><br><span class="line">  --lru-test &lt;keys&gt;  Simulate a cache workload with an 80-20 distribution.</span><br><span class="line">  --replica          Simulate a replica showing commands received from the master.</span><br><span class="line">  --rdb &lt;filename&gt;   Transfer an RDB dump from remote server to local file.</span><br><span class="line">  --pipe             Transfer raw Redis protocol from stdin to server.</span><br><span class="line">  --pipe-timeout &lt;n&gt; In --pipe mode, abort with error if after sending all data.</span><br><span class="line">                     no reply is received within &lt;n&gt; seconds.</span><br><span class="line">                     Default timeout: 30. Use 0 to wait forever.</span><br><span class="line">  --bigkeys          Sample Redis keys looking for keys with many elements (complexity).</span><br><span class="line">  --memkeys          Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">  --memkeys-samples &lt;n&gt; Sample Redis keys looking for keys consuming a lot of memory.</span><br><span class="line">                     And define number of key elements to sample</span><br><span class="line">  --hotkeys          Sample Redis keys looking for hot keys.</span><br><span class="line">                     only works when maxmemory-policy is *lfu.</span><br><span class="line">  --scan             List all keys using the SCAN command.</span><br><span class="line">  --pattern &lt;pat&gt;    Useful with --scan to specify a SCAN pattern.</span><br><span class="line">  --intrinsic-latency &lt;sec&gt; Run a test to measure intrinsic system latency.</span><br><span class="line">                     The test will run for the specified amount of seconds.</span><br><span class="line">  --eval &lt;file&gt;      Send an EVAL command using the Lua script at &lt;file&gt;.</span><br><span class="line">  --ldb              Used with --eval enable the Redis Lua debugger.</span><br><span class="line">  --ldb-sync-mode    Like --ldb but uses the synchronous Lua debugger, in</span><br><span class="line">                     this mode the server is blocked and script changes are</span><br><span class="line">                     not rolled back from the server memory.</span><br><span class="line">  --cluster &lt;command&gt; [args...] [opts...]</span><br><span class="line">                     Cluster Manager command and arguments (see below).</span><br><span class="line">  --verbose          Verbose mode.</span><br><span class="line">  --no-auth-warning  Don&#39;t show warning message when using password on command</span><br><span class="line">                     line interface.</span><br><span class="line">  --help             Output this help and exit.</span><br><span class="line">  --version          Output version and exit.</span><br><span class="line"></span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  Use --cluster help to list all available cluster manager commands.</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  cat &#x2F;etc&#x2F;passwd | redis-cli -x set mypasswd</span><br><span class="line">  redis-cli get mypasswd</span><br><span class="line">  redis-cli -r 100 lpush mylist x</span><br><span class="line">  redis-cli -r 100 -i 1 info | grep used_memory_human:</span><br><span class="line">  redis-cli --eval myscript.lua key1 key2 , arg1 arg2 arg3</span><br><span class="line">  redis-cli --scan --pattern &#39;*:12345*&#39;</span><br><span class="line"></span><br><span class="line">  (Note: when using --eval the comma separates KEYS[] from ARGV[] items)</span><br><span class="line"></span><br><span class="line">When no command is given, redis-cli starts in interactive mode.</span><br><span class="line">Type &quot;help&quot; in interactive mode for information on available commands</span><br><span class="line">and settings.</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node_7 ~]$redis-cli --cluster help</span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN</span><br><span class="line">                 --cluster-replicas &lt;arg&gt;</span><br><span class="line">  check          host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  info           host:port</span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners</span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1&#x3D;w1...nodeN&#x3D;wN&gt;</span><br><span class="line">                 --cluster-use-empty-masters</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-simulate</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-threshold &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port  #需要使用这个命令添加</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line">  del-node       host:port node_id</span><br><span class="line">  call           host:port command arg arg .. arg</span><br><span class="line">  set-timeout    host:port milliseconds</span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-copy</span><br><span class="line">                 --cluster-replace</span><br><span class="line">  help           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>开始添加主节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster add-node 10.0.0.112:6379 10.0.0.110:6379</span><br><span class="line"></span><br><span class="line">redis-cli -a centos cluster nodes</span><br><span class="line">25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379@16379 master - 0 1603542788089 0 connected</span><br><span class="line">#新主节点已经添加成功</span><br></pre></td></tr></table></figure>

<p>检查当前的集群情况：注意，redis的命令行中–cluster和进入redis输入的cluster是两个方式，他们的内容不一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112:6379</span><br></pre></td></tr></table></figure>

<p><strong>给新的节点分配槽位（slot）：</strong></p>
<p><strong>注意：重新分配槽位需要清空数据！请备份好数据后再操作</strong></p>
<p>利用的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster reshard 10.0.0.110:6379 #这里填写任意一个集群中的节点</span><br><span class="line">reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;</span><br><span class="line">                 --cluster-to &lt;arg&gt;</span><br><span class="line">                 --cluster-slots &lt;arg&gt;</span><br><span class="line">                 --cluster-yes</span><br><span class="line">                 --cluster-timeout &lt;arg&gt;</span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;</span><br><span class="line">                 --cluster-replace</span><br><span class="line">需要被询问：</span><br><span class="line">1.需要分配多少槽位？</span><br><span class="line">2.需要分配给哪个主节点</span><br><span class="line">3.分配的槽位是从哪些主节点上来的（也就是从哪里再分一些槽位出来给新的主节点，如果是想要把某个老的主节点替换掉，那么就把它的全部槽位分配给新节点），有一个智能的ALL选项，可以平均的从其他主节点上获取槽位</span><br><span class="line">4.是否接受分配规则？</span><br></pre></td></tr></table></figure>

<p>分配完成后，检查当前集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster check 10.0.0.112</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.112:6379)</span><br><span class="line">M: 25a3f4642c96aa8da5895fe6948c16add5737036 10.0.0.112:6379</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">已经有了槽位</span><br></pre></td></tr></table></figure>

<p><strong>添加从节点：</strong></p>
<p>两个方法：</p>
<p><strong>1.第一个方法：</strong></p>
<p>一步添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add-node       new_host:new_port existing_host:existing_port</span><br><span class="line">                 --cluster-slave</span><br><span class="line">                 --cluster-master-id &lt;arg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379 --cluster-slave --cluster-master-id 25a3f4642c96aa8da5895fe6948c16add5737036</span><br><span class="line">#cluster的id填新的主节点的id</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br><span class="line">6803c4e25d23980fba3ff2d336126f4f000a4418 10.0.0.14:6379@16379 myself,slave 25a3f4642c96aa8da5895fe6948c16add5737036 0 1603544102000 0 connected</span><br><span class="line">已经添加成为了从节点</span><br></pre></td></tr></table></figure>

<p>2.第二个方法：</p>
<p>两步添加为从节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a centos --cluster add-node 10.0.0.14:6379 10.0.0.110:6379</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate 25a3f4642c96aa8da5895fe6948c16add5737036</span><br></pre></td></tr></table></figure>



<h4 id="3-3-3-集群的缩容"><a href="#3-3-3-集群的缩容" class="headerlink" title="3.3.3 集群的缩容"></a>3.3.3 集群的缩容</h4><p>1.缩容之前需要把原本的槽位分给其他主节点</p>
<p><strong>注意：缩容操作中，需要分三次，均匀的把槽位分配给剩余的主节点</strong></p>
<p>分配槽位，使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ redis-cli -a centos --cluster reshard 10.0.0.112:6379</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 1365  #这里设置每次分配的槽位，4096 &#x2F; 3 </span><br><span class="line">What is the receiving node ID? 819d053d78d249570b5bd610436fdb0e4ac59627 #这里写分配给哪个主节点</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: 25a3f4642c96aa8da5895fe6948c16add5737036  #这里写要把哪个主节点分配了，也就是缩容了</span><br><span class="line"></span><br><span class="line">这个操作做三次，并且确保要缩容的节点上已经没有槽位</span><br></pre></td></tr></table></figure>

<p>把槽位分配完成后，原本的从节点也自动变成了其他主节点的从节点</p>
<p>2.删除节点，先删除主，后删除从</p>
<p>使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~ redis-cli -a centos --cluster del-node 10.0.0.112:6379 25a3f4642c96aa8da5895fe6948c16ad</span><br><span class="line">d5737036</span><br><span class="line"></span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Removing node 25a3f4642c96aa8da5895fe6948c16add5737036 from cluster 10.0.0.112:6379</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node</span><br></pre></td></tr></table></figure>

<p>此时这个主节点的redis服务也被关闭了，然后下一步我们把他的cluster自动生成的nodes-6379.conf文件删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;*  #注意：cluster的配置文件存放到哪里，是由redis.conf文件中dir选项决定的</span><br></pre></td></tr></table></figure>

<p>检查当前集群信息，发现已经没有被缩容的主节点了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del-node ip:port</span><br></pre></td></tr></table></figure>

<p>删除从节点：从节点只需要删除节点，删除自动生成的nodes-6379.conf文件即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$redis-cli -a centos --cluster del-node 10.0.0.14:6379 42339be4491341520d59219d685530fcc61655ec</span><br><span class="line"></span><br><span class="line">rm -f &#x2F;app&#x2F;redis&#x2F;data&#x2F;* </span><br></pre></td></tr></table></figure>

<p>此时检查集群信息，已经没有这个从节点了，缩容结束。</p>
<h4 id="3-3-5-把数据导入集群"><a href="#3-3-5-把数据导入集群" class="headerlink" title="3.3.5 把数据导入集群"></a>3.3.5 把数据导入集群</h4><p><strong>注意：慎用！</strong></p>
<p>用之前把所有涉及到的redis服务的密码全设置为空，包括导入数据的redis和被导入数据的redis集群的全部节点</p>
<p>然后使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster import 10.0.0.110:6379 --cluster-from 10.0.0.112:6379 --cluster-copy --cluster-replace</span><br><span class="line">参数说明：</span><br><span class="line">--cluster import 后面跟上集群中的一个节点IP和端口</span><br><span class="line">--cluster-from 后面跟上从哪里导入数据</span><br><span class="line">--cluster-copy  这个参数表示复制数据到集群</span><br><span class="line">--cluster-replace 这个参数表示如果出现相同的key，那么使用导入的数据替换了原来的数据</span><br></pre></td></tr></table></figure>



<h4 id="3-3-6-集群偏斜"><a href="#3-3-6-集群偏斜" class="headerlink" title="3.3.6 集群偏斜"></a>3.3.6 集群偏斜</h4><ul>
<li>节点和槽位分配不均</li>
<li>不同槽位对应键值数量差异较大</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看槽位中的键值对个数</span><br><span class="line">countkeysinslot NUMBER</span><br></pre></td></tr></table></figure>

<p>有一个重新分配槽位的命令，但是慎用！会影响客户端的访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster rebalance 集群IP:端口</span><br></pre></td></tr></table></figure>



<ul>
<li>包含bigkey，建议少用</li>
<li>内存相关配置不一致</li>
<li>热点数据不均衡：一致性不高时，可以使用本机缓存和MQ</li>
</ul>
<h4 id="3-3-7-Redis-cluster的局限性"><a href="#3-3-7-Redis-cluster的局限性" class="headerlink" title="3.3.7 Redis cluster的局限性"></a>3.3.7 Redis cluster的局限性</h4><ul>
<li>跨槽位查询不支持，不是说跨节点的问题，槽位都不能跨</li>
<li>性能降低</li>
<li>客户端维护更复杂</li>
<li>不支持多个数据库，只使用db0</li>
<li>复制只有一层，不支持级联复制</li>
<li>key事务和Lua支持有限</li>
</ul>
<p>1.主从复制</p>
<p>2.哨兵</p>
<p>3.Cluster 创建  两个版本  4,5都试试</p>
<p>4.扩容</p>
<p>5.缩容</p>
<p>6.导入</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/" data-id="ckhnf9hf9000c40utdll7137b" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySQL数据库" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.241Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="MySQL是什么"><a href="#MySQL是什么" class="headerlink" title="MySQL是什么"></a>MySQL是什么</h2><ul>
<li><p>关系型数据库管理软件–RDBMS</p>
<ul>
<li>数据库是数据库，MySQL是管理数据库的软件</li>
<li>实体-联系模型E-R<ul>
<li>实体Entity：客观存在并且可以相互区分的客观事物或抽象事件称为实体</li>
<li>属性：实体所具有的特征或性质</li>
<li>联系：联系是数据之间的关联集合，是客观存在的应用语义链<ul>
<li>实体和属性之间的联系</li>
<li>实体和实体之间的联系</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>数据冗余和性能的矛盾关系，冗余越小，在查询数据的时候就会越消耗性能</p>
</li>
<li><p>数据库的范式，有很多范式，但是一般数据只需满足第三范式（3NF）即可</p>
<ul>
<li><p>第一范式：1NF（normal form）</p>
<p>无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性，确保每一列的原子性。除去同类型的字段，就是无重复的列。</p>
<p>总结：消除重复列</p>
<p>比如下面表中xiaolv，他的年龄只能有一个，不能有两个</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">xiaoli</td>
<td align="center">20</td>
</tr>
<tr>
<td align="center">xiaolv</td>
<td align="center">20,22（两个值是错误的）</td>
</tr>
</tbody></table>
<ul>
<li><p>第二范式</p>
<p>第二范式必须先满足第一范式，属性完全依赖于主键，要求表中的每个行必须可以被唯一的区分，通常为表加上每行的唯一标识PK，非PK的字段需要与整个PK有直接的相关性</p>
<p>总结：消除部分依赖</p>
<p>比如下面的ID就是主键，每行都不相同，name和age字段依赖于ID</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">name</th>
<th align="center">age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">xiaolv</td>
<td align="center">20</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">xiaohui</td>
<td align="center">21</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">xiaozhe</td>
<td align="center">20</td>
</tr>
</tbody></table>
<ul>
<li><p>第三范式</p>
<p>第三范式必须先满足第二范式，不依赖于其他非主属性。第三范式要求一个数据表中不包含已在其他表中已包含的非主键字信息，非PK的字段间不能有从属关系</p>
<p>总结：消除全部依赖</p>
</li>
</ul>
</li>
<li><p>mysql客户端工具：</p>
<ul>
<li>mysql</li>
<li>mysqladmin</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ppasswd -Pport</span><br><span class="line"></span><br><span class="line">mysql [options] [database]</span><br><span class="line">-A,--no-auto-rehash 禁止补全</span><br><span class="line">-u,--user&#x3D; 用户名，默认为root</span><br><span class="line">-h,--host&#x3D; 服务器名，默认为localhost</span><br><span class="line">-p,--password 用户密码，默认为空密码</span><br><span class="line">-P,--port&#x3D; 服务器端口</span><br><span class="line">-S,--socket 指定连接socket文件路径</span><br><span class="line">-D，--datebase&#x3D; 指定默认数据库</span><br><span class="line">-C，--compress 启用压缩</span><br><span class="line">-e &quot;SQL&quot; 执行SQL命令</span><br><span class="line">-V,--version 显示版本</span><br><span class="line">-v,--verbos 显示详细信息</span><br><span class="line">--print-defaults 获取程序默认使用的配置</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -ppasswd ping</span><br><span class="line">mysqladmin [options] command command ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器端配置</p>
</li>
</ul>
<p>服务器端（mysqld）配置：</p>
<p>1.命令行选项</p>
<p>2.配置文件</p>
<ul>
<li><p>/etc/my.cnf</p>
</li>
<li><p>/etc/my.cnf.d/mysql-server.cnf</p>
<ul>
<li><p>```<br> 13 [mysqld]<br> 14 datadir=/var/lib/mysql<br> 15 socket=/var/lib/mysql/mysql.sock<br> 16 log-error=/var/log/mysql/mysqld.log<br> 17 pid-file=/run/mysqld/mysqld.pid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">socket地址：</span><br><span class="line"></span><br><span class="line">* ip socket地址：监听在tcp的3306端口，支持远程通信，侦听3306&#x2F;tcp端口可以绑定有一个或全部接口的IP上</span><br><span class="line">* Unix sock：监听在sock文件上，仅支持本机通信，如：&#x2F;var&#x2F;lib&#x2F;mysql.sock,说明，host为localhost时自动使用unix sock</span><br><span class="line"></span><br><span class="line">## MySQL数据库怎么安装</span><br><span class="line"></span><br><span class="line">在实际生产环境中大多使用编译安装或二进制安装</span><br><span class="line"></span><br><span class="line">* 编写脚本，实现二进制方式安装MySQL</span><br><span class="line"></span><br><span class="line">MySQL的三大分支</span><br><span class="line"></span><br><span class="line">* mysql</span><br><span class="line">* mariadb</span><br><span class="line">* percona server</span><br><span class="line"></span><br><span class="line">数据库应该尽量少被访问，尽量分担数据库的压力</span><br><span class="line"></span><br><span class="line">脚本在二进制安装.md中</span><br><span class="line"></span><br><span class="line">* yum install </span><br><span class="line">* 编译安装</span><br><span class="line">  * 建议内存4G以上</span><br><span class="line">  </span><br><span class="line">  * 下载并解压源码包</span><br><span class="line">  </span><br><span class="line">  * 源码编译安装，使用cmake，指定一些环境</span><br><span class="line">  </span><br><span class="line">  * &#96;&#96;&#96;</span><br><span class="line">    cd mariadb-10.2.18&#x2F;cmake . \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX&#x3D;&#x2F;app&#x2F;mysql \</span><br><span class="line">    -DMYSQL_DATADIR&#x3D;&#x2F;data&#x2F;mysql&#x2F; \</span><br><span class="line">    -DSYSCONFDIR&#x3D;&#x2F;etc&#x2F;  \</span><br><span class="line">    -DMYSQL_USER&#x3D;mysql \</span><br><span class="line">    -DWITH_INNOBASE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_ARCHIVE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_BLACKHOLE_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_PARTITION_STORAGE_ENGINE&#x3D;1  \</span><br><span class="line">    -DWITHOUT_MROONGA_STORAGE_ENGINE&#x3D;1 \</span><br><span class="line">    -DWITH_DEBUG&#x3D;0 \</span><br><span class="line">    -DWITH_READLINE&#x3D;1 \</span><br><span class="line">    -DWITH_SSL&#x3D;system \</span><br><span class="line">    -DWITH_ZLIB&#x3D;system\</span><br><span class="line">    -DWITH_LIBWRAP&#x3D;0 \</span><br><span class="line">    -DENABLED_LOCAL_INFILE&#x3D;1  \</span><br><span class="line">    -DMYSQL_UNIX_ADDR&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock \</span><br><span class="line">    -DDEFAULT_CHARSET&#x3D;utf8 \</span><br><span class="line">    -DDEFAULT_COLLATION&#x3D;utf8_general_ci</span><br><span class="line">    make &amp;&amp; make install </span><br></pre></td></tr></table></figure>

<p>提示：如果出错，执行rm -f CMakeCache.txt</p>
<p>剩下的步骤与二进制安装相同</p>
</li>
</ul>
</li>
<li><p>二进制安装，相比编译安装就是少了编译过程</p>
<ul>
<li>1.创建mysql组和用户</li>
<li>2.创建数据库存放目录，修改这个目录所有者、所有组的信息</li>
<li>3.下载源码，解压到/usr/local下</li>
<li>4.创建软链接 ln -s /usr/local/mysqlxxxx   mysql</li>
<li>5.配置文件复制到/etc/my.cnf</li>
<li>6.使用自带脚本生成数据库文件</li>
<li>7.使用自带脚本制作开机启动脚本</li>
<li>8.配置开机启动</li>
<li>9.启动安全加固脚本</li>
</ul>
</li>
</ul>
<p>1.MySQL账户</p>
<p>2.MySQL配置文件</p>
<p>3.MySQL工具</p>
<p>4.MySQL数据库文件</p>
<p>5.MySQL登录方式文件</p>
<p>mysql</p>
<p>mysqladmin</p>
<h2 id="SQL语言"><a href="#SQL语言" class="headerlink" title="SQL语言"></a>SQL语言</h2><p>SQL的注释：</p>
<ul>
<li>– 注释内容 单行注释，注意有空格</li>
<li>/**/ 多行注释</li>
</ul>
<p>MySQL注释：</p>
<ul>
<li>“#”号后面跟注释内容，有空格</li>
</ul>
<p>SQL关键字建议大写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;passwd&#39; WITH GRANT OPTION;</span><br><span class="line">#这个是指定访问的IP和账号</span><br><span class="line">delete from user where host&#x3D;xxx and user&#x3D;xxx;</span><br><span class="line">#这个是删除一个用户</span><br><span class="line">flush privileges;</span><br><span class="line">#刷新数据库</span><br></pre></td></tr></table></figure>

<p>数据库的组件：</p>
<p>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器</p>
<p>命名规则：</p>
<ul>
<li>必须以字母开头，可包括数字和三个特殊字符（# _ $）</li>
<li>不要使用MySQL的保留字</li>
</ul>
<p>SQL的语句分类：</p>
<ul>
<li><p>DDL:数据定义语言 Data Defination Language</p>
<p>表：二维关系</p>
<p>设计表：遵循规范</p>
<p>定义：字段，索引</p>
<p>​    字段：字段名，字段数据类型，修饰符</p>
<p>​    约束，索引：应该创建在经常用作查询条件的字段上</p>
<ul>
<li><p>CREATE</p>
<p>第一种创建表的方式：直接创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table if not exists student (</span><br><span class="line">id int UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">name VARCHAR(20) NOT NULL,</span><br><span class="line">age tinyint UNSIGNED,</span><br><span class="line">gender ENUM(&#39;F&#39;,&#39;M&#39;) default &#39;M&#39;)ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;10 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line">(root@localhost) [ahui]&gt;desc student;</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field  | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id     | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name   | varchar(20)         | NO   |     | NULL    |                |</span><br><span class="line">| age    | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| gender | enum(&#39;F&#39;,&#39;M&#39;)       | YES  |     | M       |                |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">(root@localhost) [ahui]&gt;insert student (name,age)values(&#39;xiaolv&#39;,20);</span><br><span class="line">(root@localhost) [ahui]&gt;insert student (name,age,gender)values(&#39;xiaohong&#39;,20,&#39;f&#39;);</span><br><span class="line">(root@localhost) [ahui]&gt;select * from student;</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">| id | name     | age  | gender |</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">| 10 | xiaolv   |   20 | M      |</span><br><span class="line">| 11 | xiaohong |   20 | F      |</span><br><span class="line">+----+----------+------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>关于AUTO_INCREMENT，通过更改系统参数可以修改步进值和默认起始的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show variables like &#39;auto_increment%&#39;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| auto_increment_increment | 10    |</span><br><span class="line">| auto_increment_offset    | 3     |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">#上面的参数是修改过的，默认都是1</span><br><span class="line">(root@localhost) [ahui]&gt;set @@auto_increment_increment&#x3D;10;</span><br><span class="line">(root@localhost) [ahui]&gt;set @@auto_increment_offset&#x3D;3;</span><br><span class="line">(root@localhost) [ahui]&gt;desc autoincre;</span><br><span class="line">(root@localhost) [ahui]&gt;desc autoincre;</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra          |</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">| col   | int(11) | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">+-------+---------+------+-----+---------+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(root@localhost) [ahui]&gt;select * from autoincre;</span><br><span class="line">+-----+</span><br><span class="line">| col |</span><br><span class="line">+-----+</span><br><span class="line">|   3 |</span><br><span class="line">|  13 |</span><br><span class="line">|  23 |</span><br><span class="line">|  33 |</span><br><span class="line">+-----+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>第二种创建表的方式：通过查询现存表创建：查询到的数据之间插入表中成为新表的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table human select user,host from mysql.user;</span><br><span class="line">(root@localhost) [ahui]&gt;select * from human;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| root          | 10.0.0.%  |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>第三种方式：通过复制现存表的表结构创建，但是不复制数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;create table teacher like student;</span><br><span class="line">(root@localhost) [ahui]&gt;desc teacher;</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field  | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id     | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name   | varchar(20)         | NO   |     | NULL    |                |</span><br><span class="line">| age    | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| gender | enum(&#39;F&#39;,&#39;M&#39;)       | YES  |     | M       |                |</span><br><span class="line">+--------+---------------------+------+-----+---------+----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">(root@localhost) [ahui]&gt;select * from teacher;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">#表中没有数据，是空的，只有数据表的结构</span><br></pre></td></tr></table></figure>

<p>查看engine</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show engines;</span><br></pre></td></tr></table></figure>

<p>查看表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show tables;</span><br></pre></td></tr></table></figure>

<p>查看表结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;desc student;</span><br></pre></td></tr></table></figure>

<p>查看创建表命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show create table student;</span><br></pre></td></tr></table></figure>

<p>查看表状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show table  status like &#39;student&#39;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: student</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 2</span><br><span class="line"> Avg_row_length: 8192</span><br><span class="line">    Data_length: 16384</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 0</span><br><span class="line">      Data_free: 0</span><br><span class="line"> Auto_increment: 12</span><br><span class="line">    Create_time: 2020-09-22 20:33:27</span><br><span class="line">    Update_time: 2020-09-22 20:37:04</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8_general_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#\G是竖着显示内容</span><br></pre></td></tr></table></figure>

<p>查看数据库中全部表的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [ahui]&gt;show table status from ahui ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DROP</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [(none)]&gt;drop database if exists ahui;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ALTER</p>
<p>add,change,modify</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(root@localhost) [(none)]&gt;alter database ahui character set utf8;</span><br><span class="line">mysql&gt; alter table info change name1 name varchar(20);</span><br></pre></td></tr></table></figure>

<p>查看所有数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>DML：数据库操纵语言 Data Manipulation Language</p>
<ul>
<li><p>INSERT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert table_name [(column1,...)] values (value1,...) (value2...)...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;insert info (id,name,gender,age) values (4,&#39;ming&#39;,&#39;M&#39;,24);</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<ul>
<li><p>DELETE</p>
<p>删除表中的数据，但不会自动缩减数据文件的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE [] FROM TABLE_NAME</span><br><span class="line">	[WHERE CONDITIONS]</span><br><span class="line">	[ORDER BY]</span><br><span class="line">	[LIMIT ROW_COUNT]</span><br><span class="line">	可以先排序再指定删除的行数</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;delete from info where id &#x3D;4;</span><br></pre></td></tr></table></figure>

<p>注意一定要有限制条件，否则将清空表中的所有数据</p>
<p>如果想清空表，保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE TABLE TABLE_NAME</span><br></pre></td></tr></table></figure>

<p>缩减表大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE TABLE_NAME</span><br></pre></td></tr></table></figure>
</li>
<li><p>UPDATE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UPDATE [] TABLE_REFERENCE</span><br><span class="line">	SET COL_NAME&#x3D;&#123;exper1|default&#125;...</span><br><span class="line">	[WHERE CONDITIONS]</span><br><span class="line">	[ORDER BY]</span><br><span class="line">	[LIMIT ROW_COUNT]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update info set id&#x3D;6 where name &#x3D; &#39;hui&#39;;</span><br></pre></td></tr></table></figure>

<p>注意要有限制条件，否则将修改所有行的指定字段，可以用mysql选项避免此错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -U | --safe-updates | --i-am-a-dummy </span><br><span class="line">可以把 mysql -U 做成别名，</span><br><span class="line">alias mysql&#x3D;&quot;mysql -U&quot;</span><br><span class="line">设置了 -U 选项后使用删除的时候必须跟上一个主键的条件！</span><br></pre></td></tr></table></figure>
</li>
<li><p>DQL：数据查询语言 Data Query Language</p>
<ul>
<li>SELECT</li>
</ul>
</li>
</ul>
<p>select语句处理的顺序</p>
<p>SQL解析–&gt;FROM–&gt;ON–&gt;JOIN和WHERE并列地位–&gt;GROUP BY–&gt;HAVING–&gt;SELECT–&gt;ORDER BY–&gt;LIMIT</p>
<p>执行查询路径中的组件：</p>
<p><img src="C:\Users\a\Desktop\dfff6efbab0d51a715a36f867daeacf8.png" alt="dfff6efbab0d51a715a36f867daeacf8"></p>
<pre><code>* 单表操作</code></pre>
<p>  between … and</p>
<p>  distinct </p>
<p>  模糊查询:like %,_ </p>
<p>  ​    数据库、数据表是区分大小写的，因为他们都是文件（目录）</p>
<p>  ​    字段名、数据是不区分大小写的</p>
<p>  GROUP分组，涉及到前后次序</p>
<p>  ​    groupby xxx having conditions=xxx</p>
<p>  ​    where conditions = xxx groupby xxx</p>
<p>  正则表达式查询：rlike,regexp</p>
<p>  order by asc desc</p>
<p>  字段的别名</p>
<p>  limit N 或者可以跳过前几条后开始显示</p>
<p>  对查询结果加锁</p>
<pre><code>* 多表查询

  子查询

  ​    普通子查询

  ​    IN 子查询

  ​    exists 和 not exists

  exists（包括 not exists）子句的返回值是一个BOOL值。exists内部有一个子查询语句，将其称为exists的内查询语句。其内查询语句返回一个结果集，exists子句根据其内查询的结果集空或非空，返回一个布尔值。将外查询的每一行带入内查询作为检验，如果内查询返回的结果为非空值，则exists子句返回true，外查询的这一行数据便可作为外查询的结果返回，否则不能作为结果。

  联合查询 union，union all

  交叉连接：笛卡尔乘积，两个表完全组合一遍 cross join

  内连接 inner join table_name on 涉及到别名

  外连接 涉及到别名

  ​    左外连接 left outer join table_name on 

  ​    有外连接 right outer join table_name on

  ​    只取非交集 左连接或右连接再加一个key的where条件

  ​    全外连接 full outer join table_name on 

  ​    mysql不支持 full outer写法，但是可以通过组合左右连接来union实现

  自连接</code></pre>
<ul>
<li>DCL：数据控制语言 Data Control Language<ul>
<li>GRANT</li>
<li>REVOKE</li>
<li>COMMIT</li>
<li>ROLLBACK</li>
</ul>
</li>
</ul>
<p>软件开发：CRUD 增删改查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table1</span><br><span class="line">WHERE price&gt;666;</span><br></pre></td></tr></table></figure>

<p>字符集：UTF8MB4 4个字节，生产环境记得修改字符集</p>
<ul>
<li>SHOW COLLATION  字符集的排序规则</li>
<li>SHOW VARIABLES LIKE ‘collation%’</li>
<li>SHOW CHARACTER SET</li>
<li>SHOW variables like ‘character%’ 查看当前数据库中使用的字符集</li>
</ul>
<p>数据类型：</p>
<p>数据长什么样</p>
<p>数据需要多少空间来存放</p>
<p>系统内置数据类型</p>
<p>用户定义数据类型</p>
<p>选择正确的数据类型对于获得高性能至关重要，三大原则：</p>
<p>1.更小的通常更好，尽量使用可正确存储数据的最小数据类型</p>
<p>2.简单就好，简单数据类型的操作通常需要更少的CPU周期</p>
<p>3.尽量避免NULL，包含为NULL的列，对MySQL更难优化</p>
<ul>
<li><p>整数型</p>
<ul>
<li>tinyint 1个字节</li>
<li>int 4个字节</li>
</ul>
</li>
<li><p>浮点型</p>
</li>
<li><p>定数型</p>
</li>
<li><p>字符串</p>
<ul>
<li>char(n) 固定长度，最多255个字符，注意不是字节</li>
<li>varchar(n) 可变长度，最多65535个字符</li>
</ul>
</li>
<li><p>修饰符</p>
<ul>
<li>NULL    数据列可包含NULL值，默认值</li>
<li>NOT NULL 数据列不允许包含NULL值，*为必填选项</li>
<li>DEFAULT 默认值</li>
<li>ENUM（’’,’’）限制值只能是设定的</li>
<li>PRIMARY KEY 主键，所有记录中此字段的值不能重复，且不能为NULL</li>
<li>UNIQUE KEY  唯一键，所有记录中此字段的值不能重复，但可以为NULL</li>
<li>CHARACTER SET name 指定一个字符集</li>
<li>适合数值型的修饰符<ul>
<li>AUTO_INCREMENT 自动递增，适用于整数类型 最大是2^32次方-1 4294967295</li>
<li>UNSIGNED 无符号</li>
</ul>
</li>
<li>日期时间类型<ul>
<li>data 日期 ‘2020-09-22’</li>
<li>time 时间 ‘20:20:20’</li>
<li>datatime 日期时间 ‘2020-09-22 20:20:30’</li>
<li>timestamp 自动存储记录修改时间</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>视图 VIEW</p>
<p>视图是虚拟的表，类似表的别名，视图存在于数据库目录下，是以文件形式存放的</p>
<p>视图可以隐藏数据表的结构</p>
<p>视图可以修改原始表的数据，视图中的数据实际存储在基表中，因此对视图数据的修改也会对基表修改，视图的修改操作受基表限制</p>
<p>创建视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW view_name [(column_list)]</span><br><span class="line">	as select_statement</span><br><span class="line">	[with[cascaded|local] check option]</span><br></pre></td></tr></table></figure>

<p>查看视图定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#显示创建视图和表的过程</span><br><span class="line">show create table v_name;</span><br><span class="line">或</span><br><span class="line">show create view v_name;</span><br></pre></td></tr></table></figure>

<p>删除视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW [if exists]</span><br><span class="line">	view_name[,view_name] ...</span><br><span class="line">	[restrict|cascade]</span><br></pre></td></tr></table></figure>

<p>函数 FUNCTION</p>
<p>​    函数必须有()</p>
<p>​    内置函数和自定义函数</p>
<p>​    mysql数据库的proc表中</p>
<p>​    函数只能被调用select function_name()，不能独立使用;</p>
<p>创建函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE [AGGREAGTE] FUNCTION function_name(parameter_name type,....)</span><br><span class="line">	RETURN &#123;STRING|INTEGER|REAL&#125;</span><br><span class="line">	runtime_body</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>参数可以有多个，也可以没有</li>
<li>无论有没有参数，必须有()</li>
<li>必须有且只有一个返回值</li>
</ul>
<p>查看函数列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW FUNCTION STATUS;</span><br></pre></td></tr></table></figure>

<p>查看函数定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE FUNCTION function_name</span><br></pre></td></tr></table></figure>

<p>删除自定义函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP FUNCTION function_name</span><br></pre></td></tr></table></figure>

<p>调用函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select function_name();</span><br></pre></td></tr></table></figure>

<p>Mysql中的变量</p>
<p>​    系统变量 @@var_name 引用</p>
<p>​    普通变量 @var_name 适用于当前会话</p>
<p>​    局部变量 var_name 函数体内部有效，其他地方无效</p>
<p>存储过程 PROCEDURE</p>
<p>​    存储过程：多表SQL的语句的集合，可以独立执行，存储过程保存在mysql.proc表中</p>
<p>​    call procdure_name;</p>
<p>创建存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE procedure_name ([parameter]...)</span><br><span class="line">routime_body</span><br><span class="line">proc_parameter :[IN|OUT|INOUT] parameter_name type</span><br></pre></td></tr></table></figure>

<p>查看存储过程列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROCEDURE STATUS</span><br></pre></td></tr></table></figure>

<p>查看存储过程定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE PROCEDURE procedure_name</span><br></pre></td></tr></table></figure>

<p>调用存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call procedure_name [(parameter)]</span><br><span class="line">#说明：当没有参数时可以不写 ()</span><br></pre></td></tr></table></figure>

<p>存储过程通过ALTER只能修改注释等无关紧要的东西，不能修改存储过程体，所以要修改存储过程，方法就是删除重建</p>
<p>删除存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP PROCEDURE [if exists] procedure_name</span><br></pre></td></tr></table></figure>

<p>触发器 TRIGGER</p>
<p>​    触发器的执行不是由程序调用，也不是由手动启动，而是由时间来触发、激活从而实现执行</p>
<p>​    触发器只对insert,delete,update这三个动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE [ DEFINER &#x3D; &#123;USER|CURRENT_USER&#125; ]</span><br><span class="line">	TRIGGER trigger_name</span><br><span class="line">	trigger_time &#123;before|after&#125; trigger_event</span><br><span class="line">	on table_name for each row</span><br><span class="line">	trigger_body</span><br></pre></td></tr></table></figure>

<p>触发器文件在/var/lib/mysql/dbname/trigger_name.TRN</p>
<p>查看触发器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#通过show命令查看</span><br><span class="line">SHOW TRIGGERs ;</span><br><span class="line">#通过查看information_schema.triggers表</span><br><span class="line">mysql&gt; select * from information_schema.triggers where trigger_name &#x3D; &#39;student_count_delete&#39;;</span><br></pre></td></tr></table></figure>

<p>删除触发器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TRIGGER trigger_name</span><br></pre></td></tr></table></figure>

<p>事件 EVENT</p>
<p>​    存放在mysql.event表中</p>
<p>​    秒钟级别</p>
<p>​    环境变量：@@event_scheduler</p>
<p>查看事件管理器是否开启，默认是关闭0,1是开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@event_scheduler;</span><br></pre></td></tr></table></figure>

<p>事件管理器开启后会开启一个线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHWO PROCESSLIST</span><br></pre></td></tr></table></figure>

<p>可以通过在配置文件中添加 event_scheduler = on  来永久开启</p>
<h3 id="用户账户管理"><a href="#用户账户管理" class="headerlink" title="用户账户管理"></a>用户账户管理</h3><p>mysql.user表中存放用户信息</p>
<p>用户账户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#39;USERNAME&#39;@&#39;HOST&#39;</span><br><span class="line">USERNAME :操作系统的用户名</span><br><span class="line">@HOST：主机名，IP地址或者Network</span><br><span class="line">	通配符：% 表示所有  _ 表示任意一个字符</span><br><span class="line">	示例：172.16.%.% user@192.168.1.%</span><br></pre></td></tr></table></figure>



<h4 id="账号创建-CREATE-USER"><a href="#账号创建-CREATE-USER" class="headerlink" title="账号创建 CREATE USER"></a>账号创建 CREATE USER</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;USERNAME&#39;@&#39;HOSTNAME&#39; [IDENTIFIED BY &#39;密码&#39;]</span><br><span class="line">新建用户默认权限：USEAGE</span><br><span class="line">mysql&gt; create user &#39;lv&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br></pre></td></tr></table></figure>

<p>用户重命名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RENAME USER old_user_name TO new_user_name;</span><br></pre></td></tr></table></figure>



<h4 id="账号删除"><a href="#账号删除" class="headerlink" title="账号删除"></a>账号删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP USER &#39;user_name&#39;@&#39;hostname&#39;</span><br></pre></td></tr></table></figure>

<h4 id="账号密码修改"><a href="#账号密码修改" class="headerlink" title="账号密码修改"></a>账号密码修改</h4><p>注意：</p>
<ul>
<li>新版MYSQL中用户密码可以保存在mysql.user表的authentication_string字段</li>
<li>旧版的密码在mysql.password字段，如果两个字段都存在数据，那么authentication_string优先级更高</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set password for root@&#39;localhost&#39;  password(&#39;centos&#39;) </span><br></pre></td></tr></table></figure>

<p>官方推荐这样操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter user user_name&#39;@&#39;hostname identified by &#39;password&#39; ;</span><br></pre></td></tr></table></figure>

<p>忘记密码的操作</p>
<p>1.关闭验证环节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--skip-grant-tables</span><br><span class="line">--skip-networking</span><br></pre></td></tr></table></figure>

<p>2.登录mysql数据库，修改密码</p>
<h4 id="账号授权"><a href="#账号授权" class="headerlink" title="账号授权"></a>账号授权</h4><p>权限的类型</p>
<ul>
<li>管理类<ul>
<li>用户管理等</li>
</ul>
</li>
<li>程序类<ul>
<li>函数、存储过程等的控制</li>
</ul>
</li>
<li>数据库级别<ul>
<li>数据库的增改删</li>
</ul>
</li>
<li>表级别<ul>
<li>数据表的增改删</li>
</ul>
</li>
<li>字段级别<ul>
<li>规定哪些字段可以操作，比如select ((col1),(col2)…)</li>
</ul>
</li>
</ul>
<p>操作符：GRANT,REVOKE</p>
<p>所有权限：ALL PRIVILEGES 或 ALL</p>
<p>授权：GRANT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GRANT priv_type [(column_list)]，...ON [object_type] priv_level TO &#39;user&#39;@&#39;host&#39;</span><br><span class="line">[IDENTIFIED BY &#39;PASSWORD&#39;] [WITH GRANT OPTION];</span><br><span class="line"></span><br><span class="line">priv_type：all [privileges]</span><br><span class="line">object_type：table | function | procedure</span><br><span class="line">priv_level：*(所有库) | *.* | db_name.* | db_name.table_name | table_name(当前库的表) | db_name.routine_name(指定库的函数，存储过程，触发器)</span><br><span class="line">with_option：grant option</span><br><span class="line">	| max_queries_per_hour count</span><br><span class="line">	| max_updates_per_hour count</span><br><span class="line">	| max_connections_per_hour count</span><br><span class="line">	| max_user_connections count</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT  ALL PRIVILEGES ON *.* TO &#39;USER_NAME&#39;@&#39;HOSTNAME&#39; IDENTIFIED BY &#39;PASSWORD&#39;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all on hellodb.* to &#39;lv&#39;@&#39;10.0.0.%&#39; ;</span><br><span class="line">#把hellodb下的所有权限发给lv@10.0.0.%用户</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant select on mysql.* to &#39;lv&#39;@&#39;10.0.0.%&#39;;</span><br></pre></td></tr></table></figure>

<p>取消授权：REVOKE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REVOKE priv_type [(column_list)]... on [object_type] priv_level from user..</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; revoke select on mysql.* from &#39;lv&#39;@&#39;10.0.0.%&#39; ;</span><br></pre></td></tr></table></figure>

<p>查看用户权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GRANTS FOR XXX@XXX;</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show grants for &#39;lv&#39;@&#39;10.0.0.%&#39;;</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| Grants for lv@10.0.0.%                                 |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &#39;lv&#39;@&#39;10.0.0.%&#39;                  |</span><br><span class="line">| GRANT ALL PRIVILEGES ON &#96;hellodb&#96;.* TO &#39;lv&#39;@&#39;10.0.0.%&#39; |</span><br><span class="line">| GRANT SELECT ON &#96;mysql&#96;.* TO &#39;lv&#39;@&#39;10.0.0.%&#39;           |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>注意：数据库启动的时候会自动读取mysql库中的全部权限表到内存，对于不能及时重读授权表的命令，可以手动执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>




<h2 id="MySQL架构和性能优化"><a href="#MySQL架构和性能优化" class="headerlink" title="MySQL架构和性能优化"></a>MySQL架构和性能优化</h2><p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200925200135006.png" alt="image-20200925200135006"></p>
<p>Mysql是单进程多线程的</p>
<p>连接器：一个API，支持各种语言开发的连接工具</p>
<p>连接池：认证，线程控制，内存检查</p>
<p>SQL接口：解释器，进行语法检查</p>
<p>解析器：查询翻译、权限检查</p>
<p>寻路优化：访问路径统计</p>
<p>缓存和缓冲区：这个不是上面的缓存访问，而是跟内存和磁盘打交道的缓存</p>
<p>插件存储引擎：面试常问，工作中对于引擎的选择是比较固定的</p>
<p>文件系统：</p>
<p>文件和日志：</p>
<h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><p>mysql是插件式存储引擎，它能够替换使用选择多种不同的引擎</p>
<p>存储引擎负责把具体分析结果完成对磁盘上文件路径访问的转换，数据库中的行数据是存储在磁盘块上的，因此存储引擎要把数据库数据映射为磁盘块，并把磁盘块加载至内存中；（逻辑关系转化成物理数据文件）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">show engines</span><br><span class="line">show variables like &#39;%engine%&#39;</span><br><span class="line">--default_storage_engines,default_storage_engines</span><br><span class="line">storage_engine</span><br><span class="line">show table status from table_name</span><br><span class="line">show create table table_name</span><br><span class="line">create TABLE table_name () ENGINE&#x3D;INNODB</span><br><span class="line">ALTER TABLE table_name ENGINE&#x3D;INNODB</span><br></pre></td></tr></table></figure>

<p><strong>MyISAM和InnoDB的区别</strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>锁的颗粒度</td>
<td>表级锁</td>
<td>行级锁</td>
</tr>
<tr>
<td>集群索引</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>MVCC</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>存储空间</td>
<td>256TB</td>
<td>64TB</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>速度</td>
<td>相对快</td>
<td>相对慢</td>
</tr>
</tbody></table>
<blockquote>
<p>InnoDB：Supports transactions, row-level locking, foreign keys and encryption for tables</p>
<p>MyISAM：Non-transactional engine with good performance and small data footprint</p>
</blockquote>
<p>MVCC：多版本并发控制机制 </p>
<p>​    数据的时间戳，INSERT和DELETE</p>
<p>InnoDB的数据文件是两个，一个数据定义，一个存放数据  </p>
<blockquote>
<p>name.frm  数据定义</p>
<p>name.ibd   真实数据以及索引</p>
</blockquote>
<p>MyISAM数据文件三个，一个索引，一个数据，一个定义</p>
<p>行–&gt;页–&gt;extent–&gt;segment</p>
<p>数据库的读取是以一页作为基本单位，一个页16KB，对比文件系统的块，文件系统的块Block是4KB</p>
<p>存储引擎是对表来说的，是对表的管理，同一个数据库中的表可以用不同的存储引擎</p>
<h3 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h3><ul>
<li><p>MySQL数据库</p>
<p>是MYsql的核心数据库，主要负责存储数据库的用户、权限设置、关键字等Mysql自己需要使用的控制和管理信息</p>
</li>
<li><p>performance_schema</p>
<p>MYsql 5.5 新增的数据库，主要用户手机数据库服务器性能参数，库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PREFORMANCE_SHCEMA的表</p>
</li>
<li><p>information_schema</p>
<p>一个虚拟数据库，物理上并不存在information_schema数据库类似于”数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表明，列类型，访问权限等</p>
</li>
<li><p>sys</p>
<p>MYSQL5.7之后新增加的数据库，库中的所有数据来源于performance_schma，目标是把performance_schema的复杂程度降低，让DBA能更好的阅读这个库里的内容。</p>
</li>
</ul>
<h3 id="服务器配置和状态"><a href="#服务器配置和状态" class="headerlink" title="服务器配置和状态"></a>服务器配置和状态</h3><p>通过mysqld的选项、服务器系统变量和服务器状态变量进行MySQL的配置和查看状态</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html">https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/">https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/</a></p>
<h4 id="服务器选项"><a href="#服务器选项" class="headerlink" title="服务器选项"></a>服务器选项</h4><p>写入配置文件，持久保存</p>
<p>Default options are read from the following files in the given order:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;my.cnf &#x2F;etc&#x2F;mysql&#x2F;my.cnf ~&#x2F;.my.cnf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#打印出当前服务启动时的默认选项</span><br><span class="line">[root@localhost local]#mysqld --print-defaults</span><br><span class="line">mysqld would have been started with the following arguments:</span><br><span class="line">--datadir&#x3D;&#x2F;data&#x2F;mysql --socket&#x3D;&#x2F;data&#x2F;mysql&#x2F;mysql.sock --skip_name_resolve&#x3D;on --port&#x3D;3306</span><br><span class="line">#打印出可用选项</span><br><span class="line">[root@localhost local]#mysql --verbose --help</span><br></pre></td></tr></table></figure>



<h4 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h4><p>变量临时修改，无法持久保存</p>
<p>系统变量分为全局（GLOBAL）和会话（session）两种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show global variables;#查看全局变量</span><br><span class="line">show [session] variables;#查看所有变量</span><br><span class="line">select @@variable;#查看某个变量的值</span><br><span class="line">SET GLOBAL system_var_name&#x3D;value;</span><br><span class="line">SET @@GLOBAL.SYSTEM_VAR_NAME&#x3D;value;</span><br><span class="line">SET system_var_name&#x3D;value;</span><br><span class="line">SET @@system_var_name&#x3D;value;</span><br></pre></td></tr></table></figure>

<p>max_connection 最大连接数，一个数据库1000左右的连接数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--character_set_server,character_set_server</span><br><span class="line">--max_connections,max_connections</span><br><span class="line">#如果该最大连接数不成功，应该是ulimits限制的，可以在&#x2F;etc&#x2F;my.cnf中加一句</span><br><span class="line">LimitNOFILE&#x3D;65535</span><br></pre></td></tr></table></figure>





<h4 id="服务器状态变量"><a href="#服务器状态变量" class="headerlink" title="服务器状态变量"></a>服务器状态变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;variables&#39;;</span><br><span class="line">show global status;</span><br><span class="line">show status;</span><br></pre></td></tr></table></figure>



<h4 id="服务器变量SQL-MODE"><a href="#服务器变量SQL-MODE" class="headerlink" title="服务器变量SQL_MODE"></a>服务器变量SQL_MODE</h4><p>SQL_MODE：对其设置可以完成一些约束检查的工作，可分别进行全局的设置或当前会话的设置</p>
<p>文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/sql-mode/">https://mariadb.com/kb/en/library/sql-mode/</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode">https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--sql_mode,sql_mode</span><br><span class="line">select @@sql_mode;</span><br></pre></td></tr></table></figure>

<p>常见MODE：</p>
<ul>
<li>NO_AUTO_CREATE_USER：禁止GRANT创建密码为空的用户</li>
<li>NO_ZERO_DATE：在严格模式，不允许使用”0000000”的时间</li>
<li>ONLY_FULL_GROUP_BY：对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将认为这个SQL是不合法的</li>
<li>NO_BACKSLASH_ESCAPES：反斜杠“\”被视为普通字符而不是逃逸符</li>
<li>PIPES_AS_CONCAT：将“||”视为连接操作符而非“或”运算符</li>
</ul>
<h3 id="Query-Cache-查询缓存"><a href="#Query-Cache-查询缓存" class="headerlink" title="Query Cache 查询缓存"></a>Query Cache 查询缓存</h3><p>Redis代替</p>
<p>能用别的应用解决，就不要用数据库实现</p>
<p>查询缓存的启用和使用，hash算法，因此对语句的要求很高，必须一模一样，连空格什么的都得一样才能从缓存中读取</p>
<p>查询缓存优化</p>
<h3 id="索引-INDEX"><a href="#索引-INDEX" class="headerlink" title="索引 INDEX"></a>索引 INDEX</h3><h4 id="索引介绍"><a href="#索引介绍" class="headerlink" title="索引介绍"></a>索引介绍</h4><p>索引是排序的快速查找的特殊数据结构，定义作为查找条件的字段上，又称为键key，索引通过存储引擎实现</p>
<p>适合读操作；不适合频繁更改的数据表</p>
<p>优点</p>
<ul>
<li>索引可以降低服务器需要扫描的数据量，减少了IO次数</li>
<li>索引可以帮助服务器避免排序和使用临时表</li>
<li>索引可以帮助将随机I/O转为顺序I/O</li>
</ul>
<p>缺点</p>
<ul>
<li>占用额外空间，影响插入速度</li>
</ul>
<p>索引类型：</p>
<ul>
<li>B+ TREE,HASH,R TREE,FULL TEXT</li>
<li>聚簇索引，非聚簇索引：数据和索引是否存储在一起</li>
<li>主键索引、二级索引</li>
<li>稠密索引、稀疏索引：是否引用了每一个数据项</li>
<li>简单索引、组合索引</li>
<li>左前缀索引：取前面的字符做索引</li>
<li>覆盖索引：从索引中即可取出要查询的数据，性能高</li>
</ul>
<h5 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h5><p>参考链接 : <a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">https://www.cs.usfca.edu/~galles/visualization/Algorithms.html</a></p>
<ul>
<li><p>二叉树</p>
</li>
<li><p>红黑树</p>
</li>
<li><p>B树</p>
</li>
<li><p>Hash索引</p>
<p>基于哈希表实现，只有精确匹配索引中的所有列的查询才有效，索引自身只存储索引列对应哈希值和数据指针，索引结构紧凑，查询性能好；Memory存储引擎支持显式HASH索引，适用于：= &lt;=&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&#x3D;&gt; 符号是专门比较NULL值的，表示等于NULL，也就是 IS NULL</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>B+树，INNODB就是用B+树作为索引</li>
</ul>
<p>B+树索引的特点：</p>
<p>1.查询类型</p>
<ul>
<li>全值匹配：精确所有索引列，如：姓lv,名zhehui,年龄25</li>
<li>匹配最左侧前缀：即只使用索引的第一列，如：姓lv</li>
<li>匹配列前缀：只匹配一列值的开头部分，如：姓以l开头的记录</li>
<li>匹配范围值：如：姓lv和wang之间</li>
<li>精确匹配某一列范围并范围匹配另一列：如：姓lv，名以z开头的记录</li>
<li>只访问索引的查询</li>
<li>如果不从最左列开始，则无法使用索引，如：查询名为zhehui,或姓的结尾是g</li>
<li>不能跳过索引中的列：？如：查找姓wang，年龄30，只能使用索引第一列</li>
</ul>
<p>mysql中 a% 可以利用索引模糊查询 %a就不可以利用索引了</p>
<p>B+树具有查询次数少，可查询数据数量大的特点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">B+树的数据存放量计算：</span><br><span class="line">1.B+树的高度</span><br><span class="line">2.根节点的指针数</span><br><span class="line">3.单个叶子记录的行数</span><br><span class="line">1*2*3 得到的就是总的行数据</span><br><span class="line">例子：</span><br><span class="line">1.B+树高2层</span><br><span class="line">2.根节点的指针数：大小16KB，一个指针6B，主键ID的数据类型是bigint，占8B，那么指针数就是：16KB&#x2F;14B&#x3D;1170个指针</span><br><span class="line">3.单个叶子记录的行数:大小16KB，一个记录1KB，那么就是16条记录</span><br><span class="line">所以总的记录数是：16*1170&#x3D;18720</span><br><span class="line">当B+树是3层的时候就是 16*1170*1170&#x3D;21902400，两千万级别的数据量</span><br></pre></td></tr></table></figure>



<h4 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h4><ul>
<li>独立地使用列：尽量避免其参与运算，独立的列指索引列不能是表达式的一部分，也不能是函数的参数，在where条件中，始终将索引列单独放在比较符号的一侧，尽量不要在列上进行运算</li>
<li>左前缀索引：构建指定索引字段的左侧的字符数，要通过索引选择性（不重复的索引值和数据表的记录总数的比值）来评估，尽量使用短索引，如果可以，应该制定一个前缀长度</li>
<li>多列索引：AND操作时适合使用多列索引，而非为每个列创建单独的索引</li>
<li>选择合适的索引列顺序：无排序和分组时，将选择性最高的列放左侧</li>
<li>只要列中含有NULL值，就最好不要在此列设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引</li>
<li>对于经常在where子句使用的列，最好设置索引</li>
<li>对于有多个列where或者order by子句，应该建立复合索引</li>
<li>对于like子句，以%或_开头的列不会使用索引，以%结尾会使用索引</li>
<li>尽量不要使用not in 和 &lt;&gt; 操作，虽然可以使用索引，但是性能不高</li>
<li>不要使用RLIKE正则表达式，这会导致索引失效</li>
<li>查询时，能不要使用“*”就不要使用，尽量写字段名，比如：select id,name,age from students;</li>
<li>大部分情况连接效率远大于子查询</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启查询缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的SQL语句优化</li>
</ul>
<h4 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h4><ul>
<li>创建索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX INDEX_NAME ON table_name(col(length));</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name ADD  INDEX index_name(index_col_name[length]);</span><br></pre></td></tr></table></figure>

<ul>
<li>查看索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEXES FROM table_name;</span><br><span class="line"></span><br><span class="line">set global userstat&#x3D;1;#开启统计</span><br><span class="line">show index_statistics;#统计有多少查询利用了索引</span><br></pre></td></tr></table></figure>

<ul>
<li>优化表空间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE table_name;</span><br></pre></td></tr></table></figure>



<ul>
<li>删除索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEXES INDEX_NAME ON table_name;</span><br></pre></td></tr></table></figure>

<p>ExPLAIN工具</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">explain select_statment</span><br><span class="line">例子：</span><br><span class="line">MariaDB [hellodb]&gt; explain select stuid,name,age,classid from students where stuid&#x3D;10;</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">| id   | select_type | table    | type  | possible_keys | key     | key_len | ref   | rows | Extra |</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">|    1 | SIMPLE      | students | const | PRIMARY       | PRIMARY | 4       | const | 1    |       |</span><br><span class="line">+------+-------------+----------+-------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>explain输出信息说明：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>执行编号，标识select所属的行</td>
</tr>
<tr>
<td>select_type</td>
<td>SIMPLE|PRIMARY</td>
</tr>
<tr>
<td>table</td>
<td>访问引用哪个表</td>
</tr>
<tr>
<td>type</td>
<td>关联类型或访问类型，即MYSQL决定的如何去查询表中的行的方式</td>
</tr>
<tr>
<td>possible_keys</td>
<td>查询可能会用到的索引</td>
</tr>
<tr>
<td>key</td>
<td>显示mysql决定采用哪个索引来优化查询</td>
</tr>
<tr>
<td>key_len</td>
<td>显示mysql在索引里使用的字节数</td>
</tr>
<tr>
<td>ref</td>
<td>根据索引返回表中匹配某单个值的所有行</td>
</tr>
<tr>
<td>rows</td>
<td>为了找到所需的行而需要读取的行数，估算值，不精确</td>
</tr>
<tr>
<td>extra</td>
<td>额外信息</td>
</tr>
</tbody></table>
<p>type类型：type类型是访问类型，结果值从好到坏依次是：</p>
<p>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; all，一般来说，得保证查询至少到达range级别，最好到ref</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>最坏的情况，全表扫描</td>
</tr>
<tr>
<td>index</td>
<td>和全表一样。</td>
</tr>
<tr>
<td>range</td>
<td>范围扫描，一个有限制的索引扫描</td>
</tr>
<tr>
<td>ref</td>
<td>一种索引访问，它返回所有匹配某单个值的行</td>
</tr>
<tr>
<td>eq_ref</td>
<td>最多只返回一条符合条件的记录</td>
</tr>
<tr>
<td>const</td>
<td>当确定最多只会有一行匹配的时候，mysql优化器会在查询前读取它而且只读取一次，因此非常快</td>
</tr>
<tr>
<td>system</td>
<td>这个const连接类型的一种特例，表仅有一行满足条件</td>
</tr>
<tr>
<td>null</td>
<td>意味着mysql能在优化阶段分解查询语句，在执行阶段甚至用不到访问表或索引</td>
</tr>
</tbody></table>
<h3 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h3><h4 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h4><p>锁：</p>
<ul>
<li>读锁，共享锁，也称S锁，只读不可写（包括当前事务），多个读互不阻塞</li>
<li>写锁：独占锁，排他锁，也称为X锁，写锁会阻塞其他事务的读和写</li>
</ul>
<p>读锁和读锁是兼容的，写锁和其他锁都不兼容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如：</span><br><span class="line">  S锁和S锁是兼容的，X锁和其他锁都不兼容，举个例子，事务T1获取了一个行r1的S锁，另一个事务T2还可以获得行r1的S锁，此时T1和T2共同获得r1的S锁，此种情况称为锁兼容；但是当另外一个事务T3此时如果想获得行r1的X锁，则必须等到r1的全部锁释放之后才可以，此种情况称为锁冲突</span><br></pre></td></tr></table></figure>

<p>锁的颗粒度</p>
<ul>
<li>表级锁：MyISAM</li>
<li>行级锁：InnoDB</li>
</ul>
<p>实现：</p>
<ul>
<li>存储引擎</li>
<li>服务器级</li>
</ul>
<p>分类：</p>
<ul>
<li>隐式锁：由搜索引擎自动加锁</li>
<li>显式锁：用户手动请求</li>
</ul>
<p>锁策略：在锁颗粒度及数据安全性寻求的平衡机制</p>
<h4 id="显式使用锁"><a href="#显式使用锁" class="headerlink" title="显式使用锁"></a>显式使用锁</h4><p>帮助:<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/lock-tables/">https://mariadb.com/kb/en/lock-tables/</a></p>
<p>加锁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lock tables table_name lock_type;</span><br><span class="line">lock_type:READ和WRITE</span><br></pre></td></tr></table></figure>

<p>解锁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock  tables;</span><br></pre></td></tr></table></figure>

<p>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH TABLES [table_name] [with read lock]</span><br></pre></td></tr></table></figure>



<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>事务：Transactions 一组原子性的SQL语句，或一个独立的工作单元</p>
<p>事务日志：记录事务信息，实现undo,redo等故障恢复功能</p>
<h5 id="事务特性"><a href="#事务特性" class="headerlink" title="事务特性"></a>事务特性</h5><p><strong>ACID特性：</strong></p>
<p>A：automicity 原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</p>
<p>C：consistency 一致性；数据库总是从一个一致性状态转换成另一个一致性状态</p>
<p>I：isolation 隔离性；一个事务所做出的的操作在提交之前，是不能为其他事务所见；隔离有多种隔离级别，实现并发</p>
<p>D：durability 持久性；一旦事务提交，其所做的修改会永久保存于数据库中</p>
<p>Transcation 生命周期</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200926192208219.png" alt="image-20200926192208219"></p>
<h5 id="管理事务"><a href="#管理事务" class="headerlink" title="管理事务"></a>管理事务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--autocommit,autocommit</span><br></pre></td></tr></table></figure>

<p>显示启动事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">BEGIN WORK</span><br><span class="line">START TRANSACTION</span><br></pre></td></tr></table></figure>

<p>结束事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#提交</span><br><span class="line">COMMIT</span><br><span class="line">#回滚</span><br><span class="line">ROLLBACK</span><br></pre></td></tr></table></figure>

<p>注意：1.只有事务性存储引擎支持（存储引擎支持事务）</p>
<p>​            2.只有DML语句可以,DDL语句无法回滚!(CREATE,DROP,TRUNCATE,ALTER)</p>
<p>自动提交：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set autocommit&#x3D;&#123;1|0&#125;</span><br><span class="line">默认为1，为0时设为非自动提交</span><br><span class="line">建议：显示请求和提交事务，而不要使用“自动提交”功能</span><br></pre></td></tr></table></figure>

<p>事务支持保存点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SAVEPOINT identifier</span><br><span class="line">ROLLBACK [WORK] TO [SAVEPOINT] identifier</span><br><span class="line">RELEASE SAVEPOINT identifier</span><br></pre></td></tr></table></figure>

<p>查看事务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查看当前正在进行的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line">#查看当前锁定的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;</span><br><span class="line">#查看当前等锁的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br><span class="line">#查看当前进程，如果有事务被锁可以通过进程号杀死</span><br><span class="line">show processlist;</span><br><span class="line">#杀死</span><br><span class="line">kill id;</span><br></pre></td></tr></table></figure>



<h5 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h5><p>MYsql支持四种隔离级别</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>加读锁</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td>可以出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>读提交</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>可重复读</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>序列化</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>是</td>
</tr>
</tbody></table>
<p>读未提交：READ UNCOMMITTED</p>
<p>​    可读取到未提交数据，产生脏读</p>
<p>读提交：READ COMMITTED</p>
<p>​    可读取到提交数据，但未提交数据不可读，产生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致</p>
<p>可重复读：REPETABLE READ</p>
<p>​    可重复读，多次读取数据都一致，产生幻读，即读取过程中，即使有其他提交的事务修改数据，仍只能读取到未修改前的旧数据。此为mysql默认设置</p>
<p>序列化：SERIALIZABLE</p>
<p>​    可串行化，未提交的读事务阻塞修改事务（加读锁，但不阻塞读事务），或者未提交的修改事务阻塞读事务（加写锁，其他事务的读，写都不可以执行）。会导致并发性能差</p>
<p>MVCC和事务的隔离级别：</p>
<p>MVCC（多版本并发控制机制）只在REPETABLE READ 和 READ COMMITED 两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为READ UNCOMMITED总是读取最新的数据行，而不是符合当前事务版本的数据行。而SERIALIZABLE则会对所有读取的行都加锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MVCC：Multi-Version Concurrency Control</span><br></pre></td></tr></table></figure>

<p>插入时间戳，根据时间戳来管理要查询到的数据；MVCC只对读有效果，对写无效；</p>
<p>幻读：幻读产生的原因是事务的写操作；T1事务第一次select出来的内容是A，然后T2事务执行了一个插入数据的操作并提交了，本来这样的操作在可重复读的隔离级别中T1是看不到数据改变的，但是T1接下来执行了一个UPDATE操作，update操作修改的数据恰好匹配到了T2刚刚提交的数据，那么这个数据就会被T1修改，接下来T1执行select就会看到T2提交的数据，当然已经被update修改过了。这就是幻读，第一次select和第二次select看到的内容不一致。</p>
<p>指定事务隔离级别：</p>
<p>变量：tx_isolation</p>
<p>服务器选项：transaction-isolation</p>
<ul>
<li>服务器变量tx_isolation指定，默认为REPETABLE READ，可在GLOBAL和SESSION级进行设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET tx_isolation&#x3D;&#39;READ-UNCOMMITED|READ-COMMITED|REPETABLE-READ|SERIALIZABLE&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务器选项中指定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[myslqd]</span><br><span class="line">transaction-isolation&#x3D;SERIALIZABLE</span><br></pre></td></tr></table></figure>

<p>死锁：</p>
<p>两个或多个事务在同一资源互相占用，并请求锁定对方占用的资源的状态</p>
<p>当要出现死锁时，数据库会自动发现并解决，解决方式是停止执行时间短的那个事务</p>
<h3 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h3><p>Mysql支持丰富的日志类型，如下：</p>
<ul>
<li>事务日志：transaction log</li>
</ul>
<blockquote>
<p>事务日志的写入类型为“追加”，因此其操作为“顺序IO”；通常也被称为：预写式日志 write ahead logging</p>
</blockquote>
<blockquote>
<p>事务日志文件：ib_logfile0,ib_logfile1</p>
</blockquote>
<ul>
<li>错误日志 error log</li>
<li>通用日志 general log</li>
<li>慢查询日志 slow query log</li>
<li>二进制日志 binary log</li>
<li>中继日志 reley log，在主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件</li>
</ul>
<h4 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h4><p>事务日志：transaction log</p>
<ul>
<li>redo log：实现WAL（Write Ahead Log），数据更新前先记录redo log  具体名字是：ib_logfile 默认最多50M，默认两个文件，写满就重新写，建议把这个存储值的大小调整大一些，文件个数调整成3个，存放的位置建议是一个干净的只放日志的分区，这样速度更快</li>
<li>undo log：保存与执行的操作相反的操作，用于实现rollback  具体的文件是在每个数据表的name.ibd中</li>
</ul>
<p>事务型存储引擎自行管理和使用，建议和数据文件分开存放</p>
<p>Innodb事务日志相关配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show variables like &#39;%innodb_log%&#39;;</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">| Variable_name               | Value     |</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">| innodb_log_buffer_size      | 16777216  |</span><br><span class="line">| innodb_log_checksums        | ON        |</span><br><span class="line">| innodb_log_compressed_pages | ON        |</span><br><span class="line">| innodb_log_file_size        | 100663296 |</span><br><span class="line">| innodb_log_files_in_group   | 1         |</span><br><span class="line">| innodb_log_group_home_dir   | .&#x2F;        |</span><br><span class="line">| innodb_log_optimize_ddl     | OFF       |</span><br><span class="line">| innodb_log_write_ahead_size | 8192      |</span><br><span class="line">+-----------------------------+-----------+</span><br><span class="line">8 rows in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">innodb_log_file_size #每个日志文件大小</span><br><span class="line">innodb_log_files_in_group #日志组成员个数</span><br><span class="line">innodb_log_group_home_dir #事务文件路径</span><br><span class="line">innodb_flush_log_at_trx_commit #默认为1</span><br></pre></td></tr></table></figure>

<p>事务日志性能优化</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201009104011312.png" alt="image-20201009104011312"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit&#x3D;0|1|2</span><br><span class="line">1 此为默认值，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。完全遵循ACID特性，但是磁盘I&#x2F;O会变多，对数据来说最安全</span><br><span class="line">0 提交时没有写磁盘的操作；而是每秒执行一次将日志缓冲区的提交的事务写入刷新到磁盘。这样可提供更好的性能，但数据库服务崩溃可能丢失最后一秒的事务，速度最快，I&#x2F;O</span><br><span class="line">2 每次提交后都会写入OS的缓冲区，但每秒才会进行一次刷新到磁盘文件的操作。性能比0略差一些，但操作系统或停电可能导致最后一秒的数据丢失。</span><br><span class="line">1模式最慢但最安全；</span><br><span class="line">0模式最快但不安全；</span><br><span class="line">2模式中等速度中等安全</span><br><span class="line">推荐2模式</span><br></pre></td></tr></table></figure>



<h4 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h4><p>mysql启动和关闭过程中输出的事件信息</p>
<p>记录mysql运行过程中产生的错误信息</p>
<p>event_scheduler运行一个event时产生的日志信息</p>
<p>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</p>
<p>错误文件路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOABL VARIABLES LIKE &#39;log_error&#39;;</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| Variable_name | Value                  |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| log_error     | &#x2F;data&#x2F;mysql&#x2F;mysqld.log |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">1 row in set (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>记录哪些警告信息至错误日志文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log_warnings&#x3D;0|1|2|3...</span><br><span class="line">MariaDB [(none)]&gt; show variables like &#39;log_warnings&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_warnings  | 2     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure>

<h4 id="通用日志"><a href="#通用日志" class="headerlink" title="通用日志"></a>通用日志</h4><p>通用日志：记录对数据库的通用操作，包括错误的SQL语句</p>
<p>通用日志可以保存在file(默认值)或table(mysql.general_log)</p>
<p>通用日志相关设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">general_log&#x3D;ON|OFF</span><br><span class="line">general_log_file&#x3D;HOSTNAME.log</span><br><span class="line">log_output&#x3D;TABLE|FILE|NONE</span><br></pre></td></tr></table></figure>

<p>范例：查找执行次数最多的前三个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select argument,count(argument) from general_log group by argument order by count(argument) desc limit 3</span><br></pre></td></tr></table></figure>

<p>范例：对访问的语句进行排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#mysql -uroot -p&#39;centos&#39; -e &quot;select argument from mysql.general_log&quot; | awk &#39;&#123;sql[$0]++&#125;END&#123;for (i in sql) &#123;print sql[i],i&#125;&#125;&#39;|sort -nr</span><br></pre></td></tr></table></figure>



<h4 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h4><p>慢查询日志：记录执行查询时长超出指定时长的操作</p>
<p>慢查询相关变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log&#x3D;ON|OFF #开启或关闭慢查询，支持全局和会话，只有全局设置才会生成慢查询</span><br><span class="line">long_query_time&#x3D;N #慢查询的阈值，单位秒，默认为10s</span><br><span class="line">slow_query_log_file&#x3D;HOSTNAME-slow.log #慢查询日志</span><br><span class="line">log_slow_filter&#x3D;admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk</span><br><span class="line">#只有是上述查询类型且查询时长超过long_query_time阈值，才记录日志</span><br><span class="line">log_queries_not_using_indexes&#x3D;ON #不使用索引或使用全索引扫描的情况下，不论是否达到慢查询阈值。是不是要记录，默认是不记录的</span><br><span class="line">log_slow_rate_limit&#x3D;1 #多少次查询才记录，mariadb特有</span><br><span class="line">log_slow_verbosity&#x3D;query_plan,explain #记录内容</span><br><span class="line">log_slow_queries&#x3D;off #同slow_query_log</span><br></pre></td></tr></table></figure>

<p>慢查询分析工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#mysqldumpslow -s c -t 10 &#x2F;data&#x2F;mysql&#x2F;slow.log</span><br></pre></td></tr></table></figure>



<h4 id="使用profile工具"><a href="#使用profile工具" class="headerlink" title="使用profile工具"></a>使用profile工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启profile工具</span><br><span class="line">set profiling &#x3D; on</span><br><span class="line">#查看查询语句的执行时间</span><br><span class="line">show profiles;</span><br><span class="line">#显示语句的详细执行步骤和时长</span><br><span class="line">show profile for query N;  # N 是通过show profiles 看到的ID</span><br><span class="line">#显示CPU使用情况</span><br><span class="line">show profile cpu for query N # N 是 看到的ID</span><br></pre></td></tr></table></figure>



<h4 id="二进制日志（备份）"><a href="#二进制日志（备份）" class="headerlink" title="二进制日志（备份）"></a>二进制日志（备份）</h4><h5 id="二进制日志的作用："><a href="#二进制日志的作用：" class="headerlink" title="二进制日志的作用："></a>二进制日志的作用：</h5><ul>
<li>记录导致数据改变或潜在导致数据改变的SQL语句</li>
<li>记录已提交的日志</li>
<li>不依赖于存储引擎类型</li>
</ul>
<p>通过“重放”二进制日志文件中的事件来生成数据副本</p>
<p>建议二进制文件和数据文件分开存放</p>
<h5 id="二进制日志记录的三种模式"><a href="#二进制日志记录的三种模式" class="headerlink" title="二进制日志记录的三种模式"></a>二进制日志记录的三种模式</h5><ul>
<li>基于“语句”记录：statement，记录语句，默认模式（mariadb 10.2.3以下），日志量较少</li>
<li>基于“行”记录：row，记录数据，日志量较大，更加安全，建议使用的格式</li>
<li>混合模式：mixed，让系统自行判断该基于哪种方式进行，默认模式（mariadb 10.2.4以上）</li>
</ul>
<h5 id="格式配置"><a href="#格式配置" class="headerlink" title="格式配置"></a>格式配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#mariadb 10.5.5 默认是mixed</span><br><span class="line">MariaDB [hellodb]&gt; show variables like &#39;binlog_format&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | MIXED |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">#MYsql 8.0 中默认是row</span><br><span class="line">mysql&gt; show variables like &#39;binlog_format&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.06 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="二进制文件的构成"><a href="#二进制文件的构成" class="headerlink" title="二进制文件的构成"></a>二进制文件的构成</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">有两类文件</span><br><span class="line">1.日志文件，mysql|mariadb-bin.文件名后缀，二进制格式，如：mariabd-bin.00001</span><br><span class="line">2.索引文件：mysql|mariadb-bin.index，文本格式</span><br></pre></td></tr></table></figure>

<p>二进制日志相关的服务器变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sql_log_bin&#x3D;ON|OFF #是否记录二进制文件，默认on，支持动态修改，系统变量，不是服务器参数</span><br><span class="line"></span><br><span class="line">log_bin&#x3D;&#x2F;path&#x2F;bin_log_file #指定文件位置，默认为OFF</span><br><span class="line">将需要存储二进制日志的目录加上权限：chown -R mysql:mysql &#x2F;data</span><br><span class="line"></span><br><span class="line">binlog_format&#x3D;statement|row|mixed #二进制日志记录的格式，默认为</span><br><span class="line">statement</span><br><span class="line"></span><br><span class="line">max_binlog_size&#x3D;1073741824 #单个二进制文件的最大体积，到达最大值会自动滚动，默认为1G。但是文件达到上限时的文件大小未必为指定的精确值</span><br><span class="line"></span><br><span class="line">binlog_cache_size&#x3D;4M #此变量确定在每次事务中保存二进制日志更改记录的缓存的大小</span><br><span class="line"></span><br><span class="line">max_binlog_cache_size&#x3D;512M #限制用于缓存多事务查询的字节的大小</span><br><span class="line"></span><br><span class="line">sync_binlog&#x3D;1|0 #设定是否启动二进制日志即时同步磁盘功能，默认为0，由操作系统负责同步日志到磁盘</span><br><span class="line"></span><br><span class="line">expire_logs_days&#x3D;N #二进制日志可以自动删除的天数，默认为0，即不自动删除</span><br></pre></td></tr></table></figure>

<h5 id="二进制日志相关的配置"><a href="#二进制日志相关的配置" class="headerlink" title="二进制日志相关的配置"></a>二进制日志相关的配置</h5><p>查看数据库自行管理使用中的二进制日志文件列表和大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binary logs;</span><br></pre></td></tr></table></figure>

<p>查看使用中的二进制日志文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status</span><br></pre></td></tr></table></figure>

<p>查看二进制文件中的指定内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binlog events [in &#39;log_name&#39;] [from pos][limit [offset,] row_count]</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binlog events in &#39;bin.xxxxx&#39; from number1 limit xxx,xxx</span><br></pre></td></tr></table></figure>

<p>生成新的二进制文件的方式：</p>
<p>1.重启数据库服务</p>
<p>2.单个文件达到最大值，max_binlog_size</p>
<p>3.flush logs;</p>
<h5 id="myslqbinlog"><a href="#myslqbinlog" class="headerlink" title="myslqbinlog"></a>myslqbinlog</h5><p>mysqlbinlog:二进制日志的客户端命令工具，支持离线查看二进制日志</p>
<p>命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [options] logfile...</span><br><span class="line">	--start-position&#x3D; #开始位置</span><br><span class="line">	--stop-position&#x3D;</span><br><span class="line">	--start-datatime&#x3D; #开始时间，时间格式是：YYYY-MM-DD hh:mm:ss</span><br><span class="line">	--stop-datetime&#x3D;</span><br><span class="line">	--base64-output[&#x3D;name]</span><br><span class="line">	-v -vvv</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 mysql]#mysqlbinlog --start-position&#x3D;678 --stop-position&#x3D;752 binlog.000001 -v</span><br></pre></td></tr></table></figure>

<p>二进制日志事件的格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># at 328</span><br><span class="line">#151105 16:31:30 server id 1 end_log_pos 431 query thread_id&#x3D;1</span><br><span class="line">exec_time&#x3D;0 error_code&#x3D;0</span><br><span class="line">use &#96;mydb&#96;&#x2F;*!*&#x2F;;</span><br><span class="line">set timestamp&#x3D;1446712300&#x2F;*!*&#x2F;;</span><br><span class="line">create table tb1 (id int,name char(30))</span><br><span class="line">&#x2F;*!*&#x2F;;</span><br><span class="line">事件发生的日期和时间：151105 16:31:30</span><br><span class="line">事件发生的服务器标识：server id 1</span><br><span class="line">事件的结束位置：end_log_pos 431</span><br><span class="line">事件的类型：query</span><br><span class="line">事件发生时所在服务器执行此时间的线程的ID：thread_id&#x3D;1</span><br><span class="line">语句的时间戳与将其写入二进制文件中的时间差：exec_time&#x3D;0</span><br><span class="line">错误代码：error_code&#x3D;0</span><br><span class="line">事件内容：</span><br><span class="line">use &#96;mydb&#96;&#x2F;*!*&#x2F;;</span><br><span class="line">set timestamp&#x3D;1446712300&#x2F;*!*&#x2F;;</span><br><span class="line">create table tb1 (id int,name char(30))</span><br><span class="line">&#x2F;*!*&#x2F;;</span><br></pre></td></tr></table></figure>

<p>清除指定二进制日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PURGE &#123;BINARY|MASTER&#125; LOGS &#123;TO &#39;log_name&#39; |BEFROE datetime_expr&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PURGE BINARY LOGS TO &#39;bin.xxxx&#39;;</span><br><span class="line">PURGE BINARY LOGS BEFROE &#39;2018-01-01&#39;</span><br></pre></td></tr></table></figure>

<p>删除所有二进制日志，index文件重新计数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESET MASTER [TO NUMBER]；#删除所有二进制日志文件，并重新生成日志文件，文件名从&#39;NUMBER&#39;开始计数，默认从1开始，一般是master主机第一次启动时执行</span><br></pre></td></tr></table></figure>

<p>切换日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FULSH LOGS;</span><br></pre></td></tr></table></figure>






<h2 id="MySQL备份和恢复"><a href="#MySQL备份和恢复" class="headerlink" title="MySQL备份和恢复"></a>MySQL备份和恢复</h2><h3 id="备份恢复概述"><a href="#备份恢复概述" class="headerlink" title="备份恢复概述"></a>备份恢复概述</h3><p>1.为什么要备份：</p>
<p>​    灾难恢复；硬件故障；软件故障；自然灾害；黑客攻击；误操作；</p>
<p>2.备份的类型：</p>
<ul>
<li>完全备份，部分备份<ul>
<li>完全备份：整个数据库全部数据</li>
<li>部分备份：只备份数据，是一个子集</li>
</ul>
</li>
<li>完全备份、增量备份、差异备份<ul>
<li>增量备份：在完全备份以及之前的增量备份的基础上，只备份变化的数据，备份较快，恢复复杂，也就是下一次增量备份是建立在之前备份的基础上的，增量备份文件个数会越来越多，他的备份参照物是第一次完全备份文件以及之后每次的增量备份文件</li>
<li>差异备份：在完全备份的基础上，只备份与完全备份时不相同的数据。备份较慢，恢复简单。他的参照物就是第一次的完全备份，之后每次的差异备份都会把当今的数据和完全备份的数据进行对比，然后把有差异的部分备份下来。他的备份文件就是两部分，一部分是完全备份，一部分是差异备份，但是时间长了，差异备份文件就会变大，备份起来也更慢</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200928095706768.png" alt="增量备份"></p>
<p>​                                    图1.增量备份</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200928095754867.png" alt="差异备份"></p>
<p>​                                    图2.差异备份</p>
<ul>
<li><p>冷备份、温备份、热备份</p>
<ul>
<li>冷备份：读、写操作均不可进行，数据库停止服务</li>
<li>温备份：读操作可执行，但写操作不可执行</li>
<li>热备份：读、写操作均可执行</li>
</ul>
<p>注：MyISAM支持冷备份和温备份，不支持热备份；InnoDB三种备份都支持</p>
</li>
<li><p>物理备份和逻辑备份</p>
<ul>
<li>物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快</li>
<li>逻辑备份：从数据库中“导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度</li>
</ul>
</li>
</ul>
<p>3.备份什么</p>
<ul>
<li><p>数据</p>
</li>
<li><p>二进制日志、InnoDB事务日志</p>
</li>
<li><p>用户账户，权限设置，程序代码（存储过程、函数、触发器、事件调度器）</p>
</li>
<li><p>服务器的配置文件</p>
</li>
<li><p>表、视图、触发器存放在对应数据库的文件夹下</p>
<p>函数、存储过程存放在mysql.proc表中</p>
<p>事件存放在mysql.event表中</p>
</li>
</ul>
<p>物理备份：</p>
<ul>
<li>/data/mysql/* 所有数据文件</li>
<li>/etc/my.cnf 服务配置文件</li>
<li>/data/logbin/* 二进制日志</li>
</ul>
<p>逻辑备份：</p>
<ul>
<li>mysql库（这里也包括了函数、存储过程、事件）</li>
<li>用户数据库</li>
</ul>
<p>4.备份注意要点</p>
<ul>
<li>能容忍最多丢失多少数据</li>
<li>备份产生的负载</li>
<li>备份过程的时长</li>
<li>温备份的持续锁多久</li>
<li>恢复数据需要在多长时间内完成</li>
<li>需要备份和恢复哪些数据</li>
</ul>
<p>5.还原要点</p>
<ul>
<li><strong>做还原测试，用于测试备份的可用性</strong></li>
<li><strong>还原演练，写成规范的技术文档</strong></li>
</ul>
<p>6.备份工具</p>
<ul>
<li>cp,tar等复制归档工具；物理备份工具，适用于所有存储引擎；只支持冷备；完全和部分备份</li>
<li>LVM的快照：先加读锁，做快照后解锁，几乎热备；借助文件系统工具进行备份</li>
<li>mysqldump：逻辑备份工具，适用于所有存储引擎，支持完全备份和部分备份；对InnoDB存储引擎支持热备，结合binlog的增量备份；对MyISAM存储引擎进行温备份；</li>
<li>xtrabackup：由Percona提供的支持对InnoDB做热备（物理备份）的工具，支持完全备份、增量备份</li>
<li>MariaDB Backup：从MariaDB10.1.26开始集成</li>
<li>mysqlbackup：热备份</li>
<li>mysqlhotcopy：Perl语言实现，几乎冷备份，仅适用于MyISAM存储引擎，使用LOCK TABLES、FLUSH TABLES和cp或scp来快速备份数据库</li>
</ul>
<h3 id="mysqldump备份工具"><a href="#mysqldump备份工具" class="headerlink" title="mysqldump备份工具"></a>mysqldump备份工具</h3><p>避免DDL语句的出现</p>
<h4 id="mysqldump-说明"><a href="#mysqldump-说明" class="headerlink" title="mysqldump 说明"></a>mysqldump 说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqldump database [table]  #支持指定数据库和数据表的备份，但是数据库本身的定义没有备份，不推荐使用</span><br><span class="line">OR</span><br><span class="line">mysqldump [options] -B database1 [db2,db3...]  #支持指定数据库备份，包含数据库本身定义也会备份，推荐使用</span><br><span class="line">OR</span><br><span class="line">mysqldump [options] -A [options]   #备份所有数据库，包含数据库本身定义也会备份，注意information_schema和performance_schema表不会备份，这两个是内存中使用的表</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-A,--all-databases #备份所有数据库，包含数据库定义语句；不备份Information_schema和performance_schema表</span><br><span class="line">-B --database db_name  #指定备份的数据库，包括数据库定义语句</span><br><span class="line">-E --events  #备份相关的所有event scheduler</span><br><span class="line">-R --routines  #备份所有函数和存储过程</span><br><span class="line">--triggers  #备份所有触发器，默认启用</span><br><span class="line">--default-character-set&#x3D;  #指定默认字符集</span><br><span class="line">--master-data[&#x3D;N]  #这个选项必须开启二进制日志使用</span><br><span class="line">#选项是1或者2；默认是1；</span><br><span class="line">#这个选项本身的意思是在生成的备份文件中（*.sql）添加一句 CHANGE MASTER TO 语句，1是不注释这句话，适合用于主从复制，2是注释这句话，适合单机使用</span><br><span class="line">#CHANGE MASTER TO 指明了备份完的数据库后面的内容从哪里继续了，给人一个明确的文件和文件位置</span><br><span class="line">#这个选项会默认打开-x或者--lock-all-tables功能，也就是锁全表功能，除非打开了--single-transaction选项</span><br><span class="line">-F --flush-logs  #锁表完成后刷新日志，从新的日志文件开始，配合-A或-B的话会导致多次刷新日志，可以配合--single-transaction，--master-data，这样就只刷新一次</span><br><span class="line">--compact   #去掉注释的内容，适合调试时使用，节约一些空间，生产中不用</span><br><span class="line">-d --no-data  #只备份数据结构，不备份数据，即备份create xxxx</span><br><span class="line">-t --no-create-info  #只备份数据，不备份结构，即没有create xxx</span><br><span class="line">-n --no-create-db  #不备份create database，可以被-A和-B覆盖</span><br><span class="line">--flush-privileges  #刷新权限，备份mysql库时要使用</span><br><span class="line">-f --force #忽略SQL错误，继续执行</span><br><span class="line">--hex-blob  #使用十六进制符号转储二进制列，当包含BINARY,VARBINARY,BLOB,BIT的数据类型的列时使用</span><br><span class="line">-q --quick  #不缓存查询，直接输出，加快备份速度</span><br><span class="line"></span><br><span class="line">与MyISAM存储引擎有关的备份选项：</span><br><span class="line">MyISAM不支持事务，只能支持温备，不支持热备，所以备份前要锁定要备份的数据库，而后启动备份操作</span><br><span class="line">-x --lock-all-tables  #加全局读锁，锁定所有库的所有表</span><br><span class="line">-l --lock-tables  #对于需要备份的每个数据库，在启动备份之前分别锁定其所有表</span><br><span class="line"></span><br><span class="line">与InnoDB存储引擎有关的备份选项：</span><br><span class="line">InnoDB存储引擎支持事务，可以利用事务的相应的隔离级别，实现热备，也可以实现温备，但不建议使用</span><br><span class="line">--single-transaction</span><br><span class="line">此选项在备份前开启一个事务，start transaction。</span><br><span class="line">注意，事务的基础是MVCC，多版本并发控制。MVCC是由存储引擎支持的（只有InnoDB支持）。</span><br><span class="line">MVCC可以管理DML语句，但是DDL语句就无能为力了，因此在开启一个事务时其他人不要使用DDL语句（CREATE,ALTER,DROP,TRUNCATE,RENAME）。</span><br></pre></td></tr></table></figure>



<p>InnoDB备份建议命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -F -E -R --single-transaction --master-data&#x3D;1 --flush-privileges --default-character-set&#x3D;utf8mb4 --hex-blob | gzip &gt; &#x2F;backup&#x2F;full.sql.gz</span><br></pre></td></tr></table></figure>



<p>MyISAM备份建议命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -E -R -F -x --master-date&#x3D;1 --flush-privileges --default-character-set&#x3D;utf8mb4 --hex-blob | gzip &gt; &#x2F;backup&#x2F;full.sql.gz</span><br></pre></td></tr></table></figure>



<h4 id="mysql分库备份实战"><a href="#mysql分库备份实战" class="headerlink" title="mysql分库备份实战"></a>mysql分库备份实战</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -B database  | gzip &gt; backup.sql.gz</span><br></pre></td></tr></table></figure>

<p>范例：分库备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for db in &#96;mysql -uroot -pcentos -e &#39;show databases&#39; | grep -vE &quot;Database|information_schema|performance_schema&quot;&#96;;do mysqldump -uroot -pcentos -B $db | gzip &gt; &#x2F;backup&#x2F;$db-&#96;date +%F-%H-%M-%S&#96;.sql.gz;done;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pcentos -e &#39;show databases&#39; | grep -Ev &quot;Database|information_schema|performance_schema&quot;|while read db;do mysqldump -uroot -pcentos -B $db | gzip &gt; &#x2F;backup&#x2F;$db-&#96;date +%F_%H-%M-%S&#96;.sql.gz;done</span><br></pre></td></tr></table></figure>



<h4 id="mysqldump-备份还原实战案例"><a href="#mysqldump-备份还原实战案例" class="headerlink" title="mysqldump 备份还原实战案例"></a>mysqldump 备份还原实战案例</h4><p>如何开启二进制日志；二进制日志的结构，是不是可以直接阅读的；是不是可以直接修改二进制日志文件中的drop,delete等行就可以把数据恢复回来了；数据备份了如何还原；</p>
<p>没有二进制文件也可以备份，把想要备份的数据库备份了就行</p>
<p>数据库的恢复：在mysql命令行中 source /backup/xxx.sql  直接进行恢复</p>
<p>分数据库进行备份</p>
<p>下面的操作是把需要备份的数据库名字找到，找到后使用 mysqldump -B 进行备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#mysql -uroot -p -e &#39;show databases&#39;|grep -Ev &#39;^(Database|information_schema|performance_schema)$&#39;|while read db;do echo &quot;备份$db&quot;;done</span><br><span class="line">Enter password: </span><br><span class="line">备份hellodb</span><br><span class="line">备份mysql</span><br></pre></td></tr></table></figure>

<p>全部备份，实现增量备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">备份文件放在&#x2F;backup下</span><br><span class="line">日志文件放在&#x2F;data&#x2F;mysql&#x2F;mylogbin-xxxx </span><br></pre></td></tr></table></figure>

<p>1.全部备份，依靠二进制文件，生成一个.sql文件</p>
<p>2.对数据库进行操作，增加删除数据，修改数据表等操作</p>
<p>3.发现删错数据了，想要还原</p>
<p>4.还原需要依靠一直开着的二进制日志才能完成，要不然只能回复到备份状态，中间所有操作都会丢失。开启二进制日志的话，不管中间做了什么，都能保留下来，只把删除语句删除了就行</p>
<p>5.去完全备份文件中找到备份结束的标志：CHANGE MASTER TO ，并查看它把下一步日志指向了哪个二进制日志文件，位置是哪里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE&#x3D;&#39;mylogbin.000002&#39;, MASTER_LOG_POS&#x3D;383;</span><br></pre></td></tr></table></figure>

<p>6.找到这个二进制日志文件，找到这个位置，用mysqlbinlog</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myslqbinlog &#x2F;data&#x2F;mysql&#x2F;mylogbin.000002 --start-position&#x3D;383</span><br></pre></td></tr></table></figure>

<p>7.把从这个位置之后的内容重定向到一个新文件inc.sql中，这代表了从完全备份后的增量日志文件，通过这个文件可以把增量的数据都找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog &#x2F;data&#x2F;mysql&#x2F;mylogbin.000002 --start-position&#x3D;383</span><br><span class="line"> &gt; &#x2F;backup&#x2F;inc.sql</span><br></pre></td></tr></table></figure>

<p>8.因为是错误删除数据了，所以去这个增量文件中找到删除命令 ‘DROP TABLE’,然后把这行删除就行了，这样再把这个文件还原了就能获得没有被删除的数据了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak &#39;&#x2F;^DROP TABLE&#x2F;d&#39; inc.sql</span><br></pre></td></tr></table></figure>

<p>9.停止访问数据库，在mysql客户端命令行中关闭二进制日志，准备还原 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set sql_log_bin&#x3D;0</span><br></pre></td></tr></table></figure>

<p>10.还原，先还原完全备份，然后再还原增量文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;backup&#x2F;full_backup.sql</span><br><span class="line">source &#x2F;backup&#x2F;inc.sql</span><br></pre></td></tr></table></figure>

<p>11.查看数据库，发现数据都回来了</p>
<h3 id="xtrabackup备份工具"><a href="#xtrabackup备份工具" class="headerlink" title="xtrabackup备份工具"></a>xtrabackup备份工具</h3><h4 id="xtrabackup工具介绍"><a href="#xtrabackup工具介绍" class="headerlink" title="xtrabackup工具介绍"></a>xtrabackup工具介绍</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html">https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html</a></p>
<p>自MariaDB10.2.7（含）以上版本，不再支持使用Percona XtraBackup工具在线物理热备份。使用mariabackup</p>
<h4 id="xtrabackup安装"><a href="#xtrabackup安装" class="headerlink" title="xtrabackup安装"></a>xtrabackup安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install xtrabackup</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl-Digest-MD5</span><br></pre></td></tr></table></figure>

<h4 id="xtrabackup用法"><a href="#xtrabackup用法" class="headerlink" title="xtrabackup用法"></a>xtrabackup用法</h4><p>xtrabackup使用分三步：</p>
<p>1.备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#xtrabackup --user&#x3D;root --password&#x3D;&#39;centos&#39; -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<p>2.预准备</p>
<p>这一步是为了让二进制日志文件和数据库中的数据保持一致性。</p>
<p>因为在对数据库进行操作时，会先把操作写入日志，然后经过提交事务后才会对数据库进行操作。所以要把日志中还没提交的事务回滚，把已经提交的事务同步给数据库。这样就能让日志和数据库保持一致性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 data]#xtrabackup --prepare --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>



<p>3.还原</p>
<p>这一步中有要求：</p>
<ul>
<li>数据库服务要停了</li>
<li>存放数据文件的文件夹必须为空</li>
</ul>
<p>然后执行还原命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 data]#xtrabackup --copy-back --target-dir&#x3D;&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<p>最后把数据文件的所有者和所有组修改成mysql</p>
<h4 id="利用xtrabackup实现完全备份及还原"><a href="#利用xtrabackup实现完全备份及还原" class="headerlink" title="利用xtrabackup实现完全备份及还原"></a>利用xtrabackup实现完全备份及还原</h4><h4 id="利用xtrabackup实现完全，增量备份及还原"><a href="#利用xtrabackup实现完全，增量备份及还原" class="headerlink" title="利用xtrabackup实现完全，增量备份及还原"></a>利用xtrabackup实现完全，增量备份及还原</h4><p>增量备份</p>
<p>1.完全备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;&#39;centos&#39; -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;bak</span><br></pre></td></tr></table></figure>

<p>2.修改数据，实现增量数据</p>
<p>3.增量备份一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;inc --incremental-basedir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>

<p>4.再次修改数据，实现增量数据</p>
<p>5.增量备份一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos -S &#x2F;tmp&#x2F;mysql.sock --backup --target-dir&#x3D;&#x2F;backup&#x2F;inc2 --incremental-basedir&#x3D;&#x2F;backup&#x2F;inc&#x2F;</span><br></pre></td></tr></table></figure>

<p>6.出现错误想要还原数据</p>
<p>7.相比完全备份的还原，增量备份的还原在prepare阶段需要进行一次完全备份准备以及多次增量备份准备（增量备份了几次就还原几次）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare --apply-log-only --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare --apply-log-only --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F; --incremental-dir&#x3D;&#x2F;backup&#x2F;inc&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --prepare  --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F; --incremental-dir&#x3D;&#x2F;backup&#x2F;inc2&#x2F;</span><br></pre></td></tr></table></figure>

<p>8.还原过程与完全备份一样，需要停止服务，清空数据文件的存放目录，以及最后把所有者和所有组改成mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysqld stop</span><br><span class="line">rm -rf &#x2F;data&#x2F;mysql&#x2F;*</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --copy-back --target-dir&#x3D;&#x2F;backup&#x2F;bak&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure>



<h4 id="xtrabackup单表导出和导入"><a href="#xtrabackup单表导出和导入" class="headerlink" title="xtrabackup单表导出和导入"></a>xtrabackup单表导出和导入</h4><p>单表导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --user&#x3D;root --password&#x3D;centos --backup --target-dir&#x3D;&#x2F;backup&#x2F; --tables&#x3D;&#39;^hellodb[.]students&#39; -S &#x2F;tmp&#x2F;mysql.sock</span><br></pre></td></tr></table></figure>



<h2 id="MySQL集群Cluster"><a href="#MySQL集群Cluster" class="headerlink" title="MySQL集群Cluster"></a>MySQL集群Cluster</h2><h3 id="MySQL主从复制"><a href="#MySQL主从复制" class="headerlink" title="MySQL主从复制"></a>MySQL主从复制</h3><h4 id="1-主从复制架构和原理"><a href="#1-主从复制架构和原理" class="headerlink" title="1.主从复制架构和原理"></a>1.主从复制架构和原理</h4><p>1.1 服务性能扩展方式</p>
<ul>
<li>Scale Up，向上扩展，垂直扩展</li>
<li>Scale Out，向外扩展，横向扩展</li>
</ul>
<p>1.2 MySQL的扩展</p>
<ul>
<li>读写分离</li>
<li>复制：每个节点都有相同的数据集，向外扩展，基于二进制日志的单向复制</li>
</ul>
<p>1.3 复制的功用</p>
<ul>
<li>实现数据分布</li>
<li>实现负载可以均衡地读</li>
<li>实现备份</li>
<li>实现高可用和故障切换</li>
<li>MySQL升级测试</li>
</ul>
<p>1.4 复制的架构</p>
<p>一主一从的复制架构</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929165555349.png" alt="image-20200929165555349"></p>
<p>一主多从的复制架构</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929165621541.png" alt="image-20200929165621541"></p>
<p>1.5 主从复制的原理</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929171429834.png" alt="image-20200929171429834"></p>
<p>主从复制相关线程：</p>
<p>主节点：</p>
<ul>
<li>dump Thread：为每个Slave的 I/O Thread启动一个dump线程，用于向其发送binary log events</li>
</ul>
<p>从节点：</p>
<ul>
<li>I/O Thread：向Master请求二进制日志事件，并保存于中继日志(RELAY LOG)中</li>
<li>SQL Thread：从中继日志中读取日志事件，在本地完成重放</li>
</ul>
<p>根复制相关的文件：</p>
<ul>
<li>master.info：用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等</li>
<li>relay-log.info：保存在当前slave节点上已经复制的当前二进制日志和本地relay log日志的对应关系</li>
<li>mariadb-relay-bin.00000#：中继日志，保存从主节点复制过来的二进制日志，本质就是二进制日志</li>
</ul>
<p>1.6 主从复制特点</p>
<ul>
<li>异步复制</li>
<li>主从数据不一致比较常见</li>
</ul>
<p>1.7 各种复制架构</p>
<ul>
<li>一主一从</li>
<li>一主多从</li>
<li>从服务器可以再有从服务器</li>
<li>主主</li>
<li>一从多主：适用于多个不同数据库</li>
<li>环状复制</li>
</ul>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20200929173016961.png" alt="image-20200929173016961"></p>
<p>复制时需要考虑二进制日志事件的记录格式</p>
<ul>
<li>STATEMENT（5.0之前）</li>
<li>ROW（目前推荐）</li>
<li>MIXED</li>
</ul>
<h4 id="2-实现主从复制配置"><a href="#2-实现主从复制配置" class="headerlink" title="2.实现主从复制配置"></a>2.实现主从复制配置</h4><p>配置分为主节点的配置和从节点的配置</p>
<p><strong>主节点配置：</strong></p>
<p>（1）启用二进制日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin </span><br><span class="line">#或者指定log_bin&#x3D;&#x2F;backup&#x2F;logbin，这样指定路径的方式一定要给备份路径更改用户组和用户为mysql，否则会导致服务无法启动</span><br></pre></td></tr></table></figure>

<p>（2）为当前节点设置一个全局唯一的ID号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id &#x3D; NUMBER </span><br><span class="line">log-basename &#x3D; master #可选性，设置二进制日志名称，确保不依赖于主机名</span><br></pre></td></tr></table></figure>

<p>说明：server-id的取值范围</p>
<p>1 to 4294967295 (2^32) （mariadb 10.2.2 以上版本）默认值为1</p>
<p>0 to 4294967295 (2^32) （mariadb 10.2.1 以下版本）默认值为0</p>
<p>（3）创建有复制权限的用户账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;repluser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#39;repluser&#39;@&#39;10.0.0.%&#39;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（4）查看从二进制日志的文件和位置开始进行复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER status;</span><br><span class="line"> binlog.000016 |      725 </span><br></pre></td></tr></table></figure>

<p><strong>从节点配置</strong></p>
<p>（1）启动中继日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id &#x3D; NUMBER #为当前节点设置一个全局唯一的ID号</span><br><span class="line">log-bin</span><br><span class="line">read_only &#x3D; ON   #设置数据库只读，针对supper user无效，注意这个意思是从服务器的超级用户是可以更改数据的！！！</span><br><span class="line">relay_log &#x3D; relay-log  #relay log的文件路径，默认值hostname-relay-bin</span><br><span class="line">relay_log_index &#x3D; relay-log.index #默认值hostname-relay-bin.index</span><br></pre></td></tr></table></figure>

<p>（2）登录本机的数据库，并启动复制线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.登录本机的数据库</span><br><span class="line">2.开始设置：</span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;192.168.8.8&#39;,</span><br><span class="line">MASTER_USER&#x3D;&#39;repluser&#39;,</span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;centos&#39;,</span><br><span class="line">MASTER_PORT&#x3D;3306,</span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;mariadb-bin.000002&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;545;</span><br><span class="line"></span><br><span class="line">START SLAVE;  #启动复制线程</span><br><span class="line">SHOW SLAVE STATUS;</span><br><span class="line"></span><br><span class="line">change master to  是个命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果主节点是新建的库，那么就按照这个步骤执行；如果主节点已经运行了，新增从节点，那么就需要做这几件事：</p>
<p>1.给主节点全部备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -pcentos -A -E -R -F --single-transaction --master-data&#x3D;1 --flush-privileges --hex-blob --default-character-set&#x3D;utf8mb4 | gzip &gt; &#x2F;backup&#x2F;test1&#x2F;full.sql.gz </span><br></pre></td></tr></table></figure>

<p>2.查看主节点当前的二进制日志和日志中的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show master status</span><br><span class="line">binlog.xxxx   727</span><br></pre></td></tr></table></figure>

<p>3.从节点导入全部备份，并且设置开始复制的主节点二进制日志和日志中的位置，这样设置的意思就是，之前的内容我从节点都有了，之后的内容就从你现在的位置开始复制</p>
<h4 id="3-主从复制相关设置"><a href="#3-主从复制相关设置" class="headerlink" title="3.主从复制相关设置"></a>3.主从复制相关设置</h4><p>1.解决复制冲突</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--sql_skip_errors,sql_slave_skip_counter</span><br><span class="line">可以在从服务器忽略几个主服务器的复制事件，或跳过事件的ID</span><br><span class="line">通过 SHOW SLAVE STATUS; 可以看到错误码，然后两种方法跳过：</span><br><span class="line">第一种：</span><br><span class="line">stop slave; #关闭slave线程</span><br><span class="line">set global sql_slave_skip_counter &#x3D; 1;</span><br><span class="line">start slave; #开启slave线程</span><br><span class="line">第二种：</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">slave_skip_errors&#x3D;ERROR_CODE | ALL  #这里填写错误码</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>2.保证主从复制的事务安全</p>
<p>在master节点启用参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sync_binlog&#x3D;1;#每次写后都把二进制日志同步到磁盘，性能差</span><br><span class="line">#Innodb存储引擎的设置</span><br><span class="line">innodb_flush_log_at_trx_commit&#x3D;1 #每次事务提交立即同步日志写磁盘</span><br><span class="line">innodb_support_xa&#x3D;on  #分布式mariadb10.3.0废除</span><br><span class="line">sync_master_info&#x3D;NUMBER #number次事件后，master.info同步到磁盘</span><br></pre></td></tr></table></figure>

<p>在slave节点启用服务器选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skip-slave-start&#x3D;ON</span><br></pre></td></tr></table></figure>

<p>在slave节点启用参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sync_relay_log&#x3D;NUMBER #number次后同步relay_log到磁盘</span><br><span class="line">sync_relay_log_info&#x3D;NUMBER #number次事务后同步relay-log.info到磁盘</span><br></pre></td></tr></table></figure>

<p>范例：当一个主服务器宕机，临时提升一个从服务器成为新的主服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">步骤：</span><br><span class="line">1.查看哪个从节点的数据是最新的，让它成为新的主服务器</span><br><span class="line">cat &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;relay-log.info或者在数据库中执行show slave status\G 查看POS值</span><br><span class="line">2.新的主服务器修改配置文件，关闭read-only配置，清除旧主服务器的复制信息</span><br><span class="line">stop slave;</span><br><span class="line">reset slave all;</span><br><span class="line">flush privileges;#这个命令不输入，会导致其他从服务器无法连接到新主服务器</span><br><span class="line">3.在新主服务器上全量备份</span><br><span class="line">4.分析旧的主服务器的二进制日志，把没有同步给新主服务器的内容导出来，还原到新主服务器，尽可能恢复数据</span><br><span class="line">5.其他所有从服务器重新还原数据库，指向新的主服务器</span><br></pre></td></tr></table></figure>

<h4 id="4-实现级联复制"><a href="#4-实现级联复制" class="headerlink" title="4.实现级联复制"></a>4.实现级联复制</h4><p>三台服务器：</p>
<p>master</p>
<p>级联</p>
<p>slave</p>
<p>就是级联服务器上配置了一项，然后最下级服务器的主服务器指向级联服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_slave_updates   #这个选项开启后级联服务器也可以修改二进制日志</span><br></pre></td></tr></table></figure>

<p>slave服务器的主服务器指向了级联服务器</p>
<h4 id="5-主主复制"><a href="#5-主主复制" class="headerlink" title="5.主主复制"></a>5.主主复制</h4><p>两个节点都可以更新数据，并且互为主从，容易差生数据不一致的问题，要慎用</p>
<p>可以通过这个设置避免出现插入同样的数据；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset&#x3D;1  #这个是起始的数字</span><br><span class="line">auto_increment_increment&#x3D;2 #这个是增长量</span><br><span class="line">#两台服务器配置不同的起始数字，相同的增长量，这样可以变成奇偶，不冲突</span><br></pre></td></tr></table></figure>



<h4 id="6-半同步复制"><a href="#6-半同步复制" class="headerlink" title="6.半同步复制"></a>6.半同步复制</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/semisynchronous-replication/#enabling-semisynchronous-replication">https://mariadb.com/kb/en/semisynchronous-replication/#enabling-semisynchronous-replication</a></p>
<p>默认情况下，MySQL的复制功能是异步的，异步复制可以提供最好的性能，主库把binary log发送给从库即结束，并不验证从库是否接收完毕。这意味着当主服务器或从服务器端发生故障时，有可能从服务器没有接收到主服务器发送过来的binlog日志，这就会导致主服务和从服务器数据不一致。</p>
<p>半同步会有确认的过程，这个是通过一个插件实现的  Plugin: rpl_semi_sync_master</p>
<p>半同步复制的意思是，一主多从的情况下，当主服务器的数据发生变化后，主服务要先把数据同步给至少一台从服务器（只要有一台从服务器返回给主服务器同步成功的信号）或者同步时间超过预设的等待时间后，然后才会返回客户端，表示数据修改成功。</p>
<p>这个插件有两个部分，master和slave，通过INSTALL SONAME的方式安装以及在配置文件中写上插件选项及名称</p>
<p>mariadb10.3.3之前版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.安装插件</span><br><span class="line">#通过命令行安装插件</span><br><span class="line">#主服务配置</span><br><span class="line">INSTALL SONAME &#39;semisync_master&#39;;</span><br><span class="line"></span><br><span class="line">#从服务器配置</span><br><span class="line">INSTALL SONAME &#39;semisync_slave&#39;</span><br><span class="line"></span><br><span class="line">#服务器配置添加插件</span><br><span class="line">#主服务器配置</span><br><span class="line">[mariadb]</span><br><span class="line">...</span><br><span class="line">plugin_load_add &#x3D; semisync_master</span><br><span class="line"></span><br><span class="line">#从服务器配置</span><br><span class="line">[mariadb]</span><br><span class="line">...</span><br><span class="line">plugin_load_add &#x3D; semisync_slave</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.开启变量</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;1</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000 #超时时间，这个3秒</span><br></pre></td></tr></table></figure>

<p>但是在mariadb 10.3.3开始这个插件就内置在数据库了，不需要去安装插件</p>
<p>在主从服务器上都打开这个选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#这两个都是既是服务器选项又是全局变量</span><br><span class="line">#主服务配置</span><br><span class="line">rpl_semi_sync_mastere_enabled &#x3D; ON</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000 #最大等待时间，这个代表3s</span><br><span class="line">#从服务器配置</span><br><span class="line">rpl_semi_sync_slave_enabled &#x3D; ON</span><br></pre></td></tr></table></figure>

<p>mysql 5.6,5.7,8.0开启半同步复制的方法：SONAME就是 .so文件的名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">服务器选项：</span><br><span class="line">plugin-load-add&#x3D;semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;on</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000;</span><br><span class="line"></span><br><span class="line">1.安装插件</span><br><span class="line">#安装主服务器的插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_snyc_master SONAME &#39;semisync_master.so&#39;</span><br><span class="line">#安装从服务器的插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_snyc_slave SONAME &#39;semisync_slave.so&#39;</span><br><span class="line">2.开启半同步变量</span><br><span class="line">#主服务器配置</span><br><span class="line">SET GLOBAL rpl_semi_sync_master_enabled&#x3D;1;</span><br><span class="line">SET GLOBAL rpl_semi_sync_master_timeout&#x3D;N;#这里的单位是毫秒，如果要设置成3秒，就写3000</span><br><span class="line">#从服务器配置</span><br><span class="line">SET GLOBAL rpl_semi_sync_slave_enabled&#x3D;1;</span><br><span class="line"></span><br><span class="line">#或者通过服务器配置，这几个变量都是服务器选项</span><br></pre></td></tr></table></figure>



<h4 id="7-复制过滤器"><a href="#7-复制过滤器" class="headerlink" title="7.复制过滤器"></a>7.复制过滤器</h4><p>让从节点仅复制指定的数据库，或指定数据库的指定表</p>
<p>复制过滤器的两种实现方式：类似黑名单，一个是二进制日志黑名单，一个是中继日志黑名单</p>
<p>（1）服务器选项：主服务仅向二进制日志中记录与特定数据库相关的事件</p>
<p>也有优点：仅需要在主服务器上配置一次，从服务器都会生效；</p>
<p>缺点：主服务器仅把白名单中的数据库备份到二进制日志，其他数据库不记录，会造成数据风险；</p>
<p>不建议使用</p>
<p>（2）从服务器SQL_THREAD在读取relay log中的事件时，仅读取与特定数据库（表）相关的事件并应用于本地</p>
<p>会造成网络和磁盘I/O浪费</p>
<p>选项中配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">replication_do_db&#x3D;db1</span><br><span class="line">replication_do_db&#x3D;db2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>命令行中设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replication_do_db&#x3D;&quot;db1,db2,db3&quot;</span><br></pre></td></tr></table></figure>



<h4 id="8-复制主从加密"><a href="#8-复制主从加密" class="headerlink" title="8.复制主从加密"></a>8.复制主从加密</h4><p>因为mysql的主从复制默认是不加密的，通信中的数据都是明文，很危险</p>
<p>通过SSL/TLS加密 transport layer security protocol，ssl是不安全的了，只是大家都这么叫这个协议，所以还留着他的名字</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/library/replication-with-secure-connections/">https://mariadb.com/kb/en/library/replication-with-secure-connections/</a></p>
<p>需要CA Certificate Authority x509 非对称密钥对 openssl</p>
<p>需要开启ssl，需要生成一个必须经过ssl认证的账户</p>
<p>1.生成CA</p>
<p>2.生成私钥</p>
<p>3.生成证书</p>
<p>4.一共需要：CA证书、私钥、主服务器私钥、证书、从服务器私钥、证书六样东西</p>
<p>5.具体步骤不写了。</p>
<h4 id="9-GTID"><a href="#9-GTID" class="headerlink" title="9.GTID"></a>9.GTID</h4><p>Global Transaction Identity 全局事务标识符</p>
<p>mysql5.6之后支持，GTID不像传统的复制方式（异步复制、半同步复制）需要找到binlog文件名和position，它只需要知道master的IP、端口、账户、密码即可。开启GTID后，执行</p>
<p>change master to master_auto_position=1即可，它会自动寻找到相应的位置开始同步</p>
<p>配置：</p>
<p>主服务器配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br></pre></td></tr></table></figure>

<p>从服务器配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">重启mysql服务后在命令输入：</span><br><span class="line">mysql&gt; change master to master_host&#x3D;&#39;10.0.0.7&#39;,</span><br><span class="line">    -&gt; master_user&#x3D;&#39;repluser&#39;,</span><br><span class="line">    -&gt; master_password&#x3D;&#39;centos&#39;,</span><br><span class="line">    -&gt; master_port&#x3D;3306,</span><br><span class="line">    -&gt; master_auto_position&#x3D;1;</span><br></pre></td></tr></table></figure>



<h4 id="10-复制的监控和维护"><a href="#10-复制的监控和维护" class="headerlink" title="10.复制的监控和维护"></a>10.复制的监控和维护</h4><p>1.清理日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PURGE &#123;BINARY|MASTER&#125; LOGS &#123; TO &#39;log_name&#39; | before datetime_expr&#125;</span><br><span class="line"></span><br><span class="line">RESET  SLAVE ALL;</span><br><span class="line"></span><br><span class="line">RESET MASTER TO N;#mysql不支持</span><br></pre></td></tr></table></figure>

<p>2.状态监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS;</span><br><span class="line">SHOW MASTER LOGS;</span><br><span class="line"></span><br><span class="line">SHOW SLAVE STATUS;</span><br><span class="line">SHOW PROCESSLIST;</span><br><span class="line"></span><br><span class="line">SHOW BINLOG EVENTS;</span><br></pre></td></tr></table></figure>

<p>3.判断从服务器是否落后于主服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW SLAVE STATUS;</span><br><span class="line">然后查看这个字段</span><br><span class="line">Seconds_Behind_Master;0 #0就是不落后，非0就是落后</span><br></pre></td></tr></table></figure>



<h4 id="11-复制的问题和解决方案"><a href="#11-复制的问题和解决方案" class="headerlink" title="11.复制的问题和解决方案"></a>11.复制的问题和解决方案</h4><p>1.造成不一致的原因：</p>
<ul>
<li>主数据库binlog格式为Statement，同步到从库后可能造成主从不一致</li>
<li>主数据库更改前执行set sql_log_bin=0，会使主库不记录binlog，从库也无法变更这部分数据</li>
<li>从节点未设置只读，误操作写入数据</li>
<li>主库或从库以外宕机，可能会造成binlog或者relaylog文件出现损坏，导致主从不一致</li>
<li>主从实例版本不一致，特别是高版本是主，低版本是从，主数据库上面支持的功能，从数据库上面可能不支持该功能</li>
<li>mysql自身bug导致</li>
</ul>
<p>2.不一致的修复方法</p>
<ul>
<li>手动重建</li>
<li>使用perconna-toolkit工具辅助</li>
</ul>
<p>3.如何避免不一致</p>
<ul>
<li>主库binlog采用ROW模式  binlog_format=row</li>
<li>主从实例数据库版本保持一致</li>
<li>主库做好账号权限把控，不可以执行  set sql_log_bin=0</li>
<li>从库开启只读，不允许人为写入</li>
<li>定期进行一致性检验</li>
</ul>
<h3 id="MySQL中间件代理服务器"><a href="#MySQL中间件代理服务器" class="headerlink" title="MySQL中间件代理服务器"></a>MySQL中间件代理服务器</h3><h4 id="1-关系型数据库和非关系型数据库-NO-SQL-数据库"><a href="#1-关系型数据库和非关系型数据库-NO-SQL-数据库" class="headerlink" title="1.关系型数据库和非关系型数据库(NO SQL)数据库"></a>1.关系型数据库和非关系型数据库(NO SQL)数据库</h4><h4 id="2-数据切分"><a href="#2-数据切分" class="headerlink" title="2.数据切分"></a>2.数据切分</h4><ul>
<li>垂直切分：把不同的数据表分离开，这些表在业务中应当不使用join</li>
<li>水平切分：按照行进行切分，比如前1000行放入一个服务器，后1000行放入另一个服务器，以此降低单个服务器的负载</li>
</ul>
<p>需要使用分片管理服务器，也就是中间件。</p>
<h4 id="3-MySQL中间件各种应用"><a href="#3-MySQL中间件各种应用" class="headerlink" title="3.MySQL中间件各种应用"></a>3.MySQL中间件各种应用</h4><p>常用的两个中间件</p>
<ul>
<li>Mycat：国人二次开发，国内使用较多</li>
<li>proxySQL：外国软件</li>
</ul>
<h4 id="4-Mycat"><a href="#4-Mycat" class="headerlink" title="4.Mycat"></a>4.Mycat</h4><h5 id="Mycat的工作原理："><a href="#Mycat的工作原理：" class="headerlink" title="Mycat的工作原理："></a>Mycat的工作原理：</h5><p>​    搞清楚Mycat和mysql的区别。我们把上层看作是对下层的抽象，例如操作系统是对各类计算机硬件的抽象。那么我们什么时候需要抽象？假如只有一种硬件的时候，我们需要开发一个操作系统吗？再比如一个项目只需要一个人完成的时候需要leader吗？但是当一个项目十几个人的时候，就应该有一个管理者，发挥沟通协调作用，而这个管理者就是我们用户对于这个项目组所有人的抽象。</p>
<p>同样的，当我们的应用只需要一台数据库服务器的时候我们不需要中间件Mycat，而如果你需要分库甚至分表，应用要面对很多个数据库时，就需要对数据库进行一个抽象，来管理这些数据库，而最上面的应用只需要面对一个数据库的抽象或者说数据库中间件就好了，这就是Mycat的核心作用。</p>
<p>所以可以这样理解：数据库是对底层存储数据文件的抽象，而Mycat是对数据库的抽象。</p>
<h5 id="实验：通过Mycat中间件和mysql-5-7-30版本数据库实现读写分离"><a href="#实验：通过Mycat中间件和mysql-5-7-30版本数据库实现读写分离" class="headerlink" title="实验：通过Mycat中间件和mysql 5.7.30版本数据库实现读写分离"></a>实验：通过Mycat中间件和mysql 5.7.30版本数据库实现读写分离</h5><p>一共三台主机，一台mycat管理机，一台主服务器，一台从服务器，主从复制是用GTID实现的</p>
<p>1.在Mycat管理机上安装Java环境，记得要把内存调整大一些，比如2GB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install java -y</span><br><span class="line">java -version</span><br><span class="line">1.8</span><br></pre></td></tr></table></figure>

<p>2.安装Mycat，去官网下载，版本我下的是1.6.7.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;dl.mycat.org.cn&#x2F;1.6.7.5&#x2F;2020-4-10&#x2F;Mycat-server-1.6.7.5-release-20200410174409-linux.tar.gz</span><br><span class="line">mkdir &#x2F;app</span><br><span class="line">tar xvf Mycat-server-1.6.7.5-release-20200410174409-linux.tar.gz -C &#x2F;app</span><br><span class="line">cd &#x2F;app&#x2F;mycat</span><br><span class="line">[root@localhost mycat]$ls</span><br><span class="line">bin  catlet  conf  lib  logs  version.txt</span><br><span class="line">➜  mycat vim &#x2F;etc&#x2F;profile.d&#x2F;mycat.sh</span><br><span class="line">PATH&#x3D;&#x2F;app&#x2F;mycat&#x2F;bin&#x2F;:$PATH</span><br><span class="line">➜  mycat source &#x2F;etc&#x2F;profile.d&#x2F;mycat.sh </span><br></pre></td></tr></table></figure>

<p>3.配置两台服务器作为主从复制机器，并且开启通用日志，通用日志是一会为了检测读写分离</p>
<p>这里的配置很简单，主、从服务器都开启gtid和二进制日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_bin</span><br><span class="line">10 gtid_mode&#x3D;on</span><br><span class="line">11 enforce_gtid_consistency&#x3D;on</span><br><span class="line"></span><br><span class="line">开启通用日志在命令行用变量开启：</span><br><span class="line">set global general_log&#x3D;on;</span><br><span class="line">show variables like &#39;%general_log%&#39;;</span><br></pre></td></tr></table></figure>

<p>几个重要的配置文件</p>
<ul>
<li>server.xml：Mycat软件本身的相关配置</li>
<li>schema.xml：配置物理数据库，包括读写分离、高可用等</li>
<li>rule.xml：分库分表规则</li>
</ul>
<p>4.配置server.xml文件，之后在安装了Mycat的服务器上就可以使用这个账号密码登录了，登录方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pcentos -h 127.0.0.1 -P 8066</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">106     &lt;user name&#x3D;&quot;root&quot; defaultAccount&#x3D;&quot;true&quot;&gt;                                            </span><br><span class="line">107         &lt;property name&#x3D;&quot;password&quot;&gt;centos&lt;&#x2F;property&gt;#这里是登录mycat的密码，可以修改</span><br><span class="line">108         &lt;property name&#x3D;&quot;schemas&quot;&gt;t1,t2,t3&lt;&#x2F;property&gt;#这里是允许用户使用的数据库，名称和数量都是自己设置的，注意这里的数据库名称需要跟schema.xml中的数据库名称对应上</span><br><span class="line">109         &lt;property name&#x3D;&quot;defaultSchema&quot;&gt;t1&lt;&#x2F;property&gt;#默认数据库名</span><br><span class="line"></span><br><span class="line">123     &lt;user name&#x3D;&quot;user&quot;&gt;</span><br><span class="line">124         &lt;property name&#x3D;&quot;password&quot;&gt;user&lt;&#x2F;property&gt;</span><br><span class="line">125         &lt;property name&#x3D;&quot;schemas&quot;&gt;t1&lt;&#x2F;property&gt;#这里也要改</span><br><span class="line">126         &lt;property name&#x3D;&quot;readOnly&quot;&gt;true&lt;&#x2F;property&gt;</span><br><span class="line">127         &lt;property name&#x3D;&quot;defaultSchema&quot;&gt;t1&lt;&#x2F;property&gt;#这里也要改</span><br><span class="line">128     &lt;&#x2F;user&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.配置schema.xml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  1 &lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;                                      </span><br><span class="line">  2 &lt;mycat:schema xmlns:mycat&#x3D;&quot;http:&#x2F;&#x2F;io.mycat&#x2F;&quot;&gt;</span><br><span class="line">  3 &lt;schema name&#x3D;&quot;t1&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn1&quot;&gt;&lt;&#x2F;schema&gt; </span><br><span class="line">  4 &lt;schema name&#x3D;&quot;t2&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn2&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">  5 &lt;schema name&#x3D;&quot;t3&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn3&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">  ##schema的名称这里是什么，server.xml中也得写成什么，这个代表逻辑数据库，提供给用户使用，逻辑数据库会跟实际数据库中的数据库对应，通过dataNode标签，建立关系。</span><br><span class="line">  6 &lt;dataNode name&#x3D;&quot;dn1&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;hellodb&quot; &#x2F;&gt;</span><br><span class="line">  7 &lt;dataNode name&#x3D;&quot;dn2&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;mysql&quot; &#x2F;&gt;</span><br><span class="line">  8 &lt;dataNode name&#x3D;&quot;dn3&quot; dataHost&#x3D;&quot;localhost1&quot; database&#x3D;&quot;db1&quot; &#x2F;&gt;</span><br><span class="line">  ##datahost标签中，定义了具体的数据库实例、读写分离配置和心跳语句。</span><br><span class="line">  #dbDriver分两个：native和jdbc</span><br><span class="line">  9 &lt;dataHost name&#x3D;&quot;localhost1&quot; maxCon&#x3D;&quot;1000&quot; minCon&#x3D;&quot;10&quot; balance&#x3D;&quot;1&quot; writeType&#x3D;&quot;0&quot; dbType&#x3D;&quot;    mysql&quot; dbDriver&#x3D;&quot;jdbc&quot; switchType&#x3D;&quot;1&quot;  slaveThreshold&#x3D;&quot;100&quot;&gt;</span><br><span class="line"> 10 &lt;heartbeat&gt;select user()&lt;&#x2F;heartbeat&gt;</span><br><span class="line"> 11 &lt;writeHost host&#x3D;&quot;hostM1&quot; url&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;10.0.0.101:3306&quot; user&#x3D;&quot;mycat&quot; password&#x3D;&quot;12345    6&quot;&gt;</span><br><span class="line"> 12 &lt;readHost host&#x3D;&quot;hostS2&quot; url&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;10.0.0.110:3306&quot; user&#x3D;&quot;mycat&quot; password&#x3D;&quot;123456    &quot;&#x2F;&gt;</span><br><span class="line"> 13 &lt;&#x2F;writeHost&gt;</span><br><span class="line"> 14 &lt;&#x2F;dataHost&gt;</span><br><span class="line"> 15 &lt;&#x2F;mycat:schema&gt;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">&lt;dataHost&gt;这里有一个 dbDriver  字段，我这里默认是jdbc，所以下面的IP地址都要写成：</span><br><span class="line">jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;</span><br><span class="line">注意：</span><br><span class="line">&lt;schema name&#x3D;&quot;TESTDB&quot; checkSQLschema&#x3D;&quot;false&quot; sqlMaxLimit&#x3D;&quot;100&quot; dataNode&#x3D;&quot;dn1&quot;&gt;&lt;&#x2F;schema&gt;</span><br><span class="line">这里有个dataNode字段，我这里默认是RandomDataNode，需要改成dataNode</span><br></pre></td></tr></table></figure>

<p>6.开启mycat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mycat start</span><br><span class="line">#启动日志是这个：&#x2F;app&#x2F;mycat&#x2F;logs&#x2F;wrapper.log</span><br><span class="line">#运行日志是：&#x2F;app&#x2F;mycat&#x2F;logs&#x2F;mycat.log</span><br></pre></td></tr></table></figure>

<p>7.测试读写分离：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">持续监测主和从服务器的通用日志</span><br><span class="line">tail -f &#x2F;data&#x2F;mysql&#x2F;localhost.log #这个是通用日志</span><br><span class="line">连接到在mycat服务器上操作：</span><br><span class="line">mysql -uroot -pcentos -h127.0.0.1 -P 8066   #这里的用户名和密码都是在server.xml中设置的，必须指定 -h，因为mycat本身不带有sockt文件，-P 是指定连接端口，mycat模拟的数据库端口是8066</span><br><span class="line"></span><br><span class="line">查询数据库，发现mycat会把查询请求发送到从服务器；</span><br><span class="line">写入数据，发现mycat会把写入请求发送到主服务器；</span><br><span class="line">关闭从服务器，发现mycat读和写都会请求到主服务器，再次开启从服务器，发现读请求立刻发送到了从服务器；</span><br><span class="line">有30秒左右的等待时间</span><br><span class="line">关闭主服务器，发现mycat读可以发送到从服务器，但是写操作被拒绝</span><br><span class="line">MySQL [t1]&gt; insert into teachers values (7,&#39;mengzi&#39;,77,&#39;M&#39;);</span><br><span class="line">ERROR: No operations allowed after connection closed.</span><br><span class="line">再次开启主服务，等待30秒左右，写操作执行成功。</span><br></pre></td></tr></table></figure>



<p>操作步骤：</p>
<p>1.创建MySQL主从数据库</p>
<p>2.在MySQL代理服务器上安装mycat并启动</p>
<p>3.在mycat服务器上修改server.xml文件配置Mycat的连接信息</p>
<p>4.修改schema.xml实现读写分离</p>
<p>5.在Master数据库上创建用户并对mycat授权</p>
<p>6.在mycat上连接并测试</p>
<p>7.通过通用日志确认实现读写分离</p>
<p>8.停止从节点，mycat自动调度请求到主节点</p>
<h4 id="5-ProxySQL"><a href="#5-ProxySQL" class="headerlink" title="5.ProxySQL"></a>5.ProxySQL</h4><h3 id="MySQL高可用"><a href="#MySQL高可用" class="headerlink" title="MySQL高可用"></a>MySQL高可用</h3><h4 id="1-常用的MySQL高可用解决方案"><a href="#1-常用的MySQL高可用解决方案" class="headerlink" title="1.常用的MySQL高可用解决方案"></a>1.常用的MySQL高可用解决方案</h4><ul>
<li>MMM</li>
<li>MHA</li>
<li>Glara Cluster</li>
</ul>
<h4 id="2-MHA-Master-High-Availability"><a href="#2-MHA-Master-High-Availability" class="headerlink" title="2.MHA Master High Availability"></a>2.MHA Master High Availability</h4><h5 id="MHA的工作原理："><a href="#MHA的工作原理：" class="headerlink" title="MHA的工作原理："></a>MHA的工作原理：</h5><p>1.从宕机崩溃的master主机保存二进制日志事件（binlog events）</p>
<p>2.识别含有最新更新的slave</p>
<p>3.应用差异的中继日志（relay log）到其他的slave</p>
<p>4.应用从master保存的二进制日志事件</p>
<p>5.提升一个slave为新的master</p>
<p>6.使其他的slave连接新的master进行复制</p>
<p>7.注意，为了尽量减少主库宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL的半同步复制</p>
<h5 id="MHA软件"><a href="#MHA软件" class="headerlink" title="MHA软件"></a>MHA软件</h5><p>MHA软件由两部分组成，Manager工具包和Node工具包</p>
<h5 id="实验：使用MHA实现高可用"><a href="#实验：使用MHA实现高可用" class="headerlink" title="实验：使用MHA实现高可用"></a>实验：使用MHA实现高可用</h5><p>一共四台机器，一台是MHA的管理机，一台主服务器，两台从服务器</p>
<p>操作系统都是centos7，数据库使用mysql 5.7.30</p>
<p>MHA使用mha4mysql-manager-0.58-0.el7.centos.noarch.rpm和mha4mysql-node-0.58-0.el7.centos.noarch.rpm</p>
<p>1.在管理节点安装manager包和node包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mha4mysql-node-0.58-0.el7.centos.noarch.rpm </span><br><span class="line">yum -y install mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">注意先装node包，manager包依赖node包</span><br><span class="line">rpm -ql mha4mysql-node-0.58-0.el7.centos.noarch </span><br><span class="line">rpm -ql mha4mysql-manager-0.58-0.el7.centos.noarch</span><br></pre></td></tr></table></figure>

<p>2.在其他三台数据库服务器上安装node包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mha4mysql-node-0.58-0.el7.centos.noarch.rpm </span><br></pre></td></tr></table></figure>

<p>3.安装必要的工具，rsync,mailx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install rsync</span><br><span class="line">yum -y install mailx</span><br></pre></td></tr></table></figure>

<p>4.各个节点之间实现ssh key验证功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id 10.0.0.112#MHA管理节点自己的IP</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.101:&#x2F;root&#x2F;</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.7:&#x2F;root&#x2F;</span><br><span class="line">rsync -a &#x2F;root&#x2F;.ssh 10.0.0.110:&#x2F;root&#x2F;</span><br><span class="line">#这个操作的目的就是生成私钥，然后利用ssh-copy-id 把公钥也生成并拷贝给自己，同时，这样也生成了认证文件。这样的话，把这个生成好的.ssh文件夹拷贝给其他主机，那么所有有.ssh这个文件夹的主机之间就都可以实现ssh密钥认证了。</span><br></pre></td></tr></table></figure>

<p>5.实现master主机，基于GTID实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line">log_bin</span><br><span class="line">server-id&#x3D;xxx</span><br><span class="line">开启半同步复制</span><br><span class="line">plugin-load-add&#x3D;semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled&#x3D;on</span><br><span class="line">rpl_semi_sync_master_timeout&#x3D;3000</span><br><span class="line"></span><br><span class="line">新建复制账号和MHA管理账号</span><br><span class="line">CREATE USER &#39;repluser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line">CREATE USER &#39;mhauser&#39;@&#39;10.0.0.%&#39; identified by &#39;centos&#39;;</span><br><span class="line"></span><br><span class="line">GRANT replication slave on *.* to &#39;repluser&#39;@&#39;10.0.0.%&#39;</span><br><span class="line">GRANT all on *.* to &#39;mhauser&#39;@&#39;10.0.0.%&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.实现slave主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;on</span><br><span class="line">plugin-load-add&#x3D;semisync_slave.so</span><br><span class="line">rpl_semi_sync_slave_enabled&#x3D;on</span><br><span class="line"></span><br><span class="line">change master to master_host&#x3D;&#39;10.0.0.112&#39;,</span><br><span class="line"> master_user&#x3D;&#39;repluser&#39;,</span><br><span class="line"> master_password&#x3D;&#39;centos&#39;,</span><br><span class="line"> master_auto_position;</span><br></pre></td></tr></table></figure>

<p>7.在管理节点建立配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">  1 [server default]</span><br><span class="line">  2 user&#x3D;mhauser</span><br><span class="line">  3 password&#x3D;centos</span><br><span class="line">  4 manager_workdir&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;</span><br><span class="line">  5 manager_log&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;manager.log</span><br><span class="line">  6 remote_workdir&#x3D;&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;</span><br><span class="line">  7 ssh_user&#x3D;root</span><br><span class="line">  8 repl_user&#x3D;repluser</span><br><span class="line">  9 repl_password&#x3D;centos</span><br><span class="line"> 10 ping_interval&#x3D;1</span><br><span class="line"> 11 master_ip_failover_script&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;master_ip_failover</span><br><span class="line"> 12 report_script&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;sendmail.sh</span><br><span class="line"> 13 check_repl_delay&#x3D;0</span><br><span class="line"> 14 master_binlog_dir&#x3D;&#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"> 15 </span><br><span class="line"> 16 [server1]</span><br><span class="line"> 17 hostname&#x3D;10.0.0.101</span><br><span class="line"> 18 candidate_master&#x3D;1</span><br><span class="line"> 19 </span><br><span class="line"> 20 [server2]</span><br><span class="line"> 21 hostname&#x3D;10.0.0.7                                                              </span><br><span class="line"> 22 candidate_master&#x3D;1</span><br><span class="line"> 23 </span><br><span class="line"> 24 [server3]</span><br><span class="line"> 25 hostname&#x3D;10.0.0.110</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Perl脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">这个脚本要放到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line">➜  bin cat master_ip_failover </span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env perl</span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL &#x3D;&gt; &#39;all&#39;;</span><br><span class="line">use Getopt::Long;</span><br><span class="line">my (</span><br><span class="line">$command, $ssh_user, $orig_master_host, $orig_master_ip,</span><br><span class="line">$orig_master_port, $new_master_host, $new_master_ip, $new_master_port</span><br><span class="line">);</span><br><span class="line">my $vip &#x3D; &#39;10.0.0.100&#39;;#设置Virtual IP</span><br><span class="line">my $gateway &#x3D; &#39;10.0.0.254&#39;;#网关Gateway IP</span><br><span class="line">my $interface &#x3D; &#39;eth0&#39;;</span><br><span class="line">my $key &#x3D; &quot;1&quot;;</span><br><span class="line">my $ssh_start_vip &#x3D; &quot;&#x2F;sbin&#x2F;ifconfig $interface:$key $vip;&#x2F;sbin&#x2F;arping -I $interface -c 3 -s $vip $gateway &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;;</span><br><span class="line">my $ssh_stop_vip &#x3D; &quot;&#x2F;sbin&#x2F;ifconfig $interface:$key down&quot;;</span><br><span class="line">GetOptions(</span><br><span class="line">&#39;command&#x3D;s&#39; &#x3D;&gt; \$command,</span><br><span class="line">&#39;ssh_user&#x3D;s&#39; &#x3D;&gt; \$ssh_user,</span><br><span class="line">&#39;orig_master_host&#x3D;s&#39; &#x3D;&gt; \$orig_master_host,</span><br><span class="line">&#39;orig_master_ip&#x3D;s&#39; &#x3D;&gt; \$orig_master_ip,</span><br><span class="line">&#39;orig_master_port&#x3D;i&#39; &#x3D;&gt; \$orig_master_port,</span><br><span class="line">&#39;new_master_host&#x3D;s&#39; &#x3D;&gt; \$new_master_host,</span><br><span class="line">&#39;new_master_ip&#x3D;s&#39; &#x3D;&gt; \$new_master_ip,</span><br><span class="line">&#39;new_master_port&#x3D;i&#39; &#x3D;&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line">exit &amp;main();</span><br><span class="line">sub main &#123;</span><br><span class="line">print &quot;\n\nIN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;$ssh_stop_vip&#x3D;&#x3D;$ssh_start_vip&#x3D;&#x3D;&#x3D;\n\n&quot;;</span><br><span class="line">if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span><br><span class="line"># If you manage master ip address at global catalog database,</span><br><span class="line"># invalidate orig_master_ip here.</span><br><span class="line">my $exit_code &#x3D; 1;</span><br><span class="line">eval &#123;</span><br><span class="line">print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">&amp;stop_vip();</span><br><span class="line">$exit_code &#x3D; 0;</span><br><span class="line">&#125;;</span><br><span class="line">if ($@) &#123;</span><br><span class="line">warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"># all arguments are passed.</span><br><span class="line"># If you manage master ip address at global catalog database,</span><br><span class="line"># activate new_master_ip here.</span><br><span class="line"># You can also grant write access (create user, set read_only&#x3D;0, etc) here.</span><br><span class="line">my $exit_code &#x3D; 10;</span><br><span class="line">eval &#123;</span><br><span class="line">print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">&amp;start_vip();</span><br><span class="line">$exit_code &#x3D; 0;</span><br><span class="line">&#125;;</span><br><span class="line">if ($@) &#123;</span><br><span class="line">warn $@;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">exit $exit_code;</span><br><span class="line">&#125;</span><br><span class="line">elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">&#96;ssh $ssh_user\@$orig_master_host \&quot; $ssh_start_vip \&quot;&#96;;</span><br><span class="line">exit 0;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">&amp;usage();</span><br><span class="line">exit 1;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that enable the VIP on the new master</span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">&#96;ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;&#96;;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that disable the VIP on the old_master</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">&#96;ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;&#96;;</span><br><span class="line">&#125;</span><br><span class="line">sub usage &#123;</span><br><span class="line">print</span><br><span class="line">&quot;Usage: master_ip_failover --command&#x3D;start|stop|stopssh|status --orig_master_host&#x3D;host --orig_master_ip&#x3D;ip --orig_master_port&#x3D;port --new_master_host&#x3D;host --new_master_ip&#x3D;ip --new_master_port&#x3D;port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送邮件的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#这个脚本要放到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;下</span><br><span class="line">echo &quot;MySQL is down&quot; | mail -s &quot;MHA Warning&quot; 734709865@qq.com</span><br></pre></td></tr></table></figure>

<p>8.MHA环境检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_ssh --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">#根据提示修改不符合要求的设置</span><br><span class="line">➜  src &#x2F;usr&#x2F;bin&#x2F;masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">app1 is stopped(2:NOT_RUNNING).</span><br><span class="line">现在还没开MHA，所以这个是正常的</span><br></pre></td></tr></table></figure>

<p>9.启动MHA</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  nohub src &#x2F;usr&#x2F;bin&#x2F;masterha_manager --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">这个是前台启动的，程序运行时命令行不会变化</span><br><span class="line">另外开一个窗口观察当前MHA状态</span><br><span class="line">➜  ~ &#x2F;usr&#x2F;bin&#x2F;masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf </span><br><span class="line">app1 (pid:5767) is running(0:PING_OK), master:10.0.0.101</span><br><span class="line">启动成功</span><br></pre></td></tr></table></figure>

<p>10.查看日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;data&#x2F;mastermha&#x2F;manager.log</span><br></pre></td></tr></table></figure>

<p>11.模拟故障</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#MHA有个特点，当master主机down后，MHA开始工作，提拔一个从服务器为主服务器，之后MHA服务就停止了</span><br><span class="line">当故障发生后，我测试几乎5秒不到就切换好了新主机，MHA发送了邮件，然后停止了服务</span><br></pre></td></tr></table></figure>

<p>12.如果需要再次运行MHA，需要先删除下面的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  src ls &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete </span><br><span class="line">&#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete</span><br><span class="line">➜  src rm -f &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;app1.failover.complete </span><br><span class="line">➜  src nohup &#x2F;usr&#x2F;bin&#x2F;masterha_manager --conf&#x3D;&#x2F;etc&#x2F;mastermha&#x2F;app1.cnf</span><br><span class="line">➜  bin tail -f &#x2F;data&#x2F;mastermha&#x2F;app1&#x2F;manager.log </span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;sbin&#x2F;ifconfig eth0:1 down&#x3D;&#x3D;&#x2F;sbin&#x2F;ifconfig eth0:1 10.0.0.100;&#x2F;sbin&#x2F;arping -I eth0 -c 3 -s 10.0.0.100 10.0.0.254 &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info]  OK.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Starting ping health check on 10.0.0.7(10.0.0.7:3306)..</span><br><span class="line">Thu Oct 15 20:07:02 2020 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&#39;t respond..</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>1.在管理节点上安装两个包：manager包和node包</p>
<p>2.在所有mysql服务器上安装node包</p>
<p>3.在管理节点和所有从节点之间实现ssh key 验证</p>
<p>4.在管理节点建立配置文件</p>
<p>5.实现Master</p>
<p>6.实现Slave</p>
<p>7.检查MHA的环境</p>
<p>8.启动MHA</p>
<p>9.查看日志</p>
<p>10.故障检测</p>
<h4 id="3-Galera-Cluster"><a href="#3-Galera-Cluster" class="headerlink" title="3.Galera Cluster"></a>3.Galera Cluster</h4><p>多主的集群，通过全局校验的方式保证多个主服务器之间数据不冲突，同时多个主服务器的集群也解决了单个主服务器的单点失败问题。</p>
<p>节点最少3个，最多8个</p>
<p>限制最少节点是为了避免脑裂，最好使用奇数个数的节点。脑裂指的是双方数据不一致，而且双方服务器数量一致，无法判断应该听从谁的。</p>
<ul>
<li>Percona Xtradb Cluster</li>
<li>Mariadb Galera Cluster</li>
</ul>
<p>Galera Cluster好的特点：</p>
<ul>
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
<li>热拔插：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务时间就会非常少。在节点故障期间，节点本身对集群的影响非常小。</li>
<li>自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不需要人工手动备份提供，Galera Cluster会自动拉取在线节点数据，最终集群会变成一致</li>
<li>对应用透明：集群的维护，对应用程序是透明的</li>
</ul>
<p>Galera Cluster缺点：</p>
<ul>
<li>由于DDL需要全局验证通过，则集群性能有集群中最差的服务器决定（一般集群节点配置都是一样的）</li>
<li>新节点加入或延后较大的节点重新加入需要全量拷贝数据（SST State Snapshot Transfer），作为doner（贡献者：同步数据时提供数据的服务器）的节点在同步过程中无法提供读写</li>
<li>只支持Innodb存储引擎的表</li>
</ul>
<p>PXC的官方文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.percona.com&#x2F;doc&#x2F;percona-xtradb-cluster&#x2F;LATEST&#x2F;overview.html</span><br></pre></td></tr></table></figure>

<p>PXC实现步骤：</p>
<p>1.配置PXC的专用yum源</p>
<p>2.在每台节点上都安装PXC</p>
<p>3.在每个节点都修改PXC配置文件 /etc/percona-xtradb-cluster.conf.d/wsrep.conf</p>
<p>​    配置节点IP</p>
<p>​    节点本身的IP</p>
<p>​    集群节点名称</p>
<p>​    认证的账号密码</p>
<p>4.开启PXC，注意第一个节点与其他节点不一样</p>
<p>5.其他节点开启</p>
<h4 id="4-TiDB"><a href="#4-TiDB" class="headerlink" title="4.TiDB"></a>4.TiDB</h4><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="压力测试工具"><a href="#压力测试工具" class="headerlink" title="压力测试工具"></a>压力测试工具</h3><h3 id="生产环境my-cnf配置案例"><a href="#生产环境my-cnf配置案例" class="headerlink" title="生产环境my.cnf配置案例"></a>生产环境my.cnf配置案例</h3><h3 id="MySQL配置最佳实践"><a href="#MySQL配置最佳实践" class="headerlink" title="MySQL配置最佳实践"></a>MySQL配置最佳实践</h3><p>重点：</p>
<p>1.表DML ！！！</p>
<p>2.表DQL 单表和多表 ！！！</p>
<p>3.视图、函数、触发器、存储过程、事件 作为了解</p>
<p>4.用户账号的创建、删除、修改密码  ！</p>
<p>5.用户授权管理  ！</p>
<p>1.存储引擎的区别</p>
<p>2.索引</p>
<p>3.事务</p>
<p>4.备份</p>
<p>5.数据库的主从</p>
<p>1.备份工具的使用：mysqldump,xtrabackup,mariadbbackup</p>
<p>两个问题：</p>
<p>1.如何把多行命令写进去，或者说CHANGE MASTER TO 到底什么要求</p>
<p>2.写进去了为什么还是连接不上级联节点</p>
<p>要做的事情，</p>
<p>重新配置级联节点和从服务器，如果写不进去也先手写进去，先保证写进去了能连接</p>
<p>CHANGE MASTER TO  MASTER_HOST=’source2.example.com’,  MASTER_USER=’replication’,  MASTER_PASSWORD=’<em>password</em>‘,  MASTER_PORT=3306,  MASTER_LOG_FILE=’source2-bin.001’,  MASTER_LOG_POS=4,  MASTER_CONNECT_RETRY=10;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" data-id="ckhnf9hfu000d40utaf958of1" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Linux启动和内核管理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/Linux%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.237Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Linux启动和内核管理"><a href="#Linux启动和内核管理" class="headerlink" title="Linux启动和内核管理"></a>Linux启动和内核管理</h3><p>重点：</p>
<p><strong>1.linux的启动流程</strong></p>
<p>2.启动故障排错</p>
<p>3.编译内核</p>
<p><strong>4.内核参数优化 /etc/sysctl.conf</strong> </p>
<p>5.自制Linux+BUSYBOX = WEB服务器</p>
<p>命令：</p>
<p>busybox    mkinitrd    modinfo    modprobe    chkconfig    sysctl</p>
<p>ntsysnv    ismod    rmmod    grub    grub-install    grub-md5-crypt    grub-crypt    runlevel    </p>
<p>sysctl -a -w -p</p>
<p>加电自检–&gt;找到启动设备–&gt;bootloader grub –&gt;读取第一个扇区内容（512 bytes）–&gt;找到文件系统的驱动程序</p>
<p>bootloader 阶段</p>
<ul>
<li>1阶段：MBR的前446个字节</li>
<li>1.5阶段：512字节之后的扇区，让阶段1的bootloader能识别阶段2所在分区的文件系统</li>
<li>2阶段：分区文件/boot/grub</li>
</ul>
<p>/boot/grub/grub.conf –&gt;找到系统内核和根系统路径</p>
<p>kernel /vmlinuzxxxxxxx</p>
<p>initrd /initxxxxxxxxx</p>
<p>1,1.5阶段的修复：</p>
<ul>
<li><p>切换根目录 chroot /mnt/sysimage</p>
</li>
<li><p>grub -install –root -directory=DIR /dev/sda –&gt;修复/boot/grub下除了grub.conf以外的文件</p>
</li>
<li><p>mkinitrd /boot/initrdxxxx</p>
</li>
</ul>
<p>centos 6 的开机运行程序顺序</p>
<p>脚本的编写</p>
<p>服务卡住导致无法启动，可以进单用户模式修改，禁止他启动</p>
<p>/etc/init.d/  这里放的是脚本</p>
<p>/etc/rc*.d/    这里放的都是软链接，通过命令创建软链接</p>
<p>然后通过命令将他添加到自动启动</p>
<p>/etc/rc.d/rc.local 这个里面可以写自己想要自动启动的脚本</p>
<p><strong>/proc</strong></p>
<p>sysctl </p>
<p>/etc/sysctl.conf</p>
<p><strong>/sys</strong></p>
<h4 id="内核管理"><a href="#内核管理" class="headerlink" title="内核管理"></a>内核管理</h4><p>kernel object  内核文件 .ko</p>
<p>几个内核模板命令</p>
<p><strong>编译内核</strong></p>
<p>1.configure文件照抄原系统，修改几个地方</p>
<p>2.解压文件</p>
<p>3.编译</p>
<p>4.make install</p>
<p><strong>BUSYBOX</strong>：一个强大的工具箱，可以实现多种功能</p>
<h4 id="内核参数"><a href="#内核参数" class="headerlink" title="内核参数"></a>内核参数</h4><p>/proc/sys –&gt; sysctl命令，专门用来调整内核参数</p>
<p><strong>sysctl</strong> -w name=xxx  更改内核参数 </p>
<p>sysctl -a 全部内核参数</p>
<p>/sys 硬件信息</p>
<p>内核版本 uname -r 显示版本</p>
<p><strong>uname</strong> -a 显示所有信息</p>
<p>内核模块命令 /proc/modules</p>
<p><strong>lsmod</strong> 显示由核心已经装载的内核模块，显示内容来自/proc/modules</p>
<p><strong>modinfo</strong> 管理内核模块，显示内核模块的详细信息</p>
<p>modinfo -n  只显示模块路径</p>
<p>modinfo -p 显示模块参数</p>
<p>modinfo -a 作者</p>
<p>modinfo -d 描述</p>
<p><strong>modprobe</strong>  装载或卸载内核模块</p>
<p>modprobe usb_storage 装载</p>
<p>modprobe -r usb_storage 卸载</p>
<p><strong>depmod</strong> 内核模块依赖关系文件及系统信息映射文件的生成工具</p>
<p><strong>insmod</strong>  可以安装模块，需要指定模块文件路径，并且不自动解决依赖模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insmod [ filename ]  [ module options ]</span><br><span class="line">例子：</span><br><span class="line">insmod &#96;modinfo -n exportfs&#96;</span><br><span class="line">insmod &#96;modinfo -n xfs&#96;</span><br></pre></td></tr></table></figure>

<p><strong>rmmod</strong> 卸载模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rmmod xfs</span><br><span class="line">rmmod exportfs</span><br></pre></td></tr></table></figure>



<h4 id="centos-6-linux的启动流程"><a href="#centos-6-linux的启动流程" class="headerlink" title="centos 6 linux的启动流程"></a>centos 6 linux的启动流程</h4><p><a target="_blank" rel="noopener" href="http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg">http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg</a></p>
<p>–&gt;加电自检</p>
<p>–&gt;加载BIOS，根据自上而下的顺序决定启动的存储硬件，并读取硬件上的MBR（Master boot recoder，硬盘的主引导记录）</p>
<p>–&gt;寻找grub，MBR的前446字节是grub（bootloader）的地址，后64字节是分区信息，最后两个字节是55 aa结束标识位</p>
<p><strong>stage1</strong> MBR的前446个字节，里面是grub的地址</p>
<p><strong>stage1.5</strong> MBR从前512字节之后的字节，这里的内容是让grub能够识别/boot/grub的文件系统</p>
<p><strong>stage2</strong> /boot/grub文件，这里面有grub配置文件，包含内核位置，initrd文件位置等信息</p>
<p>–&gt;读取grub的配置信息，grub的配置信息中包含了操作系统的内核位置和初始化程序包（硬件驱动程序）</p>
<p>–&gt;内核执行init程序，获取默认的运行信息（/etc/inittab）</p>
<p>–&gt;init程序执行/etc/rc.d/rc.sysinit文件，重新挂载根文件系统</p>
<p>–&gt;启动核心的外挂模块</p>
<p>–&gt;init运行各个脚本文件（/etc/rc.d/init.d）</p>
<p>–&gt;init执行/etc/rc.d/rc.local</p>
<p>–&gt;执行/bin/login程序，等待用户登录</p>
<p>–&gt;用户登录，以shell控制主机</p>
<h4 id="centos6的最小系统制作"><a href="#centos6的最小系统制作" class="headerlink" title="centos6的最小系统制作"></a>centos6的最小系统制作</h4><p>所需条件：</p>
<p>1.vmlinuz内核文件，initrawfs.img 镜像模块文件</p>
<p>2.grub引导，grub-install –root-directory=/root /dev/sda，以及grub.conf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">default&#x3D;0</span><br><span class="line">timeout&#x3D;5</span><br><span class="line">title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">kernel &#x2F;vmlinuz root&#x3D;&#x2F;dev&#x2F;sda2 init&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">initrd &#x2F;initramfs.img</span><br></pre></td></tr></table></figure>

<p>3.必要的目录和启动程序及命令脚本，启动程序和目录脚本可以用busybox代替，在</p>
<p>busybox源码编译完成后，生成了_install文件，里面有/bin,/sbin,/usr 这里面有基本所有的命令，他们都指向/bin/busybox。</p>
<h4 id="centos6删除-boot-以及-etc-fstab后如何自救"><a href="#centos6删除-boot-以及-etc-fstab后如何自救" class="headerlink" title="centos6删除 /boot/*以及/etc/fstab后如何自救"></a>centos6删除 /boot/*以及/etc/fstab后如何自救</h4><p>1.进入救援模式，此时是看不到硬盘分区信息的，所以第一个目的就是恢复分区信息，尤其是找到/root，因为找到这个目录就能自己编写/etc/fstab了</p>
<p>使用fdisk -l 可以看到硬盘的分区情况，但是都没有挂载，需要新建一个文件夹来挂载测试，看看哪个分区是/root</p>
<p>2.找到/root后，编写fstab文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UUID&#x3D;4d61dbb0-c5bb-4403-a7a3-8fbac43d112d &#x2F;                       xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;61ad2930-f49f-4257-86b7-a530310a949b &#x2F;boot                   xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;23b80602-17b8-4a93-a9fa-a8d4b45838f3 &#x2F;data                   xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;e024b373-e102-42e1-ae6e-cc83cd135eec swap                    swap    defaults        0 0</span><br><span class="line">UUID&#x3D;95a42eaa-cc05-484d-ae5e-88b98add2c39 &#x2F;edata          ext4    defaults        0 0          </span><br></pre></td></tr></table></figure>

<p>这里面 UUID那里可以直接写硬盘的分区名，比如 /dev/sda1 这样，后面写挂载点</p>
<p>然后重启</p>
<p>3.重启后还是不能打开系统，因为没有启动引导了，所以还要进救援模式</p>
<p>4.这次进救援模式就是为了重新生成引导文件，所以需要这么几步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.切换根，chroot &#x2F;mnt&#x2F;sysimage&#x2F; </span><br><span class="line">2.恢复内核文件和模块镜像文件，可以用下面的命令生成</span><br><span class="line">rpm -ivh &#x2F;mnt&#x2F;Packages&#x2F;kernelxxxxxxx.rpm --force</span><br><span class="line">3.生成grub文件夹以及里面除了grub.conf以外的文件 grub-install &#x2F;dev&#x2F;sda1</span><br><span class="line">4.编写grub.conf</span><br><span class="line">	default&#x3D;0</span><br><span class="line">	timeout&#x3D;5</span><br><span class="line">	title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">	kernel &#x2F;vmlinuz root&#x3D;&#x2F;dev&#x2F;sda2 init&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">	initrd &#x2F;initramfs.img</span><br><span class="line">5.sync 同步</span><br><span class="line">6.重启</span><br></pre></td></tr></table></figure>



<h4 id="systemd：system-daemon！"><a href="#systemd：system-daemon！" class="headerlink" title="systemd：system daemon！"></a><strong>systemd</strong>：system daemon！</h4><p> centos7,8的技术，超级守护进程，顶替了xinetd</p>
<p>systemd代替其他的服务程序去监听端口，按需要唤醒服务</p>
<p>socket：套接字  端口:IP_ADDR</p>
<p>service：服务程序</p>
<p>unit：统统都叫unit</p>
<p>unit类型：</p>
<ul>
<li><p>service unit：文件扩展名为.service，用于定义系统服务</p>
</li>
<li><p>Socket unit：.socket，定义进程间通信用的socket，也可以在系统启动时，延迟启动服务，实现按需启动</p>
</li>
<li><p>Target unit：文件扩展名为.target，用于模拟实现运行级别</p>
</li>
<li><p>Device unit：.device，用于定义内核识别的设备</p>
</li>
<li><p>Mount unit：.mount，定义文件系统挂载点</p>
</li>
</ul>
<p>涉及到的文件路径：</p>
<p><strong>/usr/lib/systemd/system</strong> 这个目录下放着启动服务.service文件，类似启动脚本，这里是发行版软件</p>
<p><strong>/lib/systemd/system</strong>  这里也是放启动服务，类似脚本，这里是系统自带</p>
<p><strong>/run/systemd/system</strong> 系统执行过程中所产生的服务脚本</p>
<p><strong>/etc/systemd/system</strong> 这个目录下包含了哪些运行级别下哪些服务要被启动或禁用</p>
<p>/usr/lib/systemd/system/ 和 /lib/systemd/system 之间存在特殊关系，我在这两个文件夹下创建name.service文件后，两边会同时生成name.service文件，在启用这个name.service服务时，建立的软链接是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;systemd&#x2F;systemd&#x2F;multi-user.target.wants&#x2F;hello.service -&gt; &#x2F;user&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;hello.service</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.systemctl命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl start name.service</span><br><span class="line">systemctl stop name.service</span><br><span class="line">systemctl restart naem.service</span><br><span class="line">systemctl status name.service</span><br><span class="line">systemctl is-active name.service</span><br><span class="line">systemctl is-enabled name.service</span><br><span class="line">systemctl mask name.service </span><br><span class="line">systemctl unmask name.service </span><br><span class="line">systemctl list-units -t service #列出运行的服务</span><br><span class="line">systemctl list-units --type service -a  #列出所有服务</span><br><span class="line">systemctl enbale name.service</span><br><span class="line">systemclt disable name.service</span><br><span class="line">ll &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;*.wants&#x2F; #列出哪些服务在哪些运行级别下启用和禁用</span><br><span class="line">systemctl --failed --type service #列出失败的服务</span><br><span class="line">systemctl list-dependencies name.service #列出服务的依赖关系</span><br><span class="line">systemctl kill unitname #杀掉进程</span><br><span class="line">systemctl list-unit-files #列出unit的状态</span><br></pre></td></tr></table></figure>

<ul>
<li>loaded unit配置文件已处理</li>
<li>active(running) 一次或多次秩序处理的运行</li>
<li>active(exited) 成功完成一次性的配置</li>
<li>active(waiting) 运行中，等待一个事件</li>
<li>inactive 不运行</li>
<li>enabled 开机启动</li>
<li> disabled 开机不启动</li>
<li>static 开机不启动，但可被另一个启用的服务激活</li>
<li>indirect 重定向到别处</li>
</ul>
<p><strong>2.service unit</strong></p>
<p>unit格式说明：</p>
<ul>
<li>以“#”开头的行后面的内容会被认为是注释</li>
<li>相关布尔值，1，yes，on，true都是开启，0，no，off，false都是关闭</li>
<li>时间单位默认是秒，所以要用毫秒（ms）、分钟（m）等需要显式说明</li>
</ul>
<p>service unit file 通常由三部分组成：</p>
<ul>
<li>[Unit]：定义与Unit类型无关的通用选项；用于提供unit的描述信息、unit行为及依赖关系等</li>
<li>[Service]：与特定类型相关的专用选项；此处为Service类型</li>
<li>[Install]：定义由“systemctl enable”以及“systemctl disable”命令在实现服务启用或禁用时用到的一些选项</li>
</ul>
<p>Unit段常用选项：</p>
<ul>
<li>Description：描述信息</li>
<li>After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反</li>
<li>Requires：依赖到的其他units，强依赖，被依赖的units无法激活时，当前unit也无法激活</li>
<li>Wants：依赖到的其他units，若依赖</li>
<li>Conflict：定义units间的冲突关系</li>
</ul>
<p>Service段的常用选项：</p>
<ul>
<li>Type：定义影响ExecStart及相关参数的功能的unit进程启动类型<ul>
<li>simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后常驻与内存中</li>
<li>forKing：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此daemon的主要服务，原生父程序在启动结束后就会终止</li>
<li>oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻与内存</li>
<li>dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才会继续运作，因此通常也要同时设定BusName= 才行</li>
<li>notify：在启动完成后会发送一个通知信息，还需要配合NotifyAccess来让Systemd接收消息</li>
<li>idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕后才执行。这类的daemon通常是开机到最后才执行即可的服务。</li>
</ul>
</li>
<li>EnvironmentFile：环境配置文件</li>
<li>ExecStart：指明启动unit要运行命令或脚本的绝对路径</li>
<li>ExecStartPre：ExecStart前运行</li>
<li>ExecStartPost：ExecStart后运行</li>
<li>ExecStop：指明停止unit要运行的命令或脚本</li>
<li>Restart：当设定Restart=1时，则当daemon服务意外终止后，会再次启动此服务</li>
<li>PrivateTmp：设定为yes时，会生成/tmp/systemd-private-UUID-NAME.service-XXXX/tmp/ 目录</li>
</ul>
<p>Install段的常用选项：</p>
<ul>
<li>Alias：别名，可使用systemctl command Alias.service</li>
<li>RequireBy：被哪些units所依赖，强依赖</li>
<li>WantedBy：被哪些units所依赖，弱依赖</li>
<li>Also：安装脚本服务的时候还要安装别的相关服务</li>
</ul>
<p>注意：新建或者修改了unit文件，需要通知systemd重新加载此文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>



<p>3.target units：相当于centos 6 之前的runlevel，unit配置文件：.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;*.target</span><br><span class="line">systemctl list-units --type target -a #显示全部target</span><br></pre></td></tr></table></figure>

<p>运行级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">o &#x3D;&#x3D;&gt; runlevel0.target，poweroff.target</span><br><span class="line">1 &#x3D;&#x3D;&gt; runlevel1.target，rescue.target</span><br><span class="line">2 &#x3D;&#x3D;&gt; runlevel2.target，multi-user.target</span><br><span class="line">3 &#x3D;&#x3D;&gt; runlevel3.target，multi-user.target</span><br><span class="line">4 &#x3D;&#x3D;&gt; runlevel4,target，multi-user.target</span><br><span class="line">5 &#x3D;&#x3D;&gt; runlevel5,target，graphical.target</span><br><span class="line">6 &#x3D;&#x3D;&gt; runlevel6，target,reboot.target</span><br></pre></td></tr></table></figure>

<p>查看target的依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units dependencies  name.target</span><br></pre></td></tr></table></figure>

<p>运行级别切换：相当于 init N</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysetmctl isslate name.target</span><br></pre></td></tr></table></figure>

<p>查看当前默认运行级别、进入默认运行级别、设定默认运行级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl get-default</span><br><span class="line">systemctl default</span><br><span class="line">systemctl set-default name.target</span><br></pre></td></tr></table></figure>

<p>生产环境禁用ctrl+alt+delete重启快捷键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ll &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ctrl-alt-del.target</span><br><span class="line">systemctl mask ctrl-alt-del.target</span><br><span class="line">Created symlink &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ctrl-alt-del.target -&gt; &#x2F;dev&#x2F;null</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>



<h4 id="centos-7之后的linux启动流程"><a href="#centos-7之后的linux启动流程" class="headerlink" title="centos 7之后的linux启动流程"></a>centos 7之后的linux启动流程</h4><p>–&gt;加电自检</p>
<p>–&gt;加载BIOS，选择启动的硬件存储设备</p>
<p>–&gt;引导装载程序，centos7之后是grub2，配置文件是</p>
<p>/etc/grub.d  /etc/default/grub  /boot/grub2/grub.cfg</p>
<p>–&gt;加载initramfs驱动模块</p>
<p>–&gt;加载内核选项</p>
<p>–&gt;内核初始化，centos7使用systemd代替init</p>
<p>–&gt;执行initrd.target所有单元，包括挂载/etc/fstab</p>
<p>–&gt;从initramfs根文件切换到磁盘根目录</p>
<p>–&gt;systemd执行默认target配置，配置文件/etc/systemd/system/system.target</p>
<p>–&gt;systemd执行sysint.target初始化系统及basic.target准备操作系统</p>
<p>–&gt;systemd启动multi-user.target下的本机与服务器服务</p>
<p>–&gt;systemd执行multi-user.target下的/etc/rc.d/rc.local</p>
<p>–&gt;systemd执行multi-user.target下的getty.target及登录服务</p>
<p>–&gt;systemd执行graphical需要的服务</p>
<p>执行命令可以看到systemd的执行过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze blame</span><br><span class="line">systemd-analyze plot &gt; boot.html #这个命令可以生成一个html文件</span><br></pre></td></tr></table></figure>

<h4 id="破解centos7-8的root密码："><a href="#破解centos7-8的root密码：" class="headerlink" title="破解centos7,8的root密码："></a>破解centos7,8的root密码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在系统启动过程中，在内核选择界面按e,然后在linux开头那行的最后加上：rd.break，然后ctrl+x启动，进入一个shell界面，这时需要重新挂载根目录，</span><br><span class="line">mount -o remount,rw &#x2F;sysroot</span><br><span class="line">chroot &#x2F;sysroot</span><br><span class="line">passwd root</span><br><span class="line">更改密码，然后exit,reboot，ok了</span><br></pre></td></tr></table></figure>

<p>破解centos6的root密码，更简单，在系统启动过程中，在内核选择界面按e，然后在linux开头的行最后写上 1或者s,S,single都行，意思是进入单用户模式，然后按b启动，然后就OK了，进入系统后passwd改密码就行</p>
<p>grub2增加密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grub2-password</span><br><span class="line">输入两遍密码</span><br><span class="line">这个密码其实是生成了一个&#x2F;boot&#x2F;grub2&#x2F;user.cfg文件，如果不想要密码了就把这个文件删除就行</span><br></pre></td></tr></table></figure>

<h4 id="grub2"><a href="#grub2" class="headerlink" title="grub2"></a>grub2</h4><p>grub2的修复：</p>
<p>1.修复配置文件grub.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg</span><br></pre></td></tr></table></figure>

<p>2.完整修复grub2文件夹中除了grub.cfg以外的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub-install &#x2F;dev&#x2F;sda  #此时的根是真正的根目录时，不需要写 --root-directory&#x3D;xxx，如果此时是光盘的救援模式等情况，根不是真根，那么就需要写真正的根目录</span><br></pre></td></tr></table></figure>

<p>3.修改默认启动内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;boot&#x2F;grub2&#x2F;grubenv</span><br><span class="line">#里面有一行：saved_entry&#x3D;xxxx，修改成想要的内核名称</span><br></pre></td></tr></table></figure>









<p>今日重点：</p>
<p>1.systemctl start stop restart enable disable is-actice is-enable reload mask systemctl get-default</p>
<p>2.service 文件格式</p>
<p>3.centos7,8启动流程，systemd （启动流程）</p>
<p>4.grub2</p>
<p>5.破解centos7,8 root秘密，grub加密</p>
<p>6.rm -rf /boot centos7的修复实验</p>
<p>7.安全，加密算法：对称，非对称，哈希，综合使用</p>
<p>8.证书和CA的工作原理</p>
<p>9.https的工作原理 (重要)</p>
<p>gpg sha512sum  grub2-mkconfig grub2-setpassword systemd-analize plot reset </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/Linux%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/" data-id="ckhnf9heg000140utfz2n734p" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-LVS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/18/LVS/" class="article-date">
  <time class="dt-published" datetime="2020-11-18T13:08:14.237Z" itemprop="datePublished">2020-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Linux-Virtual-Server"><a href="#Linux-Virtual-Server" class="headerlink" title="Linux Virtual Server"></a>Linux Virtual Server</h1><p>LVS：负载均衡服务器</p>
<p>Linux Virtual Server</p>
<p>尝试使用80/20方法进行LVS的学习，得分步骤做：80%的需要是在20%的内容中的</p>
<p>LVS的重要的20%是：</p>
<ul>
<li>LVS的工作原理</li>
<li>LVS-DR模型的实现方法</li>
<li>LVS-DR的实际操作</li>
</ul>
<h2 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h2><ul>
<li><strong>集群概念</strong></li>
<li><strong>LVS模型</strong></li>
<li><strong>LVS调度算法</strong></li>
<li><strong>LVS实现</strong></li>
<li><strong>Idirectord</strong></li>
</ul>
<h1 id="1-集群和分布式"><a href="#1-集群和分布式" class="headerlink" title="1.集群和分布式"></a>1.集群和分布式</h1><p>系统性能扩展方式：</p>
<ul>
<li>Scale Up：垂直扩展，向上扩展，增强单个服务器的性能</li>
<li>Scale Out：水平扩展，向外扩展，增加更多设备</li>
</ul>
<p>水平扩展更合适，性价比高，所以需要一个调度器</p>
<h2 id="1-1-集群-Cluster"><a href="#1-1-集群-Cluster" class="headerlink" title="1.1 集群 Cluster"></a>1.1 集群 Cluster</h2><p>Cluster分为三个类型</p>
<ul>
<li><p>LB：Load Balancing 负载均衡，多个主机组成，每个主机只承担一部分访问请求</p>
</li>
<li><p>HA：High Availiablity，高可用，避免单点失败问题</p>
<p>考核指标：MTBF：Mean Time Between failure 平均无故障时间，即正常时间</p>
<p>MTTR：Mean Time To Restoration  平均恢复前时间，即故障时间</p>
<p>故障时间 / 全部时间    的比值，99% 99.9% 99.99% 99.999%，按年来算</p>
<p>SLA：服务等级协议，就是看你能有几个9</p>
<p>计划外的停机时间是我们需要关注的</p>
</li>
<li><p>HPC：</p>
</li>
</ul>
<h2 id="1-2-分布式系统"><a href="#1-2-分布式系统" class="headerlink" title="1.2 分布式系统"></a>1.2 分布式系统</h2><p>分布式存储：Ceph，Gluster，FastDFS，MogileFS</p>
<p>分布式计算：Hadoop，Spark</p>
<p>1.3 集群和分布式的区别</p>
<p>1.4 集群设计原则</p>
<p>1.5 集群涉及实现</p>
<p>1.5.1 基础设施层面</p>
<p>1.5.2 业务层面</p>
<h2 id="1-6-LB-Cluster-负载均衡集群"><a href="#1-6-LB-Cluster-负载均衡集群" class="headerlink" title="1.6 LB Cluster 负载均衡集群"></a>1.6 LB Cluster 负载均衡集群</h2><p>1.6.1 实现方式</p>
<ul>
<li>硬件实现</li>
<li>软件</li>
</ul>
<h1 id="2-LVS"><a href="#2-LVS" class="headerlink" title="2.LVS"></a>2.LVS</h1><p>LVS工作原理：LVS是内核级功能，工作在INPUT链的位置，将发往INPUT链的数据报文根据目标IP和目标端口及协议将其调度转发到真实的业务服务器上，转发的依据是多种调度算法</p>
<p>查看内核对LVS的支持：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ grep -i -C 10 ipvs /boot/config-3.10.0-1127.el7.x86_64</span><br><span class="line"><span class="comment"># IPVS transport protocol load balancing support    #支持的协议</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_PROTO_TCP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_UDP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH=y</span><br><span class="line">CONFIG_IP_VS_PROTO_SCTP=y</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS scheduler    #调度算法</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_RR=m</span><br><span class="line">CONFIG_IP_VS_WRR=m</span><br><span class="line">CONFIG_IP_VS_LC=m</span><br><span class="line">CONFIG_IP_VS_WLC=m</span><br><span class="line">CONFIG_IP_VS_LBLC=m</span><br><span class="line">CONFIG_IP_VS_LBLCR=m</span><br><span class="line">CONFIG_IP_VS_DH=m</span><br><span class="line">CONFIG_IP_VS_SH=m</span><br><span class="line">CONFIG_IP_VS_SED=m</span><br><span class="line">CONFIG_IP_VS_NQ=m</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS SH scheduler</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_SH_TAB_BITS=8</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS application helper</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_FTP=m</span><br><span class="line">CONFIG_IP_VS_NFCT=y</span><br><span class="line">CONFIG_IP_VS_PE_SIP=m</span><br></pre></td></tr></table></figure>



<h2 id="LVS集群中的术语"><a href="#LVS集群中的术语" class="headerlink" title="LVS集群中的术语"></a>LVS集群中的术语</h2><p>VS：Virtual Server，Load Balancer</p>
<p>RS：Real Server(LSV)，upstream server(nginx)，backend server(haproxy)</p>
<p>CIP：Client Server</p>
<p>VIP：Virtual server IP，面对用户的IP</p>
<p>DIP：Director IP，面对业务服务器的IP</p>
<p>RIP：Real Server IP</p>
<p>访问流程：CIP–&gt;VIP–&gt;DIP–&gt;RIP</p>
<h2 id="LVS工作模式和相关命令"><a href="#LVS工作模式和相关命令" class="headerlink" title="LVS工作模式和相关命令"></a>LVS工作模式和相关命令</h2><p>TCP/IP在各个层数据单位是什么？</p>
<p>应用层：报文</p>
<p>传输层：报文段</p>
<p>网络层：数据包</p>
<p>链路层：帧</p>
<h3 id="1-LVS集群的工作模式"><a href="#1-LVS集群的工作模式" class="headerlink" title="1 LVS集群的工作模式"></a>1 LVS集群的工作模式</h3><ul>
<li>lvs-nat：本质是多目标IP的DNAT；重点：对报文的修改！</li>
<li>lvs-dr：Direct Routing 直接路由，基于数据链路层的MAC地址进行修改</li>
<li>lvs-tun：tunnel，隧道，在原请求的IP报文之外新添加一个IP首部</li>
<li>lvs-fullnat：修改请求报文的源和目标IP</li>
</ul>
<h4 id="LVS-NAT"><a href="#LVS-NAT" class="headerlink" title="LVS-NAT"></a>LVS-NAT</h4><p>本质：是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为根据调度算法选择出的一个RS的RIP和Port实现转发；同时把从RS回来的响应报文的目标地址和目标端口修改为客户端的IP和端口</p>
<p>特征：</p>
<blockquote>
<p>1.RIP和DIP应该在同一个IP网络，且应该使用私网地址；RS的网关要指向DIP</p>
<p>2.请求报文和响应报文都必须经由Director转发，因此Director容易成为系统瓶颈</p>
<p>3.支持端口映射，可以修改请求报文的目标Port</p>
<p>4.因为使用的技术是Linux的内核技术LVS，因此Director必须是Linux操作系统，RS可以是任意系统</p>
<p>5.Director需要开启FORWORD选项，net.ipv4.ip_forward</p>
</blockquote>
<p>画报文图，应该画两个，去方向一个图，回方向一个图</p>
<p>请求报文流程图：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105223908434.png" alt="image-20201105223908434"></p>
<p>响应报文流程图：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105224836162.png" alt="image-20201105224836162"></p>
<h4 id="LVS-DR：最主流的使用模型、默认的模型"><a href="#LVS-DR：最主流的使用模型、默认的模型" class="headerlink" title="LVS-DR：最主流的使用模型、默认的模型"></a>LVS-DR：最主流的使用模型、默认的模型</h4><p>Direct Routing</p>
<p>工作方式：通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是根据调试算法挑选出的RS的RIP所在接口的MAC地址，需要注意的是，源IP/PORT以及目标IP/PORT是在整个请求过程中是不被改变的；当RS发送响应报文时，根本不经过Director，而是自己把这个响应报文发送给路由器，由路由器把响应报文发给客户端</p>
<p>特点：</p>
<blockquote>
<p>1.DR模型可以降低LVS的负载压力，因为回复报文不需要经过LVS了</p>
<p>2.需要确保前端的路由器将目标IP为VIP的请求报文真的发送给Director而不是具有相同VIP的RS，方法大体上有三种：</p>
<p>​    1）在前端的路由器上做静态的IP和MAC地址的绑定，把VIP绑定到Director的MAC地址</p>
<p>​    2）在RS上使用arptables工具</p>
<p>​    3）在RS上修改内核参数，本质上是对绑定了VIP的网卡的arp协议的广播和接收进行了关闭</p>
<p>​    修改的参数是：/proc/sys/net/ipv4/conf/all/arp_ignore</p>
<p>​                 /proc/sys/net/ipv4/conf/all/arp_announce</p>
<p>​    上面的参数是对一个主机的arp的总开关，对于我们需要真正要修改的、VIP的网卡还需要开小开关</p>
<p>​                 /proc/sys/net/ipv4/conf/lo/arp_ignore</p>
<p>​                 /prof/sys/net/ipv4/conf/lo/arp_announce</p>
<p>3.RS的RIP可以使用私网地址，也可以是公网地址，只要RIP和DIP在同一个网络就行；RIP的网关不能指向DIP，以确保响应报文不会经由Director</p>
<p>4.RS和Director要在同一个物理网络</p>
<p>5.请求报文要经由Director，但响应报文不经由Director，而是由RS之间发送给路由器，路由器再发送给客户端</p>
<p>6.因为是对数据链路层的MAC地址的改变，因此不支持端口映射</p>
<p>7.Director不需要开启路由转发，因为数据不经过他的FORWARD链</p>
<p>8.因为使用的技术是Linux的内核技术LVS，因此Director必须是Linux操作系统，RS可以是大多数系统</p>
</blockquote>
<p>LVS-DR模型中的重点问题：</p>
<blockquote>
<p>如何解决IP地址冲突问题？—&gt;地址冲突是因为arp的广播和接收，导致每个主机都会通知其他主机自己的IP和MAC的对应关系，而通过修改内核参数，关闭RS的arp广播和接收选项，而Director正常广播自己的VIP和MAC的对应关系，这样就不冲突了</p>
<p>支持端口映射吗？—&gt;LVS-DR模型只修改数据链路层，因此不支持端口映射；</p>
<p>为什么Director和RS之间必须在交换机环境，不可以有路由器？—&gt;因为LVS-DR模型是Director通过对请求报文中MAC地址的修改进行转发和调度的，而在转发的过程中是把目标MAC从Director改成了RS的MAC，因此Director和RS需要知道彼此的MAC地址，而MAC地址又是通过arp协议来获取的，而arp协议是通过广播来实现的，而广播又不能穿过路由器，因此，Director和RS要在同一个路由器下，所以他们中间不能是路由器</p>
<p>重点：对ARP的理解；免费ARP是？，自问自答，判断IP地址冲突；</p>
<p>根据ARP协议的工作流程，修改ARP协议中的发送和接收选项；修改的是内核参数</p>
<p>配置在回环网卡上，lo，网络地址稳定，不影响其他网卡</p>
</blockquote>
<h4 id="LVS-DR模型的数据流程图："><a href="#LVS-DR模型的数据流程图：" class="headerlink" title="LVS-DR模型的数据流程图："></a>LVS-DR模型的数据流程图：</h4><blockquote>
<p><strong>注意：Web服务器网关要指向防火墙（路由器），因为响应报文不需要经过LVS，而是Web服务器自己发往客户端</strong></p>
</blockquote>
<blockquote>
<p><strong>注意：图中的防火墙提供了DNAT功能，把目标地址为172.30.0.200的请求都转发到了10.0.0.200上</strong></p>
</blockquote>
<blockquote>
<p>注意：图中我认为客户端不应该之间知道内网LVS的地址，因此使用了防火墙的DNAT，对于LVS来说，目标IP是没变过的，一致是VIP</p>
</blockquote>
<blockquote>
<p>注意：因为LVS-DR要让LVS和多台Web服务器使用一个相同的VIP，所以涉及地址冲突问题，但是可以通过修改所有Web服务器上的内核arp参数来解决这一问题，这样可以实现在这个局域网中，所有主机都认为拥有VIP地址的主机是LVS，因此防火墙会把报文先发送给LVS</p>
</blockquote>
<blockquote>
<p>注意：因为VIP是绑定在回环网卡lo上的，而lo网卡没有MAC地址，因此其实是使用了每个主机的其他网卡进行信息传输的，所以在报文中的MAC地址都是本机的其他网卡的</p>
</blockquote>
<p>图中IP地址和MAC的对应关系</p>
<table>
<thead>
<tr>
<th align="center">网卡IP</th>
<th align="center">MAC地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center">172.30.0.100</td>
<td align="center">5a</td>
</tr>
<tr>
<td align="center">172.30.0.200</td>
<td align="center">5b</td>
</tr>
<tr>
<td align="center">10.0.0.100</td>
<td align="center">5c</td>
</tr>
<tr>
<td align="center">10.0.0.200</td>
<td align="center">5d</td>
</tr>
<tr>
<td align="center">10.0.0.130</td>
<td align="center">5e</td>
</tr>
<tr>
<td align="center">10.0.0.140</td>
<td align="center">5f</td>
</tr>
</tbody></table>
<p>请求报文的数据流：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105231944974.png" alt="image-20201105231944974"></p>
<p>响应报文的数据流：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201106082943359.png" alt="image-20201106082943359"></p>
<h4 id="LVS-TUN：为了跨网段通信"><a href="#LVS-TUN：为了跨网段通信" class="headerlink" title="LVS-TUN：为了跨网段通信"></a>LVS-TUN：为了跨网段通信</h4><p>Tunnel</p>
<p>转发方式：Director不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而是在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP）后，将报文发往由调度算法选出的目标RS；RS在发送响应报文时，将直接把报文发送给路由器，路由器再把报文发送回客户端，因此tun模式的响应报文也不经过Director</p>
<p>特点：</p>
<blockquote>
<p>1.RIP和DIP可以不处于同一个物理网络中，RS的网关一般不能指向DIP，而是指向路由器。因此RS和Director是可以跨互联网的，DIP，RIP，VIP都可以是公网IP</p>
<p>2.RS的tun接口上需要配置VIP地址，以便于接收Director转发过来的数据包，以及作为响应的报文源IP</p>
<p>3.Director转发给RS时需要借助隧道，隧道外层的IP头部的源IP是DIP，目标IP是RIP，而RS响应给客户端的IP头是根据隧道内层的IP头分析得到的，源IP是VIP，目标IP是CIP</p>
<p>4.请求报文要经由Director，但响应不经由Director，响应由RS自己完成</p>
<p>5.不支持端口映射</p>
<p>6.RS的操作系统必须支持隧道功能</p>
<p>7.使用的很少，因为在广域网模式下使用代理服务比如nginx和DNS更多</p>
</blockquote>
<h4 id="LVS-FULLNAT模式："><a href="#LVS-FULLNAT模式：" class="headerlink" title="LVS-FULLNAT模式："></a>LVS-FULLNAT模式：</h4><p>转发原理：通过同时修改请求报文的源IP地址和目标IP地址进行转发</p>
<p>特点：</p>
<blockquote>
<p>1.请求和响应报文都经由Director</p>
<p>2.支持端口映射</p>
<p>3.VIP是公网地址，RIP和DIP是私网地址，且通常不在同一个IP网络中，因此RIP的网关不指向DIP</p>
<p>4.相对NAT模式，可以更好地实现RS间跨VLAN通讯</p>
<p>5.这个模式Kernel默认不支持</p>
</blockquote>
<h4 id="LVS工作模式总结和比较"><a href="#LVS工作模式总结和比较" class="headerlink" title="LVS工作模式总结和比较"></a>LVS工作模式总结和比较</h4><table>
<thead>
<tr>
<th>对比种类</th>
<th>NAT</th>
<th>TUN</th>
<th>DR</th>
</tr>
</thead>
<tbody><tr>
<td>RS的操作系统要求</td>
<td>任意操作系统</td>
<td>支持隧道</td>
<td>支持禁止arp广播和接收的系统</td>
</tr>
<tr>
<td>RS所处的网络类型</td>
<td>私网</td>
<td>公网/私网</td>
<td>私网，而且必须与调度器在同一个路由器中</td>
</tr>
<tr>
<td>支持的RS数量</td>
<td>10~20</td>
<td>100+</td>
<td>100+</td>
</tr>
<tr>
<td>RS的网关配置</td>
<td>需要指向调度器</td>
<td>指向自身的路由器</td>
<td>指向自身的路由器</td>
</tr>
<tr>
<td>优点</td>
<td>可以进行端口转换</td>
<td>可以跨WAN</td>
<td>性能最好</td>
</tr>
<tr>
<td>缺点</td>
<td>性能差</td>
<td>系统需要支持隧道</td>
<td>不可以跨网段</td>
</tr>
</tbody></table>
<h3 id="2-LVS调试算法"><a href="#2-LVS调试算法" class="headerlink" title="2 LVS调试算法"></a>2 LVS调试算法</h3><p>Ipvs scheduler：根据其调度时是否考虑各RS当前的负载状态</p>
<p>根据其调度时是否考虑RS当前负载状态分为静态和动态算法</p>
<h4 id="1-静态算法"><a href="#1-静态算法" class="headerlink" title="1 静态算法"></a>1 静态算法</h4><ul>
<li>RR：roundrobin，轮询，使用较多</li>
<li>WRR：Weighted RR，加权轮询，使用较多</li>
<li>SH：Source Hashing，源地址哈希，实现session sticky，会话绑定</li>
<li>DH：Destination Hashing，目标地址哈希,典型使用场景是正向代理缓存场景中的负载均衡，比如Web缓存</li>
</ul>
<h4 id="2-动态算法"><a href="#2-动态算法" class="headerlink" title="2 动态算法"></a>2 动态算法</h4><p>根据后端RS的负载状态进行调度</p>
<p>活动连接：建立连接并且有数据交互</p>
<ul>
<li>LC：least connections 最短连接算法，适用于长连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;activeConnections*256+inactiveConnections</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>WLC：WeightedLC，带权重的最短连接算法，默认调度方法，较常用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;(activeConnections*256+inactiveConnections)&#x2F;weight</span><br></pre></td></tr></table></figure>

<ul>
<li>SED：Shortest Expection Delay，初始连接高权重优先，只检查活动连接，而不考虑非活动连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead&#x3D;(activeConnections+1)*256&#x2F;weight</span><br></pre></td></tr></table></figure>

<ul>
<li>NQ：Never Queue，第一轮均匀分配，后续使用SED</li>
<li>LBLC：Locallity-Based LC，动态的DH算法</li>
<li>LBLCR：LBLC with Replication，带复制功能的LBLC，解决LBLC负载不均衡的问题</li>
<li>内核版本4.15之后新增调度算法：FO和OVF</li>
</ul>
<h1 id="3-LVS相关软件"><a href="#3-LVS相关软件" class="headerlink" title="3 LVS相关软件"></a>3 LVS相关软件</h1><h2 id="1-ipvsadm"><a href="#1-ipvsadm" class="headerlink" title="1 ipvsadm"></a>1 ipvsadm</h2><p>程序包：ipvsadm</p>
<p>主程序：/usr/sbin/ipvsadm</p>
<p>规则保存程序：/usr/sbin/ipvsadm-save</p>
<p>规则加载工具：/usr/sbin/ipvsadm-restore</p>
<p>配置文件：/etc/sysconfig/ipvsadm-config</p>
<p>调度规则文件：/etc/sysconfig/ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br><span class="line">[root@node_7 ~]$rpm -ql ipvsadm</span><br><span class="line">&#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm-config</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ipvsadm.service</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm-restore</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ipvsadm-save</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;ipvsadm-1.27</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;ipvsadm-1.27&#x2F;README</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm-restore.8.gz</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm-save.8.gz</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;ipvsadm.8.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2-ipvsadm-使用"><a href="#2-ipvsadm-使用" class="headerlink" title="2 ipvsadm 使用"></a>2 ipvsadm 使用</h2><p>ipvsadm与iptables很像，他们的服务开启都是加载规则，所以不需要开服务，只需要写规则，他们都是对内核功能的调用</p>
<p>核心功能：</p>
<ul>
<li>集群的管理：增加、删除、修改</li>
<li>集群中业务服务器的管理：增加、删除、修改</li>
<li>查看：<code>ipvsadm -Ln</code></li>
</ul>
<h4 id="创建一个完整的集群的步骤："><a href="#创建一个完整的集群的步骤：" class="headerlink" title="创建一个完整的集群的步骤："></a>创建一个完整的集群的步骤：</h4><p>分两步：</p>
<p>第一步：创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t VIP:port -s 调度算法</span><br><span class="line">-A：--add-service add virtual service with options 表示添加虚拟服务器</span><br><span class="line">-t：--tcp-service service-address is host[:port]  添加tcp协议的服务器IP和端口</span><br><span class="line">-s：scheduler one of rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq,the default scheduler 	is wlc.</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t 172.30.0.200:80 -s rr</span><br></pre></td></tr></table></figure>

<p>第二步：添加集群中的服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t VIP:port -r RS的IP:RS的端口 -工作模式</span><br><span class="line">-a：--add-server add real server with options 表示添加真实的业务服务器</span><br><span class="line">-t：添加tcp协议的服务器的IP和端口</span><br><span class="line">工作模式：</span><br><span class="line">-m：masquerading (NAT) NAT模式</span><br><span class="line">-g：gatewaying (direct routing) (default) DR模式</span><br><span class="line">-i：ipip encapsulation (tunneling) TUN模式</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.7:80 -m</span><br><span class="line">ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.14:80 -m</span><br></pre></td></tr></table></figure>

<h4 id="集群的管理操作："><a href="#集群的管理操作：" class="headerlink" title="集群的管理操作："></a>集群的管理操作：</h4><p>增加、修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br><span class="line">-A：增加虚拟服务</span><br><span class="line">-E：修改虚拟服务</span><br><span class="line">-t：使用tcp协议  -u：使用udp  -f：firewall Mark，防火墙标记，是一个数字</span><br><span class="line">-s：使用的调度算法</span><br><span class="line">-p：持久连接的保存时间，-p 后面不跟时间就是代表360秒</span><br></pre></td></tr></table></figure>

<p>删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -D -t|u|f service-address</span><br></pre></td></tr></table></figure>

<h4 id="集群中的RS的增、删、改："><a href="#集群中的RS的增、删、改：" class="headerlink" title="集群中的RS的增、删、改："></a>集群中的RS的增、删、改：</h4><p>增、改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]</span><br><span class="line">-a：增加RS服务器</span><br><span class="line">-e：修改RS服务器</span><br><span class="line">-t|u|f：tcp,udp,firewall mark</span><br><span class="line">-r：real server 的IP和Port</span><br><span class="line">-g：DR模式，默认模式</span><br><span class="line">-i：TUN模式</span><br><span class="line">-m：NAT模式</span><br><span class="line">-w：权重</span><br></pre></td></tr></table></figure>

<p>删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -d -t|u|f service-address -r server-address</span><br></pre></td></tr></table></figure>

<h4 id="清空集群命令："><a href="#清空集群命令：" class="headerlink" title="清空集群命令："></a>清空集群命令：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<h4 id="清空计数器："><a href="#清空计数器：" class="headerlink" title="清空计数器："></a>清空计数器：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -Z [-t|u|f service-address]</span><br></pre></td></tr></table></figure>

<h4 id="保存规则：建议保存到-etc-sysconfig-ipvsadm"><a href="#保存规则：建议保存到-etc-sysconfig-ipvsadm" class="headerlink" title="保存规则：建议保存到/etc/sysconfig/ipvsadm"></a>保存规则：建议保存到/etc/sysconfig/ipvsadm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-save &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">或者</span><br><span class="line">ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">或者</span><br><span class="line">systemctl stop ipvsadm.service <span class="comment">#这个service文件中调用的命令有保存</span></span><br></pre></td></tr></table></figure>

<h4 id="载入规则：会自动加载-etc-sysconfig-ipvsadm"><a href="#载入规则：会自动加载-etc-sysconfig-ipvsadm" class="headerlink" title="载入规则：会自动加载/etc/sysconfig/ipvsadm"></a>载入规则：会自动加载/etc/sysconfig/ipvsadm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-restore &lt; /path/from/ipvsadm_file</span><br><span class="line">或者</span><br><span class="line">systemctl start ipvsadm.service <span class="comment">#会自动加载/etc/sysconfig/ipvsadm</span></span><br></pre></td></tr></table></figure>

<h4 id="防火墙标记"><a href="#防火墙标记" class="headerlink" title="防火墙标记"></a>防火墙标记</h4><p>FWM：FireWall Mark</p>
<p>Mark target 可用于给特定的报文打标记，–set-mark value，其中value可以是十六进制数字</p>
<p>工作原理：借助于防火墙标记来分类报文，而后基于标记定义集群服务，可以将多个不同的应用使用同一个集群服务进行调度</p>
<p>实现方法：</p>
<p>在Director主机打标记：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -d $&#123;VIP&#125; -p $&#123;protocol&#125; -m multiport --dport $&#123;port1&#125;,$&#123;port2&#125;,... -j MARK --set-mark NUMBER</span><br></pre></td></tr></table></figure>

<p>之后在ipvsadm中可以直接利用这个标记来标记集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -f NUMBER [options]</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<h4 id="LVS持久连接"><a href="#LVS持久连接" class="headerlink" title="LVS持久连接"></a>LVS持久连接</h4><p>session绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现</p>
<p>持久连接（lvs persistence）模板：实现无论使用任何调度算法，在一段时间内（默认360s），能够实现将来自同一个地址的请求始终发往同一个RS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br><span class="line">使用-p选项就代表了持久连接，默认是360秒</span><br></pre></td></tr></table></figure>

<p>持久连接的实现方法：</p>
<ul>
<li>按照端口，PPC，每端口持久，每个端口定义为一个集群服务，每个集群服务单独调度</li>
<li>按照防火墙标记，PFWMC，每防火墙标记持久，基于防火墙标记定义集群服务，可以实现将多个端口上的应用同意调度，即port Affinity</li>
</ul>
<p>例子：</p>
<h2 id="3-LVS的操作实例"><a href="#3-LVS的操作实例" class="headerlink" title="3 LVS的操作实例"></a>3 LVS的操作实例</h2><h3 id="1-NAT模式的操作"><a href="#1-NAT模式的操作" class="headerlink" title="1 NAT模式的操作"></a>1 NAT模式的操作</h3><p>环境说明：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105153045726.png" alt="image-20201105153045726"></p>
<p>操作步骤</p>
<h4 id="第一步：环境配置"><a href="#第一步：环境配置" class="headerlink" title="第一步：环境配置"></a>第一步：环境配置</h4><p>1.准备两个网段，</p>
<p>2.配置IP地址</p>
<p>3.这个图里画了防火墙，但是其实防火墙和LVS是一台主机</p>
<p>配置192段主机的网关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先把原来的指向0.0.0.0的默认路由删掉</span><br><span class="line">ip route del default dev eth0 </span><br><span class="line">然后把默认路由指向防火墙一侧</span><br><span class="line">ip route add default dev eth0 via 172.30.0.200</span><br></pre></td></tr></table></figure>

<p>配置10段主机的网关，这个网关是指向Director的，因为响应报文要先发给Director进行处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先把原来的指向0.0.0.0的默认路由删掉</span><br><span class="line">ip route del default dev eth0 </span><br><span class="line">然后把默认路由指向防火墙一侧</span><br><span class="line">ip route add default dev eth0 via 10.0.0.100</span><br></pre></td></tr></table></figure>

<p>4.注意一点，防火墙两边的主机的网关都要指向防火墙，而且防火墙上不要配置Iptables规则，尤其是nat表的规则，因为LVS的ipvsadm是作用在INPUT表的</p>
<p>5.防火墙要开启路由转发功能 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;net.ipv4.ip_forward &#x3D; 1&quot; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p;让sysctl.conf的内容生效</span><br></pre></td></tr></table></figure>



<h4 id="第二步：LVS的操作"><a href="#第二步：LVS的操作" class="headerlink" title="第二步：LVS的操作"></a>第二步：LVS的操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$yum install ipvsadm</span><br><span class="line">[root@node_7 ~]$ipvsadm -A -t 172.30.0.200:80 -s rr</span><br><span class="line">[root@node_7 ~]$ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.30.0.200:80 rr</span><br><span class="line">[root@node_7 ~]$ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.7:80 -m</span><br><span class="line">[root@node_7 ~]$ipvsadm -a -t 172.30.0.200:80 -r 10.0.0.14:80 -m</span><br><span class="line">[root@node_7 ~]$ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.30.0.200:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Masq    1      0          0         </span><br><span class="line">  -&gt; 10.0.0.14:80                 Masq    1      0          0 </span><br></pre></td></tr></table></figure>

<h4 id="第三步：在外网进行访问"><a href="#第三步：在外网进行访问" class="headerlink" title="第三步：在外网进行访问"></a>第三步：在外网进行访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends! this is 7</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 172.30.0.200</span><br><span class="line">Hello,my friends! this is 7</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试成功！</p>
<p>保存规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm</span><br></pre></td></tr></table></figure>

<p>清除规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<p>重新导入规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm</span><br></pre></td></tr></table></figure>

<p>设置开机自动导入规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ipvsadm.service</span><br><span class="line">前提是保存的规则文件确实是&#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm才行，为什么，因为ipvsadm.service文件里面是：</span><br><span class="line">  7 ExecStart&#x3D;&#x2F;bin&#x2F;bash -c &quot;exec &#x2F;sbin&#x2F;ipvsadm-restore &lt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm&quot;</span><br><span class="line">  8 ExecStop&#x3D;&#x2F;bin&#x2F;bash -c &quot;exec &#x2F;sbin&#x2F;ipvsadm-save -n &gt; &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm&quot;</span><br><span class="line">  9 ExecStop&#x3D;&#x2F;sbin&#x2F;ipvsadm -C</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-DR模式的操作"><a href="#2-DR模式的操作" class="headerlink" title="2.DR模式的操作"></a>2.DR模式的操作</h3><h4 id="杂谈："><a href="#杂谈：" class="headerlink" title="杂谈："></a>杂谈：</h4><p>单网段和多网段</p>
<p>LVS也需要配置一个路由</p>
<p>网络环境的配置尽量按照一个方向配置</p>
<p>修改内核参数需要修改ALL和lo网卡</p>
<p>如何永久添加一个网卡上的两个IP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eth0 +ipv4.address 172.16.0.200&#x2F;24 ifname eth0</span><br><span class="line">其实就是在ifcfg-eth0的配置文件中添加了ipaddr1&#x3D;172.16.0.200 prefix1&#x3D;24 这样的行</span><br></pre></td></tr></table></figure>

<h4 id="LVS-DR单网段"><a href="#LVS-DR单网段" class="headerlink" title="LVS-DR单网段"></a>LVS-DR单网段</h4><p>DR模型中LVS和各个RS主机上都需要配置VIP，但是他们不是同一台主机，因此会出现一个VIP地址有三个MAC地址的问题，也就是地址冲突问题，所以要解决这个问题，解决这个问题的方法大概有三种：</p>
<p>1）在前端的路由器上做VIP地址和LVS服务器MAC的绑定</p>
<p>2）在各个RS上使用arptables工具</p>
<p>3）在各个RS上修改内核参数（arp的广播和接收），来限制arp响应和通告的级别</p>
<p>方法一存在问题，那就是每当更换LVS服务器时，都需要修改路由器上的绑定关系，因此不推荐使用</p>
<p>方法二的配置还需要学习，因此暂时不用，arptables的思路与iptables思路一样，只不过协议变了</p>
<p>方法三好配置，因此推荐使用</p>
<p>需要修改的内核参数：arp_ignore,arp_announce</p>
<p><strong>注意：这两个参数都是有一个总的配置和每个网卡上的配置，因此修改的时候需要修改总的配置和需要配置VIP的网卡的配置</strong></p>
<blockquote>
<p> arp_ignore：限制响应级别</p>
<ul>
<li>0：默认值，表示可以使用本地任意接口上配置的任意地址进行响应</li>
<li>1：仅在请求的目标IP配置在本地主机的接收请求报文的接口上时，才给予响应</li>
</ul>
</blockquote>
<blockquote>
<p>arp_announce：限制通告级别</p>
<ul>
<li>0：默认值，把本机所有接口的所有信息向每个接口的网络进行通告</li>
<li>1：尽量避免将接口信息向非直接连接的网络进行通告</li>
<li>2：必须避免将接口信息向非本网络进行通告</li>
</ul>
</blockquote>
<p>范例1：</p>
<p>环境：</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105161821292.png" alt="image-20201105161821292"></p>
<p>环境准备：5台主机，两个网段，注意网关的配置，每个主机的网关都要指向路由器，路由器要开启路由转发</p>
<p><strong>注意：LVS服务器和两台RS服务器上，都要配置VIP，VIP都配置到lo网卡上</strong></p>
<p>配置网络环境中最主要的命令：</p>
<p>修改路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip route del default dev eth0</span><br><span class="line">ip route add default dev etho via 10.0.0.100</span><br></pre></td></tr></table></figure>

<p>查看路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">route -n</span><br><span class="line">或者</span><br><span class="line">ip route</span><br></pre></td></tr></table></figure>

<p>添加IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address add 10.0.0.200&#x2F;32 dev lo</span><br></pre></td></tr></table></figure>



<p>步骤：</p>
<p>1.两台RS的配置，即arp参数的修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_ignore </span><br><span class="line">➜  ~ echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_announce </span><br><span class="line">➜  ~ echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;lo&#x2F;arp_ignore </span><br><span class="line">➜  ~ echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;lo&#x2F;arp_announce</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.LVS服务器的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ipvsadm -A -t 10.0.0.200:80 -s wrr</span><br><span class="line">➜  ~ ipvsadm -a -t 10.0.0.200:80 -r 10.0.0.7:80 -g </span><br><span class="line">➜  ~ ipvsadm -a -t 10.0.0.200:80 -r 10.0.0.14:80 -g</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.172网段的主机进行访问测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 7</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 14</span><br><span class="line">[root@node_7 ~]$curl 10.0.0.200</span><br><span class="line">Hello,my friends!,this is 7</span><br></pre></td></tr></table></figure>

<p>测试成功</p>
<p>想要对LVS-DR模式的修改MAC地址进行了解，那么就抓包查看</p>
<p>首先开启抓包软件，然后监听NAT网卡，也就是VMNET8，然后在172.30.0.100上curl；</p>
<p>注意：因为抓的是VMNET8网段，所以看不到172主机与路由器之间的通讯，下面我们看到的通讯已经经过了路由器的转发了，也就是说，172.30.0.100这个IP所带的MAC其实已经是路由器的MAC了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.0.0.200</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105174819989.png" alt="image-20201105174819989"></p>
<p>下面对这个报文进行分析</p>
<blockquote>
<p>1.请求报文： SRC 172.30.0.100 SRC-MAC 8a DEST 10.0.0.200 DEST-MAC 0d<br>2.请求报文： SRC 172.30.0.100 SRC-MAC 0d DEST 10.0.0.200 DEST-MAC a5<br>3.响应报文： SRC 10.0.0.200 SRC-MAC a5 DEST 172.30.0.100 DEST-MAC 8a</p>
</blockquote>
<p>通过对报文的分析，可以看到：</p>
<p>首先，172主机向10.0.0.200的IP地址发起请求，这个时候的10.0.0.200的MAC是LVS主机</p>
<p>然后，LVS主机根据调度算法，向一个MAC地址是a5（IP是10.0.0.14）的主机转发了这个报文，可以注意到，此时的源IP地址和源MAC并没有改变，目标IP也没有改变，但是目标MAC改变了</p>
<p>最后，10.0.0.14主机向172.30.0.100主机发出响应报文，此时可以看到，源IP地址是10.0.0.200，源MAC是10.0.0.14的MAC，目标IP是172.30.0.100，目标MAC是路由器的MAC</p>
<h4 id="LVS-DR模式多网段"><a href="#LVS-DR模式多网段" class="headerlink" title="LVS-DR模式多网段"></a>LVS-DR模式多网段</h4><p>环境搭建</p>
<p><img src="C:\Users\a\AppData\Roaming\Typora\typora-user-images\image-20201105191226209.png" alt="image-20201105191226209"></p>
<p>这个实验与上一个实验的区别就是对VIP是一个与RS服务器不在同一个网段的IP，因此在路由器上需要增加一个192.168.0.0/24的地址；还有一个区别，那就是LVS服务器的网关，这个网关其实是没用的，因为它接收到报文后，通过修改MAC的方式调度到RS服务器上了，它不需要跨网段通信，但是不设置这个网关还真不行，随便设置一个就行</p>
<p>在这里还碰到了问题，那就是通过命令临时添加的路由和IP会自动消失（虚拟机环境），因此我写到了配置文件中，给一个网卡上永久保存两个IP的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eth0 +ipv4.address 192.168.0.200&#x2F;24 ifname eth0</span><br></pre></td></tr></table></figure>

<p>这个命令其实是修改了ifcfg-eth0的配置文件，所以也需要通过命令重新加载网卡配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection reload</span><br><span class="line">nmcli connection up eth0</span><br></pre></td></tr></table></figure>

<p>查看ifcfg-eth0文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> 1 DEVICE&#x3D;eth0                                                                  </span><br><span class="line"> 2 NAME&#x3D;eth0</span><br><span class="line"> 3 ONBOOT&#x3D;yes</span><br><span class="line"> 4 BOOTPROTO&#x3D;static</span><br><span class="line"> 5 IPADDR&#x3D;10.0.0.100</span><br><span class="line"> 6 NETMASK&#x3D;255.255.255.0</span><br><span class="line"> 7 GATEWAY&#x3D;10.0.0.1</span><br><span class="line"> 8 DNS1&#x3D;180.76.76.76</span><br><span class="line"> 9 DNS2&#x3D;223.6.6.6</span><br><span class="line">10 TYPE&#x3D;Ethernet</span><br><span class="line">11 PROXY_METHOD&#x3D;none</span><br><span class="line">12 BROWSER_ONLY&#x3D;no</span><br><span class="line">13 PREFIX&#x3D;24</span><br><span class="line">14 IPADDR1&#x3D;192.168.0.200</span><br><span class="line">15 PREFIX1&#x3D;24</span><br><span class="line">16 NETMASK1&#x3D;255.255.255.0</span><br><span class="line">17 DEFROUTE&#x3D;yes</span><br><span class="line">18 IPV4_FAILURE_FATAL&#x3D;no</span><br><span class="line">19 IPV6INIT&#x3D;no</span><br><span class="line">20 UUID&#x3D;5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>脚本：</p>
<p>自动配置LVS服务器、RS服务器，其实就是修改arp内核参数，配置VIP到lo网卡上</p>
<h3 id="3-tunnel模式的操作"><a href="#3-tunnel模式的操作" class="headerlink" title="3.tunnel模式的操作"></a>3.tunnel模式的操作</h3><p>ip addr add xxxx dev tunl0</p>
<p>ip link set tunl0 up</p>
<p>防火墙标记</p>
<p>使用mangle表的标记</p>
<p>LVS的持久连接</p>
<p>一段时间内让一个用户访问同一个业务服务器，这样可以保留session信息</p>
<p>这个时间可以设置</p>
<h2 id="4-LVS的高可用"><a href="#4-LVS的高可用" class="headerlink" title="4 LVS的高可用"></a>4 LVS的高可用</h2><p>使用keepalive实现LVS的高可用</p>
<h3 id="LVS的两个痛点："><a href="#LVS的两个痛点：" class="headerlink" title="LVS的两个痛点："></a>LVS的两个痛点：</h3><p>高可用的解决方法：</p>
<p>Keepalive，使用一个虚拟IP，谁工作，VIP就是谁的</p>
<p>对业务服务器状态无法感知的解决方法：</p>
<p>KeepAlive，定期检查业务服务器的状态</p>
<p>要求：LVS-DR模型操作</p>
<p>在实验中加入LVS+</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/18/LVS/" data-id="ckhnf9het000840utf88f5ivo" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/hexo/" style="font-size: 10px;">hexo</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/18/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020/11/18/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91MYSQL8.0/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020/11/18/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-rsyslog/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020/11/18/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020/11/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85MySQL%E8%84%9A%E6%9C%AC/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2020 huihui<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>